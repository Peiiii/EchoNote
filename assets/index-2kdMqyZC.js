const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/pkg-mermaid-BKUwkIFg.js","assets/pkg-at-mermaid-js-parser-FFOaRQbu.js","assets/pkg-langium-k-diuD5f.js","assets/pkg-vscode-jsonrpc-CNa_m3dn.js","assets/pkg-chevrotain-CEPHk4zS.js","assets/pkg-at-chevrotain-utils-DXqYm0RC.js","assets/pkg-at-chevrotain-gast-CM_WTRiP.js","assets/lodash-C0JF0MaN.js","assets/pkg-at-chevrotain-regexp-to-ast-CeRRmUFy.js","assets/pkg-chevrotain-allstar-CSJ5eIgA.js","assets/pkg-vscode-languageserver-types-NoPvPymt.js","assets/pkg-vscode-languageserver-textdocument-CKBVUiR3.js","assets/pkg-vscode-uri-BBKMTmn0.js","assets/pkg-ts-dedent-DrFu-skq.js","assets/pkg-d3-transition-Be1UnZzk.js","assets/pkg-d3-timer-DdKHrDhs.js","assets/pkg-d3-dispatch-kxCwF96_.js","assets/pkg-d3-interpolate-Iy2XDU8a.js","assets/pkg-d3-color-amxIadob.js","assets/pkg-d3-selection-DSeOx27A.js","assets/pkg-d3-ease-DRPgKoYJ.js","assets/pkg-d3-zoom-CShAqKQT.js","assets/pkg-d3-drag-BRlWb_WG.js","assets/pkg-dompurify-CGs5VtEq.js","assets/pkg-stylis-D5iaQeiq.js","assets/pkg-dagre-d3-es-CvYYlzoE.js","assets/pkg-cytoscape-DtBltrT8.js","assets/pkg-cytoscape-cose-bilkent-C9QuRRRD.js","assets/pkg-at-braintree-sanitize-url-DFOppRqi.js","assets/pkg-cose-base-pzx1KLkZ.js","assets/pkg-layout-base-DINsLxBG.js","assets/pkg-khroma-DUX6PT6k.js","assets/pkg-dayjs-CVSRrfvc.js","assets/pkg-d3-scale-BdQTp1Zi.js","assets/pkg-internmap-BkD7Hj8s.js","assets/pkg-d3-array-DzV2ZBVv.js","assets/pkg-d3-format-CzD4bSOQ.js","assets/pkg-d3-time-format-D0g1J26-.js","assets/pkg-d3-time-BJXYiI7q.js","assets/pkg-d3-axis-DSWTncID.js","assets/pkg-d3-shape-B1-Efro7.js","assets/pkg-d3-path-Bai4oqrp.js","assets/pkg-roughjs-CycZv-lV.js","assets/pkg-uuid-BKrj-4V8.js","assets/pkg-d3-sankey-CL8iXfid.js","assets/pkg-d3-scale-chromatic-CvOaoHrI.js","assets/pkg-at-iconify-utils-D2F_yRRF.js","assets/pkg-marked-BGv_dqOO.js","assets/pkg-cytoscape-fcose-DSsTzDQ2.js","assets/pkg-d3-hierarchy-CvYzv8kf.js","assets/pkg-react-syntax-highlighter-CV6PWkyB.js","assets/react-vendor-BmBsKbru.js","assets/pkg-scheduler-Bb8JjhAW.js","assets/pkg-refractor-Ch9JKb1r.js","assets/pkg-hastscript-VmKaH6iJ.js","assets/pkg-property-information-CFHPdWQf.js","assets/pkg-xtend-VQg9yHl6.js","assets/pkg-hast-util-parse-selector-CLnxzGsj.js","assets/pkg-space-separated-tokens-CF7pUylw.js","assets/pkg-comma-separated-tokens-BQxVigOH.js","assets/pkg-parse-entities-xsQacvMO.js","assets/pkg-character-entities-legacy-BSd6ekHp.js","assets/pkg-character-reference-invalid-AKrgFUtc.js","assets/pkg-is-decimal-Bg2oiju0.js","assets/pkg-is-hexadecimal-yh8m6GRc.js","assets/pkg-is-alphanumerical-DYCKc-AM.js","assets/pkg-is-alphabetical-BQ1fjZEF.js","assets/pkg-prismjs-roPZ7vEp.js","assets/pkg-at-babel-runtime-BlVrb8V_.js"])))=>i.map(i=>d[i]);
import{r as m,j as e,H as Ts,a as Wa,d as Yc}from"./react-vendor-BmBsKbru.js";import{S as vi,a as wi,C as yi,b as ji,T as Xc,D as Jc,P as Ni,O as Ci,c as Zc,d as Qc,e as ed,f as td,g as sd,h as nd,i as ad,j as rd,k as ki,l as od,L as id,m as ld,n as cd,o as dd,p as ud,q as md,r as hd,s as gd,t as pd,G as fd,u as xd,v as bd,w as vd,x as wd,y as yd,z as jd,V as Nd,A as Cd,B as kd,E as Sd,R as Md,I as Id,F as Td,H as Ed,J as Ad,K as Rd,M as Ld,N as Dd,Q as _d,U as Pd,W as Od,X as $d,Y as Bd}from"./radix-D27LS9ld.js";import{t as Ud,c as Fd,a as Mr}from"./ui-utils-CjxovF-h.js";import{u as L,i as zd,T as Si}from"./pkg-react-i18next-CaTF3ZQ9.js";import{g as fe,h as Es,W as Hd,i as Xs,j as _t,k as Mi,l as ua,I as Ii,m as Gd,n as Vd,o as Ir,p as qa,q as Wd,r as Tr,s as Yn,t as Xn,E as ms,u as ma,v as Er,w as st,x as bs,y as ha,z as Ti,D as Xe,F as Ka,P as $e,G as qd,H as Ar,J as Kd,K as Yd,N as vs,O as hs,Q as Ei,V as Ai,Y as Xd,Z as Jd,_ as Zd,$ as yt,a0 as Je,a1 as Qd,a2 as Ri,a3 as ga,a4 as Rr,a5 as Ls,a6 as Jn,a7 as eu,a8 as tu,a9 as su,aa as jt,ab as nu,ac as pa,ad as Mt,ae as pn,af as Ya,ag as Zn,ah as tt,ai as Xa,aj as an,ak as Ja,al as Li,am as Di,an as au,ao as fn,ap as ru,aq as ou,ar as iu,as as gs,at as _i,au as It,av as uo,aw as mo,ax as ho,ay as go,az as lu,aA as cu,aB as po,aC as fo,aD as xo,aE as Un,aF as Za,aG as Sa,aH as As,aI as bo,aJ as du,aK as uu,aL as mu,aM as hu,aN as gu,aO as pu,aP as Lr,aQ as Pi,aR as fu,aS as Qa,aT as Oi,aU as xn,aV as $i,aW as xu,aX as Bi,aY as Ui,aZ as bu,a_ as Fi,a$ as vu,b0 as vo,b1 as ps,b2 as zi,b3 as Hi,b4 as wu,b5 as er,b6 as Gi,b7 as yu,b8 as Vi,b9 as ju,ba as tr,bb as sr,bc as Ma,bd as Nu,be as fa,bf as Cu,bg as ku,bh as Su,bi as Mu,bj as Iu,bk as Wi,bl as Tu,bm as Eu,bn as Au,bo as Ru,bp as wo,bq as Lu,br as qi,bs as Du,bt as Ia,bu as _u,bv as Pu,bw as Ou,bx as $u,by as Bu,bz as Uu}from"./icons-B15-rQhB.js";import{c as _e,p as Xt}from"./pkg-zustand-c3SqYTrA.js";import{T as Fu,t as ke}from"./pkg-sonner-COYOtiVF.js";import{i as zu,s as Hu,l as Gu,a as Vu}from"./pkg-at-firebase-analytics-CSlJI-t7.js";import"./firebase-BPC2EMoK.js";import{i as Wu,c as qu,g as Ku,b as Yu,o as Xu,s as Us,a as Ju,d as yo,e as Fs,f as jo,u as Ta,G as Zu,h as Qu}from"./pkg-at-firebase-auth-omahK6ZZ.js";import{i as em}from"./pkg-at-firebase-app-BIK-kTny.js";import"./pkg-at-firebase-logger-CNz1B4Yj.js";import{i as No,p as tm,a as sm,c as ze,g as Se,q as be,w as ie,o as Ve,b as Js,l as Gt,d as Ea,e as me,u as Te,s as ce,f as nr,h as rs,j as Vt,k as nm,m as Fn,n as am,T as rm,r as om,t as Zs,v as im,x as lm}from"./pkg-at-firebase-firestore-DyYiRSku.js";import{S as cm,B as Rt,R as Ki,d as xa,f as Qs,s as Yi,o as dm,c as Xi,m as os,a as Ms,t as um,b as mm,e as hm,g as gm,h as Ji,O as ar,i as pm,j as fm,k as rr}from"./rxjs-BGfRWZln.js";import{v as fs}from"./pkg-uuid-BKrj-4V8.js";import{A as Dr,m as he}from"./pkg-framer-motion-ByyIFi-r.js";import{u as xm,a as _r,R as ba,b as Is,c as bm,N as Pr,H as vm}from"./pkg-react-router-BkbVofjk.js";import{E as wm,d as Zi,D as Qn}from"./pkg-at-cardos-extension-B6GroYyD.js";import{u as rn}from"./pkg-ahooks-pw93jeL_.js";import{P as ym,a as jm,b as Nm}from"./pkg-react-resizable-panels-DkV_pGBO.js";import{O as Qi}from"./ai-sdk-Cs_ets_2.js";import{i as W}from"./pkg-i18next-C5QWbJWw.js";import{B as Cm}from"./pkg-i18next-http-backend-Go9VqH1A.js";import{_ as ue}from"./pkg-at-mermaid-js-parser-FFOaRQbu.js";import{d as el,i as km,a as Sm,f as or,b as Mm}from"./pkg-date-fns-Cc4qOlqn.js";import{T as et,E as ct,u as Im,a as Tm,A as Em}from"./agent-chat-w7OO76SM.js";import{$ as Am}from"./lodash-C0JF0MaN.js";import{E as Rm,a as Lm,S as Dm,T as Co}from"./pkg-emoji-picker-react-BaGPy3TE.js";import{R as _m,N as Pm,a as Om,u as $m,E as Bm}from"./pkg-at-tiptap-react-rf1NHhgG.js";import{i as Um}from"./pkg-at-tiptap-extension-bubble-menu-DbBO6TnN.js";import{i as Fm}from"./pkg-at-tiptap-extension-placeholder-C61jGW_T.js";import{S as zm}from"./pkg-at-tiptap-starter-kit-BeTqfHQC.js";import{i as Hm}from"./pkg-at-tiptap-extension-code-block-lowlight-CeFN_vop.js";import{i as Gm}from"./pkg-at-tiptap-extension-underline-Bc-1QzGt.js";import{i as Vm}from"./pkg-at-tiptap-extension-link-BpPLl1yG.js";import{i as Wm}from"./pkg-at-tiptap-extension-image-BWcc5HCz.js";import{i as qm}from"./pkg-at-tiptap-extension-typography-BNh8BK4m.js";import{c as Km}from"./pkg-at-tiptap-extension-table-Cep6OeXh.js";import{i as Ym}from"./pkg-at-tiptap-extension-table-row-CDDzHxTi.js";import{i as Xm}from"./pkg-at-tiptap-extension-table-header-CBUC3IlF.js";import{i as Jm}from"./pkg-at-tiptap-extension-table-cell-Cbo0s_r5.js";import{i as Zm}from"./pkg-at-tiptap-extension-task-list-BjPe_qK3.js";import{i as Qm}from"./pkg-at-tiptap-extension-task-item-B-JYeMAW.js";import{T as eh}from"./pkg-turndown-DScDaalG.js";import{g as th}from"./pkg-turndown-plugin-gfm-CHX_rbMa.js";import{k as tl}from"./pkg-marked-BGv_dqOO.js";import{v as ir}from"./pkg-unist-util-visit-Ddo8Kubz.js";import{E as sh}from"./pkg-unist-util-visit-parents-BcSs7PJp.js";import{u as nh}from"./pkg-unified-DkoGxGPE.js";import{r as ah}from"./pkg-rehype-parse-BoGwmf-J.js";import{r as rh}from"./pkg-rehype-remark-gZKLrGxq.js";import{r as sl,a as nl,M as oh,b as ih}from"./markdown-BCKuswd-.js";import{r as lh}from"./pkg-remark-stringify-EhqeS4xL.js";import{E as ch}from"./pkg-at-tiptap-core-BEPluX3I.js";import{i as dh}from"./pkg-at-tiptap-suggestion-B7OJ7sq3.js";import{l as uh}from"./pkg-lowlight-DYSj9Ibr.js";import{i as mh}from"./pkg-at-tiptap-extension-heading-DOz64cif.js";import{q as al}from"./pkg-react-virtuoso-BimVkHfU.js";import{S as rl,v as hh,o as gh}from"./pkg-react-syntax-highlighter-CV6PWkyB.js";import{z as ph,i as fh}from"./pkg-d3-zoom-CShAqKQT.js";import{f as xh,a as bh,b as vh,c as wh,d as yh}from"./pkg-d3-force-zv4HlRoA.js";import{s as Aa}from"./pkg-d3-selection-DSeOx27A.js";import{a as jh}from"./pkg-d3-drag-BRlWb_WG.js";import{G as Nh,a as Ch,g as kh,p as Sh}from"./pkg-at-dimstack-git-auth-HYuP_LUZ.js";import"./pkg-at-braintree-sanitize-url-DFOppRqi.js";import"./pkg-scheduler-Bb8JjhAW.js";import"./pkg-react-remove-scroll-D84cQcFc.js";import"./pkg-tslib-NCTAzukp.js";import"./pkg-react-remove-scroll-bar-HAm2nWq0.js";import"./pkg-react-style-singleton-BtmK1JjA.js";import"./pkg-get-nonce-C-Z93AgS.js";import"./pkg-use-sidecar-Dk7v8vBV.js";import"./pkg-use-callback-ref-C1Qc1SND.js";import"./pkg-aria-hidden-DvXkyWUv.js";import"./pkg-use-sync-external-store-FcjOgQqs.js";import"./pkg-at-floating-ui-react-dom-DG-zBnew.js";import"./pkg-at-floating-ui-dom-H_s0ufE4.js";import"./pkg-at-floating-ui-core-Bf0tlPHe.js";import"./pkg-at-floating-ui-utils-CAQGqlS1.js";import"./pkg-html-parse-stringify-FuUoKy6c.js";import"./pkg-void-elements-BiMHg9sG.js";import"./pkg-at-firebase-util-BkZ7B19c.js";import"./pkg-at-firebase-component-VBiwi6I0.js";import"./pkg-at-firebase-installations-E2mrg3vu.js";import"./pkg-idb-BXWtuYvb.js";import"./pkg-at-firebase-webchannel-wrapper-QS5lB7L3.js";import"./pkg-motion-dom-BwV5m02p.js";import"./pkg-motion-utils-CjIqCkNq.js";import"./pkg-dayjs-CVSRrfvc.js";import"./pkg-langium-k-diuD5f.js";import"./pkg-vscode-jsonrpc-CNa_m3dn.js";import"./pkg-chevrotain-CEPHk4zS.js";import"./pkg-at-chevrotain-utils-DXqYm0RC.js";import"./pkg-at-chevrotain-gast-CM_WTRiP.js";import"./pkg-at-chevrotain-regexp-to-ast-CeRRmUFy.js";import"./pkg-chevrotain-allstar-CSJ5eIgA.js";import"./pkg-vscode-languageserver-types-NoPvPymt.js";import"./pkg-vscode-languageserver-textdocument-CKBVUiR3.js";import"./pkg-vscode-uri-BBKMTmn0.js";import"./pkg-flairup-CpvKgcza.js";import"./pkg-fast-deep-equal-Bz4WhI9j.js";import"./editor-C-B7di21.js";import"./pkg-w3c-keyname-DEtA-KhA.js";import"./pkg-rope-sequence-nfUW61tr.js";import"./pkg-orderedmap-C4TimWWB.js";import"./pkg-at-tiptap-extensions-CsjD9KBa.js";import"./pkg-at-tiptap-extension-blockquote-CIx2_CtX.js";import"./pkg-at-tiptap-extension-bold-CL-3UbJm.js";import"./pkg-at-tiptap-extension-code-DLCV8URN.js";import"./pkg-at-tiptap-extension-code-block-CumulSY5.js";import"./pkg-at-tiptap-extension-document-Dilzfe-S.js";import"./pkg-at-tiptap-extension-hard-break-Cq0Drqhf.js";import"./pkg-at-tiptap-extension-horizontal-rule-CL_RkuIS.js";import"./pkg-at-tiptap-extension-italic-Cjk0aqR1.js";import"./pkg-at-tiptap-extension-list-Dndwv1kf.js";import"./pkg-at-tiptap-extension-paragraph-C7HeI5db.js";import"./pkg-at-tiptap-extension-strike-ByPbP-rY.js";import"./pkg-at-tiptap-extension-text-CSJP2zVF.js";import"./pkg-highlight-js-Bau7PnhN.js";import"./pkg-linkifyjs-DVrXeg1a.js";import"./pkg-unist-util-is-BPZGFiMU.js";import"./pkg-bail-FqpXQuLt.js";import"./pkg-extend-gYfrUz6q.js";import"./pkg-is-plain-obj-C1gvLhAf.js";import"./pkg-trough-B_b8ryxu.js";import"./pkg-vfile-C9sMpkI_.js";import"./pkg-vfile-message-9l3O2Txd.js";import"./pkg-unist-util-stringify-position-Ch_qCilz.js";import"./pkg-hast-util-from-html-Dr5jZ0zX.js";import"./pkg-parse5-_EF7DkJg.js";import"./pkg-entities-BglH30t1.js";import"./pkg-hast-util-from-parse5-CbpRgCtS.js";import"./pkg-devlop-Cl3hj7Sz.js";import"./pkg-property-information-CFHPdWQf.js";import"./pkg-xtend-VQg9yHl6.js";import"./pkg-web-namespaces-Cmx0dTen.js";import"./pkg-hastscript-VmKaH6iJ.js";import"./pkg-hast-util-parse-selector-CLnxzGsj.js";import"./pkg-space-separated-tokens-CF7pUylw.js";import"./pkg-comma-separated-tokens-BQxVigOH.js";import"./pkg-vfile-location-LfEFwJ2h.js";import"./pkg-hast-util-to-mdast-BPVClNk7.js";import"./pkg-at-ungap-structured-clone--gfxRhYI.js";import"./pkg-trim-trailing-lines-7L_Z2a2U.js";import"./pkg-hast-util-to-text-C4DEUCmM.js";import"./pkg-hast-util-is-element-Bzxglnm2.js";import"./pkg-unist-util-find-after-DkOernp_.js";import"./pkg-hast-util-phrasing-B72AGgQS.js";import"./pkg-hast-util-embedded-CWukGJwN.js";import"./pkg-hast-util-is-body-ok-link-C43KYGFe.js";import"./pkg-hast-util-has-property-BRFdt-Gn.js";import"./pkg-mdast-util-phrasing-CAX20Uul.js";import"./pkg-hast-util-whitespace-D4Wp6AEg.js";import"./pkg-mdast-util-to-string-C_aolqmU.js";import"./pkg-unist-util-position-B29JQW-R.js";import"./pkg-rehype-minify-whitespace-BY0G4hOn.js";import"./pkg-hast-util-minify-whitespace-DPvWwg0h.js";import"./pkg-remark-parse-BeO-KmVJ.js";import"./pkg-mdast-util-from-markdown-BmEQKP9C.js";import"./pkg-micromark-util-decode-numeric-character-reference-CNs1qBpV.js";import"./pkg-micromark-util-decode-string-CN12p1QQ.js";import"./pkg-decode-named-character-reference-C3-224fz.js";import"./pkg-micromark-util-normalize-identifier-C9ANKk3v.js";import"./pkg-micromark-D5KhfieM.js";import"./pkg-micromark-util-combine-extensions-Do2pbDSt.js";import"./pkg-micromark-util-chunked-DrRIdSP-.js";import"./pkg-micromark-factory-space-BZOpXu4z.js";import"./pkg-micromark-util-character-Cn8n62xE.js";import"./pkg-micromark-core-commonmark-CqZ3B5v2.js";import"./pkg-micromark-util-classify-character-CcNqx0ik.js";import"./pkg-micromark-util-resolve-all-PQCKh0dx.js";import"./pkg-micromark-util-subtokenize-Rnufg-uS.js";import"./pkg-micromark-factory-destination-BpBlAxuG.js";import"./pkg-micromark-factory-label-DyndCtq7.js";import"./pkg-micromark-factory-title--3sarO0x.js";import"./pkg-micromark-factory-whitespace-BFbQeeHj.js";import"./pkg-micromark-util-html-tag-name-DbKNfynz.js";import"./pkg-remark-rehype-DYOQqASa.js";import"./pkg-mdast-util-to-hast-Brl7PQp-.js";import"./pkg-micromark-util-sanitize-uri-Bcy1OjTd.js";import"./pkg-trim-lines-D8znQY54.js";import"./pkg-hast-util-to-jsx-runtime-BrcWNXAC.js";import"./pkg-style-to-js-CEKVR7hG.js";import"./pkg-style-to-object-BBLxsZ82.js";import"./pkg-inline-style-parser-D4u_cg7q.js";import"./pkg-estree-util-is-identifier-name-BgBfM8ME.js";import"./pkg-html-url-attributes-D46m5wfe.js";import"./pkg-micromark-extension-gfm-B0DctPzH.js";import"./pkg-micromark-extension-gfm-autolink-literal-DBUxU-6S.js";import"./pkg-micromark-extension-gfm-footnote-DBQxKibT.js";import"./pkg-micromark-extension-gfm-strikethrough-DP_nekd2.js";import"./pkg-micromark-extension-gfm-table-BwEzuKcM.js";import"./pkg-micromark-extension-gfm-task-list-item-Bh-RsFa-.js";import"./pkg-mdast-util-gfm-CpKz74zx.js";import"./pkg-mdast-util-gfm-autolink-literal-Dncmbeag.js";import"./pkg-ccount-c2V3InAJ.js";import"./pkg-mdast-util-find-and-replace-DRnaru6o.js";import"./pkg-escape-string-regexp-BaJN9MlJ.js";import"./pkg-mdast-util-gfm-footnote-Fj4BtPn2.js";import"./pkg-mdast-util-gfm-strikethrough-Cj9qKt6Q.js";import"./pkg-mdast-util-gfm-table-ZH_uo1A0.js";import"./pkg-markdown-table-DvhhVmnL.js";import"./pkg-mdast-util-to-markdown-inCPN5xz.js";import"./pkg-zwitch-C2o2j-tx.js";import"./pkg-longest-streak-CtXnX3Xp.js";import"./pkg-mdast-util-gfm-task-list-item-BAonFiNm.js";import"./pkg-micromark-extension-math-CgVsLmiT.js";import"./pkg-mdast-util-math-xlj7Pg1K.js";import"./pkg-hast-util-from-html-isomorphic-Dm2lD_eS.js";import"./pkg-hast-util-from-dom-Bra3Ahul.js";import"./pkg-fault-lzTQDqBo.js";import"./pkg-format-Jkd_0D2M.js";import"./pkg-refractor-Ch9JKb1r.js";import"./pkg-parse-entities-xsQacvMO.js";import"./pkg-character-entities-legacy-BSd6ekHp.js";import"./pkg-character-reference-invalid-AKrgFUtc.js";import"./pkg-is-decimal-Bg2oiju0.js";import"./pkg-is-hexadecimal-yh8m6GRc.js";import"./pkg-is-alphanumerical-DYCKc-AM.js";import"./pkg-is-alphabetical-BQ1fjZEF.js";import"./pkg-prismjs-roPZ7vEp.js";import"./pkg-at-babel-runtime-BlVrb8V_.js";import"./pkg-d3-transition-Be1UnZzk.js";import"./pkg-d3-timer-DdKHrDhs.js";import"./pkg-d3-dispatch-kxCwF96_.js";import"./pkg-d3-interpolate-Iy2XDU8a.js";import"./pkg-d3-color-amxIadob.js";import"./pkg-d3-ease-DRPgKoYJ.js";import"./pkg-d3-quadtree-CSANTnla.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const Sn={md:768,lg:1024,xl:1280,"2xl":1536},va=()=>{if(typeof window>"u")return"sm";const s=window.innerWidth;return s>=Sn["2xl"]?"2xl":s>=Sn.xl?"xl":s>=Sn.lg?"lg":s>=Sn.md?"md":"sm"},ol=()=>{const s=va();return s==="sm"||s==="md"},Mh=()=>va()==="lg",Ih=()=>{const s=va();return s==="xl"||s==="2xl"},il=m.createContext(void 0);function Th({children:s}){const[t,n]=m.useState("sm");m.useEffect(()=>{const r=()=>{n(va())};return r(),window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[]);const a={currentBreakpoint:t,isMobile:ol(),isTablet:Mh(),isDesktop:Ih()};return e.jsx(il.Provider,{value:a,children:s})}function ll(){const s=m.useContext(il);if(s===void 0)throw new Error("useBreakpoint must be used within a BreakpointProvider");return s}function E(...s){return Ud(Fd(s))}const Eh=Mr("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function M({className:s,variant:t,size:n,asChild:a=!1,...r}){const o=a?vi:"button";return e.jsx(o,{"data-slot":"button",className:E(Eh({variant:t,size:n,className:s})),...r})}function Jt({...s}){return e.jsx(wi,{"data-slot":"dialog",...s})}function cl({...s}){return e.jsx(Zc,{"data-slot":"dialog-trigger",...s})}function Ah({...s}){return e.jsx(Ni,{"data-slot":"dialog-portal",...s})}function Rh({className:s,...t}){return e.jsx(Ci,{"data-slot":"dialog-overlay",className:E("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",s),...t})}function Zt({className:s,children:t,showCloseButton:n=!0,onWheel:a,...r}){const{t:o}=L(),i=l=>{l.stopPropagation(),a?.(l)};return e.jsxs(Ah,{"data-slot":"dialog-portal",children:[e.jsx(Rh,{}),e.jsxs(yi,{"data-slot":"dialog-content",className:E("bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",s),...r,onWheel:i,children:[t,n&&e.jsxs(ji,{"data-slot":"dialog-close",className:"data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",children:[e.jsx(fe,{}),e.jsx("span",{className:"sr-only",children:o("common.close")})]})]})]})}function Ds({className:s,...t}){return e.jsx("div",{"data-slot":"dialog-header",className:E("flex flex-col gap-2 text-center sm:text-left",s),...t})}function Or({className:s,...t}){return e.jsx("div",{"data-slot":"dialog-footer",className:E("flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",s),...t})}function _s({className:s,...t}){return e.jsx(Xc,{"data-slot":"dialog-title",className:E("text-lg leading-none font-semibold",s),...t})}function wa({className:s,...t}){return e.jsx(Jc,{"data-slot":"dialog-description",className:E("text-muted-foreground text-sm",s),...t})}const kt=_e()((s,t)=>({isOpen:!1,options:{},isOkLoading:!1,error:null,show:n=>{s({isOpen:!0,options:n,isOkLoading:!1,error:null})},confirm:n=>{t().show({...n,okText:n.okText??"Confirm",cancelText:n.cancelText??"Cancel"})},close:()=>{s({isOpen:!1})},handleOk:async()=>{const{options:n}=t();s({isOkLoading:!0,error:null});try{await n.onOk?.();const a=t().options.afterClose;s({isOpen:!1}),a?.()}catch(a){const r=a instanceof Error?a.message:"Operation failed";s({error:r})}finally{s({isOkLoading:!1})}},handleCancel:()=>{const{options:n}=t();n.onCancel?.();const a=n.afterClose;s({isOpen:!1}),a?.()}})),Ee={show:s=>kt.getState().show(s),confirm:s=>kt.getState().confirm(s),close:()=>kt.getState().close()};function Lh({children:s}){const t=kt(l=>l.isOpen),n=kt(l=>l.options),a=kt(l=>l.isOkLoading),r=kt(l=>l.error),o=kt(l=>l.handleOk),i=kt(l=>l.handleCancel);return e.jsxs(e.Fragment,{children:[s,e.jsx(Jt,{open:t,onOpenChange:l=>!l&&i(),children:e.jsxs(Zt,{className:E(n.className),children:[n.title&&e.jsxs(Ds,{children:[e.jsx(_s,{children:n.title}),n.description&&e.jsx(wa,{children:n.description})]}),n.content,r&&e.jsx("div",{className:"mt-2 text-sm text-red-600 dark:text-red-400",children:r}),n.showFooter!==!1&&e.jsxs(Or,{children:[e.jsx(M,{variant:"outline",onClick:i,disabled:a,children:n.cancelText??"Cancel"}),e.jsx(M,{onClick:o,disabled:a,variant:n.okVariant==="destructive"?"destructive":void 0,children:a?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"}),n.okLoadingText??n.okText??"Processing..."]}):n.okText??"Confirm"})]})]})})]})}const dl=m.createContext(null),ko="app-theme";function So(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function Dh({children:s}){const[t,n]=m.useState(()=>typeof window>"u"?"system":localStorage.getItem(ko)||"system"),[a,r]=m.useState(typeof window>"u"?"light":So());m.useEffect(()=>{const u=window.matchMedia("(prefers-color-scheme: dark)"),h=g=>{r(g.matches?"dark":"light")};return u.addEventListener("change",h),()=>u.removeEventListener("change",h)},[]);const o=u=>{n(u),localStorage.setItem(ko,u);const h=window.document.documentElement;if(u==="system"){const g=So()==="dark";h.classList.toggle("dark",g)}else h.classList.toggle("dark",u==="dark");h.classList.add("theme-transition"),setTimeout(()=>{h.classList.remove("theme-transition")},300)},i=()=>{o((t==="system"?a:t)==="dark"?"light":"dark")};m.useEffect(()=>{const u=window.document.documentElement,h=t==="system"?a==="dark":t==="dark";u.classList.toggle("dark",h)},[t,a]);const l=t==="system"?a==="dark":t==="dark",c=m.useMemo(()=>E("h-screen w-screen flex flex-col overflow-hidden",l?"bg-gray-900":"bg-gray-50"),[l]),d={theme:t,setTheme:o,isDarkMode:l,toggleDarkMode:i,rootClassName:c};return e.jsx(dl.Provider,{value:d,children:s})}function ul(){const s=m.useContext(dl);if(!s)throw new Error("useTheme must be used within a ThemeProvider");return s}const Mo=({...s})=>e.jsx(Fu,{position:"top-right",duration:1400,className:"toaster group",...s});function on({className:s,...t}){return e.jsx("div",{"data-slot":"card",className:E("bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",s),...t})}function ml({className:s,...t}){return e.jsx("div",{"data-slot":"card-header",className:E("@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",s),...t})}function hl({className:s,...t}){return e.jsx("div",{"data-slot":"card-title",className:E("leading-none font-semibold",s),...t})}function gl({className:s,...t}){return e.jsx("div",{"data-slot":"card-description",className:E("text-muted-foreground text-sm",s),...t})}function $r({className:s,...t}){return e.jsx("div",{"data-slot":"card-content",className:E("px-6",s),...t})}const _h=()=>{const[s,t]=m.useState(null),[n,a]=m.useState(!1),[r,o]=m.useState(!1);m.useEffect(()=>{const d=g=>{g.preventDefault(),t(g),!r&&localStorage.getItem("pwa-install-dismissed")!=="true"&&a(!0)},u=()=>{o(!0),a(!1),t(null)};return(()=>{const g=window.matchMedia("(display-mode: standalone)").matches,x=window.navigator.standalone===!0,f=g||x;o(f),f&&a(!1)})(),window.addEventListener("beforeinstallprompt",d),window.addEventListener("appinstalled",u),()=>{window.removeEventListener("beforeinstallprompt",d),window.removeEventListener("appinstalled",u)}},[r]);const i=async()=>{if(!s)return;s.prompt();const{outcome:d}=await s.userChoice;console.log(d==="accepted"?"PWA installation accepted":"PWA installation dismissed"),t(null),a(!1)},l=()=>{a(!1),localStorage.setItem("pwa-install-dismissed","true")},{t:c}=L();return r||!n||localStorage.getItem("pwa-install-dismissed")==="true"?null:e.jsx("div",{className:"fixed bottom-4 left-4 right-4 z-50 md:left-auto md:right-4 md:max-w-sm",children:e.jsxs(on,{className:"border-2 border-blue-500 shadow-lg",children:[e.jsxs(ml,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(hl,{className:"text-lg",children:c("pwa.install.title")}),e.jsx(M,{variant:"ghost",size:"sm",onClick:l,className:"h-6 w-6 p-0",children:e.jsx(fe,{className:"h-4 w-4"})})]}),e.jsx(gl,{children:c("pwa.install.description")})]}),e.jsx($r,{className:"pt-0",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{onClick:i,className:"flex-1",children:c("pwa.install.button")}),e.jsx(M,{variant:"outline",onClick:l,children:c("pwa.install.later")})]})})]})})},Ph=()=>{const[s,t]=m.useState(!1),[n,a]=m.useState(!1);m.useEffect(()=>{const l=()=>{t(!0)};return"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",c=>{c.data&&c.data.type==="SW_UPDATE_AVAILABLE"&&t(!0)}),()=>{"serviceWorker"in navigator&&navigator.serviceWorker.removeEventListener("message",l)}},[]);const r=async()=>{a(!0);try{if("serviceWorker"in navigator){const l=await navigator.serviceWorker.getRegistration();l&&l.waiting&&l.waiting.postMessage({type:"SKIP_WAITING"})}window.location.reload()}catch(l){console.error("Failed to update app:",l),a(!1)}},o=()=>{t(!1)},{t:i}=L();return s?e.jsx("div",{className:"fixed top-4 left-4 right-4 z-50 md:left-auto md:right-4 md:max-w-sm",children:e.jsxs(on,{className:"border-2 border-green-500 shadow-lg",children:[e.jsxs(ml,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(hl,{className:"text-lg flex items-center gap-2",children:[e.jsx(Es,{className:"h-5 w-5"}),i("pwa.update.title")]}),e.jsx(M,{variant:"ghost",size:"sm",onClick:o,className:"h-6 w-6 p-0",children:e.jsx(fe,{className:"h-4 w-4"})})]}),e.jsx(gl,{children:i("pwa.update.description")})]}),e.jsx($r,{className:"pt-0",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{onClick:r,disabled:n,className:"flex-1",children:n?e.jsxs(e.Fragment,{children:[e.jsx(Es,{className:"mr-2 h-4 w-4 animate-spin"}),i("pwa.update.updating")]}):i("pwa.update.button")}),e.jsx(M,{variant:"outline",onClick:o,children:i("pwa.update.later")})]})})]})}):null},Oh=()=>{const[s,t]=m.useState({isInstalled:!1,isOnline:navigator.onLine,isUpdateAvailable:!1,installPrompt:null});return m.useEffect(()=>{const r=()=>{const u=window.matchMedia("(display-mode: standalone)").matches,h=window.navigator.standalone===!0;t(g=>({...g,isInstalled:u||h}))},o=()=>t(u=>({...u,isOnline:!0})),i=()=>t(u=>({...u,isOnline:!1})),l=u=>{u.preventDefault(),t(h=>({...h,installPrompt:u}))},c=()=>{t(u=>({...u,isInstalled:!0,installPrompt:null}))},d=()=>{t(u=>({...u,isUpdateAvailable:!0}))};return r(),window.addEventListener("online",o),window.addEventListener("offline",i),window.addEventListener("beforeinstallprompt",l),window.addEventListener("appinstalled",c),"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",u=>{u.data&&u.data.type==="SW_UPDATE_AVAILABLE"&&d()}),()=>{window.removeEventListener("online",o),window.removeEventListener("offline",i),window.removeEventListener("beforeinstallprompt",l),window.removeEventListener("appinstalled",c)}},[]),{...s,installApp:async()=>{if(!s.installPrompt)return!1;try{const r=s.installPrompt;r.prompt();const{outcome:o}=await r.userChoice;return o==="accepted"?(t(i=>({...i,installPrompt:null})),!0):!1}catch(r){return console.error("Failed to install app:",r),!1}},updateApp:async()=>{try{if("serviceWorker"in navigator){const r=await navigator.serviceWorker.getRegistration();r&&r.waiting&&r.waiting.postMessage({type:"SKIP_WAITING"})}window.location.reload()}catch(r){console.error("Failed to update app:",r)}}}},$h=Mr("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 dark:bg-destructive/60",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function He({className:s,variant:t,asChild:n=!1,...a}){const r=n?vi:"span";return e.jsx(r,{"data-slot":"badge",className:E($h({variant:t}),s),...a})}const Bh=()=>{const{t:s}=L(),{isInstalled:t,isOnline:n,isUpdateAvailable:a}=Oh();return t&&n&&!a?null:e.jsxs("div",{className:"fixed top-4 right-4 z-40 flex gap-2",children:[!n&&e.jsxs(He,{variant:"destructive",className:"flex items-center gap-1",children:[e.jsx(Hd,{className:"h-3 w-3"}),s("pwa.status.offline")]}),a&&e.jsxs(He,{variant:"default",className:"flex items-center gap-1",children:[e.jsx(Es,{className:"h-3 w-3"}),s("pwa.status.updateAvailable")]})]})},Io="https://firebase-auth-api.agentverse.cc",Uh="firebase-api.agentverse.cc",pl={apiKey:"AIzaSyAR5kNhhjt2-oJWbbZm_JmyqCT2EkTT60E",authDomain:"echo-note-9fe01.firebaseapp.com",projectId:"echo-note-9fe01",storageBucket:"echo-note-9fe01.firebasestorage.app",messagingSenderId:"339659564131",appId:"1:339659564131:web:2d7e9782ac4423d3384456",measurementId:"G-QS4CHWNFH2"},lr=em(pl),Fh=()=>{const s={host:Uh,ssl:!0,ignoreUndefinedProperties:!0,experimentalForceLongPolling:!1};try{return No(lr,{...s,localCache:tm({tabManager:sm()})})}catch(t){return console.warn("[firebase] Failed to enable persistent cache, falling back to memory cache.",t),No(lr,s)}},zh=Fh(),Hh=s=>{const t=localStorage.getItem("region");return t||s},Gh=s=>{localStorage.setItem("region",s)},To="CN";class Ss{static instance=null;app=lr;auth=null;analytics=null;db=zh;region=Hh(To);hadCachedRegionAtBoot=localStorage.getItem("region")!==null;regionInitPromise;constructor(){this.getAuth(),this.regionInitPromise=this.validateRegionAndMaybeReloadPage()}static getInstance(){return Ss.instance||(Ss.instance=new Ss),Ss.instance}getApp(){return this.app}isInCNRegion(){return this.region===To}supportGoogleAuth(){return!this.isInCNRegion()}async fetchRegion(){let t=this.region;try{const n=await fetch(`${Io}/api/location`);n.ok&&(t=(await n.json()).country||"XX")}catch(n){console.error("Failed to fetch user country, keeping existing region.",n)}return t}async validateRegionAndMaybeReloadPage(){try{const t=await this.fetchRegion();if(!t)return;Gh(t),t!==this.region&&(this.region=t,window.location.reload())}catch(t){console.warn("[FirebaseConfig] validateRegion failed, skipping reload",t)}}hasCachedRegion(){return this.hadCachedRegionAtBoot}whenRegionReadyForUi(){return this.hadCachedRegionAtBoot?Promise.resolve():this.regionInitPromise}getAuth(){return this.auth||(this.isInCNRegion()?(this.auth=Wu(this.getApp(),{persistence:Yu}),qu(this.auth,Io,{disableWarnings:!0})):this.auth=Ku(this.getApp())),this.auth}getAnalytics(){return this.analytics?this.analytics:this.isInCNRegion()?(console.log("[FirebaseConfig] In CN region, Analytics is disabled."),null):(console.log("[FirebaseConfig] Initializing Analytics for non-CN region."),pl.measurementId?this.analytics=zu(this.getApp()):console.warn("[FirebaseConfig] measurementId is not provided, Analytics will not be initialized."),this.analytics)}setUserIdForAnalytics(t){this.getAnalytics()&&Hu(this.getAnalytics(),t)}getDb(){return this.db}}const ne=Ss.getInstance();let Mn=!1;const Ie={signInWithGoogle:async()=>{if(console.log("[firebaseAuthService] signInWithGoogle"),!ne.supportGoogleAuth())throw new Error("Google authentication is not supported in this region");const s=new Zu;try{const t=await ne.getAuth();return(await Qu(t,s)).user}catch(t){return console.error("Google Sign-In Error:",t),null}},sendSignUpLink:async(s,t,n)=>{try{Mn=!0;try{const a=await ne.getAuth(),r=await jo(a,s,t);return n&&await Ta(r.user,{displayName:n}),await Fs(r.user),await Us(a),{verificationSent:!0}}catch(a){if(a.code==="auth/email-already-in-use")try{const r=await ne.getAuth(),o=await yo(r,s,t);if(o.user.emailVerified)throw new Error("EMAIL_ALREADY_VERIFIED");return n&&await Ta(o.user,{displayName:n}),await Fs(o.user),await Us(r),{verificationSent:!0}}catch(r){throw r.code==="auth/wrong-password"||r.code==="auth/invalid-credential"?new Error("ACCOUNT_EXISTS_WRONG_PASSWORD"):r}throw a}}catch(a){throw Mn=!1,console.error("Send Sign-Up Link Error:",a),a}finally{Mn=!1}},signUpWithEmail:async(s,t,n)=>{try{const a=await ne.getAuth(),r=await jo(a,s,t);return n&&await Ta(r.user,{displayName:n}),await Fs(r.user),await Us(a),{user:r.user,verificationSent:!0}}catch(a){throw console.error("Email Sign-Up Error:",a),a}},sendEmailVerification:async s=>{try{await Fs(s)}catch(t){throw console.error("Email Verification Error:",t),t}},signInWithEmail:async(s,t)=>{try{const n=await ne.getAuth(),a=await yo(n,s,t);if(!a.user.emailVerified)throw await Fs(a.user),await Us(n),new Error("EMAIL_NOT_VERIFIED_RESENT");return a.user}catch(n){throw console.error("âŒ Email Sign-In Error:",n),n}},sendPasswordReset:async s=>{try{const t=await ne.getAuth();await Ju(t,s)}catch(t){throw console.error("Password Reset Error:",t),t}},signOut:async()=>{const s=await ne.getAuth();await Us(s)},onAuthStateChanged:async s=>{const t=await ne.getAuth();return Xu(t,n=>{Mn||s(n)})},getCurrentUser:async()=>(await ne.getAuth()).currentUser,checkEmailVerification:async()=>{const t=(await ne.getAuth()).currentUser;return t?(await t.reload(),t.emailVerified):!1}};var ee=(s=>(s.IDLE="idle",s.AUTHENTICATING="authenticating",s.VERIFYING_EMAIL="verifying-email",s.INITIALIZING_DATA="initializing-data",s.COMPLETE="complete",s.ERROR="error",s))(ee||{}),xt=(s=>(s.CONNECTING_GOOGLE="Connecting to Google...",s.VERIFYING_CREDENTIALS="Verifying credentials...",s.CHECKING_EMAIL_VERIFICATION="Checking email verification...",s.SETTING_UP_WORKSPACE="Setting up your workspace...",s.WELCOME_BACK="Welcome back!",s.SIGN_IN_FAILED="Sign-in failed. Please try again.",s.CHECK_CREDENTIALS="Sign-in failed. Please check your credentials.",s.CREATING_ACCOUNT="Creating your account...",s.SENDING_VERIFICATION="Sending verification email...",s.ACCOUNT_CREATED="Account created successfully!",s))(xt||{}),bt=(s=>(s[s.START=0]="START",s[s.AUTHENTICATING=25]="AUTHENTICATING",s[s.VERIFYING_EMAIL=50]="VERIFYING_EMAIL",s[s.INITIALIZING_DATA=75]="INITIALIZING_DATA",s[s.COMPLETE=100]="COMPLETE",s))(bt||{});const Eo=["ðŸ’¡","ðŸ“","ðŸ“Œ","ðŸ“š","ðŸ§ ","âœ¨","ðŸ“","ðŸ“’","ðŸ““","ðŸ—‚ï¸","ðŸŒŸ","ðŸ§©","ðŸ—’ï¸","ðŸ“Ž","ðŸ—³ï¸","ðŸŽ¯"];function cr(s){const t=Math.floor(Math.random()*Eo.length);return Eo[t]}const dr="stillroot-recent-channels",Vh=8;function Wh(s){try{const t=localStorage.getItem(dr);let n=t?JSON.parse(t):[];n=n.filter(a=>a.channelId!==s),n.unshift({channelId:s,accessedAt:Date.now()}),n=n.slice(0,Vh),localStorage.setItem(dr,JSON.stringify(n))}catch(t){console.warn("Failed to save recent channel",t)}}function qh(){try{const s=localStorage.getItem(dr);return s?JSON.parse(s).map(n=>n.channelId):[]}catch(s){return console.warn("Failed to load recent channels",s),[]}}const J=_e()(Xt((s,t)=>({currentChannelId:null,lastChannelIdByUserId:{},hasHydrated:!1,isAddingMessage:!1,isUpdatingMessage:!1,isDeletingMessage:!1,currentUser:null,setAuth:n=>{s({currentUser:n})},setCurrentChannel:n=>{const a=O.getState().userId;s(r=>({currentChannelId:n,lastChannelIdByUserId:a&&n?{...r.lastChannelIdByUserId,[a]:n}:r.lastChannelIdByUserId})),n&&Wh(n)},setHasHydrated:n=>{s({hasHydrated:n})},setIsAddingMessage:n=>{s({isAddingMessage:n})},setIsUpdatingMessage:n=>{s({isUpdatingMessage:n})},setIsDeletingMessage:n=>{s({isDeletingMessage:n})},addMessage:async n=>{t().setIsAddingMessage(!0);try{await O.getState().addMessage(n)}finally{t().setIsAddingMessage(!1)}},deleteMessage:async n=>{t().setIsDeletingMessage(!0);try{await O.getState().deleteMessage(n)}finally{t().setIsDeletingMessage(!1)}},updateMessage:async(n,a)=>{t().setIsUpdatingMessage(!0);try{await O.getState().updateMessage(n,a)}finally{t().setIsUpdatingMessage(!1)}}}),{name:"stillroot-notes-view-storage",version:2,partialize:s=>({lastChannelIdByUserId:s.lastChannelIdByUserId}),onRehydrateStorage:()=>(s,t)=>{t||s?.setHasHydrated(!0)},migrate:(s,t)=>t<2&&s&&typeof s=="object"?{lastChannelIdByUserId:s.lastChannelIdByUserId??{}}:s}));class zn extends cm{emit(t){this.next(t)}listen(t){const n=this.subscribe(t);return()=>n.unsubscribe()}}const In=s=>{const t=s.data();return{id:s.id,name:t.name,description:t.description,emoji:t.emoji,createdAt:t.createdAt?.toDate()||new Date,updatedAt:t.updatedAt?t.updatedAt.toDate():void 0,messageCount:t.messageCount||0,lastMessageTime:t.lastMessageTime?.toDate(),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,shareToken:t.shareToken,shareMode:t.shareMode||(t.shareToken?"read-only":void 0)}},Cs=s=>{const t=s.data();let n;return t.timestamp?t.timestamp instanceof rm||t.timestamp.toDate&&typeof t.timestamp.toDate=="function"?n=t.timestamp.toDate():t.timestamp instanceof Date?n=t.timestamp:(console.warn("Invalid timestamp format in document:",s.id,t.timestamp),n=new Date):(console.warn("Missing timestamp in document:",s.id),n=new Date),{id:s.id,content:t.content,sender:t.sender,channelId:t.channelId,timestamp:n,tags:t.tags,parentId:t.parentId,threadId:t.threadId,isThreadExpanded:t.isThreadExpanded,threadCount:t.threadCount,aiAnalysis:t.aiAnalysis,isDeleted:t.isDeleted||!1,deletedAt:t.deletedAt?t.deletedAt.toDate():void 0,deletedBy:t.deletedBy,canRestore:t.canRestore}},gt=s=>ze(ne.getDb(),`users/${s}/channels`),rt=s=>ze(ne.getDb(),`users/${s}/messages`);class Kh{async getChannel(t,n){try{const a=await gt(t),o=(await Se(be(a,ie("isDeleted","==",!1),ie("__name__","==",n)))).docs[0];return o?In(o):null}catch(a){return console.warn("[firebaseNotesService.getChannel] failed",a),null}}subscribeToChannels=(t,n)=>{console.log("ðŸ”” [firebaseNotesService][subscribeToChannels]:",{userId:t});const a=be(gt(t),ie("isDeleted","==",!1),Ve("lastMessageTime","desc"));return Js(a,o=>{const i=o.docs.map(In);n(i)},o=>{console.error("Error subscribing to channels:",o),n([])})};subscribeToChannelMessages=(t,n,a,r)=>{console.log("ðŸ”” [firebaseNotesService][subscribeToChannelMessages]:",{userId:t,channelId:n,messagesLimit:a});const o=be(rt(t),ie("isDeleted","==",!1),ie("channelId","==",n),ie("sender","==","user"),Ve("timestamp","desc"),Gt(a));return Js(o,l=>{const c=l.docs.map(Cs),d=c.length>=a;r(c,d)},l=>{console.error("Error subscribing to channel messages:",l)})};fetchChannels=async t=>{console.log("ðŸ”” [firebaseNotesService][fetchChannels]:",{userId:t});const n=be(gt(t),ie("isDeleted","==",!1),Ve("lastMessageTime","desc"));return(await Se(n)).docs.map(In)};createChannel=async(t,n)=>{const a=Object.fromEntries(Object.entries(n).filter(([,o])=>o!==void 0));return(await Ea(gt(t),{...a,createdAt:ce(),updatedAt:ce(),messageCount:0,isDeleted:!1,lastMessageTime:ce()})).id};updateChannel=async(t,n,a)=>{const r=me(gt(t),n),o={};for(const[i,l]of Object.entries(a))l===void 0?o[i]=om():o[i]=l;o.updatedAt=ce(),await Te(r,o)};deleteChannel=async(t,n)=>{console.log("ðŸ”” [firebaseNotesService][deleteChannel]:",{userId:t,channelId:n});const a=me(gt(t),n);await Te(a,{isDeleted:!0,deletedAt:ce(),deletedBy:t});try{const r=be(rt(t),ie("channelId","==",n),ie("isDeleted","==",!1)),o=await Se(r),i=500;for(let l=0;l<o.docs.length;l+=i){const d=o.docs.slice(l,l+i).map(u=>Te(u.ref,{isDeleted:!0,deletedAt:ce(),deletedBy:t,deletedChannelId:n}));await Promise.all(d)}console.log("ðŸ”” [firebaseNotesService][deleteChannel]: Successfully soft deleted channel and messages",{channelId:n,messageCount:o.docs.length})}catch(r){throw console.error("ðŸ”” [firebaseNotesService][deleteChannel]: Error soft deleting messages:",r),new Error(`Channel soft deleted but failed to soft delete associated messages: ${r}`)}};restoreChannel=async(t,n)=>{console.log("ðŸ”” [firebaseNotesService][restoreChannel]:",{userId:t,channelId:n});const a=me(gt(t),n);await Te(a,{isDeleted:!1,deletedAt:null,deletedBy:null});try{const r=be(rt(t),ie("channelId","==",n),ie("isDeleted","==",!0),ie("deletedChannelId","==",n)),o=await Se(r),i=500;for(let l=0;l<o.docs.length;l+=i){const d=o.docs.slice(l,l+i).map(u=>Te(u.ref,{isDeleted:!1,deletedAt:null,deletedBy:null,deletedChannelId:null}));await Promise.all(d)}console.log("ðŸ”” [firebaseNotesService][restoreChannel]: Successfully restored channel and messages",{channelId:n,messageCount:o.docs.length})}catch(r){throw console.error("ðŸ”” [firebaseNotesService][restoreChannel]: Error restoring messages:",r),new Error(`Channel restored but failed to restore associated messages: ${r}`)}};fetchInitialMessages=async(t,n,a)=>{console.log("ðŸ”” [firebaseNotesService][fetchInitialMessages]:",{userId:t,channelId:n,messagesLimit:a});const r=be(rt(t),ie("isDeleted","==",!1),ie("channelId","==",n),ie("sender","==","user"),Ve("timestamp","desc"),Gt(a)),o=await Se(r),i=o.docs.map(Cs),l=o.docs[o.docs.length-1],c=i.length<a;return{messages:i,lastVisible:l,allLoaded:c}};fetchInitialMessagesAllSenders=async(t,n,a)=>{const r=be(rt(t),ie("isDeleted","==",!1),ie("channelId","==",n),Ve("timestamp","desc"),Gt(a));try{const o=await Se(r),i=o.docs.map(Cs),l=o.docs[o.docs.length-1],c=i.length<a;return{messages:i,lastVisible:l,allLoaded:c}}catch(o){throw console.error("âŒ [firebaseNotesService][fetchInitialMessagesAllSenders] failed",o),o}};fetchMoreMessages=async(t,n,a,r)=>{console.log("ðŸ”” [firebaseNotesService][fetchMoreMessages]:",{userId:t,channelId:n,messagesLimit:a,cursor:r});const o=be(rt(t),ie("isDeleted","==",!1),ie("channelId","==",n),ie("sender","==","user"),Ve("timestamp","desc"),nr(r),Gt(a)),i=await Se(o),l=i.docs.map(Cs),c=i.docs[i.docs.length-1],d=l.length<a;return{messages:l,lastVisible:c,allLoaded:d}};subscribeToNewMessages=(t,n,a,r)=>{console.log("ðŸ”” [firebaseNotesService][subscribeToNewMessages]:",{userId:t,channelId:n,afterTimestamp:a});const o=be(rt(t),ie("isDeleted","==",!1),ie("channelId","==",n),ie("sender","==","user"),ie("timestamp",">",a),Ve("timestamp","desc"));return Js(o,l=>{const c=l.docs.map(Cs);r(c)},l=>{console.error("Error subscribing to new messages:",l)})};createMessage=async(t,n)=>{const a=Object.fromEntries(Object.entries(n).filter(([,i])=>i!==void 0)),r=await Ea(rt(t),{...a,timestamp:ce(),isDeleted:!1}),o=me(gt(t),n.channelId);return await Te(o,{lastMessageTime:ce(),messageCount:rs(1)}),r.id};updateMessage=async(t,n,a)=>{const r=me(ne.getDb(),`users/${t}/messages/${n}`);await Te(r,a)};moveMessage=async(t,n,a,r)=>{if(a===r)return;const o=ne.getDb(),i=me(o,`users/${t}/messages/${n}`),l=await Vt(i);if(!l.exists())throw new Error("Message not found");if(l.data()?.channelId===r)return;const d=await Se(be(rt(t),ie("threadId","==",n))),u=nm(o);u.update(i,{channelId:r}),d.docs.forEach(f=>{u.update(f.ref,{channelId:r})});const h=1+d.docs.length,g=me(gt(t),a),x=me(gt(t),r);u.update(g,{messageCount:rs(-h),updatedAt:ce()}),u.update(x,{messageCount:rs(h),lastMessageTime:ce(),updatedAt:ce()}),await u.commit()};deleteMessage=async(t,n)=>{const a=me(ne.getDb(),`users/${t}/messages/${n}`);await Fn(a)};softDeleteMessage=async(t,n)=>{const a=me(ne.getDb(),`users/${t}/messages/${n}`);await Te(a,{isDeleted:!0,deletedAt:ce(),deletedBy:t})};restoreMessage=async(t,n)=>{const a=me(ne.getDb(),`users/${t}/messages/${n}`);await Te(a,{isDeleted:!1,deletedAt:null,deletedBy:null})};getDeletedMessages=async(t,n)=>{console.log("ðŸ”” [firebaseNotesService][getDeletedMessages]:",{userId:t,channelId:n});try{let a=be(rt(t),ie("isDeleted","==",!0),Ve("deletedAt","desc"));return n&&(a=be(rt(t),ie("isDeleted","==",!0),ie("channelId","==",n),ie("sender","==","user"),Ve("deletedAt","desc"))),(await Se(a)).docs.map(Cs)}catch(a){return console.error("ðŸ”” [Firebase] [getDeletedMessages]: Error fetching deleted messages:",a),[]}};publishSpace=async(t,n,a="read-only")=>{const r=fs();return await this.updateChannel(t,n,{shareToken:r,shareMode:a}),r};unpublishSpace=async(t,n)=>{await this.updateChannel(t,n,{shareToken:void 0,shareMode:void 0})};findChannelByShareToken=async t=>{try{const n=ne.getDb(),a=be(am(n,"channels"),ie("shareToken","==",t),ie("isDeleted","==",!1),Gt(1)),r=await Se(a);if(r.empty)return null;const o=r.docs[0],i=In(o),l=o.ref.path.split("/"),c=l.indexOf("users");if(c===-1||c+1>=l.length)return console.warn("[firebaseNotesService.findChannelByShareToken] Invalid document path:",o.ref.path),null;const d=l[c+1];return{channel:i,userId:d}}catch(n){return console.error("[firebaseNotesService.findChannelByShareToken] failed",n),null}};createMessageForPublicSpace=async(t,n)=>{const a=await this.findChannelByShareToken(t);if(!a)throw new Error("Channel not found or not published");if(a.channel.shareMode!=="append-only")throw new Error("This space is read-only. Messages cannot be added.");const r=Object.fromEntries(Object.entries(n).filter(([,l])=>l!==void 0)),o=await Ea(rt(a.userId),{...r,timestamp:ce(),isDeleted:!1}),i=me(gt(a.userId),a.channel.id);return await Te(i,{lastMessageTime:ce(),messageCount:rs(1)}),o.id}}const ge=new Kh;class ya{capabilities={realtime:!0,pagination:"cursor"};static MAX_CURSOR_CACHE=256;cursorMap=new Map;async listChannels(t){return ge.fetchChannels(t)}subscribeChannels(t,n){return ge.subscribeToChannels(t,n)}async createChannel(t,n){return ge.createChannel(t,n)}async updateChannel(t,n,a){return ge.updateChannel(t,n,a)}async deleteChannel(t,n){return ge.deleteChannel(t,n)}async listMessages(t,n,a){const r=a.includeSenders??["user"],o=a.cursor??null,i=a.limit;if(!o){const h=r.includes("ai")&&r.includes("user")?await ge.fetchInitialMessagesAllSenders(t,n,i):await ge.fetchInitialMessages(t,n,i),g=h.allLoaded||!h.lastVisible?null:this.registerCursor(h.lastVisible);return{items:h.messages,nextCursor:g}}const l=this.cursorMap.get(o);if(!l)throw new Error("Invalid cursor (expired). Please reload messages.");this.cursorMap.delete(o),this.cursorMap.set(o,l);const c=await ge.fetchMoreMessages(t,n,i,l),d=c.allLoaded||!c.lastVisible?null:this.registerCursor(c.lastVisible);return{items:c.messages,nextCursor:d}}subscribeNewMessages(t,n,a,r){return ge.subscribeToNewMessages(t,n,a,r)}async createMessage(t,n){return ge.createMessage(t,n)}async updateMessage(t,n,a){return ge.updateMessage(t,n,a)}async deleteMessage(t,n,a={}){return a.hardDelete?ge.deleteMessage(t,n):ge.softDeleteMessage(t,n)}async restoreMessage(t,n){return ge.restoreMessage(t,n)}async moveMessage(t,n,a,r){return ge.moveMessage(t,n,a,r)}async publishSpace(t,n,a="read-only"){return ge.publishSpace(t,n,a)}async unpublishSpace(t,n){return ge.unpublishSpace(t,n)}registerCursor(t){const n=fs();if(this.cursorMap.set(n,t),this.cursorMap.size>ya.MAX_CURSOR_CACHE){const a=this.cursorMap.keys().next().value;a&&this.cursorMap.delete(a)}return n}}function zs(s){return{id:s.uid,email:s.email,displayName:s.displayName,emailVerified:s.emailVerified,photoURL:s.photoURL}}class fl{async signInWithGoogle(){const t=await Ie.signInWithGoogle();return t?zs(t):null}async signInWithEmail(t,n){const a=await Ie.signInWithEmail(t,n);return a?zs(a):null}async signUpWithEmail(t,n,a){const r=await Ie.signUpWithEmail(t,n,a);return{user:zs(r.user),verificationSent:r.verificationSent}}async sendSignUpLink(t,n,a){return Ie.sendSignUpLink(t,n,a)}async sendPasswordReset(t){return Ie.sendPasswordReset(t)}async sendEmailVerification(){const t=await Ie.getCurrentUser();if(!t)throw new Error("No user logged in");return Ie.sendEmailVerification(t)}async signOut(){return Ie.signOut()}async getCurrentUser(){const t=await Ie.getCurrentUser();return t?zs(t):null}onAuthStateChanged(t){let n=null;return Ie.onAuthStateChanged(a=>{t(a?zs(a):null)}).then(a=>{n=a}),()=>{n&&n()}}}class Yh{version="1.0.0";name="Add isDeleted field to messages";description="Add isDeleted field to all messages to support soft delete functionality";createdAt=new Date("2025-01-27");async execute(t){const n=ne.getDb(),a=ze(n,`users/${t}/messages`),r=await Se(a);let o=0;for(const i of r.docs)if(i.data().isDeleted===void 0){const c=me(a,i.id);await Te(c,{isDeleted:!1}),o++}o>0?console.log(`   ðŸ“Š Updated ${o} messages with isDeleted field`):console.log("   â„¹ï¸  No messages needed updating")}}class Xh{version="1.0.1";name="Add lastMessageTime to channels";description="Add lastMessageTime and messageCount fields to all channels for sorting and statistics";createdAt=new Date("2025-01-27");async execute(t){const n=ne.getDb(),a=ze(n,`users/${t}/channels`),r=await Se(a);let o=0;for(const i of r.docs){const l=i.data();if(!l.lastMessageTime){const c=me(a,i.id),d=be(ze(n,`users/${t}/messages`),ie("channelId","==",i.id),Ve("timestamp","desc"),Gt(1)),u=await Se(d);if(u.empty)await Te(c,{lastMessageTime:l.createdAt||ce(),messageCount:0});else{const g=u.docs[0].data().timestamp;await Te(c,{lastMessageTime:g,messageCount:u.size})}o++}}o>0?console.log(`   ðŸ“Š Updated ${o} channels with lastMessageTime field`):console.log("   â„¹ï¸  No channels needed updating")}}class Jh{version="1.1.0";name="Add isDeleted field to channels";description="Add isDeleted field to all channels to support soft delete functionality";createdAt=new Date("2025-01-27");async execute(t){const n=ne.getDb(),a=ze(n,`users/${t}/channels`),r=await Se(a);let o=0;for(const i of r.docs)if(i.data().isDeleted===void 0){const c=me(a,i.id);await Te(c,{isDeleted:!1}),o++}o>0?console.log(`   ðŸ“Š Updated ${o} channels with isDeleted field`):console.log("   â„¹ï¸  No channels needed updating")}}class Zh{version="1.2.0";name="Create default General channel";description="Create a default channel named 'General' if the user has no channels";createdAt=new Date("2025-02-01");async execute(t){const n=ne.getDb(),a=ze(n,`users/${t}/channels`),r=me(a,"default-general"),o=await Se(be(a,ie("isDeleted","==",!1),Gt(1))),i=(await Vt(r)).exists();!o.empty||i||await Zs(r,{name:"General",description:"",createdAt:ce(),updatedAt:ce(),messageCount:0,isDeleted:!1,lastMessageTime:ce()})}}class pe{static PREFIX="[Migration]";static PREFIX_STATE="[MigrationState]";static PREFIX_EXECUTOR="[MigrationExecutor]";static PREFIX_SERVICE="[MigrationService]";static printHeader(t){console.log(`${this.PREFIX} ðŸš€ Starting migrations for user: ${t}`)}static printOverview(t,n,a){console.log(`${this.PREFIX} ðŸ“Š Status: ${t} total, ${n} completed, ${a} pending`)}static printAllCompleted(t){console.log(`${this.PREFIX} âœ… All migrations completed (${t} skipped)`)}static printPendingMigrations(t){console.log(`${this.PREFIX} ðŸš€ Pending migrations (${t.length}):`),t.forEach((n,a)=>{console.log(`${this.PREFIX}    ${a+1}. [${n.version}] ${n.name}`)})}static printMigrationStart(t,n,a){console.log(`${this.PREFIX} ðŸ”„ ${t} Executing: ${n} - ${a}`)}static printMigrationComplete(){console.log(`${this.PREFIX}    âœ… Completed`)}static printMigrationFailure(t){const n=t instanceof Error?t.message:String(t);console.log(`${this.PREFIX}    âŒ Failed: ${n}`)}static printExecutionSummary(t,n,a){console.log(`${this.PREFIX} ðŸ“ˆ Summary: ${t} executed, ${n} failed, ${a} skipped`),n===0&&console.log(`${this.PREFIX} ðŸŽ‰ All migrations completed successfully!`)}static printCriticalError(t){console.error(`${this.PREFIX} ðŸ’¥ Critical error:`,t)}static printStateInfo(t){console.log(`${this.PREFIX_STATE} â„¹ï¸  ${t}`)}static printStateError(t,n){console.error(`${this.PREFIX_STATE} âŒ ${t}`,n||"")}static printExecutorInfo(t){console.log(`${this.PREFIX_EXECUTOR} â„¹ï¸  ${t}`)}static printExecutorError(t,n){console.error(`${this.PREFIX_EXECUTOR} âŒ ${t}`,n||"")}static printServiceInfo(t){console.log(`${this.PREFIX_SERVICE} â„¹ï¸  ${t}`)}static printServiceError(t,n){console.error(`${this.PREFIX_SERVICE} âŒ ${t}`,n||"")}}const Pe=()=>({channel:{autoCreateDefault:{enabled:!0},settings:{enabled:!1},input:{emoji:{enabled:!1},image:{enabled:!1},file:{enabled:!1},voice:{enabled:!1},more:{enabled:!1},call:{enabled:!1},video:{enabled:!1}},thoughtRecord:{edit:{enabled:!0},sparks:{enabled:!0},viewDetails:{enabled:!1},bookmark:{enabled:!1},reply:{enabled:!1},tags:{enabled:!0},thread:{enabled:!1}}},ui:{globalProcess:{workspaceInit:{displayMode:"fullscreen"},branding:{enabled:!0,brandName:"StillRoot"}}},data:{migrations:{enabled:!1}}});class Qh{getMigrationsCollectionRef=t=>ze(ne.getDb(),`users/${t}/migrations`);async getUserMigrationState(t){try{const n=me(this.getMigrationsCollectionRef(t),"state"),a=await Vt(n);if(a.exists()){const r=a.data();return{userId:t,completedMigrations:r.completedMigrations||[],lastMigrationCheck:r.lastMigrationCheck?.toDate()||new Date,version:r.version||"1.0.0"}}return{userId:t,completedMigrations:[],lastMigrationCheck:new Date,version:"1.0.0"}}catch(n){return pe.printStateError("Failed to get migration state",n),{userId:t,completedMigrations:[],lastMigrationCheck:new Date,version:"1.0.0"}}}async updateUserMigrationState(t,n,a){try{const r=me(this.getMigrationsCollectionRef(t),"state");await Zs(r,{userId:t,completedMigrations:n,lastMigrationCheck:ce(),version:a}),pe.printStateInfo(`Updated migration state for user ${t}`)}catch(r){throw pe.printStateError("Failed to update migration state",r),r}}async markMigrationCompleted(t,n){try{const a=await this.getUserMigrationState(t),r=[...new Set([...a.completedMigrations,n])];await this.updateUserMigrationState(t,r,a.version),pe.printStateInfo(`Migration ${n} marked as completed for user ${t}`)}catch(a){throw pe.printStateError("Failed to mark migration as completed",a),a}}async resetMigrationState(t){try{await this.updateUserMigrationState(t,[],"1.0.0"),pe.printStateInfo(`Migration state reset for user ${t}`)}catch(n){throw pe.printStateError("Failed to reset migration state",n),n}}}class eg{migrations=[new Yh,new Xh,new Jh,new Zh].filter(Boolean);getAllMigrations(){return this.migrations}getPendingMigrations(t){return this.migrations.filter(n=>!t.includes(n.version))}async executeMigration(t,n){try{pe.printExecutorInfo(`Starting migration ${t.version}: ${t.name}`),await t.execute(n),pe.printExecutorInfo(`Migration ${t.version} completed successfully`)}catch(a){throw pe.printExecutorError(`Migration ${t.version} failed`,a),a}}addMigration(t){this.migrations.push(t),pe.printExecutorInfo(`Added new migration: ${t.version} - ${t.name}`)}}class tg{inProgressUsers=new Set;stateManager=new Qh;executorManager=new eg;async runAllMigrations(t){try{if(this.inProgressUsers.has(t)){pe.printServiceInfo(`Migration already in progress for user: ${t}, skipping duplicate trigger`);return}this.inProgressUsers.add(t),pe.printHeader(t);const n=await this.stateManager.getUserMigrationState(t),a=this.executorManager.getAllMigrations(),r=this.executorManager.getPendingMigrations(n.completedMigrations),o=a.filter(c=>n.completedMigrations.includes(c.version));if(pe.printOverview(a.length,o.length,r.length),r.length===0){pe.printAllCompleted(o.length);return}pe.printPendingMigrations(r);let i=0,l=0;for(let c=0;c<r.length;c++){const d=r[c],u=`[${c+1}/${r.length}]`;try{pe.printMigrationStart(u,d.version,d.name),await this.executorManager.executeMigration(d,t),await this.stateManager.markMigrationCompleted(t,d.version),pe.printMigrationComplete(),i++}catch(h){pe.printMigrationFailure(h),l++}}pe.printExecutionSummary(i,l,o.length)}catch(n){throw pe.printCriticalError(n),n}finally{this.inProgressUsers.delete(t)}}async checkMigrationStatus(t){try{const n=await this.stateManager.getUserMigrationState(t),a=this.executorManager.getAllMigrations(),r=this.executorManager.getPendingMigrations(n.completedMigrations),o=a.filter(u=>n.completedMigrations.includes(u.version)),l=(await Se(ze(ne.getDb(),`users/${t}/messages`))).docs.filter(u=>u.data().isDeleted===void 0).length,d=(await Se(ze(ne.getDb(),`users/${t}/channels`))).docs.filter(u=>!u.data().lastMessageTime).length;return pe.printServiceInfo(`Status check: ${r.length} pending, ${l} messages, ${d} channels need migration`),{messagesNeedMigration:l,channelsNeedMigration:d,pendingMigrations:r.map(u=>u.version),lastMigrationCheck:n.lastMigrationCheck,totalMigrations:a.length,completedMigrations:o.length,skippedMigrations:o.length}}catch(n){throw pe.printServiceError("Failed to check migration status",n),n}}async forceRerunAllMigrations(t){try{pe.printServiceInfo(`Force rerunning all migrations for user: ${t}`),await this.stateManager.resetMigrationState(t),await this.runAllMigrations(t),pe.printServiceInfo("Force rerun completed successfully")}catch(n){throw pe.printServiceError("Force rerun failed",n),n}}addMigration(t){this.executorManager.addMigration(t)}}const xl=new tg;class sg{backend="firebase";notes=new ya;auth=new fl;async initializeForUser(t){await xl.runAllMigrations(t)}}const ng="stillroot-local-notes:";function bl(s){return`${ng}${s}`}function Ra(s){return{...s,createdAt:new Date(s.createdAt),updatedAt:s.updatedAt?new Date(s.updatedAt):void 0,lastMessageTime:s.lastMessageTime?new Date(s.lastMessageTime):void 0}}function La(s){return{...s,createdAt:s.createdAt.toISOString(),updatedAt:s.updatedAt?s.updatedAt.toISOString():void 0,lastMessageTime:s.lastMessageTime?s.lastMessageTime.toISOString():void 0}}function ks(s){return{...s,timestamp:new Date(s.timestamp),deletedAt:s.deletedAt?new Date(s.deletedAt):void 0}}function Hs(s){return{...s,timestamp:s.timestamp.toISOString(),deletedAt:s.deletedAt?s.deletedAt.toISOString():void 0}}function pt(s){const t=localStorage.getItem(bl(s));if(!t)return{channels:[],messagesByChannel:{}};try{const n=JSON.parse(t);return{channels:Array.isArray(n.channels)?n.channels:[],messagesByChannel:n.messagesByChannel&&typeof n.messagesByChannel=="object"?n.messagesByChannel:{}}}catch{return{channels:[],messagesByChannel:{}}}}function Ft(s,t){localStorage.setItem(bl(s),JSON.stringify(t))}function ag(s){if(!s)return 0;const t=Number(s);return Number.isFinite(t)&&t>=0?t:0}class vl{capabilities={realtime:!0,pagination:"cursor"};async listChannels(t){return pt(t).channels.map(Ra).sort((a,r)=>{const o=a.lastMessageTime?.getTime()??a.updatedAt?.getTime()??a.createdAt.getTime();return(r.lastMessageTime?.getTime()??r.updatedAt?.getTime()??r.createdAt.getTime())-o})}subscribeChannels(t,n){return this.listChannels(t).then(n),()=>{}}async createChannel(t,n){const a=pt(t),r=new Date,o=fs(),i={id:o,name:n.name,description:n.description,emoji:n.emoji,createdAt:r,updatedAt:r,messageCount:0,lastMessageTime:void 0,backgroundColor:n.backgroundColor,backgroundImage:n.backgroundImage,shareToken:void 0,shareMode:void 0};return a.channels.unshift(La(i)),a.messagesByChannel[o]=[],Ft(t,a),o}async updateChannel(t,n,a){const r=pt(t),o=r.channels.findIndex(c=>c.id===n);if(o<0)return;const l={...Ra(r.channels[o]),...a,updatedAt:new Date};r.channels[o]=La(l),Ft(t,r)}async deleteChannel(t,n){const a=pt(t);a.channels=a.channels.filter(r=>r.id!==n),delete a.messagesByChannel[n],Ft(t,a)}async listMessages(t,n,a){const i=(pt(t).messagesByChannel[n]??[]).map(ks).filter(g=>!g.isDeleted).filter(g=>(a.includeSenders??["user"]).includes(g.sender)).sort((g,x)=>x.timestamp.getTime()-g.timestamp.getTime()),l=ag(a.cursor??null),c=Math.max(1,a.limit),d=i.slice(l,l+c),u=l+d.length,h=u>=i.length?null:String(u);return{items:d,nextCursor:h}}subscribeNewMessages(t,n,a,r){let o=!0,i=a.getTime();const l=()=>{if(!o)return;const u=(pt(t).messagesByChannel[n]??[]).map(ks).filter(h=>!h.isDeleted).filter(h=>h.sender==="user").filter(h=>h.timestamp.getTime()>i).sort((h,g)=>h.timestamp.getTime()-g.timestamp.getTime());u.length>0&&(i=u[u.length-1].timestamp.getTime(),r(u)),setTimeout(l,1500)};return setTimeout(l,1500),()=>{o=!1}}async createMessage(t,n){const a=pt(t),r=fs(),o=new Date,i={id:r,content:n.content,sender:n.sender,channelId:n.channelId,timestamp:o,tags:n.tags,parentId:n.parentId,threadId:n.threadId,isThreadExpanded:n.isThreadExpanded,threadCount:n.threadCount,aiAnalysis:n.aiAnalysis,isDeleted:!1,deletedAt:void 0,deletedBy:n.deletedBy,canRestore:n.canRestore,isNew:n.isNew},l=a.messagesByChannel[i.channelId]??[];l.unshift(Hs(i)),a.messagesByChannel[i.channelId]=l;const c=a.channels.findIndex(d=>d.id===i.channelId);if(c>=0){const d=Ra(a.channels[c]),u={...d,messageCount:(d.messageCount??0)+1,lastMessageTime:o,updatedAt:o};a.channels[c]=La(u)}return Ft(t,a),r}async updateMessage(t,n,a){const r=pt(t);for(const[o,i]of Object.entries(r.messagesByChannel)){const l=i.findIndex(u=>u.id===n);if(l<0)continue;const d={...ks(i[l]),...a};r.messagesByChannel[o][l]=Hs(d),Ft(t,r);return}}async deleteMessage(t,n,a={}){const r=pt(t);for(const[o,i]of Object.entries(r.messagesByChannel)){const l=i.findIndex(c=>c.id===n);if(!(l<0)){if(a.hardDelete)r.messagesByChannel[o]=i.filter(c=>c.id!==n);else{const d={...ks(i[l]),isDeleted:!0,deletedAt:new Date};r.messagesByChannel[o][l]=Hs(d)}Ft(t,r);return}}}async restoreMessage(t,n){const a=pt(t);for(const[r,o]of Object.entries(a.messagesByChannel)){const i=o.findIndex(d=>d.id===n);if(i<0)continue;const c={...ks(o[i]),isDeleted:!1,deletedAt:void 0};a.messagesByChannel[r][i]=Hs(c),Ft(t,a);return}}async moveMessage(t,n,a,r){const o=pt(t),i=o.messagesByChannel[a]??[],l=i.findIndex(h=>h.id===n);if(l<0)return;const c=ks(i[l]);o.messagesByChannel[a]=i.filter(h=>h.id!==n);const d={...c,channelId:r},u=o.messagesByChannel[r]??[];u.unshift(Hs(d)),o.messagesByChannel[r]=u,Ft(t,o)}async publishSpace(t,n,a){throw new Error("Publishing requires an account. Please sign in.")}async unpublishSpace(t,n){throw new Error("Unpublishing requires an account. Please sign in.")}}class rg{async signInWithGoogle(){return null}async signInWithEmail(t,n){return null}async signUpWithEmail(t,n,a){throw new Error("Local backend does not support sign-up")}async sendSignUpLink(t,n,a){throw new Error("Local backend does not support sign-up")}async sendPasswordReset(t){throw new Error("Local backend does not support password reset")}async sendEmailVerification(){throw new Error("Local backend does not support email verification")}async signOut(){}async getCurrentUser(){return null}onAuthStateChanged(t){return t(null),()=>{}}}class og{backend="local";notes=new vl;auth=new rg;async initializeForUser(t){}}const wl="stillroot-guest-id",Br="guest:";function Ue(s){return s.startsWith(Br)}function Ur(){const s=localStorage.getItem(wl);return!s||!s.startsWith(Br)?null:s}function Fr(){return Ur()!==null}function ig(){const s=Ur();if(s)return s;const t=`${Br}${fs()}`;return localStorage.setItem(wl,t),t}class lg{capabilities={realtime:!0,pagination:"cursor"};local=new vl;firebase=new ya;repoFor(t){return Ue(t)?this.local:this.firebase}listChannels(t){return this.repoFor(t).listChannels(t)}subscribeChannels(t,n){const a=this.repoFor(t);return a.subscribeChannels?a.subscribeChannels(t,n):()=>{}}createChannel(t,n){return this.repoFor(t).createChannel(t,n)}updateChannel(t,n,a){return this.repoFor(t).updateChannel(t,n,a)}deleteChannel(t,n){return this.repoFor(t).deleteChannel(t,n)}listMessages(t,n,a){return this.repoFor(t).listMessages(t,n,a)}subscribeNewMessages(t,n,a,r){const o=this.repoFor(t);return o.subscribeNewMessages?o.subscribeNewMessages(t,n,a,r):()=>{}}createMessage(t,n){return this.repoFor(t).createMessage(t,n)}updateMessage(t,n,a){return this.repoFor(t).updateMessage(t,n,a)}deleteMessage(t,n,a){return this.repoFor(t).deleteMessage(t,n,a)}restoreMessage(t,n){return this.repoFor(t).restoreMessage(t,n)}moveMessage(t,n,a,r){return this.repoFor(t).moveMessage(t,n,a,r)}publishSpace(t,n,a){if(Ue(t))throw new Error("Publishing requires an account. Please sign in.");return this.firebase.publishSpace(t,n,a)}unpublishSpace(t,n){if(Ue(t))throw new Error("Unpublishing requires an account. Please sign in.");return this.firebase.unpublishSpace(t,n)}}class cg{backend="hybrid";notes=new lg;auth=new fl;async initializeForUser(t){Ue(t)||await xl.runAllMigrations(t)}}const dg=s=>{switch(s){case"firebase":return new sg;case"local":return new og;case"hybrid":return new cg}};let Tn=null;const ye=()=>Tn||(Tn=dg("hybrid"),Tn),ug=()=>{let s=!1;const t=[];return{isFrozen:()=>s,freeze:()=>{s=!0},unfreeze:()=>{for(;t.length>0;)t.shift()();s=!1},submit:o=>{s?t.push(o):o()}}},ur=ug();class yl extends Rt{next(t){ur.submit(()=>super.next(t))}}const mr=(s,t)=>{if(t){const n=t.split("::");let a=s.data;for(let r=0;r<n.length;r+=1){if(!a[n[r]])return a[n[r]];a=a[n[r]]}return a}else return s.data},mg=s=>typeof s=="object"&&s!==null?Array.isArray(s)?[...s]:{...s}:s,hg=(s,t,n,a)=>{const r=mr(s,n);if(a===r)return;const o=(i,l,c)=>{l!==c&&i.$.next(l),Object.entries(i.children).forEach(([d,u])=>{o(u,l?.[d],c?.[d])})};if(ur.freeze(),!n)s.data=a,o(t,a,r);else{const i=n.split("::");let l=s.data,c=t;const d=[[c,l,void 0]];for(let p=0;p<i.length-1;p+=1)l[i[p]]===void 0&&(l[i[p]]={}),l=l[i[p]],c=c?.children[i[p]],d.push([c,l,i[p]]);const u=c?.children[i[i.length-1]];d.push([u,a,i[i.length-1]]);const h=[],g=[];let x,f;for(let p=d.length-1;p>=0;p-=1){const[b,v,y]=d[p];if(p===d.length-1)g.unshift([b,v]),x=y,f=v;else{const w=mg(v);w[x]=f,g.unshift([b,w]),x=y,f=w}}s.data=f;for(let p=0;p<g.length;p+=1){const[b,v]=g[p];if(b)h.push(()=>b.$.next(v));else break}h.reverse().forEach(p=>p()),u&&Object.entries(u.children).forEach(([p,b])=>{o(b,a?.[p],r?.[p])})}ur.unfreeze()},jl=(s,t,n)=>{if(n){const a=n.split("::");let r=s.data,o=t;for(let i=0;i<a.length;i+=1)i<a.length-1&&r[a[i]]===void 0&&(r[a[i]]={}),o.children[a[i]]===void 0&&(o.children[a[i]]={$:new yl(r[a[i]]),children:{}}),r=r[a[i]],o=o.children[a[i]];return o}else return t},gg=(s,t,n)=>{const{$:a}=jl(s,t,n),[,r]=m.useState(()=>a.getValue());return m.useEffect(()=>{const o=a.subscribe(i=>{r(i)});return()=>o.unsubscribe()},[a]),a.getValue()},Nl=(s,t,n)=>{const a=t||{$:new yl(s.data),children:{}},r=o=>n?`${n}::${o}`:o;return new Proxy({$$isBean:!0},{ownKeys(o){return Reflect.ownKeys(o).concat(["use","get","set","$","namespaces"])},get(o,i){if(i in o)return o[i];if(typeof i=="string"){if(["$","get","set","use"].includes(i)){const l=jl(s,a,n);if(i==="$")return l.$;if(i==="get")return l.get||(l.get=()=>mr(s,n)),l.get;if(i==="set")return l.set||(l.set=c=>hg(s,a,n,typeof c=="function"?c(mr(s,n)):c)),l.set;if(i==="use")return l.use||(l.use=()=>gg(s,a,n)),l.use}else if(i==="namespaces")return new Proxy({},{get(l,c){return Nl(s,a,r(c))}})}else return o[i]}})},Cl=(s,t,n)=>Nl({data:s},t,n),cs=(s,t)=>t.split(".").reduce((a,r)=>a.namespaces[r],s),kl=s=>({value:s.use(),set:s.set,get:s.get}),Da=async(s,t,n)=>{s();try{await t()}catch(a){throw n(),a}};class pg{moreMessageLoadedEvent$=new zn;requestLoadInitialMessages$=new Ki(1);dataContainer=Cl({messageByChannel:{}});handleRequestWorkflow$=this.requestLoadInitialMessages$.pipe(xa((t,n)=>t.channelId===n.channelId&&t.messageLimit===n.messageLimit),Qs(t=>{const n=this.dataContainer.get().messageByChannel[t.channelId];return!n||n.hasMore&&!n.loading}),Yi(t=>this.loadInitialMessages({channelId:t.channelId,messagesLimit:t.messageLimit||20})));connectToRequestWorkflow=()=>{const t=this.handleRequestWorkflow$.subscribe();return()=>t.unsubscribe()};getIsAnyChannelLoading$=t=>t.length?Xi(t.map(n=>cs(this.dataContainer,`messageByChannel.${n}.loading`).$)).pipe(os(n=>n.some(a=>a))):dm(!1);waitForChannelIdle=async(t,n)=>{const a=cs(this.dataContainer,`messageByChannel.${t}`);await Ms(a.$.pipe(Qs(r=>!!r),Qs(r=>!r.loading&&!r.loadingMore),um({first:n?.timeoutMs??15e3})))};ensureMessagesLoaded=async(t,n)=>{const{userId:a}=O.getState();if(!a)throw new Error("User not authenticated");if(!t)throw new Error("Channel id is required");const r=Math.max(1,n?.initialLimit??50),o=Math.max(1,n?.pageSize??50),i=Math.max(1,n?.maxMessages??200),l=n?.timeoutMs??15e3,c=this.dataContainer.get().messageByChannel[t];c?(c.loading||c.loadingMore)&&await this.waitForChannelIdle(t,{timeoutMs:l}):await this.loadInitialMessages({channelId:t,messagesLimit:Math.min(r,i)});let d=this.dataContainer.get().messageByChannel[t];if(d)for(;d.hasMore&&d.messages.length<i;){const u=i-d.messages.length;if(u<=0||(await this.loadMoreHistory({channelId:t,messagesLimit:Math.min(o,u)}),d=this.dataContainer.get().messageByChannel[t],!d))break}};getChannelStateControl=t=>{const n=cs(this.dataContainer,`messageByChannel.${t}`),{get:a,namespaces:{loading:{set:r},loadingMore:{set:o},messages:{set:i},lastVisible:{set:l},hasMore:{set:c},subscription:{set:d}}}=n,u=f=>{const p=a().messages||[];if(p.find(v=>v.id===f.id))return;const b=p[p.length-1];b&&b.content===f.content?i([...p.slice(0,-1),f]):i([...p,f])},h=f=>{const p=a().messages||[];i(p.filter(b=>b.id!==f))},g=(f,p)=>{const b=a().messages||[],v=b.find(y=>y.id===p);i(v?b.filter(y=>y.id!==f):b.map(y=>y.id===f?{...y,id:p,isNew:!1}:y))},x=()=>{const f=a();i([]),r(!1),o(!1),c(!1),l(null),f?.subscription&&f.subscription.unsubscribe()};return{getChannelState:a,setLoading:r,setLoadingMore:o,addMessage:u,updateMessage:this.updateMessage,setMessages:i,setLastVisible:l,setHasMore:c,setSubscription:d,removeMessage:h,fixFakeMessage:g,clearChannel:x}};loadInitialMessages=async({channelId:t,messagesLimit:n})=>{console.log("[ChannelMessageService] loadInitialMessages",{channelId:t,messagesLimit:n});const{userId:a}=O.getState();if(console.log("[ChannelMessageService] loadInitialMessages",{channelId:t,messagesLimit:n,userId:a}),!a||!t)return;const{setLoading:r,addMessage:o,setLastVisible:i,setHasMore:l,setSubscription:c}=this.getChannelStateControl(t);r(!0);try{const d=await ye().notes.listMessages(a,t,{limit:n,cursor:null,includeSenders:["user"]});if(d.items.forEach(o),i(d.nextCursor),l(!!d.nextCursor),d.items.length>0){const u=d.items[0].timestamp,h=this.subscribeToNewMessages({channelId:t,afterTimestamp:u});c({unsubscribe:h})}}catch(d){console.error("Error loading initial messages:",d)}finally{r(!1)}};loadMoreHistory=async({channelId:t,messagesLimit:n})=>{const{userId:a}=O.getState();if(!a||!t)return;const{getChannelState:r,setLoadingMore:o,setLastVisible:i,setHasMore:l,setMessages:c}=this.getChannelStateControl(t),{loading:d,loadingMore:u,hasMore:h,lastVisible:g,messages:x}=r();if(!(!a||!t||!h||!g||d||u)){o(!0);try{const f=await ye().notes.listMessages(a,t,{limit:n,cursor:g,includeSenders:["user"]});if(f.items.length>0){const p=[...f.items,...x];c(p),i(f.nextCursor),this.moreMessageLoadedEvent$.emit({channelId:t,messages:f.items})}l(!!f.nextCursor)}catch(f){console.error("Error loading more messages:",f)}finally{o(!1)}}};subscribeToNewMessages=({channelId:t,afterTimestamp:n})=>{const{userId:a}=O.getState();if(!a||!t)return()=>{};const{addMessage:r,getChannelState:o,setSubscription:i}=this.getChannelStateControl(t),{subscription:l}=o();l&&(console.log("ðŸ”” [subscribeToNewMessages] å–æ¶ˆä¹‹å‰çš„è®¢é˜…"),l.unsubscribe()),console.log("ðŸ”” [subscribeToNewMessages] å¼€å§‹è®¢é˜…æ–°æ¶ˆæ¯",{channelId:t,afterTimestamp:n});const c=ye().notes;if(!c.subscribeNewMessages)return()=>{};const d=c.subscribeNewMessages(a,t,n,u=>{u.forEach(h=>{r(h)})});return i({unsubscribe:d}),d};deleteMessage=async({messageId:t,hardDelete:n,channelId:a})=>{const{userId:r}=O.getState();if(!r)return;const{removeMessage:o,getChannelState:i,setMessages:l}=this.getChannelStateControl(a),c=i().messages;await Da(()=>o(t),async()=>{await ye().notes.deleteMessage(r,t,{hardDelete:n}),console.log("Message deleted successfully:",{messageId:t,channelId:a,hardDelete:n})},()=>{l(c),console.error("Failed to delete message, rolling back:",{messageId:t,channelId:a})})};sendMessage=async t=>{const{userId:n}=O.getState();if(!n)return;const{addMessage:a,fixFakeMessage:r}=this.getChannelStateControl(t.channelId),o={...t,id:fs(),timestamp:new Date,isNew:!0};a(o);const i=await ye().notes.createMessage(n,t);r(o.id,i)};updateMessage=async({messageId:t,channelId:n,updates:a,userId:r})=>{const{getChannelState:o,setMessages:i}=this.getChannelStateControl(n),{messages:l}=o(),c=l.find(u=>u.id===t);if(!c)throw new Error("Message not found");if(c.sender!=="user")throw new Error("You can only edit user messages, not AI messages");const d={...c,...a};await Da(()=>i(l.map(u=>u.id===t?d:u)),async()=>{await ye().notes.updateMessage(r,t,a),console.log("Message updated successfully:",{messageId:t,channelId:n,updates:a})},()=>{i(l.map(u=>u.id===t?c:u)),console.error("Failed to update message, rolling back:",{messageId:t,channelId:n})})};moveMessage=async({messageId:t,fromChannelId:n,toChannelId:a})=>{if(n===a)return;const{userId:r}=O.getState();if(!r)throw new Error("User not authenticated");const o=this.getChannelStateControl(n),i=this.getChannelStateControl(a),l=o.getChannelState(),c=i.getChannelState(),d=l?.messages??[],u=c?.messages??[],h=d.find(x=>x.id===t);if(!h)throw new Error("Message not found in source channel");const g={...h,channelId:a};await Da(()=>{if(o.setMessages(d.filter(x=>x.id!==t)),c?.messages){const x=[...u.filter(f=>f.id!==t),g].sort((f,p)=>p.timestamp.getTime()-f.timestamp.getTime());i.setMessages(x)}},async()=>{await O.getState().moveMessage(t,n,a)},()=>{o.setMessages(d),c?.messages&&i.setMessages(u)})}}const X=new pg;window.channelMessageService=X;const ot=s=>async(...t)=>{const{userId:n}=O.getState();n&&await s(n,...t)},Qe=async(s,t)=>{try{return await s()}catch(n){console.error(`Error in ${t}:`,n)}},O=_e()((s,t)=>({channels:[],channelsLoading:!0,userId:null,unsubscribeChannels:null,isListenerEnabled:!0,messagesByChannel:{},setChannelsLoading:n=>{s({channelsLoading:n})},addChannel:ot(async(n,a)=>{const r={...a,emoji:a.emoji&&a.emoji.trim()?a.emoji:cr()},o=await Qe(()=>ye().notes.createChannel(n,r),"createChannel");if(typeof o=="string"&&o)try{J.getState().setCurrentChannel(o);const i={id:o,name:r.name,description:r.description,emoji:r.emoji,createdAt:new Date,updatedAt:new Date,messageCount:0,lastMessageTime:new Date,backgroundColor:void 0,backgroundImage:void 0},{channels:l}=O.getState();l.some(d=>d.id===o)||O.setState({channels:[i,...l]})}catch(i){console.warn("[addChannel] Failed to set current channel after creation",i)}}),updateChannel:ot(async(n,a,r)=>{const{channels:o}=t(),i=o.map(l=>l.id===a?{...l,...r}:l);s({channels:i}),await Qe(()=>ye().notes.updateChannel(n,a,r),"updateChannel")}),deleteChannel:ot(async(n,a)=>{await Qe(()=>ye().notes.deleteChannel(n,a),"deleteChannel");const{channels:r,messagesByChannel:o}=t(),i=r.filter(d=>d.id!==a);s({channels:i});const{[a]:l,...c}=o;s({messagesByChannel:c}),console.log("ðŸ”” [deleteChannel] æˆåŠŸåˆ é™¤ channel å¹¶æ›´æ–°æœ¬åœ°çŠ¶æ€",{channelId:a,remainingChannelsCount:Object.keys(c).length,removedChannelMessageCount:l?.messages?.length||0})}),addMessage:ot(async(n,a)=>{await Qe(()=>ye().notes.createMessage(n,a),"createMessage")}),deleteMessage:ot(async(n,a,r=!1)=>{await Qe(()=>ye().notes.deleteMessage(n,a,{hardDelete:r}),r?"deleteMessage":"softDeleteMessage");const{messagesByChannel:o}=t();console.log("ðŸ”” [deleteMessage] å¼€å§‹æŸ¥æ‰¾æ¶ˆæ¯",{messageId:a,messagesByChannel:o});for(const[i,l]of Object.entries(o))if(l.messages.some(d=>d.id===a)){console.log("ðŸ”” [deleteMessage] æ‰¾åˆ°æ¶ˆæ¯ï¼Œå‡†å¤‡åˆ é™¤",{channelId:i,messageId:a}),t().removeChannelMessage(i,a);break}}),updateMessage:ot(async(n,a,r)=>{await Qe(()=>ye().notes.updateMessage(n,a,r),"updateMessage")}),moveMessage:ot(async(n,a,r,o)=>{try{await ye().notes.moveMessage(n,a,r,o)}catch(i){throw console.error("Failed to move message:",{messageId:a,fromChannelId:r,toChannelId:o,error:i}),i}s(i=>{const l=i.messagesByChannel[r],c=i.messagesByChannel[o];if(!l)return i;const d=l.messages.find(g=>g.id===a);if(!d)return i;const u={...l,messages:l.messages.filter(g=>g.id!==a)};let h={...i.messagesByChannel,[r]:u};if(c){const g={...d,channelId:o},x=[...c.messages.filter(f=>f.id!==a),g].sort((f,p)=>p.timestamp.getTime()-f.timestamp.getTime());h={...h,[o]:{...c,messages:x}}}return{messagesByChannel:h}})}),addThreadMessage:ot(async(n,a,r)=>{await Qe(()=>ye().notes.createMessage(n,{...r,parentId:a,threadId:a}),"createThreadMessage")}),restoreMessage:ot(async(n,a)=>{await Qe(()=>ye().notes.restoreMessage(n,a),"restoreMessage")}),permanentDeleteMessage:ot(async(n,a)=>{await Qe(()=>ye().notes.deleteMessage(n,a,{hardDelete:!0}),"permanentDeleteMessage")}),setChannelMessages:(n,a)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[n]:{...r.messagesByChannel[n],messages:a,loading:!1}}}))},addChannelMessage:(n,a)=>{s(r=>{const o=r.messagesByChannel[n];return o?o.messages.some(l=>l.id===a.id)?(console.log("ðŸ”” [addChannelMessage] æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ",{messageId:a.id,channelId:n}),r):(console.log("ðŸ”” [addChannelMessage] æ·»åŠ æ–°æ¶ˆæ¯",{messageId:a.id,channelId:n}),{messagesByChannel:{...r.messagesByChannel,[n]:{...o,messages:[...o.messages,a]}}}):r})},setChannelLoading:(n,a)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[n]:{...r.messagesByChannel[n],loading:a}}}))},setChannelHasMore:(n,a)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[n]:{...r.messagesByChannel[n],hasMore:a}}}))},setChannelLastVisible:(n,a)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[n]:{...r.messagesByChannel[n],lastVisible:a}}}))},clearChannelMessages:n=>{s(a=>{const{[n]:r,...o}=a.messagesByChannel;return{messagesByChannel:o}})},removeChannelMessage:(n,a)=>{s(r=>{const o=r.messagesByChannel[n];if(!o)return r;const i=o.messages.filter(l=>l.id!==a);return console.log("ðŸ”” [removeChannelMessage]",{channelId:n,messageId:a,beforeCount:o.messages.length,afterCount:i.length}),{messagesByChannel:{...r.messagesByChannel,[n]:{...o,messages:i}}}})},initFirebaseListeners:async n=>{const{userId:a,unsubscribeChannels:r}=t();if(r&&a===n)return;t().cleanupListeners(),s({userId:n,channelsLoading:!0});const o=ye().notes;if(!o.subscribeChannels)throw new Error("Current storage backend does not support realtime channel subscriptions");const i=o.subscribeChannels(n,l=>{const{isListenerEnabled:c}=t();c&&(s({channels:l,channelsLoading:!1}),t().validateAndCleanupCurrentChannel(l))});s({unsubscribeChannels:i})},initGuestWorkspace:async n=>{const a=Ur(),r=ig();if(await t().initFirebaseListeners(r),!!n?.autoCreateDefaultSpace&&!a)try{(await ye().notes.listChannels(r)).length===0&&await t().addChannel({name:"My First Space",emoji:"ðŸš€",description:"Start your journey here"})}catch(i){console.warn("[guest] failed to auto-create default space",i)}},cleanupListeners:()=>{const{unsubscribeChannels:n}=t();n&&n(),s({unsubscribeChannels:null,channels:[],channelsLoading:!1,userId:null,messagesByChannel:{}})},fetchInitialData:async n=>{s({channelsLoading:!0}),await Qe(async()=>{const a=await ye().notes.listChannels(n);s({channels:a,channelsLoading:!1}),t().validateAndCleanupCurrentChannel(a)},"fetchChannels")},validateAndCleanupCurrentChannel:n=>{const a=J.getState().currentChannelId;if(!a)return;n.some(o=>o.id===a)||(J.getState().setCurrentChannel(null),X.getChannelStateControl(a).clearChannel(),t().clearChannelMessages(a))},publishSpace:async(n,a="read-only")=>{const{userId:r}=t();if(!r)return"";const o=await Qe(()=>ye().notes.publishSpace(r,n,a),"publishSpace");if(o){const{channels:i}=t(),l=i.map(c=>c.id===n?{...c,shareToken:o,shareMode:a}:c);s({channels:l})}return o||""},unpublishSpace:ot(async(n,a)=>{await Qe(()=>ye().notes.unpublishSpace(n,a),"unpublishSpace");const{channels:r}=t(),o=r.map(i=>i.id===a?{...i,shareToken:void 0,shareMode:void 0}:i);s({channels:o})}),updatePublishMode:ot(async(n,a,r)=>{await Qe(()=>ye().notes.updateChannel(n,a,{shareMode:r}),"updatePublishMode");const{channels:o}=t(),i=o.map(l=>l.id===a?{...l,shareMode:r}:l);s({channels:i})})}));function fg(){const s="__stillroot_auth_listener_singleton__",t=globalThis;return t[s]||(t[s]={started:!1,unsubscribe:null}),t[s]}async function Ao(s){const t=O.getState();return s&&s.emailVerified?(await t.initFirebaseListeners(s.uid),"cloud"):Fr()?(await t.initGuestWorkspace(),"local"):(t.cleanupListeners(),"signedOut")}const Ye=_e()((s,t)=>({currentUser:null,sessionMode:"booting",isAuthenticating:!1,authStep:ee.IDLE,authMessage:"",authProgress:0,signInWithGoogle:async()=>{if(!ne.supportGoogleAuth())throw new Error("Google authentication is not supported in this region");s({isAuthenticating:!0,authStep:ee.AUTHENTICATING,authMessage:xt.CONNECTING_GOOGLE,authProgress:bt.AUTHENTICATING});try{await Ie.signInWithGoogle(),s({authStep:ee.INITIALIZING_DATA,authMessage:xt.SETTING_UP_WORKSPACE,authProgress:bt.INITIALIZING_DATA})}catch(n){throw s({authStep:ee.ERROR,authMessage:xt.SIGN_IN_FAILED,authProgress:bt.START}),n}finally{s({isAuthenticating:!1})}},signInWithEmail:async(n,a)=>{s({isAuthenticating:!0,authStep:ee.AUTHENTICATING,authMessage:xt.VERIFYING_CREDENTIALS,authProgress:bt.AUTHENTICATING});try{await Ie.signInWithEmail(n,a),s({authStep:ee.VERIFYING_EMAIL,authMessage:xt.CHECKING_EMAIL_VERIFICATION,authProgress:bt.VERIFYING_EMAIL})}catch(r){throw s({authStep:ee.ERROR,authMessage:xt.CHECK_CREDENTIALS,authProgress:bt.START}),r}finally{s({isAuthenticating:!1})}},signUpWithEmail:async(n,a,r)=>{s({isAuthenticating:!0});try{return await Ie.signUpWithEmail(n,a,r)}finally{s({isAuthenticating:!1})}},sendSignUpLink:async(n,a,r)=>{s({isAuthenticating:!0});try{return await Ie.sendSignUpLink(n,a,r)}finally{s({isAuthenticating:!1})}},sendPasswordReset:async n=>{s({isAuthenticating:!0});try{await Ie.sendPasswordReset(n)}finally{s({isAuthenticating:!1})}},sendEmailVerification:async()=>{s({isAuthenticating:!0});try{const n=t().currentUser;if(!n)throw new Error("No user logged in");await Ie.sendEmailVerification(n)}finally{s({isAuthenticating:!1})}},signOut:async()=>{s({isAuthenticating:!0});try{await Ie.signOut(),t().setAuth(null);const n=await Ao(null);s({sessionMode:n})}finally{s({isAuthenticating:!1})}},setAuth:n=>{s({currentUser:n})},setAuthStep:(n,a,r)=>{s({authStep:n,authMessage:a,authProgress:r})},initAuthListener:async()=>{const n=fg();if(n.started)return()=>{};n.started=!0,s({sessionMode:"booting"}),O.getState().cleanupListeners(),O.getState().setChannelsLoading(!0);try{const a=await Ie.onAuthStateChanged(r=>{t().setAuth(r),r&&r.emailVerified&&ne.setUserIdForAnalytics(r.uid),Ao(r).then(o=>s({sessionMode:o})).catch(o=>{console.error("[auth] apply session workspace failed",o),O.getState().cleanupListeners(),s({sessionMode:"signedOut"})})});return n.unsubscribe=a,()=>{}}catch(a){throw n.started=!1,n.unsubscribe=null,a}}})),ja=()=>{const{currentUser:s,sessionMode:t,initAuthListener:n}=Ye();return m.useEffect(()=>{let a;return(async()=>{a=await n()})(),()=>{a&&a()}},[n]),{user:s,sessionMode:t}},zr=m.createContext(null),ve=()=>{const s=m.useContext(zr);if(!s)throw new Error("useCommonPresenter must be used within a CommonPresenterProvider");return s};class xg{instances$=new Rt([]);baseZIndex=1e3;nextId=0;get instances(){return this.instances$.value}get instancesObservable(){return this.instances$}show(t){const n=`modal-${++this.nextId}`,a=this.baseZIndex+this.instances.length,r={id:n,options:t,zIndex:a},o=[...this.instances,r];return this.instances$.next(o),{id:n,close:i=>this.hide(n,i)}}hide(t,n){const a=this.instances.find(o=>o.id===t);if(!a)return;const r=this.instances.filter(o=>o.id!==t);this.instances$.next(r),a.options.onClose?.(n)}hideAll(){this.instances.forEach(t=>{t.options.onClose?.()}),this.instances$.next([])}}const en=new xg;function Sl(s,t){const[n,a]=m.useState(t),r=m.useMemo(()=>typeof s=="function"?s():s,[s]);return m.useEffect(()=>{const o=r.subscribe(a);return()=>o.unsubscribe()},[r]),n}function bg(){const s=m.useRef(null),t=m.useRef(null);return m.useEffect(()=>{const n=s.current;if(!n)return;t.current=document.activeElement;const a=n.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),r=a[0],o=a[a.length-1];r&&r.focus();const i=l=>{l.key==="Tab"&&(l.shiftKey?document.activeElement===r&&(l.preventDefault(),o?.focus()):document.activeElement===o&&(l.preventDefault(),r?.focus()))};return document.addEventListener("keydown",i),()=>{document.removeEventListener("keydown",i),t.current?.focus()}},[]),s}function vg(s=!0){m.useEffect(()=>{if(!s)return;const t=window.getComputedStyle(document.body).overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=t}},[s])}function wg({onClose:s,threshold:t=100}){const n=m.useRef(0),a=m.useRef(0),r=m.useRef(!1),o=m.useCallback(c=>{n.current=c.touches[0].clientY,a.current=c.touches[0].clientX,r.current=!1},[]),i=m.useCallback(c=>{if(!r.current){const d=Math.abs(c.touches[0].clientY-n.current),u=Math.abs(c.touches[0].clientX-a.current);r.current=d>u&&d>10}},[]),l=m.useCallback(c=>{r.current&&c.changedTouches[0].clientY-n.current>t&&(c.preventDefault(),s())},[s,t]);return{onTouchStart:o,onTouchMove:i,onTouchEnd:l}}function yg({instance:s,onClose:t}){const n=bg();vg(!0);const a=wg({onClose:()=>t()});m.useEffect(()=>{const h=g=>{g.key==="Escape"&&(g.preventDefault(),t())};return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[t]);const r=s.options.position||"center",o=r==="top",i=s.options.topOffset??12,l=()=>{switch(r){case"top":return"fixed inset-x-0 top-0 pointer-events-none flex justify-center items-start";case"center":default:return"fixed inset-0 flex items-center justify-center pointer-events-none"}},d=(()=>{switch(r){case"top":return{initial:{opacity:0,scale:.95,y:-20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:-20}};case"center":default:return{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20}}}})(),u=o?"relative bg-background shadow-lg overflow-hidden pointer-events-auto w-full":"relative bg-background rounded-lg shadow-lg max-w-[90vw] max-h-[90vh] overflow-hidden pointer-events-auto";return e.jsx(Dr,{children:e.jsxs("div",{className:"fixed inset-0 z-50",style:{zIndex:s.zIndex},children:[e.jsx(he.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15},className:"absolute inset-0 bg-black/50",onClick:()=>t()}),e.jsx(he.div,{ref:n,initial:d.initial,animate:d.animate,exit:d.exit,transition:{duration:.15,ease:"easeOut"},className:`${l()}`,...a,children:e.jsx("div",{className:`${u} ${s.options.className||""}`,style:o?{marginTop:`${i}px`}:void 0,children:s.options.content})})]})})}function Ml(){const s=Sl(en.instancesObservable,[]);return e.jsx(e.Fragment,{children:s.map(t=>e.jsx(yg,{instance:t,onClose:n=>en.hide(t.id,n)},t.id))})}const Il={show:s=>en.show(s),hide:(s,t)=>en.hide(s,t),hideAll:()=>en.hideAll()},En=_e(s=>({targetPath:null,currentPath:"/",navigate:t=>s({targetPath:t}),setCurrentPath:t=>s({currentPath:t})})),jg=()=>{const s=xm(),t=_r(),n=En(r=>r.targetPath),a=En(r=>r.currentPath);m.useEffect(()=>{n&&(s(n),En.getState().navigate(null))},[n,s]),m.useEffect(()=>{t.pathname!==a&&En.getState().setCurrentPath(t.pathname)},[t.pathname,a])},Gs=new wm,Ng=s=>{const[t,n]=m.useState(!1),a=m.useRef(new Set);return m.useEffect(()=>{s.forEach(r=>{const o=r.manifest.id;Gs.getExtension(o)||Gs.registerExtension(r)})},[s]),m.useEffect(()=>{const r=new Set(s.map(l=>l.manifest.id)),o=a.current;s.forEach(l=>{const c=l.manifest.id;o.has(c)||(Gs.activateExtension(c),o.add(c))}),Array.from(o).filter(l=>!r.has(l)).forEach(l=>{Gs.deactivateExtension(l),o.delete(l)}),n(!0)},[s]),m.useEffect(()=>()=>{const r=a.current;Array.from(r).forEach(i=>{Gs.deactivateExtension(i)}),r.clear()},[]),{initialized:t}},Tl=s=>{jg();const{initialized:t}=Ng(s.extensions);return{initialized:t}};function El(s,t,n){return n?s.map(a=>a.id===n?{...a,children:a.children?[...a.children,t]:[t]}:a.children?{...a,children:El(a.children,t,n)}:a):[...s,t]}function Al(s,t,n){return n?s.map(a=>a.id===n?{...a,children:a.children?[...a.children,...t]:t}:a.children?{...a,children:Al(a.children,t,n)}:a):[...s,...t]}function Hn(s,t){return s.filter(n=>n.id!==t).map(n=>n.children?{...n,children:Hn(n.children,t)}:n)}function Rl(s,t,n){return s.map(a=>a.id===t?{...a,...n}:a.children?{...a,children:Rl(a.children,t,n)}:a)}const Na=_e()((s,t)=>({routes:[],addRoute:(n,a)=>(s(r=>({routes:El(r.routes,n,a)})),()=>{s(r=>({routes:Hn(r.routes,n.id)}))}),addRoutes:(n,a)=>(s(r=>({routes:Al(r.routes,n,a)})),()=>{s(r=>({routes:n.reduce((o,i)=>Hn(o,i.id),r.routes)}))}),removeRoute:n=>{s(a=>({routes:Hn(a.routes,n)}))},updateRoute:(n,a)=>{s(r=>({routes:Rl(r.routes,n,a)}))},getRoutes:()=>t().routes,reset:()=>s({routes:[]})}));function Ll(s){return s.sort((t,n)=>(t.order??0)-(n.order??0)).map(t=>e.jsx(Is,{path:t.path,element:t.element,children:t.children&&Ll(t.children)},t.id))}const Cg=()=>{const s=Na(t=>t.routes);return e.jsx(ba,{children:Ll(s)})},kg=s=>{const{t}=L(),{extensions:n}=s,{initialized:a}=Tl({extensions:n});return a?e.jsx("div",{className:"fixed inset-0 flex flex-col",children:e.jsx("div",{className:E("flex flex-col h-full"),children:e.jsx("div",{className:"flex-1 min-h-0 flex",children:e.jsx(Cg,{})})})}):e.jsx("div",{children:t("common.loading")})},Ro={message:Ls,users:Rr,settings:ga,github:Ri,home:Qd,search:Je,file:yt,folder:Zd,calendar:Jd,star:Xd,heart:Ai,bookmark:Ei,bot:hs,download:vs,upload:Yd,share:Kd,edit:Ar,trash:qd,plus:$e,minus:Ka,check:Xe,x:fe,"chevron-left":Ti,"chevron-right":ha,"chevron-up":bs,"chevron-down":st,menu:Er,"more-horizontal":ma,"more-vertical":ms,sun:Xn,moon:Yn,monitor:Tr,bell:Wd,user:qa,"log-out":Ir,cog:Vd,"help-circle":Gd,info:Ii,"alert-circle":ua,"alert-triangle":Mi,"check-circle":_t,"x-circle":Xs},Dl=_e()((s,t)=>({icons:Ro,addIcon:(n,a)=>(s(r=>({icons:{...r.icons,[n]:a}})),()=>{t().removeIcon(n)}),addIcons:n=>(s(a=>({icons:{...a.icons,...n}})),()=>{Object.keys(n).forEach(a=>{t().removeIcon(a)})}),removeIcon:n=>{s(a=>{const r={...a.icons};return delete r[n],{icons:r}})},getIcon:n=>t().icons[n],reset:()=>{s({icons:Ro})}})),Hr=(s,t)=>{const n=rn(t);m.useEffect(()=>s?.listen(n),[s,n])};var vt=(s=>(s.AI_ASSISTANT="ai_assistant",s.THREAD="thread",s.SETTINGS="settings",s.STUDIO="studio",s))(vt||{});const Le=_e()(Xt((s,t)=>({sideView:ol()?void 0:"ai_assistant",currentThreadId:null,isChannelListOpen:!1,get isStudioOpen(){return t().sideView==="studio"},setSideView:(n,a=null)=>{s({sideView:n,currentThreadId:n==="thread"?a:null})},closeSideView:()=>{s({sideView:void 0,currentThreadId:null})},openAIAssistant:()=>{s({sideView:"ai_assistant",currentThreadId:null})},closeAIAssistant:()=>{t().sideView==="ai_assistant"&&s({sideView:void 0})},openThread:n=>{s({sideView:"thread",currentThreadId:n})},closeThread:()=>{t().sideView==="thread"&&s({sideView:void 0,currentThreadId:null})},openSettings:()=>{s({sideView:"settings",currentThreadId:null})},closeSettings:()=>{t().sideView==="settings"&&s({sideView:void 0})},openStudio:()=>{s({sideView:"studio",currentThreadId:null})},closeStudio:()=>{t().sideView==="studio"&&s({sideView:void 0})},openChannelList:()=>{s({isChannelListOpen:!0})},closeChannelList:()=>{s({isChannelListOpen:!1})}}),{name:"stillroot-ui-state",partialize:s=>({sideView:s.sideView})}));var hr=(s=>(s.DESKTOP="desktop",s.MOBILE="mobile",s))(hr||{}),_l=(s=>(s.TEXT="text",s.IMAGE="image",s.FILE="file",s))(_l||{}),ds=(s=>(s.NAME="name",s.DESCRIPTION="description",s.EMOJI="emoji",s))(ds||{}),Pl=(s=>(s.BUTTON="button",s.HOTKEY="hotkey",s.AUTO="auto",s))(Pl||{}),Ol=(s=>(s.LEFT="left",s.RIGHT="right",s))(Ol||{}),gr=(s=>(s.OPEN="open",s.CLOSE="close",s))(gr||{}),pr=(s=>(s.COLLAPSE="collapse",s.EXPAND="expand",s))(pr||{});class Sg{logEvent=(t,n)=>{const a=ne.getAnalytics();if(a)try{Gu(a,t,n)}catch(r){console.error("[Analytics] Failed to log event",r)}};setUserProperties=t=>{const n=ne.getAnalytics();n&&Vu(n,t)};logAppStart=(t,n)=>{this.logEvent("app_start",{platform:t,version:n})};logAppClose=t=>{this.logEvent("app_close",{session_duration:t})};logChannelCreate=(t,n,a)=>{this.logEvent("channel_create",{channel_id:t,channel_name:n,has_description:a})};logChannelSelect=(t,n,a)=>{this.logEvent("channel_select",{channel_id:t,channel_name:n,message_count:a})};logChannelEdit=(t,n)=>{this.logEvent("channel_edit",{channel_id:t,field:n})};logChannelDelete=(t,n,a)=>{this.logEvent("channel_delete",{channel_id:t,channel_name:n,message_count:a})};logNoteCreate=(t,n,a,r)=>{this.logEvent("note_create",{channel_id:t,note_type:n,content_length:a,has_tags:r})};logMessageEdit=(t,n,a)=>{this.logEvent("message_edit",{message_id:t,channel_id:n,edit_count:a})};logMessageDelete=(t,n,a)=>{this.logEvent("message_delete",{message_id:t,channel_id:n,message_age:a})};logMessageReply=(t,n,a)=>{this.logEvent("message_reply",{message_id:t,channel_id:n,thread_id:a})};logAIAssistantOpen=(t,n)=>{this.logEvent("ai_assistant_open",{channel_id:t,trigger:n})};logAIAssistantClose=(t,n,a)=>{this.logEvent("ai_assistant_close",{channel_id:t,session_duration:n,message_count:a})};logAIMessageSend=(t,n,a)=>{this.logEvent("ai_message_send",{channel_id:t,message_length:n,context_mode:a})};logAIMessageReceive=(t,n,a,r)=>{this.logEvent("ai_message_receive",{channel_id:t,response_length:n,response_time:a,tool_used:r})};logAIToolUse=(t,n,a)=>{this.logEvent("ai_tool_use",{tool_name:t,channel_id:n,success:a})};logThreadOpen=(t,n,a)=>{this.logEvent("thread_open",{message_id:t,channel_id:n,thread_count:a})};logThreadClose=(t,n,a)=>{this.logEvent("thread_close",{message_id:t,channel_id:n,session_duration:a})};logThreadReply=(t,n,a)=>{this.logEvent("thread_reply",{message_id:t,channel_id:n,thread_id:a})};logSearchStart=(t,n)=>{this.logEvent("search_start",{query:t,channel_id:n,search_scope:n?"channel":"global"})};logSearchResult=(t,n,a)=>{this.logEvent("search_result",{query:t,result_count:n,channel_id:a,search_scope:a?"channel":"global"})};logSearchSelect=(t,n,a)=>{this.logEvent("search_select",{query:t,result_index:n,channel_id:a,search_scope:a?"channel":"global"})};logSidebarToggle=(t,n)=>{this.logEvent("sidebar_toggle",{sidebar:t,action:n})};logInputCollapse=t=>{this.logEvent("input_collapse",{action:t})};logScrollToBottom=(t,n)=>{this.logEvent("scroll_to_bottom",{channel_id:t,message_count:n})};logScrollToLatest=(t,n)=>{this.logEvent("scroll_to_latest",{channel_id:t,message_count:n})};logMessageExpand=(t,n,a)=>{this.logEvent("message_expand",{message_id:t,channel_id:n,content_length:a})};logSettingsOpen=t=>{this.logEvent("settings_open",{channel_id:t})};logThemeChange=t=>{this.logEvent("theme_change",{theme:t})};logContextModeChange=(t,n)=>{this.logEvent("context_mode_change",{mode:t,channel_id:n})};logPageLoad=(t,n,a)=>{this.logEvent("page_load",{page:t,load_time:n,platform:a})};logMessageLoad=(t,n,a)=>{this.logEvent("message_load",{channel_id:t,message_count:n,load_time:a})};logVirtualizationPerformance=(t,n,a,r)=>{this.logEvent("virtualization_performance",{channel_id:t,visible_count:n,total_count:a,render_time:r})};logError=(t,n,a,r)=>{this.logEvent("error_occurred",{error_type:t,error_message:n,component:a,channel_id:r})};logAIFailure=(t,n,a)=>{this.logEvent("ai_failure",{channel_id:t,error_type:n,retry_count:a})};logDailyActive=(t,n,a)=>{this.logEvent("daily_active",{message_count:t,channel_count:n,ai_usage_count:a})};logSessionMetrics=(t,n,a,r)=>{this.logEvent("session_metrics",{session_duration:t,message_count:n,ai_interaction_count:a,channel_count:r})};logFeatureUsage=(t,n,a)=>{this.logEvent("feature_usage",{feature:t,action:n,channel_id:a})};logExport=(t,n,a)=>{this.logEvent("export",{format:t,channel_id:n,message_count:a})};logTagUse=(t,n,a)=>{this.logEvent("tag_use",{tag:t,channel_id:n,action:a})};logHotkeyUse=(t,n)=>{this.logEvent("hotkey_use",{hotkey:t,context:n})};logMobileGesture=(t,n)=>{this.logEvent("mobile_gesture",{gesture:t,action:n})};logPWAInstall=t=>{this.logEvent("pwa_install",{platform:t})};logPWAUpdate=t=>{this.logEvent("pwa_update",{version:t})};logBatchOperation=(t,n,a)=>{this.logEvent("batch_operation",{operation:t,item_count:n,channel_id:a})};logFeedback=(t,n,a)=>{this.logEvent("feedback",{type:t,rating:n,channel_id:a})}}const De=new Sg,$l=m.createContext(null),Mg=()=>{const s=m.useContext($l);if(!s)throw new Error("useCollapsibleSidebar must be used within CollapsibleSidebar");return s},Ig=({children:s,width:t="w-80",collapsedWidth:n="w-0",className:a="",collapsed:r,onCollapseChange:o})=>{const[i,l]=m.useState(!1),c=r!==void 0?r:i,d=()=>{const h=!c;De.logSidebarToggle(Ol.LEFT,h?gr.CLOSE:gr.OPEN),r===void 0&&l(h),o?.(h)};m.useEffect(()=>{r!==void 0&&l(r)},[r]);const u={isCollapsed:c,toggleCollapse:d,onCollapseChange:o};return e.jsx($l.Provider,{value:u,children:e.jsx("div",{"data-component":"collapsible-sidebar",className:E("flex-shrink-0 transition-all duration-300 ease-in-out overflow-hidden",c?n:t,a),children:e.jsx("div",{className:E("h-full flex flex-col transition-opacity duration-300",c?"opacity-0":"opacity-100"),children:s})})})},Tg=({children:s,className:t=""})=>e.jsx("div",{className:E("flex items-center justify-between p-3 border-b border-border",t),children:s}),Eg=({className:s="",children:t})=>{const{isCollapsed:n,toggleCollapse:a}=Mg();return e.jsx(M,{variant:"ghost",size:"sm",onClick:a,className:E("h-8 w-8 hover:bg-accent transition-all duration-300",n?"opacity-0 scale-95":"opacity-100 scale-100",s),title:n?"Expand sidebar":"Collapse sidebar",children:t||e.jsx(Jn,{className:"h-4 w-4"})})},Ag=({children:s,className:t=""})=>e.jsx("div",{"data-component":"collapsible-sidebar-content",className:E("flex-1 overflow-hidden",t),children:s}),ea=Object.assign(Ig,{Header:Tg,ToggleButton:Eg,Content:Ag}),Wt=_e()(Xt(s=>({isLeftSidebarCollapsed:!0,rightSidebarVisible:!1,rightSidebarSize:35,layoutMode:"default",showTimestamps:!0,showUserAvatars:!0,timelineCoverCollapsed:!0,timelineInputCollapsed:{},toggleLeftSidebar:()=>{s(t=>({isLeftSidebarCollapsed:!t.isLeftSidebarCollapsed}))},setLeftSidebarCollapsed:t=>{s({isLeftSidebarCollapsed:t})},setRightSidebarVisible:t=>{s({rightSidebarVisible:t})},setRightSidebarSize:t=>{s({rightSidebarSize:t})},setLayoutMode:t=>{s({layoutMode:t})},setShowTimestamps:t=>{s({showTimestamps:t})},setShowUserAvatars:t=>{s({showUserAvatars:t})},setTimelineCoverCollapsed:t=>{s({timelineCoverCollapsed:t})},setTimelineInputCollapsed:(t,n)=>{s(a=>({timelineInputCollapsed:{...a.timelineInputCollapsed,[t]:n}}))}}),{name:"stillroot-ui-preferences-storage",partialize:s=>({isLeftSidebarCollapsed:s.isLeftSidebarCollapsed,rightSidebarVisible:s.rightSidebarVisible,rightSidebarSize:s.rightSidebarSize,layoutMode:s.layoutMode,showTimestamps:s.showTimestamps,showUserAvatars:s.showUserAvatars,timelineCoverCollapsed:s.timelineCoverCollapsed,timelineInputCollapsed:s.timelineInputCollapsed}),version:2,migrate:(s,t)=>{if(t<2&&s&&typeof s=="object"){const n=s,a=n.timelineCoverCollapsed;let r;return a&&typeof a=="object"&&!Array.isArray(a)?r=Object.values(a).some(Boolean):r=!!a,{...n,timelineCoverCollapsed:r}}return s}})),Rg=({children:s,width:t="w-70",collapsedWidth:n="w-0",className:a=""})=>{const{isLeftSidebarCollapsed:r,setLeftSidebarCollapsed:o}=Wt(),i=l=>{o(l)};return e.jsx(ea,{width:t,collapsedWidth:n,className:a,collapsed:r,onCollapseChange:i,children:e.jsx(ea.Content,{children:s})})};function Lg({className:s,...t}){return e.jsx(ym,{"data-slot":"resizable-panel-group",className:E("flex h-full w-full data-[panel-group-direction=vertical]:flex-col",s),...t})}function Lo({...s}){return e.jsx(jm,{"data-slot":"resizable-panel",...s})}function Dg({withHandle:s,className:t,...n}){return e.jsx(Nm,{"data-slot":"resizable-handle",className:E("bg-border/20 hover:bg-border/40 relative flex w-px items-center justify-center after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:translate-x-0 data-[panel-group-direction=vertical]:after:-translate-y-1/2 [&[data-panel-group-direction=vertical]>div]:rotate-90 transition-colors duration-200",t),...n,children:s&&e.jsx("div",{className:"bg-border/30 hover:bg-border/50 z-10 flex h-4 w-3 items-center justify-center rounded-xs border border-border/20 transition-colors duration-200",children:e.jsx(eu,{className:"size-2.5 text-muted-foreground/60"})})})}const _g=({children:s,rightSidebar:t,farRightSidebar:n,className:a=""})=>{const{rightSidebarSize:r,setRightSidebarSize:o}=Wt(),l=!!t||!!n?100-r:100;return e.jsxs(Lg,{direction:"horizontal",className:"flex-1 min-h-0",children:[e.jsx(Lo,{id:"content-panel",defaultSize:l,minSize:20,children:e.jsx("div",{className:`h-full flex flex-col bg-background overflow-hidden ${a}`,children:s})}),(t||n)&&e.jsxs(e.Fragment,{children:[e.jsx(Dg,{withHandle:!0}),e.jsx(Lo,{id:"right-sidebar-panel",defaultSize:r,minSize:20,onResize:c=>{o(c)},children:e.jsxs("div",{className:"h-full bg-muted overflow-hidden flex",children:[t&&e.jsx("div",{className:"h-full flex-1 min-w-0",children:t}),n&&e.jsx("div",{className:`h-full ${t?"w-[450px] min-w-[450px]":"flex-1 min-w-0"}`,children:n})]})})]})]})},Pg=({sidebar:s,content:t,rightSidebar:n,farRightSidebar:a,className:r=""})=>e.jsx("div",{className:`flex-1 flex flex-col bg-background ${r} overflow-hidden`,children:e.jsxs("div",{className:"flex-1 flex min-h-0 relative",children:[e.jsx(Rg,{className:"bg-card dark:bg-sidebar",children:s}),e.jsx(_g,{rightSidebar:n,farRightSidebar:a,children:t})]})});function fr(s,t=new WeakSet){if(s===null)return null;const n=typeof s;if(n==="string"||n==="number"||n==="boolean")return s;if(n==="bigint")return Number(s);if(!(n==="symbol"||n==="function"||n==="undefined")){if(Array.isArray(s))return s.map(r=>fr(r,t)).filter(r=>r!==void 0);if(n==="object"){const a=s;if(t.has(a))return;t.add(a);const r={};for(const[o,i]of Object.entries(a)){const l=fr(i,t);l!==void 0&&(r[o]=l)}return t.delete(a),r}}}function An(s){return{id:s.id,role:s.role,parts:fr(s.parts)}}class Og{getDb(){return ne.getDb()}async createConversation(t,n,a){const r=crypto.randomUUID(),o={id:r,title:n,userId:t,createdAt:new Date,updatedAt:new Date,lastMessageAt:new Date,messageCount:0,isArchived:!1,...a?{contexts:a}:{}};return await Zs(me(this.getDb(),`users/${t}/aiConversations/${r}`),{...o,createdAt:ce(),updatedAt:ce(),lastMessageAt:ce()}),o}async getConversations(t){const n=this.buildConversationsQuery(t);return(await Se(n)).docs.map(r=>this.docToAIConversation(r))}async listConversations(t,n={}){const a=n.limit??20;let r=be(ze(this.getDb(),`users/${t}/aiConversations`),Ve("lastMessageAt","desc"),Gt(a));n.startAfterLastMessageAt&&(r=be(r,nr(n.startAfterLastMessageAt)));const o=await Se(r),i=o.docs.map(c=>this.docToAIConversation(c));let l=null;return i.length===a&&(l=o.docs[o.docs.length-1].data()?.lastMessageAt?.toDate?.()??i[i.length-1]?.lastMessageAt??null),{items:i,nextCursor:l}}async getConversation(t,n){const a=me(this.getDb(),`users/${t}/aiConversations/${n}`),r=await Vt(a);return r.exists()?this.docToAIConversation(r):null}async deleteConversation(t,n){const a=ze(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages`),o=(await Se(a)).docs.map(i=>Fn(i.ref));await Promise.all(o),await Fn(me(this.getDb(),`users/${t}/aiConversations/${n}`))}async updateConversation(t,n,a){await Te(me(this.getDb(),`users/${t}/aiConversations/${n}`),{...a,updatedAt:ce()})}async addMessage(t,n,a){const r=me(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${a.id}`),i=!(await Vt(r)).exists();if(i){console.log("[FirebaseAIConversationService] addMessage new message",a);const c=An(a);await Zs(r,{...c,conversationId:n,timestamp:ce()})}else{console.log("[FirebaseAIConversationService] addMessage existing message",a);const c=An(a);await Te(r,{...c,conversationId:n,timestamp:ce()})}const l={lastMessageAt:ce(),updatedAt:ce()};i&&(l.messageCount=rs(1)),await Te(me(this.getDb(),`users/${t}/aiConversations/${n}`),l)}async createMessage(t,n,a){const r=me(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${a.id}`);if((await Vt(r)).exists())return;const i=An(a);await Zs(r,{...i,conversationId:n,timestamp:ce()}),await Te(me(this.getDb(),`users/${t}/aiConversations/${n}`),{lastMessageAt:ce(),updatedAt:ce(),messageCount:rs(1)})}async getMessages(t,n){const a=be(ze(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages`),Ve("timestamp","asc"));return(await Se(a)).docs.map(o=>this.docToUIMessage(o))}async listMessages(t,n,a={}){const{limit:r=50,orderBy:o="asc",startAfter:i,endBefore:l}=a;let c=be(ze(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages`),Ve("timestamp",o));if(r&&(c=be(c,im(r))),i){const u=await Vt(me(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${i}`));c=be(c,nr(u))}if(l){const u=await Vt(me(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${l}`));c=be(c,lm(u))}return(await Se(c)).docs.map(u=>this.docToUIMessage(u))}async updateMessage(t,n,a,r){const o={updatedAt:ce()},i=r;if(Object.prototype.hasOwnProperty.call(i,"role")&&(o.role=i.role),Object.prototype.hasOwnProperty.call(i,"parts")){const l=An({id:a,role:i.role??"assistant",parts:i.parts});o.parts=l.parts}await Te(me(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${a}`),o)}async deleteMessage(t,n,a){await Fn(me(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${a}`)),await Te(me(this.getDb(),`users/${t}/aiConversations/${n}`),{messageCount:rs(-1),updatedAt:ce()})}subscribeToMessages(t,n,a){const r=be(ze(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages`),Ve("timestamp","asc"));return Js(r,o=>{const i=o.docs.map(l=>this.docToUIMessage(l));a(i)})}subscribeToConversations(t,n){const a=this.buildConversationsQuery(t);return Js(a,r=>{const o=r.docs.map(i=>this.docToAIConversation(i));n(o)})}buildConversationsQuery(t){return be(ze(this.getDb(),`users/${t}/aiConversations`),Ve("lastMessageAt","desc"))}docToAIConversation(t){const n=t.data(),a={id:t.id,title:n.title,userId:n.userId,createdAt:n.createdAt?.toDate()||new Date,updatedAt:n.updatedAt?.toDate()||new Date,lastMessageAt:n.lastMessageAt?.toDate()||new Date,messageCount:n.messageCount||0,isArchived:n.isArchived||!1};let r;return n.contexts?r=n.contexts:n.channelId&&(r={mode:"channels",channelIds:[n.channelId]}),r?{...a,contexts:r}:a}docToUIMessage(t){const n=t.data();return{id:t.id,role:n.role,parts:n.parts}}}const it=new Og,$g="https://api-gateway.stillroot.app",Bg="proxy",Ug=`${$g.replace(/\/+$/,"")}/openai/v1`,is="qwen-plus-latest",ls=new Qi({apiKey:Bg,baseURL:Ug,dangerouslyAllowBrowser:!0}),Bl=["en","zh-CN"],Fg="stillroot-lang",_a=s=>s&&s.toLowerCase().startsWith("zh")?"zh-CN":"en",zg=()=>{if(typeof window>"u")return"en";try{const t=localStorage.getItem(Fg);if(t)try{const n=JSON.parse(t);if(n&&n.state&&n.state.language)return _a(n.state.language)}catch{const n=_a(t);if(n)return n}}catch{}const s=(navigator.languages?.[0]??navigator.language)||"en";return _a(s)};let Rn=null;const Hg=()=>{if(Rn)return Rn;const s=typeof window>"u"?"en":zg();return Rn=W.use(Cm).use(zd).init({lng:s,fallbackLng:"en",supportedLngs:[...Bl],ns:["common"],defaultNS:"common",backend:{loadPath:"/locales/{{lng}}/{{ns}}.json"},interpolation:{escapeValue:!1},returnNull:!1}).then(async()=>{if(typeof window>"u")return;const{syncLanguageFromI18n:t,useLanguageStore:n}=await ue(async()=>{const{syncLanguageFromI18n:o,useLanguageStore:i}=await Promise.resolve().then(()=>Ox);return{syncLanguageFromI18n:o,useLanguageStore:i}},void 0),a=n.getState().language,r=W.resolvedLanguage??W.language;a&&a!==r?W.changeLanguage(a):t(r),W.on("languageChanged",o=>{t(o)})}),Rn};async function Gg({prompt:s,system:t,temperature:n}){const r=(await ls.chat.completions.create({model:is,messages:[{role:"system",content:t??W.t("aiAssistant.prompts.systemPrompts.defaultAssistant")},{role:"user",content:s}],temperature:n})).choices?.[0]?.message?.content;return typeof r=="string"?r:""}class Vg{inFlight=new Map;queue=[];running=!1;enabled=!0;minIntervalMs=1500;results=new Map;setEnabled(t){this.enabled=t}request(t,n,a){if(!this.enabled)return Promise.resolve("");const r=this.inFlight.get(t);if(r)return r.promise;const o=new Promise((i,l)=>{const c=a?.mode||"deterministic",d=Fl(a?.lng);this.queue.push(JSON.stringify({id:t,text:n,mode:c,lng:d})),this.runLoop().catch(()=>{});const u=setInterval(()=>{const h=this.results.get(t);h!==void 0&&(clearInterval(u),this.results.delete(t),h.error?l(h.error):i(h.title||""))},50)});return this.inFlight.set(t,{promise:o,ts:Date.now()}),o.finally(()=>this.inFlight.delete(t)),o}async runLoop(){if(this.running)return;this.running=!0;let t=0;for(;this.queue.length;){const n=this.queue.shift();if(!n)break;const{id:a,text:r,mode:o,lng:i}=JSON.parse(n),l=Date.now()-t;l<this.minIntervalMs&&await new Promise(c=>setTimeout(c,this.minIntervalMs-l));try{const c=await this.generateTitle(r,o,i);this.results.set(a,{title:c}),t=Date.now()}catch(c){this.results.set(a,{error:c}),t=Date.now()}}this.running=!1}async generateTitle(t,n,a){return n==="deterministic"?this.generateDeterministicTitle(t):n==="auto"&&!this.enabled?this.generateDeterministicTitle(t):n==="ai"||n==="auto"&&this.enabled?this.generateAITitle(t,a):this.generateDeterministicTitle(t)}generateDeterministicTitle(t){return t.trim().replace(/\s+/g," ").slice(0,200)}async generateAITitle(t,n){try{const a=this.buildTitlePrompt(t,n),r=await this.callAIService(a,n),o=this.validateAndTrimTitle(r);return o||this.generateDeterministicTitle(t)}catch(a){return console.warn("AI title generation failed, falling back to deterministic:",a),this.generateDeterministicTitle(t)}}buildTitlePrompt(t,n){return n==="zh-CN"?`è¯·æ ¹æ®ä»¥ä¸‹å¯¹è¯å†…å®¹ç”Ÿæˆä¸€ä¸ªç®€æ´ã€æ˜Žç¡®çš„å¯¹è¯æ ‡é¢˜ã€‚è¦æ±‚ï¼š
- æœ€å¤š 36 ä¸ªå­—ç¬¦
- æ¦‚æ‹¬ä¸»è¦ä¸»é¢˜
- é¿å…â€œæ–°å¯¹è¯â€è¿™ç±»æ³›è¯
- åªè¾“å‡ºæ ‡é¢˜æœ¬èº«ï¼Œä¸è¦å¼•å·ã€ä¸è¦å¤šä½™è§£é‡Š

å†…å®¹ï¼š${t}`:`Generate a concise, descriptive title for this conversation content. The title should be:
- Maximum 36 characters
- Capture the main topic or theme
- Be clear and informative
- Avoid generic phrases like "New Conversation"
- Output ONLY the title (no quotes, no extra text)

Content: ${t}`}async callAIService(t,n){return await Gg({prompt:t,system:W.t("aiAssistant.prompts.systemPrompts.defaultTitleGenerator",{lng:n}),temperature:.3})}validateAndTrimTitle(t){const n=t.trim();return n&&n.length<=36?n:null}}const Wg=new Vg;async function qg(s){if(!Kg(s))return;const t=Yg(s.messages);if(t){s.setTitleGenerating(s.conversationId);try{const n=await Xg(s,t);if(!n){s.completeTitleGenerating(s.conversationId);return}await Jg(s,n),s.completeTitleGenerating(s.conversationId)}catch(n){throw s.completeTitleGenerating(s.conversationId),n}}}function Kg(s){const{conversationId:t,conversation:n,autoTitleDone:a}=s;return a[t]?!1:Ul(n.title)}function Ul(s){const t=(s??"").trim();if(!t||t.toLowerCase()==="new conversation"||t.startsWith("temp-"))return!0;const n=new Set;for(const a of Bl)n.add(W.t("aiAssistant.conversationList.newConversation",{lng:a})),n.add(W.t("aiAssistant.conversationList.generatingTitle",{lng:a}));return n.has(t)}function Yg(s){const t=s.find(a=>a.role==="user");return t&&t.parts.find(a=>a.type==="text")?.text?.trim()||""}async function Xg(s,t){const{conversationId:n,autoTitleEnabled:a,autoTitleMode:r}=s,o=a?r:"deterministic",i=Fl(W.resolvedLanguage??W.language);try{const l=await Wg.request(n,t,{mode:o,lng:i});if(l)return l}catch{return t.replace(/\s+/g," ").slice(0,36)}return t.replace(/\s+/g," ").slice(0,36)}async function Jg(s,t){const{conversationId:n,getUserId:a,update:r,applyLocal:o,markDone:i}=s,l=a();l&&(await r(l,n,t),o(n,t),i(n))}function Fl(s){return(s??"").toLowerCase().startsWith("zh")?"zh-CN":"en"}const Zg="stillroot-local-ai:";function zl(s){return`${Zg}${s}`}function ts(s){const t=localStorage.getItem(zl(s));if(!t)return{conversations:[],messagesByConversation:{}};try{const n=JSON.parse(t);return{conversations:Array.isArray(n.conversations)?n.conversations:[],messagesByConversation:n.messagesByConversation&&typeof n.messagesByConversation=="object"?n.messagesByConversation:{}}}catch{return{conversations:[],messagesByConversation:{}}}}function Vs(s,t){localStorage.setItem(zl(s),JSON.stringify(t))}function Pa(s){return{...s,createdAt:new Date(s.createdAt),updatedAt:new Date(s.updatedAt),lastMessageAt:new Date(s.lastMessageAt)}}function Oa(s){return{...s,createdAt:s.createdAt.toISOString(),updatedAt:s.updatedAt.toISOString(),lastMessageAt:s.lastMessageAt.toISOString()}}function Qg(s,t){const n=t?.orderBy??"desc",a=t?.limit??50,r=t?.offset??0;return[...s].sort((i,l)=>{const c=i.createdAt,d=l.createdAt,u=c?new Date(c).getTime():0,h=d?new Date(d).getTime():0;return n==="asc"?u-h:h-u}).slice(r,r+a)}const Ke={async listConversations(s,t){const a=ts(s).conversations.map(Pa).sort((d,u)=>u.lastMessageAt.getTime()-d.lastMessageAt.getTime()),r=t?.startAfterLastMessageAt?.getTime?.()??null,o=r?a.filter(d=>d.lastMessageAt.getTime()<r):a,i=t?.limit??20,l=o.slice(0,i),c=o.length>i?l[l.length-1]?.lastMessageAt??null:null;return{items:l,nextCursor:c}},async createConversation(s,t,n){const a=ts(s),r=new Date,o={id:crypto.randomUUID(),userId:s,title:t,createdAt:r,updatedAt:r,lastMessageAt:r,messageCount:0,isArchived:!1,contexts:n??null};return a.conversations.unshift(Oa(o)),a.messagesByConversation[o.id]=[],Vs(s,a),o},async updateConversation(s,t,n){const a=ts(s),r=a.conversations.findIndex(l=>l.id===t);if(r<0)return;const i={...Pa(a.conversations[r]),...n,updatedAt:new Date};a.conversations[r]=Oa(i),Vs(s,a)},async deleteConversation(s,t){const n=ts(s);n.conversations=n.conversations.filter(a=>a.id!==t),delete n.messagesByConversation[t],Vs(s,n)},async getMessages(s,t){return ts(s).messagesByConversation[t]??[]},subscribeToMessages(s,t,n){let a=!0,r="";const o=async()=>{if(!a)return;const i=await Ke.getMessages(s,t),l=JSON.stringify(i.map(c=>c.id));l!==r&&(r=l,n(i)),setTimeout(o,1e3)};return o(),()=>{a=!1}},async createMessage(s,t,n){const a=ts(s),r=a.messagesByConversation[t]??[];r.push(n),a.messagesByConversation[t]=r;const o=a.conversations.findIndex(i=>i.id===t);if(o>=0){const i=Pa(a.conversations[o]),l=new Date,c={...i,lastMessageAt:l,updatedAt:l,messageCount:(i.messageCount??0)+1};a.conversations[o]=Oa(c)}Vs(s,a)},async updateMessage(s,t,n,a){const r=ts(s),o=r.messagesByConversation[t]??[],i=o.findIndex(l=>l.id===n);i<0||(o[i]=a,r.messagesByConversation[t]=o,Vs(s,r))},async listMessages(s,t,n){const a=await Ke.getMessages(s,t);return Qg(a,n)}};function ep(s,t,n){return s.id.startsWith("temp-")||t.autoTitleDone[s.id]||t.titleGeneratingMap[s.id]||!n.some(r=>r.role==="user")?!1:Ul(s.title)}const Hl=s=>s.startsWith("temp-"),se=_e((s,t)=>({conversations:[],currentConversationId:null,loading:!1,loadingMore:!1,error:null,selectionTick:0,uiView:"chat",deletingIds:[],showArchived:!1,query:"",titleGeneratingMap:{},autoTitleEnabled:!0,autoTitleDone:{},autoTitleMode:"ai",nextCursor:null,hasMore:!1,resetForLoggedOut(){s({conversations:[],currentConversationId:null,loading:!1,loadingMore:!1,error:null,nextCursor:null,hasMore:!1})},async createConversation(n,a,r){s({error:null});const o=`temp-${crypto.randomUUID()}`,i={id:o,title:a,userId:n,createdAt:new Date,updatedAt:new Date,lastMessageAt:new Date,messageCount:0,isArchived:!1,...r?{contexts:r}:{}};s(l=>({conversations:[i,...l.conversations],currentConversationId:o,uiView:"chat"}));try{const l=Ue(n)?await Ke.createConversation(n,a,r):await it.createConversation(n,a,r);return s(c=>({conversations:c.conversations.map(d=>d.id===o?l:d),currentConversationId:l.id,uiView:"chat"})),l}catch(l){throw s(c=>({conversations:c.conversations.filter(d=>d.id!==o),currentConversationId:c.currentConversationId===o?null:c.currentConversationId,error:l instanceof Error?l.message:"Failed to create conversation"})),l}},async loadConversations(n){s({loading:!0,error:null,nextCursor:null,hasMore:!1});try{const{items:a,nextCursor:r}=Ue(n)?await Ke.listConversations(n,{limit:20}):await it.listConversations(n,{limit:20}),o=t().currentConversationId;s({conversations:a,loading:!1,nextCursor:r,hasMore:!!r}),a.length>0&&!o&&s({currentConversationId:a[0].id})}catch(a){s({loading:!1,error:a instanceof Error?a.message:"Failed to load conversations"})}},async loadMoreConversations(n){const{nextCursor:a,loadingMore:r,hasMore:o}=t();if(!(!o||r)){s({loadingMore:!0});try{const{items:i,nextCursor:l}=Ue(n)?await Ke.listConversations(n,{limit:20,startAfterLastMessageAt:a}):await it.listConversations(n,{limit:20,startAfterLastMessageAt:a}),d=[...t().conversations];for(const u of i)d.some(h=>h.id===u.id)||d.push(u);s({conversations:d,nextCursor:l,hasMore:!!l})}catch(i){s({error:i instanceof Error?i.message:"Failed to load more conversations"})}finally{s({loadingMore:!1})}}},selectConversation(n){s(a=>({currentConversationId:n,selectionTick:a.selectionTick+1,uiView:"chat"}))},async deleteConversation(n,a){s(i=>({error:null,deletingIds:[...i.deletingIds,a]}));const r=t().conversations,o=t().currentConversationId===a;s(i=>({conversations:i.conversations.filter(l=>l.id!==a),currentConversationId:o?null:i.currentConversationId}));try{Ue(n)?await Ke.deleteConversation(n,a):await it.deleteConversation(n,a)}catch(i){throw s({conversations:r,currentConversationId:o?a:t().currentConversationId,error:i instanceof Error?i.message:"Failed to delete conversation"}),i}finally{s(i=>({deletingIds:i.deletingIds.filter(l=>l!==a)}))}},async updateConversation(n,a,r){const o=t().conversations;s(i=>({conversations:i.conversations.map(l=>l.id===a?{...l,...r}:l)}));try{Ue(n)?await Ke.updateConversation(n,a,r):await it.updateConversation(n,a,r)}catch(i){throw s({conversations:o,error:i instanceof Error?i.message:"Failed to update conversation"}),i}},clearError(){s({error:null})},showList(){s({uiView:"list"})},showChat(){s({uiView:"chat"})},setView(n){s({uiView:n})},setShowArchived(n){s({showArchived:n})},setQuery(n){s({query:n})},async archiveConversation(n,a){Ue(n)?await Ke.updateConversation(n,a,{isArchived:!0,updatedAt:new Date}):await it.updateConversation(n,a,{isArchived:!0,updatedAt:new Date}),s(r=>({conversations:r.conversations.map(o=>o.id===a?{...o,isArchived:!0}:o)}))},async unarchiveConversation(n,a){Ue(n)?await Ke.updateConversation(n,a,{isArchived:!1,updatedAt:new Date}):await it.updateConversation(n,a,{isArchived:!1,updatedAt:new Date}),s(r=>({conversations:r.conversations.map(o=>o.id===a?{...o,isArchived:!1}:o)}))},setTitleGenerating(n){s(a=>({titleGeneratingMap:{...a.titleGeneratingMap,[n]:!0}}))},completeTitleGenerating(n){s(a=>{const r={...a.titleGeneratingMap};return delete r[n],{titleGeneratingMap:r}})},clearTitleGenerating(n){s(a=>{const r={...a.titleGeneratingMap};return delete r[n],{titleGeneratingMap:r}})},setAutoTitleDone(n){s(a=>({autoTitleDone:{...a.autoTitleDone,[n]:!0}}))},setAutoTitleMode(n){s({autoTitleMode:n})},onMessagesSnapshot(n,a){const r=t(),o=r.conversations.find(i=>i.id===n);o&&ep(o,r,a)&&qg({conversationId:n,conversation:o,messages:a,autoTitleEnabled:r.autoTitleEnabled,autoTitleMode:r.autoTitleMode,autoTitleDone:r.autoTitleDone,getUserId:()=>O.getState().userId,update:async(i,l,c)=>{Ue(i)?await Ke.updateConversation(i,l,{title:c}):await it.updateConversation(i,l,{title:c})},applyLocal:(i,l)=>s(c=>({conversations:c.conversations.map(d=>d.id===i?{...d,title:l}:d)})),markDone:i=>s(l=>({autoTitleDone:{...l.autoTitleDone,[i]:!0}})),setTitleGenerating:i=>t().setTitleGenerating(i),completeTitleGenerating:i=>t().completeTitleGenerating(i)})}}));function bn(){const s=se(p=>p.conversations),t=se(p=>p.currentConversationId),n=se(p=>p.loading),a=se(p=>p.loadingMore),r=se(p=>p.error),o=se(p=>p.hasMore),i=se(p=>p.createConversation),l=se(p=>p.loadConversations),c=se(p=>p.loadMoreConversations),d=se(p=>p.resetForLoggedOut),u=se(p=>p.selectConversation),h=se(p=>p.deleteConversation),g=se(p=>p.updateConversation),x=se(p=>p.clearError),f=m.useMemo(()=>s.find(p=>p.id===t)||null,[s,t]);return{conversations:s,currentConversationId:t,currentConversation:f,loading:n,loadingMore:a,error:r,hasMore:o,createConversation:i,loadConversations:l,loadMoreConversations:c,resetForLoggedOut:d,selectConversation:u,deleteConversation:h,updateConversation:g,clearError:x}}function tp(s,t){const{sidebar:n=320,chatMin:a=520,gutter:r=0,hysteresis:o=24,debounceMs:i=100}=t||{},[l,c]=m.useState("two-pane"),[d,u]=m.useState(!1),h=m.useRef(l);return h.current=l,m.useLayoutEffect(()=>{const g=s.current;if(!g)return;const x=n+a+r;let f=null;const p=()=>{const y=g.clientWidth||g.getBoundingClientRect().width,w=h.current;let N;w==="two-pane"?N=y>=x-o?"two-pane":"single-pane":N=y>=x+o?"two-pane":"single-pane",N!==w&&(h.current=N,c(N)),u(!0)},b=()=>{f&&clearTimeout(f),f=setTimeout(p,i)};p();const v=new ResizeObserver(()=>b());return v.observe(g),()=>{f&&clearTimeout(f),v.disconnect()}},[s,n,a,r,o,i]),{mode:l,ready:d}}const Yt=s=>{const t=typeof s=="string"?new Date(s):s;if(isNaN(t.getTime()))return"Unknown time";const n=new Date,a=Math.floor((n.getTime()-t.getTime())/(1e3*60)),r=Math.floor(a/60),o=el(n,t);return a<1?"Just now":a<60?`${a}m`:r<24?`${r}h`:km(t)?"Yesterday":o<3?`${o}d ago`:Sm(t)?or(t,"MMM d"):or(t,"MMM d, yyyy")},Gl=s=>{const t=typeof s=="string"?new Date(s):s;if(isNaN(t.getTime()))return"Unknown time";const n=new Date,a=Math.floor((n.getTime()-t.getTime())/(1e3*60)),r=Math.floor(a/60),o=el(n,t);return a<1?"Just now":a<60?`${a}m ago`:r<24?`${r}h ago`:o===1?"Yesterday":o<7?`${o}d ago`:o<30?`${Math.floor(o/7)}w ago`:o<365?`${Math.floor(o/30)}mo ago`:`${Math.floor(o/365)}y ago`};function ln({...s}){return e.jsx(ed,{"data-slot":"popover",...s})}function cn({...s}){return e.jsx(Qc,{"data-slot":"popover-trigger",...s})}function dn({className:s,align:t="center",sideOffset:n=4,...a}){return e.jsx(td,{children:e.jsx(sd,{"data-slot":"popover-content",align:t,sideOffset:n,className:E("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",s),...a})})}function Do({...s}){return e.jsx(nd,{"data-slot":"popover-close",...s})}function Gr({conversations:s,currentConversationId:t,loading:n}){const{t:a}=L(),{selectConversation:r,deleteConversation:o,updateConversation:i,loadMoreConversations:l,hasMore:c,loadingMore:d}=bn(),{userId:u}=O(),h=se(j=>j.deletingIds),g=se(j=>j.showArchived),x=se(j=>j.setShowArchived),f=se(j=>j.query),p=se(j=>j.setQuery),b=se(j=>j.titleGeneratingMap),[v,y]=m.useState(null),[w,N]=m.useState(""),S=s.filter(j=>{if(!g&&j.isArchived)return!1;if(!f)return!0;const C=f.toLowerCase();return(j.title||"").toLowerCase().includes(C)});return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-3 sticky top-0 z-10 flex items-center gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{value:f,onChange:j=>p(j.target.value),placeholder:a("aiAssistant.conversationList.searchPlaceholder"),className:"w-full h-9 px-3 rounded-lg border bg-muted/50 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-colors"})}),e.jsxs(ln,{children:[e.jsx(cn,{asChild:!0,children:e.jsx("button",{type:"button",className:"h-9 w-9 inline-flex items-center justify-center rounded-lg border bg-background hover:bg-accent transition-colors","aria-label":a("aiAssistant.conversationList.filter"),children:e.jsx(tu,{className:"w-4 h-4"})})}),e.jsx(dn,{align:"end",sideOffset:6,className:"p-2 w-56",onClick:j=>j.stopPropagation(),onMouseDown:j=>j.stopPropagation(),children:e.jsxs("button",{type:"button",onClick:()=>x(!g),className:"w-full h-8 px-3 rounded-md border bg-background text-sm flex items-center justify-between hover:bg-accent transition-colors",children:[e.jsx("span",{children:a("aiAssistant.conversationList.showArchived")}),e.jsx("span",{className:"inline-block w-4 h-4 rounded-sm border "+(g?"bg-primary border-primary":"bg-background")})]})})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:n?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:a("common.loading")}):S.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:a("aiAssistant.conversationList.noConversations")}):e.jsxs(e.Fragment,{children:[S.map(j=>e.jsx("div",{className:`group px-4 py-3 cursor-pointer hover:bg-accent/50 transition-colors ${t===j.id?"bg-accent":""} ${h.includes(j.id)?"opacity-50 pointer-events-none":""}`,onClick:()=>r(j.id),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"text-sm font-medium text-foreground truncate mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"truncate",children:v===j.id?e.jsx("input",{value:w,onChange:C=>N(C.target.value),onKeyDown:C=>{if(C.key==="Enter"){const I=w.trim();I&&u&&i(u,j.id,{title:I}),y(null)}C.key==="Escape"&&y(null)},onBlur:()=>{const C=w.trim();C&&u&&i(u,j.id,{title:C}),y(null)},className:"h-7 px-2 rounded-sm border bg-background text-sm w-full",autoFocus:!0,onClick:C=>C.stopPropagation()}):e.jsx("span",{onDoubleClick:C=>{C.stopPropagation(),y(j.id),N(j.title||"")},children:b[j.id]?a("aiAssistant.conversationList.generatingTitle"):j.title||a("aiAssistant.conversationList.newConversation")})}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsx(Ls,{className:"w-3 h-3 text-muted-foreground/60"}),e.jsx("span",{className:"text-xs text-muted-foreground/70",children:j.messageCount})]})]}),j.isArchived&&e.jsx("span",{className:"ml-2 text-[10px] uppercase tracking-wide text-muted-foreground bg-muted px-1.5 py-0.5 rounded",children:a("aiAssistant.conversationList.archived")})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:Yt(j.lastMessageAt)})]}),u&&e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{type:"button",className:"text-muted-foreground hover:text-foreground p-1.5 rounded-md hover:bg-accent/50 transition-colors",onClick:C=>{C.stopPropagation(),j.isArchived?(i(u,j.id,{isArchived:!1}),ke.success(a("aiAssistant.conversationList.restoredSuccess"))):(i(u,j.id,{isArchived:!0}),ke.success(a("aiAssistant.conversationList.archivedSuccess")))},"aria-label":j.isArchived?a("aiAssistant.conversationList.restoreConversation"):a("aiAssistant.conversationList.archiveConversation"),children:e.jsx(su,{className:"w-4 h-4"})}),e.jsxs(ln,{children:[e.jsx(cn,{asChild:!0,children:e.jsx("button",{type:"button",className:"text-muted-foreground hover:text-foreground p-1.5 rounded-md hover:bg-accent/50 transition-colors",onClick:C=>{C.stopPropagation()},onMouseDown:C=>{C.stopPropagation()},onKeyDown:C=>{C.stopPropagation()},"aria-label":a("aiAssistant.conversationList.deleteConversation"),children:e.jsx(jt,{className:"w-4 h-4"})})}),e.jsxs(dn,{align:"end",sideOffset:6,className:"p-2 w-56",onClick:C=>C.stopPropagation(),onMouseDown:C=>C.stopPropagation(),children:[e.jsx("div",{className:"text-sm mb-2",children:a("aiAssistant.conversationList.deleteConfirm")}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(Do,{asChild:!0,children:e.jsx("button",{type:"button",className:"h-8 px-3 rounded-md text-sm border hover:bg-accent",onClick:C=>{C.stopPropagation()},children:a("common.cancel")})}),e.jsx(Do,{asChild:!0,children:e.jsx("button",{type:"button",className:"h-8 px-3 rounded-md text-sm bg-destructive text-destructive-foreground hover:bg-destructive/90",onClick:C=>{C.stopPropagation(),o(u,j.id).then(()=>ke.success(a("aiAssistant.conversationList.deletedSuccess"))).catch(()=>ke.error(a("aiAssistant.conversationList.deleteFailed")))},children:a("common.delete")})})]})]})]})]})]})},j.id)),c&&u&&e.jsx("div",{className:"p-4 border-t",children:e.jsx("button",{type:"button",className:"w-full h-9 px-4 rounded-lg text-sm border bg-background hover:bg-accent disabled:opacity-60 transition-colors",disabled:d,onClick:()=>{l(u)},children:a(d?"common.loading":"aiAssistant.conversationList.loadMore")})})]})})]})}function sp(s){const t=new Map;for(const n of s)n?.id&&t.set(n.id,n);return Array.from(t.values())}class np{dataContainer=Cl({messageByConversation:{}});requestLoadInitialMessages$=new Ki(1);handleRequestWorkflow$=this.requestLoadInitialMessages$.pipe(xa((t,n)=>t===n),mm(t=>console.log("[ConversationMessageService] handleRequestWorkflow$",t)),Qs(t=>!this.dataContainer.get().messageByConversation[t]),Yi(t=>gm(this.loadInitialMessages({conversationId:t}))),hm({bufferSize:1,refCount:!1}));connectToRequestWorkflow=()=>{const t=this.handleRequestWorkflow$.subscribe();return()=>t.unsubscribe()};getConversationStateControl(t){const n=cs(this.dataContainer,`messageByConversation.${t}`),{get:a,namespaces:{messages:{set:r},loading:{set:o},loadingMore:{set:i},hasMore:{set:l},subscription:{set:c}}}=n,d=()=>{a()||n.set({messages:[],loading:!1,loadingMore:!1,hasMore:!0})},u=x=>r(sp(x));return{getState:a,ensureInit:d,setMessages:u,setLoading:o,setLoadingMore:i,setHasMore:l,setSubscription:c,mergeAndSet:x=>{const f=a()?.messages||[];u([...f,...x])},upsert:x=>{const f=a()?.messages||[],p=f.findIndex(b=>b.id===x.id);u(p===-1?[...f,x]:[...f.slice(0,p),x,...f.slice(p+1)])}}}loadInitialMessages=async({conversationId:t})=>{const{userId:n}=O.getState();if(!n||!t)return;const{ensureInit:a,setLoading:r,setMessages:o,setSubscription:i}=this.getConversationStateControl(t);a(),r(!0);try{const l=Ue(n)?await Ke.getMessages(n,t):await it.getMessages(n,t);o(l);const c=this.subscribeToMessages({userId:n,conversationId:t});i({unsubscribe:c})}finally{r(!1)}};subscribeToMessages=({userId:t,conversationId:n})=>{const{setMessages:a}=this.getConversationStateControl(n);return Ue(t)?Ke.subscribeToMessages(t,n,r=>a(r||[])):it.subscribeToMessages(t,n,r=>a(r||[]))};async createMessage(t,n,a){Ue(t)?await Ke.createMessage(t,n,a):await it.createMessage(t,n,a)}async updateMessage(t,n,a){Ue(t)?await Ke.updateMessage(t,n,a.id,a):await it.updateMessage(t,n,a.id,a)}}const Ws=new np;function ap(s){const{userId:t}=O(),n=m.useMemo(()=>cs(Ws.dataContainer,`messageByConversation.${s}`),[s]),{value:a}=kl(n);m.useEffect(()=>Ws.connectToRequestWorkflow(),[]),m.useEffect(()=>{!t||!s||Ws.requestLoadInitialMessages$.next(s)},[t,s]);const r=async i=>{t&&await Ws.createMessage(t,s,i)},o=async i=>{t&&await Ws.updateMessage(t,s,i)};return{messages:a?.messages||[],loading:a?.loading||!1,createMessage:r,updateMessage:o}}const zt="https://stillroot-ai-proxy.agentverse.cc",rp="https://api-gateway.stillroot.app",Ln=`${rp.replace(/\/+$/,"")}/openai/v1`,xs=[{id:"qwen-plus",name:"Qwen Plus",description:"Alibaba Cloud Qwen model via DashScope",apiKey:Ln?"proxy":"",model:"qwen-plus-latest",apiUrl:Ln||"https://dashscope.aliyuncs.com/compatible-mode/v1",temperature:.7,maxTokens:4e3},{id:"qwen3-max",name:"Qwen3 Max",description:"Alibaba Cloud Qwen3 Max model via DashScope",apiKey:Ln?"proxy":"",model:"qwen3-max",apiUrl:Ln||"https://dashscope.aliyuncs.com/compatible-mode/v1",temperature:.7,maxTokens:4e3,isDefault:!0},{id:"cloudflare-worker-openrouter-google-gemini-2.5-pro",name:"Gemini 2.5 Pro",description:"Google Gemini 2.5 Pro via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/google/gemini-2.5-pro",apiUrl:zt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-gemini-2.5-flash",name:"Gemini 2.5 Flash",description:"Google Gemini 2.5 Flash via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/google/gemini-2.5-flash",apiUrl:zt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-grok-4-fast",name:"Grok 4 Fast",description:"Grok 4 Fast via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/x-ai/grok-4-fast:free",apiUrl:zt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-grok-code-fast-1",name:"Grok Code Fast 1",description:"Grok Code Fast 1 via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/x-ai/grok-code-fast-1",apiUrl:zt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-openai-gpt-5-codex",name:"GPT 5 Codex",description:"GPT 5 Codex via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/openai/gpt-5-codex",apiUrl:zt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-openai-gpt-5-chat",name:"GPT 5 Chat",description:"GPT 5 Chat via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/openai/gpt-5-chat",apiUrl:zt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-claude-sonnet-4.5",name:"Claude Sonnet 4.5",description:"Claude Sonnet 4.5 via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/anthropic/claude-sonnet-4.5",apiUrl:zt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-glm-4.6",name:"GLM 4.6",description:"GLM 4.5 via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/z-ai/glm-4.6",apiUrl:zt,temperature:.7,maxTokens:4e3,isDefault:!1}],xr=()=>xs.find(s=>s.isDefault)||xs[0],Vr=s=>xs.find(t=>t.id===s);function dt({...s}){return e.jsx(ad,{"data-slot":"dropdown-menu",...s})}function ut({...s}){return e.jsx(rd,{"data-slot":"dropdown-menu-trigger",...s})}function mt({className:s,sideOffset:t=4,...n}){return e.jsx(ki,{children:e.jsx(od,{"data-slot":"dropdown-menu-content",sideOffset:t,className:E("bg-popover/95 backdrop-blur-xl text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-xl shadow-[0_0_0_1px_rgba(0,0,0,0.05),0_10px_15px_-3px_rgba(0,0,0,0.1),0_4px_6px_-2px_rgba(0,0,0,0.05)] dark:shadow-[0_0_0_1px_rgba(255,255,255,0.1),0_10px_15px_-3px_rgba(0,0,0,0.3),0_4px_6px_-2px_rgba(0,0,0,0.1)]","data-[state=open]:duration-50 data-[state=closed]:duration-50",s),...n})})}function op({...s}){return e.jsx(fd,{"data-slot":"dropdown-menu-group",...s})}function Lt({className:s,inset:t,variant:n="default",...a}){return e.jsx(cd,{"data-slot":"dropdown-menu-item","data-inset":t,"data-variant":n,className:E("focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",s),...a})}function _o({...s}){return e.jsx(md,{"data-slot":"dropdown-menu-radio-group",...s})}function ip({className:s,children:t,...n}){return e.jsxs(gd,{"data-slot":"dropdown-menu-radio-item",className:E("focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",s),...n,children:[e.jsx("span",{className:"pointer-events-none absolute left-2 flex size-3.5 items-center justify-center",children:e.jsx(pd,{children:e.jsx(nu,{className:"size-2 fill-current"})})}),t]})}function Wr({className:s,inset:t,...n}){return e.jsx(id,{"data-slot":"dropdown-menu-label","data-inset":t,className:E("px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",s),...n})}function Dt({className:s,...t}){return e.jsx(ld,{"data-slot":"dropdown-menu-separator",className:E("bg-border -mx-1 my-1 h-px",s),...t})}function Po({...s}){return e.jsx(dd,{"data-slot":"dropdown-menu-sub",...s})}function lp({className:s,inset:t,children:n,...a}){return e.jsxs(hd,{"data-slot":"dropdown-menu-sub-trigger","data-inset":t,className:E("focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",s),...a,children:[n,e.jsx(ha,{className:"ml-auto size-4"})]})}function Oo({className:s,sideOffset:t=8,...n}){return e.jsx(ki,{children:e.jsx(ud,{"data-slot":"dropdown-menu-sub-content",sideOffset:t,className:E("bg-popover/95 backdrop-blur-xl text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[10rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-xl shadow-[0_0_0_1px_rgba(0,0,0,0.05),0_10px_15px_-3px_rgba(0,0,0,0.1),0_4px_6px_-2px_rgba(0,0,0,0.05)] dark:shadow-[0_0_0_1px_rgba(255,255,255,0.1),0_10px_15px_-3px_rgba(0,0,0,0.3),0_4px_6px_-2px_rgba(0,0,0,0.1)]","data-[state=open]:duration-50 data-[state=closed]:duration-50","p-1",s),...n})})}const cp=s=>s.includes("qwen")?"default":s.includes("gemini")?"secondary":s.includes("grok")?"outline":s.includes("claude")?"secondary":s.includes("glm")?"outline":"default";function dp({selectedModelId:s,onModelChange:t,className:n=""}){const{t:a}=L(),[r,o]=m.useState(!1),i=s?Vr(s):xs[0],l=c=>{t?.(c.id),o(!1)};return e.jsx("div",{className:`flex items-center ${n}`,children:e.jsxs(dt,{open:r,onOpenChange:o,children:[e.jsx(ut,{asChild:!0,children:e.jsxs(M,{variant:"ghost",size:"sm",className:"h-8 px-3 gap-2 bg-transparent hover:bg-accent/50 text-muted-foreground hover:text-foreground",children:[e.jsx("span",{className:"text-sm font-medium",children:i?.name||a("aiAssistant.modelSelector.selectModel")}),e.jsx(st,{className:"w-3 h-3 opacity-50"})]})}),e.jsxs(mt,{align:"start",className:"w-64 p-1",side:"top",children:[e.jsx(Wr,{className:"text-xs text-muted-foreground px-2 py-1.5",children:a("aiAssistant.modelSelector.chooseModel")}),e.jsx(Dt,{}),xs.map(c=>e.jsxs(Lt,{onClick:()=>l(c),className:"flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-accent/50 rounded-md",children:[e.jsx("span",{className:"text-sm font-medium text-foreground",children:c.name}),e.jsxs("div",{className:"flex items-center gap-1",children:[c.isDefault&&e.jsx(He,{variant:"secondary",className:"text-xs px-1.5 py-0.5",children:a("aiAssistant.modelSelector.default")}),s===c.id&&e.jsx(He,{variant:cp(c.id),className:"text-xs px-1.5 py-0.5",children:a("aiAssistant.modelSelector.selected")})]})]},c.id))]})]})})}const up=s=>{const{messages:t,assistantMessageId:n}=s,a=t.filter(i=>i.role==="assistant"&&!!i.toolCalls).map(i=>i.toolCalls).flat(),r=t.filter(i=>i.role==="assistant").map(i=>i.content).join(`
`),o=t.filter(i=>i.role==="tool");return[{id:n,role:"assistant",content:r,toolCalls:a.length>0?a:void 0},...o]},mp=(s,t,n)=>{const{id:a,role:r}=s,o=[],i=`${a}-${n}`;if(t.type==="text")o.push({id:i,role:r,content:t.text});else if(t.type==="tool-invocation"){const l={id:`${i}-tool-call`,role:"assistant",content:"",toolCalls:[{id:t.toolInvocation.toolCallId,type:"function",function:{name:t.toolInvocation.toolName,arguments:t.toolInvocation.args}}]};if([et.CALL,et.PARTIAL_CALL].includes(t.toolInvocation.status))o.push(l);else{const c={id:`${i}-tool-result`,role:"tool",toolCallId:t.toolInvocation.toolCallId,content:JSON.stringify({result:t.toolInvocation.result,error:t.toolInvocation.error,cancelled:t.toolInvocation.status===et.CANCELLED})};o.push(l,c)}}return r==="assistant"?up({messages:o,assistantMessageId:a}):o},hp=s=>s.filter(t=>t.role!=="data").map(t=>t.parts.map((n,a)=>mp(t,n,a)).flat()).flat();class gp{constructor(){}encode(t){return this.encodeSSE(t)}encodeSSE(t){return`data: ${JSON.stringify(t)}

`}}class Vl{constructor(t){this.encoder=t}async*handle(t,n){if(!n.isMessageStarted){const r={type:ct.TEXT_START,messageId:n.messageId};yield this.encoder.encode(r),n.isMessageStarted=!0}const a=t.choices[0].delta.content;if(a){n.fullResponse+=a;const r={type:ct.TEXT_DELTA,messageId:n.messageId,delta:a};yield this.encoder.encode(r)}}async*finalize(t){if(t.isMessageStarted){const n={type:ct.TEXT_END,messageId:t.messageId};yield this.encoder.encode(n)}}}class pp{constructor(t){this.encoder=t}async*handle(t,n){const a=t.choices[0].delta.tool_calls?.[0];if(a){if(!n.isToolCallStarted){n.toolCallId=a.id??"",n.toolCallName=a.function?.name??"",n.isToolCallStarted=!0;const r={type:ct.TOOL_CALL_START,toolCallId:n.toolCallId,toolName:n.toolCallName};yield this.encoder.encode(r)}if(a.function?.arguments){n.toolCallArgs+=a.function.arguments;const r={type:ct.TOOL_CALL_ARGS_DELTA,toolCallId:n.toolCallId,argsDelta:a.function.arguments};yield this.encoder.encode(r)}}}async*finalize(t){if(t.isToolCallStarted){const n={type:ct.TOOL_CALL_END,toolCallId:t.toolCallId};yield this.encoder.encode(n)}}}class fp{constructor(t){this.encoder=t,this.context={messageId:fs(),toolCallId:"",isMessageStarted:!1,isToolCallStarted:!1,fullResponse:"",toolCallArgs:"",toolCallName:"",getSnapshot:()=>({last_response:this.context.fullResponse,last_tool_call:this.context.isToolCallStarted?{name:this.context.toolCallName,arguments:this.context.toolCallArgs}:null,usage:{prompt_tokens:0,completion_tokens:0,total_tokens:0}})}}handlers=new Map;context;addHandler(t,n){this.handlers.set(t,n)}async*process(t){try{for await(const n of t){const a=this.getChunkType(n),r=this.handlers.get(a);r&&(yield*r.handle(n,this.context))}for(const n of this.handlers.values())yield*n.finalize(this.context)}catch(n){yield*this.handleError(n)}}getChunkType(t){return t.choices[0].delta.tool_calls?"tool":t.choices[0].delta.content?"text":"unknown"}async*handleError(t){const n=new Vl(this.encoder);yield*n.handle({id:"",created:0,model:"",object:"chat.completion.chunk",choices:[{delta:{content:`Error: ${t.message}`},finish_reason:"stop",index:0}],usage:{prompt_tokens:0,completion_tokens:0,total_tokens:0}},this.context),yield*n.finalize(this.context);const a={type:ct.RUN_ERROR,error:t.message};yield this.encoder.encode(a)}}class $o{constructor(t){this.config=t,this.client=new Qi({apiKey:t.apiKey,baseURL:t.baseURL,dangerouslyAllowBrowser:!0})}client;currentStream=null;convertToolsToOpenAIFormat(t){return t.map(n=>({type:"function",function:{name:n.name,description:n.description,parameters:n.parameters}}))}convertMessagesToOpenAIFormat(t){return hp(t).map(a=>a.role==="tool"&&"toolCallId"in a?{role:a.role,content:a.content,tool_call_id:a.toolCallId}:a.role==="developer"||a.role==="system"||a.role==="user"?{role:a.role,content:a.content,id:a.id}:{role:a.role,content:a.content,id:a.id,tool_calls:"toolCalls"in a?a.toolCalls?.map(r=>({id:r.id,type:"function",function:{name:r.function.name,arguments:r.function.arguments}})):void 0})}addContextToMessages(t,n){return[{role:"system",content:n.map(r=>`${r.description}: ${r.value}`).join(`
`)},...t]}async*run(t,n){const a=new gp,r={type:ct.RUN_STARTED,threadId:t.threadId};yield a.encode(r);try{let i=t.messages?this.convertMessagesToOpenAIFormat(t.messages):[];t.context&&(i=this.addContextToMessages(i,t.context));const l=t.tools?this.convertToolsToOpenAIFormat(t.tools):[],c=await this.client.chat.completions.create({model:this.config.model,messages:i,stream:!0,tools:l.length>0?l:void 0});this.currentStream=c;const d=new fp(a);d.addHandler("text",new Vl(a)),d.addHandler("tool",new pp(a)),yield*d.process(c)}catch(i){yield*this.handleError(i,a)}const o={type:ct.RUN_FINISHED,threadId:t.threadId};yield a.encode(o)}abort(){this.currentStream&&this.currentStream.controller.abort()}async*handleError(t,n){const a={type:ct.RUN_ERROR,error:t.message};console.error("[OpenAIAgent][handleError]:",t),yield n.encode(a)}}function xp(){return s=>s.pipe(Ji(t=>new ar(n=>{const a=t.split(/\r?\n/);for(const r of a){if(!r.startsWith("data:"))continue;const o=r.slice(5).trim();if(!(!o||o==="[DONE]"))try{const i=JSON.parse(o);n.next(i)}catch{}}n.complete()})))}const Bo=5e4;class Dn{openaiAgent;currentConfig;contextCharLimit;constructor(t){this.currentConfig={apiKey:t?.apiKey||""||"",model:t?.model||"qwen3-max-preview",temperature:t?.temperature||.7,maxTokens:t?.maxTokens||1e3,baseURL:t?.baseURL||"https://dashscope.aliyuncs.com/compatible-mode/v1"};const n=Bo;if(this.contextCharLimit=Number.isFinite(n)&&n>0?n:Bo,!this.currentConfig.apiKey)throw new Error("API key is required. Please set the appropriate API key environment variable.");this.openaiAgent=new $o(this.currentConfig)}abortRun(){this.openaiAgent.abort()}run(t){const n=this.trimInputByCharLimit(t,this.contextCharLimit),a=r=>new ar(o=>{(async()=>{try{for await(const i of r)o.next(i);o.complete()}catch(i){o.error(i)}})()});return new ar(r=>((async()=>{try{const l=this.openaiAgent.run(n,"application/json");a(l).pipe(xp(),Qs(c=>!!c&&!!c.type),pm(c=>(console.error("ðŸ”” [ExperimentalInBrowserAgent][run] error:",c),r.next({type:ct.RUN_ERROR}),r.error(c),[]))).subscribe({next:c=>{r.next(c)},error:c=>r.error(c),complete:()=>{r.complete()}})}catch(i){console.error("ðŸ”” [ExperimentalInBrowserAgent][run] error:",i),r.next({type:ct.RUN_ERROR}),r.error(i)}})(),()=>{}))}setConfig(t){this.currentConfig={...this.currentConfig,...t};const n=t?.contextCharLimit;if(typeof n=="number"&&Number.isFinite(n)&&n>0&&(this.contextCharLimit=n),!this.currentConfig.apiKey)throw new Error("API key is required. Please set the appropriate API key environment variable.");this.openaiAgent=new $o(this.currentConfig)}getConfig(){return{...this.currentConfig,hasApiKey:!!this.currentConfig.apiKey,contextCharLimit:this.contextCharLimit}}trimInputByCharLimit(t,n){try{const a=t.messages||[],r=f=>f.type==="text"&&typeof f.text=="string",o=f=>f.type==="tool-invocation"&&!!f.toolInvocation,i=f=>{if(r(f))return f.text.length;if(o(f)){const p=f.toolInvocation;let b=0;return b+=p.toolName?p.toolName.length:0,typeof p.args=="string"&&(b+=p.args.length),p.toolCallId&&(b+=p.toolCallId.length),p.result!==void 0&&(b+=typeof p.result=="string"?p.result.length:JSON.stringify(p.result).length),p.error!==void 0&&(b+=typeof p.error=="string"?p.error.length:JSON.stringify(p.error).length),b}try{return JSON.stringify(f).length}catch{return 0}},l=f=>(f.parts||[]).reduce((p,b)=>p+i(b),0),c=a.filter(f=>f.role==="user"||f.role==="assistant"),d=c.reduce((f,p)=>f+l(p),0);if(d<=n)return t;const u=[...c],h=new Set;let g=d;for(;g>n&&u.length>0;){const f=u.shift();h.add(f.id),g-=l(f)}const x=a.filter(f=>!h.has(f.id));return{...t,messages:x}}catch(a){return console.warn("trimInputByCharLimit failed, fallback to original input:",a),t}}}function Ca(s){try{if(s.parsedArgs)return s.parsedArgs;const t=s.args;return typeof t=="string"?JSON.parse(t):t&&typeof t=="object"?t:null}catch{return null}}const bp={default:"bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800",success:"bg-green-50 dark:bg-green-950 border-green-200 dark:border-green-900",warning:"bg-yellow-50 dark:bg-yellow-950 border-yellow-200 dark:border-yellow-900",error:"bg-red-50 dark:bg-red-950 border-red-200 dark:border-red-900"},vp={default:"text-gray-700 dark:text-gray-300",success:"text-gray-700 dark:text-gray-200",warning:"text-gray-700 dark:text-gray-200",error:"text-gray-600 dark:text-gray-300"};function br({content:s,variant:t="default",maxHeight:n,showScrollbar:a=!0,className:r,placeholder:o="Loading content..."}){const i=s||o;return e.jsx("div",{className:E("rounded-md border p-3",bp[t],a&&"overflow-y-auto",r),style:n?{maxHeight:n}:void 0,children:e.jsx("p",{className:E("text-sm whitespace-pre-wrap",vp[t]),children:i})})}const wp=Mr("relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",{variants:{variant:{default:"bg-card text-card-foreground",destructive:"text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90"}},defaultVariants:{variant:"default"}});function ta({className:s,variant:t,...n}){return e.jsx("div",{"data-slot":"alert",role:"alert",className:E(wp({variant:t}),s),...n})}function sa({className:s,...t}){return e.jsx("div",{"data-slot":"alert-description",className:E("text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",s),...t})}function na({error:s,fallbackMessage:t="An error occurred",variant:n="text",className:a}){const r=typeof s=="string"?s:s instanceof Error?s.message:t;return n==="alert"?e.jsx(ta,{variant:"destructive",className:a,children:e.jsx(sa,{children:r})}):e.jsx("div",{className:E("text-red-700 dark:text-red-300 text-sm",a),children:r})}function Wl({icon:s,message:t,className:n}){return e.jsxs("div",{className:E("flex items-center gap-2 text-gray-500 dark:text-gray-400",n),children:[e.jsx(s,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t})]})}const yp={sm:"gap-2",md:"gap-4",lg:"gap-6"},jp={default:"text-gray-500 dark:text-gray-400",mono:"font-mono text-gray-500 dark:text-gray-400",highlight:"text-gray-700 dark:text-gray-300 font-medium"};function Np({items:s,className:t,gap:n="md"}){return s.length===0?null:e.jsx("div",{className:E("flex items-center",yp[n],t),children:s.map((a,r)=>e.jsx("div",{className:"flex items-center gap-1",children:a.variant==="mono"?e.jsx(He,{variant:"outline",className:"text-xs font-mono",children:a.value}):e.jsx("span",{className:E("text-xs",jp[a.variant||"default"]),children:a.value})},r))})}function Uo({original:s,updated:t,showLabels:n=!0,className:a}){const{t:r}=L();return e.jsxs("div",{className:E("space-y-3",a),children:[n&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:s.label||r("agentTools.comparisonLayout.original")}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400","aria-hidden":"true",children:r("agentTools.comparisonLayout.arrowSeparator")}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:t.label||r("agentTools.comparisonLayout.updated")})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(br,{content:s.content,variant:"default",className:"max-h-48",showScrollbar:!0,placeholder:s.placeholder||r("agentTools.comparisonLayout.loadingOriginal")}),e.jsx(br,{content:t.content,variant:"success",className:"max-h-48",showScrollbar:!0,placeholder:t.placeholder||r("agentTools.comparisonLayout.loadingUpdated")})]})]})}function Cp({icon:s,title:t,status:n,statusText:a,hasDetails:r=!1,isExpanded:o=!1,onToggleExpanded:i}){const c={loading:{icon:e.jsx(Mt,{className:"h-4 w-4 animate-spin text-blue-600"}),color:"text-blue-600"},success:{icon:e.jsx(_t,{className:"h-4 w-4 text-green-600"}),color:"text-green-600"},error:{icon:e.jsx(Xs,{className:"h-4 w-4 text-red-600"}),color:"text-red-600"},ready:{icon:e.jsx(pa,{className:"h-4 w-4 text-gray-500"}),color:"text-gray-500"}}[n];return e.jsxs("div",{className:"px-2 flex gap-2 items-center overflow-hidden",children:[e.jsx("div",{className:"flex items-center gap-2 flex-shrink-0",children:s}),e.jsx("div",{className:"overflow-y-auto flex-shrink-0",children:t}),e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:c.icon}),e.jsx("span",{className:`text-sm font-medium truncate overflow-hidden ${c.color}`,children:a})]}),e.jsx("div",{className:"flex-1 w-[9999px]"}),r&&e.jsx(M,{variant:"ghost",size:"sm",onClick:i,className:"h-8 w-8 p-0 hover:bg-gray-100 flex-shrink-0","aria-label":o?"Collapse details":"Expand details",children:o?e.jsx(st,{className:"h-4 w-4"}):e.jsx(ha,{className:"h-4 w-4"})})]})}function kp({children:s,maxHeight:t="400px",isExpanded:n=!1,scrollable:a=!0}){return n?e.jsx("div",{className:"p-4 w-full",children:e.jsx("div",{className:a?"overflow-y-auto w-full":"w-full",style:a?{maxHeight:t}:void 0,children:s})}):null}function Sp({children:s,header:t,content:n,headerCardClassName:a="border-gray-200 dark:border-gray-800",contentCardClassName:r="border-gray-200 dark:border-gray-800 mt-2"}){return e.jsxs("div",{className:"w-full flex flex-col","data-echo-tool":!0,children:[e.jsx("div",{className:"flex w-full overflow-hidden",children:e.jsx(on,{className:E(a,"overflow-hidden py-2 px-2"),children:e.jsx(Cp,{...t})})}),n&&n.isExpanded&&e.jsx("div",{className:"w-full",children:e.jsx(on,{className:r,children:e.jsx(kp,{...n})})}),s&&e.jsx("div",{className:"w-full mt-2",children:s})]})}function St({icon:s,title:t,status:n,statusText:a,children:r,maxHeight:o="400px",defaultExpanded:i,expandable:l,forceExpanded:c,contentScrollable:d,headerCardClassName:u,contentCardClassName:h}){const g=!!r,x=l!==!1&&g&&!c,[f,p]=m.useState(i??!1),b=c?!0:f,v=m.useMemo(()=>({icon:s,title:t,status:n,statusText:a,hasDetails:x,isExpanded:b,onToggleExpanded:x?()=>p(w=>!w):void 0}),[s,t,n,a,x,b]),y=g?{children:r,maxHeight:o,isExpanded:b,scrollable:d!==!1}:void 0;return e.jsx("div",{className:"w-full","data-echo-tool":!0,children:e.jsx(Sp,{header:v,content:y,headerCardClassName:u,contentCardClassName:h})})}function ql(s){try{if(s.parsedArgs)return s.parsedArgs;const t=s.args;return typeof t=="string"?JSON.parse(t):t&&typeof t=="object"?t:null}catch{return null}}function qr({invocation:s,icon:t,title:n,loadingText:a="Loading...",loadingIcon:r,successIcon:o,errorIcon:i,readyIcon:l,successStatusText:c,errorStatusText:d,readyStatusText:u="Ready",contentScrollable:h=!0,headerCardClassName:g,contentCardClassName:x,children:f}){const p=ql(s)||{};if(s.status===et.PARTIAL_CALL)return e.jsx(St,{icon:r||t,title:n,status:"loading",statusText:a,contentScrollable:h,headerCardClassName:g||"border-blue-200 dark:border-blue-800",contentCardClassName:x||"border-gray-200 dark:border-gray-800 mt-2",children:f(p)});if(s.status===et.CALL)return e.jsx(St,{icon:r||t,title:n,status:"loading",statusText:a,contentScrollable:h,headerCardClassName:g||"border-blue-200 dark:border-blue-800",contentCardClassName:x||"border-gray-200 dark:border-gray-800 mt-2",children:f(p)});if(s.status===et.RESULT){const b=s.result;return e.jsx(St,{icon:o||t,title:n,status:"success",statusText:c?c(b):"Success",contentScrollable:h,headerCardClassName:g||"border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950",contentCardClassName:x||"border-gray-200 dark:border-gray-800 mt-2",children:f(p,b)})}if(s.status===et.ERROR){const b=s.error;return e.jsx(St,{icon:i||t,title:n,status:"error",statusText:d?d(b):"Error occurred",contentScrollable:h,headerCardClassName:g||"border-red-200 dark:border-red-800",contentCardClassName:x||"border-red-200 dark:border-red-800 mt-2",children:f(p,void 0,b)})}return e.jsx(St,{icon:l||t,title:n,status:"ready",statusText:u,contentScrollable:h,headerCardClassName:g||"border-gray-200 dark:border-gray-800",contentCardClassName:x||"border-gray-200 dark:border-gray-800 mt-2",children:f(p)})}function Fo({confirmLabel:s,cancelLabel:t="Cancel",onConfirm:n,onCancel:a,isLoading:r,confirmIcon:o,loadingLabel:i,variant:l="default"}){return e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(M,{onClick:n,disabled:r,className:"flex-1",variant:l,children:r?e.jsxs(e.Fragment,{children:[e.jsx(Mt,{className:"h-4 w-4 mr-2 animate-spin"}),i||`${s}...`]}):e.jsxs(e.Fragment,{children:[o,o?e.jsx("span",{className:"ml-2",children:s}):s]})}),e.jsx(M,{variant:"outline",onClick:a,disabled:r,children:t})]})}function Mp({invocation:s,onResult:t,confirm:n}){const[a,r]=m.useState(!1),[o,i]=m.useState(null);return{isLoading:a,error:o,handleConfirm:async()=>{r(!0),i(null);try{const d=await n();t({toolCallId:s.toolCallId,result:d,status:et.RESULT})}catch(d){const u=d instanceof Error?d.message:"Operation failed";i(u),r(!1)}},handleCancel:()=>{t({toolCallId:s.toolCallId,status:et.CANCELLED,cancelled:!0})}}}function Kr(s){const{invocation:t,onResult:n,icon:a,title:r,loadingText:o="Loading...",callStatusText:i,preview:l,confirm:c,confirmLabel:d,confirmIcon:u,confirmVariant:h,resultStatusText:g,resultContent:x,cancelStatusText:f,contentScrollable:p,stickyFooter:b=!0}=s,v=ql(t)||{},{isLoading:y,error:w,handleConfirm:N,handleCancel:S}=Mp({invocation:t,onResult:n,confirm:c});if(t.status===et.PARTIAL_CALL)return e.jsx(St,{icon:a,title:r,status:"loading",statusText:o,contentScrollable:p,headerCardClassName:"border-blue-200 dark:border-blue-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:l(v)});if(t.status===et.CALL)return e.jsx(St,{icon:a,title:r,status:"ready",statusText:i,forceExpanded:!0,contentScrollable:p,headerCardClassName:"border-amber-200 dark:border-amber-800",children:b?e.jsxs("div",{className:"relative w-full",children:[e.jsxs("div",{className:"space-y-4 w-full pb-16",children:[l(v),w&&e.jsx(ta,{variant:"destructive",children:e.jsx(sa,{children:w})})]}),e.jsx("div",{className:"sticky bottom-0 w-full bg-background border-t dark:border-gray-800 pt-3 pb-3",children:e.jsx(Fo,{confirmLabel:d,loadingLabel:`${d}...`,onConfirm:N,onCancel:S,isLoading:y,confirmIcon:u,variant:h})})]}):e.jsxs("div",{className:"space-y-4 w-full",children:[l(v),w&&e.jsx(ta,{variant:"destructive",children:e.jsx(sa,{children:w})}),e.jsx(Fo,{confirmLabel:d,loadingLabel:`${d}...`,onConfirm:N,onCancel:S,isLoading:y,confirmIcon:u,variant:h})]})});if(t.status===et.RESULT){const j=t.result;return e.jsx(St,{icon:a,title:r,status:"success",statusText:g(j),contentScrollable:p,headerCardClassName:"border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:x(v,j)})}return t.status===et.CANCELLED?e.jsx(St,{icon:a,title:r,status:"ready",statusText:f||"Cancelled",contentScrollable:p,headerCardClassName:"border-gray-200 dark:border-gray-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:l(v)}):e.jsx(St,{icon:a,title:r,status:"ready",statusText:"",headerCardClassName:"border-gray-200 dark:border-gray-800"})}function un({content:s,showMetadata:t=!1,metadata:n,variant:a="preview",maxHeight:r,className:o,placeholder:i}){const l=[];t&&n&&(n.noteId&&l.push({label:"ID",value:n.noteId,variant:"mono"}),n.timestamp&&l.push({label:"Time",value:n.timestamp,variant:"default"}),n.contentLength&&l.push({label:"Length",value:`${n.contentLength} chars`,variant:"default"}));const c=a==="detail"?"success":a==="error"?"error":"default",d=a==="comparison";return e.jsxs("div",{className:o,children:[t&&l.length>0&&e.jsx(Np,{items:l,className:"mb-3"}),e.jsx(br,{content:s,variant:c,className:d?"max-h-48":void 0,maxHeight:d?void 0:r,showScrollbar:a==="comparison",placeholder:i})]})}function Ip({noteId:s,content:t,contentLength:n,timestampReadable:a,showIdPrefix:r=!0,idPrefixLength:o=8,showCharCount:i=!0,charCountThreshold:l=60,className:c}){const{t:d}=L();return e.jsxs("div",{className:E("p-3 bg-gray-50 dark:bg-gray-900 rounded-md border dark:border-gray-800",c),children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pn,{className:"w-3 h-3 text-gray-400 dark:text-gray-500"}),r&&e.jsxs(He,{variant:"outline",className:"text-xs font-mono",children:[s.substring(0,o),"..."]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx(pa,{className:"w-3 h-3"}),e.jsx("span",{children:a})]})]}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap",children:t}),i&&n>l&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:d("agentTools.noteList.charactersTotal",{count:n})})]})}function Tp(s,t){const[n,a]=Ts.useState("");return Ts.useEffect(()=>{if(!(!s||!t))try{const o=X.dataContainer.get().messageByChannel[t]?.messages.find(i=>i.id===s);o&&a(o.content)}catch(r){console.error("Failed to fetch note content:",r)}},[s,t]),n}function Ep({invocation:s,onResult:t}){const{t:n}=L(),a=Ca(s),r=a?.noteId||"",o=a?.content||"",i=a?.channelId||"",l=Tp(r,i);return e.jsx(Kr,{invocation:s,onResult:t,icon:e.jsx(Ar,{className:"h-5 w-5 text-amber-600 dark:text-amber-400"}),title:n("agentTools.updateNote.title"),loadingText:n("agentTools.updateNote.preparing"),callStatusText:n("agentTools.updateNote.ready"),contentScrollable:!1,stickyFooter:!1,preview:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(He,{variant:"outline",className:"font-mono text-xs",children:r||n("common.loading")})}),e.jsx(Uo,{original:{content:l||"",label:n("agentTools.updateNote.original"),placeholder:n("agentTools.updateNote.loadingOriginal")},updated:{content:o,label:n("agentTools.updateNote.updated"),placeholder:n("agentTools.updateNote.loadingUpdated")},showLabels:!0})]}),confirm:async()=>(await X.updateMessage({messageId:r,channelId:i,updates:{content:o},userId:O.getState().userId}),{status:"updated",message:n("agentTools.updateNote.success")}),confirmLabel:n("agentTools.updateNote.confirm"),confirmIcon:e.jsx(_t,{className:"h-4 w-4"}),resultStatusText:()=>n("agentTools.updateNote.resultSuccess"),resultContent:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(He,{variant:"outline",className:"font-mono text-xs",children:r})}),e.jsx(Uo,{original:{content:l||"",label:n("agentTools.updateNote.original"),placeholder:n("agentTools.updateNote.originalContent")},updated:{content:o,label:n("agentTools.updateNote.updated"),placeholder:n("agentTools.updateNote.updatedContent")},showLabels:!0})]}),cancelStatusText:n("agentTools.updateNote.cancelled")})}function Ap({invocation:s,onResult:t}){const{t:n}=L(),[a,r]=m.useState(""),o=Ca(s),i=o?.noteId||"",l=o?.channelId||"";return Ts.useEffect(()=>{try{const d=X.dataContainer.get().messageByChannel[l]?.messages.find(u=>u.id===i);d&&r(d.content)}catch(c){console.error("Failed to fetch note content:",c)}},[i,l]),e.jsx(Kr,{invocation:s,onResult:t,icon:e.jsx(jt,{className:"h-5 w-5 text-amber-600 dark:text-amber-400"}),title:n("agentTools.deleteNote.title"),loadingText:n("agentTools.deleteNote.preparing"),callStatusText:n("agentTools.deleteNote.ready"),preview:()=>e.jsxs("div",{className:"space-y-4 w-full",children:[e.jsx(ta,{variant:"destructive",children:e.jsxs(sa,{children:[e.jsx("strong",{children:n("agentTools.deleteNote.warning")})," ",n("agentTools.deleteNote.warningDescription")]})}),e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(He,{variant:"outline",className:"font-mono text-xs",children:i||n("common.loading")})}),e.jsx(un,{content:a,variant:"preview",showMetadata:!1,maxHeight:"max-h-32",placeholder:n("agentTools.deleteNote.loadingContent")})]}),confirm:async()=>(await X.deleteMessage({messageId:i,channelId:J.getState().currentChannelId}),{status:"deleted",message:n("agentTools.deleteNote.success")}),confirmLabel:n("agentTools.deleteNote.confirm"),confirmIcon:e.jsx(jt,{className:"h-4 w-4"}),confirmVariant:"destructive",resultStatusText:()=>n("agentTools.deleteNote.resultSuccess"),resultContent:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(He,{variant:"outline",className:"font-mono text-xs",children:i})}),e.jsx(un,{content:a,variant:"error",showMetadata:!1,placeholder:n("agentTools.deleteNote.deletedContent")})]})})}function Rp({invocation:s}){const{t}=L(),a=Ca(s)?.noteId;return e.jsx(qr,{invocation:s,icon:e.jsx(yt,{className:"h-5 w-5 text-blue-600"}),title:t("agentTools.readNote.title"),loadingText:t("agentTools.readNote.loading",{noteId:a?.substring(0,8)||t("common.unknown")}),successIcon:e.jsx(yt,{className:"h-5 w-5 text-green-600"}),errorIcon:e.jsx(Mi,{className:"w-5 h-5 text-red-600"}),successStatusText:()=>t("agentTools.readNote.success"),errorStatusText:r=>r&&typeof r=="object"&&"found"in r&&!r.found?t("agentTools.readNote.notFound"):t("agentTools.readNote.failed"),readyStatusText:t("agentTools.readNote.preparing"),contentScrollable:!0,headerCardClassName:"border-blue-200 dark:border-blue-900",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:(r,o,i)=>i?e.jsx(na,{error:i,fallbackMessage:t("agentTools.readNote.errorOccurred")}):o?.found?e.jsx(un,{content:o.content,variant:"detail",showMetadata:!0,metadata:{noteId:o.noteId,timestamp:o.timestampReadable,contentLength:o.contentLength}}):e.jsx(na,{error:t("agentTools.readNote.notFound"),fallbackMessage:t("agentTools.readNote.notFound")})})}function Lp({invocation:s}){const{t}=L(),a=(s.parsedArgs||{}).limit||10;return e.jsx(qr,{invocation:s,icon:e.jsx(Ya,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),title:t("agentTools.listNotes.title"),loadingText:t("agentTools.listNotes.loading"),successStatusText:r=>t("agentTools.listNotes.found",{count:r?.notes?.length||0}),errorStatusText:r=>t("agentTools.listNotes.failed"),readyStatusText:t("agentTools.listNotes.preparing"),contentScrollable:!0,headerCardClassName:"border-blue-200 dark:border-blue-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:(r,o,i)=>i?e.jsx(na,{error:i,fallbackMessage:t("agentTools.listNotes.errorOccurred"),variant:"alert"}):!o?.notes||!Array.isArray(o.notes)||o.notes.length===0?e.jsx(Wl,{icon:yt,message:t("agentTools.listNotes.noNotes")}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3",children:t("agentTools.listNotes.showing",{limit:a})}),o.notes.map((l,c)=>e.jsx(Ip,{noteId:l.noteId,content:l.content,contentLength:l.contentLength,timestampReadable:l.timestampReadable},l.noteId||c))]})})}function Dp({invocation:s}){const{t}=L(),n=r=>{const o=r||{},i=["grep"];o.ignoreCase&&i.push("-i"),o.word&&i.push("-w"),o.fixedStrings&&i.push("-F"),o.onlyMatching&&i.push("-o"),o.countOnly&&i.push("-c"),o.listOnly&&i.push("-l"),o.context!==void 0&&i.push("-C",String(o.context)),o.before!==void 0&&i.push("-B",String(o.before)),o.after!==void 0&&i.push("-A",String(o.after)),o.maxMatches!==void 0&&i.push("--max-count",String(o.maxMatches));const l=o.pattern??"",c=`'${String(l).replace(/'/g,"'\\''")}'`;return o.isRegex,i.push("--",c),i.join(" ")},a=({args:r,scope:o,effectiveIncludeCount:i})=>{const l=n(r);return e.jsxs("div",{className:"rounded-md border p-3 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800 space-y-2",children:[e.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:t("agentTools.grep.command")}),e.jsx("pre",{className:"text-xs bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-2 py-1 rounded overflow-x-auto",children:l}),e.jsxs("div",{className:"text-xs text-gray-700 dark:text-gray-300",children:[e.jsxs("span",{className:"inline-block mr-2",children:[t("agentTools.grep.scope"),": ",e.jsx("code",{children:o||t("agentTools.grep.global")})]}),typeof i=="number"&&e.jsxs("span",{className:"inline-block",children:[t("agentTools.grep.channels"),": ",e.jsx("code",{children:i})]})]}),e.jsx("div",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:t("agentTools.grep.scopeNote")})]})};return e.jsx(qr,{invocation:s,icon:e.jsx(Je,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),title:t("agentTools.grep.title"),loadingText:t("agentTools.grep.searching"),successStatusText:r=>{const o=r?.summary;if(!o)return t("agentTools.grep.finished");const i=o.timedOut?` (${t("agentTools.grep.timedOut")})`:"";return t("agentTools.grep.successStatus",{totalMatches:o.totalMatches,matchedNotes:o.matchedNotes,scannedNotes:o.scannedNotes,tookMs:o.tookMs,suffix:i})},errorStatusText:()=>t("agentTools.grep.failed"),readyStatusText:t("agentTools.grep.ready"),contentScrollable:!0,headerCardClassName:"border-blue-200 dark:border-blue-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:(r,o,i)=>{const l=e.jsx(a,{args:r,effectiveIncludeCount:o?.effectiveIncludeCount});return i?e.jsxs("div",{className:"space-y-3",children:[l,e.jsx(na,{error:i,fallbackMessage:t("agentTools.grep.errorOccurred"),variant:"alert"})]}):o?o.noteIds&&o.noteIds.length>0&&(!o.matches||o.matches.length===0)?e.jsxs("div",{className:"space-y-3",children:[l,e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:t("agentTools.grep.matchedNotes")}),e.jsx("div",{className:"rounded-md border p-3 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800",children:e.jsx("ul",{className:"list-disc pl-6 text-sm",children:o.noteIds.map(c=>e.jsx("li",{children:e.jsx("code",{children:c})},c))})})]}):!o.matches||o.matches.length===0?e.jsxs("div",{className:"space-y-3",children:[l,e.jsx(Wl,{icon:Je,message:t("agentTools.grep.noMatches")})]}):e.jsxs("div",{className:"space-y-4",children:[l,o.matches.map(c=>e.jsxs("div",{className:"rounded-md border p-3 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800 space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:[t("agentTools.grep.noteLabel")," ",e.jsx("code",{children:c.noteId})," ",e.jsx("span",{"aria-hidden":"true",children:t("common.separator")})," ",t("agentTools.grep.channelLabel")," ",e.jsx("code",{children:c.channelId})," ",e.jsx("span",{"aria-hidden":"true",children:t("common.separator")})," ",c.timestamp]}),e.jsx("div",{className:"font-mono text-sm",children:c.contexts.map((d,u)=>e.jsxs("div",{className:"mb-3",children:[d.before?.map((h,g)=>e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:h},`b-${g}`)),e.jsx("div",{className:"bg-yellow-100 dark:bg-yellow-900/40 px-1 rounded",children:d.match}),d.after?.map((h,g)=>e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:h},`a-${g}`))]},u))})]},c.noteId))]}):l}})}function _p({invocation:s,onResult:t}){const{t:n}=L(),a=Ca(s),r=a?.content||"",o=a?.channelId||"";return e.jsx(Kr,{invocation:s,onResult:t,icon:e.jsx(yt,{className:"h-5 w-5 text-amber-600 dark:text-amber-400"}),title:n("agentTools.createNote.title"),loadingText:n("agentTools.createNote.preparing"),callStatusText:n("agentTools.createNote.ready"),preview:()=>e.jsx(un,{content:r,variant:"preview",showMetadata:!1}),confirm:async()=>(await X.sendMessage({channelId:o,content:r,sender:"user"}),{status:"created",message:n("agentTools.createNote.success")}),confirmLabel:n("agentTools.createNote.confirm"),confirmIcon:e.jsx(_t,{className:"h-4 w-4"}),resultStatusText:()=>n("agentTools.createNote.resultSuccess"),resultContent:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx(un,{content:r,variant:"detail",showMetadata:!1}),e.jsx("p",{className:"text-sm text-green-600 dark:text-green-400",children:n("agentTools.createNote.saved")})]}),cancelStatusText:n("agentTools.createNote.cancelled")})}function Pp(){return{name:"listNotes",description:"List notes/thoughts in the specified channel, optionally sorted by time",parameters:{type:"object",properties:{limit:{type:"number",description:"Maximum number of notes/thoughts to return (default: 10)"},order:{type:"string",enum:["asc","desc"],description:"Sort order by timestamp (default: desc)"},channelId:{type:"string",description:"ID of the channel to list notes from"}},required:["channelId"]},execute:async s=>{try{const{limit:t=10,order:n="desc",channelId:a}=s;let{userId:r}=O.getState();if(r||(await O.getState().initGuestWorkspace(),r=O.getState().userId),!r)throw new Error("No active workspace");const{items:o}=await ye().notes.listMessages(r,a,{limit:t,cursor:null,includeSenders:["user","ai"]});return{notes:(n==="asc"?[...o].sort((c,d)=>c.timestamp.getTime()-d.timestamp.getTime()):[...o].sort((c,d)=>d.timestamp.getTime()-c.timestamp.getTime())).map(c=>({content:c.content.substring(0,200)+(c.content.length>200?"...":""),contentLength:c.content.length,timestamp:c.timestamp,timestampReadable:Yt(c.timestamp),noteId:c.id}))}}catch(t){throw console.error("ðŸ”” [listNotesTool][execute][error]:",t),new Error(`Failed to list notes: ${t instanceof Error?t.message:"Unknown error"}`)}},render:s=>e.jsx(Lp,{invocation:s})}}class tn{notes$=new Rt([]);channels$=new Rt([]);updateStatus$=new Rt({isUpdating:!1,lastUpdateTime:0});channelUpdateStatus$=new Rt({});static STALE_MS=3600*1e3;constructor(){this.loadFromCache()}getNotes(t){return this.notes$.pipe(os(n=>this.filterNotes(n,t)))}getChannels(t){return this.channels$.pipe(os(n=>this.filterChannels(n,t)))}getNoteById(t){return this.notes$.pipe(os(n=>n.find(a=>a.id===t)||null))}getUpdateStatus(){return this.updateStatus$}getChannelUpdateStatus(t){return this.channelUpdateStatus$.pipe(os(n=>n[t]||null))}async updateAll(){this.setUpdateStatus({isUpdating:!0,lastUpdateTime:0});try{const n=(await Ie.getCurrentUser())?.uid;if(!n)return;const a=this.getLastFullUpdateTime();if(a&&Date.now()-a<tn.STALE_MS){(this.notes$.value.length===0||this.channels$.value.length===0)&&await this.loadFromCache(),this.setUpdateStatus({isUpdating:!1,lastUpdateTime:a});return}const o=await ge.fetchChannels(n);let i=[];this.notes$.value.length>0?i=[...this.notes$.value]:i=[...(await this.loadFromIndexedDB()).notes],console.debug("[NoteSearch][updateAll] start",{channels:o.length});for(const l of o){const c=this.getChannelLastUpdateTime(l.id),d=c&&Date.now()-c<tn.STALE_MS,u=i.some(x=>x.channelId===l.id);if(d&&u)continue;let h=[];try{const x=await ge.fetchInitialMessagesAllSenders(n,l.id,1e3);console.debug("[NoteSearch][updateAll] channel fetched (all senders)",{channelId:l.id,count:x.messages.length}),h=x.messages}catch(x){console.warn("[NoteSearch][updateAll] all-senders fetch failed, fallback to user-only",{channelId:l.id,err:x}),h=(await ge.fetchInitialMessages(n,l.id,1e3)).messages}const g=h.map(x=>{const f=x;return{id:f.id,channelId:f.channelId,content:f.content,tags:f.tags||[],aiAnalysis:f.aiAnalysis,timestamp:f.timestamp,sender:f.sender,isDeleted:f.isDeleted||!1}});i=i.filter(x=>x.channelId!==l.id).concat(g),this.notes$.next([...i]),this.setChannelLastUpdateTime(l.id,Date.now())}this.notes$.next(i),this.channels$.next(o),await this.saveToCache(i,o),this.setLastFullUpdateTime(Date.now()),this.setUpdateStatus({isUpdating:!1,lastUpdateTime:Date.now()})}catch(t){console.warn("[NoteSearch][updateAll] failed",t),this.setUpdateStatus({isUpdating:!1,lastUpdateTime:Date.now(),error:t instanceof Error?t.message:"Unknown error"})}}async updateChannel(t){this.setChannelUpdateStatus(t,{isUpdating:!0,lastUpdateTime:0});try{const a=(await Ie.getCurrentUser())?.uid;if(!a)return;const r=this.getChannelLastUpdateTime(t);if(r&&Date.now()-r<tn.STALE_MS&&(this.notes$.value.length===0&&await this.loadFromCache(),this.notes$.value.some(h=>h.channelId===t))){this.setChannelUpdateStatus(t,{isUpdating:!1,lastUpdateTime:r});return}console.debug("[NoteSearch][updateChannel] start",{channelId:t});let i=[];try{const u=await ge.fetchInitialMessagesAllSenders(a,t,1e3);console.debug("[NoteSearch][updateChannel] fetched (all senders)",{channelId:t,count:u.messages.length}),i=u.messages}catch(u){console.warn("[NoteSearch][updateChannel] all-senders fetch failed, fallback to user-only",{channelId:t,err:u}),i=(await ge.fetchInitialMessages(a,t,1e3)).messages}const l=i.map(u=>{const h=u;return{id:h.id,channelId:h.channelId,content:h.content,tags:h.tags||[],aiAnalysis:h.aiAnalysis,timestamp:h.timestamp,sender:h.sender,isDeleted:h.isDeleted||!1}}),d=this.notes$.value.filter(u=>u.channelId!==t).concat(l);this.notes$.next(d),await this.saveNotesToCache(d),this.setChannelLastUpdateTime(t,Date.now()),this.setChannelUpdateStatus(t,{isUpdating:!1,lastUpdateTime:Date.now()})}catch(n){console.warn("[NoteSearch][updateChannel] failed",n),this.setChannelUpdateStatus(t,{isUpdating:!1,lastUpdateTime:0})}}async forceUpdate(){await this.updateAll()}filterNotes(t,n){return n?t.filter(a=>{if(n.channelIds&&!n.channelIds.includes(a.channelId)||n.tags&&!n.tags.some(r=>a.tags.includes(r))||n.sender&&a.sender!==n.sender)return!1;if(n.dateRange){const r=new Date(a.timestamp).getTime();if(n.dateRange.start&&r<n.dateRange.start||n.dateRange.end&&r>n.dateRange.end)return!1}return!0}):t}filterChannels(t,n){return n?t.filter(a=>!(n.ids&&!n.ids.includes(a.id)||n.name&&!a.name.toLowerCase().includes(n.name.toLowerCase()))):t}setUpdateStatus(t){this.updateStatus$.next(t)}setChannelUpdateStatus(t,n){const a=this.channelUpdateStatus$.value;this.channelUpdateStatus$.next({...a,[t]:n})}async loadFromCache(){try{const t=await this.loadFromIndexedDB();t.notes.length>0&&this.notes$.next(t.notes),t.channels.length>0&&this.channels$.next(t.channels)}catch(t){console.warn("Failed to load from cache:",t)}}async saveToCache(t,n){try{await this.saveToIndexedDB({notes:t,channels:n})}catch(a){console.warn("Failed to save to cache:",a)}}async saveNotesToCache(t){try{const n=await this.loadFromIndexedDB();await this.saveToIndexedDB({...n,notes:t})}catch(n){console.warn("Failed to save notes to cache:",n)}}async loadFromIndexedDB(){return new Promise((t,n)=>{const a=indexedDB.open("stillroot_data",1);a.onupgradeneeded=()=>{const r=a.result;r.objectStoreNames.contains("notes")||r.createObjectStore("notes",{keyPath:"id"}),r.objectStoreNames.contains("channels")||r.createObjectStore("channels",{keyPath:"id"})},a.onsuccess=()=>{const r=a.result,o=r.transaction(["notes","channels"],"readonly"),i=o.objectStore("notes"),l=o.objectStore("channels"),c=i.getAll(),d=l.getAll();Promise.all([new Promise((u,h)=>{c.onsuccess=()=>u(c.result),c.onerror=()=>h(c.error)}),new Promise((u,h)=>{d.onsuccess=()=>u(d.result),d.onerror=()=>h(d.error)})]).then(([u,h])=>{r.close(),t({notes:u,channels:h})}).catch(n)},a.onerror=()=>n(a.error)})}async saveToIndexedDB(t){return new Promise((n,a)=>{const r=indexedDB.open("stillroot_data",1);r.onupgradeneeded=()=>{const o=r.result;o.objectStoreNames.contains("notes")||o.createObjectStore("notes",{keyPath:"id"}),o.objectStoreNames.contains("channels")||o.createObjectStore("channels",{keyPath:"id"})},r.onsuccess=()=>{const o=r.result,i=o.transaction(["notes","channels"],"readwrite"),l=i.objectStore("notes"),c=i.objectStore("channels");l.clear(),c.clear(),t.notes.forEach(d=>l.add(d)),t.channels.forEach(d=>c.add(d)),i.oncomplete=()=>{o.close(),n()},i.onerror=()=>a(i.error)},r.onerror=()=>a(r.error)})}getLastFullUpdateTime(){if(typeof window>"u")return null;const t=window.localStorage.getItem("stillroot_search_last_full_update");return t?Number(t):null}setLastFullUpdateTime(t){typeof window>"u"||window.localStorage.setItem("stillroot_search_last_full_update",String(t))}getChannelLastUpdateTime(t){if(typeof window>"u")return null;const n=window.localStorage.getItem(`stillroot_search_channel_update_${t}`);return n?Number(n):null}setChannelLastUpdateTime(t,n){typeof window>"u"||window.localStorage.setItem(`stillroot_search_channel_update_${t}`,String(n))}}const ft=new tn;function Op(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function $p(s){return/[|*+?^${}()[\]\\]/.test(s)}function Bp(s){const t=s.pattern??"",n=s.ignoreCase?"i":"";if(!t)return{test:()=>({matched:!1})};if(s.fixedStrings){const i=s.ignoreCase?t.toLowerCase():t;return{test:l=>{const d=(s.ignoreCase?l.toLowerCase():l).indexOf(i);return{matched:d>=0,matchText:t,index:d>=0?d:void 0}}}}let r=s.isRegex??$p(t)?t:Op(t);s.word&&(r=`\\b${r}\\b`);let o;try{o=new RegExp(r,n)}catch{const i=s.ignoreCase?t.toLowerCase():t;return{test:l=>{const d=(s.ignoreCase?l.toLowerCase():l).indexOf(i);return{matched:d>=0,matchText:t,index:d>=0?d:void 0}}}}return{test:i=>{const l=o.exec(i);return{matched:!!l,matchText:l?.[0],index:l?.index}}}}async function Up(s){const t=Date.now(),n=Math.max(500,Math.min(s.timeoutMs??3e3,15e3)),a=Math.max(1,Math.min(s.maxMatches??200,5e3)),r=Math.max(1,Math.min(s.maxNotes??500,5e3)),o=s.context!==void 0?s.context:s.before??0,i=s.context!==void 0?s.context:s.after??0,l={};let c="global",d=null;if(s.includeChannels&&s.includeChannels.length>0)d=s.includeChannels,c="args";else{const v=se.getState(),y=v.currentConversationId,w=v.conversations.find(S=>S.id===y),N=w?.contexts?.mode;if(N==="channels"&&w?.contexts?.channelIds&&w.contexts.channelIds.length>0)d=w.contexts.channelIds,c="contexts:channels";else if(N==="all")d=null,c="contexts:all";else{const{currentChannelId:S}=J.getState();S?(d=[S],c="currentChannel"):(d=null,c="global")}}if(d&&d.length>0&&(l.channelIds=d),s.tags&&s.tags.length>0&&(l.tags=s.tags),s.sender&&(l.sender=s.sender),s.dateRange){const v=s.dateRange.start??0,y=s.dateRange.end??Number.MAX_SAFE_INTEGER;l.dateRange={start:v,end:y}}let u=await Ms(ft.getNotes(l));if(u.length===0||s.includeChannels&&s.includeChannels.every(v=>!u.some(y=>y.channelId===v)))try{if(s.includeChannels&&s.includeChannels.length>0)for(const v of s.includeChannels)await ft.updateChannel(v);else await ft.updateAll();u=await Ms(ft.getNotes(l))}catch{}if(s.excludeChannels&&s.excludeChannels.length>0){const v=new Set(s.excludeChannels);u=u.filter(y=>!v.has(y.channelId))}let h=0,g=0,x=0;const f=[],p=Bp(s);for(const v of u){if(Date.now()-t>n||h>=r)break;h++;const y=v.content||"";if(!y)continue;const w=y.split(/\r?\n/),N=[];let S=!1;for(let j=0;j<w.length;j++){const C=w[j],I=p.test(C);if(I.matched){S=!0,x++;const k=[],T=[];for(let D=Math.max(0,j-o);D<j;D++)k.push(w[D]);for(let D=j+1;D<=Math.min(w.length-1,j+i);D++)T.push(w[D]);const z=s.onlyMatching&&I.matchText?I.matchText:C;if(N.push({before:k,match:z,after:T,line:j+1,offset:I.index}),x>=a)break}if(Date.now()-t>n)break}if(S&&(g++,s.countOnly||f.push({noteId:v.id,channelId:v.channelId,timestamp:v.timestamp?.toLocaleString?.()||"",contexts:N})),x>=a)break}const b={summary:{scannedNotes:h,matchedNotes:g,totalMatches:x,tookMs:Date.now()-t,timedOut:Date.now()-t>n},scope:c,effectiveIncludeCount:d?d.length:void 0};return s.countOnly||(s.listOnly?b.noteIds=f.map(v=>v.noteId):b.matches=f),b}function Fp(){return{name:"grepNotes",description:"Search notes with grep-like semantics (equivalent to 'grep -E' by default). Automatically detects and enables extended regex mode when pattern contains special characters (|, *, +, ?, etc). Supports regex alternation (e.g., 'äº§å“|æ—¶é—´çº¿'), case-insensitive, word boundary, context lines, and filtering by channel/tags/date. Use fixedStrings=true for literal string search (like 'grep -F').",parameters:{type:"object",properties:{pattern:{type:"string",description:"Search pattern. Extended regex mode is automatically enabled if pattern contains special characters like | (alternation), *, +, ?, etc. Matches 'grep -E' behavior."},isRegex:{type:"boolean",description:"Force regex mode on/off. By default, mode is auto-detected based on pattern content."},ignoreCase:{type:"boolean",description:"Case-insensitive search (like 'grep -i')"},word:{type:"boolean",description:"Match whole words only (like 'grep -w')"},fixedStrings:{type:"boolean",description:"Disable regex and search for literal string (like 'grep -F')"},before:{type:"number",description:"Print N lines of leading context before each match (like 'grep -B N')"},after:{type:"number",description:"Print N lines of trailing context after each match (like 'grep -A N')"},context:{type:"number",description:"Print N lines of surrounding context (like 'grep -C N')"},countOnly:{type:"boolean",description:"Only output count of matching lines (like 'grep -c')"},listOnly:{type:"boolean",description:"Only output filenames with matches (like 'grep -l')"},onlyMatching:{type:"boolean",description:"Only output the matching part (like 'grep -o')"},includeChannels:{type:"array",items:{type:"string"}},excludeChannels:{type:"array",items:{type:"string"}},tags:{type:"array",items:{type:"string"}},sender:{type:"string",enum:["user","ai"]},dateRange:{type:"object",properties:{start:{type:"number"},end:{type:"number"}}},maxMatches:{type:"number"},maxNotes:{type:"number"},snippetSize:{type:"number"},timeoutMs:{type:"number"}},required:["pattern"]},execute:async s=>await Up(s),render:s=>Ts.createElement(Dp,{invocation:s})}}async function zp(s,t){const r=X.dataContainer.get().messageByChannel[s];if(r&&!r.loading)return;r||X.requestLoadInitialMessages$.next({channelId:s});const o=Date.now();await new Promise((i,l)=>{const c=()=>{const d=X.dataContainer.get().messageByChannel[s];if(d&&!d.loading)return i();if(Date.now()-o>1e4)return l(new Error(`Timeout waiting channel ${s} messages to load`));setTimeout(c,100)};c()})}class Hp{getChannelTools(){return[this.createNoteTool(),this.readNoteTool(),this.updateNoteTool(),this.deleteNoteTool(),this.listNotesTool(),this.grepNotesTool()]}createNoteTool(){return{name:"createNote",description:"Create a new note/thought in the specified channel (requires user confirmation).",parameters:{type:"object",properties:{content:{type:"string",description:"Content of the note/thought"},channelId:{type:"string",description:"ID of the channel to create the note in"}},required:["content","channelId"]},render:(t,n)=>m.createElement(_p,{invocation:t,onResult:n})}}readNoteTool(){return{name:"readNote",description:"Read a specific note/thought by its ID from the specified channel",parameters:{type:"object",properties:{noteId:{type:"string",description:"ID of the note/thought to read"},channelId:{type:"string",description:"ID of the channel to read the note from"}},required:["noteId","channelId"]},execute:async t=>{const{noteId:n,channelId:a}=t;try{await zp(a);const o=X.dataContainer.get().messageByChannel[a]?.messages.find(i=>i.id===n);if(!o)throw new Error(`Note with ID ${n} not found`);return{found:!0,noteId:o.id,content:o.content,timestamp:o.timestamp,timestampReadable:o.timestamp.toLocaleString(),contentLength:o.content.length}}catch(r){throw console.error("ðŸ”” [readNoteTool][error]:",r),new Error(`Failed to read note: ${r instanceof Error?r.message:"Unknown error"}`)}},render:t=>m.createElement(Rp,{invocation:t})}}updateNoteTool(){return{name:"updateNote",description:"Update an existing note/thought by its ID in the specified channel (requires user confirmation).",parameters:{type:"object",properties:{noteId:{type:"string",description:"ID of the note/thought to update"},content:{type:"string",description:"New content for the note/thought"},channelId:{type:"string",description:"ID of the channel containing the note"}},required:["noteId","content","channelId"]},render:(t,n)=>m.createElement(Ep,{invocation:t,onResult:n})}}deleteNoteTool(){return{name:"deleteNote",description:"Delete a note/thought by its ID from the specified channel (requires user confirmation).",parameters:{type:"object",properties:{noteId:{type:"string",description:"ID of the note/thought to delete"},channelId:{type:"string",description:"ID of the channel containing the note"}},required:["noteId","channelId"]},render:(t,n)=>m.createElement(Ap,{invocation:t,onResult:n})}}listNotesTool(){return Pp()}grepNotesTool(){return Fp()}}const Gp=new Hp;class Vp{summarizeMessages(t,n){const a=t.filter(i=>i.sender==="user");if(a.length===0)return[{description:"No user content available",value:JSON.stringify({message:"No user thoughts or notes found in this context."})}];const r=a.reduce((i,l)=>{const c=l.channelId;return i[c]||(i[c]=[]),i[c].push(l),i},{}),o=[];return Object.entries(r).forEach(([i,l])=>{const c=O.getState().channels.find(u=>u.id===i),d=l.sort((u,h)=>h.timestamp.getTime()-u.timestamp.getTime());o.push({description:`Channel ${i} - All messages (${d.length} messages)`,value:JSON.stringify({channelId:i,messageCount:c?.messageCount,channelName:c?.name,messages:d.map(u=>({id:u.id,content:u.content,timestamp:u.timestamp.toISOString(),sender:u.sender,channelId:u.channelId,tags:u.tags}))})})}),o}}class Wp{TIER_LIMITS={latest:1e4,recent:2e3,historical:300,archive:30};MAX_LENGTH=35e3;summarizeMessages(t,n){const a=n||this.MAX_LENGTH,r=t.filter(l=>l.sender==="user");if(r.length===0)return[{description:"User Notes Context",value:JSON.stringify({empty:!0,message:"No user notes available"})}];const o=this.groupMessagesByTier(r),i=this.buildContextJSON(o,a);return[{description:"User Notes Context (Structured)",value:JSON.stringify(i)}]}groupMessagesByTier(t){const n=[{name:"1",description:"Most recent note (full content)",items:[],charLimit:this.TIER_LIMITS.latest},{name:"2-5",description:"Recent notes (detailed)",items:[],charLimit:this.TIER_LIMITS.recent},{name:"6-30",description:"Historical notes (summarized)",items:[],charLimit:this.TIER_LIMITS.historical},{name:"31+",description:"Archive notes (brief)",items:[],charLimit:this.TIER_LIMITS.archive}];return t.forEach((a,r)=>{const o=this.getMessageGroupIndex(r);o>=0&&o<n.length&&n[o].items.push(a)}),n}getMessageGroupIndex(t){return t===0?0:t>=1&&t<=4?1:t>=5&&t<=29?2:3}buildContextJSON(t,n){const a=t.flatMap(c=>c.items);if(a.length===0)return{empty:!0,message:"No user notes available",sampling_rules:this.getSamplingRulesDescription()};const r={sampling_rules:this.getSamplingRulesDescription(),groups:[]};let o=0,i=0;for(const c of t){if(c.items.length===0)continue;const d=this.buildGroupJSON(c),u=this.getTextLength(JSON.stringify(d));if(o+u<=n)r.groups.push(d),o+=u,i+=c.items.length;else break}const l=a.length-i;return l>0&&(r.additional_notes={count:l,message:"Use search tools to access more content"}),r}buildGroupJSON(t){const n={name:t.name,description:t.description,items:[]};return t.items.forEach(a=>{const r=this.processMessageContent(a,t.charLimit),o={id:a.id,timestamp:a.timestamp.toISOString(),channel_id:a.channelId,content:r.content};r.truncated&&(o.truncated=!0,o.original_length=r.originalLength,o.truncated_length=r.truncatedLength),n.items.push(o)}),n}processMessageContent(t,n){if(t.content.length<=n)return{content:t.content};const a=this.truncateContent(t.content,n);return{content:a,truncated:!0,originalLength:t.content.length,truncatedLength:a.length}}truncateContent(t,n){if(t.length<=n)return t;const a=.7,r=.3,o="...",i=Math.floor(n*a),l=Math.floor(n*r),c=Math.max(0,i-o.length),d=Math.max(0,l-o.length),u=t.substring(0,c),h=t.substring(t.length-d);return`${u}${o}${h}`}getTextLength(t){return t?.length||0}getSamplingRulesDescription(){return`USER NOTES CONTEXT ORGANIZATION:

Notes are sorted by timestamp (newest first) and organized into groups by position with different detail levels:

1. POSITION 1 (Most Recent):
   - Contains: The single most recent user note
   - Detail level: FULL CONTENT (up to ${this.TIER_LIMITS.latest} characters)
   - Purpose: Provides complete context of user's latest thoughts
   - Usage: Reference for immediate context and current user state

2. POSITIONS 2-5 (Recent Notes):
   - Contains: Notes from positions 2, 3, 4, and 5 (if they exist)
   - Detail level: DETAILED (up to ${this.TIER_LIMITS.recent} characters each)
   - Purpose: Recent context and immediate history
   - Usage: Understanding recent user patterns and immediate background

3. POSITIONS 6-30 (Historical Notes):
   - Contains: Notes from positions 6 through 30 (if they exist)
   - Detail level: SUMMARIZED (up to ${this.TIER_LIMITS.historical} characters each)
   - Purpose: Historical context and patterns
   - Usage: Understanding user's longer-term thinking patterns and themes

4. POSITIONS 31+ (Archive Notes):
   - Contains: All notes from position 31 onwards (if they exist)
   - Detail level: BRIEF (up to ${this.TIER_LIMITS.archive} characters each)
   - Purpose: Distant historical context
   - Usage: Identifying long-term themes and patterns

CONTENT PROCESSING:
- Long content is intelligently truncated preserving 70% from start + 30% from end
- Truncated items include metadata: truncated=true, original_length, truncated_length
- Each note includes: id, timestamp, channel_id, content
- Use search tools to access full content of truncated or additional notes

GROUP STRUCTURE:
Each group contains: name (position range), description (purpose), and items array (actual notes)
Groups are processed in priority order (1 â†’ 2-5 â†’ 6-30 â†’ 31+) until token limit is reached`}debugSummarizeMessages(t){const n=t||this.generateSampleMessages();console.group("ðŸ” Message Summarizer Debug"),console.log("ðŸ“ Input Messages:",n);const a=this.summarizeMessages(n);if(console.log("ðŸ“Š Summary Result:",a),a[0]?.value)try{const r=JSON.parse(a[0].value);console.log("ðŸ“‹ Parsed JSON:",r),console.log("ðŸ“ Length:",this.getTextLength(a[0].value)),console.log("ðŸ“ Character Count:",a[0].value.length)}catch(r){console.error("âŒ Failed to parse JSON:",r)}console.groupEnd()}generateSampleMessages(){const t=new Date;return[{id:"1",content:"This is the latest note with full content that should be preserved completely. It contains important information about the current project status and next steps.",timestamp:new Date(t.getTime()-1e3*60*5),sender:"user",channelId:"channel1"},{id:"2",content:"This is a recent note that should be included with good detail. It discusses the implementation approach and technical considerations.",timestamp:new Date(t.getTime()-1e3*60*30),sender:"user",channelId:"channel1"},{id:"3",content:"This is a historical note that should be summarized. It contains older information that is less critical but still relevant for context.",timestamp:new Date(t.getTime()-1e3*60*60*2),sender:"user",channelId:"channel2"},{id:"4",content:"This is an archive note that should be brief. Very old information that provides minimal context.",timestamp:new Date(t.getTime()-1e3*60*60*24),sender:"user",channelId:"channel1"}]}}class Kl{rawSummarizer=new Vp;tieredSummarizer=new Wp;LENGTH_LIMIT=3e4;summarizeMessages(t){if(t.length===0)return[];const n=this.rawSummarizer.summarizeMessages(t),a=this.calculateTotalLength(n);if(a<=this.LENGTH_LIMIT)return console.log(`[HybridMessageSummarizer] Using raw strategy (${a} chars)`),n;console.log(`[HybridMessageSummarizer] Raw strategy exceeds limit (${a} chars), switching to tiered strategy`);const r=this.tieredSummarizer.summarizeMessages(t),o=this.calculateTotalLength(r);return console.log(`[HybridMessageSummarizer] Tiered strategy result: ${o} chars`),r}calculateTotalLength(t){return t.reduce((n,a)=>n+(a.value?.length||0),0)}getStrategyInfo(t){const n=this.rawSummarizer.summarizeMessages(t),a=this.tieredSummarizer.summarizeMessages(t),r=this.calculateTotalLength(n),o=this.calculateTotalLength(a),i=r<=this.LENGTH_LIMIT,l=i?"raw":"tiered";return{messageCount:t.length,rawLength:r,tieredLength:o,strategyUsed:l,withinLimit:i}}}function qp(s,t,n){const a=W.t.bind(W);return`${a("aiAssistant.prompts.systemPrompts.stillRootAI.intro")}

${a("aiAssistant.prompts.systemPrompts.stillRootAI.channelContext",{channelName:s,messageCount:t})}

## Your Three Core Objectives (in priority order):

${a("aiAssistant.prompts.systemPrompts.stillRootAI.objective1")}

${a("aiAssistant.prompts.systemPrompts.stillRootAI.objective2")}

${a("aiAssistant.prompts.systemPrompts.stillRootAI.objective3",{multiChannel:"",multiChannelBoundary:""})}

${a("aiAssistant.prompts.systemPrompts.stillRootAI.workingApproach")}

${a("aiAssistant.prompts.systemPrompts.stillRootAI.terminology")}

${a("aiAssistant.prompts.systemPrompts.stillRootAI.importantRules")}

${a("aiAssistant.prompts.systemPrompts.stillRootAI.toolUsageGuidelines",{channelId:n})}

${a("aiAssistant.prompts.systemPrompts.stillRootAI.closing")}`}class Kp{summarizer=new Kl;getChannelContext(t){const n=X.dataContainer.get().messageByChannel[t],{channels:a}=O.getState(),r=a.find(c=>c.id===t),o=n?.messages||[];if(!r)return[{description:"Channel Context",value:JSON.stringify({info:"Channel meta loading...",channelId:t,timestamp:new Date().toISOString()})}];const i=o.filter(c=>c.sender==="user").sort((c,d)=>d.timestamp.getTime()-c.timestamp.getTime()),l=this.summarizer.summarizeMessages(i);return[{description:"System Instructions",value:JSON.stringify({instructions:qp(r.name,i.length,t)})},...l]}}const Yp=new Kp;var Y=(s=>(s.NONE="none",s.CHANNELS="channels",s.ALL="all",s.AUTO="auto",s))(Y||{});const _n=1e3;class Xp{summarizer=new Kl;generateSystemInstructions(t,n,a,r){const o=t>1,i=o?`a multi-channel context spanning ${t} channels: ${a.join(", ")}`:`the channel: ${a[0]}`,l=W.t.bind(W),c=l(o?"aiAssistant.prompts.systemPrompts.stillRootAI.contextUnderstandingMulti":"aiAssistant.prompts.systemPrompts.stillRootAI.contextUnderstandingSingle");return`${l("aiAssistant.prompts.systemPrompts.stillRootAI.intro")}

${l("aiAssistant.prompts.systemPrompts.stillRootAI.multiChannelContext",{channelContext:i,totalNotes:n})}

## Your Three Core Objectives (in priority order):

${l("aiAssistant.prompts.systemPrompts.stillRootAI.objective1")}

${l("aiAssistant.prompts.systemPrompts.stillRootAI.objective2")}

${l("aiAssistant.prompts.systemPrompts.stillRootAI.objective3",{multiChannel:o?" across different channels":"",multiChannelBoundary:o?" across channel boundaries":""})}

${l("aiAssistant.prompts.systemPrompts.stillRootAI.workingApproach")}

## Context Understanding:
${c}

${l("aiAssistant.prompts.systemPrompts.stillRootAI.terminology")}

${l("aiAssistant.prompts.systemPrompts.stillRootAI.importantRules")}

${l("aiAssistant.prompts.systemPrompts.stillRootAI.toolUsageGuidelines",{channelId:r})}

${l("aiAssistant.prompts.systemPrompts.stillRootAI.closing")}`}ensureContextsLoaded(t,n){if(!t){const o=X.dataContainer.get().messageByChannel[n];(!o||o.hasMore)&&X.requestLoadInitialMessages$.next({channelId:n,messageLimit:_n});return}const{mode:a,channelIds:r}=t;if(a===Y.AUTO){const o=J.getState().currentChannelId,i=X.dataContainer.get().messageByChannel[o];(!i||i.hasMore)&&X.requestLoadInitialMessages$.next({channelId:o,messageLimit:_n});return}if(a===Y.CHANNELS&&r)r.forEach(o=>{const i=X.dataContainer.get().messageByChannel[o];(!i||i.hasMore)&&X.requestLoadInitialMessages$.next({channelId:o,messageLimit:_n})});else if(a===Y.ALL){const{channels:o}=O.getState();o.forEach(i=>{const l=X.dataContainer.get().messageByChannel[i.id];(!l||l.hasMore)&&X.requestLoadInitialMessages$.next({channelId:i.id,messageLimit:_n})})}}getSessionContexts(t,n){const a=se.getState().conversations.find(d=>d.id===t);if(!a||!a.contexts)return this.getUnifiedContext([n]);const{mode:r,channelIds:o}=a.contexts;if(r===Y.NONE)return[{description:"System Instructions",value:JSON.stringify({instructions:"No external context is attached to this conversation. Respond based on user input only unless the user explicitly asks to reference notes."})}];if(r===Y.CHANNELS){const d=o||[];return d.length===0?[]:this.getUnifiedContext(d)}const{channels:i}=O.getState(),l=X.dataContainer.get().messageByChannel,c=i.map(d=>d.id).filter(d=>{const u=l[d];return u&&!u.loading});return c.length===0?this.getUnifiedContext([n]):this.getUnifiedContext(c)}getUnifiedContext(t){const{channels:n}=O.getState(),a=X.dataContainer.get().messageByChannel,r=[];t.forEach(u=>{const h=n.find(x=>x.id===u),g=a[u];if(h&&g?.messages){const x=g.messages.filter(f=>f.sender==="user").map(f=>({...f,channelId:u,channelName:h.name}));r.push(...x)}}),r.sort((u,h)=>h.timestamp.getTime()-u.timestamp.getTime());const o=this.summarizer.summarizeMessages(r),i=t.map(u=>{const h=n.find(g=>g.id===u);return{id:u,name:h?.name||"Unknown",note_count:h?.messageCount||0}}),l=i.map(u=>u.name),c=r.length;return[{description:"System Instructions",value:this.generateSystemInstructions(t.length,c,l,t[0])},{description:"Channel Information",value:JSON.stringify({channels:i,total_channels:t.length,total_notes:c})},...o]}}const Yr=new Xp;function Oe({className:s,type:t,...n}){return e.jsx("input",{type:t,"data-slot":"input",className:E("file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm","aria-invalid:border-destructive",s),...n})}const Jp=m.createContext(null),Zp=({children:s,open:t,onOpenChange:n,modal:a})=>{const[r,o]=m.useState(!1),i=t!==void 0?t:r,l=n||o,c={isOpen:i,onOpenChange:l};return e.jsx(Jp.Provider,{value:c,children:e.jsx(ln,{open:i,onOpenChange:l,modal:a,children:s})})},Qp=({children:s,className:t=""})=>e.jsx("div",{className:E("flex items-center gap-2.5 mb-5",t),children:s}),ef=({children:s,className:t=""})=>e.jsx("div",{className:E("space-y-4",t),children:s}),tf=({children:s,className:t=""})=>e.jsx("div",{className:E("flex justify-end gap-2.5 pt-3 mt-2",t),children:s}),sf=cn,Yl=m.forwardRef(({className:s,variant:t="default",size:n="md",...a},r)=>{const o="h-8 px-4 rounded-lg text-sm transition-all duration-200 font-medium flex items-center justify-center",i={default:"bg-primary text-primary-foreground hover:bg-primary/90",outline:"text-muted-foreground hover:text-foreground hover:bg-accent/30",ghost:"text-muted-foreground hover:text-foreground hover:bg-accent/30"},l={sm:"h-7 px-3 text-xs",md:"h-8 px-4 text-sm"};return e.jsx("button",{className:E(o,i[t],l[n],"disabled:opacity-50",s),ref:r,...a})});Yl.displayName="RefinedPopoverButton";const nf=({children:s,width:t="w-80",className:n="",align:a="center",side:r="bottom",sideOffset:o=6,onInteractOutside:i})=>e.jsx(dn,{className:E(t,"p-4 border border-slate-200/60 dark:border-slate-700/60 shadow-lg bg-popover text-popover-foreground rounded-xl overflow-hidden max-w-[90vw] max-h-[70vh] mr-4 sm:mr-0",n),align:a,side:r,sideOffset:o,onInteractOutside:i,children:s}),Q=Object.assign(Zp,{Trigger:sf,Content:nf,Header:Qp,Body:ef,Actions:tf,Button:Yl});function af({conversationId:s,fallbackChannelId:t,onActiveToolChannelChange:n,activeToolChannelId:a}){const r=se(x=>x.conversations.find(f=>f.id===s)),o=se(x=>x.updateConversation),{userId:i}=O(),[l,c]=m.useState(r?.contexts?r.contexts.mode:Y.AUTO),[d,u]=m.useState(r?.contexts?.mode===Y.CHANNELS?r?.contexts?.channelIds||[t]:[t]);m.useEffect(()=>{c(r?.contexts?r.contexts.mode:Y.AUTO),u(r?.contexts?.mode===Y.CHANNELS?r?.contexts?.channelIds||[t]:[t])},[s,r?.contexts,t]);const h=m.useCallback(x=>{u(f=>f.includes(x)?f.filter(p=>p!==x):[...f,x])},[]),g=m.useCallback(async()=>{if(!i||!r)return;if(l===Y.AUTO){await o(i,r.id,{contexts:{mode:Y.AUTO}});return}let x;if(l===Y.NONE)x={mode:Y.NONE};else if(l===Y.ALL)x={mode:Y.ALL};else{const f=d.length?d:[t];if(x={mode:Y.CHANNELS,channelIds:f},n){const p=a&&f.includes(a)?a:f[0];n(p)}}await o(i,r.id,{contexts:x}),Yr.ensureContextsLoaded(x,t)},[i,r,l,d,t,n,a,o]);return{draftMode:l,setDraftMode:c,draftChannelIds:d,toggleChannel:h,apply:g,isSelectedMode:l===Y.CHANNELS}}function rf(s,t,n,a){if(s===Y.AUTO)return[n];if(s===Y.NONE)return[];if(s===Y.CHANNELS){const r=t?.channelIds||[];return r.length>0?r:[n]}else return a.map(r=>r.id)}function of(s,t,n){return s.length===0?"":s.map(r=>{const o=t[r],i=n(r),l=o?.loading?"loading":"ready";return`${i}(${l})`}).join(", ")}function lf({conversationId:s,fallbackChannelId:t,contexts:n,getChannelName:a}){const r=X.dataContainer.use(),{channels:o}=O();m.useEffect(()=>{Yr.ensureContextsLoaded(n||null,t)},[s,t,n]);const{anyLoading:i,tooltip:l}=m.useMemo(()=>{const c=n?n.mode:Y.AUTO,d=rf(c,n,t,o),h=d.map(x=>r.messageByChannel[x]?.loading||!1).some(x=>x),g=of(d,r.messageByChannel,a);return{anyLoading:h,tooltip:g}},[n,t,o,r,a]);return{anyLoading:i,tooltip:l}}function cf(s){const[t,n]=m.useState(""),a=J(o=>o.currentChannelId),r=m.useMemo(()=>{let o=s;if(t.trim()){const i=t.toLowerCase();o=s.filter(l=>l.name.toLowerCase().includes(i)||l.description?.toLowerCase().includes(i))}return o.sort((i,l)=>{if(a){if(i.id===a&&l.id!==a)return-1;if(l.id===a&&i.id!==a)return 1}return i.messageCount!==l.messageCount?l.messageCount-i.messageCount:i.name.localeCompare(l.name)})},[s,t,a]);return{searchQuery:t,setSearchQuery:n,filteredChannels:r}}function df({contexts:s,fallbackChannelId:t,getChannelName:n,channelsLength:a}){const r=m.useMemo(()=>{const l=s;if(!l)return`Auto (${n(t)})`;if(l.mode===Y.NONE)return"No Context";if(l.mode===Y.ALL)return"All Spaces";const c=l.channelIds||[];return c.length===0?"No Context":(c.length===1,n(c[0]))},[s,t,n]),o=m.useMemo(()=>{const l=s;if(!l||l.mode!==Y.CHANNELS)return 0;const c=l.channelIds||[];return Math.max(0,c.length-1)},[s]),i=m.useMemo(()=>{const l=s;return l?l.mode===Y.NONE?0:l.mode===Y.ALL?a:(l.channelIds||[]).length:1},[s,a]);return{label:r,otherCount:o,totalCount:i}}function uf({variant:s,label:t,tooltip:n,totalCount:a,anyLoading:r,conv:o,showModeNameInCompact:i=!1,modeName:l}){return s==="compact"?e.jsxs("div",{className:"relative h-8 w-8 inline-flex items-center justify-center",children:[(()=>{const c=o?.contexts;return c?c.mode===Y.NONE?e.jsx(Xa,{className:"w-4 h-4"}):c.mode===Y.ALL?e.jsx(an,{className:"w-4 h-4"}):c.mode===Y.CHANNELS?e.jsx(Ja,{className:"w-4 h-4"}):e.jsx(Zn,{className:"w-4 h-4"}):e.jsx(tt,{className:"w-4 h-4"})})(),a>0&&e.jsx("span",{className:"absolute top-0 right-0.5 min-w-[14px] h-3 px-1 rounded-full bg-muted text-foreground/80 text-[10px] leading-3 flex items-center justify-center",children:a}),e.jsx("span",{className:"absolute bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full "+(r?"bg-primary animate-pulse":"bg-emerald-500")})]}):e.jsxs("div",{className:"relative inline-flex items-center gap-1.5 text-sm",children:[(()=>{const c=o?.contexts;return!c||c.mode===Y.AUTO?e.jsx(tt,{className:"w-4 h-4 text-muted-foreground/70"}):c.mode===Y.NONE?e.jsx(Xa,{className:"w-4 h-4 text-muted-foreground/70"}):c.mode===Y.ALL?e.jsx(an,{className:"w-4 h-4 text-muted-foreground/70"}):c.mode===Y.CHANNELS?e.jsx(Ja,{className:"w-4 h-4 text-muted-foreground/70"}):e.jsx(Zn,{className:"w-4 h-4 text-muted-foreground/70"})})(),e.jsx("span",{className:"font-medium text-foreground/90 truncate max-w-[10rem]",children:t}),a>0&&e.jsx("span",{className:"min-w-[18px] h-4 px-1.5 rounded-full bg-muted text-foreground/80 text-[10px] leading-4 flex items-center justify-center",children:a}),e.jsx("span",{className:"w-1.5 h-1.5 rounded-full "+(r?"bg-primary animate-pulse":"bg-emerald-500")})]})}function Pn({mode:s,currentMode:t,icon:n,title:a,description:r,onClick:o,showChevron:i=!1,isExpanded:l=!1}){const c=t===s;return e.jsxs("div",{className:E("flex items-center gap-2.5 px-2.5 py-2 rounded-lg cursor-pointer transition-all duration-200",c?"bg-primary/8 text-primary":"hover:bg-accent/30 text-foreground"),onClick:o,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("div",{className:E("transition-colors",c?"text-primary":"text-muted-foreground"),children:n}),e.jsx("span",{className:"text-sm font-medium",children:a})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground/70",children:r}),i&&e.jsx(st,{className:E("w-3.5 h-3.5 text-muted-foreground/60 transition-all duration-200",l?"rotate-180":"")})]})]})}function mf({searchQuery:s,setSearchQuery:t,filteredChannels:n,draftChannelIds:a,toggleChannel:r,fallbackChannelId:o}){const{t:i}=L();return e.jsxs("div",{className:"bg-muted/35 border border-muted/50 rounded-lg shadow-sm transition-all",children:[e.jsx("div",{className:"p-2.5 border-b border-muted/45 bg-muted/15",children:e.jsxs("div",{className:"relative",children:[e.jsx(Je,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground/60"}),e.jsx(Oe,{placeholder:i("aiAssistant.contextControl.searchSpaces"),value:s,onChange:l=>t(l.target.value),className:"pl-9 h-7 text-sm border-0 bg-background/95 focus:bg-background focus:ring-1 focus:ring-primary/20"})]})}),e.jsx("div",{className:"max-h-32 overflow-y-auto",children:n.length===0?e.jsxs("div",{className:"text-center py-6",children:[e.jsx("div",{className:"text-muted-foreground/50 mb-1.5 text-lg",children:s?"ðŸ”":"ðŸ“"}),e.jsx("div",{className:"text-xs text-muted-foreground/70",children:i(s?"aiAssistant.contextControl.noSpacesFound":"aiAssistant.contextControl.noSpacesAvailable")})]}):e.jsx("div",{className:"p-1.5 space-y-0.5",children:n.map(l=>{const c=a.includes(l.id),d=l.id===o;return e.jsxs("div",{className:E("flex items-center gap-2.5 px-2.5 py-1.5 rounded-lg text-sm transition-all duration-200 cursor-pointer",c?"bg-primary/6 text-primary":"hover:bg-accent/25 text-foreground"),onClick:()=>r(l.id),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("span",{className:"text-sm",children:l.emoji||"ðŸ“"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:l.name}),d&&e.jsx("div",{className:"text-xs text-primary/80",children:i("aiAssistant.contextControl.currentSpace")})]})]}),c&&e.jsx(Xe,{className:"w-4 h-4 text-primary"})]},l.id)})})})]})}function hf({activeToolChannelId:s,draftChannelIds:t,onActiveToolChannelChange:n,getChannelName:a}){const{t:r}=L();return e.jsxs("div",{className:"p-2.5 rounded-lg bg-muted/35 border border-muted/50 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Zn,{className:"w-4 h-4 text-muted-foreground/70"}),e.jsx("span",{className:"text-sm font-medium text-foreground/90",children:r("aiAssistant.contextControl.activeToolSpace")})]}),e.jsxs("select",{value:s&&t.includes(s)?s:t[0]||"",onChange:o=>n(o.target.value||null),className:"w-full h-7 px-2.5 rounded-lg border-0 bg-background/95 text-sm focus:bg-background focus:ring-1 focus:ring-primary/20 transition-all duration-200",children:[t.length===0&&e.jsx("option",{value:"",children:r("aiAssistant.contextControl.none")}),t.map(o=>e.jsx("option",{value:o,children:a(o)},o))]})]})}function gf({conversationId:s,fallbackChannelId:t,onActiveToolChannelChange:n,activeToolChannelId:a,variant:r="inline",className:o,showModeNameInCompact:i=!1}){const{t:l}=L(),[c,d]=m.useState(!1),u=se($=>$.conversations.find(H=>H.id===s)),{channels:h}=O(),g=m.useCallback($=>h.find(H=>H.id===$)?.name||$,[h]),{draftMode:x,setDraftMode:f,draftChannelIds:p,toggleChannel:b,apply:v}=af({conversationId:s,fallbackChannelId:t,onActiveToolChannelChange:n,activeToolChannelId:a}),{searchQuery:y,setSearchQuery:w,filteredChannels:N}=cf(h),{anyLoading:S,tooltip:j}=lf({conversationId:s,fallbackChannelId:t,contexts:u?.contexts,getChannelName:g}),{label:C,totalCount:I}=df({contexts:u?.contexts,fallbackChannelId:t,getChannelName:g,channelsLength:h.length}),[k,T]=m.useState(x===Y.CHANNELS),z=E(r==="banner"?"flex items-center gap-2 px-3 py-2 border-b bg-background/60":r==="compact"?"inline-flex items-center":"inline-flex items-center gap-1",o),D=()=>{const $=u?.contexts;return!$||$.mode===Y.AUTO?l("aiAssistant.contextControl.mode.auto"):$.mode===Y.NONE?l("aiAssistant.contextControl.mode.none"):$.mode===Y.ALL?l("aiAssistant.contextControl.mode.all"):$.mode===Y.CHANNELS?l("aiAssistant.contextControl.mode.custom"):l("aiAssistant.contextControl.mode.auto")};return e.jsx("div",{className:z,children:e.jsxs(Q,{open:c,onOpenChange:d,modal:!0,children:[e.jsx(Q.Trigger,{asChild:!0,children:e.jsxs("div",{className:"flex items-center gap-0.5 h-8 rounded-md bg-transparent hover:bg-accent/50 text-muted-foreground hover:text-foreground transition-colors duration-200",children:[e.jsx(uf,{variant:r,label:C,tooltip:j,totalCount:I,anyLoading:S,conv:u,showModeNameInCompact:i,modeName:D()}),(r!=="compact"||i)&&e.jsxs("div",{className:"flex items-center gap-0.5 pr-2",children:[e.jsx("span",{className:"text-sm font-medium",children:D()}),e.jsx(st,{className:"w-3 h-3 opacity-50"})]})]})}),e.jsxs(Q.Content,{width:"w-80",align:"center",side:"bottom",children:[e.jsxs(Q.Header,{children:[e.jsx(Zn,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:l("aiAssistant.contextControl.title")}),e.jsx(Q.Button,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:()=>d(!1),title:l("common.close"),children:e.jsx(fe,{className:"h-3 w-3"})})]}),e.jsxs(Q.Body,{children:[S&&e.jsx("div",{className:"mb-3 p-2.5 rounded-lg bg-primary/6",children:e.jsxs("div",{className:"flex items-center gap-2 text-xs text-primary/90",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-primary animate-pulse"}),e.jsx("span",{children:l("aiAssistant.contextControl.loading")})]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Pn,{mode:Y.AUTO,currentMode:x,icon:e.jsx(tt,{className:"w-4 h-4 text-muted-foreground"}),title:l("aiAssistant.contextControl.mode.auto"),description:l("aiAssistant.contextControl.mode.autoDescription"),onClick:()=>{f(Y.AUTO),T(!1)}}),e.jsx(Pn,{mode:Y.NONE,currentMode:x,icon:e.jsx(Xa,{className:"w-4 h-4 text-muted-foreground"}),title:l("aiAssistant.contextControl.mode.none"),description:l("aiAssistant.contextControl.mode.noneDescription"),onClick:()=>{f(Y.NONE),T(!1)}}),e.jsx(Pn,{mode:Y.ALL,currentMode:x,icon:e.jsx(an,{className:"w-4 h-4 text-muted-foreground"}),title:l("aiAssistant.contextControl.mode.all"),description:l("aiAssistant.contextControl.mode.allDescription"),onClick:()=>{f(Y.ALL),T(!1)}}),e.jsx(Pn,{mode:Y.CHANNELS,currentMode:x,icon:e.jsx(Ja,{className:"w-4 h-4 text-muted-foreground"}),title:l("aiAssistant.contextControl.mode.custom"),description:l("aiAssistant.contextControl.mode.customDescription"),showChevron:!0,isExpanded:k,onClick:()=>{x===Y.CHANNELS?T(!k):(f(Y.CHANNELS),T(!0))}}),k&&e.jsx(mf,{searchQuery:y,setSearchQuery:w,filteredChannels:N,draftChannelIds:p,toggleChannel:b,fallbackChannelId:t}),x===Y.CHANNELS&&n&&e.jsx(hf,{activeToolChannelId:a||null,draftChannelIds:p,onActiveToolChannelChange:n,getChannelName:g})]})]}),e.jsxs(Q.Actions,{children:[e.jsx(Q.Button,{type:"button",variant:"outline",onClick:()=>d(!1),children:l("common.cancel")}),e.jsx(Q.Button,{type:"button",variant:"default",onClick:()=>{v(),d(!1)},children:l("aiAssistant.contextControl.applyChanges")})]})]})]})})}const Xl=_e()(Xt((s,t)=>{const n=xr();return{selectedModelId:n.id,selectedModel:n,setSelectedModel:a=>{const r=xs.find(o=>o.id===a);r&&s({selectedModelId:a,selectedModel:r})},getSelectedModel:()=>t().selectedModel}},{name:"model-selection-storage",partialize:s=>({selectedModelId:s.selectedModelId}),onRehydrateStorage:()=>s=>{if(s){const t=xs.find(n=>n.id===s.selectedModelId);if(t)s.selectedModel=t;else{const n=xr();s.selectedModelId=n.id,s.selectedModel=n}}}}));class pf{agent=null;getAgent(){if(!this.agent){const{getSelectedModel:t}=Xl.getState(),n=t();this.agent=new Dn({apiKey:n.apiKey,model:n.model,temperature:n.temperature,maxTokens:n.maxTokens,baseURL:n.apiUrl})}return this.agent}updateAgentConfig(t){this.agent||(this.agent=new Dn),this.agent.setConfig({apiKey:t.apiKey,model:t.model,temperature:t.temperature,maxTokens:t.maxTokens,baseURL:t.apiUrl})}createAgentWithModel(t){return new Dn({apiKey:t.apiKey,model:t.model,temperature:t.temperature,maxTokens:t.maxTokens,baseURL:t.apiUrl})}createAgentWithConfig(t){const n=xr();return new Dn({apiKey:t.apiKey||n.apiKey,model:t.model||n.model,temperature:t.temperature??n.temperature,maxTokens:t.maxTokens??n.maxTokens,baseURL:t.baseURL||n.apiUrl})}getChannelTools(){return Gp.getChannelTools()}getChannelContext(t){return Yp.getChannelContext(t)}getSessionContexts(t,n){return Yr.getSessionContexts(t,n)}}const Gn=new pf,ff=({draft:s,setDraft:t,props:n})=>{const{selectedModelId:a,setSelectedModel:r}=Xl(),o=s.meta?.modelId,i=l=>{const c=Vr(l);c&&(r(l),Gn.updateAgentConfig(c),t({...s,meta:{...s.meta,modelId:l,modelConfig:{apiKey:c.apiKey,model:c.model,apiUrl:c.apiUrl,temperature:c.temperature,maxTokens:c.maxTokens}}}),n.onModelChange?.(l))};return e.jsx(dp,{selectedModelId:o||a||n.selectedModelId,onModelChange:i,className:n.className})},xf=s=>({id:"model-selector",placement:"bottom-left",render:({draft:t,setDraft:n})=>e.jsx(ff,{draft:t,setDraft:n,props:s}),beforeSend:async t=>{const n=t.meta?.modelId;if(n){const a=Vr(n);if(a)return{...t,meta:{...t.meta,modelConfig:{apiKey:a.apiKey,model:a.model,apiUrl:a.apiUrl,temperature:a.temperature,maxTokens:a.maxTokens}}}}return t}}),bf=({props:s})=>e.jsx(gf,{conversationId:s.conversationId,fallbackChannelId:s.fallbackChannelId,onActiveToolChannelChange:s.onActiveToolChannelChange,activeToolChannelId:s.activeToolChannelId,variant:"compact",className:s.className,showModeNameInCompact:s.showModeNameInCompact}),vf=s=>({id:"context-selector",placement:"bottom-left",render:({draft:t,setDraft:n})=>e.jsx(bf,{draft:t,setDraft:n,props:s})}),K=({className:s,children:t})=>t?e.jsx("div",{className:E("animate-pulse",s),children:t}):e.jsx("div",{className:E("animate-pulse rounded-md bg-slate-200 dark:bg-slate-700",s)});function Xr(){return e.jsxs("div",{className:"h-full w-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(K,{className:"w-8 h-8 rounded-full"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(K,{className:"h-4 w-32"}),e.jsx(K,{className:"h-3 w-24"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{className:"w-8 h-8 rounded-md"}),e.jsx(K,{className:"w-8 h-8 rounded-md"})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(K,{className:"w-8 h-8 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{className:"h-4 w-16"}),e.jsx(K,{className:"h-3 w-20"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{className:"h-4 w-full"}),e.jsx(K,{className:"h-4 w-5/6"}),e.jsx(K,{className:"h-4 w-3/4"}),e.jsx(K,{className:"h-4 w-2/3"})]})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 justify-end",children:[e.jsxs("div",{className:"flex-1 space-y-2 min-w-0 max-w-[80%]",children:[e.jsxs("div",{className:"flex items-center space-x-2 justify-end",children:[e.jsx(K,{className:"h-3 w-20"}),e.jsx(K,{className:"h-4 w-16"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{className:"h-4 w-full"}),e.jsx(K,{className:"h-4 w-4/5"})]})]}),e.jsx(K,{className:"w-8 h-8 rounded-full flex-shrink-0"})]}),e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(K,{className:"w-8 h-8 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{className:"h-4 w-16"}),e.jsx(K,{className:"h-3 w-20"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{className:"h-4 w-full"}),e.jsx(K,{className:"h-4 w-4/5"}),e.jsx(K,{className:"h-4 w-3/4"})]})]})]})]}),e.jsx("div",{className:"p-4 border-t border-border",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{className:"flex-1 h-10 rounded-md"}),e.jsx(K,{className:"w-10 h-10 rounded-md"})]})})]})}function wf({count:s=5}){return e.jsxs("div",{className:"h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsx(K,{className:"h-6 w-32"}),e.jsx(K,{className:"w-8 h-8 rounded-md"})]}),e.jsx("div",{className:"flex-1 overflow-hidden p-4 space-y-3",children:Array.from({length:s}).map((t,n)=>e.jsx("div",{className:"p-3 border border-border rounded-lg",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{className:"h-4 w-3/4"}),e.jsx(K,{className:"h-3 w-1/2"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(K,{className:"h-3 w-20"}),e.jsx(K,{className:"h-3 w-16"})]})]})},n))}),e.jsx("div",{className:"p-4 border-t border-border",children:e.jsx(K,{className:"w-full h-10 rounded-md"})})]})}function Jl({conversationId:s,channelId:t}){const{messages:n,createMessage:a,updateMessage:r,loading:o}=ap(s),i=se(x=>x.conversations.find(f=>f.id===s)),l=se(x=>x.conversations),c=!!i&&i.messageCount===0,d=l.filter(x=>!x.id.startsWith("temp-")).length===1&&c,u=o&&!c,h=m.useRef(s),g=m.useMemo(()=>{const x=h.current;if(x!==s)return h.current=s,Hl(x)?x:s},[s]);return e.jsx("div",{className:"h-full flex flex-col bg-background",children:e.jsx("div",{className:"flex-1 overflow-hidden",children:u?e.jsx(Xr,{}):e.jsx(yf,{conversationId:s,channelId:t,messages:n,createMessage:a,updateMessage:r,isFirstConversation:d},g)})})}function yf({conversationId:s,channelId:t,messages:n,createMessage:a,updateMessage:r,isFirstConversation:o}){const{isMobile:i}=ll(),{t:l}=L(),c=m.useMemo(()=>Gn.getAgent(),[]),d=m.useMemo(()=>Gn.getChannelTools(),[]),{toolDefs:u,toolExecutors:h,toolRenderers:g}=Im(d),x=m.useMemo(()=>()=>{const S=Gn.getSessionContexts(s,t);return o?[{description:"Product Information & First Session Guide",value:JSON.stringify({welcomeMessage:"This is the user's first AI conversation. Please DEMONSTRATE your agent capabilities by actively using tools to show what you can do.",productInfo:{name:"StillRoot",purpose:"A personal growth companion platform that helps users become who they want to be",coreFeatures:["Personal Growth Guidance: Monitor progress, identify problems in thinking and behavior, provide specific improvement suggestions","Deep Understanding: Help users dig deeper from surface phenomena to underlying essence and patterns","Insight Discovery: Analyze connections between notes, discover knowledge blind spots, provide new insights","Note Management: Create, read, update, and organize notes across channels with AI assistance"],valueProposition:"StillRoot helps users track thoughts, discover patterns, and grow personally through AI-powered analysis of their notes and ideas.",mission:"Help users become who they want to be through cognitive enhancement and personal growth supervision"},engagementStrategy:"Be enthusiastic, show value by USING TOOLS, demonstrate capabilities, and encourage exploration. Make them feel excited about using StillRoot regularly.",demonstrationRequirements:["You MUST actively use at least 2-3 tools to demonstrate your capabilities","Use listNotes to show you can access their notes and provide insights","Use grepNotes to search their notes and find patterns or interesting content","Analyze their notes to provide meaningful insights","Show excitement about their data and suggest ways to explore it","CRITICAL: Call tools ONE AT A TIME. Wait for each tool to complete before calling the next one. Do not send multiple tool calls in parallel.","For example, first call listNotes, wait for results, then call grepNotes, wait for results, then analyze"],suggestedApproach:["Greet them warmly as their personal growth companion","Briefly introduce StillRoot's mission and your role","IMMEDIATELY start using tools (listNotes, grepNotes, etc.) to demonstrate your capabilities","Show actual insights from their notes, even if they're just starting out","Highlight the value of having AI-powered analysis of their thoughts","Invite them to try asking questions or exploring specific topics","Be encouraging and show enthusiasm about helping them grow"]})},...S]:S},[s,t,o]),f=m.useMemo(()=>o&&!Hl(s)&&n.length===0?[{id:`welcome-${s}`,role:"user",parts:[{type:"text",text:l("aiAssistant.prompts.firstConversationWelcome")}]}]:n,[o,s,n,l]),p=Tm({agent:c,getToolDefs:()=>u,getContexts:x,initialMessages:f,getToolExecutor:S=>h[S]}),b=m.useRef(!1);m.useEffect(()=>{o&&(b.current||(b.current=!0,p.runAgent()))},[o,s,p]);const v=rn(a),y=rn(r);m.useEffect(()=>{const S=p.addMessagesEvent$.subscribe(({messages:j})=>{j.forEach(async C=>{await v(C)})});return()=>S.unsubscribe()},[p.addMessagesEvent$,v]),m.useEffect(()=>{const S=p.updateMessageEvent$.pipe(os(({message:j})=>j),fm(j=>j.id),Ji(j=>j.pipe(rr(300),xa((C,I)=>Am(C,I))))).subscribe(j=>{y(j).catch(()=>{})});return()=>S.unsubscribe()},[p.updateMessageEvent$,y]),m.useEffect(()=>{const S=p.messages$.pipe(rr(100)).subscribe(j=>{se.getState().onMessagesSnapshot(s,j)});return()=>S.unsubscribe()},[p,s]);const w=m.useMemo(()=>[vf({conversationId:s,fallbackChannelId:t,showModeNameInCompact:!i}),xf({onModelChange:S=>{console.log("Model changed to:",S)}})],[s,t,i]),N=m.useMemo(()=>[{id:"prompt-1",prompt:l("aiAssistant.prompts.defaultPrompts.analyzeNotes")},{id:"prompt-2",prompt:l("aiAssistant.prompts.defaultPrompts.summarizeThoughts")},{id:"prompt-3",prompt:l("aiAssistant.prompts.defaultPrompts.findPatterns")},{id:"prompt-4",prompt:l("aiAssistant.prompts.defaultPrompts.organizeIdeas")},{id:"prompt-5",prompt:l("aiAssistant.prompts.defaultPrompts.whatMissing")},{id:"prompt-6",prompt:l("aiAssistant.prompts.defaultPrompts.suggestImprovements")}],[l]);return e.jsx("div",{className:"h-full flex flex-col agent-chat-fullwidth",children:e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(Em,{agentChatController:p,toolRenderers:g,className:"h-full w-full",messageItemProps:{showAvatar:!1},promptsProps:{items:N,onItemClick:({prompt:S})=>{p.handleAddMessages([{id:crypto.randomUUID(),role:"user",parts:[{type:"text",text:S}]}],{triggerAgent:!0}).catch(()=>{})}},inputExtensions:w})})})}function Zl({onCreate:s}){const{t}=L();return e.jsx("div",{className:"flex-1 flex items-center justify-center p-6",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx("svg",{className:"w-8 h-8 text-primary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"})})}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:t("aiAssistant.emptyPane.title")}),e.jsx("p",{className:"text-muted-foreground text-sm leading-relaxed",children:t("aiAssistant.emptyPane.description")})]}),e.jsx("div",{className:"space-y-3 mb-6",children:e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("p",{className:"font-medium",children:t("aiAssistant.emptyPane.tryAsking")}),e.jsxs("p",{children:['"',t("aiAssistant.emptyPane.example1"),'"']}),e.jsxs("p",{children:['"',t("aiAssistant.emptyPane.example2"),'"']}),e.jsxs("p",{children:['"',t("aiAssistant.emptyPane.example3"),'"']})]})}),e.jsx("button",{onClick:s,className:"inline-flex h-10 items-center justify-center whitespace-nowrap rounded-md px-4 text-sm font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90",children:t("aiAssistant.emptyPane.startConversation")})]})})}function Ql({currentConversationId:s,channelId:t,hasConversations:n,onClose:a}){const{createConversation:r}=bn(),{userId:o}=O();return s?e.jsx(Jl,{conversationId:s,channelId:t,onClose:a}):n?e.jsx("div",{className:"flex-1"}):e.jsx(Zl,{onCreate:()=>{o&&r(o,"")}})}function jf({conversations:s,currentConversationId:t,loading:n,channelId:a,onClose:r}){const o=s.length>0;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-80 flex flex-col",children:e.jsx(Gr,{conversations:s,currentConversationId:t,loading:n,withHeader:!1})}),e.jsx("div",{className:"flex-1 flex flex-col",children:e.jsx(Ql,{currentConversationId:t,channelId:a,hasConversations:o,onClose:r})})]})}const Nf=m.forwardRef(function({conversations:t,currentConversationId:n,loading:a,channelId:r,onClose:o},i){const l=se(h=>h.uiView),c=se(h=>h.showList),d=se(h=>h.showChat),u=t.length>0;return m.useImperativeHandle(i,()=>({showList:()=>c(),showChat:()=>d()}),[c,d]),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"absolute inset-0 flex flex-col "+(l==="list"?"":"hidden"),children:e.jsx(Gr,{conversations:t,currentConversationId:n,loading:a,withHeader:!1})}),e.jsx("div",{className:"absolute inset-0 flex flex-col "+(l==="chat"?"":"hidden"),children:e.jsx(Ql,{currentConversationId:n,channelId:r,hasConversations:u,onClose:o})})]})}),Cf=m.forwardRef(function({channelId:t,onClose:n},a){const{userId:r}=O(),{conversations:o,currentConversationId:i,loading:l,createConversation:c,loadConversations:d,resetForLoggedOut:u}=bn(),h=m.useRef(null),{mode:g,ready:x}=tp(h,{sidebar:320,chatMin:520,hysteresis:12,debounceMs:80}),f=g==="single-pane",p=m.useRef(null),b=m.useCallback(()=>{r&&c(r,"")},[r,c]);return m.useImperativeHandle(a,()=>({showList:()=>p.current?.showList(),showChat:()=>p.current?.showChat(),createNew:()=>b(),isSinglePane:()=>f}),[f,b]),m.useEffect(()=>{if(!r){u();return}d(r)},[r,d,u]),l||!x?e.jsx("div",{ref:h,className:"h-full flex "+(x?"":"invisible"),children:e.jsx(Xr,{})}):e.jsx("div",{ref:h,className:"h-full flex "+(x?"":"invisible"),children:g==="two-pane"?e.jsx(jf,{conversations:o,currentConversationId:i,loading:l,channelId:t,onClose:n}):e.jsx(Nf,{ref:p,conversations:o,currentConversationId:i,loading:l,channelId:t,onClose:n})})});function kf({isOpen:s,onClose:t,channelId:n}){const{t:a}=L(),{userId:r}=O(),o=m.useRef(null),{currentConversation:i,createConversation:l}=bn(),c=se(h=>h.uiView),d=se(h=>h.titleGeneratingMap);if(!s)return null;const u=()=>c==="list"?a("aiAssistant.sidebar.conversations"):i?d[i.id]?a("aiAssistant.conversationList.generatingTitle"):i.title||a("aiAssistant.sidebar.aiConversations"):a("aiAssistant.sidebar.aiConversations");return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"px-3 py-2 bg-background",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2 min-w-0",children:e.jsx("h3",{className:"font-semibold text-foreground truncate",children:u()})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(M,{variant:"ghost",size:"icon",onClick:()=>{const h=o.current;h&&h.isSinglePane()&&h.showList()},"aria-label":a("aiAssistant.sidebar.conversations"),children:e.jsx(Li,{className:"w-5 h-5"})}),e.jsx(M,{variant:"ghost",size:"icon",onClick:()=>{r&&l(r,"")},"aria-label":a("aiAssistant.sidebar.newConversation"),children:e.jsx($e,{className:"w-5 h-5"})}),e.jsx(M,{variant:"ghost",size:"icon",onClick:t,"aria-label":a("common.close"),children:e.jsx(fe,{className:"w-5 h-5"})})]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(Cf,{ref:o,channelId:n,onClose:t})})]})}function Jr({onSelect:s,children:t}){const[n,a]=m.useState(!1),[r,o]=m.useState(!1);m.useEffect(()=>{const l=()=>{const u=document.documentElement.classList.contains("dark")||window.matchMedia("(prefers-color-scheme: dark)").matches;o(u)};l();const c=new MutationObserver(l);c.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]});const d=window.matchMedia("(prefers-color-scheme: dark)");return d.addEventListener("change",l),()=>{c.disconnect(),d.removeEventListener("change",l)}},[]);const i=l=>{s(l.emoji),a(!1)};return e.jsxs(Q,{open:n,onOpenChange:a,children:[e.jsx(Q.Trigger,{asChild:!0,children:t}),e.jsx(Q.Content,{align:"start",sideOffset:8,className:"p-0",children:e.jsx("div",{className:"w-80",children:e.jsx(Rm,{onEmojiClick:i,autoFocusSearch:!1,searchDisabled:!1,skinTonesDisabled:!1,width:"100%",height:350,theme:r?Co.DARK:Co.LIGHT,previewConfig:{showPreview:!1},searchPlaceHolder:"Search emojis...",defaultSkinTone:Dm.NEUTRAL,emojiStyle:Lm.NATIVE,lazyLoadEmojis:!0})})})]})}function wt({className:s,...t}){return e.jsx(xd,{"data-slot":"label",className:E("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",s),...t})}function Ps({className:s,...t}){return e.jsx("textarea",{"data-slot":"textarea",className:E("border-input placeholder:text-muted-foreground aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),...t})}function mn({trigger:s,variant:t="popover",instantCreate:n=!1,defaultName:a}){const{t:r}=L(),o=ve(),[i,l]=m.useState(!1),[c,d]=m.useState(""),[u,h]=m.useState(""),[g,x]=m.useState(cr()),f=a||r("channelManagement.createChannel.untitled"),p=async I=>{await o.channelManager.addChannel(I),De.logChannelCreate(I.name,I.name,!!I.description)},b=I=>{I&&I.preventDefault(),c.trim()&&(p({name:c.trim(),description:u.trim(),emoji:g?.trim()||void 0}),l(!1))},v=async()=>{await p({name:f,description:"",emoji:void 0})},y=()=>{d(""),h(""),l(!1)},w=I=>{I.key==="Enter"&&c.trim()?(I.preventDefault(),b()):I.key==="Escape"&&(I.preventDefault(),y())},N=I=>{l(I),I&&(d(""),h(""),x(cr()))},S=e.jsxs(M,{variant:"outline",className:"w-full h-10 text-muted-foreground hover:text-foreground border-dashed",onClick:n?v:void 0,children:[e.jsx($e,{className:"w-4 h-4 mr-2"}),r("channelManagement.createChannel.newSpace")]}),j=e.jsxs("div",{className:"space-y-4 pb-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{htmlFor:"emoji",children:r("channelManagement.createChannel.emoji")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Jr,{onSelect:x,children:e.jsx(M,{type:"button",variant:"outline",size:"sm",className:"h-10 w-16 text-sm",children:g||r("channelManagement.createChannel.select")})}),g&&e.jsx(M,{type:"button",variant:"ghost",size:"sm",onClick:()=>x(""),className:"h-10 px-2 text-muted-foreground",children:r("common.clear")})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{htmlFor:"name",children:r("channelManagement.createChannel.name")}),e.jsx(Oe,{id:"name",value:c,onChange:I=>d(I.target.value),onKeyDown:w,placeholder:r("channelManagement.createChannel.namePlaceholder"),required:!0,autoFocus:t==="popover"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{htmlFor:"description",children:r("channelManagement.createChannel.description")}),t==="dialog"?e.jsx(Ps,{id:"description",value:u,onChange:I=>h(I.target.value),placeholder:r("channelManagement.createChannel.descriptionPlaceholder"),rows:3}):e.jsx(Oe,{id:"description",value:u,onChange:I=>h(I.target.value),onKeyDown:w,placeholder:r("channelManagement.createChannel.descriptionPlaceholderShort")})]})]}),C=e.jsxs(e.Fragment,{children:[e.jsx(Q.Button,{type:"button",variant:"outline",onClick:y,children:r("common.cancel")}),e.jsx(Q.Button,{type:"submit",variant:"default",disabled:!c.trim(),onClick:b,children:r("channelManagement.createChannel.createSpace")})]});if(n){if(s){if(m.isValidElement(s)){const I=s.props.onClick,k=async T=>{I?.(T),await v()};return m.cloneElement(s,{onClick:k})}return e.jsx("span",{onClick:v,children:s})}return S}return t==="dialog"?e.jsxs(Jt,{open:i,onOpenChange:N,children:[e.jsx(cl,{asChild:!0,children:s??S}),e.jsxs(Zt,{className:"sm:max-w-md",children:[e.jsxs(Ds,{children:[e.jsx(_s,{children:r("channelManagement.createChannel.title")}),e.jsx(wa,{children:r("channelManagement.createChannel.descriptionText")})]}),e.jsxs("form",{onSubmit:b,children:[j,e.jsx(Or,{className:"gap-2 pt-4",children:C})]})]})]}):e.jsxs(Q,{open:i,onOpenChange:N,children:[e.jsx(Q.Trigger,{asChild:!0,children:s??S}),e.jsxs(Q.Content,{align:"center",side:"bottom",children:[e.jsxs(Q.Header,{children:[e.jsx($e,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:r("channelManagement.createChannel.title")})]}),e.jsx(Q.Body,{children:j}),e.jsx(Q.Actions,{children:C})]})]})}const Zr=()=>{const s=O(l=>l.channels),t=O(l=>l.userId),n=O(l=>l.channelsLoading),a=J(l=>l.hasHydrated),r=J(l=>l.setCurrentChannel),o=J(l=>l.currentChannelId),i=J(l=>l.lastChannelIdByUserId);m.useEffect(()=>{if(!a||!t)return;if(!o){const d=i[t];d&&r(d)}if(n||s.length===0||!!o&&s.some(d=>d.id===o))return;const c=t?i[t]:void 0;if(c&&s.some(d=>d.id===c)){r(c);return}r(s[0].id)},[s,n,o,a,i,r,t])};function zo(s){const t=s.lastMessageTime?.getTime(),n=s.updatedAt?.getTime(),a=s.createdAt?.getTime?.()?s.createdAt.getTime():0;return t??n??a??0}function Qr(s){return[...s].sort((t,n)=>zo(n)-zo(t))}function eo(s,t){const n=Qr(s),a=n.findIndex(r=>r.id===t);if(a>0){const[r]=n.splice(a,1);n.unshift(r)}return n}const Ho={general:tt,work:ou,study:ru,ideas:fn,personal:Ai,goals:au,team:Rr,default:Di},ec=s=>{const t=Ho[s]||Ho.default;return e.jsx(t,{className:"w-4 h-4"})};function Sf({children:s,trigger:t,triggerClassName:n,contentClassName:a,align:r="end",sideOffset:o=4,width:i="md",alwaysVisible:l=!1}){const{t:c}=L(),d={sm:"w-44",md:"w-52",lg:"w-60",xl:"w-72"},u=e.jsxs(M,{variant:"ghost",size:"sm",className:E("h-8 w-8 p-0 transition-all duration-200 rounded-md","text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200","hover:bg-slate-200/60 dark:hover:bg-slate-700/60","focus:outline-none",l?"opacity-100":"opacity-0 group-hover:opacity-100",n),children:[e.jsx(ma,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:c("common.moreActions")})]});return e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:t||u}),e.jsx(mt,{align:r,className:E("p-1 rounded-xl bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl","min-w-[200px] max-w-[280px]","shadow-[0_0_0_1px_rgba(0,0,0,0.05),0_10px_15px_-3px_rgba(0,0,0,0.1),0_4px_6px_-2px_rgba(0,0,0,0.05)] dark:shadow-[0_0_0_1px_rgba(255,255,255,0.1),0_10px_15px_-3px_rgba(0,0,0,0.3),0_4px_6px_-2px_rgba(0,0,0,0.1)]",d[i],a),sideOffset:o,children:s})]})}function tc({icon:s,title:t,description:n,onClick:a,variant:r="default",disabled:o=!1,className:i}){const l={default:"text-slate-700 dark:text-slate-200 hover:text-slate-900 dark:hover:text-slate-100 hover:bg-slate-50/40 dark:hover:bg-slate-800/30",destructive:"text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 hover:bg-red-50/40 dark:hover:bg-red-900/5",warning:"text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300 hover:bg-amber-50/40 dark:hover:bg-amber-900/5"},c={default:"text-slate-500 dark:text-slate-400",destructive:"text-red-500 dark:text-red-400",warning:"text-amber-500 dark:text-amber-400"};return e.jsxs(Lt,{onClick:o?void 0:a,disabled:o,className:E("flex items-center gap-3 px-3 py-2.5 cursor-pointer transition-all duration-100 group","rounded-lg text-sm font-medium",l[r],o&&"opacity-50 cursor-not-allowed",i),children:[e.jsx("div",{className:E("w-4 h-4 flex-shrink-0 transition-all duration-100",c[r],"group-hover:scale-110 group-hover:rotate-1"),children:s}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"truncate",children:t}),n&&e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400 truncate mt-0.5",children:n})]})]})}function sc({title:s,children:t,variant:n="default",showSeparator:a=!0,className:r}){const o={default:"text-slate-500 dark:text-slate-400",warning:"text-amber-500 dark:text-amber-400",danger:"text-red-500 dark:text-red-400"};return e.jsxs(e.Fragment,{children:[a&&e.jsx(Dt,{className:"my-1 bg-slate-200/50 dark:bg-slate-700/50"}),e.jsxs(op,{className:E("space-y-0.5",r),children:[s&&e.jsx(Wr,{className:E("px-3 py-1.5 text-xs font-medium text-slate-500 dark:text-slate-400",o[n]),children:s}),t]})]})}function nc({groups:s,trigger:t,triggerClassName:n,contentClassName:a,align:r="end",sideOffset:o=4,width:i="md",alwaysVisible:l=!1}){const c=s.map(d=>({...d,items:d.items.filter(u=>!u.hidden)})).filter(d=>d.items.length>0);return e.jsx(Sf,{trigger:t,triggerClassName:n,contentClassName:a,align:r,sideOffset:o,width:i,alwaysVisible:l,children:c.map((d,u)=>e.jsx(sc,{title:d.title,variant:d.variant,showSeparator:d.showSeparator!==!1&&u>0,children:d.items.map(h=>e.jsx(tc,{icon:h.icon,title:h.title,description:h.description,onClick:h.onClick,variant:h.variant,disabled:h.disabled},h.id))},d.id))})}function ac({groups:s}){const t=s.map(n=>({...n,items:n.items.filter(a=>!a.hidden)})).filter(n=>n.items.length>0);return e.jsx(e.Fragment,{children:t.map((n,a)=>e.jsx(sc,{title:n.title,variant:n.variant,showSeparator:a>0||n.showSeparator===!0,children:n.items.map(r=>e.jsx(tc,{icon:r.icon,title:r.title,description:r.description,onClick:r.onClick,variant:r.variant,className:r.disabled?"opacity-50 cursor-not-allowed":""},r.id))},n.id))})}function Go({channel:s}){const{t}=L(),n=ve();return e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(M,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 hover:bg-slate-200 dark:hover:bg-slate-600",title:t("common.moreActions"),onClick:a=>a.stopPropagation(),children:e.jsx(ms,{className:"h-3 w-3"})})}),e.jsx(mt,{className:"w-56 p-2",align:"end",side:"bottom",onClick:a=>a.stopPropagation(),children:e.jsx(ac,{groups:[{id:"danger",items:[{id:"delete",icon:e.jsx(jt,{}),title:t("channelManagement.deleteChannel.title",{channelName:s.name}),onClick:()=>Ee.confirm({title:t("channelManagement.deleteChannel.dialogTitle"),description:t("channelManagement.deleteChannel.description",{channelName:s.name}),okText:t("common.delete"),okLoadingText:t("channelManagement.deleteChannel.deleting"),okVariant:"destructive",cancelText:t("common.cancel"),onOk:async()=>{await n.channelManager.deleteChannel(s.id)}}),variant:"default"}]}]})})]})}const aa=({channel:s,children:t})=>{const{t:n}=L(),a=ve(),[r,o]=m.useState(!1),[i,l]=m.useState(s.name),[c,d]=m.useState(s.description),[u,h]=m.useState(s.emoji||""),[g,x]=m.useState(!1);m.useEffect(()=>{r&&(l(s.name),d(s.description),h(s.emoji||""))},[r,s.id,s.name,s.description,s.emoji]);const f=async()=>{if(i.trim()){x(!0);try{const v=i.trim()!==s.name,y=c.trim()!==(s.description||""),w=u.trim()!==(s.emoji||"");await a.channelManager.updateChannel(s.id,{name:i.trim(),description:c.trim(),emoji:u.trim()||void 0}),v&&De.logChannelEdit(s.id,ds.NAME),y&&De.logChannelEdit(s.id,ds.DESCRIPTION),w&&De.logChannelEdit(s.id,ds.EMOJI),o(!1)}catch(v){console.error("Error updating channel:",v),l(s.name),d(s.description),h(s.emoji||"")}finally{x(!1)}}},p=()=>{l(s.name),d(s.description),h(s.emoji||""),o(!1)},b=v=>{v.key==="Enter"&&!g?f():v.key==="Escape"&&p()};return e.jsxs(Q,{open:r,onOpenChange:o,children:[e.jsx(Q.Trigger,{asChild:!0,children:t}),e.jsxs(Q.Content,{align:"center",side:"bottom",children:[e.jsxs(Q.Header,{children:[e.jsx(iu,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:n("channelManagement.editChannel.title")})]}),e.jsx(Q.Body,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:n("channelManagement.editChannel.emoji")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Jr,{value:u,onSelect:h,children:e.jsx(M,{variant:"outline",size:"sm",className:"h-10 w-16 text-lg border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800",children:u||"ðŸ˜Š"})}),u&&e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>h(""),className:"h-10 px-2 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200",children:n("common.clear")})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{htmlFor:"channel-name",className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:n("channelManagement.editChannel.channelName")}),e.jsx(Oe,{id:"channel-name",value:i,onChange:v=>l(v.target.value),onKeyDown:b,placeholder:n("channelManagement.editChannel.channelNamePlaceholder"),disabled:g,className:"h-10 px-3 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg transition-colors duration-200 focus:border-slate-400 dark:focus:border-slate-500  hover:border-slate-300 dark:hover:border-slate-600"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{htmlFor:"channel-description",className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:n("channelManagement.editChannel.description")}),e.jsx(Oe,{id:"channel-description",value:c,onChange:v=>d(v.target.value),onKeyDown:b,placeholder:n("channelManagement.editChannel.descriptionPlaceholder"),disabled:g,className:"h-10 px-3 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg transition-colors duration-200 focus:border-slate-400 dark:focus:border-slate-500  hover:border-slate-300 dark:hover:border-slate-600"})]})]})}),e.jsxs(Q.Actions,{children:[e.jsx(Q.Button,{type:"button",variant:"outline",onClick:p,disabled:g,children:n("common.cancel")}),e.jsx(Q.Button,{type:"button",variant:"default",onClick:f,disabled:!i.trim()||g,children:g?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"}),n("common.saving")]}):n("common.save")})]})]})]})},Mf=({channel:s,isActive:t,onClick:n})=>{const{t:a}=L(),r=!!(s.description&&s.description.trim());return e.jsx("div",{className:"w-full group cursor-pointer",onClick:n,children:e.jsx("div",{className:`relative px-2.5 py-2 rounded-md transition-colors ${t?"bg-accent/60":"bg-transparent hover:bg-accent/50"}`,children:e.jsxs("div",{className:"flex gap-2.5",children:[e.jsx("div",{className:"w-7 h-7 rounded flex items-center justify-center flex-shrink-0",children:s.emoji?e.jsx("span",{className:"text-lg",title:`Emoji: ${s.emoji}`,children:s.emoji}):ec(s.id)}),e.jsx("div",{className:`flex-1 min-w-0 ${r?"flex flex-col":"flex items-center justify-between"}`,children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:`text-sm font-medium truncate ${t?"text-slate-900 dark:text-slate-100":"text-slate-700 dark:text-slate-300"}`,children:s.name}),e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 flex-shrink-0",children:[e.jsx(aa,{channel:s,children:e.jsx(M,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 hover:bg-slate-200 dark:hover:bg-slate-700",title:a("channelManagement.channelItem.editChannel"),onClick:o=>o.stopPropagation(),children:e.jsx(gs,{className:"h-3.5 w-3.5"})})}),e.jsx(Go,{channel:s})]})]}),e.jsx("p",{className:`text-xs truncate mt-1 ${t?"text-slate-600 dark:text-slate-400":"text-slate-500 dark:text-slate-500"}`,children:s.description})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:`text-sm font-medium truncate ${t?"text-slate-900 dark:text-slate-100":"text-slate-700 dark:text-slate-300"}`,children:s.name}),e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 flex-shrink-0",children:[e.jsx(aa,{channel:s,children:e.jsx(M,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 hover:bg-slate-200 dark:hover:bg-slate-700",title:a("channelManagement.channelItem.editChannel"),onClick:o=>o.stopPropagation(),children:e.jsx(gs,{className:"h-3.5 w-3.5"})})}),e.jsx(Go,{channel:s})]})]})})]})})})},If=({email:s,password:t,confirmPassword:n,isSignUp:a,isAuthenticating:r,error:o,statusMessage:i,onEmailChange:l,onPasswordChange:c,onConfirmPasswordChange:d,onToggleSignUp:u,onPasswordReset:h,onSubmit:g})=>{const{t:x}=L(),[f,p]=m.useState(!1),[b,v]=m.useState(!1);return e.jsxs("form",{onSubmit:y=>{y.preventDefault(),g()},className:"space-y-4",children:[e.jsx(Oe,{type:"email",name:"email",placeholder:x("auth.emailPasswordForm.emailPlaceholder"),value:s,onChange:y=>l(y.target.value),className:"w-full h-12 text-sm rounded-xl border-slate-200 dark:border-slate-600 focus:border-slate-400 dark:focus:border-slate-500 dark:bg-slate-700 dark:text-white dark:placeholder-slate-400",disabled:r,autoComplete:"email"}),e.jsxs("div",{className:"relative",children:[e.jsx(Oe,{type:f?"text":"password",name:"password",placeholder:x("auth.emailPasswordForm.passwordPlaceholder"),value:t,onChange:y=>c(y.target.value),className:"w-full h-12 text-sm rounded-xl border-slate-200 dark:border-slate-600 focus:border-slate-400 dark:focus:border-slate-500  dark:bg-slate-700 dark:text-white dark:placeholder-slate-400 pr-10",disabled:r,autoComplete:a?"new-password":"current-password"}),e.jsx("button",{type:"button",onClick:()=>p(!f),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors",disabled:r,children:f?e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"})}):e.jsxs("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})})]}),a&&e.jsxs("div",{className:"relative",children:[e.jsx(Oe,{type:b?"text":"password",name:"confirmPassword",placeholder:x("auth.emailPasswordForm.confirmPasswordPlaceholder"),value:n,onChange:y=>d(y.target.value),className:"w-full h-12 text-sm rounded-xl border-slate-200 dark:border-slate-600 focus:border-slate-400 dark:focus:border-slate-500  dark:bg-slate-700 dark:text-white dark:placeholder-slate-400 pr-10",disabled:r,autoComplete:"new-password"}),e.jsx("button",{type:"button",onClick:()=>v(!b),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors",disabled:r,children:b?e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"})}):e.jsxs("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})})]}),o&&e.jsx("div",{className:"text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/30 rounded-lg p-3",children:o}),i&&e.jsx("div",{className:"text-sm text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800/30 rounded-lg p-3",children:i}),e.jsx(M,{type:"submit",disabled:r||!s||!t||a&&(!n||t!==n||t.length<6),className:"w-full h-12 text-sm font-medium rounded-xl bg-slate-600 hover:bg-slate-700 dark:bg-slate-700 dark:hover:bg-slate-600 text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",size:"lg",children:r?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:x(a?"auth.emailPasswordForm.creatingAccount":"auth.emailPasswordForm.signingIn")})]}):x(a?"auth.emailPasswordForm.createAccount":"auth.emailPasswordForm.signIn")}),e.jsx("div",{className:"text-center",children:e.jsx("button",{type:"button",onClick:u,className:"text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors underline underline-offset-2",disabled:r,children:x(a?"auth.emailPasswordForm.alreadyHaveAccount":"auth.emailPasswordForm.dontHaveAccount")})}),!a&&e.jsx("div",{className:"text-center",children:e.jsx("button",{type:"button",onClick:h,className:"text-sm text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 transition-colors underline underline-offset-2",disabled:r||!s,children:x("auth.emailPasswordForm.forgotPassword")})})]})},Tf=()=>{const{t:s}=L();return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("p",{className:"text-xs text-slate-500 dark:text-slate-400 leading-relaxed",children:[s("auth.loginFooter.agreement")," ",e.jsx("button",{className:"underline underline-offset-2 hover:text-slate-700 dark:hover:text-slate-300 transition-colors font-medium",children:s("auth.loginFooter.terms")}),","," ",e.jsx("button",{className:"underline underline-offset-2 hover:text-slate-700 dark:hover:text-slate-300 transition-colors font-medium",children:s("auth.loginFooter.privacy")}),"."]})}),e.jsxs("div",{className:"flex justify-center gap-4 mt-6",children:[e.jsx("button",{className:"w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center transition-colors",children:e.jsx("svg",{className:"w-4 h-4 text-slate-600 dark:text-slate-400",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"})})}),e.jsx("button",{className:"w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center transition-colors",children:e.jsx("svg",{className:"w-4 h-4 text-slate-600 dark:text-slate-400",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"})})})]})]})},rc=({size:s="md",variant:t="default",text:n,className:a})=>{const r={sm:"w-4 h-4",md:"w-8 h-8",lg:"w-12 h-12",xl:"w-16 h-16"},o={sm:"text-xs",md:"text-sm",lg:"text-base",xl:"text-lg"},i=()=>e.jsx("div",{className:E("animate-spin rounded-full border-2 border-slate-200 dark:border-slate-700","border-t-blue-600 dark:border-t-blue-400",r[s])}),l=()=>e.jsx("div",{className:E("animate-pulse rounded-full bg-gradient-to-r from-blue-400 to-purple-500",r[s])}),c=()=>e.jsx("div",{className:"flex space-x-1",children:[0,1,2].map(g=>e.jsx("div",{className:E("animate-bounce rounded-full bg-blue-600 dark:bg-blue-400",s==="sm"?"w-1.5 h-1.5":s==="md"?"w-2 h-2":s==="lg"?"w-2.5 h-2.5":"w-3 h-3"),style:{animationDelay:`${g*.1}s`,animationDuration:"1s"}},g))}),d=()=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:E("absolute inset-0 rounded-full bg-blue-600 dark:bg-blue-400 opacity-75",r[s])}),e.jsx("div",{className:E("absolute inset-0 rounded-full bg-blue-600 dark:bg-blue-400 opacity-75",r[s],"animate-ping")}),e.jsx("div",{className:E("relative rounded-full bg-blue-600 dark:bg-blue-400",r[s])})]}),u=()=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:E("animate-spin rounded-full border-2 border-slate-200 dark:border-slate-700","border-t-blue-600 dark:border-t-blue-400",r[s])}),n&&e.jsx("span",{className:E("text-slate-600 dark:text-slate-400 font-medium",o[s]),children:n})]}),h=()=>{switch(t){case"spinner":return i();case"pulse":return l();case"dots":return c();case"ripple":return d();default:return u()}};return e.jsx("div",{className:E("flex items-center justify-center",a),children:h()})};function ra({className:s,value:t,...n}){return e.jsx(bd,{"data-slot":"progress",className:E("bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",s),...n,children:e.jsx(vd,{"data-slot":"progress-indicator",className:"bg-primary h-full w-full flex-1 transition-all",style:{transform:`translateX(-${100-(t||0)}%)`}})})}const Ef=({authStep:s,authMessage:t,authProgress:n})=>{const{t:a}=L(),r=()=>{switch(s){case ee.COMPLETE:return e.jsx(_t,{className:"w-6 h-6 text-green-500"});case ee.ERROR:return e.jsx(ua,{className:"w-6 h-6 text-red-500"});default:return e.jsx(rc,{variant:"spinner",size:"lg"})}},o=()=>{switch(s){case ee.COMPLETE:return"text-green-600 dark:text-green-400";case ee.ERROR:return"text-red-600 dark:text-red-400";default:return"text-blue-600 dark:text-blue-400"}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-center",children:r()}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-slate-100",children:s===ee.COMPLETE?a("auth.progress.welcome"):a("auth.progress.pleaseWait")}),e.jsx("p",{className:`text-sm font-medium ${o()}`,children:t}),s!==ee.COMPLETE&&s!==ee.ERROR&&e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:a("auth.progress.mayTakeMoment")})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(ra,{value:n,className:`${s===ee.ERROR?"bg-red-100 dark:bg-red-900/20":s===ee.COMPLETE?"bg-green-100 dark:bg-green-900/20":"bg-blue-100 dark:bg-blue-900/20"}`}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500 dark:text-slate-400",children:[e.jsxs("div",{className:`flex items-center gap-2 ${s===ee.AUTHENTICATING?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===ee.AUTHENTICATING?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:a("auth.progress.authenticating")})]}),e.jsxs("div",{className:`flex items-center gap-2 ${s===ee.VERIFYING_EMAIL?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===ee.VERIFYING_EMAIL?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:a("auth.progress.verifying")})]}),e.jsxs("div",{className:`flex items-center gap-2 ${s===ee.INITIALIZING_DATA?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===ee.INITIALIZING_DATA?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:a("auth.progress.settingUp")})]})]})]})]})},Af=({authStep:s,authMessage:t,authProgress:n})=>{const{t:a}=L(),r=()=>{switch(s){case ee.COMPLETE:return e.jsx(_t,{className:"w-6 h-6 text-green-500"});case ee.ERROR:return e.jsx(ua,{className:"w-6 h-6 text-red-500"});default:return e.jsx(rc,{variant:"spinner",size:"lg"})}},o=()=>{switch(s){case ee.COMPLETE:return"text-green-600 dark:text-green-400";case ee.ERROR:return"text-red-600 dark:text-red-400";default:return"text-blue-600 dark:text-blue-400"}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-center",children:r()}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-slate-100",children:s===ee.COMPLETE?a("auth.progress.welcome"):a("auth.progress.pleaseWait")}),e.jsx("p",{className:`text-sm font-medium ${o()}`,children:t}),s!==ee.COMPLETE&&s!==ee.ERROR&&e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:a("auth.progress.mayTakeMoment")})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(ra,{value:n,className:`${s===ee.ERROR?"bg-red-100 dark:bg-red-900/20":s===ee.COMPLETE?"bg-green-100 dark:bg-green-900/20":"bg-blue-100 dark:bg-blue-900/20"}`}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500 dark:text-slate-400",children:[e.jsxs("div",{className:`flex items-center gap-2 ${s===ee.AUTHENTICATING?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===ee.AUTHENTICATING?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:a("auth.progress.creating")})]}),e.jsxs("div",{className:`flex items-center gap-2 ${s===ee.VERIFYING_EMAIL?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===ee.VERIFYING_EMAIL?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:a("auth.progress.sendingLink")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-slate-300 dark:bg-slate-600"}),e.jsx("span",{children:a("auth.progress.checkInbox")})]})]})]})]})},Rf=({email:s,onResendVerification:t,onBackToSignIn:n,resendCooldown:a=0,isResending:r=!1})=>{const{t:o}=L();return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(_t,{className:"w-8 h-8 text-green-500"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-xl font-semibold text-slate-900 dark:text-slate-100",children:o("auth.emailVerification.checkEmail")}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/30 rounded-lg p-4",children:[e.jsxs("p",{className:"text-sm text-green-700 dark:text-green-400",children:[o("auth.emailVerification.sentLink",{email:s?` ${s}`:""}),s&&e.jsx("strong",{className:"font-semibold",children:s}),"."]}),e.jsx("p",{className:"text-xs text-green-600 dark:text-green-500 mt-1",children:o("auth.emailVerification.clickLink")})]}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-2",children:[e.jsx("button",{onClick:t,disabled:a>0||r,className:"px-4 py-2 text-sm font-medium text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30 border border-green-200 dark:border-green-800/30 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:r?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-green-600 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:o("auth.emailVerification.sending")})]}):a>0?o("auth.emailVerification.resendIn",{seconds:a}):o("auth.emailVerification.resendLink")}),e.jsx("button",{onClick:n,className:"px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700/50 border border-slate-200 dark:border-slate-700 rounded-lg transition-colors",children:o("auth.emailVerification.backToSignIn")})]})]})]})},Lf=({isEmailVerificationSent:s,email:t,onResendVerification:n,onBackToSignIn:a,isSignUpFlow:r,forceOpen:o,onClose:i,resendCooldown:l=0,isResending:c=!1})=>{const{authStep:d,authMessage:u,authProgress:h,isAuthenticating:g}=Ye(),x=!!o||g||!!s;if(!x)return null;const f=()=>{i&&i()},p=()=>s?e.jsx(Rf,{email:t,onResendVerification:n,onBackToSignIn:a,resendCooldown:l,isResending:c}):r?e.jsx(Af,{authStep:d,authMessage:u,authProgress:h}):e.jsx(Ef,{authStep:d,authMessage:u,authProgress:h});return e.jsx(Jt,{open:x,onOpenChange:b=>{b||f()},children:e.jsx(Zt,{className:"max-w-md w-full mx-4 p-8",children:e.jsx("div",{className:"text-center space-y-6",children:p()})})})},Df=({className:s})=>{const{t}=L(),{signInWithEmail:n,sendSignUpLink:a,sendPasswordReset:r,sendEmailVerification:o,isAuthenticating:i,setAuthStep:l}=Ye(),[c,d]=m.useState(""),[u,h]=m.useState(""),[g,x]=m.useState(""),[f,p]=m.useState(!1),[b,v]=m.useState(""),[y,w]=m.useState(""),[N,S]=m.useState(!1),[j,C]=m.useState(!1),[I,k]=m.useState(null),[T,z]=m.useState(!1),[D,$]=m.useState(0),[H,ae]=m.useState(!1);m.useEffect(()=>{let Z;return D>0&&(Z=setTimeout(()=>{$(D-1)},1e3)),()=>{Z&&clearTimeout(Z)}},[D]);const re=async()=>{if(!c||!u){v(t("auth.loginCard.errors.fillAllFields"));return}if(f){if(!g){v(t("auth.loginCard.errors.confirmPassword"));return}if(u!==g){v(t("auth.loginCard.errors.passwordsNotMatch"));return}if(u.length<6){v(t("auth.loginCard.errors.passwordTooShort"));return}}try{v(""),w(""),f?(z(!0),l(ee.AUTHENTICATING,xt.CREATING_ACCOUNT,bt.AUTHENTICATING),(await a(c,u)).verificationSent&&(l(ee.VERIFYING_EMAIL,xt.SENDING_VERIFICATION,bt.VERIFYING_EMAIL),k({email:c}),C(!0),$(60))):await n(c,u)}catch(Z){console.error("Email auth failed:",Z),w("");const _=Z;let q="";switch(_.code){case"auth/user-not-found":q="No account found with this email address";break;case"auth/wrong-password":q="Incorrect password";break;case"auth/invalid-credential":q="Invalid email or password. Please check your credentials and try again.";break;case"auth/email-already-in-use":q="An account with this email already exists";break;case"auth/weak-password":q="Password should be at least 6 characters";break;case"auth/invalid-email":q="Invalid email address";break;case"auth/user-disabled":q="This account has been disabled. Please contact support.";break;case"auth/too-many-requests":q="Too many failed attempts. Please try again later.";break;case"auth/network-request-failed":q="Network error. Please check your connection and try again.";break;case"auth/operation-not-allowed":q="This sign-in method is not enabled. Please try a different method.";break;default:_.message==="EMAIL_NOT_VERIFIED"?q="Please verify your email address before signing in. Check your inbox for a verification link.":_.message==="EMAIL_NOT_VERIFIED_RESENT"?q="Please verify your email address before signing in. We've sent a new verification link to your inbox.":_.message==="EMAIL_ALREADY_VERIFIED"?q="This email is already verified. Please sign in instead.":_.message==="ACCOUNT_EXISTS_WRONG_PASSWORD"?q="An account with this email already exists, but the password is incorrect. Please check your password or try signing in.":q="Authentication failed. Please check your credentials and try again."}v(q);try{l(ee.ERROR,f?"Sign-up failed. Please try again.":xt.SIGN_IN_FAILED,bt.START)}catch{}}},je=async()=>{if(!c){v("Please enter your email address first");return}try{v(""),await r(c),S(!0)}catch(Z){switch(console.error("Password reset failed:",Z),Z.code){case"auth/user-not-found":v("No account found with this email address");break;case"auth/invalid-email":v("Invalid email address");break;case"auth/too-many-requests":v("Too many reset attempts. Please try again later.");break;case"auth/network-request-failed":v("Network error. Please check your connection and try again.");break;default:v("Failed to send password reset email. Please try again.")}}},Ne=async()=>{if(!I){v("No pending user found");return}try{if(D>0){v(`Please wait ${D} seconds before resending`);return}ae(!0),v(""),C(!1),l(ee.VERIFYING_EMAIL,xt.SENDING_VERIFICATION,bt.VERIFYING_EMAIL),await o(),C(!0),$(60)}catch(Z){switch(console.error("Failed to resend verification:",Z),Z.code){case"auth/too-many-requests":v("Too many verification attempts. Please try again later."),$(120);break;case"auth/network-request-failed":v("Network error. Please check your connection and try again.");break;default:v("Failed to resend verification email. Please try again.")}}finally{ae(!1)}},Be=()=>{p(!1),C(!1),z(!1),v(""),w(""),k(null),$(0),h(""),x(""),ae(!1)},F=()=>{p(!f),v(""),w(""),S(!1),C(!1),k(null),x(""),$(0),ae(!1)},G=()=>{z(!1),C(!1),k(null),v(""),$(0),ae(!1)};return e.jsxs("div",{className:s,children:[e.jsx(If,{email:c,password:u,confirmPassword:g,isSignUp:f,isAuthenticating:i,error:b,statusMessage:y,onEmailChange:d,onPasswordChange:h,onConfirmPasswordChange:x,onToggleSignUp:F,onPasswordReset:je,onSubmit:re}),e.jsx(Lf,{isEmailVerificationSent:j,email:c,onResendVerification:Ne,onBackToSignIn:Be,isSignUpFlow:f||j,forceOpen:T,onClose:G,resendCooldown:D,isResending:H}),N&&e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/30 rounded-lg p-3",children:t("auth.login.passwordResetSent")}),e.jsx(Tf,{})]})},oc=()=>({isGoogleAuthSupported:ne.supportGoogleAuth(),isInCNRegion:ne.isInCNRegion()}),_f=({onSelectGoogle:s,onSelectEmail:t,onSelectLocal:n,isAuthenticating:a,showLocalOption:r=!0})=>{const{t:o}=L(),{isGoogleAuthSupported:i}=oc();return e.jsxs("div",{className:"space-y-3",children:[i&&e.jsx(M,{onClick:s,disabled:a,className:"w-full h-14 text-sm font-medium rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 text-slate-900 dark:text-white transition-all shadow-sm hover:shadow-md",variant:"ghost",children:a?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-slate-300 dark:border-slate-500 border-t-slate-600 dark:border-t-slate-300 rounded-full animate-spin"}),e.jsx("span",{children:o("auth.emailPasswordForm.signingIn")})]}):e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("svg",{className:"w-5 h-5",viewBox:"0 0 24 24",children:[e.jsx("path",{fill:"#4285F4",d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),e.jsx("path",{fill:"#34A853",d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),e.jsx("path",{fill:"#FBBC05",d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),e.jsx("path",{fill:"#EA4335",d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),e.jsx("span",{children:o("auth.socialLogin.continueWithGoogle")})]})}),e.jsx(M,{onClick:t,disabled:a,className:"w-full h-14 text-sm font-medium rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 text-slate-900 dark:text-white transition-all shadow-sm hover:shadow-md",variant:"ghost",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(_i,{className:"w-5 h-5 text-slate-600 dark:text-slate-300"}),e.jsx("span",{children:o("auth.login.continueWithEmail")})]})}),r&&e.jsx(M,{onClick:n,disabled:a,className:"w-full h-14 text-sm font-medium rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-600 bg-transparent hover:bg-slate-50 dark:hover:bg-slate-800/50 text-slate-600 dark:text-slate-400 transition-all",variant:"ghost",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Tr,{className:"w-5 h-5"}),e.jsxs("div",{className:"flex flex-col items-start",children:[e.jsx("span",{children:o("auth.login.localMode")}),e.jsx("span",{className:"text-xs text-slate-400 dark:text-slate-500",children:o("auth.login.localModeHint")})]})]})})]})};function Pf({allowGuest:s}){const t=Ye(b=>b.currentUser),{signInWithGoogle:n,isAuthenticating:a}=Ye(),r=O(b=>b.initGuestWorkspace),{t:o}=L(),{isGoogleAuthSupported:i}=oc(),[l,c]=m.useState("select"),[d,u]=m.useState("");m.useEffect(()=>{t&&Ee.close()},[t]);const h=async()=>{try{u(""),await n()}catch(b){switch(console.error("Google login failed:",b),b.code){case"auth/popup-closed-by-user":u(o("auth.loginCard.errors.popupClosed"));break;case"auth/popup-blocked":u(o("auth.loginCard.errors.popupBlocked"));break;case"auth/network-request-failed":u(o("auth.loginCard.errors.networkError"));break;case"auth/too-many-requests":u(o("auth.loginCard.errors.tooManyRequests"));break;default:u(o("auth.loginCard.errors.googleSignInFailed"))}}},g=async()=>{await r({autoCreateDefaultSpace:!0}),Ee.close()},x=()=>{c("email")},f=()=>{c("select"),u("")};return l==="select"&&(i||s)?e.jsxs("div",{className:"space-y-4",children:[d&&e.jsx("div",{className:"text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/30 rounded-lg p-3",children:d}),e.jsx(_f,{onSelectGoogle:h,onSelectEmail:x,onSelectLocal:g,isAuthenticating:a,showLocalOption:s})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs(M,{variant:"ghost",size:"sm",onClick:f,className:"flex items-center gap-1 text-muted-foreground hover:text-foreground -ml-2 mb-2",children:[e.jsx(It,{className:"w-4 h-4"}),o("auth.login.backToOptions")]}),e.jsx(Df,{})]})}function Kt(s){const t=s?.allowGuest?W.t("auth.login.titleOrLocal"):W.t("auth.login.title"),n=s?.allowGuest?W.t("auth.login.descOrLocal"):W.t("auth.login.description");Ee.show({title:s?.title??t,description:s?.description??n,showFooter:!1,className:"w-full max-w-[560px] sm:max-w-[560px]",content:e.jsx(Pf,{allowGuest:s?.allowGuest}),onCancel:()=>{!s?.allowGuest||Ye.getState().currentUser||Fr()||O.getState().initGuestWorkspace()}})}const Of=()=>{const{t:s}=L(),t=ve(),n=O(r=>r.userId),a=async r=>{if(!n){Kt({title:s("auth.login.titleOrLocal"),description:s("auth.login.descOrLocal"),allowGuest:!0});return}await t.channelManager.addChannel(r),De.logChannelCreate(r.name,r.name,!!r.description)};return e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4",children:e.jsx($e,{className:"w-8 h-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:s("channelManagement.channelListEmptyState.title")}),e.jsx("p",{className:"text-muted-foreground text-sm mb-4 max-w-xs",children:s("channelManagement.channelListEmptyState.description")}),e.jsx("button",{onClick:()=>a({name:s("desktop.welcomeGuide.firstSpaceName"),emoji:"ðŸš€",description:s("desktop.welcomeGuide.firstSpaceDescription")}),className:"text-sm text-primary hover:text-primary/80 font-medium",children:s("channelManagement.channelListEmptyState.createFirstSpace")})]})};function $f({count:s=12}){return e.jsxs("div",{"data-component":"channel-list",className:"w-full h-full overflow-hidden flex flex-col bg-card shadow-sm",children:[e.jsxs("div",{"data-component":"channel-list-header",className:"h-12 px-4 flex items-center justify-between",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx(K,{className:"h-5 w-16"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-8 w-8 rounded-md"}),e.jsx(K,{className:"h-8 w-8 rounded-md"}),e.jsx(ea.ToggleButton,{})]})]}),e.jsx("div",{"data-component":"channel-list-content",className:"flex-1 overflow-y-auto p-3 space-y-1 min-h-0 channel-list-content",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:Array.from({length:s}).map((t,n)=>e.jsx("div",{className:"w-full group transition-all duration-200 cursor-pointer",children:e.jsx("div",{className:"relative p-3 rounded-lg transition-all duration-200 bg-transparent",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(K,{className:"w-8 h-8 rounded-lg flex-shrink-0"}),e.jsxs("div",{className:"flex-1 text-left min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx(K,{className:"w-20 h-4"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(K,{className:"w-24 h-3"}),e.jsx(K,{className:"w-16 h-3"})]})]}),e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1",children:[e.jsx(K,{className:"w-6 h-6 rounded"}),e.jsx(K,{className:"w-6 h-6 rounded"})]})]})})},n))}),e.jsx("div",{"data-component":"channel-list-footer",className:"p-3 border-t border-slate-200 dark:border-slate-700",children:e.jsx(K,{className:"w-full h-10 rounded-lg"})})]})}class Bf{docs=new Map;byChannelCount=new Map;indexNotes(t){this.docs.clear(),this.byChannelCount.clear();for(const n of t)n.isDeleted||(this.docs.set(n.id,n),this.byChannelCount.set(n.channelId,(this.byChannelCount.get(n.channelId)||0)+1))}upsertNote(t){const n=this.docs.get(t.id);if(!t.isDeleted)this.docs.set(t.id,t),n||this.byChannelCount.set(t.channelId,(this.byChannelCount.get(t.channelId)||0)+1);else if(this.docs.delete(t.id),n){const a=(this.byChannelCount.get(n.channelId)||1)-1;a>0?this.byChannelCount.set(n.channelId,a):this.byChannelCount.delete(n.channelId)}}upsertNotes(t){for(const n of t)this.upsertNote(n)}search(t,n){const a=(t||"").trim().toLowerCase();if(!a)return[];const r=n?.channelIds?new Set(n.channelIds):null,o=[];for(const i of this.docs.values()){if(r&&!r.has(i.channelId))continue;const l=this.scoreNote(i,a);l.score>0&&o.push(l)}return o.sort((i,l)=>l.score-i.score||l.timestamp.getTime()-i.timestamp.getTime()),n?.limit?o.slice(0,n.limit):o}getChannelDocCount(t){return this.byChannelCount.get(t)||0}getIndexedChannelIds(){return Array.from(this.byChannelCount.keys())}getTotalDocs(){return this.docs.size}scoreNote(t,n){const a=[];let r=0;const o=(t.content||"").toLowerCase(),i=this.countOccurrences(o,n);i>0&&(a.push("content"),r+=i*10);const c=(t.tags||[]).map(x=>x.toLowerCase()).filter(x=>x.includes(n)).length;c>0&&(a.push("tags"),r+=c*6);const u=(t.aiAnalysis?.keywords||[]).map(x=>x.toLowerCase()).filter(x=>x.includes(n)).length;u>0&&(a.push("keywords"),r+=u*5);const h=(t.aiAnalysis?.summary||"").toLowerCase(),g=this.countOccurrences(h,n);return g>0&&(a.push("summary"),r+=g*3),{id:t.id,channelId:t.channelId,score:r,snippet:this.buildSnippet(t.content,n),matchedFields:a,timestamp:t.timestamp}}countOccurrences(t,n){if(!t||!n)return 0;let a=0,r=0;for(;(r=t.indexOf(n,r))!==-1;)a++,r+=n.length;return a}buildSnippet(t,n){const a=t||"",o=a.toLowerCase().indexOf(n);if(o===-1)return;const i=Math.max(0,o-30),l=Math.min(a.length,o+n.length+30),c=a.slice(i,l),d=i>0?"â€¦":"",u=l<a.length?"â€¦":"";return d+c+u}}const $a={limits:{maxResults:50},ui:{debounceMs:150,minQueryLength:1}};class Uf{searchIndex;searchQuery$=new Rt("");searchFilters$=new Rt({});indexStats$=new Rt({totalDocs:0,indexedChannelIds:[]});indexedDataHash="";isIndexing=!1;constructor(){this.searchIndex=new Bf,this.initializeIndex()}search(t,n){return this.searchQuery$.next(t),n&&this.searchFilters$.next(n),Xi([ft.getNotes(this.searchFilters$.value),this.searchQuery$.pipe(rr($a.ui.debounceMs),xa())]).pipe(os(([a,r])=>!r||r.trim().length<$a.ui.minQueryLength?[]:(this.updateIndexIfNeeded(a),this.searchIndex.search(r,{channelIds:this.searchFilters$.value.channelIds,limit:$a.limits.maxResults}))))}async updateAllData(){await ft.updateAll()}async updateChannelData(t){await ft.updateChannel(t)}async preIndexData(){if(!this.isIndexing){this.isIndexing=!0;try{const t=await Ms(ft.getNotes());t&&(this.searchIndex.indexNotes(t),this.indexedDataHash=this.calculateDataHash(t),this.updateIndexStats())}finally{this.isIndexing=!1}}}async preIndexChannel(t){if(!this.isIndexing){this.isIndexing=!0;try{const n=await Ms(ft.getNotes({channelIds:[t]}));if(n){this.searchIndex.upsertNotes(n);const a=await Ms(ft.getNotes());this.indexedDataHash=this.calculateDataHash(a),this.updateIndexStats()}}finally{this.isIndexing=!1}}}getIndexStats(){return{totalDocs:this.searchIndex.getTotalDocs(),indexedChannelIds:this.searchIndex.getIndexedChannelIds()}}getIndexStats$(){return this.indexStats$.asObservable()}initializeIndex(){ft.getNotes().subscribe(t=>{this.updateIndexIfNeeded(t);const n=this.getIndexStats();typeof window<"u"&&console.debug("[NoteSearchService] notes updated, index stats",n)})}updateIndexIfNeeded(t){const n=this.calculateDataHash(t);n!==this.indexedDataHash&&(this.searchIndex.indexNotes(t),this.indexedDataHash=n,this.updateIndexStats())}updateIndexStats(){this.indexStats$.next({totalDocs:this.searchIndex.getTotalDocs(),indexedChannelIds:this.searchIndex.getIndexedChannelIds()})}calculateDataHash(t){const n=JSON.stringify(t.map(r=>{const o=r;return{id:o.id,content:o.content,tags:o.tags,aiAnalysis:o.aiAnalysis,timestamp:o.timestamp}}));let a=0;for(let r=0;r<n.length;r++){const o=n.charCodeAt(r);a=(a<<5)-a+o,a=a&a}return a.toString()}}const Ht=new Uf;function Ff({items:s,activeIndex:t,setActiveIndex:n,onSelect:a,onEscape:r,onTab:o,enabled:i=!0}){m.useEffect(()=>{if(!i)return;const l=c=>{if(c.key==="Escape"){c.preventDefault(),r?.();return}if(c.key==="ArrowDown"){c.preventDefault(),n(d=>Math.min(d+1,Math.max(0,s.length-1)));return}if(c.key==="ArrowUp"){c.preventDefault(),n(d=>Math.max(0,d-1));return}if(c.key==="Tab"){c.preventDefault(),o?.();return}c.key==="Enter"&&s[t]&&(c.preventDefault(),a?.(s[t],t))};return window.addEventListener("keydown",l),()=>window.removeEventListener("keydown",l)},[s,t,n,a,r,o,i])}function zf({onSwipeLeft:s,onSwipeRight:t,onSwipeUp:n,onSwipeDown:a,threshold:r=50,enabled:o=!0}){m.useEffect(()=>{if(!o)return;let i=0,l=0,c=!1;const d=g=>{i=g.touches[0].clientY,l=g.touches[0].clientX,c=!1},u=g=>{if(!c){const x=Math.abs(g.touches[0].clientY-i),f=Math.abs(g.touches[0].clientX-l);c=f>x&&f>10}},h=g=>{if(c){const x=g.changedTouches[0].clientX-l,f=g.changedTouches[0].clientY-i;Math.abs(x)>r?(g.preventDefault(),x>0?t?.():s?.()):Math.abs(f)>r&&(g.preventDefault(),f>0?a?.():n?.())}};return document.addEventListener("touchstart",d,{passive:!0}),document.addEventListener("touchmove",u,{passive:!0}),document.addEventListener("touchend",h,{passive:!1}),()=>{document.removeEventListener("touchstart",d),document.removeEventListener("touchmove",u),document.removeEventListener("touchend",h)}},[s,t,n,a,r,o])}function Hf({activeId:s,scrollBehavior:t="smooth",block:n="nearest",enabled:a=!0}){m.useEffect(()=>{if(!a||!s)return;const r=document.getElementById(s);r&&r.scrollIntoView({behavior:t,block:n})},[s,t,n,a])}function Gf({operation:s,onSuccess:t,onError:n}){const[a,r]=m.useState(!1),[o,i]=m.useState(null);return{execute:m.useCallback(async()=>{if(!a){r(!0),i(null);try{const c=await s();return t?.(c),c}catch(c){const d=c instanceof Error?c:new Error(String(c));throw i(d),n?.(d),d}finally{r(!1)}}},[s,t,n,a]),isLoading:a,error:o}}function Vf({q:s,setQ:t,scope:n,setScope:a,indexing:r}){const{t:o}=L(),i=m.useRef(null);m.useEffect(()=>{setTimeout(()=>i.current?.focus(),0)},[]);const l=r&&n==="all";return e.jsxs("div",{className:"sticky top-0 z-10 bg-background shrink-0",children:[e.jsx("div",{className:"h-[env(safe-area-inset-top)] sm:hidden"}),e.jsxs("div",{className:"px-4 py-3 sm:px-6 sm:py-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Je,{className:"absolute left-0 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground/50"}),e.jsx("input",{ref:i,type:"text",placeholder:o(n==="current"?"noteSearch.searchHeader.placeholderCurrent":"noteSearch.searchHeader.placeholderAll"),value:s,onChange:c=>t(c.target.value),className:"w-full h-auto py-2 pl-7 pr-9 bg-transparent border-0 text-base placeholder:text-muted-foreground/50 focus:outline-none focus:ring-0 transition-all duration-200"}),s&&e.jsx("button",{className:"absolute right-0 top-1/2 -translate-y-1/2 h-6 w-6 inline-flex items-center justify-center rounded hover:bg-muted/50 text-muted-foreground hover:text-foreground transition-colors",onClick:()=>t(""),"aria-label":o("common.clearSearch"),children:e.jsx(fe,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center gap-0.5 rounded-md bg-muted/30 p-0.5 shrink-0",children:[e.jsx("button",{role:"radio","aria-checked":n==="current",className:`px-2 py-0.5 text-sm font-medium rounded transition-all duration-150 ${n==="current"?"bg-background text-foreground":"text-muted-foreground hover:text-foreground"}`,onClick:()=>a("current"),children:o("noteSearch.searchHeader.current")}),e.jsx("button",{role:"radio","aria-checked":n==="all",className:`px-2 py-0.5 text-sm font-medium rounded transition-all duration-150 ${n==="all"?"bg-background text-foreground":"text-muted-foreground hover:text-foreground"}`,onClick:()=>a("all"),children:o("noteSearch.searchHeader.all")})]})]}),l&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1 bg-muted/30 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary animate-pulse",style:{width:"30%"}})}),e.jsx("span",{className:"text-xs text-muted-foreground/60 whitespace-nowrap",children:o("noteSearch.searchHeader.indexing")})]})]})]})}function Wf(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function qf({text:s,query:t}){if(!s||!t)return e.jsx(e.Fragment,{children:s});const n=Wf(t);try{const a=new RegExp(`(${n})`,"ig"),r=s.split(a);return e.jsx(e.Fragment,{children:r.map((o,i)=>o.toLowerCase()===t.toLowerCase()?e.jsx("mark",{className:"bg-yellow-200/80 dark:bg-yellow-600/50 text-foreground rounded px-0.5",children:o},i):e.jsx("span",{children:o},i))})}catch{return e.jsx(e.Fragment,{children:s})}}function Kf({results:s,activeIndex:t,setActiveIndex:n,onPick:a,channelName:r,q:o}){const{t:i}=L();return e.jsx("div",{className:"flex-1 py-2",children:s.map((l,c)=>{const d=c===t,u=Mm(new Date(l.timestamp),{addSuffix:!0});return e.jsx("button",{id:l.id,type:"button",role:"option","aria-selected":d,className:`relative w-full text-left px-4 py-2.5 rounded transition-colors duration-150 ${d?"bg-muted/50":"hover:bg-muted/30"}`,onMouseEnter:()=>n(c),onClick:()=>a(l.id,l.channelId),children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground/80",children:r(l.channelId)}),e.jsx("span",{className:"text-xs text-foreground/50","aria-hidden":"true",children:i("noteSearch.searchResults.dotSeparator")}),e.jsx("span",{className:"text-xs text-foreground/50",children:u})]}),e.jsx("div",{className:"text-sm text-foreground/70 leading-relaxed",children:l.snippet?e.jsx(qf,{text:l.snippet,query:o}):i("noteSearch.searchResults.noPreview")})]})},l.id)})})}function Yf({q:s,scope:t,isRefreshing:n,onRefresh:a}){const{t:r}=L();return s.trim()===""?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center py-16 px-6 text-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-muted/30 flex items-center justify-center mb-4",children:e.jsx(Je,{className:"h-6 w-6 text-muted-foreground/50"})}),e.jsx("p",{className:"text-sm text-muted-foreground/70",children:r(t==="current"?"noteSearch.emptyStates.searchCurrent":"noteSearch.emptyStates.searchAll")})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center py-16 px-6 text-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-muted/30 flex items-center justify-center mb-4",children:e.jsx(Je,{className:"h-6 w-6 text-muted-foreground/50"})}),e.jsx("p",{className:"text-sm text-muted-foreground/70 mb-4",children:r("noteSearch.emptyStates.noResults")}),e.jsx("button",{onClick:a,disabled:n,className:"text-xs text-muted-foreground/60 hover:text-foreground transition-colors disabled:opacity-50",children:r(n?"noteSearch.emptyStates.refreshing":"noteSearch.emptyStates.refreshIndex")})]})}function Xf({onClose:s,defaultScope:t="current"}){const{t:n}=L(),{currentChannelId:a}=J(),r=O(I=>I.channels),o=ve(),[i,l]=m.useState(""),[c,d]=m.useState(t),[u,h]=m.useState([]),[g,x]=m.useState(!1),[f,p]=m.useState(0),b=m.useRef(null),v=m.useMemo(()=>c==="current"&&a?[a]:void 0,[c,a]);m.useEffect(()=>{let I=!1;return(async()=>c==="all"&&(x(!0),await Ht.updateAllData(),await Ht.preIndexData(),I||x(!1)))(),()=>{I=!0}},[c]),m.useEffect(()=>{let I=!1;return(async()=>{if(c!=="current"||!a)return;console.debug("[QuickSearch] current scope pre-index start",{currentChannelId:a}),x(!0),await Ht.updateChannelData(a),await Ht.preIndexChannel(a);const k=Ht.getIndexStats();console.debug("[QuickSearch] current scope pre-index done",{stats:k}),I||x(!1)})(),()=>{I=!0}},[c,a]);const y=I=>r.find(k=>k.id===I)?.name||I,w=m.useCallback((I,k)=>{s(),o.rxEventBus.requestJumpToMessage$.emit({channelId:k,messageId:I})},[s,o.rxEventBus.requestJumpToMessage$]);Ff({items:u,activeIndex:f,setActiveIndex:p,onSelect:I=>w(I.id,I.channelId),onEscape:s,onTab:()=>d(I=>I==="current"?"all":"current")}),zf({onSwipeLeft:()=>d("all"),onSwipeRight:()=>d("current")}),Hf({activeId:u[f]?.id||null});const N=m.useMemo(()=>Ht.search(i,{channelIds:v}),[i,v]),S=Sl(N,[]);m.useEffect(()=>{h(S),p(0),i&&console.debug("[QuickSearch] search results",{q:i,scope:c,channelIds:v,count:S.length})},[S,i,c,v]);const{execute:j,isLoading:C}=Gf({operation:async()=>{await Ht.updateAllData(),await Ht.preIndexData()}});return e.jsxs("div",{className:"flex flex-col w-full h-full min-h-0",children:[e.jsx(Vf,{q:i,setQ:l,scope:c,setScope:d,indexing:g}),e.jsx("div",{ref:b,className:"flex-1 min-h-0 overflow-y-auto overscroll-contain flex flex-col",role:"listbox","aria-activedescendant":u[f]?.id,children:i.trim()===""||u.length===0?e.jsx(Yf,{q:i,scope:c,isRefreshing:C,onRefresh:j}):e.jsx(Kf,{results:u,activeIndex:f,setActiveIndex:p,onPick:w,channelName:y,q:i})}),e.jsx("div",{className:"px-4 py-2 sm:px-6 sm:py-3 shrink-0 border-t border-border/40",children:e.jsxs("div",{className:"flex items-center justify-center gap-4 text-xs text-muted-foreground/60",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted/50 rounded text-xs font-mono",children:"â†‘"}),e.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted/50 rounded text-xs font-mono",children:"â†“"}),e.jsx("span",{children:n("noteSearch.keyboardShortcuts.navigate")})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted/50 rounded text-xs font-mono",children:"Enter"}),e.jsx("span",{children:n("noteSearch.keyboardShortcuts.open")})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted/50 rounded text-xs font-mono",children:"Esc"}),e.jsx("span",{children:n("noteSearch.keyboardShortcuts.close")})]})]})})]})}function hn(s){const{defaultScope:t="current"}=s||{};let n=null;return n=Il.show({content:e.jsx(Xf,{onClose:()=>n?.close(),defaultScope:t}),className:["w-screen max-w-none h-svh max-h-none rounded-none","sm:w-full sm:rounded-xl","sm:max-w-2xl","sm:h-[70vh] sm:max-h-[70vh]"].join(" "),position:"top",topOffset:96}),n}function sn({icon:s,onClick:t,title:n,ariaLabel:a}){return e.jsx(M,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105",onClick:t,title:n,"aria-label":a??n,children:e.jsx(s,{className:"h-4 w-4"})})}function Jf({showFadeEffect:s=!1}){const{t}=L(),n=ve(),a=O(u=>u.channels),r=O(u=>u.channelsLoading),o=J(u=>u.currentChannelId),i=m.useRef(null),[l,c]=m.useState(!1);Zr();const d=m.useMemo(()=>Qr(a),[a]);return m.useEffect(()=>{if(i.current){const{scrollHeight:u,clientHeight:h}=i.current;c(u>h)}}),r?e.jsx($f,{}):e.jsxs("div",{"data-component":"channel-list",className:"flex flex-col h-full overflow-hidden bg-card",children:[e.jsxs("div",{"data-component":"channel-list-header",className:"h-11 px-4 flex items-center justify-between border-b border-slate-200/50 dark:border-slate-700/50",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("h3",{className:"text-sm font-semibold text-slate-900 dark:text-slate-100 truncate",children:t("channelManagement.channelList.title")})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(sn,{icon:Je,onClick:()=>hn({defaultScope:"all"}),title:t("channelManagement.channelList.searchAllNotesTooltip"),ariaLabel:t("channelManagement.channelList.searchAllNotes")}),e.jsx(mn,{instantCreate:!0,trigger:e.jsx(sn,{icon:$e,onClick:()=>{},title:t("channelManagement.channelList.newSpace")})}),e.jsx(ea.ToggleButton,{})]})]}),e.jsx("div",{ref:i,"data-component":"channel-list-content",className:"flex-1 overflow-y-auto px-2.5 py-2 space-y-1 min-h-0 channel-list-content",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:d.length===0?e.jsx(Of,{}):d.map(u=>e.jsx(Mf,{channel:u,isActive:o===u.id,onClick:()=>{De.logChannelSelect(u.id,u.name,u.messageCount||0),n.viewStateManager.setCurrentChannel(u.id)}},u.id))}),l&&s&&e.jsx("div",{className:"relative",children:e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-6 bg-gradient-to-t from-slate-100/90 dark:from-slate-800/90 to-transparent pointer-events-none"})})]})}function Zf(){return m.useEffect(()=>{const s=t=>{(navigator.platform.toUpperCase().includes("MAC")?t.metaKey:t.ctrlKey)&&(t.key==="k"||t.key==="K")&&(t.preventDefault(),hn())};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[]),null}const Vo={js:"javascript",jsx:"jsx",ts:"typescript",tsx:"tsx","c++":"cpp","c#":"csharp",sh:"bash",zsh:"bash",shell:"bash",yml:"yaml",md:"markdown",py:"python",golang:"go"};function Wo(s,t){const n=s.trim().toLowerCase();return n?Vo[n]?Vo[n]:t.includes(n)?n:n==="text"||n==="plain"||n==="plaintext"?null:n:null}let On=[];const Qf=({node:s,updateAttributes:t,extension:n})=>{const{t:a}=L(),[r,o]=m.useState(!1),[i,l]=m.useState(""),[c,d]=m.useState(!1),u=m.useRef(!1),h=m.useRef(null),g=m.useRef(null),x=n.options&&n.options.lowlight||void 0,f=m.useMemo(()=>x?.listLanguages?x.listLanguages():[],[x]),p=s.attrs.language||null,b=m.useMemo(()=>{const w=i.trim().toLowerCase();return w?f.filter(N=>N.toLowerCase().includes(w)):f},[f,i]),v=w=>{t({language:w}),o(!1),w&&(On=[w,...On.filter(N=>N!==w)].slice(0,6))},y=async()=>{try{const w=g.current;if(!w)return;const N=w.textContent||"";await navigator.clipboard.writeText(N),d(!0),h.current&&window.clearTimeout(h.current),h.current=window.setTimeout(()=>{u.current||d(!1)},1200)}catch{}};return Ts.useEffect(()=>(u.current=!1,()=>{u.current=!0,h.current&&window.clearTimeout(h.current)}),[]),e.jsxs(Pm,{as:"div",className:"relative group",children:[e.jsxs("div",{className:"absolute right-2 top-2 z-10 flex items-center gap-1 opacity-95",onMouseDown:w=>{w.preventDefault()},children:[e.jsx("button",{type:"button",className:"px-2 h-6 rounded text-xs bg-slate-800/80 text-white hover:bg-slate-800",onClick:()=>o(w=>!w),children:p||a("editor.codeBlock.plainText")}),e.jsx("button",{type:"button",className:"px-2 h-6 rounded text-xs bg-slate-800/80 text-white hover:bg-slate-800",onClick:y,children:a(c?"common.copied":"common.copy")})]}),r&&e.jsxs("div",{className:"absolute right-2 top-10 z-20 w-56 rounded-md border bg-white dark:bg-slate-800 shadow-lg p-1 text-sm",onMouseDown:w=>w.preventDefault(),children:[e.jsx("div",{className:"p-1",children:e.jsx("input",{autoFocus:!0,placeholder:a("editor.codeBlock.searchLanguage"),value:i,onChange:w=>l(w.target.value),className:"w-full px-2 py-1 rounded border bg-transparent text-sm"})}),e.jsxs("div",{className:"max-h-64 overflow-auto",children:[On.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-2 py-1 text-xs text-slate-500",children:a("editor.codeBlock.recent")}),On.map(w=>e.jsx("button",{className:["w-full text-left px-2 py-1 rounded",p===w?"bg-slate-100 dark:bg-slate-700":"hover:bg-slate-100 dark:hover:bg-slate-700"].join(" "),onClick:()=>v(Wo(w,f)),children:w},`recent-${w}`)),e.jsx("div",{className:"my-1 border-t border-slate-200 dark:border-slate-700"})]}),e.jsx("button",{className:"w-full text-left px-2 py-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700",onClick:()=>v(null),children:a("editor.codeBlock.plainText")}),b.map(w=>e.jsx("button",{className:["w-full text-left px-2 py-1 rounded",p===w?"bg-slate-100 dark:bg-slate-700":"hover:bg-slate-100 dark:hover:bg-slate-700"].join(" "),onClick:()=>v(Wo(w,f)),children:w},w))]})]}),e.jsx("div",{className:"codeblock-grid",children:e.jsx("pre",{ref:g,className:"codeblock-pre",children:e.jsx(Om,{className:"hljs"})})})]})},ex=Hm.extend({addNodeView(){return _m(Qf)}});function qe(s,t){if(!s)return!1;const n=s;return n.type!=="element"?!1:t?n.tagName===t:!0}function tx(s){if(!s)return;const t=/text-align\s*:\s*(left|center|right)/i.exec(s);if(!t)return;const n=t[1].toLowerCase();if(n==="left"||n==="center"||n==="right")return n}function sx(s){let t=!1;return ir(s,"element",n=>{if(!qe(n))return;const a=n;if(a.tagName==="th"||a.tagName==="td"){const r=a.properties||{},o=parseInt(r.colspan||"1",10),i=parseInt(r.rowspan||"1",10);if((Number.isFinite(o)?o:1)>1||(Number.isFinite(i)?i:1)>1)return t=!0,sh}}),t}function nx(s){const t=s.children;for(let n=0;n<t.length;n++){const a=t[n];if(qe(a,"p")){const r=a.children||[];t.splice(n,1,...r),n+=r.length-1}}}function ax(s={}){const{flattenCells:t=!0,forceHeader:n=!0}=s;return function(r){ir(r,"element",o=>{if(!qe(o,"table"))return;const i=o;if(sx(i))return;const l=i.children,c=l.findIndex(w=>qe(w,"thead")),d=l.findIndex(w=>qe(w,"tbody")),u=w=>w?(w.children||[]).find(j=>qe(j,"tr")):void 0,h=l.find(w=>qe(w,"tr")),g=c>=0?l[c]:void 0,x=d>=0?l[d]:void 0;let f=u(g)||u(x)||h;if(!f)return;const p=g&&f&&f===u(g)?g:x&&f&&f===u(x)?x:i,b=(f.children||[]).every(w=>qe(w,"th")),y=p&&qe(p,"thead")||b;if(n&&!y){const w={type:"element",tagName:"tr",properties:{},children:(f.children||[]).map(C=>{const I=C;if(!qe(I))return I;const k=I.properties?.style||"",T=tx(k);return{type:"element",tagName:"th",properties:T?{align:T}:{},children:I.children||[]}})},N={type:"element",tagName:"thead",properties:{},children:[w]};let S=l.findIndex(C=>qe(C,"tbody")||qe(C,"tr")||qe(C,"tfoot"));S===-1&&(S=l.length),i.children.splice(S,0,N);const j=[i];g&&j.unshift(g),x&&j.unshift(x);for(const C of j){const I=C.children||[],k=I.indexOf(f);if(k>=0){I.splice(k,1);break}}f=w}t&&ir(i,"element",w=>{if(!qe(w))return;const N=w;(N.tagName==="th"||N.tagName==="td")&&nx(N)})})}}tl.setOptions({gfm:!0,breaks:!1});const rx=new eh({headingStyle:"atx",codeBlockStyle:"fenced",bulletListMarker:"-"});rx.use(th);function ox(s){if(typeof window>"u"||!s||s.indexOf('type="checkbox"')===-1)return s;try{const t=document.implementation.createHTMLDocument(""),n=t.createElement("div");return n.innerHTML=s,Array.from(n.querySelectorAll("ul")).forEach(a=>{const r=Array.from(a.querySelectorAll(":scope > li"));r.some(i=>i.querySelector('input[type="checkbox"]'))&&(a.setAttribute("data-type","taskList"),r.forEach(i=>{const l=i.querySelector('input[type="checkbox"]');if(!l)return;const c=l.checked||l.hasAttribute("checked"),d=Array.from(i.childNodes);l.parentElement&&l.parentElement.removeChild(l),i.innerHTML="",i.setAttribute("data-type","taskItem"),i.setAttribute("data-checked",c?"true":"false");const u=t.createElement("label");u.setAttribute("contenteditable","false"),u.appendChild(l);const h=t.createElement("span");u.appendChild(h),i.appendChild(u);const g=t.createElement("div");g.setAttribute("class","content");const x=d.filter(p=>p!==l);if(x.some(p=>p.nodeType===1&&/^(P|UL|OL|DIV|H[1-6]|BLOCKQUOTE|PRE|TABLE)$/i.test(p.tagName)))x.forEach(p=>{p.nodeType===3&&!p.textContent?.trim()||g.appendChild(p.cloneNode(!0))});else{const p=t.createElement("p");x.forEach(b=>{b.nodeType===3&&!b.textContent?.trim()||p.appendChild(b.cloneNode(!0))}),p.firstChild||p.appendChild(t.createTextNode("")),g.appendChild(p)}i.appendChild(g)}))}),n.innerHTML}catch{return s}}function ix(s){if(typeof window>"u"||!s||s.indexOf('data-type="taskList"')===-1)return s;try{const t=document.implementation.createHTMLDocument(""),n=t.createElement("div");return n.innerHTML=s,n.querySelectorAll('ul[data-type="taskList"]').forEach(a=>{a.classList.add("contains-task-list"),a.querySelectorAll(":scope > li").forEach(r=>{const o=r.getAttribute("data-checked"),i=o==="true"||o==="checked",l=r.querySelector(":scope > label"),c=r.querySelector(":scope > div.content")||r.querySelector(":scope > div"),d=t.createElement("input");d.type="checkbox",d.setAttribute("aria-label","Task item"),d.setAttribute("disabled","true"),i&&d.setAttribute("checked","true"),r.removeAttribute("data-checked"),l&&l.remove();const u=[];if(c){for(;c.firstChild;)u.push(c.firstChild),c.removeChild(c.firstChild);c.remove()}u.length||Array.from(r.childNodes).forEach(h=>{h.nodeType===1&&h.tagName==="INPUT"||u.push(h.cloneNode(!0))}),r.classList.add("task-list-item"),r.innerHTML="",r.appendChild(d),r.appendChild(t.createTextNode(" ")),u.forEach(h=>{if(h.nodeType===1&&h.tagName==="P"){const g=h;for(;g.firstChild;)r.appendChild(g.firstChild)}else{if(h.nodeType===3&&!h.textContent?.trim())return;r.appendChild(h)}})}),a.removeAttribute("data-type")}),n.innerHTML}catch{return s}}function Ba(s){if(!s)return"";try{const t=tl.parse(s);return ox(t)}catch{return s}}function lx(s){if(!s)return"";try{const t=ix(s),n={fences:!0,bullet:"-",rule:"-",listItemIndent:"one"},a=nh().use(ah,{fragment:!0}).use(ax).use(rh).use(sl).use(nl).use(lh,n).processSync(t);return String(a.value)}catch{return s}}const cx=ch.create({name:"slashCommand",addOptions(){return{char:"/",onOpen:()=>{},onUpdate:()=>{},onClose:()=>{},onMoveIndex:()=>{},onEnter:()=>{},onCommand:()=>{}}},addProseMirrorPlugins(){const s=this.editor,t=this.options,n={editor:s,char:t.char??"/",startOfLine:!0,allowSpaces:!0,command:({editor:a,range:r,props:o})=>{const i=o.action;i&&t.onCommand(a,r,i)},render:()=>({onStart:a=>{const r=a.clientRect?.()??null,o=i=>a.command(i);t.onOpen({query:a.query??"",range:a.range,clientRect:r,invoke:o})},onUpdate:a=>{const r=a.clientRect?.()??null,o=i=>a.command(i);t.onUpdate({query:a.query??"",range:a.range,clientRect:r,invoke:o})},onKeyDown:({event:a})=>a.key==="ArrowDown"?(t.onMoveIndex(1),a.preventDefault(),!0):a.key==="ArrowUp"?(t.onMoveIndex(-1),a.preventDefault(),!0):a.key==="Enter"?(t.onEnter(),a.preventDefault(),!0):a.key==="Escape"?(t.onClose(),a.preventDefault(),a.stopPropagation(),!0):!1,onExit:()=>{t.onClose()}})};return[dh(n)]}}),dx=/^(#{1,6})$/,ux=mh.extend({addKeyboardShortcuts(){const s=this.parent?.()??{};return{...s,Space:({editor:t})=>{const n=s.Space,{state:a}=t,{selection:r}=a;if(!r.empty)return n?n({editor:t}):!1;const{$from:o}=r,i=o.start(),l=a.doc.textBetween(i,r.from,`
`,`
`),c=dx.exec(l);if(!c)return n?n({editor:t}):!1;const d=c[1].length,u=r.from-l.length;return t.chain().focus().deleteRange({from:u,to:r.from}).toggleHeading({level:d}).run(),!0}}}}),de=Ts.forwardRef(({disabled:s,active:t,onClick:n,children:a,size:r="md",className:o="",...i},l)=>{const c=r==="sm"?"h-5 w-5 text-[11px]":"h-7 w-7 text-[13px]";return e.jsx("button",{ref:l,type:"button",onClick:n,disabled:s,className:["inline-flex items-center justify-center rounded transition-colors",c,s?"opacity-40 cursor-not-allowed":"hover:bg-slate-100 dark:hover:bg-slate-800",t?"bg-slate-100 dark:bg-slate-800":"bg-transparent",o].join(" "),...i,children:a})});de.displayName="ToolbarButton";function vn({value:s,onChange:t,editable:n=!0,placeholder:a,className:r="",variant:o="default",maxHeight:i,minHeight:l,enterSends:c=!1,onSubmitEnter:d,hideToolbar:u,suspended:h=!1}){const{t:g}=L(),x=a||g("editor.placeholder"),f=m.useMemo(()=>{const R=document.createElement("div");return R.style.zIndex="1100",R.style.pointerEvents="auto",R},[]),p=m.useMemo(()=>Ba(s||""),[s]),b=m.useRef(s||""),v=m.useRef(null),y=m.useRef(null),[w,N]=m.useState({open:!1,x:0,y:0,index:0,query:""}),S=m.useRef(w);m.useEffect(()=>{S.current=w},[w]);const j=m.useRef(null),[C,I]=m.useState({open:!1,rowX:0,rowY:0,colX:0,colY:0}),[k,T]=m.useState({x:-9999,y:-9999}),[z,D]=m.useState({row:!1,col:!1}),[$,H]=m.useState({open:!1,x:0,y:0,value:"",text:""}),ae=m.useRef(null),[re,je]=m.useState({open:!1,x:0,y:0,value:""}),Ne=m.useRef(null),Be=()=>{const R=y.current?.getBoundingClientRect(),A=window.getSelection();if(!R||!A||A.rangeCount===0)return{x:8,y:8};const P=A.getRangeAt(0).getBoundingClientRect();return{x:Math.max(8,P.left-R.left+(y.current?.scrollLeft||0)),y:Math.max(8,P.bottom-R.top+(y.current?.scrollTop||0))}},F=()=>{const{x:R,y:A}=Be(),P=v.current,U=P?.getAttributes("link")?.href||"";let oe="";try{if(P){const B=P.state.selection;B.empty||(oe=P.state.doc.textBetween(B.from,B.to))}}catch{oe=""}H({open:!0,x:R,y:A,value:U,text:oe})},G=()=>{const{x:R,y:A}=Be();je({open:!0,x:R,y:A,value:""})},Z=m.useMemo(()=>[zm.configure({codeBlock:!1,heading:!1}),ux,Gm,Vm.configure({openOnClick:!0,autolink:!0,linkOnPaste:!0,HTMLAttributes:{rel:"noopener noreferrer nofollow",target:"_blank"}}),Wm.configure({allowBase64:!0}),qm,Km.configure({resizable:!0}),Ym,Xm,Jm,Zm,Qm.configure({nested:!0}),ex.configure({lowlight:uh,defaultLanguage:null}),Um.configure({element:f,options:{placement:"top"},appendTo:()=>document.body,shouldShow:({editor:R,state:A})=>R.isEditable?!A.selection.empty:!1}),Fm.configure({placeholder:x,showOnlyWhenEditable:!0,showOnlyCurrent:!1}),cx.configure({onOpen:R=>{const A=R.clientRect||{left:8,top:8,bottom:16},P=typeof window<"u"?window.innerWidth:1024,U=typeof window<"u"?window.innerHeight:768,oe=A.top,B=A.left,V="bottom"in A&&typeof A.bottom=="number"?A.bottom:oe+16,le=Math.max(0,oe),Me=Math.max(0,U-V)>=le?"down":"up",We=Math.max(8,Math.min(B,P-260));N({open:!0,x:We,y:Me==="up"?oe:V,fixed:!0,place:Me,range:R.range,index:0,query:R.query,invoke:R.invoke})},onUpdate:R=>{const A=R.clientRect||{left:8,top:8,bottom:16},P=typeof window<"u"?window.innerWidth:1024,U=typeof window<"u"?window.innerHeight:768,oe=A.top,B=A.left,V="bottom"in A&&typeof A.bottom=="number"?A.bottom:oe+16,le=Math.max(0,oe),Me=Math.max(0,U-V)>=le?"down":"up",We=Math.max(8,Math.min(B,P-260)),nt=Me==="up"?oe:V;N(Ae=>({...Ae||{open:!0,index:0},open:!0,x:We,y:nt,fixed:!0,place:Me,range:R.range,query:R.query,invoke:R.invoke}))},onClose:()=>N({open:!1,x:0,y:0,index:0,query:""}),onMoveIndex:R=>N(A=>{const P=js(),U=Math.max(0,Math.min(P.length-1,A.index+R));return{...A,index:U}}),onEnter:()=>{const R=S.current,A=js().at(R.index);A&&R.invoke&&R.invoke({action:A.id})},onCommand:(R,A,P)=>{const U=R.chain().focus().deleteRange(A).setTextSelection(A.from);switch(P){case"h1":U.toggleHeading({level:1}).run();break;case"h2":U.toggleHeading({level:2}).run();break;case"h3":U.toggleHeading({level:3}).run();break;case"h4":U.toggleHeading({level:4}).run();break;case"h5":U.toggleHeading({level:5}).run();break;case"h6":U.toggleHeading({level:6}).run();break;case"bullet":U.toggleBulletList().run();break;case"ordered":U.toggleOrderedList().run();break;case"task":U.toggleTaskList().run();break;case"quote":U.toggleBlockquote().run();break;case"code":U.toggleCodeBlock().run();break;case"icode":U.toggleCode().run();break;case"hr":U.setHorizontalRule().run();break;case"table":U.insertTable({rows:3,cols:3,withHeaderRow:!0}).run();break;case"table-row-above":U.addRowBefore().run();break;case"table-row-below":U.addRowAfter().run();break;case"table-row-delete":U.deleteRow().run();break;case"table-col-left":U.addColumnBefore().run();break;case"table-col-right":U.addColumnAfter().run();break;case"table-col-delete":U.deleteColumn().run();break;case"table-delete":U.deleteTable().run();break;case"image":{U.run(),G();break}case"link":{U.run(),F();break}case"clear":U.unsetAllMarks().clearNodes().run();break;default:U.run()}}})],[a,f,N,G,F]),_=$m({extensions:Z,content:p,editable:n,editorProps:{attributes:{spellcheck:"false",style:o==="frameless"?"padding: 4px 6px; outline: none; height: 100%;":"min-height: 240px; padding: 12px; outline: none;"},handlePaste(R,A){const P=A.clipboardData?.getData("text/plain")||"";if(P.includes("```")){const B=Ba(P);if(B)return v.current?.chain().focus().insertContent(B).run(),!0}const oe=Array.from(A.clipboardData?.items||[]).find(B=>B.type.startsWith("image/"));if(oe){const B=oe.getAsFile();if(B){const V=new FileReader;return V.onload=()=>{typeof V.result=="string"&&v.current?.chain().focus().setImage({src:V.result}).run()},V.readAsDataURL(B),!0}}return!1},handleKeyDown(R,A){if(c&&A.key==="Enter")return A.metaKey||A.ctrlKey?(A.preventDefault(),d?.(),!0):!1;if(A.key==="Tab"){const P=v.current;if(!P)return!0;if(A.shiftKey)return P.can().liftListItem("taskItem")?(P.chain().focus().liftListItem("taskItem").run(),A.preventDefault(),!0):P.can().liftListItem("listItem")?(P.chain().focus().liftListItem("listItem").run(),A.preventDefault(),!0):!1;if(P.can().sinkListItem("taskItem"))return P.chain().focus().sinkListItem("taskItem").run(),A.preventDefault(),!0;if(P.can().sinkListItem("listItem"))return P.chain().focus().sinkListItem("listItem").run(),A.preventDefault(),!0;const{$from:U}=P.state.selection,B=U.parent?.textContent??"",V=/^\s*([-*+])\s+/.exec(B),le=/^\s*(\d+)[.)]\s+/.exec(B);return V?(P.chain().focus().toggleBulletList().run(),A.preventDefault(),!0):le?(P.chain().focus().toggleOrderedList().run(),A.preventDefault(),!0):!1}if((A.metaKey||A.ctrlKey)&&A.key.toLowerCase()==="k")return A.preventDefault(),F(),!0;if((A.metaKey||A.ctrlKey)&&A.altKey){const P=A.key;if(P==="1")return v.current?.chain().focus().toggleHeading({level:1}).run(),A.preventDefault(),!0;if(P==="2")return v.current?.chain().focus().toggleHeading({level:2}).run(),A.preventDefault(),!0;if(P==="3")return v.current?.chain().focus().toggleHeading({level:3}).run(),A.preventDefault(),!0;if(P==="4")return v.current?.chain().focus().toggleHeading({level:4}).run(),A.preventDefault(),!0;if(P==="5")return v.current?.chain().focus().toggleHeading({level:5}).run(),A.preventDefault(),!0;if(P==="6")return v.current?.chain().focus().toggleHeading({level:6}).run(),A.preventDefault(),!0;if(P==="0")return v.current?.chain().focus().setParagraph().run(),A.preventDefault(),!0}return!1},handleDOMEvents:{dblclick:(R,A)=>{const P=A.target;if(P&&P.tagName==="IMG"){const U=window.prompt(g("editor.image.urlPrompt"),P.src||"");return U===null?!0:U.trim()?(v.current?.chain().focus().setImage({src:U.trim(),alt:P.alt}).run(),!0):(v.current?.chain().focus().deleteSelection().run(),!0)}return!1},click:(R,A)=>{const P=A.target;return w.open&&!y.current?.contains(P)&&N({open:!1,x:0,y:0,index:0,query:""}),$.open&&(ae.current&&ae.current.contains(P)||Nt()),re.open&&(Ne.current&&Ne.current.contains(P)||Et()),!1},mousedown:(R,A)=>{const P=A.target;return $.open&&(ae.current&&ae.current.contains(P)||Nt()),re.open&&(Ne.current&&Ne.current.contains(P)||Et()),!1}}},onCreate:({editor:R})=>{v.current=R},onUpdate({editor:R}){const A=R.getHTML(),P=lx(A);P!==b.current&&(b.current=P,t?.(P))}});m.useEffect(()=>{if(_&&s!==b.current){b.current=s;const R=Ba(s||"");_.commands.setContent(R)}},[s,_]),m.useEffect(()=>{_&&_.setEditable(n)},[n,_]),m.useEffect(()=>{if(!_)return;const R=_.extensionManager.extensions.find(A=>A.name==="placeholder");R&&R.options&&(R.options.placeholder=a,_.view.dom.querySelectorAll("[data-placeholder]").forEach(U=>{U.setAttribute("data-placeholder",a||"")}))},[a,_]),m.useEffect(()=>{if(v.current&&h){try{v.current.commands.blur()}catch{}N({open:!1,x:0,y:0,index:0,query:""}),H({open:!1,x:0,y:0,value:"",text:""}),je({open:!1,x:0,y:0,value:""})}},[h]),m.useEffect(()=>{if(!w.open)return;const R=j.current;if(!R)return;const A=R.querySelector(`[data-slash-index="${w.index}"]`);if(A){const{offsetTop:P}=A,U=P+A.offsetHeight,oe=R.scrollTop,B=oe+R.clientHeight;if(P<oe)R.scrollTo({top:P,behavior:"auto"});else if(U>B){const V=U-B;R.scrollTo({top:oe+V,behavior:"auto"})}}},[w.index,w.open]);const q=(R,A)=>_?.isActive(R,A)??!1,Ce=R=>_?R():!1,Tt=[1,2,3,4,5,6],Ze=_?Tt.find(R=>_.isActive("heading",{level:R})):void 0,ys=Ze?`H${Ze}`:g("richEditor.text"),Nt=()=>H({open:!1,x:0,y:0,value:"",text:""}),Et=()=>je({open:!1,x:0,y:0,value:""});m.useEffect(()=>{if(!_)return;const R=_.extensionManager.extensions.find(A=>A.name==="bubbleMenu");R&&(R.options.shouldShow=({editor:A,state:P})=>!A.isEditable||w.open||$.open||re.open?!1:!P.selection.empty,_.view.dispatch(_.state.tr.setMeta("bubbleMenu","updatePosition")))},[_,w.open,$.open,re.open]),m.useEffect(()=>{if(!_)return;let R=0;const A=()=>{try{const V=_.view,{from:le}=_.state.selection,Me=V.domAtPos(le).node,nt=(Me&&Me.nodeType===3?Me.parentElement:Me)?.closest("td,th"),Ae=nt?.closest("tr"),Ge=nt?.closest("table");if(!nt||!Ae||!Ge){I(es=>es.open?{...es,open:!1}:es);return}const Ct=Ae.cells&&Ae.cells.length>0?Ae.cells[0]:Ae.querySelector("th,td"),$t=Ge.querySelector("tr"),at=$t?$t.cells[nt.cellIndex]:null;if(!Ct||!at){I(es=>es.open?{...es,open:!1}:es);return}const xe=y.current?.getBoundingClientRect(),Re=y.current?.scrollLeft||0,Bt=y.current?.scrollTop||0,ht=Ae.getBoundingClientRect(),Cn=Ct.getBoundingClientRect(),At=at.getBoundingClientRect(),kn=Cn.left-(xe?.left||0)+Re,zc=ht.top+ht.height/2-(xe?.top||0)+Bt,Hc=At.left+At.width/2-(xe?.left||0)+Re,Gc=At.top-(xe?.top||0)+Bt,lo=xe?.width||0,co=xe?.height||0,Ut=1,Vc=Math.max(Ut,Math.min(kn,lo-Ut)),Wc=Math.max(Ut,Math.min(zc,co-Ut)),qc=Math.max(Ut,Math.min(Hc,lo-Ut)),Kc=Math.max(Ut,Math.min(Gc,co-Ut));I({open:!0,rowX:Vc,rowY:Wc,colX:qc,colY:Kc})}catch{I(V=>V.open?{...V,open:!1}:V)}},P=()=>{cancelAnimationFrame(R),R=requestAnimationFrame(A)};_.on("selectionUpdate",P),_.on("transaction",P);const U=()=>P(),oe=()=>P(),B=V=>{const le=y.current?.getBoundingClientRect();le&&T({x:V.clientX-le.left+(y.current?.scrollLeft||0),y:V.clientY-le.top+(y.current?.scrollTop||0)})};return y.current?.addEventListener("scroll",U),y.current?.addEventListener("mousemove",B),window.addEventListener("resize",oe),P(),()=>{_.off("selectionUpdate",P),_.off("transaction",P),y.current?.removeEventListener("scroll",U),y.current?.removeEventListener("mousemove",B),window.removeEventListener("resize",oe),cancelAnimationFrame(R)}},[_]),m.useEffect(()=>{const A=Math.hypot(k.x-C.rowX,k.y-C.rowY),P=Math.hypot(k.x-C.colX,k.y-C.colY);D({row:C.open&&A<=20,col:C.open&&P<=20})},[k,C]);const Qt=[{label:g("richEditor.slashCommands.heading1"),id:"h1",group:g("richEditor.slashCommands.groups.headings"),aliases:["h1","title"]},{label:g("richEditor.slashCommands.heading2"),id:"h2",group:g("richEditor.slashCommands.groups.headings"),aliases:["h2"]},{label:g("richEditor.slashCommands.heading3"),id:"h3",group:g("richEditor.slashCommands.groups.headings"),aliases:["h3"]},{label:g("richEditor.slashCommands.bulletedList"),id:"bullet",group:g("richEditor.slashCommands.groups.lists"),aliases:["ul","unordered"]},{label:g("richEditor.slashCommands.numberedList"),id:"ordered",group:g("richEditor.slashCommands.groups.lists"),aliases:["ol","ordered","number"]},{label:g("richEditor.slashCommands.taskList"),id:"task",group:g("richEditor.slashCommands.groups.lists"),aliases:["todo","checkbox"]},{label:g("richEditor.slashCommands.quote"),id:"quote",group:g("richEditor.slashCommands.groups.blocks"),aliases:["blockquote"]},{label:g("richEditor.slashCommands.codeBlock"),id:"code",group:g("richEditor.slashCommands.groups.blocks"),aliases:["fence","```"]},{label:g("richEditor.slashCommands.inlineCode"),id:"icode",group:g("richEditor.slashCommands.groups.blocks"),aliases:["code inline"]},{label:g("richEditor.slashCommands.horizontalRule"),id:"hr",group:g("richEditor.slashCommands.groups.blocks"),aliases:["divider","line"]},{label:g("richEditor.slashCommands.table"),id:"table",group:g("richEditor.slashCommands.groups.table")},{label:g("richEditor.slashCommands.tableAddRowAbove"),id:"table-row-above",group:g("richEditor.slashCommands.groups.table")},{label:g("richEditor.slashCommands.tableAddRowBelow"),id:"table-row-below",group:g("richEditor.slashCommands.groups.table")},{label:g("richEditor.slashCommands.tableDeleteRow"),id:"table-row-delete",group:g("richEditor.slashCommands.groups.table")},{label:g("richEditor.slashCommands.tableAddColumnLeft"),id:"table-col-left",group:g("richEditor.slashCommands.groups.table")},{label:g("richEditor.slashCommands.tableAddColumnRight"),id:"table-col-right",group:g("richEditor.slashCommands.groups.table")},{label:g("richEditor.slashCommands.tableDeleteColumn"),id:"table-col-delete",group:g("richEditor.slashCommands.groups.table")},{label:g("richEditor.slashCommands.tableDeleteTable"),id:"table-delete",group:g("richEditor.slashCommands.groups.table")},{label:g("richEditor.slashCommands.image"),id:"image",group:g("richEditor.slashCommands.groups.mediaLinks"),aliases:["img","picture"]},{label:g("richEditor.slashCommands.link"),id:"link",group:g("richEditor.slashCommands.groups.mediaLinks"),aliases:["url"]},{label:g("richEditor.slashCommands.clearFormatting"),id:"clear",group:g("richEditor.slashCommands.groups.editing"),aliases:["reset","remove style"]}],js=()=>{const R=(w.query??"").toLowerCase();return R?Qt.filter(A=>A.label.toLowerCase().includes(R)||(A.aliases||[]).some(P=>P.toLowerCase().includes(R))):Qt},Ot=R=>{const A="w-4 h-4 text-slate-500";switch(R){case"h1":return e.jsx(pu,{className:A});case"h2":return e.jsx(gu,{className:A});case"h3":return e.jsx(hu,{className:A});case"h4":return e.jsx(mu,{className:A});case"h5":return e.jsx(uu,{className:A});case"h6":return e.jsx(du,{className:A});case"bullet":return e.jsx(Ya,{className:A});case"ordered":return e.jsx(fo,{className:A});case"task":return e.jsx(_t,{className:A});case"quote":return e.jsx(xo,{className:A});case"code":return e.jsx(Za,{className:A});case"icode":return e.jsx(Un,{className:A});case"hr":return e.jsx(Ka,{className:A});case"table":return e.jsx(bo,{className:A});case"image":return e.jsx(As,{className:A});case"link":return e.jsx(Sa,{className:A});case"clear":return e.jsx(po,{className:A});default:return null}},Ns={...i?{maxHeight:typeof i=="number"?`${i}px`:String(i)}:{},...l?{minHeight:typeof l=="number"?`${l}px`:String(l)}:{}};return e.jsxs("div",{style:Ns,className:[o==="frameless"?"border-0 rounded-none bg-transparent":"border rounded-md bg-background","flex flex-col min-h-0 gap-y-0",r].join(" "),children:[!u&&e.jsxs("div",{className:"flex items-center gap-0.5 px-1 pb-2 shrink-0",children:[e.jsx(de,{active:q("bold"),disabled:!Ce(()=>_.can().chain().focus().toggleBold().run()),onClick:()=>_?.chain().focus().toggleBold().run(),children:e.jsx(uo,{className:"w-4 h-4"})}),e.jsx(de,{active:q("italic"),disabled:!Ce(()=>_.can().chain().focus().toggleItalic().run()),onClick:()=>_?.chain().focus().toggleItalic().run(),children:e.jsx(mo,{className:"w-4 h-4"})}),e.jsx(de,{active:q("underline"),disabled:!Ce(()=>_.can().chain().focus().toggleUnderline().run()),onClick:()=>_?.chain().focus().toggleUnderline().run(),children:e.jsx(ho,{className:"w-4 h-4"})}),e.jsx(de,{active:q("strike"),disabled:!Ce(()=>_.can().chain().focus().toggleStrike().run()),onClick:()=>_?.chain().focus().toggleStrike().run(),children:e.jsx(go,{className:"w-4 h-4"})}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsx(de,{disabled:!Ce(()=>_.can().chain().focus().undo().run()),onClick:()=>_?.chain().focus().undo().run(),children:e.jsx(lu,{className:"w-4 h-4"})}),e.jsx(de,{disabled:!Ce(()=>_.can().chain().focus().redo().run()),onClick:()=>_?.chain().focus().redo().run(),children:e.jsx(cu,{className:"w-4 h-4"})}),e.jsx(de,{onClick:()=>_?.chain().focus().unsetAllMarks().clearNodes().run(),children:e.jsx(po,{className:"w-4 h-4"})}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsxs(de,{active:!!Ze,onClick:()=>{},className:"px-1.5 min-w-[44px] justify-between gap-1 text-xs",children:[e.jsx("span",{className:"font-medium text-xs",children:ys}),e.jsx(st,{className:"h-3 w-3 opacity-60"})]})}),e.jsxs(mt,{align:"start",className:"w-36 p-1 text-xs",children:[e.jsxs(Lt,{onSelect:()=>_?.chain().focus().setParagraph().run(),className:"flex items-center gap-2",children:[e.jsx("span",{className:"flex h-6 w-6 items-center justify-center rounded bg-slate-100 text-xs font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-200","aria-hidden":"true",children:g("richEditor.symbols.paragraph")}),e.jsx("span",{className:"font-medium",children:g("richEditor.text")})]}),e.jsx(Dt,{className:"my-1"}),Tt.map(R=>e.jsxs(Lt,{onSelect:()=>_?.chain().focus().toggleHeading({level:R}).run(),className:"flex items-center gap-2",children:[e.jsx("span",{className:"flex h-6 w-6 items-center justify-center rounded bg-slate-100 text-xs font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-200","aria-hidden":"true",children:g("richEditor.symbols.heading",{level:R})}),e.jsx("span",{className:"font-medium",children:g("richEditor.heading",{level:R})})]},R))]})]}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsx(de,{active:q("bulletList"),onClick:()=>_?.chain().focus().toggleBulletList().run(),children:e.jsx(Ya,{className:"w-4 h-4"})}),e.jsx(de,{active:q("orderedList"),onClick:()=>_?.chain().focus().toggleOrderedList().run(),children:e.jsx(fo,{className:"w-4 h-4"})}),e.jsx(de,{active:q("taskList"),onClick:()=>_?.chain().focus().toggleTaskList().run(),children:e.jsx(_t,{className:"w-4 h-4"})}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsx(de,{active:q("blockquote"),onClick:()=>_?.chain().focus().toggleBlockquote().run(),children:e.jsx(xo,{className:"w-4 h-4"})}),e.jsx(de,{active:q("code"),disabled:!Ce(()=>_.can().chain().focus().toggleCode().run()),onClick:()=>_?.chain().focus().toggleCode().run(),children:e.jsx(Un,{className:"w-4 h-4"})}),e.jsx(de,{active:q("codeBlock"),onClick:()=>_?.chain().focus().toggleCodeBlock().run(),children:e.jsx(Za,{className:"w-4 h-4"})}),e.jsx(de,{onClick:()=>_?.chain().focus().setHorizontalRule().run(),children:e.jsx(Ka,{className:"w-4 h-4"})}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsx(de,{onClick:()=>{F()},children:e.jsx(Sa,{className:"w-4 h-4"})}),e.jsx(de,{onClick:()=>{const R=window.prompt(g("editor.image.urlOrBase64Prompt"));R&&_?.chain().focus().setImage({src:R}).run()},children:e.jsx(As,{className:"w-4 h-4"})}),e.jsx(de,{onClick:()=>_?.chain().focus().insertTable({rows:3,cols:3,withHeaderRow:!0}).run(),children:e.jsx(bo,{className:"w-4 h-4"})})]}),e.jsxs("div",{ref:y,className:"relative min-h-0 flex-1 overflow-y-auto",children:[e.jsx("div",{className:["relative h-full",u?"":"pt-0.5",o==="frameless"?"px-3 pb-0":"px-3 pb-3"].join(" "),children:e.jsx(Bm,{editor:_,className:[o==="frameless"?"tiptap max-w-none h-full outline-none focus:outline-none":"tiptap prose dark:prose-invert max-w-none h-full outline-none focus:outline-none"].join(" ")})}),$.open&&e.jsx("div",{ref:ae,style:{position:"absolute",left:$.x,top:$.y,zIndex:1e3,minWidth:320},className:"rounded-md border bg-white dark:bg-slate-800 shadow-lg p-2 text-sm",onMouseDown:R=>R.preventDefault(),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{autoFocus:!0,value:$.value,onChange:R=>H(A=>({...A,value:R.target.value})),placeholder:g("editor.link.urlPlaceholder"),className:"w-56 px-2 py-1 rounded border bg-transparent text-sm"}),e.jsx("input",{value:$.text,onChange:R=>H(A=>({...A,text:R.target.value})),placeholder:g("editor.link.textPlaceholder"),className:"w-40 px-2 py-1 rounded border bg-transparent text-sm"}),e.jsx("button",{type:"button",className:"px-2 h-7 rounded text-xs bg-slate-900 text-white dark:bg-slate-200 dark:text-slate-900",onClick:()=>{const R=$.value.trim(),A=($.text||"").trim(),P=_;if(P){if(!R){P.chain().focus().unsetLink().run(),Nt();return}if(A){const U=R.replace(/"/g,"&quot;"),oe=A.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");P.chain().focus().insertContent(`<a href="${U}">${oe}</a>`).run(),Nt();return}if(!P.state.selection.empty)P.chain().focus().setLink({href:R}).run();else{const U=R.replace(/"/g,"&quot;"),oe=R.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");P.chain().focus().insertContent(`<a href="${U}">${oe}</a>`).run()}Nt()}},children:g("common.save")}),e.jsx("button",{type:"button",className:"px-2 h-7 rounded text-xs bg-slate-100 dark:bg-slate-700",onClick:()=>{_?.chain().focus().unsetLink().run(),Nt()},children:g("editor.link.unlink")}),e.jsx("button",{type:"button",className:"px-2 h-7 rounded text-xs bg-slate-100 dark:bg-slate-700",onClick:()=>Nt(),"aria-label":g("editor.link.close"),children:g("common.close")})]})}),re.open&&e.jsx("div",{ref:Ne,style:{position:"absolute",left:re.x,top:re.y,zIndex:1e3,minWidth:280},className:"rounded-md border bg-white dark:bg-slate-800 shadow-lg p-2 text-sm",onMouseDown:R=>R.preventDefault(),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{autoFocus:!0,value:re.value,onChange:R=>je(A=>({...A,value:R.target.value})),onKeyDown:R=>{if(R.key==="Enter"){const A=re.value.trim();A&&_?.chain().focus().setImage({src:A}).run(),Et()}R.key==="Escape"&&Et()},placeholder:g("editor.image.urlPlaceholder"),className:"w-56 px-2 py-1 rounded border bg-transparent text-sm"}),e.jsx("button",{type:"button",className:"px-2 h-7 rounded text-xs bg-slate-900 text-white dark:bg-slate-200 dark:text-slate-900",onClick:()=>{const R=re.value.trim();R&&_?.chain().focus().setImage({src:R}).run(),Et()},children:g("editor.image.insert")}),e.jsx("button",{type:"button",className:"px-2 h-7 rounded text-xs bg-slate-100 dark:bg-slate-700",onClick:()=>Et(),"aria-label":g("editor.image.close"),children:g("common.close")})]})}),_&&f&&Wa.createPortal(e.jsxs("div",{className:"rounded-lg bg-white dark:bg-slate-800 shadow-lg border border-slate-200 dark:border-slate-700 p-1 flex items-center gap-0.5",onMouseDown:R=>R.preventDefault(),children:[e.jsx(de,{active:q("bold"),onClick:()=>_?.chain().focus().toggleBold().run(),children:e.jsx(uo,{className:"w-4 h-4"})}),e.jsx(de,{active:q("italic"),onClick:()=>_?.chain().focus().toggleItalic().run(),children:e.jsx(mo,{className:"w-4 h-4"})}),e.jsx(de,{active:q("underline"),onClick:()=>_?.chain().focus().toggleUnderline().run(),children:e.jsx(ho,{className:"w-4 h-4"})}),e.jsx(de,{active:q("strike"),onClick:()=>_?.chain().focus().toggleStrike().run(),children:e.jsx(go,{className:"w-4 h-4"})}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsx(de,{active:q("code"),onClick:()=>_?.chain().focus().toggleCode().run(),children:e.jsx(Un,{className:"w-4 h-4"})}),e.jsx(de,{active:q("link"),onClick:()=>{F()},children:e.jsx(Sa,{className:"w-4 h-4"})})]}),f),C.open&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{position:"absolute",left:C.rowX,top:C.rowY,zIndex:1e3,transform:"translateX(-100%) translateX(-1px) translateY(-50%)"},className:["bg-transparent border-0 shadow-none p-0 flex flex-col items-center gap-0.5 transition-opacity",z.row?"opacity-100":"opacity-30"].join(" "),onMouseDown:R=>R.preventDefault(),children:[e.jsx(de,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!Ce(()=>_.can().chain().focus().addRowBefore().run()),onClick:()=>_?.chain().focus().addRowBefore().run(),children:e.jsx(bs,{className:"w-3 h-3",strokeWidth:2})}),e.jsx(de,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!Ce(()=>_.can().chain().focus().deleteRow().run()),onClick:()=>_?.chain().focus().deleteRow().run(),children:e.jsx(jt,{className:"w-3 h-3",strokeWidth:2})}),e.jsx(de,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!Ce(()=>_.can().chain().focus().addRowAfter().run()),onClick:()=>_?.chain().focus().addRowAfter().run(),children:e.jsx(st,{className:"w-3 h-3",strokeWidth:2})})]}),e.jsxs("div",{style:{position:"absolute",left:C.colX,top:C.colY,zIndex:1e3,transform:"translateY(-100%) translateY(-1px) translateX(-50%)"},className:["bg-transparent border-0 shadow-none p-0 flex items-center gap-0.5 transition-opacity",z.col?"opacity-100":"opacity-30"].join(" "),onMouseDown:R=>R.preventDefault(),children:[e.jsx(de,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!Ce(()=>_.can().chain().focus().addColumnBefore().run()),onClick:()=>_?.chain().focus().addColumnBefore().run(),children:e.jsx(Ti,{className:"w-3 h-3",strokeWidth:2})}),e.jsx(de,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!Ce(()=>_.can().chain().focus().deleteColumn().run()),onClick:()=>_?.chain().focus().deleteColumn().run(),children:e.jsx(jt,{className:"w-3 h-3",strokeWidth:2})}),e.jsx(de,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!Ce(()=>_.can().chain().focus().addColumnAfter().run()),onClick:()=>_?.chain().focus().addColumnAfter().run(),children:e.jsx(ha,{className:"w-3 h-3",strokeWidth:2})})]})]}),w.open&&Wa.createPortal(e.jsx("div",{style:{position:"fixed",left:w.x,top:w.y,zIndex:1100,minWidth:240,transform:w.place==="up"?"translateY(-100%) translateY(-8px)":"translateY(8px)"},className:"rounded-md border bg-white dark:bg-slate-800 shadow-lg p-1 text-sm",children:e.jsx("div",{ref:j,className:"max-h-64 overflow-auto",children:(()=>{const R=js(),A=[];let P;return R.forEach((U,oe)=>{U.group&&U.group!==P&&A.push(e.jsx("div",{className:"px-2 pt-2 pb-1 text-[11px] uppercase tracking-wide text-slate-400",children:U.group},`group-${U.group}-${oe}`)),A.push(e.jsxs("button",{"data-slash-index":oe,className:["w-full text-left px-2 py-1 rounded flex items-center gap-2",oe===w.index?"bg-slate-100 dark:bg-slate-700":"hover:bg-slate-100 dark:hover:bg-slate-700"].join(" "),onMouseDown:B=>{B.preventDefault()},onClick:()=>w.invoke?.({action:U.id}),children:[e.jsx("span",{className:"shrink-0",children:Ot(U.id)}),e.jsx("span",{children:U.label})]},`item-${U.label}-${oe}`)),P=U.group}),A})()})}),document.body)]})]})}function to(s){let t=0;for(let a=0;a<s.length;a+=1)t=Math.imul(31,t)+s.charCodeAt(a),t|=0;return(t>>>0).toString(16).padStart(8,"0")}const te=_e()(Xt((s,t)=>({editingMessageId:null,editingChannelId:null,editContent:"",originalContent:"",isDirty:!1,isSaving:!1,baseHash:null,showDraftPrompt:!1,restoredFromDraft:!1,drafts:{},editMode:"inline",editorMode:"wysiwyg",startEditing:(n,a,r)=>{const o=r?.baseHash??to(a),i=t().drafts[n],l=!!i&&i.baseHash===o,{currentChannelId:c}=J.getState(),d=r?.channelId??c??null;i&&!l&&s(x=>{const f={...x.drafts};return delete f[n],{drafts:f}});const u=!!r?.restoreDraft&&l,h=u&&i?i.content:a,g=t().editorMode;s({editingMessageId:n,editingChannelId:d,editContent:h,originalContent:a,isDirty:h!==a,isSaving:!1,baseHash:o,showDraftPrompt:l&&!u,restoredFromDraft:u,editMode:"inline",editorMode:g})},updateContent:n=>{const a=t();if(!a.editingMessageId)return;const r=a.editingMessageId,o=n.trim(),i=a.originalContent.trim(),l=o!==i,c=l&&o.length>0,d=a.drafts[r];a.editContent===n&&a.isDirty===l&&(c&&d&&d.content===n||!c&&(!d||a.showDraftPrompt))||s(h=>{let g=h.drafts;if(c&&h.baseHash){const f=h.drafts[r];(!f||f.content!==n||f.baseHash!==h.baseHash)&&(g={...h.drafts,[r]:{content:n,baseHash:h.baseHash,updatedAt:Date.now()}})}else if(h.drafts[r]&&(!h.showDraftPrompt||h.restoredFromDraft)){const{[r]:f,...p}=h.drafts;g=p}const x=50;if(Object.keys(g).length>x){const p=Object.entries(g).sort((b,v)=>(v[1].updatedAt||0)-(b[1].updatedAt||0)).slice(0,x);g=Object.fromEntries(p)}return{editContent:n,isDirty:l,drafts:g,showDraftPrompt:!1}})},switchToExpandedMode:()=>{s({editMode:"expanded",editorMode:"wysiwyg"})},switchToInlineMode:()=>{s({editMode:"inline"})},setEditorMode:n=>{s({editorMode:n})},save:async(n=!0)=>{const{editingMessageId:a,editContent:r,editingChannelId:o}=t();if(!(!a||!r.trim())){s({isSaving:!0});try{const{userId:i}=O.getState();if(!i)throw new Error("User not authenticated");const l=J.getState().currentChannelId,c=o??l;if(!c)throw new Error("No current channel selected");await X.updateMessage({messageId:a,channelId:c,updates:{content:r.trim()},userId:i}),t().clearDraft(a),n?t().reset():s({isSaving:!1,isDirty:!1,originalContent:r.trim(),restoredFromDraft:!1})}catch(i){console.error("Failed to save message:",i)}finally{s(i=>i.isSaving?{isSaving:!1}:{})}}},cancel:()=>{t().reset()},reset:()=>{s({editingMessageId:null,editingChannelId:null,editContent:"",originalContent:"",isDirty:!1,isSaving:!1,baseHash:null,showDraftPrompt:!1,restoredFromDraft:!1,editMode:"inline",editorMode:"wysiwyg"})},applyDraft:()=>{const{editingMessageId:n,drafts:a,originalContent:r}=t();if(!n)return;const o=a[n];o&&s({editContent:o.content,isDirty:o.content!==r,showDraftPrompt:!1,restoredFromDraft:!0})},dismissDraftPrompt:()=>{const{editingMessageId:n}=t();s(a=>{let r=a.drafts;if(n&&a.drafts[n]){const{[n]:o,...i}=a.drafts;r=i}return r===a.drafts?{showDraftPrompt:!1}:{showDraftPrompt:!1,drafts:r}})},clearDraft:n=>{s(a=>{if(!a.drafts[n])return{};const r={...a.drafts};return delete r[n],{drafts:r}})}}),{name:"stillroot-edit-state-storage",partialize:s=>({drafts:s.drafts,editorMode:s.editorMode})})),mx=({channel:s,isSelected:t,isCurrent:n,onSelect:a,highlightQuery:r})=>{const o=m.useCallback(()=>{a(s.id)},[s.id,a]),i=(l,c)=>{if(!c)return l;const d=l.split(new RegExp(`(${c})`,"gi"));return e.jsx(e.Fragment,{children:d.map((u,h)=>u.toLowerCase()===c.toLowerCase()?e.jsx("mark",{className:"bg-primary/20 text-primary font-medium px-0.5 rounded",children:u},h):e.jsx("span",{children:u},h))})};return e.jsxs("div",{role:"option","aria-selected":t,onClick:o,className:E("flex items-center gap-2 px-2.5 py-1.5 rounded-lg cursor-pointer transition-all duration-200 min-h-[40px]",t?"bg-primary/6 text-primary":"hover:bg-accent/25 text-foreground",n&&!t&&"ring-1 ring-primary/30"),children:[e.jsx("div",{className:"w-5 h-5 rounded flex items-center justify-center flex-shrink-0 text-muted-foreground",children:s.emoji?e.jsx("span",{className:"text-sm leading-none",children:s.emoji}):ec(s.id)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"font-medium text-sm truncate",children:r?i(s.name,r):s.name}),s.messageCount!==void 0&&s.messageCount>0&&e.jsx(He,{variant:"secondary",className:"text-[10px] px-1.5 py-0 h-4 flex-shrink-0 font-normal",children:s.messageCount})]}),s.description&&e.jsx("div",{className:"text-xs text-muted-foreground truncate mt-0.5",children:s.description})]}),e.jsxs("div",{className:"flex-shrink-0 ml-1",children:[t&&e.jsx(Xe,{className:"w-4 h-4 text-primary"}),n&&!t&&e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-primary/60"})]})]})},ic=({currentChannel:s,channels:t,onChannelSelect:n,trigger:a,className:r="",maxHeight:o=400,itemHeight:i=40})=>{const{t:l}=L(),[c,d]=m.useState(!1),[u,h]=m.useState(""),[g,x]=m.useState(0),f=m.useRef(null),p=m.useRef(null),b=m.useMemo(()=>eo(t,s.id),[t,s.id]),{recentChannels:v,otherChannels:y,allChannels:w}=m.useMemo(()=>{if(u.trim()){const H=u.toLowerCase().trim(),ae=b.filter(re=>re.name.toLowerCase().includes(H)||re.description?.toLowerCase().includes(H));return{recentChannels:[],otherChannels:[],allChannels:ae}}const T=qh(),z=new Map,D=[];for(const H of b)T.includes(H.id)&&H.id!==s.id?z.set(H.id,H):H.id!==s.id&&D.push(H);return{recentChannels:T.map(H=>z.get(H)).filter(H=>H!==void 0).slice(0,8),otherChannels:D,allChannels:[]}},[b,s.id,u]);m.useEffect(()=>{c&&f.current&&setTimeout(()=>{f.current?.focus()},0)},[c]);const N=m.useMemo(()=>{if(u.trim()||w.length>0)return w.map(z=>({type:"channel",channel:z}));const T=[];return v.length>0&&(v.forEach(z=>{T.push({type:"channel",channel:z})}),y.length>0&&T.push({type:"separator",label:l("spaceSelector.allSpaces")})),y.forEach(z=>{T.push({type:"channel",channel:z})}),T},[v,y,w,u]);m.useEffect(()=>{c||h(""),x(0)},[c,N.length]);const S=m.useCallback(T=>{n(T),d(!1)},[n]),j=m.useMemo(()=>N.filter(T=>T.type==="channel"),[N]),C=m.useCallback(T=>{if(T.key==="ArrowDown"){T.preventDefault();const z=Math.min(g+1,j.length-1);x(z),p.current&&z<j.length&&p.current.scrollToIndex({index:z,align:"center",behavior:"smooth"})}else if(T.key==="ArrowUp"){T.preventDefault();const z=Math.max(g-1,0);x(z),p.current&&z>=0&&p.current.scrollToIndex({index:z,align:"center",behavior:"smooth"})}else T.key==="Enter"&&j[g]?(T.preventDefault(),S(j[g].channel.id)):T.key==="Escape"&&d(!1)},[g,j,S]),I=m.useCallback(T=>{h(T.target.value),x(0),p.current&&p.current.scrollToIndex({index:0,behavior:"auto"})},[]),k=m.useCallback(()=>{h(""),x(0),f.current?.focus(),p.current&&p.current.scrollToIndex({index:0,behavior:"auto"})},[]);return e.jsx("div",{className:r,children:e.jsxs(dt,{open:c,onOpenChange:d,children:[e.jsx(ut,{asChild:!0,children:a}),e.jsxs(mt,{className:"w-80 p-0 overflow-hidden",align:"start",sideOffset:8,onKeyDown:C,children:[e.jsx("div",{className:"p-2 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx(Je,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground pointer-events-none"}),e.jsx(Oe,{ref:f,placeholder:l("spaceSelector.searchPlaceholder"),value:u,onChange:I,onKeyDown:C,className:"pl-8 pr-8 h-8 text-sm"}),u&&e.jsx("button",{onClick:k,className:"absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground hover:text-foreground transition-colors","aria-label":l("common.clearSearch"),children:e.jsx(fe,{className:"w-4 h-4"})})]})}),e.jsx("div",{className:"overflow-hidden py-1",style:{maxHeight:`${o}px`},children:j.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-4 text-center",children:[e.jsx("div",{className:"text-muted-foreground/50 mb-2 text-2xl",children:u?"ðŸ”":"ðŸ“"}),e.jsx("div",{className:"text-sm text-muted-foreground font-medium mb-1",children:l(u?"spaceSelector.noSpacesFound":"spaceSelector.noSpacesAvailable")}),u&&e.jsx("div",{className:"text-xs text-muted-foreground/70",children:l("spaceSelector.tryDifferentSearch")})]}):e.jsx(al,{ref:p,data:N,totalCount:N.length,itemContent:(T,z)=>{if(z.type==="separator")return e.jsx("div",{className:"px-3 py-1.5 h-8 flex items-center",children:e.jsx("div",{className:"text-xs font-medium text-muted-foreground/70 uppercase tracking-wide",children:z.label})});const D=N.slice(0,T+1).filter($=>$.type==="channel").length-1;return e.jsx("div",{className:"px-2 py-0.5",children:e.jsx(mx,{channel:z.channel,isSelected:D===g,isCurrent:z.channel.id===s.id,onSelect:S,highlightQuery:u||void 0})})},defaultItemHeight:i+4,style:{height:`${Math.min(N.reduce((T,z)=>T+(z.type==="separator"?32:i+4),0),o-72)}px`,maxHeight:`${o-72}px`},overscan:5})})]})]})})},so=({currentChannel:s,channels:t,onChannelSelect:n,className:a=""})=>{const r=e.jsx(M,{variant:"ghost",className:`h-auto px-2 py-1.5 hover:bg-muted/50 active:bg-muted/70 transition-all duration-200 touch-manipulation min-h-[36px] ${a}`,children:e.jsxs("div",{className:"flex items-center space-x-1.5 min-w-0 max-w-full",children:[s.emoji&&e.jsx("div",{className:"text-base flex-shrink-0",children:s.emoji}),e.jsx("div",{className:"flex items-center min-w-0 flex-1",children:e.jsx("h1",{className:"text-base font-medium text-foreground/90 truncate",children:s.name})}),e.jsx(st,{className:"h-3.5 w-3.5 text-muted-foreground flex-shrink-0"})]})});return e.jsx(ic,{currentChannel:s,channels:t,onChannelSelect:n,trigger:r,className:a,maxHeight:360,itemHeight:44})};function lc({headerLeft:s,headerRight:t,banner:n,children:a,onKeyDown:r,onKeyDownCapture:o,className:i}){return e.jsxs("div",{className:E("w-full h-full min-h-0 flex flex-col bg-background",i),"data-component":"expanded-surface",onKeyDown:r,onKeyDownCapture:o,children:[(s||t)&&e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-slate-200 dark:border-slate-700 bg-slate-50/40 dark:bg-slate-800/30",children:[e.jsx("div",{className:"flex items-center gap-1.5 min-w-0",children:s}),e.jsx("div",{className:"flex items-center gap-1.5",children:t})]}),e.jsxs("div",{className:"flex-1 min-h-0 p-3 overflow-hidden flex flex-col gap-3",children:[n,e.jsx("div",{className:"flex-1 min-h-0",children:a})]})]})}function hx(){const{t:s}=L(),t=ve(),n=te(w=>w.editContent),a=te(w=>w.isSaving),r=te(w=>w.isDirty),o=te(w=>w.editingMessageId),i=te(w=>w.showDraftPrompt),l=te(w=>w.restoredFromDraft),c=te(w=>w.editingChannelId),d=O(w=>w.channels),u=te(m.useCallback(w=>o?w.drafts[o]:void 0,[o])),h=m.useMemo(()=>i&&!!u&&!l,[i,u,l]),[g,x]=m.useState(!1),f=m.useMemo(()=>{const w=c??void 0;return w?d.find(N=>N.id===w):void 0},[d,c]),p=()=>{t.noteEditManager.switchToInlineMode()},b=async()=>{!n.trim()||!r||a||(await t.noteEditManager.save(!1),x(!0))};m.useEffect(()=>{r&&x(!1)},[r]),m.useEffect(()=>{x(!1)},[o]);const v=a?"saving":g&&!r?"saved":"idle",y=v==="saving"?s("common.saving"):v==="saved"?s("common.saved"):"";return e.jsx(lc,{className:"w-full h-full",headerLeft:e.jsxs(e.Fragment,{children:[f&&e.jsx("div",{className:"pointer-events-none opacity-80",children:e.jsx(so,{currentChannel:f,channels:d,onChannelSelect:()=>{},className:"max-w-[240px]"})}),y&&e.jsx("span",{className:"text-xs text-slate-500 dark:text-slate-400",children:y}),e.jsx(M,{variant:"ghost",size:"icon",onClick:b,disabled:a||!n.trim()||!r,className:"h-9 w-9 text-muted-foreground hover:text-foreground","aria-label":s("common.save"),title:s("common.save"),children:a?e.jsx(Mt,{className:"w-4 h-4 animate-spin"}):v==="saved"?e.jsx(Xe,{className:"w-4 h-4"}):e.jsx(Pi,{className:"w-4 h-4"})})]}),headerRight:e.jsx(M,{variant:"ghost",size:"icon",onClick:p,className:"h-9 w-9","aria-label":s("common.collapse"),title:s("common.collapse"),children:e.jsx(Lr,{className:"w-4 h-4"})}),banner:h?e.jsx("div",{className:"rounded-md border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900 dark:border-amber-400/30 dark:bg-amber-500/10 dark:text-amber-100",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx("div",{className:"font-medium",children:s("notes.expandedEditor.unsavedDraft")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-8 rounded-md bg-amber-500 px-3 text-xs font-medium text-white transition-colors hover:bg-amber-600",onClick:()=>t.noteEditManager.applyDraft(),children:s("notes.expandedEditor.restoreDraft")}),e.jsx("button",{type:"button",className:"h-8 rounded-md px-3 text-xs font-medium text-amber-700 transition-colors hover:bg-amber-100 hover:text-amber-900 dark:text-amber-100 dark:hover:bg-amber-500/20",onClick:()=>t.noteEditManager.dismissDraftPrompt(),children:s("common.dismiss")})]})]})}):null,onKeyDownCapture:async w=>{if(w.key==="Escape"&&p(),w.key.toLowerCase()==="s"&&(w.metaKey||w.ctrlKey)){w.preventDefault(),await b();return}w.key==="Enter"&&w.shiftKey&&(w.preventDefault(),await b())},children:e.jsx(vn,{value:n,onChange:t.noteEditManager.updateContent,editable:!a,placeholder:"",className:"h-full",variant:"frameless"})})}const gx=600,Fe=_e((s,t)=>({statusMap:{},activeMessageId:null,inlineOverlap:!1,activeVisibleHeight:null,pendingCollapseId:null,layoutSync:null,shouldSuppressAutoScroll:!1,suppressionTimestamp:null,setStatus:(n,a)=>s(r=>({statusMap:{...r.statusMap,[n]:a}})),setActiveInfo:(n,a,r)=>s({activeMessageId:n,inlineOverlap:a,activeVisibleHeight:r}),requestCollapse:n=>s({pendingCollapseId:n}),acknowledgeCollapse:()=>s({pendingCollapseId:null}),registerLayoutSync:n=>s({layoutSync:n}),notifyLayoutChange:()=>{const n=t().layoutSync;n?.()},activateAutoScrollSuppression:()=>s({shouldSuppressAutoScroll:!0,suppressionTimestamp:Date.now()}),shouldSuppressAutoScrollNow:()=>{const n=t();return n.shouldSuppressAutoScroll?n.suppressionTimestamp&&Date.now()-n.suppressionTimestamp>gx?(s({shouldSuppressAutoScroll:!1,suppressionTimestamp:null}),!1):!0:!1}})),cc=s=>{const t=s.activeMessageId;if(!t)return!1;const n=s.statusMap[t];return!n||!n.long||!n.expanded||!s.inlineOverlap?!1:n.collapseThreshold<=0||s.activeVisibleHeight==null?!0:s.activeVisibleHeight>n.collapseThreshold+1};function ws(){const{currentChannelId:s}=J(),t=Wt(m.useCallback(i=>s?i.timelineInputCollapsed[s]??!1:!1,[s])),n=Wt(m.useCallback(i=>i.setTimelineInputCollapsed,[])),a=Fe(m.useCallback(i=>i.notifyLayoutChange,[])),r=m.useCallback(()=>{s&&(De.logInputCollapse(pr.COLLAPSE),n(s,!0),a())},[s,n,a]),o=m.useCallback(()=>{s&&(De.logInputCollapse(pr.EXPAND),n(s,!1),a())},[s,n,a]);return{inputCollapsed:t,handleCollapseInput:r,handleExpandInput:o,currentChannelId:s}}const qt=_e()(s=>({expanded:!1,drafts:{},setExpanded:t=>s({expanded:t}),setDraft:(t,n)=>s(a=>({drafts:{...a.drafts,[t]:n}})),clearDraft:t=>s(n=>{const a={...n.drafts};return delete a[t],{drafts:a}})}));function px({message:s,onMessageChange:t,onKeyDown:n,placeholder:a,disabled:r}){const{handleExpandInput:o,inputCollapsed:i}=ws(),l=qt(u=>u.expanded);return e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"relative min-h-[80px]","data-tour":"timeline-composer",onMouseDown:o,children:e.jsx(vn,{value:s,onChange:t,editable:!r,placeholder:a,variant:"frameless",hideToolbar:!0,minHeight:80,maxHeight:120,enterSends:!0,suspended:i||l,onSubmitEnter:()=>{n({key:"Enter",metaKey:!0,ctrlKey:!0,preventDefault:()=>{}})}})})})}function fx({replyToMessage:s,onCancelReply:t}){const{t:n}=L();return e.jsx("div",{className:"px-3 py-1.5 bg-blue-50 dark:bg-blue-900/20",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fu,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm text-blue-700 dark:text-blue-300",children:n("messageInput.reply.label")}),e.jsxs("span",{className:"text-sm text-slate-600 dark:text-slate-400 truncate",children:[s.content.substring(0,50),"..."]})]}),e.jsx("button",{onClick:t,className:"text-slate-400 hover:text-slate-600 dark:hover:text-slate-300",children:e.jsx(ma,{className:"w-4 h-4"})})]})})}function Vn({icon:s,onClick:t,title:n,disabled:a=!1,className:r=""}){const o="w-7 h-7 rounded-md flex items-center justify-center text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-slate-300 transition-all duration-200",i=a?"opacity-50 cursor-not-allowed":"cursor-pointer";return e.jsx("button",{onClick:()=>t?.(),disabled:a,className:`${o} ${i} ${r}`,title:n,children:e.jsx(s,{className:"w-4 h-4"})})}function xx({onSend:s,canSend:t,shortcutHint:n}){const{t:a}=L(),r=[{icon:As,title:a("messageInput.bottom.image"),onClick:void 0,enabled:Pe().channel.input.image.enabled},{icon:yt,title:a("messageInput.bottom.file"),onClick:void 0,enabled:Pe().channel.input.file.enabled},{icon:Qa,title:a("messageInput.bottom.voice"),onClick:void 0,enabled:Pe().channel.input.voice.enabled},{icon:ma,title:a("messageInput.bottom.more"),onClick:void 0,enabled:Pe().channel.input.more.enabled}].filter(o=>o.enabled);return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-1.5",children:r.map((o,i)=>e.jsx(Vn,{icon:o.icon,onClick:o.onClick,title:o.title},i))}),e.jsxs("div",{className:"flex items-center gap-2",children:[n&&e.jsx("span",{className:"text-xs text-slate-500 dark:text-slate-400",children:a("messageInput.bottom.sendHint",{shortcut:n})}),e.jsx("button",{onClick:s,disabled:!t,className:`w-8 h-8 rounded-md flex items-center justify-center transition-colors duration-150 text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-slate-300 ${t?"":"opacity-40 cursor-not-allowed hover:bg-transparent"}`,"aria-label":a("messageInput.bottom.sendNote"),children:e.jsx(Oi,{className:"w-4 h-4"})})]})]})}function bx(){const{t:s}=L(),{inputCollapsed:t,handleCollapseInput:n,handleExpandInput:a}=ws(),r=qt(o=>o.setExpanded);return e.jsxs("div",{className:"flex items-center justify-between px-2 pt-2 pb-1",children:[e.jsx("div",{className:"flex items-center gap-1.5",children:e.jsx(Vn,{icon:xn,onClick:()=>r(!0),title:s("messageInput.header.expandComposer")})}),e.jsx("div",{className:"flex items-center gap-1.5",children:t?e.jsx(Vn,{icon:$i,onClick:a,title:s("messageInput.header.showComposer")}):e.jsx(Vn,{icon:xu,onClick:n,title:s("messageInput.header.hideComposer")})})]})}const Os=({onHistoryMessagesChange:s})=>{const{currentChannelId:t}=J(),n=O(d=>d.userId),a=m.useMemo(()=>cs(X.dataContainer,`messageByChannel.${t}`),[t]),{value:{messages:r=[],loading:o,hasMore:i,loadingMore:l}={},get:c}=kl(a);return m.useEffect(()=>X.moreMessageLoadedEvent$.listen(({messages:d})=>s?.(d)),[]),m.useEffect(()=>X.connectToRequestWorkflow(),[]),m.useEffect(()=>{n&&t&&X.requestLoadInitialMessages$.next({channelId:t})},[t,n]),{messages:r,loading:o,hasMore:i,loadMore:X.loadMoreHistory,loadingMore:l,getChannelState:c}},dc=()=>{const[s,t]=m.useState(void 0);return{replyToMessageId:s,clearReplyToMessageId:()=>{t(void 0)},handleCancelReply:()=>{t(void 0)},handleReply:o=>{t(o)}}},vx=()=>navigator.platform.toUpperCase().includes("MAC"),uc=s=>s.metaKey||s.ctrlKey,wx=s=>`âŒ˜+${s} / Ctrl+${s}`,qo={SAVE:wx("Enter"),CANCEL:"Esc"};function mc(){const{t:s}=L(),t=ve(),n=m.useRef(null),{currentChannelId:a,isAddingMessage:r}=J(),{messages:o=[]}=Os({}),{clearReplyToMessageId:i,replyToMessageId:l,handleCancelReply:c}=dc(),d=m.useMemo(()=>l&&o.length>0?o.find(N=>N.id===l):null,[l,o]),u=qt(N=>N.expanded),h=qt(N=>a?N.drafts[a]??"":""),g=qt(N=>N.setDraft),x=qt(N=>N.clearDraft),f=h,p=async()=>{if(!f.trim()||!a)return;const N=f.trim(),S=N.includes("#"),j=_l.TEXT;De.logNoteCreate(a,j,N.length,S),l?(De.logMessageReply(l,a,l),t.threadManager.addThreadMessage(l,{content:N,sender:"user",channelId:a})):t.noteManager.sendMessage({content:N,sender:"user",channelId:a}),i(),t.rxEventBus.requestTimelineScrollToLatest$.emit(),x(a)},b=N=>{!u&&N.key==="Enter"&&(N.metaKey||N.ctrlKey)&&(N.preventDefault(),p())},v=N=>{a&&g(a,N)};m.useEffect(()=>{n.current&&(n.current.style.height="auto",n.current.style.height=`${Math.min(n.current.scrollHeight,200)}px`)},[f]);const y=m.useMemo(()=>s(d?"messageInput.placeholder.reply":"messageInput.placeholder.default"),[d,s]),w=m.useMemo(()=>`${vx()?"Command":"Ctrl"}+Enter`,[]);return{message:f,textareaRef:n,replyToMessage:d,isAddingMessage:r,handleSend:p,handleKeyDown:b,handleMessageChange:v,placeholder:y,shortcutHint:w,currentChannelId:a,handleCancelReply:c}}function yx(){const{message:s,textareaRef:t,replyToMessage:n,isAddingMessage:a,handleSend:r,handleKeyDown:o,handleMessageChange:i,placeholder:l,shortcutHint:c,handleCancelReply:d}=mc(),{inputCollapsed:u}=ws(),[h,g]=m.useState(!1),x=h,f="sticky bottom-0 z-10 shrink-0",p="overflow-hidden transition-[max-height,opacity,transform,padding] duration-220 ease-out will-change-[max-height,opacity,transform] origin-bottom",b="max-h-[320px] opacity-100 translate-y-0",v="max-h-0 opacity-0 translate-y-1 py-0",y="border-t border-border/60",w=m.useRef(null);return m.useEffect(()=>{const N=w.current;if(!N)return;const S=()=>g(!0),j=C=>{N.contains(C.relatedTarget)||g(!1)};return N.addEventListener("focusin",S),N.addEventListener("focusout",j),()=>{N.removeEventListener("focusin",S),N.removeEventListener("focusout",j)}},[]),e.jsx("div",{className:f,children:e.jsx("div",{ref:w,className:`${p} ${u?v:b} bg-background ${u?"":y}`,"aria-hidden":u,children:e.jsxs("div",{children:[n&&e.jsx(fx,{replyToMessage:n,onCancelReply:d}),e.jsx(bx,{}),e.jsx("div",{className:"relative px-2 pt-0",children:e.jsx(px,{message:s,onMessageChange:i,onKeyDown:o,placeholder:l,disabled:a,textareaRef:t})}),e.jsx("div",{className:"px-2 pb-1",children:e.jsx(xx,{onSend:r,canSend:!!s.trim()&&!a,shortcutHint:x?c:void 0})})]})})})}const jx=()=>e.jsx("div",{className:"w-full p-4 space-y-3 border-b border-border/50",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(K,{className:"w-8 h-8 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{className:"h-4 w-24"}),e.jsx(K,{className:"h-3 w-16"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{className:"h-4 w-full"}),e.jsx(K,{className:"h-4 w-3/4"}),e.jsx(K,{className:"h-4 w-1/2"})]}),e.jsxs("div",{className:"flex items-center space-x-2 pt-2",children:[e.jsx(K,{className:"h-6 w-16"}),e.jsx(K,{className:"h-6 w-16"}),e.jsx(K,{className:"h-6 w-16"})]})]})]})}),nn=({count:s=3})=>e.jsx("div",{className:"w-full h-full overflow-hidden",children:Array.from({length:s}).map((t,n)=>e.jsx(jx,{},n))}),oa=({onClick:s,children:t,ariaLabel:n,isVisible:a=!0,className:r})=>a?e.jsx(M,{size:"sm",variant:"secondary",className:E("h-8 w-8 rounded-full p-0 shadow-lg",r),onClick:s,"aria-label":n,children:t}):null,Nx=({onClick:s,isVisible:t})=>e.jsx(oa,{onClick:s,isVisible:t,ariaLabel:"Scroll to top",children:e.jsx(bs,{className:"h-4 w-4"})}),Ko=s=>typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(s):s.replace(/["\\]/g,"\\$&"),us={messageId:"data-message-id",collapseInlineFor:"data-collapse-inline-for"},Rs={message:`[${us.messageId}]`,messageById:s=>`[${us.messageId}="${Ko(s)}"]`,collapseInlineFor:s=>`[${us.collapseInlineFor}="${Ko(s)}"]`},Cx=s=>s.getAttribute(us.messageId);function kx(s){const{container:t,element:n,onCollapse:a}=s,r=t.getBoundingClientRect(),i=n.getBoundingClientRect().top>=r.top;a(),i||setTimeout(()=>{const d=n.getBoundingClientRect().top-r.top;t.scrollTop+=d},300)}const Sx=(s,t)=>{const n=s.getBoundingClientRect(),a=t.getBoundingClientRect(),r=n.top-a.top;t.scrollTop+=r};function Mx(s){const{container:t,element:n,onCollapse:a}=s,r=t.getBoundingClientRect();if(n.getBoundingClientRect().top>=r.top){a();return}else Sx(n,t),setTimeout(()=>{a()},200)}function Ix(s){if(!s)return 8;const n=getComputedStyle(s).getPropertyValue("--collapse-float-offset"),a=parseFloat(n);return Number.isFinite(a)?a:8}function Tx(s){const t=Array.from(s.querySelectorAll(Rs.message));if(!t.length)return{id:null,inlineOverlap:!1,visibleHeight:null};const n=s.getBoundingClientRect();let a=null;for(const d of t){const u=d.getBoundingClientRect();if(u.bottom<n.top||u.top>n.bottom)continue;const h=Cx(d);if(!h)continue;const g=Math.max(0,n.bottom-u.bottom);(!a||g<a.distance)&&(a={id:h,distance:g,rect:u})}if(!a)return{id:null,inlineOverlap:!1,visibleHeight:null};const o=s.querySelector(Rs.collapseInlineFor(a.id))?.getBoundingClientRect(),i=Ix(s),l=o?n.bottom-o.bottom<=i+.5:!1,c=Math.max(0,Math.min(n.bottom,a.rect.bottom)-Math.max(n.top,a.rect.top));return{id:a.id,inlineOverlap:l,visibleHeight:c}}function Ex(s){const t=Fe(cc),n=Fe(m.useCallback(u=>u.requestCollapse,[])),a=Fe(m.useCallback(u=>u.setActiveInfo,[])),r=Fe(m.useCallback(u=>u.registerLayoutSync,[])),o=m.useRef(null),i=m.useRef(null),l=m.useCallback(()=>{const u=s.current;u&&(o.current&&cancelAnimationFrame(o.current),o.current=requestAnimationFrame(()=>{const{id:h,inlineOverlap:g,visibleHeight:x}=Tx(u);a(h,g,x)}))},[s,a]);m.useEffect(()=>()=>{o.current&&cancelAnimationFrame(o.current),i.current?.disconnect()},[]),m.useEffect(()=>{const u=s.current;if(!u)return;const h=new MutationObserver(g=>{g.some(f=>f.type!=="childList"?!1:[...Array.from(f.addedNodes),...Array.from(f.removedNodes)].some(b=>b instanceof HTMLElement&&b.hasAttribute(us.messageId)))&&l()});return h.observe(u,{childList:!0,subtree:!0}),i.current=h,l(),()=>{h.disconnect()}},[s,l]),m.useEffect(()=>(r(l),()=>r(null)),[r,l]),m.useEffect(()=>(window.addEventListener("resize",l),()=>window.removeEventListener("resize",l)),[l]);const c=m.useCallback(()=>{l()},[l]),d=m.useCallback(()=>{const h=Fe.getState().activeMessageId,g=s.current;if(!h||!g)return;const x=g.querySelector(Rs.messageById(h));x&&kx({container:g,element:x,onCollapse:()=>n(h)})},[s,n]);return{showFloatingCollapse:t,handleScroll:c,collapseCurrent:d}}const Ax=({date:s})=>{const t=or(new Date(s),"MMM dd, yyyy");return e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"px-4 py-1.5 bg-slate-50/60 dark:bg-slate-900/40 rounded-lg",children:e.jsx("span",{className:"text-xs font-normal text-slate-500 dark:text-slate-400 tracking-wide",children:t})}),e.jsx("div",{className:"absolute -left-12 top-1/2 transform -translate-y-1/2 w-8 h-px bg-slate-200/40 dark:bg-slate-700/40"}),e.jsx("div",{className:"absolute -right-12 top-1/2 transform -translate-y-1/2 w-8 h-px bg-slate-200/40 dark:bg-slate-700/40"})]})})},hc=({renderThoughtRecord:s,className:t="",groupedMessages:n,messages:a,onScroll:r})=>{const{t:o}=L(),i=ve(),l=Le(F=>F.sideView),c=J(F=>F.currentChannelId),{inputCollapsed:d,handleExpandInput:u,handleCollapseInput:h}=ws(),[g,x]=m.useState(!1);m.useEffect(()=>{let G=null;return d?G=window.setTimeout(()=>x(!0),260):x(!1),()=>{G&&window.clearTimeout(G)}},[d]);const f=m.useRef(null);i.scrollManager.setScrollContainerRef(f);const p=m.useRef(null),[b,v]=m.useState(!1),y=30,w=m.useCallback(F=>{const G=F?.behavior==="smooth"?"smooth":"auto";if(p.current){p.current.scrollTo({top:0,behavior:G});return}f.current?.scrollTo({top:0,behavior:G})},[]),{showFloatingCollapse:N,handleScroll:S,collapseCurrent:j}=Ex(f),C=m.useRef(null),I=100,k=8,T=320,z=m.useRef(0),D=m.useCallback(F=>{r?.(F),S();const G=f.current;if(G){v(G.scrollTop>y);const Z=Date.now();if(Z<z.current)return;G.scrollTop>I?C.current!=="away"&&(h(),C.current="away",z.current=Z+T):G.scrollTop<=k&&C.current!=="top"&&(u(),C.current="top",z.current=Z+T)}},[r,S,h,u]);m.useEffect(()=>{C.current=d?"away":"top"},[d]),m.useEffect(()=>{const F=f.current;if(!F)return;const G=Z=>{D(Z)};return F.addEventListener("scroll",G,{passive:!0}),()=>F.removeEventListener("scroll",G)},[D]),Hr(i.rxEventBus.requestTimelineScrollToLatest$,F=>{const G=F?.behavior||"instant";w({behavior:G})}),m.useEffect(()=>{w({behavior:"instant"})},[w]),m.useEffect(()=>{u()},[c]);const $=m.useMemo(()=>{const F=new Map;for(const G of a??[]){const Z=G.threadId||G.id;F.set(Z,(F.get(Z)??0)+1)}return F},[a]),{items:H,indexMap:ae}=m.useMemo(()=>{const F=[],G=new Map;return Object.entries(n).forEach(([Z,_])=>{F.push({type:"date-divider",date:Z}),_.filter(q=>q.sender==="user"&&!q.parentId).forEach(q=>{F.push({type:"message",message:q}),G.set(q.id,F.length-1)})}),{items:F,indexMap:G}},[n]),re=m.useRef(ae);re.current=ae,m.useEffect(()=>{const F={scrollToMessageId:(G,Z)=>{const _=re.current.get(G),q=p.current;return _===void 0||!q?!1:(q.scrollToIndex({index:_,align:Z?.align??"start",behavior:Z?.behavior??"auto"}),!0)}};return i.scrollManager.setTimelineVirtualScrollApi(F),()=>{i.scrollManager.setTimelineVirtualScrollApi(null)}},[i]);const je=F=>{const G=F.threadId||F.id,Z=$.get(G)??0,_=Z>1?Z-1:0;return e.jsx("div",{[us.messageId]:F.id,className:"w-full",style:{height:"auto",minHeight:"auto"},children:s(F,_)},F.id)},Ne=F=>e.jsx("div",{className:"w-full",style:{height:"auto",minHeight:"auto"},children:e.jsx(Ax,{date:F})},F),Be=F=>F.type==="date-divider"?Ne(F.date):je(F.message);return console.log("ðŸ”” [MessageTimeline][items]:",{items:H}),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`w-full bg-background flex-1 overflow-hidden min-h-0 ${t}`,style:{height:"100%",minHeight:"100%",maxHeight:"100%"},children:e.jsx(al,{ref:F=>{p.current=F},data:H,itemContent:(F,G)=>Be(G),scrollerRef:F=>{f.current=F||null,F instanceof HTMLDivElement&&F.classList.add("timeline-scroll")},style:{height:"100%",width:"100%"}})}),e.jsx("div",{className:"absolute top-8 right-4 z-20 pointer-events-none",children:e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsx("div",{className:"pointer-events-auto",children:e.jsx(oa,{onClick:()=>{De.logAIAssistantOpen("",Pl.BUTTON),i.openAIAssistant()},isVisible:l!==vt.AI_ASSISTANT,ariaLabel:o("notes.messageTimeline.openAIAssistant"),children:e.jsx(hs,{className:"h-4 w-4"})})}),e.jsx("div",{className:"pointer-events-auto",children:e.jsx(Nx,{onClick:()=>{De.logScrollToLatest("",a.length),w({behavior:"smooth"})},isVisible:b})})]})}),e.jsx("div",{className:"absolute right-4 z-20 pointer-events-none",style:{bottom:"calc(env(safe-area-inset-bottom, 0px) + 16px)"},children:e.jsx("div",{className:`transition-opacity duration-150 ${g?"opacity-100":"opacity-0"}`,children:g&&e.jsx("div",{className:"pointer-events-auto",children:e.jsx(oa,{onClick:u,ariaLabel:o("notes.messageTimeline.showComposer"),children:e.jsx(Bi,{className:"h-4 w-4"})})})})}),e.jsx("div",{className:`pointer-events-none absolute left-1/2 -translate-x-1/2 z-20 transition-all duration-150 ${N?"opacity-100 -translate-y-1":"opacity-0 translate-y-0"}`,style:{bottom:"calc(env(safe-area-inset-bottom, 0px) + var(--collapse-float-offset, 8px))"},children:N&&e.jsx("div",{className:"pointer-events-auto",children:e.jsxs(M,{size:"sm",variant:"secondary",className:"h-8 rounded-full px-2.5 shadow-lg flex items-center gap-1 hover:bg-secondary",onClick:j,"aria-label":o("notes.messageTimeline.collapseCurrent"),children:[e.jsx(bs,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs leading-none",children:o("notes.messageTimeline.collapse")})]})})})]})},gc=({className:s=""})=>{const{t}=L(),{inputCollapsed:n,handleExpandInput:a}=ws(),[r,o]=m.useState(!1);return m.useEffect(()=>{let l=null;return n?l=window.setTimeout(()=>o(!0),260):o(!1),()=>{l&&window.clearTimeout(l)}},[n]),e.jsxs("div",{className:`relative flex-1 flex items-center justify-center p-8 ${s}`,children:[e.jsx(on,{className:"max-w-md w-full border-2 border-dashed border-muted-foreground/20 bg-gradient-to-br from-background to-muted/20 shadow-lg",children:e.jsxs($r,{className:"p-8 text-center space-y-6",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-blue-500/10 to-purple-500/10 rounded-2xl flex items-center justify-center mx-auto shadow-inner",children:e.jsx(tt,{className:"w-10 h-10 text-blue-500 dark:text-blue-400"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground",children:t("notes.spaceEmptyState.title")}),e.jsx("p",{className:"text-muted-foreground leading-relaxed",children:t("notes.spaceEmptyState.description")})]}),e.jsxs("div",{className:"bg-muted/30 rounded-lg p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsx("span",{children:t("notes.spaceEmptyState.tip1")})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("div",{className:"w-2 h-2 bg-purple-500 rounded-full"}),e.jsx("span",{children:t("notes.spaceEmptyState.tip2")})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),e.jsx("span",{children:t("notes.spaceEmptyState.tip3")})]})]})]})}),e.jsx("div",{className:"absolute right-4 z-20 pointer-events-none",style:{bottom:"calc(env(safe-area-inset-bottom, 0px) + 16px)"},children:e.jsx("div",{className:`transition-opacity duration-150 ${r?"opacity-100":"opacity-0"}`,children:r&&e.jsx("div",{className:"pointer-events-auto",children:e.jsx(oa,{onClick:a,ariaLabel:"Show composer",children:e.jsx(Bi,{className:"h-4 w-4"})})})})})]})},no=(s,t={})=>{const{latestFirst:n=!1}=t;return m.useMemo(()=>{if(!s||s.length===0)return{};const a={};s.forEach(i=>{const l=new Date(i.timestamp).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"});a[l]||(a[l]=[]),a[l].push(i)}),Object.keys(a).forEach(i=>{a[i].sort((l,c)=>{const d=new Date(l.timestamp).getTime()-new Date(c.timestamp).getTime();return n?-d:d})});const r=Object.keys(a).sort((i,l)=>{const c=new Date(a[i][0]?.timestamp||0),d=new Date(a[l][0]?.timestamp||0),u=c.getTime()-d.getTime();return n?-u:u}),o={};return r.forEach(i=>{o[i]=a[i]}),o},[s,n])},pc=({onTrigger:s,canTrigger:t,threshold:n=.2,direction:a="top",getState:r})=>({handleScroll:m.useCallback(i=>{if(!t||!r().hasMore||r().loading||r().loadingMore)return;const{scrollTop:l,scrollHeight:c,clientHeight:d}=i.currentTarget;a==="top"?l/(c-d)<n&&s():(c-l-d)/(c-d)<n&&s()},[t,r,n,s,a])});function fc({className:s}){const{isDarkMode:t,toggleDarkMode:n}=ul();return e.jsx(M,{variant:"ghost",size:"icon",onClick:n,className:E("hover:bg-muted/80",s),title:t?"Switch to light mode":"Switch to dark mode",children:t?e.jsx(Xn,{className:"h-[1.2rem] w-[1.2rem]"}):e.jsx(Yn,{className:"h-[1.2rem] w-[1.2rem]"})})}const Rx="https://stillroot.app/#/space/18ec8262-2f5b-4c07-8dd1-fb3cdda8f1e7";function Lx({onClose:s}){const{t}=L();return e.jsxs("div",{className:"flex flex-col w-screen max-w-[1024px] h-[80vh]",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b border-border bg-background",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-semibold",children:t("feedback.modal.title")}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t("feedback.modal.description")})]}),e.jsx("button",{type:"button",className:"text-xs text-muted-foreground hover:text-foreground px-2 py-1 rounded",onClick:s,children:t("common.close")})]}),e.jsx("div",{className:"flex-1 bg-muted",children:e.jsx("iframe",{src:Rx,title:t("feedback.modal.iframeTitle"),className:"w-full h-full border-0"})})]})}function Dx(){let s=null;return s=Il.show({content:e.jsx(Lx,{onClose:()=>s?.close()}),className:"w-full max-w-[1024px] h-[80vh] flex flex-col",position:"center"}),s}const xc="stillroot-lang",Wn=s=>s&&s.toLowerCase().startsWith("zh")?"zh-CN":"en",_x=()=>{if(typeof window>"u")return"en";try{const t=localStorage.getItem(xc);if(t)try{const n=JSON.parse(t);if(n&&n.state&&n.state.language)return Wn(n.state.language)}catch{const n=Wn(t);if(n)return n}}catch{}const s=(navigator.languages?.[0]??navigator.language)||"en";return Wn(s)};let vr=!1;const gn=_e()(Xt(s=>({language:_x(),setLanguage:t=>{vr||(s({language:t}),typeof window<"u"&&W.isInitialized&&W.changeLanguage(t).then(()=>{window.location.reload()}))}}),{name:xc,partialize:s=>({language:s.language}),onRehydrateStorage:()=>s=>{if(s&&typeof window<"u"&&W.isInitialized){const t=s.language,n=W.resolvedLanguage??W.language;t&&t!==n&&W.changeLanguage(t)}}})),Px=s=>{const t=Wn(s);gn.getState().language!==t&&(vr=!0,gn.setState({language:t}),setTimeout(()=>{vr=!1},0))},Ox=Object.freeze(Object.defineProperty({__proto__:null,syncLanguageFromI18n:Px,useLanguageStore:gn},Symbol.toStringTag,{value:"Module"}));function $x(){const s=gn(n=>n.language),t=gn(n=>n.setLanguage);return{language:s,setLanguage:t}}function lt({icon:s,children:t,onSelect:n,disabled:a,className:r}){return e.jsxs(Lt,{className:E("cursor-pointer rounded-md",r),disabled:a,onSelect:n,children:[e.jsx(s,{className:"h-4 w-4"}),e.jsx("span",{children:t})]})}function qs({icon:s,value:t,children:n,className:a}){return e.jsxs(ip,{value:t,className:a,children:[s&&e.jsx(s,{className:"h-4 w-4"}),e.jsx("span",{children:n})]})}function Yo({icon:s,children:t,className:n}){let a;if(m.isValidElement(s))a=s;else if(s&&(typeof s=="function"||s?.$$typeof)){const r=s;a=e.jsx(r,{className:"h-4 w-4"})}else a=null;return e.jsxs(lp,{className:E("cursor-pointer rounded-md gap-2",n),children:[a,e.jsx("span",{children:t})]})}function wr({tone:s="dark",className:t,onOpenApiAccess:n}){const{user:a}=ja(),{theme:r,setTheme:o}=ul(),{language:i,setLanguage:l}=$x(),{t:c}=L(),d=Ye(f=>f.signOut),u=Ye(f=>f.isAuthenticating),h=m.useCallback(()=>{Kt({allowGuest:!0})},[]),g=m.useCallback(()=>{d()},[d]),x=s==="light"?"h-8 w-8 p-0 text-white/80 hover:text-white hover:bg-white/20":"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent";return e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"sm",className:E(x,"group transition-all duration-200 flex-shrink-0",t),title:c("header.menu.title"),"aria-label":c("header.menu.title"),onClick:f=>f.stopPropagation(),children:e.jsx(Er,{className:"h-4 w-4 transition-transform duration-200 group-hover:scale-105"})})}),e.jsxs(mt,{align:"start",sideOffset:8,className:"min-w-[220px] p-1",children:[e.jsx(Wr,{className:"text-xs text-muted-foreground px-2 py-1.5",children:a?a.displayName||a.email||c("header.menu.account"):c("header.menu.guestMode")}),e.jsx(Dt,{}),a?e.jsx(lt,{icon:Ir,onSelect:g,disabled:u,children:c("header.menu.logout")}):e.jsx(lt,{icon:Ui,onSelect:h,children:c("header.menu.login")}),e.jsx(Dt,{}),e.jsxs(Po,{children:[e.jsx(Yo,{icon:r==="dark"?Yn:Xn,children:c("header.menu.theme.label")}),e.jsx(Oo,{className:"min-w-[200px]",children:e.jsxs(_o,{value:r,onValueChange:f=>o(f),children:[e.jsx(qs,{icon:Xn,value:"light",children:c("header.menu.theme.light")}),e.jsx(qs,{icon:Yn,value:"dark",children:c("header.menu.theme.dark")}),e.jsx(qs,{icon:Tr,value:"system",children:c("header.menu.theme.system")})]})})]}),e.jsxs(Po,{children:[e.jsx(Yo,{icon:bu,children:c("header.menu.language.label")}),e.jsx(Oo,{className:"min-w-[200px]",children:e.jsxs(_o,{value:i,onValueChange:f=>l(f),children:[e.jsx(qs,{value:"en",children:c("header.menu.language.english")}),e.jsx(qs,{value:"zh-CN",children:c("header.menu.language.chinese")})]})})]}),e.jsx(Dt,{}),n&&e.jsx(lt,{icon:Fi,onSelect:n,children:c("apiAccess.menu")}),e.jsx(lt,{icon:vu,onSelect:()=>Dx(),children:c("header.menu.feedback")})]})]})}const Bx=()=>{const{t:s}=L(),{addChannel:t}=O(),n=async()=>{try{await t({name:s("desktop.welcomeGuide.firstSpaceName"),emoji:"âœ¨",description:s("desktop.welcomeGuide.firstSpaceDescription")})}catch(a){console.error("Failed to create first channel:",a)}};return e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border/50",children:[e.jsx(wr,{tone:"dark"}),e.jsx("div",{})," "]}),e.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center space-y-6 max-w-sm",children:[e.jsx("div",{className:"text-6xl",children:"ðŸ“"}),e.jsx("p",{className:"text-lg text-muted-foreground",children:s("desktop.welcomeGuide.emptyStateHint")}),e.jsxs(M,{"data-tour":"create-first-space",onClick:n,size:"lg",className:"px-6",children:[e.jsx($e,{className:"w-4 h-4 mr-2"}),s("desktop.welcomeGuide.createFirstSpace")]})]})})]})};function Ux({isOpen:s,onClose:t,content:n,title:a,onDownload:r,showDownload:o=!0}){const{t:i}=L(),[l,c]=m.useState(!1),[d,u]=m.useState(!1);return m.useEffect(()=>{if(s){c(!1),u(!0);const h=setTimeout(()=>c(!0),100);return()=>clearTimeout(h)}},[s]),m.useEffect(()=>{if(s&&d){const h=setTimeout(()=>u(!1),3e3);return()=>clearTimeout(h)}},[s,d]),m.useEffect(()=>(s?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[s]),m.useEffect(()=>{const h=g=>{g.key==="Escape"&&s&&t()};return s&&document.addEventListener("keydown",h),()=>{document.removeEventListener("keydown",h)}},[s,t]),s?e.jsxs("div",{className:"fixed inset-0 z-[9999] bg-black/95 backdrop-blur-sm",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx("div",{className:`relative w-full h-full flex items-center justify-center transition-all duration-300 ${l?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"relative w-full h-full flex items-center justify-center overflow-hidden bg-white dark:bg-gray-900 rounded-lg p-4",children:e.jsx("div",{className:"w-full h-full flex items-center justify-center [&_svg]:max-w-full [&_svg]:max-h-full [&_svg]:w-auto [&_svg]:h-auto",dangerouslySetInnerHTML:{__html:n}})})})}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-4",children:[a&&e.jsx("div",{className:"text-white/90 text-sm font-medium truncate max-w-[60%] bg-black/50 backdrop-blur-sm rounded-full px-3 py-1",children:a}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[o&&r&&e.jsx(M,{variant:"ghost",size:"sm",onClick:r,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(vs,{className:"w-4 h-4"})}),e.jsx(M,{variant:"ghost",size:"sm",onClick:t,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(fe,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"absolute inset-0 -z-10",onClick:t,"aria-label":i("common.closeViewer")}),e.jsx("div",{className:`absolute top-16 left-1/2 transform -translate-x-1/2 bg-black/50 backdrop-blur-sm rounded-full px-4 py-2 text-white/60 text-xs transition-all duration-500 ${d?"opacity-100 translate-y-0":"opacity-0 -translate-y-2 pointer-events-none"}`,children:e.jsx(Si,{i18nKey:"common.pressEscToClose",components:{kbd:e.jsx("kbd",{className:"px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono"})}})})]}):null}function Fx({code:s}){const{t}=L(),[n,a]=m.useState(null),[r,o]=m.useState(null),[i,l]=m.useState(!1),c=m.useRef(null),d=m.useMemo(()=>`mermaid-${Math.random().toString(36).slice(2)}`,[]),[u,h]=m.useState(!1),[g,x]=m.useState(!1);m.useEffect(()=>{let b=!1;async function v(){try{const y=await ue(()=>import("./pkg-mermaid-BKUwkIFg.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49])),w=document.documentElement.classList.contains("dark");y.default.initialize({startOnLoad:!1,securityLevel:"loose",theme:w?"dark":"default"});const{svg:N,bindFunctions:S}=await y.default.render(d,s);if(b)return;a(N),S&&c.current&&S(c.current)}catch(y){if(b)return;const w=typeof y=="object"&&y&&"message"in y?String(y.message):"Failed to render mermaid diagram";o(w)}}return v(),()=>{b=!0}},[s,d]);const f=async()=>{try{await navigator.clipboard.writeText(s),l(!0),setTimeout(()=>l(!1),1500)}catch(b){console.warn("Copy mermaid source failed:",b)}},p=()=>{if(n)try{const b=new Blob([n],{type:"image/svg+xml;charset=utf-8"}),v=URL.createObjectURL(b),y=document.createElement("a");y.href=v,y.download="diagram.svg",document.body.appendChild(y),y.click(),y.remove(),URL.revokeObjectURL(v)}catch(b){console.warn("Download SVG failed:",b)}};return r?e.jsxs("div",{className:"group/code relative my-4",children:[e.jsxs("div",{className:"flex items-center justify-between bg-slate-100 dark:bg-gray-900 border border-slate-200 dark:border-gray-700 rounded-t px-2 py-1",children:[e.jsx("span",{className:"text-[11px] font-medium uppercase tracking-wide text-slate-600 dark:text-gray-300",children:t("markdown.mermaid.label")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>x(b=>!b),className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:t(g?"markdown.mermaid.viewDiagram":"markdown.mermaid.viewSource"),children:g?e.jsx(As,{className:"w-3 h-3"}):e.jsx(vo,{className:"w-3 h-3"})}),e.jsx("button",{onClick:f,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:t(i?"common.copied":"markdown.mermaid.copySource"),children:i?e.jsx(Xe,{className:"w-3 h-3"}):e.jsx(ps,{className:"w-3 h-3"})})]})]}),g?e.jsx("pre",{className:"bg-slate-50 dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700 border-t-0",children:e.jsx("code",{className:"text-sm leading-relaxed font-mono text-slate-800 dark:text-gray-200 whitespace-pre",children:s})}):e.jsx("div",{className:"bg-white dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700",children:e.jsx("code",{className:"text-sm text-red-400",children:t("markdown.mermaid.renderFailed")})})]}):e.jsxs("div",{className:"group/code relative my-4",ref:c,children:[e.jsxs("div",{className:"flex items-center justify-between bg-slate-100 dark:bg-gray-900 border border-slate-200 dark:border-gray-700 rounded-t px-2 py-1",children:[e.jsx("span",{className:"text-[11px] font-medium uppercase tracking-wide text-slate-600 dark:text-gray-300",children:t("markdown.mermaid.label")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>x(b=>!b),className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:t(g?"markdown.mermaid.viewDiagram":"markdown.mermaid.viewSource"),children:g?e.jsx(As,{className:"w-3 h-3"}):e.jsx(vo,{className:"w-3 h-3"})}),!g&&e.jsx("button",{onClick:()=>h(!0),className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:t("common.viewLarger"),children:e.jsx(xn,{className:"w-3 h-3"})}),e.jsx("button",{onClick:g?()=>{try{const b=new Blob([s],{type:"text/plain;charset=utf-8"}),v=URL.createObjectURL(b),y=document.createElement("a");y.href=v,y.download="diagram.mmd",document.body.appendChild(y),y.click(),y.remove(),URL.revokeObjectURL(v)}catch(b){console.warn("Download mmd failed:",b)}}:p,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:t(g?"markdown.mermaid.downloadMmd":"markdown.mermaid.downloadSvg"),children:e.jsx(vs,{className:"w-3 h-3"})}),e.jsx("button",{onClick:f,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:t(i?"common.copied":"markdown.mermaid.copySource"),children:i?e.jsx(Xe,{className:"w-3 h-3"}):e.jsx(ps,{className:"w-3 h-3"})})]})]}),g?e.jsx("pre",{className:"bg-slate-50 dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700",children:e.jsx("code",{className:"text-sm leading-relaxed font-mono text-slate-800 dark:text-gray-200 whitespace-pre",children:s})}):e.jsx("div",{className:"bg-white dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700 border-t-0 cursor-zoom-in",onDoubleClick:()=>h(!0),dangerouslySetInnerHTML:{__html:n||""}}),e.jsx(Ux,{isOpen:u,onClose:()=>h(!1),content:n||"",title:t("markdown.mermaid.preview"),onDownload:p,showDownload:!!n})]})}const zx={javascript:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.j),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),jsx:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.a),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),typescript:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.t),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),tsx:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.b),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),json:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.c),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),bash:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.d),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),shell:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.d),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),sh:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.d),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),yaml:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.y),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),yml:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.y),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),markdown:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.m),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),md:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.m),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),css:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.e),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),scss:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.s),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),html:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.f),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),xml:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.f),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),graphql:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.g),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),go:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.i),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),java:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.k),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),python:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.p),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),ruby:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.r),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),rust:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.l),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),php:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.n),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),c:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.q),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),cpp:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.u),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),docker:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.w),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),nginx:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.x),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),sql:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.z),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),diff:()=>ue(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.A),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68]))},yr=new Set,Ua={};async function Hx(s){if(!s)return;const t=s.toLowerCase();if(t==="mermaid"||yr.has(t))return;const n=zx[t];n&&(Ua[t]||(Ua[t]=n().then(a=>{const o=a.default??a;rl.registerLanguage(t,o),yr.add(t)}).catch(a=>{console.warn("Failed to load prism language:",t,a)})),await Ua[t])}const Xo=s=>{const t=/language-([a-z0-9]+)/i.exec(s||"");return t?t[1]:""},jr=s=>typeof s=="string"||typeof s=="number"?String(s):Array.isArray(s)?s.map(jr).join(""):m.isValidElement(s)?jr(s.props.children):"",Gx=s=>jr(s).replace(/\n$/,""),Vx=({code:s,languageHint:t,containerClassName:n})=>{const a=t.toLowerCase(),[r,o]=m.useState(0),[i,l]=m.useState(()=>typeof document<"u"?document.documentElement.classList.contains("dark"):!1),[c,d]=m.useState(!1),u=!!(a&&yr.has(a));m.useMemo(()=>{!a||a==="mermaid"||(async()=>(await Hx(a),o(g=>g+1)))()},[a]),m.useEffect(()=>{if(typeof document>"u")return;const g=document.documentElement,x=()=>l(g.classList.contains("dark"));x();const f=new MutationObserver(x);return f.observe(g,{attributes:!0,attributeFilter:["class"]}),()=>f.disconnect()},[]);const h=async()=>{try{await navigator.clipboard.writeText(s),d(!0),setTimeout(()=>d(!1),2e3)}catch(g){console.error("Failed to copy code:",g)}};return e.jsxs("div",{className:["group/code relative my-4",n].filter(Boolean).join(" "),children:[e.jsxs("div",{className:"flex items-center justify-between bg-slate-100 dark:bg-gray-900 border border-slate-200 dark:border-gray-700 rounded-t px-2 py-1",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("span",{className:"text-[11px] font-medium uppercase tracking-wide text-slate-600 dark:text-gray-300",children:t||"text"})}),e.jsx("button",{onClick:h,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:c?"Copied!":"Copy code",children:c?e.jsx(Xe,{className:"w-3 h-3"}):e.jsx(ps,{className:"w-3 h-3"})})]}),u?e.jsx(rl,{style:i?hh:gh,language:a,PreTag:"div",className:"rounded-b overflow-auto w-full max-w-full min-w-0 border border-slate-200 dark:border-gray-700 border-t-0",wrapLongLines:!0,customStyle:{whiteSpace:"pre",overflowX:"auto",overflowY:"auto",background:i?"#0b0b0b":"#f8fafc",margin:0,padding:"0.75rem"},children:s},r):e.jsx("pre",{className:"bg-slate-50 dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700 border-t-0",children:e.jsx("code",{className:"text-sm leading-relaxed font-mono text-slate-800 dark:text-gray-200",children:s})})]})},Wx=({children:s,className:t})=>{const n=m.Children.toArray(s),a=Xo(t)||n.reduce((o,i)=>o||m.isValidElement(i)&&typeof i.props.className=="string"&&Xo(i.props.className)||o,""),r=Gx(s);return r?a.toLowerCase()==="mermaid"?e.jsx(Fx,{code:r}):e.jsx(Vx,{code:r,languageHint:a,containerClassName:t}):e.jsx("pre",{className:t,children:s})},qx=({className:s,children:t,...n})=>e.jsx("code",{className:`inline-block bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-1.5 py-0.5 rounded text-sm font-mono border border-gray-300 dark:border-gray-600${s?` ${s}`:""}`,...n,children:t});function Nr({className:s,...t}){return e.jsx(wd,{"data-slot":"checkbox",className:E("peer border-slate-300 dark:border-slate-600 dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",s),...t,children:e.jsx(yd,{"data-slot":"checkbox-indicator",className:"flex items-center justify-center text-current transition-none",children:e.jsx(Xe,{className:"size-3.5"})})})}function Kx({minScale:s=.1,maxScale:t=5,initialScale:n=1}={}){const[a,r]=m.useState(n),[o,i]=m.useState({x:0,y:0}),[l,c]=m.useState(!1),[d,u]=m.useState({x:0,y:0}),[h,g]=m.useState(0),x=m.useCallback(S=>{a>1&&(c(!0),u({x:S.clientX-o.x,y:S.clientY-o.y}))},[a,o]),f=m.useCallback(S=>{l&&a>1&&i({x:S.clientX-d.x,y:S.clientY-d.y})},[l,a,d]),p=m.useCallback(()=>{c(!1)},[]),b=m.useCallback(S=>{S.preventDefault();const j=Date.now();if(j-h<16)return;g(j);const C=Math.abs(S.deltaY);let I;C<50?I=S.deltaY>0?.98:1.02:C<100?I=S.deltaY>0?.96:1.04:I=S.deltaY>0?.94:1.06;const k=Math.max(s,Math.min(t,a*I));r(k),k<=1&&i({x:0,y:0})},[h,a,s,t]),v=m.useCallback(()=>{r(S=>Math.min(t,S*1.1))},[t]),y=m.useCallback(()=>{r(S=>{const j=Math.max(s,S*.9);return j<=1&&i({x:0,y:0}),j})},[s]),w=m.useCallback(()=>{r(n),i({x:0,y:0})},[n]),N=m.useCallback(()=>{r(n),i({x:0,y:0}),c(!1)},[n]);return{scale:a,position:o,isDragging:l,handleMouseDown:x,handleMouseMove:f,handleMouseUp:p,handleWheel:b,zoomIn:v,zoomOut:y,resetView:w,reset:N}}function Yx({isOpen:s,onClose:t,src:n,alt:a,title:r,onDownload:o,showDownload:i=!0}){const{t:l}=L(),[c,d]=m.useState(!1),[u,h]=m.useState(!1),[g,x]=m.useState(!1),{scale:f,position:p,isDragging:b,handleMouseDown:v,handleMouseMove:y,handleMouseUp:w,handleWheel:N,zoomIn:S,zoomOut:j,resetView:C,reset:I}=Kx();return m.useEffect(()=>{if(s){d(!1),h(!0);const k=setTimeout(()=>d(!0),100);return()=>clearTimeout(k)}},[s]),m.useEffect(()=>{if(s&&u){const k=setTimeout(()=>h(!1),3e3);return()=>clearTimeout(k)}},[s,u]),m.useEffect(()=>(s?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[s]),m.useEffect(()=>{const k=T=>{T.key==="Escape"&&s&&t()};return s&&document.addEventListener("keydown",k),()=>{document.removeEventListener("keydown",k)}},[s,t]),m.useEffect(()=>{s&&(I(),x(!1))},[s,I]),s?e.jsxs("div",{className:"fixed inset-0 z-[9999] bg-black/95 backdrop-blur-sm",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx("div",{className:`relative w-full h-full flex items-center justify-center transition-all duration-300 ${c?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"relative w-full h-full flex items-center justify-center overflow-hidden",onWheel:N,children:e.jsx("img",{src:n,alt:a,className:`max-w-full max-h-full object-contain transition-all duration-200 ${g?"opacity-100":"opacity-0"} ${b?"cursor-grabbing":f>1?"cursor-grab":"cursor-zoom-in"}`,style:{transform:`scale(${f}) translate(${p.x/f}px, ${p.y/f}px)`,transformOrigin:"center center"},onLoad:()=>x(!0),onMouseDown:v,onMouseMove:y,onMouseUp:w,onMouseLeave:w,draggable:!1})})})}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-4",children:[r&&e.jsx("div",{className:"text-white/90 text-sm font-medium truncate max-w-[60%] bg-black/50 backdrop-blur-sm rounded-full px-3 py-1",children:r}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[i&&o&&e.jsx(M,{variant:"ghost",size:"sm",onClick:o,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(vs,{className:"w-4 h-4"})}),e.jsx(M,{variant:"ghost",size:"sm",onClick:t,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(fe,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"absolute inset-0 -z-10",onClick:t,"aria-label":l("common.closeViewer")}),e.jsx("div",{className:`absolute top-16 left-1/2 transform -translate-x-1/2 bg-black/50 backdrop-blur-sm rounded-full px-4 py-2 text-white/60 text-xs transition-all duration-500 ${u?"opacity-100 translate-y-0":"opacity-0 -translate-y-2 pointer-events-none"}`,children:e.jsx(Si,{i18nKey:"common.pressEscToClose",components:{kbd:e.jsx("kbd",{className:"px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono"})}})}),e.jsxs("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 flex items-center gap-2 bg-black/50 backdrop-blur-sm rounded-full px-4 py-2",children:[e.jsx(M,{variant:"ghost",size:"sm",onClick:j,className:"text-white/80 hover:text-white hover:bg-white/10 border-0 h-8 w-8 p-0",children:e.jsx(zi,{className:"w-4 h-4"})}),e.jsxs("span",{className:"text-white/80 text-xs font-medium min-w-[3rem] text-center",children:[Math.round(f*100),"%"]}),e.jsx(M,{variant:"ghost",size:"sm",onClick:S,className:"text-white/80 hover:text-white hover:bg-white/10 border-0 h-8 w-8 p-0",children:e.jsx(Hi,{className:"w-4 h-4"})}),e.jsx("div",{className:"w-px h-4 bg-white/20"}),e.jsx(M,{variant:"ghost",size:"sm",onClick:C,className:"text-white/80 hover:text-white hover:bg-white/10 border-0 h-8 w-8 p-0",children:e.jsx(wu,{className:"w-4 h-4"})})]})]}):null}function Xx({src:s,alt:t,className:n}){const{t:a}=L(),[r,o]=m.useState(!1),[i,l]=m.useState(!1),[c,d]=m.useState(!1),u=(()=>{if(!s)return"image";try{return new URL(s,window.location.href).pathname.split("/").pop()||"image"||"image"}catch{return"image"}})(),h=async()=>{if(s)try{const x=await(await fetch(s)).blob(),f=URL.createObjectURL(x),p=document.createElement("a");p.href=f,p.download=u,document.body.appendChild(p),p.click(),p.remove(),URL.revokeObjectURL(f)}catch{const g=document.createElement("a");g.href=s,g.download=u,document.body.appendChild(g),g.click(),g.remove()}};return e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"inline-block relative",onMouseEnter:()=>d(!0),onMouseLeave:()=>d(!1),children:[e.jsx("img",{src:s,alt:t,className:`${i?"cursor-default":"cursor-zoom-in"} ${n??""}`,loading:"lazy",onLoad:()=>l(!1),onError:()=>l(!0),onClick:()=>!i&&o(!0)}),!i&&c&&e.jsx("button",{type:"button",className:"absolute top-1 right-1 flex items-center justify-center w-6 h-6 rounded bg-black/50 text-white transition-opacity duration-200",title:a("common.viewLarger"),onClick:()=>o(!0),children:e.jsx(xn,{className:"w-3 h-3"})})]}),e.jsx(Yx,{isOpen:r,onClose:()=>o(!1),src:s||"",alt:t,title:t||u,onDownload:i?void 0:h,showDownload:!i})]})}function $s({content:s,className:t=""}){return e.jsx("div",{className:`prose prose-slate dark:prose-invert max-w-none [&_ul_ul]:ml-6 [&_ul_ul_ul]:ml-6 [&_ul_ul_ul_ul]:ml-6 [&_ul_ul_ul_ul_ul]:ml-6 [&_ol_ol]:ml-6 [&_ol_ol_ol]:ml-6 [&_ol_ol_ol_ol]:ml-6 [&_ol_ol_ol_ol_ol]:ml-6 [&_ul_ol]:ml-6 [&_ol_ul]:ml-6 [&_ul_p]:mb-0 [&_ol_p]:mb-0 ${t}`,children:e.jsx(oh,{remarkPlugins:[nl,sl],rehypePlugins:[ih],components:{pre:Wx,code:qx,a({children:n,href:a,...r}){return e.jsx("a",{href:a,className:"text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline transition-colors duration-150",target:"_blank",rel:"noopener noreferrer",...r,children:n})},table({children:n,...a}){return e.jsx("div",{className:"my-4 overflow-x-auto",children:e.jsx("table",{className:"min-w-full border-collapse border border-gray-300 dark:border-gray-600",...a,children:n})})},th({children:n,...a}){return e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-900 dark:text-gray-100 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600",...a,children:n})},td({children:n,...a}){return e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600",...a,children:n})},blockquote({children:n,...a}){return e.jsx("blockquote",{className:"my-4 pl-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-800/30 border-l-4 border-gray-300 dark:border-gray-600 [&>p:last-child]:mb-0",...a,children:n})},ul({children:n,...a}){return e.jsx("ul",{className:"my-2 space-y-2 list-disc pl-6",...a,children:n})},li({children:n,...a}){return e.jsx("li",{className:"text-gray-800 dark:text-gray-200 mb-2 leading-relaxed",...a,children:n})},input({type:n,checked:a,...r}){return n==="checkbox"?e.jsx(Nr,{checked:a,className:"mr-2 mt-0.5 inline-block align-top",disabled:!0}):e.jsx("input",{type:n,checked:a,...r})},ol({children:n,...a}){return e.jsx("ol",{className:"my-2 space-y-2 list-decimal pl-6 text-gray-800 dark:text-gray-200",...a,children:n})},h1({children:n,...a}){return e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-3 mt-5 leading-7",...a,children:n})},h2({children:n,...a}){return e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3 mt-4 leading-6",...a,children:n})},h3({children:n,...a}){return e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2 mt-3 leading-5",...a,children:n})},h4({children:n,...a}){return e.jsx("h4",{className:"text-base font-medium text-gray-900 dark:text-gray-100 mb-2 mt-3 leading-5",...a,children:n})},h5({children:n,...a}){return e.jsx("h5",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 mb-2 mt-3 leading-5",...a,children:n})},h6({children:n,...a}){return e.jsx("h6",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 mt-3 leading-5",...a,children:n})},p({children:n,...a}){return e.jsx("p",{className:"text-base leading-6 text-gray-800 dark:text-gray-200 break-words font-normal mb-2",...a,children:n})},hr({...n}){return e.jsx("hr",{className:"my-6 border-0 h-px bg-gray-300 dark:bg-gray-600",...n})},strong({children:n,...a}){return e.jsx("strong",{className:"font-semibold text-gray-900 dark:text-gray-100",...a,children:n})},em({children:n,...a}){return e.jsx("em",{className:"italic text-gray-700 dark:text-gray-300",...a,children:n})},img({src:n,alt:a}){return e.jsx(Xx,{src:n,alt:a?.toString(),className:"my-2"})}},children:s})})}function bc(s){const t=te(u=>u.editingMessageId),n=te(u=>u.editContent),a=te(u=>u.editMode),r=te(u=>u.isSaving),o=t===s.id,i=o?n:s.content;return{isEditing:o,editContent:i,editMode:o?a:"inline",isSaving:o?r:!1,isExpandedEditing:o&&a==="expanded"}}function Jx({icon:s,onClick:t,title:n,disabled:a,active:r,indicator:o}){return e.jsxs("button",{onClick:()=>t?.(),disabled:a,className:`relative p-2 transition-all duration-200 rounded-lg hover:scale-105 ${r?"bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-400":"text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 hover:bg-slate-200/60 dark:hover:bg-slate-700/60"} ${a?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,title:n,children:[e.jsx(s,{className:"w-4 h-4"}),o&&!a&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2.5 w-2.5 rounded-full bg-red-500 shadow-[0_0_0_2px] shadow-white dark:shadow-slate-900"})]})}function Zx({message:s,onDelete:t,onEdit:n,onCopy:a,onShare:r,onReport:o,onMove:i}){const{t:l}=L(),c=()=>{a?a():navigator.clipboard.writeText(s.content)},d=[{id:"primary",showSeparator:!1,items:[...n?[{id:"edit",icon:e.jsx(Ar,{}),title:l("thoughtRecord.actions.edit"),description:l("thoughtRecord.actions.editDescription"),onClick:n,variant:"default"}]:[],{id:"copy",icon:e.jsx(ps,{}),title:l("thoughtRecord.actions.copy"),onClick:c,variant:"default"},...r?[{id:"share",icon:e.jsx(er,{}),title:l("thoughtRecord.actions.share"),description:l("thoughtRecord.actions.shareDescription"),onClick:r,variant:"default"}]:[],...i?[{id:"move",icon:e.jsx(Gi,{}),title:l("thoughtRecord.actions.move"),onClick:i,variant:"default"}]:[],{id:"delete",icon:e.jsx(jt,{}),title:l("thoughtRecord.actions.delete"),onClick:t,variant:"default"}]},{id:"secondary",title:l("thoughtRecord.menu.statistics"),variant:"default",items:[{id:"word-count",icon:e.jsx(yt,{}),title:l("thoughtRecord.menu.characters",{count:s.content.length}),onClick:()=>{},disabled:!0}]},{id:"advanced",title:l("thoughtRecord.menu.advanced"),variant:"default",items:o?[{id:"report",icon:e.jsx(yu,{}),title:l("thoughtRecord.actions.report"),description:l("thoughtRecord.actions.reportDescription"),onClick:o,variant:"warning"}]:[]}];return e.jsx(nc,{groups:d})}m.createContext(null);function Bs({className:s,children:t,...n}){return e.jsxs(jd,{"data-slot":"scroll-area",className:E("relative",s),...n,children:[e.jsx(Nd,{"data-slot":"scroll-area-viewport",className:"size-full rounded-[inherit] transition-[color,box-shadow] outline-none",children:t}),e.jsx(Qx,{}),e.jsx(Cd,{})]})}function Qx({className:s,orientation:t="vertical",...n}){return e.jsx(kd,{"data-slot":"scroll-area-scrollbar",orientation:t,className:E("flex touch-none p-px transition-colors select-none",t==="vertical"&&"h-full w-2.5 border-l border-l-transparent",t==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent",s),...n,children:e.jsx(Sd,{"data-slot":"scroll-area-thumb",className:"bg-border relative flex-1 rounded-full"})})}function vc({fromChannelId:s,onMove:t}){const{t:n}=L(),a=O(b=>b.channels),[r,o]=m.useState(""),[i,l]=m.useState(null),[c,d]=m.useState(!1),[u,h]=m.useState(null),g=m.useMemo(()=>a.filter(b=>b.id!==s),[a,s]),x=m.useMemo(()=>{if(!r.trim())return g;const b=r.trim().toLowerCase();return g.filter(v=>v.name.toLowerCase().includes(b)||(v.description||"").toLowerCase().includes(b))},[g,r]),f=i?a.find(b=>b.id===i)??null:null,p=async()=>{if(!(!i||c)){d(!0),h(null);try{await t(i),Ee.close()}catch(b){const v=b instanceof Error?b.message:n("notes.moveNoteModal.error");h(v),d(!1)}}};return e.jsxs("div",{className:"w-full max-w-md p-1 max-h-[80vh] flex flex-col",children:[e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900 dark:text-slate-100",children:n("notes.moveNoteModal.title")}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:n("notes.moveNoteModal.description")})]}),g.length===0?e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400",children:n("notes.moveNoteModal.noSpaces")}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400",children:n("notes.moveNoteModal.destinationSpace")}),e.jsx(Oe,{placeholder:n("notes.moveNoteModal.searchPlaceholder"),value:r,onChange:b=>o(b.target.value),disabled:c})]}),e.jsx(Bs,{className:"mt-3 flex-1 min-h-[220px] max-h-[320px] pr-1",children:e.jsx("div",{className:"space-y-1.5 py-1",children:x.length===0?e.jsx("p",{className:"px-3 py-2 text-sm text-slate-500 dark:text-slate-400",children:n("notes.moveNoteModal.noMatches")}):x.map(b=>{const v=b.id===i;return e.jsxs("button",{type:"button",className:E("w-full px-3 py-2 flex items-center gap-2.5 text-left text-sm transition-all duration-200 rounded-lg","hover:bg-accent/30 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/20",v?"bg-primary/8 text-primary":"text-foreground"),onClick:()=>{l(b.id)},disabled:c,"aria-pressed":v,children:[b.emoji&&e.jsx("span",{className:"text-lg",children:b.emoji}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsx("p",{className:"font-medium truncate",children:b.name}),b.description&&e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 truncate",children:b.description})]}),v&&e.jsx(Xe,{className:"h-4 w-4 text-primary"})]},b.id)})})}),f&&e.jsxs("div",{className:"mt-3 rounded-md border border-slate-200/70 dark:border-slate-700/60 bg-slate-50 dark:bg-slate-800/40 px-3 py-2 text-xs text-slate-600 dark:text-slate-300",children:[e.jsxs("span",{className:"font-semibold",children:[n("notes.moveNoteModal.willMoveTo")," "]}),f.emoji&&e.jsx("span",{className:"mr-1",children:f.emoji}),e.jsx("span",{className:"font-medium",children:f.name}),f.description&&e.jsxs("span",{className:"ml-1 text-slate-500 dark:text-slate-400",children:[e.jsx("span",{"aria-hidden":"true",children:n("notes.moveNoteModal.dashSeparator")})," ",f.description]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx(M,{type:"button",variant:"ghost",onClick:()=>Ee.close(),disabled:c,children:n("common.cancel")}),e.jsx(M,{type:"button",onClick:p,disabled:!i||c,children:c?e.jsxs(e.Fragment,{children:[e.jsx(Mt,{className:"h-4 w-4 animate-spin mr-2"}),n("notes.moveNoteModal.moving")]}):n("notes.moveNoteModal.confirmMove")})]})]}),u&&e.jsx("p",{className:"mt-3 text-sm text-red-500",children:u})]})}function e0({onToggleAnalysis:s,onReply:t,message:n,isEditing:a,editorMode:r,onEditorModeChange:o,hasDraft:i=!1,draftEntry:l=null}){const{t:c}=L(),d=ve(),u=J(p=>p.currentChannelId)||"",h=async()=>{const p=n.content.length>100?`${n.content.substring(0,100)}...`:n.content;Ee.confirm({title:c("thoughtRecord.delete.title"),description:c("thoughtRecord.delete.description",{preview:p}),okText:c("thoughtRecord.delete.confirm"),okLoadingText:c("thoughtRecord.delete.deleting"),okVariant:"destructive",cancelText:c("thoughtRecord.delete.cancel"),onOk:async()=>{try{await d.noteManager.deleteMessage({messageId:n.id,hardDelete:!1,channelId:u})}catch(b){const v=b instanceof Error?b.message:c("thoughtRecord.delete.unknownError");alert(c("thoughtRecord.delete.error",{error:v}))}}})},g=()=>{u&&Ee.show({content:e.jsx(vc,{fromChannelId:u,onMove:async p=>{await d.noteManager.moveMessage({messageId:n.id,fromChannelId:u,toChannelId:p})}}),showFooter:!1,className:"max-w-md"})},x=()=>{if(i&&l?.content){const p=l.updatedAt?Gl(new Date(l.updatedAt)):null,b=()=>{Ee.close(),d.noteEditManager.startEditing({messageId:n.id,content:n.content,restoreDraft:!0,channelId:n.channelId})},v=()=>{d.noteEditManager.discardDraft(n.id),Ee.close(),d.noteEditManager.startEditing({messageId:n.id,content:n.content,channelId:n.channelId})},y=()=>{Ee.close(),d.noteEditManager.startEditing({messageId:n.id,content:n.content,channelId:n.channelId})};Ee.show({title:c("thoughtRecord.draft.available"),content:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm text-slate-600 dark:text-slate-300",children:[p?c("thoughtRecord.draft.savedMessage",{time:p}):c("thoughtRecord.draft.unsavedMessage"),e.jsx("br",{}),c("thoughtRecord.draft.choose")]}),e.jsx("div",{className:"max-h-48 overflow-y-auto rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 p-3 text-sm",children:e.jsx($s,{content:l.content})}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:justify-end",children:[e.jsx(M,{variant:"ghost",size:"sm",onClick:y,className:"sm:order-1",children:c("thoughtRecord.draft.ignore")}),e.jsx(M,{variant:"ghost",size:"sm",onClick:v,className:"text-red-600 hover:text-red-700 hover:bg-red-50 dark:text-red-300 dark:hover:bg-red-500/20 sm:order-0",children:c("thoughtRecord.draft.discard")}),e.jsx(M,{size:"sm",onClick:b,className:"bg-blue-600 text-white hover:bg-blue-700 sm:order-2",children:c("thoughtRecord.draft.restore")})]})]}),showFooter:!1,className:"max-w-xl"});return}d.noteEditManager.startEditing({messageId:n.id,content:n.content,channelId:n.channelId})},f=[...a&&r&&o?[{icon:Vi,onClick:()=>o("markdown"),title:c("thoughtRecord.editor.markdownMode"),disabled:!1,enabled:!0,active:r==="markdown"},{icon:yt,onClick:()=>o("wysiwyg"),title:c("thoughtRecord.editor.wysiwygMode"),disabled:!1,enabled:!0,active:r==="wysiwyg"}]:[],{icon:gs,onClick:x,title:c(i?"thoughtRecord.actions.editWithDraft":"thoughtRecord.actions.edit"),disabled:a,enabled:Pe().channel.thoughtRecord.edit.enabled,indicator:i},{icon:fn,onClick:s,title:c("thoughtRecord.actions.toggleSparks"),disabled:a,enabled:Pe().channel.thoughtRecord.sparks.enabled},{icon:ju,onClick:void 0,title:c("thoughtRecord.actions.viewDetails"),disabled:a,enabled:Pe().channel.thoughtRecord.viewDetails.enabled},{icon:Ei,onClick:void 0,title:c("thoughtRecord.actions.bookmark"),disabled:a,enabled:Pe().channel.thoughtRecord.bookmark.enabled},{icon:tr,onClick:t,title:c("thoughtRecord.actions.reply"),disabled:a,enabled:Pe().channel.thoughtRecord.reply.enabled}].filter(p=>p.enabled);return e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out",children:[f.map(({icon:p,onClick:b,title:v,disabled:y,active:w,indicator:N})=>e.jsx(Jx,{icon:p,onClick:b,title:v,disabled:y,active:w,indicator:N},v)),e.jsx(Zx,{message:n,onDelete:h,onCopy:()=>navigator.clipboard.writeText(n.content),onMove:u?g:void 0})]})}const wc=({actions:s,className:t,leftActions:n,rightActions:a})=>{const r=(o,i)=>e.jsxs(M,{variant:o.variant||"ghost",size:o.size||"sm",onClick:o.onClick,disabled:o.disabled,className:E("h-8 px-3 text-xs",o.className),children:[o.icon,o.label]},i);return e.jsxs("div",{className:E("flex items-center justify-between",t),children:[e.jsx("div",{className:"flex items-center gap-2",children:n?.map(r)}),s&&s.length>0&&e.jsx("div",{className:"flex items-center gap-2",children:s.map(r)}),e.jsx("div",{className:"flex items-center gap-2",children:a?.map(r)})]})};class t0{textarea;updateContent;pendingOperations=[];constructor(t,n){this.textarea=t,this.updateContent=n,this.setupEventListeners()}setupEventListeners=()=>{this.textarea.addEventListener("keydown",this.handleKeyDown)};handleKeyDown=t=>{t.key==="Tab"&&(t.preventDefault(),this.handleTabIndentation(t.shiftKey))};handleTabIndentation=t=>{const n=this.textarea.selectionStart,a=this.textarea.selectionEnd,r=this.textarea.value;if(n===a)if(t){const o=r.substring(0,n),i=r.substring(a),l=Math.min(2,o.length-o.trimEnd().length),c=o.slice(0,-l)+i,d=n-l;this.setContentAndFocus(c,d,d)}else{const o=r.slice(0,n)+"  "+r.slice(a),i=n+2;this.setContentAndFocus(o,i,i)}else{const o=r.split(`
`),i=r.substring(0,n).split(`
`).length-1,l=r.substring(0,a).split(`
`).length-1;let c=n,d=a;const h=o.map((g,x)=>{if(x>=i&&x<=l)if(t){const f=g.replace(/^ {2}/,""),p=g.length-f.length;return x===i&&(c=Math.max(0,c-p)),x===l&&(d=Math.max(0,d-p)),f}else{const f="  "+g;return x===i&&(c+=2),x===l&&(d+=2),f}return g}).join(`
`);this.setContentAndFocus(h,c,d)}};setContentAndFocus=(t,n,a)=>{this.addPendingOperation(()=>{this.textarea&&document.contains(this.textarea)&&(this.textarea.focus(),this.textarea.setSelectionRange(n,a))}),this.updateContent(t)};addPendingOperation=t=>{this.pendingOperations.push(t)};consumePendingOperations=()=>{for(;this.pendingOperations.length>0;){const t=this.pendingOperations.shift();t&&t()}};hasPendingOperations=()=>this.pendingOperations.length>0;destroy=()=>{this.textarea.removeEventListener("keydown",this.handleKeyDown)}}const ao=s=>{const{textareaRef:t,updateContent:n,content:a}=s,r=m.useRef(null),o=m.useRef(n);return m.useEffect(()=>{o.current=n},[n]),m.useEffect(()=>(t.current&&(r.current&&r.current.destroy(),r.current=new t0(t.current,i=>{o.current(i)})),()=>{r.current&&(r.current.destroy(),r.current=null)}),[]),m.useEffect(()=>{r.current&&setTimeout(()=>{r.current?.consumePendingOperations()},0)},[a]),{editor:r.current}};function s0({content:s,isSaving:t,editorMode:n,onEditorModeChange:a,className:r}){const{t:o}=L(),i=ve(),[l,c]=m.useState(s),d=m.useRef(null),u=te(N=>N.updateContent),h=te(N=>N.editingMessageId),g=te(N=>N.showDraftPrompt),x=te(m.useCallback(N=>h?N.drafts[h]:void 0,[h])),f=m.useMemo(()=>g&&!!x,[g,x]),p=x?.updatedAt;ao({textareaRef:d,updateContent:u,content:n==="markdown"?s:""}),m.useEffect(()=>{d.current&&d.current.focus()},[]),m.useEffect(()=>{c(s)},[s]),m.useEffect(()=>{if(d.current){d.current.style.height="auto";const N=300;d.current.style.height=`${Math.min(d.current.scrollHeight,N)}px`}},[l]);const b=N=>{c(N),u(N)},v=()=>{l.trim()&&i.noteEditManager.save()},y=()=>{i.noteEditManager.cancel()},w=N=>{N.key==="Escape"?y():N.key==="Enter"&&uc(N)&&v()};return e.jsxs("div",{className:E("space-y-4",r),children:[f&&e.jsx("div",{className:"rounded-md border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900 dark:border-amber-400/30 dark:bg-amber-500/10 dark:text-amber-100",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:o("thoughtRecord.draft.found")}),p&&e.jsx("span",{className:"ml-2 text-xs text-amber-700/80 dark:text-amber-100/80",children:o("thoughtRecord.draft.saved",{time:Gl(new Date(p))})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-8 rounded-md bg-amber-500 px-3 text-xs font-medium text-white transition-colors hover:bg-amber-600",onClick:()=>i.noteEditManager.applyDraft(),children:o("thoughtRecord.draft.restore")}),e.jsx("button",{type:"button",className:"h-8 rounded-md px-3 text-xs font-medium text-amber-700 transition-colors hover:bg-amber-100 hover:text-amber-900 dark:text-amber-100 dark:hover:bg-amber-500/20",onClick:()=>i.noteEditManager.dismissDraftPrompt(),children:o("thoughtRecord.draft.dismiss")})]})]})}),e.jsx("div",{className:"relative rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm",children:n==="markdown"?e.jsx("textarea",{ref:d,value:l,onChange:N=>b(N.target.value),onKeyDown:w,placeholder:o("thoughtRecord.editor.placeholder"),className:"w-full min-h-[200px] max-h-[400px] resize-none bg-transparent border-0 rounded-none px-4 py-3 text-base leading-relaxed placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:ring-0 focus:outline-none focus:border-0 shadow-none text-slate-800 dark:text-slate-200 font-normal",disabled:t,style:{caretColor:"#3b82f6"}}):e.jsx("div",{onKeyDown:w,children:e.jsx(vn,{value:l,onChange:b,editable:!t,placeholder:o("thoughtRecord.editor.placeholder"),variant:"frameless",compactToolbar:!0,minHeight:200,maxHeight:360,className:"px-3 pt-3"})})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:[e.jsx("kbd",{className:"px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs border border-slate-200 dark:border-slate-700",children:qo.SAVE}),e.jsxs("span",{className:"ml-2",children:[o("thoughtRecord.editor.shortcuts.toSave"),","]}),e.jsx("kbd",{className:"px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs border border-slate-200 dark:border-slate-700 ml-2",children:qo.CANCEL}),e.jsx("span",{className:"ml-2",children:o("thoughtRecord.editor.shortcuts.toCancel")})]}),e.jsx(wc,{rightActions:[{label:o("thoughtRecord.editor.expand"),onClick:()=>i.noteEditManager.switchToExpandedMode(),disabled:t,icon:e.jsx(xn,{className:"w-3.5 h-3.5 mr-1.5"}),className:"text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800"},{label:o("thoughtRecord.editor.cancel"),onClick:()=>i.noteEditManager.cancel(),disabled:t,icon:e.jsx(fe,{className:"w-3.5 h-3.5 mr-1.5"}),className:"text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800"},{label:o(t?"thoughtRecord.editor.saving":"thoughtRecord.editor.save"),onClick:()=>i.noteEditManager.save(),disabled:t||!l.trim(),icon:t?e.jsx(Mt,{className:"w-3.5 h-3.5 mr-1.5 animate-spin"}):e.jsx(Xe,{className:"w-3.5 h-3.5 mr-1.5"}),className:"bg-blue-600 hover:bg-blue-700 text-white shadow-sm"}]})]})]})}function n0({children:s,onClick:t,className:n=""}){const a="hover:text-slate-600 dark:hover:text-slate-300 transition-colors duration-200",r=t?"cursor-pointer":"";return t?e.jsx("button",{onClick:t,className:`${a} ${r} ${n}`,children:s}):e.jsx("span",{className:`${a} ${n}`,children:s})}const yc=m.createContext(null),ro=()=>{const s=m.useContext(yc);if(!s)throw new Error("useDesktopPresenter must be used within a DesktopPresenterProvider");return s};function a0({message:s,hasSparks:t,aiAnalysis:n,onToggleAnalysis:a,threadCount:r}){const{t:o}=L();return e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-400 dark:text-slate-500 px-6",children:[e.jsx("div",{className:"flex items-center gap-4 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out",children:t&&Pe().channel.thoughtRecord.sparks.enabled&&e.jsx(n0,{onClick:a,children:o("thoughtRecord.sparks.count",{count:n.insights.length})})}),e.jsx("div",{className:"flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out",children:Pe().channel.thoughtRecord.thread.enabled})]})}function jc({children:s,messageId:t,maxHeight:n,clampMargin:a=0,className:r,gradientClassName:o,readMoreLabel:i,collapseLabel:l}){const{t:c}=L(),d=ve(),u=i??c("readMore.readMore"),h=l??c("readMore.collapse"),g=Fe(m.useCallback($=>$.setStatus,[])),x=Fe($=>$.pendingCollapseId),f=Fe(m.useCallback($=>$.acknowledgeCollapse,[])),[p,b]=m.useState(!1),[v,y]=m.useState(!1),w=m.useRef(null),N=Fe(cc),S=Fe(m.useCallback($=>$.activeMessageId,[])),j=Fe(m.useCallback($=>$.notifyLayoutChange,[])),C=Fe(m.useCallback($=>$.activateAutoScrollSuppression,[])),I=m.useRef(!1);m.useEffect(()=>{if(!w.current)return;const $=w.current.scrollHeight;y($>n+a)},[s,n,a,p]),m.useEffect(()=>{g(t,{long:v,expanded:p,collapseThreshold:n+a})},[t,v,p,n,a,g]),m.useEffect(()=>{x===t&&p&&(b(!1),f())},[x,t,p,f]),m.useEffect(()=>{j()},[j,p,v]),m.useEffect(()=>{p&&!I.current&&C(),I.current=p},[p,C]);const k=()=>{const $=d.scrollManager.getScrollContainer();if(!$)return;const H=$.querySelector(Rs.messageById(t));Mx({container:$,element:H,onCollapse:()=>b(!1)})},T=()=>{if(p)k();else{b(!0);return}},z=N&&S===t&&p,D={[us.collapseInlineFor]:t};return e.jsxs("div",{className:E("relative group overflow-hidden",r),children:[e.jsx("div",{ref:w,className:E("transition-all duration-100 ease-in-out",!p&&v?"overflow-hidden":"",p&&v?"pb-12":""),style:{maxHeight:!p&&v?`${n}px`:"none"},children:s}),!p&&v&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:E("pointer-events-none absolute inset-x-0 bottom-0 h-16 bg-gradient-to-t from-background via-background/60 to-transparent transition-colors duration-200 group-hover:from-muted group-hover:via-muted/50 group-hover:to-transparent z-0",o)}),e.jsxs("button",{type:"button",onClick:T,className:"absolute bottom-2 left-1/2 -translate-x-1/2 z-10 text-xs px-2 py-1.5 rounded-full bg-white/80 dark:bg-slate-900/60 backdrop-blur-sm text-muted-foreground shadow-sm border border-slate-200/30 dark:border-slate-700/30 flex items-center gap-1 active:scale-[0.98] transition-all duration-150 hover:bg-white/90 dark:hover:bg-slate-900/70 hover:shadow-md",children:[e.jsx("span",{children:u}),e.jsx(st,{className:"w-3 h-3"})]})]}),p&&v&&e.jsxs("button",{type:"button",...D,onClick:T,className:E("absolute bottom-4 left-1/2 -translate-x-1/2 z-10 text-xs px-2 py-1.5 rounded-full bg-white/80 dark:bg-slate-900/60 backdrop-blur-sm text-muted-foreground shadow-sm border border-slate-200/30 dark:border-slate-700/30 flex items-center gap-1 active:scale-[0.98] transition-all duration-150 hover:bg-white/90 dark:hover:bg-slate-900/70 hover:shadow-md",z&&"opacity-0 pointer-events-none"),children:[e.jsx(bs,{className:"w-3 h-3"}),e.jsx("span",{children:h})]})]})}function r0({children:s,maxHeight:t=300,className:n="",messageId:a}){return e.jsx(jc,{messageId:a,maxHeight:t,className:E("relative overflow-hidden pb-2",n),children:s})}function Nc(s){const t=s.trim(),n=t.match(/^```(?:json)?\s*([\s\S]*?)\s*```$/i);return n?n[1].trim():t}function Jo(s){const t=Nc(s),n=t.indexOf("{"),a=t.lastIndexOf("}");return n>=0&&a>n?t.slice(n,a+1).trim():t.trim()}function o0(s){return s.replace(/,\s*([}\]])/g,"$1")}function $n(s){const t=[s,Nc(s),Jo(s),o0(Jo(s))];let n=null;for(const a of t)try{return JSON.parse(a)}catch(r){n=r}throw n instanceof Error?n:new Error(`Failed to parse JSON: ${String(n)}`)}async function wn({schema:s,prompt:t,system:n,temperature:a,jsonOnly:r=!0}){if(!r){const g=(await ls.chat.completions.create({model:is,messages:[{role:"system",content:n||W.t("aiAssistant.prompts.systemPrompts.defaultAssistant")},{role:"user",content:t}],temperature:typeof a=="number"?a:.3})).choices?.[0]?.message?.content;if(!g)throw new Error("No content generated");return g}const o=JSON.stringify(s,null,2),i=n||W.t("aiAssistant.prompts.systemPrompts.defaultStructuredData"),l=W.t("aiAssistant.prompts.systemPrompts.defaultJSONGenerator",{schema:o}),c=`${i}

${l}`,d=`

Required output format: A single JSON object that matches the schema above. No markdown, no comments, no additional text.`;try{const h=async f=>ls.chat.completions.create({model:is,messages:[{role:"system",content:c},{role:"user",content:`${t}${d}`}],...f?{response_format:{type:"json_object"}}:{},temperature:typeof a=="number"?a:.3});let g;try{g=await h(!0)}catch{g=await h(!1)}const x=g.choices?.[0]?.message?.content;if(!x)throw new Error("No content generated");return $n(x)}catch(h){console.warn("[generateObject] JSON mode failed, trying tool calling:",h)}const u={type:"function",function:{name:"generate_structured_data",description:"Generate structured data according to the specified schema",parameters:s}};try{const g=(await ls.chat.completions.create({model:is,messages:[{role:"system",content:i},{role:"user",content:t}],tools:[u],tool_choice:{type:"function",function:{name:"generate_structured_data"}},temperature:typeof a=="number"?a:.3})).choices?.[0]?.message?.tool_calls?.[0];if(!g||g.type!=="function")throw new Error("No tool call generated");if(g.function.name!=="generate_structured_data")throw new Error("Unexpected tool call function name");const x=g.function.arguments;if(!x)throw new Error("No arguments in tool call");return $n(x)}catch(h){console.error("Failed to generate structured data using tools:",h),console.warn("Falling back to manual JSON generation...");const g=async(f,p=1)=>{const b=p>1?`

This is attempt ${p}. Please ensure the output strictly follows the schema.`:"",v=async N=>ls.chat.completions.create({model:is,messages:[{role:"system",content:`${c}${f?`
${f}`:""}${b}`},{role:"user",content:`${t}${d}`}],...N?{response_format:{type:"json_object"}}:{},temperature:typeof a=="number"?a:.3});let y;try{y=await v(!0)}catch{y=await v(!1)}const w=y.choices?.[0]?.message?.content;return typeof w=="string"?w:""};let x=await g();try{return $n(x)}catch(f){console.warn("First fallback attempt failed, retrying...",f);const p=`The previous output did not match the expected JSON schema. 
Please fix the output to strictly conform to this schema:

${o}

Common issues to avoid:
- Extra text before or after JSON
- Missing required fields
- Wrong data types
- Extra commas or syntax errors

Output ONLY the valid JSON object.`;x=await g(p,2);try{return $n(x)}catch(b){throw console.error("All attempts failed:",b),console.error("Generated text:",x),new Error(`Failed to generate valid JSON. Tool-based generation failed and fallback also failed. Last error: ${b}`)}}}}class ia{static DEFAULT_OPTIONS={maxMessages:20,maxContentLength:2e3,excludeCurrentMessage:!0};static getChannelContext(t,n,a={}){const r={...this.DEFAULT_OPTIONS,...a},o=cs(X.dataContainer,`messageByChannel.${t}`).get();if(!o?.messages)return console.warn(`[ChannelContextService] No messages found for channel: ${t}`),null;let i=o.messages;return r.excludeCurrentMessage&&n&&(i=i.filter(d=>d.id!==n)),{recentMessages:i.sort((d,u)=>u.timestamp.getTime()-d.timestamp.getTime()).slice(0,r.maxMessages).map(d=>({...d,content:this.truncateContent(d.content,r.maxContentLength)})),totalMessageCount:o.messages.length,channelId:t}}static formatContextForPrompt(t){return t.recentMessages.length===0?"":[`
<channel_context>`,"  <metadata>",`    <recent_messages_count>${t.recentMessages.length}</recent_messages_count>`,`    <total_messages_count>${t.totalMessageCount}</total_messages_count>`,`    <channel_id>${t.channelId}</channel_id>`,"  </metadata>","  <recent_thoughts>",...t.recentMessages.map((a,r)=>{const o=this.formatReadableTime(a.timestamp);return`    <thought index="${r+1}" timestamp="${o}">${a.content}</thought>`}),"  </recent_thoughts>",`</channel_context>
`].join(`
`)}static formatReadableTime(t){return t.toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}static truncateContent(t,n){if(t.length<=n)return t;const a=t.substring(0,n),r=Math.max(a.lastIndexOf("."),a.lastIndexOf("!"),a.lastIndexOf("?"));if(r>n*.7)return a.substring(0,r+1)+"...";const o=a.lastIndexOf(" ");return o>n*.8?a.substring(0,o)+"...":a+"..."}}const Zo={type:"object",properties:{sparks:{type:"array",items:{type:"string"},minItems:3,maxItems:5}},required:["sparks"]};async function i0(s){const{content:t,channelId:n,messageId:a,options:r={}}=s;let o="";if(r.includeChannelContext&&n){const d=ia.getChannelContext(n,a,r.contextOptions);d&&(o=ia.formatContextForPrompt(d))}const i=W.t.bind(W),l=o?i("aiAssistant.prompts.systemPrompts.sparks.qualityRequirements",{contextRequirement:i("aiAssistant.prompts.systemPrompts.sparks.qualityRequirementContext")}):i("aiAssistant.prompts.systemPrompts.sparks.qualityRequirements",{contextRequirement:""}),c=`<role>
${i("aiAssistant.prompts.systemPrompts.sparks.role")}
</role>

<task>
${i("aiAssistant.prompts.systemPrompts.sparks.task")}

<strategy>
${i("aiAssistant.prompts.systemPrompts.sparks.strategy")}

<spark_distribution_guide>
${i("aiAssistant.prompts.systemPrompts.sparks.sparkDistributionGuide")}
</spark_distribution_guide>
</strategy>
</task>

<objectives>
${i("aiAssistant.prompts.systemPrompts.sparks.objectiveExpand")}
${i("aiAssistant.prompts.systemPrompts.sparks.objectiveCare")}
${i("aiAssistant.prompts.systemPrompts.sparks.objectiveAdapt")}
${i("aiAssistant.prompts.systemPrompts.sparks.objectiveGrowth")}
${o?i("aiAssistant.prompts.systemPrompts.sparks.objectiveContext"):""}
${i("aiAssistant.prompts.systemPrompts.sparks.objectiveAdditional")}
</objectives>

${l}

<user_content>
${t}
</user_content>
${o?`<context>${o}</context>`:""}${r.additionalInstructions?`

<additional_instructions>${r.additionalInstructions}</additional_instructions>`:""}`;console.log("Generating creative sparks with schema:",Zo);try{const d=await wn({schema:Zo,prompt:c,temperature:.9,jsonOnly:!0});return console.log("Successfully generated creative sparks:",d.sparks),d.sparks}catch(d){throw console.error("Failed to generate creative sparks:",d),d}}async function*l0(s,t){const{content:n,channelId:a,messageId:r,options:o={}}=s;if(!n||!n.trim())return;let i="";if(o.includeChannelContext&&a){const f=ia.getChannelContext(a,r,o.contextOptions);f&&(i=ia.formatContextForPrompt(f))}const l=W.t.bind(W),c=`<role>
${l("aiAssistant.prompts.systemPrompts.sparks.roleSimple")}
</role>
<task>
${l("aiAssistant.prompts.systemPrompts.sparks.streamingTask")}
</task>
${o.additionalInstructions?`<additional_instructions>${o.additionalInstructions}</additional_instructions>`:""}
<user_content>
${n}
</user_content>
${i?`<context>${i}</context>`:""}`,d=await ls.chat.completions.create({model:is,stream:!0,temperature:.9,messages:[{role:"system",content:W.t("aiAssistant.prompts.systemPrompts.defaultAssistant")},{role:"user",content:c}]}),u=[];let h="";const g=5,x=/^\s*[-*â€¢]\s+/;try{for await(const p of d){if(t?.signal?.aborted)throw new DOMException("Aborted","AbortError");const b=p.choices?.[0]?.delta?.content||"";if(!b)continue;h+=b;const v=h.split(/\r?\n/);h=v.pop()||"";for(const y of v){const w=String(y).trim();if(!w)continue;const N=x.test(w)?w.replace(x,"").trim():w;N&&(u.includes(N)||(u.push(N),u.length>g&&u.splice(g),yield[...u]))}u.length>=3}const f=h.trim();if(f){const p=x.test(f)?f.replace(x,"").trim():f;p&&!u.includes(p)&&u.length<g&&(u.push(p),yield[...u])}}catch(f){throw f.name==="AbortError"||console.error("generateSparksStream error:",f),f}}class c0{rules=[];constructor(){this.initializeDefaultRules()}addRule(t){this.rules.push(t),this.rules.sort((n,a)=>(a.priority||0)-(n.priority||0))}removeRule(t){this.rules=this.rules.filter(n=>n.pattern.toString()!==t.toString())}processTags(t,n){const a=[];for(const o of n){const i=this.findMatchingRule(o);if(i){const l=i.handler(o,t);l&&a.push(l)}}return a.length===0?{enhancedPrompt:t,hasTagContext:!1}:{enhancedPrompt:`Special instructions:
${a.join(`
`)}`,hasTagContext:!0}}hasTagContext(t){return this.findMatchingRule(t)!==null}getSupportedPatterns(){return this.rules.map(t=>({pattern:t.pattern.toString(),description:t.description||"No description",priority:t.priority||0}))}findMatchingRule(t){for(const n of this.rules)if(typeof n.pattern=="string"){if(t.toLowerCase()===n.pattern.toLowerCase())return n}else if(n.pattern.test(t))return n;return null}initializeDefaultRules(){this.addRule({pattern:"prompt",handler:(t,n)=>`<instruction>${n}</instruction>`,priority:10,description:"Convert content to instruction"}),this.addRule({pattern:"translate",handler:(t,n)=>`<translate>${n}</translate>`,priority:10,description:"Translate content"}),this.addRule({pattern:"to-english",handler:(t,n)=>`<translate-to-english>${n}</translate-to-english>`,priority:10,description:"Translate content to English"}),this.addRule({pattern:/^prompt:/i,handler:t=>{const n=t.substring(7).trim();return n?`<instruction>${n}</instruction>`:""},priority:20,description:"Any tag starting with prompt: becomes an instruction"})}}const d0=new c0;function u0(s,t){return d0.processTags(s,t)}function Cc(s,t){const{enableContextEnhancement:n=!0,mode:a="batch",minContentLength:r=8}=t||{},[o,i]=m.useState(!1),[l,c]=m.useState(null),[d,u]=m.useState(null),[h,g]=m.useState(!1),x=m.useRef(null),f=(s.content||"").trim().length<r,{hasTagContext:p,enhancedPrompt:b}=m.useMemo(()=>u0(s.content,s.tags||[]),[s.content,s.tags]),v=m.useCallback(async C=>{const{userId:I}=O.getState();if(!I)throw new Error("User not authenticated");await X.updateMessage({messageId:s.id,channelId:s.channelId,updates:{aiAnalysis:{...s.aiAnalysis||{},insights:C,keywords:s.aiAnalysis?.keywords??[],topics:s.aiAnalysis?.topics??[],sentiment:s.aiAnalysis?.sentiment??"neutral",summary:s.aiAnalysis?.summary??"",tags:s.aiAnalysis?.tags??[],relatedTopics:s.aiAnalysis?.relatedTopics??[]}},userId:I})},[s.id,s.channelId,s.aiAnalysis]),y=m.useCallback(()=>{x.current?.abort()},[]),w=m.useCallback(async()=>{c(null),i(!0);try{const C=await i0({content:s.content,channelId:s.channelId,messageId:s.id,options:{includeChannelContext:n,additionalInstructions:p?b:void 0}});u(C),await v(C)}finally{i(!1)}},[s.content,s.channelId,s.id,n,p,b,v]),N=m.useCallback(async()=>{c(null),i(!0),g(!0);const C=new AbortController;x.current=C;const I=[];try{for await(const k of l0({content:s.content,channelId:s.channelId,messageId:s.id,options:{includeChannelContext:n,additionalInstructions:p?b:void 0}},{signal:C.signal}))u(k);I.length===0&&d?.length?await v(d):I.length>0&&await v(I)}catch(k){k?.name==="AbortError"||c(k.message||"Failed to generate sparks")}finally{g(!1),i(!1),x.current=null}},[s.content,s.channelId,s.id,n,p,b,v,d]),S=m.useCallback(async()=>{o||f||(a==="stream"?await N():await w())},[o,f,a,w,N]),j=m.useCallback(async()=>{u(null),await S()},[S]);return{isGenerating:o,isStreaming:h,error:l,hasTagContext:p,contentTooShort:f,sparks:d,generate:S,regenerate:j,cancel:y}}function m0({message:s,showAnalysis:t,className:n,onClose:a,enableContextEnhancement:r=!0,mode:o="stream"}){const{t:i}=L(),l=s.aiAnalysis,c=!!(l&&l.insights&&l.insights.length>0),{isGenerating:d,error:u,hasTagContext:h,sparks:g,generate:x,regenerate:f}=Cc(s,{enableContextEnhancement:r,mode:o}),p=!!(g&&g.length||c),b=g??l?.insights??[];return t?e.jsx("div",{className:E("mb-4 p-4 bg-slate-50/60 dark:bg-slate-800/30 rounded-lg border border-slate-200/50 dark:border-slate-700/50",n),children:e.jsx("div",{className:"space-y-4",children:p?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:i("thoughtRecord.sparks.title")}),h&&e.jsx("span",{className:"text-xs px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-full",children:i("thoughtRecord.sparks.tagEnhanced")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{onClick:f,variant:"outline",disabled:d,children:i(d?"thoughtRecord.sparks.generating":"thoughtRecord.sparks.regenerate")}),a&&e.jsx("button",{onClick:a,className:"p-1 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-all duration-200 rounded hover:bg-slate-200/60 dark:hover:bg-slate-700/60",title:i("thoughtRecord.sparks.close"),children:e.jsx(fe,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"space-y-3",children:[b.map((v,y)=>e.jsx("div",{className:"p-3 bg-white/60 dark:bg-slate-700/40 rounded-lg border border-slate-200/40 dark:border-slate-600/40",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-yellow-500/80 mt-2 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-slate-700 dark:text-slate-200 leading-relaxed",children:v})]})},y)),u&&e.jsx("div",{className:"text-xs text-red-500 px-1.5",children:u})]})]}):e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:i("thoughtRecord.sparks.title")}),h&&e.jsx("span",{className:"text-xs px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-full",children:i("thoughtRecord.sparks.tagEnhanced")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{variant:"outline",onClick:x,disabled:d,children:i(d?"thoughtRecord.sparks.generating":"thoughtRecord.sparks.generate")}),a&&e.jsx("button",{onClick:a,className:"p-1 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-all duration-200 rounded hover:bg-slate-200/60 dark:hover:bg-slate-700/60",title:i("thoughtRecord.sparks.close"),children:e.jsx(fe,{className:"w-4 h-4"})})]})]})})}):null}function h0(s){const[t,n]=m.useState(!1),a=s.aiAnalysis,r=!!a?.insights?.length;return{showAnalysis:t,handleToggleAnalysis:()=>{n(!t)},aiAnalysis:a,hasSparks:r}}function g0({tags:s,onTagsChange:t,trigger:n,maxTags:a=10,placeholder:r}){const{t:o}=L(),[i,l]=m.useState(!1),[c,d]=m.useState(""),[u,h]=m.useState(null),g=m.useRef(null),x=r||o("notes.tagEditor.placeholder");m.useEffect(()=>{i&&g.current&&g.current.focus()},[i]);const f=j=>{const C=j.trim().toLowerCase();if(C){if(s.includes(C)){d("");return}s.length>=a||(t([...s,C]),d(""))}},p=j=>{t(s.filter(C=>C!==j))},b=j=>{j.key==="Enter"?(j.preventDefault(),f(c)):j.key==="Escape"&&l(!1)},v=()=>{f(c)},y=j=>{h(j),d(j),g.current&&g.current.focus()},w=()=>{if(u&&c.trim()){const j=c.trim().toLowerCase();j!==u&&!s.includes(j)&&t(s.map(C=>C===u?j:C)),h(null),d("")}},N=()=>{h(null),d("")},S=j=>{j.key==="Enter"?(j.preventDefault(),w()):j.key==="Escape"&&N()};return e.jsxs(ln,{open:i,onOpenChange:l,children:[e.jsx(cn,{asChild:!0,children:n||e.jsxs(M,{variant:"ghost",size:"sm",className:"h-8 px-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 dark:text-slate-400 dark:hover:text-slate-100 dark:hover:bg-slate-800",children:[e.jsx(sr,{className:"h-4 w-4 mr-1"}),o("notes.tagEditor.tags"),s.length>0&&e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-xs bg-slate-200 dark:bg-slate-700 rounded-full",children:s.length})]})}),e.jsxs(dn,{className:"w-80 p-0",align:"start",side:"bottom",children:[e.jsxs("div",{className:"p-3 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(sr,{className:"h-4 w-4 text-slate-600 dark:text-slate-400"}),e.jsx("h3",{className:"text-sm font-medium text-slate-900 dark:text-slate-100",children:o("notes.tagEditor.editTags")})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Oe,{ref:g,value:c,onChange:j=>d(j.target.value),onKeyPress:u?S:b,placeholder:u?o("notes.tagEditor.editPlaceholder",{tag:u}):x,className:"flex-1"}),u?e.jsxs("div",{className:"flex gap-1",children:[e.jsx(M,{size:"sm",variant:"outline",onClick:N,className:"px-2",children:e.jsx(fe,{className:"h-3 w-3"})}),e.jsx(M,{size:"sm",onClick:w,disabled:!c.trim(),className:"px-2","aria-label":o("notes.tagEditor.confirm"),children:e.jsx("span",{"aria-hidden":"true",children:o("notes.tagEditor.checkmark")})})]}):e.jsx(M,{size:"sm",onClick:v,disabled:!c.trim()||s.length>=a,className:"px-2",children:e.jsx($e,{className:"h-3 w-3"})})]})]}),e.jsx("div",{className:"p-3",children:s.length===0?e.jsx("div",{className:"text-center py-4 text-slate-500 dark:text-slate-400 text-sm",children:o("notes.tagEditor.noTags")}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400 mb-2",children:o("notes.tagEditor.tagCount",{current:s.length,max:a})}),e.jsx("div",{className:"flex flex-wrap gap-1",children:s.map(j=>e.jsxs("div",{className:"group flex items-center gap-1 bg-slate-100 dark:bg-slate-800 rounded-md px-2 py-1 text-sm",children:[e.jsx("span",{className:"cursor-pointer hover:text-blue-600 dark:hover:text-blue-400",onClick:()=>y(j),children:j}),e.jsx("button",{onClick:()=>p(j),className:"opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-slate-600 dark:hover:text-slate-300",children:e.jsx(fe,{className:"h-3 w-3"})})]},j))})]})})]})]})}const p0={default:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",secondary:"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200",outline:"border border-gray-300 text-gray-700 dark:border-gray-600 dark:text-gray-300",destructive:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200",footer:"bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200"},f0={sm:"px-2 py-1 text-xs",md:"px-2.5 py-1.5 text-sm",lg:"px-3 py-2 text-base"};function x0({name:s,variant:t="default",size:n="sm",removable:a=!1,onClick:r,onRemove:o,className:i,truncate:l=!1,maxWidth:c="80px"}){const d=u=>{u.stopPropagation(),o?.()};return e.jsxs("span",{className:E("inline-flex items-center gap-1 rounded-full font-medium transition-colors",p0[t],f0[n],r&&"cursor-pointer hover:opacity-80",l&&"max-w-[80px]",i),style:l?{maxWidth:c}:void 0,onClick:r,title:l?s:void 0,children:[e.jsxs("span",{className:E(l&&"truncate"),children:["#",s]}),a&&e.jsx(M,{variant:"ghost",size:"sm",className:"h-4 w-4 p-0 hover:bg-transparent",onClick:d,children:e.jsx(fe,{className:"h-3 w-3"})})]})}function b0({tags:s,variant:t="default",size:n="sm",removable:a=!1,onTagClick:r,onTagRemove:o,className:i,maxTags:l,truncate:c=!1,maxWidth:d="80px"}){const{t:u}=L(),h=l?s.slice(0,l):s,g=l&&s.length>l?s.length-l:0;return s.length===0?null:e.jsxs("div",{className:E("flex flex-wrap gap-1",i),children:[h.map(x=>e.jsx(x0,{name:x,variant:t,size:n,removable:a,onClick:()=>r?.(x),onRemove:()=>o?.(x),truncate:c,maxWidth:d},x)),g>0&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:u("notes.tagList.more",{count:g})})]})}function v0({tags:s,onTagsChange:t,maxTags:n=10}){const{t:a}=L();return e.jsxs("div",{className:"flex items-center gap-2",children:[s.length>0&&e.jsx(b0,{tags:s,variant:"footer",size:"sm",maxTags:2,truncate:!0,maxWidth:"80px"}),e.jsx(g0,{tags:s,onTagsChange:t,maxTags:n,trigger:e.jsx("button",{type:"button",className:"inline-flex items-center justify-center rounded-lg p-1.5 transition-all duration-200 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 hover:bg-slate-200/60 dark:hover:bg-slate-700/60 cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-slate-400 dark:focus-visible:ring-slate-500",title:s.length>0?a("thoughtRecord.tags.count",{count:s.length}):a("thoughtRecord.tags.add"),"aria-label":s.length>0?a("thoughtRecord.tags.count",{count:s.length}):a("thoughtRecord.tags.add"),children:e.jsx(sr,{className:"h-3 w-3"})})})]})}function w0({message:s,onReply:t,threadCount:n=0}){const a=ve(),r=J(j=>j.currentChannelId)||"",o=O(j=>j.userId),{isEditing:i,editContent:l,editMode:c,isSaving:d}=bc(s),{showAnalysis:u,aiAnalysis:h,hasSparks:g,handleToggleAnalysis:x}=h0(s),[f,p]=m.useState(s.tags||[]),b=te(m.useCallback(j=>j.drafts[s.id]??null,[s.id])),v=m.useMemo(()=>to(s.content),[s.content]),y=!!b&&b.baseHash===v,w=te(j=>j.editorMode);m.useEffect(()=>{p(s.tags||[])},[s.tags]);const N=async j=>{if(p(j),!(!o||!r))try{await a.noteManager.updateMessage({messageId:s.id,channelId:r,updates:{tags:j},userId:o})}catch(C){console.error("Failed to update tags:",C),p(s.tags||[])}};if(s.isDeleted)return null;const S=Pe().channel.thoughtRecord.tags.enabled;return e.jsx("div",{className:"w-full","data-component":"thought-record",children:e.jsxs("div",{className:`group relative w-full py-2 transition-all duration-300 ease-out ${i?"bg-gray-100/60 dark:bg-gray-800/30":"hover:bg-gray-100/80 dark:hover:bg-gray-800/20"} ${s.isNew?"animate-in slide-in-from-bottom-5 fade-in duration-400":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 px-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 font-medium",children:[e.jsx(pa,{className:"w-3 h-3"}),e.jsx("span",{children:Yt(s.timestamp)})]}),!i&&S&&e.jsx("div",{className:"opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto transition-all duration-300 ease-out",children:e.jsx(v0,{tags:f,onTagsChange:N,maxTags:10})})]}),e.jsx(e0,{onToggleAnalysis:x,onReply:t,message:s,isEditing:i,editorMode:w,onEditorModeChange:a.noteEditManager.setEditorMode,hasDraft:!i&&y,draftEntry:b??null})]}),i&&c==="inline"?e.jsx(s0,{content:l,isSaving:d,editorMode:w,onEditorModeChange:a.noteEditManager.setEditorMode,className:"px-6"}):e.jsx("div",{className:"px-6",children:e.jsx(r0,{maxHeight:300,messageId:s.id,children:e.jsx($s,{content:s.content})})}),!i&&e.jsx(m0,{message:s,showAnalysis:u,className:"px-6 mx-6",onClose:x}),!i&&e.jsx(a0,{message:s,hasSparks:g,aiAnalysis:h||null,onToggleAnalysis:x,threadCount:n})]})})}const Ks=({children:s="",className:t=""})=>e.jsx("div",{className:`flex-1 flex flex-col min-h-0 relative ${t}`,children:s}),y0=({className:s=""})=>{const t=ve(),{currentChannelId:n}=J(),a=O(p=>p.channels),r=O(p=>p.channelsLoading),{messages:o,loading:i,hasMore:l,loadMore:c,getChannelState:d}=Os({onHistoryMessagesChange:p=>{t.rxEventBus.onHistoryMessagesLoadedEvent$.emit(p)}}),{handleScroll:u}=pc({onTrigger:()=>n&&c({channelId:n,messagesLimit:20}),canTrigger:!!l&&!i,getState:d,direction:"bottom"}),h=no(o,{latestFirst:!0}),g=Object.values(h).some(p=>p.some(b=>b.sender==="user"&&!b.parentId)),f=!!!n||a.some(p=>p.id===n);return n?!f||r?e.jsx(Ks,{children:e.jsx(nn,{count:5})}):i?e.jsx(Ks,{children:e.jsx(nn,{count:5})}):g?e.jsx(Ks,{className:s,children:e.jsx("div",{className:`flex-1 flex flex-col min-h-0 relative ${s}`,children:e.jsx(hc,{renderThoughtRecord:(p,b)=>e.jsx(w0,{message:p,threadCount:b}),groupedMessages:h,messages:o,onScroll:u})})}):e.jsx(Ks,{children:e.jsx(gc,{})}):e.jsx(Ks,{children:r||a.length>0?e.jsx(nn,{count:5}):e.jsx(Bx,{})})},j0=[{id:"gradient-1",name:"Ocean Breeze",type:"gradient",value:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",preview:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"},{id:"gradient-2",name:"Sunset Glow",type:"gradient",value:"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",preview:"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"},{id:"gradient-3",name:"Forest Mist",type:"gradient",value:"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",preview:"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"},{id:"gradient-4",name:"Warm Sand",type:"gradient",value:"linear-gradient(135deg, #fa709a 0%, #fee140 100%)",preview:"linear-gradient(135deg, #fa709a 0%, #fee140 100%)"},{id:"gradient-5",name:"Purple Haze",type:"gradient",value:"linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",preview:"linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)"},{id:"gradient-6",name:"Midnight Sky",type:"gradient",value:"linear-gradient(135deg, #2c3e50 0%, #3498db 100%)",preview:"linear-gradient(135deg, #2c3e50 0%, #3498db 100%)"}],N0=[{id:"color-1",name:"Soft Blue",type:"color",value:"#e3f2fd",preview:"#e3f2fd"},{id:"color-2",name:"Warm Gray",type:"color",value:"#f5f5f5",preview:"#f5f5f5"},{id:"color-3",name:"Mint Green",type:"color",value:"#e8f5e8",preview:"#e8f5e8"},{id:"color-4",name:"Lavender",type:"color",value:"#f3e5f5",preview:"#f3e5f5"},{id:"color-5",name:"Peach",type:"color",value:"#fff3e0",preview:"#fff3e0"},{id:"color-6",name:"Rose",type:"color",value:"#fce4ec",preview:"#fce4ec"}],C0=(s=6)=>{const t=[],n=new Set;for(;t.length<s;){const a=Math.floor(Math.random()*1e3)+1;n.has(a)||(n.add(a),t.push({id:`random-${a}`,name:`Image ${t.length+1}`,type:"image",value:`https://picsum.photos/id/${a}/800/400`,preview:`https://picsum.photos/id/${a}/100/100`}))}return t},k0=({currentBackground:s,onBackgroundSelect:t})=>{const{t:n}=L(),a=r=>s===r.value;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground mb-2",children:n("channelHeader.backgroundSwitcher.gradients")}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:j0.map(r=>e.jsx("button",{onClick:o=>{o.preventDefault(),o.stopPropagation(),t(r)},className:`relative aspect-square rounded-lg border-2 transition-all duration-200 hover:scale-105 cursor-pointer ${a(r)?"border-primary":"border-border hover:border-primary/50"}`,style:{background:r.preview},title:r.name,children:a(r)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 rounded-lg",children:e.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})},r.id))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground mb-2",children:n("channelHeader.backgroundSwitcher.solidColors")}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:N0.map(r=>e.jsx("button",{onClick:o=>{o.preventDefault(),o.stopPropagation(),t(r)},className:`relative aspect-square rounded-lg border-2 transition-all duration-200 hover:scale-105 cursor-pointer ${a(r)?"border-primary":"border-border hover:border-primary/50"}`,style:{background:r.preview},title:r.name,children:a(r)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 rounded-lg",children:e.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})},r.id))})]})]})},S0=({currentBackground:s,onBackgroundSelect:t})=>{const{t:n}=L(),[a,r]=m.useState(""),[o,i]=m.useState([]),[l,c]=m.useState(!1),d=f=>s===f.value,u=async()=>{c(!0);try{const f=C0(6);i(f)}finally{c(!1)}},h=()=>{u()},g=()=>{if(!a.trim())return;const f={id:`custom-${Date.now()}`,name:n("channelHeader.backgroundSwitcher.customImage"),type:"image",value:a.trim(),preview:a.trim()};t(f),r("")},x=f=>{try{return new URL(f),f.match(/\.(jpg|jpeg|png|gif|webp|svg)(\?.*)?$/i)}catch{return!1}};return m.useEffect(()=>{u()},[]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground",children:n("channelHeader.backgroundSwitcher.randomImages")}),e.jsx(M,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:h,disabled:l,children:l?e.jsx(Mt,{className:"h-3 w-3 animate-spin"}):e.jsx(Es,{className:"h-3 w-3"})})]}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:l?Array.from({length:6}).map((f,p)=>e.jsx("div",{className:"aspect-square rounded-lg border-2 border-border bg-muted animate-pulse"},p)):o.map(f=>e.jsxs("button",{onClick:p=>{p.preventDefault(),p.stopPropagation(),t(f)},className:`relative aspect-square rounded-lg border-2 transition-all duration-200 hover:scale-105 cursor-pointer overflow-hidden ${d(f)?"border-primary":"border-border hover:border-primary/50"}`,title:f.name,children:[e.jsx("img",{src:f.preview,alt:f.name,className:"w-full h-full object-cover",onError:p=>{const b=p.target;b.style.display="none"}}),d(f)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 rounded-lg",children:e.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})]},f.id))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground mb-2",children:n("channelHeader.backgroundSwitcher.customImageUrl")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Oe,{type:"url",placeholder:n("channelHeader.backgroundSwitcher.imageUrlPlaceholder"),value:a,onChange:f=>r(f.target.value),className:"text-xs"}),e.jsxs(M,{variant:"outline",size:"sm",className:"w-full",onClick:g,disabled:!a.trim()||!x(a),children:[e.jsx($e,{className:"w-4 h-4 mr-2"}),n("channelHeader.backgroundSwitcher.addImage")]}),a&&!x(a)&&e.jsx("p",{className:"text-xs text-destructive",children:n("channelHeader.backgroundSwitcher.invalidImageUrl")})]})]})]})};function M0({currentBackground:s,onBackgroundChange:t,onRemoveBackground:n,buttonClassName:a="h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105"}){const{t:r}=L(),[o,i]=m.useState(!1),[l,c]=m.useState("colors"),[d,u]=m.useState(s),h=m.useRef(!1);m.useEffect(()=>{h.current=o},[o]);const g=p=>{p&&u(s),i(p)},x=p=>{p.type==="gradient"||p.type==="color"?t({type:"color",value:p.value}):p.type==="image"&&t({type:"image",value:p.value})},f=()=>{d?(console.log("ðŸŽ¨ [BackgroundSwitcher] Resetting background to:",{originalBackground:d}),t({type:d.type,value:d.value||""})):n()};return e.jsxs(Q,{open:o,onOpenChange:g,children:[e.jsx(Q.Trigger,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"sm",className:a,title:r("backgroundSwitcher.changeBackground"),children:e.jsx(Ma,{className:"h-4 w-4"})})}),e.jsxs(Q.Content,{width:"w-80",align:"center",side:"bottom",onInteractOutside:p=>{p.preventDefault()},children:[e.jsxs(Q.Header,{children:[e.jsx(Ma,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:r("backgroundSwitcher.background")}),e.jsx(Q.Button,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:()=>i(!1),title:r("backgroundSwitcher.close"),children:e.jsx(fe,{className:"h-3 w-3"})})]}),e.jsxs(Q.Body,{children:[e.jsxs("div",{className:"flex space-x-1 mb-4",children:[e.jsxs(Q.Button,{variant:l==="colors"?"default":"outline",size:"sm",className:"flex-1",onClick:()=>c("colors"),children:[e.jsx(Ma,{className:"h-4 w-4 mr-2"}),r("backgroundSwitcher.colors")]}),e.jsxs(Q.Button,{variant:l==="images"?"default":"outline",size:"sm",className:"flex-1",onClick:()=>c("images"),children:[e.jsx(As,{className:"h-4 w-4 mr-2"}),r("backgroundSwitcher.images")]})]}),e.jsx("div",{className:"max-h-64 overflow-y-auto",children:l==="colors"?e.jsx(k0,{currentBackground:s?.value,onBackgroundSelect:x}):e.jsx(S0,{currentBackground:s?.value,onBackgroundSelect:x})}),e.jsx("div",{className:"mt-4 pt-3 border-t border-border",children:e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:r("backgroundSwitcher.description")}),e.jsx("div",{className:"flex justify-center",children:e.jsx(Q.Button,{variant:"outline",size:"sm",className:"h-6 px-3 text-xs",onClick:f,title:r("backgroundSwitcher.resetToOriginal"),children:r("backgroundSwitcher.reset")})})]})})]})]})]})}const I0=({currentChannel:s,channels:t,onChannelSelect:n,className:a=""})=>{const r=e.jsxs("div",{className:"flex items-center space-x-1.5 min-w-0 p-2 rounded-lg hover:bg-accent/50 transition-all duration-200 cursor-pointer group",children:[s.emoji&&e.jsx("div",{className:"text-lg flex-shrink-0 group-hover:scale-105 transition-transform duration-200",children:s.emoji}),e.jsx("h1",{className:"text-lg font-semibold text-muted-foreground group-hover:text-foreground truncate transition-colors duration-200 min-w-0 flex-1",children:s.name}),e.jsx(He,{variant:"secondary",className:"text-xs flex-shrink-0 text-muted-foreground group-hover:text-foreground transition-colors duration-200",children:s.messageCount}),e.jsx(st,{className:"h-4 w-4 text-muted-foreground group-hover:text-foreground flex-shrink-0 transition-colors duration-200"})]});return e.jsx(ic,{currentChannel:s,channels:t,onChannelSelect:n,trigger:r,className:a,maxHeight:400,itemHeight:40})};function T0({channel:s,isOpen:t,onOpenChange:n}){const{t:a}=L(),{publishSpace:r,unpublishSpace:o,updatePublishMode:i}=O(),l=Ye(C=>C.currentUser),[c,d]=m.useState(!1),[u,h]=m.useState(!1),[g,x]=m.useState(s.shareMode||"read-only");m.useEffect(()=>{x(s.shareMode||"read-only")},[s.shareMode]);const f=s.shareToken&&g!==s.shareMode,p=s.shareToken&&!f,b=s.shareToken?`${window.location.origin}/#/space/${s.shareToken}`:"",v=async()=>{if(!l){ke(a("channelManagement.publishSpace.signInToPublish")),Kt({title:a("channelManagement.publishSpace.signInTitle"),description:a("channelManagement.publishSpace.signInDescription")});return}d(!0);try{await r(s.id,g)}catch(C){console.error("Error publishing space:",C)}finally{d(!1)}},y=async()=>{if(!l){ke(a("channelManagement.publishSpace.signInToUnpublish")),Kt({title:a("channelManagement.publishSpace.signInToManageTitle"),description:a("channelManagement.publishSpace.signInToManageDescription")});return}Ee.confirm({title:a("channelManagement.publishSpace.unpublishTitle"),description:a("channelManagement.publishSpace.unpublishDescription",{channelName:s.name}),okText:a("channelManagement.publishSpace.unpublish"),okLoadingText:a("channelManagement.publishSpace.unpublishing"),okVariant:"destructive",cancelText:a("common.cancel"),onOk:async()=>{d(!0);try{await o(s.id),h(!1),n(!1)}catch(C){console.error("Error unpublishing space:",C)}finally{d(!1)}}})},w=async()=>{if(b)try{await navigator.clipboard.writeText(b),h(!0),setTimeout(()=>h(!1),2e3)}catch(C){console.error("Error copying link:",C)}},N=C=>{C!==g&&x(C)},S=async()=>{if(!(!s.shareToken||!f)){if(!l){ke(a("channelManagement.publishSpace.signInToUpdateMode")),Kt({title:a("channelManagement.publishSpace.signInToUpdateModeTitle"),description:a("channelManagement.publishSpace.signInToUpdateModeDescription")});return}d(!0);try{await i(s.id,g)}catch(C){console.error("Error updating publish mode:",C)}finally{d(!1)}}},j=()=>{x(s.shareMode||"read-only")};return e.jsx(Jt,{open:t,onOpenChange:n,children:e.jsxs(Zt,{className:"sm:max-w-md",children:[e.jsxs(Ds,{children:[e.jsx(_s,{children:a("channelManagement.publishSpace.title")}),e.jsx(wa,{children:s.shareToken?s.shareMode==="append-only"?a("channelManagement.publishSpace.publishedAppendOnly"):a("channelManagement.publishSpace.publishedReadOnly"):a("channelManagement.publishSpace.makeAccessible")})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider",children:a("channelManagement.publishSpace.mode")}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{onClick:()=>N("read-only"),className:E("flex items-center gap-2.5 px-2.5 py-2 rounded-lg cursor-pointer transition-all duration-200",g==="read-only"?"bg-primary/8 text-primary":"hover:bg-accent/30 text-foreground"),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("div",{className:E("transition-colors",g==="read-only"?"text-primary":"text-muted-foreground"),children:e.jsx(Nu,{className:"w-4 h-4"})}),e.jsx("span",{className:"text-sm font-medium",children:a("channelManagement.publishSpace.readOnly")})]}),e.jsx("div",{className:"flex items-center gap-1.5",children:e.jsx("span",{className:"text-xs text-muted-foreground/70",children:a("channelManagement.publishSpace.viewOnly")})})]}),e.jsxs("div",{onClick:()=>N("append-only"),className:E("flex items-center gap-2.5 px-2.5 py-2 rounded-lg cursor-pointer transition-all duration-200",g==="append-only"?"bg-primary/8 text-primary":"hover:bg-accent/30 text-foreground"),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("div",{className:E("transition-colors",g==="append-only"?"text-primary":"text-muted-foreground"),children:e.jsx(Ls,{className:"w-4 h-4"})}),e.jsx("span",{className:"text-sm font-medium",children:a("channelManagement.publishSpace.collaborative")})]}),e.jsx("div",{className:"flex items-center gap-1.5",children:e.jsx("span",{className:"text-xs text-muted-foreground/70",children:a("channelManagement.publishSpace.anyoneCanAdd")})})]})]}),e.jsx("div",{className:"mt-3 pt-3 border-t border-border/60",children:e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed",children:a(g==="read-only"?"channelManagement.publishSpace.readOnlyDescription":"channelManagement.publishSpace.collaborativeDescription")})})]}),p&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider",children:a("channelManagement.publishSpace.shareLink")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oe,{value:b,readOnly:!0,className:"flex-1 font-mono text-xs bg-muted/30 border-border/60",onClick:C=>C.target.select()}),e.jsx(M,{type:"button",variant:"outline",size:"icon",onClick:w,className:"shrink-0 h-9 w-9",children:u?e.jsx(Xe,{className:"h-4 w-4 text-primary"}):e.jsx(ps,{className:"h-4 w-4"})})]})]})]}),e.jsx(Or,{children:s.shareToken?f?e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsx(M,{type:"button",variant:"outline",onClick:j,disabled:c,className:"flex-1",children:a("common.cancel")}),e.jsx(M,{type:"button",onClick:S,disabled:c,className:"flex-1",children:a(c?"channelManagement.publishSpace.changing":"channelManagement.publishSpace.confirmChange")})]}):e.jsx(M,{type:"button",variant:"outline",onClick:y,disabled:c,className:"w-full",children:a(c?"channelManagement.publishSpace.unpublishing":"channelManagement.publishSpace.unpublish")}):e.jsx(M,{type:"button",onClick:v,disabled:c,className:"w-full",children:a(c?"channelManagement.publishSpace.publishing":"channelManagement.publishSpace.publish")})})]})})}const E0=s=>{let t=0;for(let n=0;n<s.length;n++)t=t*31+s.charCodeAt(n);return Math.abs(t)},A0=s=>({background:`url(https://picsum.photos/800/400?random=${s%100+1})`,isImage:!0}),R0=s=>{if(s.backgroundImage)return{background:`url(${s.backgroundImage})`,isImage:!0};if(s.backgroundColor)return{background:s.backgroundColor,isImage:!1};const t=E0(s.id);return A0(t)},L0=({channel:s,className:t="",defaultCollapsed:n=!1})=>{const{t:a}=L(),[r,o]=m.useState(!1),i=ro(),[l,c]=m.useState(!1),d=m.useRef(null),u=Fe(m.useCallback(D=>D.notifyLayoutChange,[])),h=Wt(m.useCallback(D=>D.setTimelineCoverCollapsed,[])),g=Wt(m.useCallback(D=>D.timelineCoverCollapsed??n,[n])),x=Wt(m.useCallback(D=>D.isLeftSidebarCollapsed,[])),f=Wt(m.useCallback(D=>D.setLeftSidebarCollapsed,[])),p=O(D=>D.channels),{setCurrentChannel:b}=J(),v=eo(p,s.id),{background:y,isImage:w}=R0(s),N=y.includes("gradient"),S=()=>w?{backgroundImage:y,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"}:N?{background:y}:{backgroundColor:y},j=()=>{if(l)return;c(!0),h(!g),u(),setTimeout(()=>{c(!1),u()},300)},C=()=>{f(!1)},I=async({type:D,value:$})=>{try{D==="color"?await i.channelManager.updateChannel(s.id,{backgroundColor:$,backgroundImage:void 0}):D==="image"&&await i.channelManager.updateChannel(s.id,{backgroundImage:$,backgroundColor:void 0})}catch(H){console.error("Failed to update channel background:",H)}},k=async()=>{try{await i.channelManager.updateChannel(s.id,{backgroundColor:void 0,backgroundImage:void 0})}catch(D){console.error("Failed to remove channel background:",D)}},T=e.jsxs("div",{className:"flex items-center space-x-2 min-w-0 w-full max-w-full overflow-hidden",children:[e.jsx(wr,{tone:"dark",onOpenApiAccess:()=>i.openSettings({tab:"apiAccess"})}),x&&e.jsxs(e.Fragment,{children:[e.jsx(M,{variant:"ghost",size:"sm",onClick:C,className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105 flex-shrink-0 animate-in fade-in slide-in-from-left-2 duration-300",title:a("channelHeader.expandSidebar"),children:e.jsx(Jn,{className:"h-4 w-4"})}),e.jsx(mn,{instantCreate:!0,trigger:e.jsx(M,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105 flex-shrink-0",title:a("channelHeader.newSpace"),"aria-label":a("channelHeader.newSpace"),children:e.jsx($e,{className:"h-4 w-4"})})})]}),x?e.jsxs("div",{className:"flex flex-1 min-w-0 max-w-full items-center gap-1",children:[e.jsx(I0,{currentChannel:s,channels:v,onChannelSelect:b,className:"min-w-0 max-w-full"}),e.jsx(aa,{channel:s,children:e.jsx(M,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105 flex-shrink-0",title:a("channelHeader.editSpace"),"aria-label":a("channelHeader.editSpace"),onClick:D=>D.stopPropagation(),children:e.jsx(gs,{className:"h-4 w-4"})})})]}):e.jsxs(e.Fragment,{children:[s.emoji&&e.jsx("div",{className:"text-lg flex-shrink-0 transition-all duration-300 ease-out hover:scale-110 cursor-pointer",children:s.emoji}),e.jsxs("div",{className:"flex items-center space-x-1.5 min-w-0 p-2 rounded-lg hover:bg-accent/50 transition-all duration-200 cursor-pointer group flex-1 overflow-hidden",children:[e.jsx("h1",{className:"text-lg font-semibold text-muted-foreground group-hover:text-foreground truncate transition-all duration-200 min-w-0",children:s.name}),e.jsx(He,{variant:"secondary",className:"text-xs flex-shrink-0 transition-all duration-200 text-muted-foreground group-hover:text-foreground",children:s.messageCount})]})]})]}),z=e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative z-10 flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2 min-w-0 flex-1",children:[e.jsx(wr,{tone:"light",onOpenApiAccess:()=>i.openSettings({tab:"apiAccess"})}),x&&e.jsxs(e.Fragment,{children:[e.jsx(M,{variant:"ghost",size:"sm",onClick:C,className:"h-8 w-8 p-0 text-white/80 hover:text-white hover:bg-white/20 transition-all duration-200 hover:scale-105 flex-shrink-0 animate-in fade-in slide-in-from-left-2 duration-300",title:a("channelHeader.expandSidebar"),children:e.jsx(Jn,{className:"h-4 w-4"})}),e.jsx(mn,{instantCreate:!0,trigger:e.jsx(M,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-white hover:bg-white/20 transition-all duration-200 hover:scale-105 flex-shrink-0",title:a("channelHeader.newSpace"),"aria-label":a("channelHeader.newSpace"),children:e.jsx($e,{className:"h-4 w-4"})})})]}),s.emoji&&e.jsx("div",{className:"text-4xl drop-shadow-lg flex-shrink-0 transition-all duration-300 ease-out",children:s.emoji}),e.jsxs("div",{className:"flex-1 min-w-0 ml-3",children:[e.jsx("h1",{className:"text-3xl font-bold text-white drop-shadow-lg truncate transition-all duration-300 ease-out min-w-0",children:s.name}),s.description&&e.jsx("p",{className:"text-white/90 text-sm mt-1.5 drop-shadow-md line-clamp-2 transition-all duration-300 ease-out",children:s.description})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-4 flex-shrink-0",children:[x&&e.jsx(aa,{channel:s,children:e.jsx(M,{variant:"ghost",size:"sm",className:"text-white hover:bg-white/20 transition-all duration-200 hover:scale-105",title:a("channelHeader.editSpace"),"aria-label":a("channelHeader.editSpace"),onClick:D=>D.stopPropagation(),children:e.jsx(gs,{className:"h-4 w-4"})})}),e.jsx(M,{variant:"ghost",size:"sm",className:"text-white hover:bg-white/20 transition-all duration-200 hover:scale-105",onClick:()=>hn(),title:a("channelHeader.search"),children:e.jsx(Je,{className:"h-4 w-4"})}),Pe().channel.settings.enabled,e.jsx(M0,{currentBackground:{type:s.backgroundColor?"color":"image",value:s.backgroundColor||s.backgroundImage},onBackgroundChange:I,onRemoveBackground:k,buttonClassName:"h-8 w-8 p-0 text-white hover:text-white hover:bg-white/20 transition-all duration-200 hover:scale-105"}),e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"sm",className:"group text-white hover:bg-white/20 transition-all duration-200",title:a("channelHeader.moreActions"),"aria-label":a("channelHeader.moreActions"),onClick:D=>D.stopPropagation(),children:e.jsx(ms,{className:"h-4 w-4 transition-transform duration-200 group-hover:scale-105"})})}),e.jsxs(mt,{align:"end",sideOffset:8,className:"min-w-[180px] p-1",children:[e.jsx(lt,{icon:s.shareToken?er:an,onSelect:()=>o(!0),children:s.shareToken?a("channelHeader.manageSharing"):a("channelHeader.publishSpace")}),e.jsx(Dt,{}),e.jsx(lt,{icon:bs,onSelect:j,children:a("channelHeader.collapseHeader")})]})]})]})]}),e.jsxs("div",{className:"relative z-10 flex items-center justify-between mt-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(He,{variant:"secondary",className:"bg-white/25 text-white border-white/40 backdrop-blur-sm transition-all duration-300 ease-out",children:[e.jsx(Ls,{className:"h-3 w-3 mr-1.5"}),e.jsx("span",{className:"font-medium",children:s.messageCount}),e.jsx("span",{className:"ml-1 text-xs opacity-90",children:a("channelHeader.messages")})]}),s.lastMessageTime&&e.jsxs(He,{variant:"secondary",className:"bg-white/25 text-white border-white/40 backdrop-blur-sm transition-all duration-300 ease-out",children:[e.jsx(Rr,{className:"h-3 w-3 mr-1.5"}),e.jsx("span",{className:"text-xs",children:new Date(s.lastMessageTime).toLocaleDateString()})]})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs(M,{variant:"secondary",size:"sm",className:"bg-white/25 text-white border-white/40 hover:bg-white/35 backdrop-blur-sm transition-all duration-200 hover:scale-105",onClick:()=>i.openAIAssistant(),children:[e.jsx(hs,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"font-medium",children:a("channelHeader.aiAssistant")})]})})]})]});return e.jsxs("div",{ref:d,className:E("relative w-full overflow-hidden transition-all duration-300 ease-out",g?"h-12":"h-52",g?"flex items-center justify-between px-4":"",t),style:g?{}:S(),children:[g?e.jsxs(e.Fragment,{children:[T,e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(sn,{icon:hs,onClick:()=>i.openAIAssistant(),title:a("channelHeader.aiAssistant")}),e.jsx(sn,{icon:tt,onClick:()=>i.openStudio(),title:a("channelHeader.studio")}),e.jsx(sn,{icon:Je,onClick:()=>hn(),title:a("channelHeader.search")}),Pe().channel.settings.enabled,e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"sm",className:"group h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200",title:a("channelHeader.moreActions"),"aria-label":a("channelHeader.moreActions"),onClick:D=>D.stopPropagation(),children:e.jsx(ms,{className:"h-4 w-4 transition-transform duration-200 group-hover:scale-105"})})}),e.jsxs(mt,{align:"end",sideOffset:8,className:"min-w-[180px] p-1",children:[e.jsx(lt,{icon:s.shareToken?er:an,onSelect:()=>o(!0),children:s.shareToken?a("channelHeader.manageSharing"):a("channelHeader.publishSpace")}),e.jsx(Dt,{}),e.jsx(lt,{icon:st,onSelect:j,children:a("channelHeader.expandHeader")})]})]})]})]}):e.jsxs("div",{className:"relative w-full h-full flex flex-col justify-between p-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-black/10 via-black/20 to-black/30 z-0"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-transparent to-black/10 z-0"}),z]}),e.jsx(T0,{channel:s,isOpen:r,onOpenChange:o})]})},D0=({content:s,actions:t,channel:n,className:a="",overlay:r})=>{const{sideView:o}=Le(),i=!o,l=i?"px-4 sm:px-6 py-4":"p-3",c=i?"w-full max-w-[900px] mx-auto":"w-full",d=m.useRef(null);return e.jsx("div",{className:`relative w-full h-full app-gradient-bg ${a}`,"data-component":"timeline-layout",children:e.jsx("div",{ref:d,className:`relative flex-1 flex flex-col h-full ${l}`,children:e.jsx("div",{className:`flex-1 min-h-0 ${c}`,children:e.jsxs("div",{className:"relative flex flex-col h-full overflow-hidden rounded-2xl bg-card",style:{boxShadow:"0 0 24px rgba(0, 0, 0, 0.08)"},children:[n&&e.jsx($0,{channel:n,layoutRef:d}),e.jsx("div",{className:"flex-1 flex flex-col min-h-0",children:s}),t&&e.jsx("div",{className:"shrink-0",children:t}),r&&e.jsx("div",{className:"absolute inset-0 z-30",children:r})]})})})})},_0=120,Qo=60,P0=20,O0=80,$0=({channel:s,layoutRef:t})=>{const n=ro(),a=m.useRef(null),r=m.useRef(null),o=m.useRef(null),i=m.useRef(0),l=m.useRef(0),[c,d]=m.useState(0),[u,h]=m.useState(!1),[g,x]=m.useState(!1);m.useEffect(()=>{const b=r.current;if(!b)return;const v=N=>{d(S=>Math.abs(S-N)>.5?N:S)},y=b.getBoundingClientRect().height;if(v(y),typeof ResizeObserver>"u")return;const w=new ResizeObserver(N=>{const S=N[0];S&&v(S.contentRect.height)});return w.observe(b),()=>w.disconnect()},[]),m.useEffect(()=>{const b=()=>{const S=o.current;if(!S)return;const j=S.scrollTop,C=i.current,I=j-C;h(k=>{let T=k;return k?j<=Qo?(l.current=0,T=!1):I<0?(l.current+=-I,l.current>=O0&&(T=!1,l.current=0)):I>0&&(l.current=0):j<=Qo?(T=!1,l.current=0):I>0&&j>_0?(T=!0,l.current=0):I!==0&&(l.current=0),T}),i.current=j},v=()=>{o.current&&(o.current.removeEventListener("scroll",b),o.current=null)},y=S=>{o.current!==S&&(v(),o.current=S,o.current.addEventListener("scroll",b,{passive:!0}),i.current=S.scrollTop,l.current=0,b())};let w=null;const N=()=>{const S=n.scrollManager.getScrollContainer();S&&S instanceof HTMLDivElement?y(S):v()};return N(),w=window.setInterval(N,500),()=>{w!==null&&window.clearInterval(w),v()}},[n]),m.useEffect(()=>{if(!u){x(!1);return}const b=v=>{const y=t.current;if(!y)return;const w=y.getBoundingClientRect(),N=v.clientX>=w.left&&v.clientX<=w.right,S=v.clientY>=w.top&&v.clientY<=w.bottom;if(!N||!S){x(T=>T&&!1);return}const j=v.clientY-w.top,C=a.current?.getBoundingClientRect(),k=!!C&&v.clientX>=C.left&&v.clientX<=C.right&&v.clientY>=C.top&&v.clientY<=C.bottom||j<=P0;x(T=>T===k?T:k)};return window.addEventListener("mousemove",b),()=>{window.removeEventListener("mousemove",b)}},[u,t]);const f=!u||g,p={transition:"transform 240ms ease, margin-bottom 240ms ease, opacity 180ms ease",transform:"translateY(0)",marginBottom:0,opacity:1,pointerEvents:"auto",willChange:"transform, margin-bottom, opacity"};return!f&&c>0&&(p.transform=`translateY(-${c}px)`,p.marginBottom=`-${c}px`,p.opacity=0,p.pointerEvents="none"),e.jsx("div",{ref:a,className:"relative z-20",style:p,children:e.jsx("div",{ref:r,children:e.jsx(L0,{channel:s})})})};function kc(){const{channels:s}=O(),{currentChannelId:t}=J();return s.find(n=>n.id===t)||null}function B0(){const{t:s}=L(),t=ve(),{currentChannelId:n}=J(),{message:a,handleMessageChange:r,handleSend:o}=mc(),i=qt(u=>u.setExpanded),l=kc(),c=O(u=>u.channels),d=J(u=>u.setCurrentChannel);return e.jsx(lc,{className:"w-full h-full",headerLeft:e.jsxs(e.Fragment,{children:[l&&e.jsx(so,{currentChannel:l,channels:c,onChannelSelect:d,className:"max-w-[240px]"}),e.jsx(M,{variant:"ghost",size:"icon",onClick:()=>{!a.trim()||!n||(o(),i(!1),t.rxEventBus.requestTimelineScrollToLatest$.emit())},disabled:!a.trim(),className:"h-9 w-9 text-muted-foreground hover:text-foreground","aria-label":s("common.send"),title:s("common.send"),children:e.jsx(fa,{className:"w-4 h-4"})})]}),headerRight:e.jsx(M,{variant:"ghost",size:"icon",onClick:()=>i(!1),className:"h-9 w-9","aria-label":s("common.collapse"),title:s("common.collapse"),children:e.jsx(Lr,{className:"w-4 h-4"})}),onKeyDown:u=>{if(u.key==="Escape"&&i(!1),u.key==="Enter"&&u.shiftKey){if(u.preventDefault(),!a.trim()||!n)return;o(),i(!1),t.rxEventBus.requestTimelineScrollToLatest$.emit()}},children:e.jsx(vn,{value:a,onChange:r,editable:!0,placeholder:"",className:"h-full",variant:"frameless"})})}const U0=({className:s=""})=>{const t=kc();ws();const n=qt(o=>o.expanded),a=te(o=>!!(o.editingMessageId&&o.editMode==="expanded")),r=a?e.jsx(hx,{}):n?e.jsx(B0,{}):null;return e.jsxs(e.Fragment,{children:[e.jsx(D0,{channel:t||void 0,content:e.jsx(y0,{}),actions:t&&!n&&!a?e.jsx(yx,{}):null,overlay:r,className:s}),e.jsx(Zf,{})]})},F0=({isOpen:s,onClose:t,onSendMessage:n,currentThreadId:a})=>{const{t:r}=L(),{messages:o}=Os({}),i=a&&o?.find(p=>p.id===a)||null,l=a?o?.filter(p=>p.threadId===a)||[]:[],[c,d]=m.useState(""),[u,h]=m.useState(!1),g=()=>{c.trim()&&(n?.(c.trim()),d(""))},x=p=>{p.key==="Enter"&&uc(p)&&(p.preventDefault(),g())},f=(p,b=200)=>p.length<=b?p:p.substring(0,b)+"...";return s?e.jsxs("div",{className:"h-full flex flex-col bg-white dark:bg-slate-900",children:[e.jsxs("div",{className:"flex-shrink-0 flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(tr,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),e.jsx("h3",{className:"font-semibold text-slate-800 dark:text-slate-200",children:r("threadManagement.sidebar.title")}),l.length>0&&e.jsx("span",{className:"px-2 py-1 text-xs bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-full",children:l.length})]}),e.jsx("button",{onClick:t,className:"p-2 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors duration-200 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800",children:e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto timeline-scroll",children:[i&&e.jsx("div",{className:"p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/30",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0",children:e.jsx(qa,{className:"w-4 h-4 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-slate-800 dark:text-slate-200 mb-1",children:r("threadManagement.sidebar.originalThought")}),e.jsx("div",{className:"text-sm text-slate-600 dark:text-slate-400 leading-relaxed",children:u?i.content:f(i.content)}),i.content.length>200&&e.jsx("button",{onClick:()=>h(!u),className:"mt-2 flex items-center gap-1 text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors duration-200",children:u?e.jsxs(e.Fragment,{children:[e.jsx(bs,{className:"w-3 h-3"}),r("threadManagement.sidebar.showLess")]}):e.jsxs(e.Fragment,{children:[e.jsx(st,{className:"w-3 h-3"}),r("threadManagement.sidebar.showMore")]})})]})]})}),e.jsx("div",{className:"p-4 space-y-4",children:l.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(tr,{className:"w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-4"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-sm",children:r("threadManagement.sidebar.noReplies")})]}):l.map(p=>e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${p.sender==="user"?"bg-blue-500":"bg-slate-500"}`,children:p.sender==="user"?e.jsx(qa,{className:"w-4 h-4 text-white"}):e.jsx(hs,{className:"w-4 h-4 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-slate-800 dark:text-slate-200 mb-1",children:p.sender==="user"?r("threadManagement.sidebar.you"):r("threadManagement.sidebar.aiAssistant")}),e.jsx("div",{className:"text-sm text-slate-600 dark:text-slate-400 leading-relaxed",children:p.content})]})]},p.id))})]}),e.jsx("div",{className:"flex-shrink-0 p-4 border-t border-slate-200 dark:border-slate-700",children:e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx("textarea",{value:c,onChange:p=>d(p.target.value),onKeyDown:x,placeholder:r("threadManagement.sidebar.addToDiscussion"),className:"w-full px-3 py-2 text-sm border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder:text-slate-500 resize-none focus:outline-none  focus:border-transparent",rows:2})}),e.jsx("button",{onClick:g,disabled:!c.trim(),className:"p-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:text-blue-600 text-white rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(fa,{className:"w-4 h-4"})})]})})]}):null},Sc=[{id:"voice-call",title:"Call",description:"Realtime voice call with AI (no history)",icon:Cu,colorClass:"bg-gradient-to-br from-sky-50 to-cyan-50 dark:from-sky-950/30 dark:to-cyan-950/30 border-sky-100/60 dark:border-sky-900/40",iconColorClass:"text-sky-600 dark:text-sky-400",order:0,enabled:!0},{id:"audio-summary",title:"Audio",description:"Generate audio summaries from your notes",icon:ku,colorClass:"bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30 border-blue-100/60 dark:border-blue-900/40",iconColorClass:"text-blue-600 dark:text-blue-400",order:1,enabled:!0},{id:"mindmap",title:"Mindmap",description:"Visualize connections and relationships",icon:Su,colorClass:"bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-950/30 dark:to-pink-950/30 border-purple-100/60 dark:border-purple-900/40",iconColorClass:"text-purple-600 dark:text-purple-400",order:2,enabled:!0},{id:"wiki-card",title:"Concept",description:"Create wiki-style concept cards",icon:Di,colorClass:"bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950/30 dark:to-orange-950/30 border-amber-100/60 dark:border-amber-900/40",iconColorClass:"text-amber-600 dark:text-amber-400",order:3,enabled:!0},{id:"report",title:"Report",description:"Generate comprehensive reports",icon:yt,colorClass:"bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-950/30 dark:to-teal-950/30 border-emerald-100/60 dark:border-emerald-900/40",iconColorClass:"text-emerald-600 dark:text-emerald-400",order:4,enabled:!0}],z0=s=>Sc.find(t=>t.id===s),H0=()=>Sc.filter(s=>s.enabled).sort((s,t)=>s.order-t.order),Pt=_e()(Xt(s=>({currentContext:null,currentModule:null,contentItems:{"audio-summary":[],mindmap:[],"wiki-card":[],report:[]},activeItemId:null,isGenerating:!1,ephemeralContextChannelIds:[],setCurrentContext:t=>s({currentContext:t}),setCurrentModule:t=>s({currentModule:t}),setEphemeralContextChannelIds:t=>s({ephemeralContextChannelIds:t}),addContentItem:t=>s(n=>({contentItems:{...n.contentItems,[t.moduleId]:[...n.contentItems[t.moduleId],t]}})),updateContentItem:(t,n)=>s(a=>{const r={...a.contentItems};for(const o in r){const i=r[o].findIndex(l=>l.id===t);if(i>=0){r[o]=[...r[o].slice(0,i),{...r[o][i],...n},...r[o].slice(i+1)];break}}return{contentItems:r}}),deleteContentItem:t=>s(n=>{const a={...n.contentItems};for(const r in a)a[r]=a[r].filter(o=>o.id!==t);return{contentItems:a,activeItemId:n.activeItemId===t?null:n.activeItemId}}),setActiveItem:t=>s({activeItemId:t}),setGenerating:t=>s({isGenerating:t}),togglePin:t=>s(n=>{const a={...n.contentItems};for(const r in a){const o=a[r],i=o.findIndex(l=>l.id===t);if(i>=0){const l=o[i];o[i]={...l,pinned:!l.pinned};break}}return{contentItems:a}})}),{name:"stillroot-studio",partialize:s=>({contentItems:s.contentItems,currentContext:s.currentContext})})),G0=s=>s?s.includes("blue")?"bg-blue-100/80 dark:bg-blue-900/40":s.includes("purple")?"bg-purple-100/80 dark:bg-purple-900/40":s.includes("amber")||s.includes("orange")?"bg-amber-100/80 dark:bg-amber-900/40":s.includes("emerald")||s.includes("teal")?"bg-emerald-100/80 dark:bg-emerald-900/40":"bg-muted/50 dark:bg-muted/30":"bg-muted/50 dark:bg-muted/30",V0=m.memo(function({module:t,onClick:n}){const a=t.icon,r=G0(t.iconColorClass);return e.jsx(he.div,{whileHover:{scale:1.02,y:-2},whileTap:{scale:.98},transition:{duration:.2,ease:[.16,1,.3,1]},className:"relative",children:e.jsxs("div",{className:E("relative overflow-hidden p-0 transition-all duration-300 group cursor-pointer rounded-lg","backdrop-blur-sm bg-card/80",t.colorClass,"before:absolute before:inset-0 before:rounded-xl before:opacity-0 before:transition-opacity before:duration-300","before:bg-gradient-to-br before:from-white/40 before:to-transparent dark:before:from-white/5","hover:before:opacity-100","active:scale-[0.98]"),onClick:n,children:[e.jsxs("div",{className:"relative flex items-center",children:[e.jsx("div",{className:E("flex-shrink-0 w-14 flex items-center justify-center py-2.5 transition-all duration-300","rounded-l-lg",r),children:e.jsx("div",{className:E("relative flex items-center justify-center w-10 h-10 rounded-lg transition-all duration-300","group-hover:scale-110"),children:e.jsx(a,{className:E("w-5 h-5 transition-all duration-300 relative z-10",t.iconColorClass||"text-muted-foreground","group-hover:scale-110","drop-shadow-sm")})})}),e.jsx("div",{className:"flex-1 min-w-0 px-3 py-2.5 flex items-center",children:e.jsx("div",{className:E("text-sm font-semibold transition-all duration-300","text-foreground group-hover:text-foreground/90 drop-shadow-sm"),children:t.title})})]}),e.jsx("div",{className:"absolute inset-0 rounded-xl bg-gradient-to-br from-white/0 via-white/0 to-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"})]})})}),W0=m.memo(function(){const{t}=L(),{channels:n}=O(),{currentContext:a,setCurrentContext:r}=Pt(),[o,i]=m.useState(!1),[l,c]=m.useState(""),d=m.useMemo(()=>a?.channelIds||[],[a?.channelIds]),u=a?.mode||"auto",h=n.filter(p=>p.name.toLowerCase().includes(l.toLowerCase())),g=m.useCallback(p=>{const b=d.includes(p)?d.filter(v=>v!==p):[...d,p];r({mode:"custom",channelIds:b})},[d,r]),x=m.useCallback(p=>{p==="all"?r({mode:"all",channelIds:n.map(b=>b.id)}):p==="none"?r({mode:"none",channelIds:[]}):p==="auto"&&r({mode:"auto",channelIds:[]}),i(!1)},[n,r]),f=()=>u==="all"?t("studio.contextSelector.mode.all"):u==="none"?t("studio.contextSelector.mode.none"):u==="auto"?t("studio.contextSelector.mode.auto"):d.length===0?t("studio.contextSelector.noSpacesSelected"):d.length===1?n.find(b=>b.id===d[0])?.name||t("studio.contextSelector.oneSpace"):t("studio.contextSelector.multipleSpaces",{count:d.length});return e.jsxs(Q,{open:o,onOpenChange:i,children:[e.jsx(Q.Trigger,{asChild:!0,children:e.jsxs("div",{className:"flex items-center gap-1.5 h-8 px-3 rounded-md bg-transparent hover:bg-accent/50 text-muted-foreground hover:text-foreground transition-colors cursor-pointer",children:[e.jsx("span",{className:"text-sm font-medium truncate",children:f()}),e.jsx(st,{className:"w-3 h-3 opacity-50 flex-shrink-0"})]})}),e.jsxs(Q.Content,{className:"w-80",children:[e.jsx(Q.Header,{children:e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:t("studio.contextSelector.title")})}),e.jsx(Q.Body,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{variant:u==="auto"?"default":"ghost",size:"sm",className:"w-full justify-start",onClick:()=>x("auto"),children:t("studio.contextSelector.mode.auto")}),e.jsx(M,{variant:u==="all"?"default":"ghost",size:"sm",className:"w-full justify-start",onClick:()=>x("all"),children:t("studio.contextSelector.mode.all")}),e.jsx(M,{variant:u==="none"?"default":"ghost",size:"sm",className:"w-full justify-start",onClick:()=>x("none"),children:t("studio.contextSelector.mode.none")}),e.jsxs("div",{className:"border-t pt-2 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2 px-2 mb-2",children:[e.jsx(Je,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("input",{type:"text",placeholder:t("studio.contextSelector.searchPlaceholder"),value:l,onChange:p=>c(p.target.value),className:"flex-1 bg-transparent border-0 outline-none text-sm"})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:h.length===0?e.jsx("div",{className:"text-center py-4 text-sm text-muted-foreground",children:t(l?"studio.contextSelector.noSpacesFound":"studio.contextSelector.noSpacesAvailable")}):e.jsx("div",{className:"space-y-1",children:h.map(p=>{const b=d.includes(p.id);return e.jsxs("div",{className:E("flex items-center gap-2 px-2 py-1.5 rounded-lg text-sm cursor-pointer transition-colors",b?"bg-primary/10 text-primary":"hover:bg-accent"),onClick:()=>{x("custom"),g(p.id)},children:[e.jsx("span",{children:p.emoji||"ðŸ“"}),e.jsx("span",{className:"flex-1 truncate",children:p.name}),b&&e.jsx(Xe,{className:"w-4 h-4"})]},p.id)})})})]})]})})]})]})}),q0="stillroot-audio",la="studio-audio",K0=1;function Y0(){return new Promise((s,t)=>{const n=indexedDB.open(q0,K0);n.onupgradeneeded=()=>{const a=n.result;a.objectStoreNames.contains(la)||a.createObjectStore(la)},n.onsuccess=()=>s(n.result),n.onerror=()=>t(n.error)})}async function Fa(s,t){const n=await Y0();try{return await new Promise((a,r)=>{const o=n.transaction(la,s),i=o.objectStore(la),l=t(i);l.onsuccess=()=>a(l.result),l.onerror=()=>r(l.error),o.onabort=()=>r(o.error)})}finally{n.close()}}const ca={put:async(s,t,n)=>{const a={blob:t,mimeType:n,createdAt:Date.now()};await Fa("readwrite",r=>r.put(a,s))},get:async s=>await Fa("readonly",n=>n.get(s)),delete:async s=>{await Fa("readwrite",t=>t.delete(s))}},X0=m.memo(function({item:t,onClose:n}){const{t:a}=L(),r=t.data,o=m.useRef(null),[i,l]=m.useState(!1),[c,d]=m.useState(null),[u,h]=m.useState(null),g=r?.transcriptMarkdown||"";m.useEffect(()=>{let b=!1;return(async()=>{if(!r?.audioStorageKey)return;const y=await ca.get(r.audioStorageKey);if(!y||b)return;const w=URL.createObjectURL(y.blob);d(w),h(y.mimeType)})(),()=>{b=!0}},[r?.audioStorageKey]),m.useEffect(()=>()=>{c&&URL.revokeObjectURL(c)},[c]);const x=m.useMemo(()=>`${(r?.title||"podcast").replace(/[\\/:*?"<>|]+/g,"_")}.wav`,[r?.title]),f=async()=>{const b=o.current;b&&(b.paused?await b.play():b.pause())},p=async()=>{if(!r?.audioStorageKey)return;const b=await ca.get(r.audioStorageKey);if(!b)return;const v=URL.createObjectURL(b.blob),y=document.createElement("a");y.href=v,y.download=x,document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(v)};return e.jsxs("div",{className:"h-full flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(M,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:n,children:e.jsx(It,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-sm font-medium flex-1 truncate",children:r?.title||t.title})]}),e.jsx(Bs,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:"p-4 space-y-4",children:[t.status==="error"?e.jsx("div",{className:"text-sm text-destructive",children:t.errorMessage||a("common.unknownError")}):c?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{variant:"outline",size:"sm",onClick:()=>void f(),children:i?e.jsx(Mu,{className:"w-4 h-4"}):e.jsx(Iu,{className:"w-4 h-4"})}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>void p(),children:e.jsx(vs,{className:"w-4 h-4"})})]}),e.jsx("audio",{ref:o,src:c,controls:!0,className:"w-full",onPlay:()=>l(!0),onPause:()=>l(!1),onEnded:()=>l(!1)}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[u?`${u} â€¢ `:"",a("studio.audioSummary.generatedPodcast")]})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:a("studio.audioSummary.noAudioAvailable")}),g&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground mb-2 uppercase tracking-wide",children:a("studio.audioSummary.transcript")}),e.jsx($s,{content:g})]})]})})]})});async function yn(s,t){const n=[];for(const a of s){await X.ensureMessagesLoaded(a,{maxMessages:t?.maxMessagesPerChannel??200,initialLimit:t?.initialLimit??50,pageSize:t?.pageSize??50,timeoutMs:t?.timeoutMs??15e3});const o=(X.dataContainer.get().messageByChannel[a]?.messages??[]).filter(i=>i.sender==="user");for(const i of o)n.push({channelId:a,content:i.content||"",timestamp:i.timestamp||new Date(0)})}return n}function ka(s){const t=/[\u4e00-\u9fff]/,n=/[\u3040-\u309f\u30a0-\u30ff]/,a=/[\uac00-\ud7af]/,r=/[\u0600-\u06ff]/,o=/[\u0400-\u04ff]/;return t.test(s)?"Chinese":n.test(s)?"Japanese":a.test(s)?"Korean":r.test(s)?"Arabic":o.test(s)?"Russian":"English"}function Cr(s){const t=(s||"").toLowerCase();return t.startsWith("zh")?"Chinese":t.startsWith("ja")?"Japanese":t.startsWith("ko")?"Korean":t.startsWith("ru")?"Russian":t.startsWith("ar")?"Arabic":"English"}function jn(s,t){return s.map(n=>t.find(a=>a.id===n)?.name||n).join(", ")}function Nn(s,t){return s.slice().sort((n,a)=>{const r=n.timestamp instanceof Date?n.timestamp.getTime():n.timestamp;return(a.timestamp instanceof Date?a.timestamp.getTime():a.timestamp)-r}).map((n,a)=>{const r=t.find(o=>o.id===n.channelId)?.name||n.channelId;return`Note ${a+1} (from ${r}):
${n.content}`}).join(`

---

`)}const J0={type:"object",properties:{title:{type:"string",description:"A short title (2-5 words, same language as the notes) that describes the theme of the mindmap"},nodes:{type:"array",items:{type:"object",properties:{id:{type:"string"},label:{type:"string"},importance:{type:"number"},group:{type:"string"}},required:["id","label"]}},edges:{type:"array",items:{type:"object",properties:{source:{type:"string"},target:{type:"string"},weight:{type:"number"}},required:["source","target"]}},tree:{type:"object",description:"Hierarchical mindmap structure with a single root for XMind-like layout",properties:{id:{type:"string"},label:{type:"string"},children:{type:"array",items:{$ref:"#/properties/tree"}}},required:["id","label"]}},required:["title","nodes","edges"]};async function Mc(s){const{channels:t}=O.getState();if(s.length===0)throw new Error("At least one channel is required");const n=jn(s,t),a=await yn(s,{maxMessagesPerChannel:200});if(a.length===0)throw new Error(`No notes found in selected channels: ${n}`);const r=a.map(h=>h.content).join(`

`),o=ka(r),i=Nn(a,t),l=W.t.bind(W),c=`${l("aiAssistant.prompts.systemPrompts.mindmap.role")}

${l("aiAssistant.prompts.systemPrompts.mindmap.graphDescription")}

${l("aiAssistant.prompts.systemPrompts.mindmap.treeDescription")}

${l("aiAssistant.prompts.systemPrompts.mindmap.constraints",{language:o})}
`,d=`Build a mindmap from the following notes from spaces: ${n}

${i}

Return a JSON object with title, nodes, and edges. All labels must be in ${o}.`,u=await wn({schema:J0,prompt:d,system:c,temperature:.4});return{title:u.title,nodes:u.nodes,edges:u.edges,generatedAt:Date.now(),contextChannelIds:s,tree:u.tree}}function Z0(){const s=m.useRef(null),[t,n]=m.useState({width:0,height:0});return m.useEffect(()=>{if(!s.current)return;const a=s.current,r=new ResizeObserver(i=>{const l=i[0];if(!l)return;const c=l.contentRect;n({width:Math.floor(c.width),height:Math.floor(c.height)})});r.observe(a);const o=a.getBoundingClientRect();return n({width:Math.floor(o.width),height:Math.floor(o.height)}),()=>r.disconnect()},[]),{ref:s,size:t}}function Q0(s,t){const n=new Map;for(const a of s)n.set(a.id,0);for(const a of t)n.set(a.source,(n.get(a.source)||0)+1),n.set(a.target,(n.get(a.target)||0)+1);return n}function eb(s,t){const n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download=s,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}function tb({data:s,onPersist:t}){const n=m.useRef(null),a=m.useRef(null),r=m.useRef(null),{ref:o,size:i}=Z0(),[l,c]=m.useState(null),[d,u]=m.useState([]),[h,g]=m.useState([]);m.useEffect(()=>{g(s.edges);const v=Math.max(200,i.width),y=Math.max(200,i.height);if(s.nodes.every(k=>typeof k.x=="number"&&typeof k.y=="number")){const k=s.nodes.map(T=>({...T,x:T.x,y:T.y,r:6+Math.min(10,T.importance||0)}));u(k);return}const N=s.nodes.map(k=>({...k})),S=s.edges.map(k=>({source:k.source,target:k.target,weight:k.weight})),j=Q0(s.nodes,s.edges),C=xh(N).force("link",bh(S).id(k=>k.id).distance(k=>{const T=typeof k.source=="object"?k.source.id:k.source;return 40+Math.min(100,12*Math.max(1,j.get(T)||1))}).strength(.12)).force("charge",vh().strength(-120)).force("collide",wh().radius(k=>18+Math.min(12,j.get(k.id)||0))).force("center",yh(v/2,y/2)).stop();for(let k=0;k<200;k++)C.tick();const I=N.map(k=>({...k,x:k.x??v/2,y:k.y??y/2,r:6+Math.min(10,(j.get(k.id)||0)*.6+(k.importance||0))}));u(I),t(I.map(({r:k,...T})=>T))},[s.nodes,s.edges,i.width,i.height,t]),m.useEffect(()=>{if(!a.current||!r.current)return;const v=Aa(a.current),y=Aa(r.current),w=S=>{y.attr("transform",S.transform.toString())},N=ph().scaleExtent([.25,3]).on("zoom",w);return v.call(N),N.transform(v,fh.translate(0,0).scale(1)),()=>{v.on("wheel.zoom",null),v.on("mousedown.zoom",null),v.on("touchstart.zoom",null)}},[i.width,i.height]);const x=m.useMemo(()=>jh().on("start",y=>{y.sourceEvent?.stopPropagation?.()}).on("drag",(y,w)=>{const N=y.x,S=y.y;w.x=N,w.y=S,u(j=>j.map(C=>C.id===w.id?{...C,x:N,y:S}:C))}).on("end",()=>{t(d.map(({r:y,...w})=>w))}),[d,t]);m.useEffect(()=>{if(!r.current)return;Aa(r.current).selectAll("g.node").call(x)},[d,x]);const f=m.useMemo(()=>new Map(d.map(v=>[v.id,v])),[d]),p=m.useCallback(v=>l&&(v.source===l||v.target===l),[l]),b=m.useCallback((v,y)=>{const w=(v.x+y.x)/2,N=(v.y+y.y)/2,S=y.x-v.x,j=y.y-v.y,C=Math.hypot(S,j)||1,I=-j/C,k=S/C,T=.16,z=w+I*C*T,D=N+k*C*T;return`M ${v.x},${v.y} Q ${z},${D} ${y.x},${y.y}`},[]);return e.jsx("div",{ref:v=>{o.current=v,n.current=v},className:"w-full h-full",children:e.jsxs("svg",{ref:a,id:"mindmap-svg",width:i.width,height:i.height,className:"block",children:[e.jsx("defs",{children:e.jsxs("filter",{id:"softGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"2.5",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})}),e.jsxs("g",{ref:r,children:[e.jsx("g",{children:h.map((v,y)=>{const w=f.get(v.source),N=f.get(v.target);if(!w||!N)return null;const S=v.weight??1,j=p(v),C=j?"hsl(var(--primary))":"hsl(var(--border))",I=j?.9:.6;return e.jsx("path",{d:b(w,N),stroke:C,strokeOpacity:I,strokeWidth:1+Math.min(2.5,Math.max(0,(S-.5)*1.2)),fill:"none",strokeLinecap:"round",pointerEvents:"none"},y)})}),e.jsx("g",{children:d.map(v=>{const y=l===v.id,w=h.some(N=>N.source===v.id||N.target===v.id);return e.jsxs("g",{className:"node",transform:`translate(${v.x}, ${v.y})`,onMouseEnter:()=>c(v.id),onMouseLeave:()=>c(null),style:{cursor:"grab"},children:[e.jsx("circle",{r:v.r,fill:y?"hsl(var(--primary))":w?"hsl(var(--accent))":"hsl(var(--muted))",fillOpacity:y?.95:.9,stroke:y?"hsl(var(--primary-foreground))":"hsl(var(--border))",strokeWidth:y?1.5:1,filter:y?"url(#softGlow)":void 0}),e.jsx("text",{x:v.r+6,y:4,className:"select-none",fontSize:12,fill:y?"hsl(var(--foreground))":"hsl(var(--muted-foreground))",children:v.label})]},v.id)})})]})]})})}const ei=160,ti=44,sb=30,si=4,nb=.005,ni=1.25;function Ic(s,t,n=0){const a=t.has(s.id),o=(s.children&&!a?s.children:[]).map(u=>Ic(u,t,n+1)),i=o.length?o.reduce((u,h)=>u+h.subtreeHeight,0)+(o.length-1)*si:0,l=Math.max(ti,i);let c=-l/2;for(const u of o)u.y=c+u.subtreeHeight/2,c+=u.subtreeHeight+si;const d={...s,width:ei,height:ti,x:n*(ei+sb),y:0,children:o,originalChildren:s.children,subtreeHeight:l};if(o.length>0){const u=o[0].y,h=o[o.length-1].y;d.y=(u+h)/2}return d}function Tc(s,t=0){s.y+=t,s.children.forEach(n=>Tc(n,s.y))}function ab(s,t){const[n,a]=[s.x,s.y],[r,o]=[t.x,t.y],i=n+(r-n)/2;return`M ${n},${a} C ${i},${a} ${i},${o} ${r},${o}`}function rb({node:s,onToggle:t,collapsed:n,onNodeClick:a,active:r}){const o=(s.originalChildren?.length||0)>0;return e.jsxs("g",{className:"mindmap-node-group",transform:`translate(${s.x}, ${s.y-s.height/2})`,onClick:()=>a?.(s.id),style:{cursor:a?"pointer":"default"},children:[e.jsx("foreignObject",{width:s.width,height:s.height,children:e.jsx("div",{className:"w-full h-full flex items-center justify-center p-1",children:e.jsx("div",{className:"w-full h-full bg-slate-200/50 dark:bg-slate-800/50 border rounded-xl shadow-sm flex items-center justify-center transition-colors "+(r?"border-indigo-500":"border-slate-300 dark:border-slate-700"),children:e.jsx("p",{className:"truncate px-2 "+(r?"text-indigo-700 dark:text-indigo-200 font-medium":"text-slate-800 dark:text-slate-100"),children:s.label})})})}),o&&e.jsxs("g",{transform:`translate(${s.width}, ${s.height/2})`,onClick:i=>{i.stopPropagation(),t(s.id)},children:[e.jsx("circle",{r:16,fill:"transparent"}),e.jsx("circle",{r:10,className:"fill-slate-50 dark:fill-slate-900"}),e.jsx("path",{d:n?"M -4 0 L 4 0 M 0 -4 L 0 4":"M -4 0 L 4 0",stroke:"currentColor",className:"stroke-slate-600 dark:stroke-slate-300",strokeWidth:2,strokeLinecap:"round"})]})]})}function Ec(s,t,n,a,r){const o=n.has(s.id),i=r?.has(s.id)??!1;let l=[e.jsx(rb,{node:s,onToggle:t,collapsed:o,onNodeClick:a,active:i},s.id)];return o||s.children.forEach(c=>{const d=i&&(r?.has(c.id)??!1);l.push(e.jsx("path",{d:ab({x:s.x+s.width,y:s.y},{x:c.x,y:c.y}),stroke:"currentColor",className:"transition-colors "+(d?"text-indigo-400 dark:text-indigo-500":"text-slate-300 dark:text-slate-600"),fill:"none",strokeWidth:1.5,strokeLinecap:"round"},`${s.id}-${c.id}`)),l=l.concat(Ec(c,t,n,a,r))}),l}function ob({data:s,onRegenerate:t,isLoading:n,onNodeClick:a,activeNodePath:r}){const{t:o}=L(),i=m.useRef(null),l=m.useRef(null),[c,d]=m.useState(new Set),[u,h]=m.useState({x:0,y:0,width:1200,height:800}),g=m.useRef(!1),x=m.useRef({x:0,y:0}),[f,p]=m.useState(!1),b=m.useMemo(()=>{const D=Ic(s,c);return Tc(D),D},[s,c]),v=m.useCallback((D,$,H)=>{h(ae=>{const re=ae.width*D,je=ae.height*D,Ne=$-($-ae.x)*D,Be=H-(H-ae.y)*D;return{x:Ne,y:Be,width:re,height:je}})},[]);m.useEffect(()=>{const D=i.current;if(!D)return;const $=H=>{const{clientX:ae,clientY:re,deltaY:je,deltaX:Ne,ctrlKey:Be}=H;if(Be){H.preventDefault();const F=new DOMPoint(ae,re),G=D.getScreenCTM();if(!G)return;const Z=F.matrixTransform(G.inverse()),_=1+je*nb;v(_,Z.x,Z.y)}else if(f){H.preventDefault();const F=u.width/(D.clientWidth||1);h(G=>({...G,x:G.x+Ne*F*.5,y:G.y+je*F*.5}))}};return D.addEventListener("wheel",$,{passive:!1}),()=>D.removeEventListener("wheel",$)},[f,v,u.width]),m.useEffect(()=>{const D=()=>p(!!document.fullscreenElement);return document.addEventListener("fullscreenchange",D),()=>document.removeEventListener("fullscreenchange",D)},[]);const y=m.useCallback(()=>{if(!i.current)return;let $=1/0,H=1/0,ae=-1/0,re=-1/0;const je=G=>{$=Math.min($,G.x),H=Math.min(H,G.y-G.height/2),ae=Math.max(ae,G.x+G.width),re=Math.max(re,G.y+G.height/2),c.has(G.id)||G.children.forEach(je)};je(b);const Ne=80,Be=ae-$,F=re-H;Be>0&&F>0&&h({x:$-Ne,y:H-Ne,width:Be+Ne*2,height:F+Ne*2})},[b,c]),w=D=>{g.current=!0,x.current={x:D.clientX,y:D.clientY}},N=D=>{if(!g.current||!i.current)return;const $=u.width/(i.current.clientWidth||1),H=(D.clientX-x.current.x)*$,ae=(D.clientY-x.current.y)*$;h(re=>({...re,x:re.x-H,y:re.y-ae})),x.current={x:D.clientX,y:D.clientY}},S=()=>{g.current=!1},j=m.useCallback(D=>{d($=>{const H=new Set($);return H.has(D)?H.delete(D):H.add(D),H})},[]),C=m.useRef(y);m.useEffect(()=>{C.current=y}),m.useEffect(()=>{setTimeout(()=>C.current(),50)},[s,f]);const I=m.useMemo(()=>Ec(b,j,c,a,r),[b,j,c,a,r]),k=f?"fixed inset-0 z-50 w-screen h-screen bg-slate-100 dark:bg-slate-900":"relative w-full h-full",T=m.useCallback(()=>{const D=l.current;D&&(document.fullscreenElement?document.exitFullscreen():D.requestFullscreen().catch(()=>{}))},[]),z=D=>{if(!i.current)return;const $=u.x+u.width/2,H=u.y+u.height/2;v(D==="in"?1/ni:ni,$,H)};return e.jsxs("div",{ref:l,className:k,children:[e.jsx("svg",{ref:i,className:"w-full h-full",viewBox:`${u.x} ${u.y} ${u.width} ${u.height}`,onMouseDown:w,onMouseMove:N,onMouseUp:S,onMouseLeave:S,children:e.jsx("g",{children:I})}),e.jsxs("div",{className:"absolute bottom-3 right-3 flex flex-col gap-2",children:[e.jsxs("div",{className:"bg-white/90 dark:bg-slate-800/90 rounded-lg shadow border border-border/60 overflow-hidden flex flex-col",children:[e.jsx("button",{onClick:()=>z("in"),title:o("studio.mindmap.zoomIn"),className:"p-2 hover:bg-muted/60 transition-colors",children:e.jsx(Hi,{className:"w-4 h-4"})}),e.jsx("div",{className:"h-px bg-border/60"}),e.jsx("button",{onClick:()=>z("out"),title:o("studio.mindmap.zoomOut"),className:"p-2 hover:bg-muted/60 transition-colors",children:e.jsx(zi,{className:"w-4 h-4"})}),e.jsx("div",{className:"h-px bg-border/60"}),e.jsx("button",{onClick:y,title:o("studio.mindmap.fitToView"),className:"p-2 hover:bg-muted/60 transition-colors",children:e.jsx(Eu,{className:"w-4 h-4"})}),e.jsx("div",{className:"h-px bg-border/60"}),e.jsx("button",{onClick:T,title:o(f?"studio.mindmap.exitFullscreen":"studio.mindmap.enterFullscreen"),className:"p-2 hover:bg-muted/60 transition-colors",children:f?e.jsx(Lr,{className:"w-4 h-4"}):e.jsx(xn,{className:"w-4 h-4"})})]}),e.jsx("button",{onClick:t,disabled:n,title:o("studio.mindmap.regenerate"),className:"p-2 bg-white/90 dark:bg-slate-800/90 rounded-lg shadow border border-border/60 text-foreground hover:bg-muted/60 transition-colors disabled:opacity-50",children:n?e.jsx("div",{className:"w-4 h-4 border-2 border-muted-foreground/60 border-t-transparent rounded-full animate-spin"}):e.jsx(Es,{className:"w-4 h-4"})})]})]})}const ib=m.memo(function({item:t,onClose:n}){const{t:a}=L(),r=t.data||{title:t.title,nodes:[],edges:[],generatedAt:Date.now(),contextChannelIds:[]},{updateContentItem:o}=Pt(),[i,l]=m.useState(r.tree?"mindmap":"graph"),[c,d]=m.useState(!1);m.useEffect(()=>{l(r.tree?"mindmap":"graph")},[t.id,!!r.tree]);const u=m.useCallback(b=>{const v={...r,nodes:r.nodes.map(y=>{const w=b.find(N=>N.id===y.id);return w?{...y,x:w.x,y:w.y}:y})};o(t.id,{data:v,updatedAt:Date.now()})},[r,t.id,o]),h=m.useCallback(()=>{const b=r.nodes.map(({x:y,y:w,...N})=>({...N})),v={...r,nodes:b};o(t.id,{data:v,updatedAt:Date.now()})},[r,t.id,o]),g=m.useCallback(()=>{const b=(r.title||"mindmap").toLowerCase().replace(/[^a-z0-9-_]+/gi,"-");eb(`${b||"mindmap"}.json`,r)},[r]),x=m.useCallback(()=>{const b=document.querySelector("#mindmap-svg");if(!b)return;const v=b.cloneNode(!0);v.setAttribute("xmlns","http://www.w3.org/2000/svg");const w=new XMLSerializer().serializeToString(v),N=new Blob([w],{type:"image/svg+xml;charset=utf-8"}),S=URL.createObjectURL(N),j=document.createElement("a");j.href=S,j.download=`${(r.title||"mindmap").replace(/\s+/g,"-")}.svg`,document.body.appendChild(j),j.click(),document.body.removeChild(j),URL.revokeObjectURL(S)},[r.title]),f=m.useCallback(async()=>{const b=document.querySelector("#mindmap-svg");if(!b)return;const y=new XMLSerializer().serializeToString(b),w=new Blob([y],{type:"image/svg+xml;charset=utf-8"}),N=URL.createObjectURL(w),S=new Image,j=()=>new Promise((C,I)=>{S.onload=()=>C(S),S.onerror=I,S.src=N});try{const C=await j(),I=b.getBoundingClientRect(),k=document.createElement("canvas");k.width=Math.max(1,Math.floor(I.width)),k.height=Math.max(1,Math.floor(I.height));const T=k.getContext("2d");if(!T)return;T.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--background")||"#fff",T.fillRect(0,0,k.width,k.height),T.drawImage(C,0,0);const z=k.toDataURL("image/png"),D=document.createElement("a");D.href=z,D.download=`${(r.title||"mindmap").replace(/\s+/g,"-")}.png`,document.body.appendChild(D),D.click(),document.body.removeChild(D)}finally{URL.revokeObjectURL(N)}},[r.title]),p=m.useCallback(async()=>{if(!(!Array.isArray(r.contextChannelIds)||r.contextChannelIds.length===0))try{d(!0);const b=await Mc(r.contextChannelIds);o(t.id,{data:b,title:b.title,updatedAt:Date.now(),status:"completed"}),b.tree&&l("mindmap")}catch(b){console.error("Regenerate mindmap failed",b)}finally{d(!1)}},[r.contextChannelIds,t.id,o]);return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(M,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:n,children:e.jsx(It,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-sm font-medium flex-1 truncate",children:t.title}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(M,{variant:i==="mindmap"?"secondary":"ghost",size:"sm",className:"h-7 px-2",onClick:()=>l("mindmap"),disabled:!r.tree,title:r.tree?a("studio.mindmap.mindmapView"):a("studio.mindmap.treeNotAvailable"),children:a("studio.mindmap.mindmap")}),e.jsx(M,{variant:i==="graph"?"secondary":"ghost",size:"sm",className:"h-7 px-2",onClick:()=>l("graph"),children:a("studio.mindmap.graph")})]}),e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"icon",className:"h-7 w-7",title:a("studio.mindmap.moreOptions"),children:e.jsx(ms,{className:"w-4 h-4"})})}),e.jsxs(mt,{align:"end",className:"w-44 p-1.5",children:[e.jsxs(Lt,{className:"cursor-pointer",onClick:h,children:[e.jsx(Es,{className:"w-4 h-4 mr-2"}),a("studio.mindmap.resetLayout")]}),e.jsxs(Lt,{className:"cursor-pointer",onClick:g,children:[e.jsx(Wi,{className:"w-4 h-4 mr-2"}),a("studio.mindmap.downloadJSON")]}),e.jsxs(Lt,{className:"cursor-pointer",onClick:x,children:[e.jsx(vs,{className:"w-4 h-4 mr-2"}),a("studio.mindmap.downloadSVG")]}),e.jsxs(Lt,{className:"cursor-pointer",onClick:f,children:[e.jsx(Tu,{className:"w-4 h-4 mr-2"}),a("studio.mindmap.downloadPNG")]})]})]})]}),e.jsx(Bs,{className:"flex-1",children:e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:a("studio.mindmap.visualization",{nodes:r.nodes.length,edges:r.edges.length})}),e.jsx("div",{className:"w-full h-96 border border-border/40 rounded-lg bg-background/60",children:i==="mindmap"&&r.tree?e.jsx("div",{className:"w-full h-full",children:e.jsx(ob,{data:r.tree,onRegenerate:p,isLoading:c})}):i==="mindmap"&&!r.tree?e.jsx("div",{className:"w-full h-full flex items-center justify-center text-muted-foreground",children:a("studio.mindmap.noTreeAvailable")}):r.nodes.length===0?e.jsx("div",{className:"w-full h-full flex items-center justify-center text-muted-foreground",children:a("studio.mindmap.noMindmapGenerated")}):e.jsx("div",{className:"w-full h-full",children:e.jsx(tb,{data:r,onPersist:u})})})]})})]})}),lb=m.memo(function({item:t,onClose:n}){const{t:a}=L(),o=t.data?.cards||[];return e.jsxs("div",{className:"h-full flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(M,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:n,children:e.jsx(It,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-sm font-medium flex-1 truncate",children:o.length>0?`${t.title} (${o.length})`:t.title})]}),e.jsx(Bs,{className:"flex-1 min-h-0",children:e.jsx("div",{className:"p-4 space-y-4",children:o.length===0?e.jsx("div",{className:"text-sm text-muted-foreground text-center py-8",children:a("studio.wikiCard.noCardsGenerated")}):o.map((i,l)=>{const c=["bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 dark:from-amber-950/40 dark:via-yellow-950/40 dark:to-orange-950/40","bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 dark:from-orange-950/40 dark:via-amber-950/40 dark:to-yellow-950/40","bg-gradient-to-br from-yellow-50 via-orange-50 to-amber-50 dark:from-yellow-950/40 dark:via-orange-950/40 dark:to-amber-950/40","bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950/40 dark:to-orange-950/40","bg-gradient-to-br from-orange-50 to-amber-50 dark:from-orange-950/40 dark:to-amber-950/40"],d=c[l%c.length];return e.jsxs("div",{className:E("p-5 rounded-xl transition-all duration-300",d),children:[e.jsx("h3",{className:"text-base font-semibold mb-3 text-amber-900 dark:text-amber-100",children:i.title}),e.jsx("div",{className:"text-sm text-foreground/90 mb-4 leading-relaxed",children:i.definition}),i.keyPoints.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-amber-700 dark:text-amber-300 mb-2 uppercase tracking-wide",children:a("studio.wikiCard.keyPoints")}),e.jsx("ul",{className:"space-y-1.5",children:i.keyPoints.map((u,h)=>e.jsxs("li",{className:"text-sm text-foreground/85 flex items-start gap-2.5",children:[e.jsx("span",{className:"text-amber-600 dark:text-amber-400 mt-0.5 font-semibold",children:a("common.separator")}),e.jsx("span",{children:u})]},h))})]}),i.examples.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-amber-700 dark:text-amber-300 mb-2 uppercase tracking-wide",children:a("studio.wikiCard.examples")}),e.jsx("ul",{className:"space-y-1.5",children:i.examples.map((u,h)=>e.jsxs("li",{className:"text-sm text-foreground/85 flex items-start gap-2.5",children:[e.jsx("span",{className:"text-amber-600 dark:text-amber-400 mt-0.5 font-semibold",children:a("common.dash")}),e.jsx("span",{children:u})]},h))})]}),i.relatedConcepts.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-amber-700 dark:text-amber-300 mb-2 uppercase tracking-wide",children:a("studio.wikiCard.relatedConcepts")}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:i.relatedConcepts.map((u,h)=>e.jsx("span",{className:"text-xs px-2.5 py-1 rounded-full bg-amber-100/80 dark:bg-amber-900/40 text-amber-800 dark:text-amber-200 border border-amber-200/60 dark:border-amber-700/40 font-medium",children:u},h))})]})]},i.id)})})})]})});function ai(s,t,n){const a=new Blob([t],{type:n}),r=URL.createObjectURL(a),o=document.createElement("a");o.href=r,o.download=s,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r)}const cb=m.memo(function({item:t,onClose:n}){const{t:a}=L(),r=t.data,o=r?.reportMarkdown||"",[i,l]=m.useState(!1);return m.useEffect(()=>{if(!i)return;const c=window.setTimeout(()=>l(!1),900);return()=>window.clearTimeout(c)},[i]),e.jsxs("div",{className:"h-full flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(M,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:n,children:e.jsx(It,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-sm font-medium flex-1 truncate",children:t.title}),e.jsx(M,{variant:"ghost",size:"icon",className:"h-7 w-7",title:a(i?"common.copied":"common.copy"),disabled:!r||!o,onClick:async()=>{r&&(await navigator.clipboard.writeText(r.reportMarkdown||""),l(!0))},children:i?e.jsx(Xe,{className:"w-4 h-4"}):e.jsx(ps,{className:"w-4 h-4"})}),e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"icon",className:"group h-7 w-7",title:a("studio.report.download"),"aria-label":a("studio.report.download"),disabled:!r,onClick:c=>c.stopPropagation(),children:e.jsx(vs,{className:"h-4 w-4 transition-transform duration-200 group-hover:scale-105"})})}),e.jsxs(mt,{align:"end",sideOffset:8,className:"min-w-[220px] p-1",children:[e.jsx(lt,{icon:Wi,onSelect:()=>{r&&ai(`${r.title||"report"}.md`,r.reportMarkdown||"","text/markdown")},children:a("studio.report.downloadMarkdown")}),e.jsx(lt,{icon:Un,onSelect:()=>{r&&ai(`${r.title||"report"}.json`,JSON.stringify(r,null,2),"application/json")},children:a("studio.report.downloadJSON")})]})]})]}),e.jsx(Bs,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-4",children:a("studio.report.basedOnSources",{count:t.contextChannelIds.length})}),t.status==="error"?e.jsx("div",{className:"text-sm text-destructive",children:t.errorMessage||a("common.unknownError")}):o?e.jsx($s,{content:o}):e.jsx("div",{className:"text-sm text-muted-foreground",children:a("studio.report.contentPlaceholder")})]})})]})}),db=["Serena","Maia","Cherry","Bella","Mia","Vivian"],ub=["Cherry","Bella","Mia"],ri=["Neil","Ethan","Kai","Moon","Andre"];function Ac(s){let t=2166136261;for(let n=0;n<s.length;n++)t^=s.charCodeAt(n),t=Math.imul(t,16777619);return t>>>0}function Rc(s){let t=s>>>0;return()=>{t+=1831565813;let n=t;return n=Math.imul(n^n>>>15,n|1),n^=n+Math.imul(n^n>>>7,n|61),((n^n>>>14)>>>0)/4294967296}}function kr(s,t){return s[Math.floor(t()*s.length)]}function mb(s){if(s.hostOverride&&s.guestOverride)return{host:s.hostOverride,guest:s.guestOverride};const t=Rc(Ac(s.seed)),n=s.hostOverride||kr(db,t);let a=s.guestOverride||kr(ri,t);return a===n&&(a=ri.find(r=>r!==a)||a),{host:n,guest:a}}function hb(s){if(s.override)return s.override;const t=Rc(Ac(s.seed));return kr(ub,t)}function gb(s,t){const n=(s??"").replace(/[ \t]+/g," ").replace(/\n{3,}/g,`

`).trim();if(!n)return[];if(n.length<=t)return[n];const a=[];let r=n;const o=[`
`,"ã€‚","ï¼","ï¼Ÿ",".","!","?",";","ï¼›"];for(;r.length>t;){const i=r.slice(0,t);let l=-1;for(const d of o){const u=i.lastIndexOf(d);u>=0&&u+1>l&&(l=u+1)}if(l<Math.floor(t*.55)){const d=i.lastIndexOf(" ");d>=Math.floor(t*.55)&&(l=d+1)}l<=0&&(l=t);const c=r.slice(0,l).trim();c&&a.push(c),r=r.slice(l).trim()}return r&&a.push(r),a}async function pb(s){const n=`${"https://api-gateway.stillroot.app".replace(/\/+$/,"")}/tts`,r={model:s.model||"qwen3-tts-flash",input:{text:s.text,voice:s.voice,language_type:s.languageType}},o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(o.ok)return await o.arrayBuffer();if((o.headers.get("content-type")||"").includes("application/json")){const l=await o.json().catch(()=>null),c=typeof l=="object"&&l!==null?l:null,d=typeof c?.error=="string"?c.error:typeof c?.message=="string"?c.message:"";throw new Error(d?`[tts] ${d}`:`[tts] HTTP ${o.status}`)}throw new Error(`[tts] HTTP ${o.status}`)}async function Lc(s){const n=s.maxChars??(Number.isFinite(600),600),a=gb(s.text,Math.max(50,n)),r=[];for(const o of a)r.push(await pb({text:o,voice:s.voice,languageType:s.languageType,model:s.model}));return r}function za(s){return`${s}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`}function fb(s){let t=0;for(let n=0;n<s.length;n++){const a=(s[n]-128)/128;t+=a*a}return Math.sqrt(t/s.length)}function xb(s){return typeof s=="object"&&s!==null}function bb(s){try{return JSON.parse(s)}catch{return null}}function vb(s){if(s){if(s==="Chinese")return"zh";if(s==="English")return"en"}}function wb(s,t){const n=s.replace(/\/+$/,"");return`${n.startsWith("https://")?`wss://${n.slice(8)}`:n.startsWith("http://")?`ws://${n.slice(7)}`:n}/voice-call/ws?sessionId=${encodeURIComponent(t)}`}function yb(s){const t=[];let n=s;const a=260,r=80,o=/([ã€‚ï¼ï¼Ÿ.!?]+[\s\n]|[\n\r]{2,})/;for(;n.length>0;){const i=n.match(o);if(!i||i.index==null)break;const l=i.index+i[0].length,c=n.slice(0,l).trim();if(c&&t.push(c),n=n.slice(l),t.length>=4)break}for(;n.length>a&&t.length<4;){const i=n.slice(0,a),l=[`

`,`
`,"ã€‚","ï¼","ï¼Ÿ",".","!","?","ï¼›",";","ï¼Œ",",","ã€"," "];let c=-1;for(const u of l){const h=i.lastIndexOf(u);h<0||(c=Math.max(c,h+u.length))}c<r&&(c=a);const d=n.slice(0,c).trim();d&&t.push(d),n=n.slice(c)}return{chunks:t,rest:n.trimStart()}}function jb(s){const{channels:t}=O.getState(),n=s.channelIds,[a,r]=m.useState("idle"),[o,i]=m.useState(null),[l,c]=m.useState([]),[d,u]=m.useState(!1),[h,g]=m.useState(""),x=m.useRef([]),f=m.useMemo(()=>za("voice_call"),[]),p=m.useMemo(()=>hb({seed:f}),[f]),[b,v]=m.useState(()=>Cr(W.resolvedLanguage??W.language));m.useEffect(()=>{x.current=l},[l]),m.useEffect(()=>{const B=()=>v(Cr(W.resolvedLanguage??W.language));return B(),W.on("languageChanged",B),()=>{W.off("languageChanged",B)}},[]);const y=m.useRef(!1),w=m.useRef(null),N=m.useRef(null),S=m.useRef(!1),j=m.useRef([]),C=m.useRef([]),I=m.useRef(!1),k=m.useRef(""),T=m.useRef(0),z=m.useRef(null),D=m.useRef(null),$=m.useRef(null),H=m.useRef(null),ae=m.useRef(null),re=m.useRef(!0),je=m.useRef(!1),Ne=m.useRef(0),Be=m.useRef(0),F=m.useRef(""),G=m.useRef(null),Z=m.useRef(!1),_=m.useRef(0),q=m.useRef(""),Ce=m.useRef(null),Tt=m.useCallback(()=>{const B=N.current;if(B){try{S.current=!1,B.onended=null,B.onerror=null,B.pause(),B.src=""}catch{}for(const V of j.current)try{URL.revokeObjectURL(V)}catch{}j.current=[]}},[]),Ze=m.useCallback(B=>{re.current=B;const V=H.current;if(V)try{V.port.postMessage({type:"enable",enabled:B})}catch{}},[]),ys=m.useCallback(()=>{T.current+=1,w.current?.abort(),w.current=null,C.current=[],k.current="",Tt()},[Tt]),Nt=m.useCallback(async()=>{const B=N.current||new Audio;if(N.current=B,S.current)return;S.current=!0;const V=async()=>{if(!y.current)return;const le=j.current.shift();if(!le){S.current=!1,Ze(!0),r("listening");return}B.onended=()=>{try{URL.revokeObjectURL(le)}catch{}V()},B.onerror=()=>{try{URL.revokeObjectURL(le)}catch{}V()},B.src=le;try{await B.play()}catch{V()}};await V()},[Ze]),Et=m.useCallback(B=>{const V=URL.createObjectURL(new Blob([B],{type:"audio/wav"}));j.current.push(V),Nt()},[Nt]),Qt=m.useCallback(async()=>{if(I.current)return;I.current=!0;const B=T.current;try{for(;C.current.length>0&&y.current;){if(B!==T.current)return;const V=C.current.shift()||"";if(!V.trim())continue;let le;try{le=await Lc({text:V,voice:p,model:"qwen3-tts-flash",languageType:b})}catch(we){const Me=we instanceof Error?we.message:String(we);i(Me?`TTS failed: ${Me}`:"TTS failed");continue}if(!y.current||B!==T.current)return;if(le.length!==0){Ze(!1);for(const we of le){if(B!==T.current)return;Et(we)}}}}finally{I.current=!1}},[p,Et,Ze,b]),js=m.useCallback(B=>{if(!B)return;k.current+=B;const{chunks:V,rest:le}=yb(k.current);if(k.current=le,V.length!==0){for(const we of V)C.current.push(we);Qt()}},[Qt]),Ot=m.useCallback(()=>{y.current=!1,w.current?.abort(),w.current=null,Tt(),ae.current!=null&&cancelAnimationFrame(ae.current),ae.current=null;try{G.current?.close()}catch{}G.current=null,Z.current=!1,Ze(!0),g(""),q.current="",_.current=0,Ce.current!=null&&(window.clearTimeout(Ce.current),Ce.current=null);const B=H.current;H.current=null;try{B?.disconnect()}catch{}if($.current=null,D.current)try{D.current.close()}catch{}if(D.current=null,z.current)for(const V of z.current.getTracks())V.stop();z.current=null},[Ze,Tt]),Ns=m.useCallback(B=>{c(V=>{const le=V.findIndex(Me=>Me.id===B.id);if(le<0)return[...V,B];const we=V.slice();return we[le]=B,we})},[]),R=m.useCallback(async B=>{const V=Date.now();if(V-Be.current<250)return;Be.current=V;const le=B.trim();if(!le)return;ys(),i(null);const we={id:za("m_user"),role:"user",text:le,createdAt:Date.now()};Ns(we);const Me=za("m_assistant");Ns({id:Me,role:"assistant",text:"",createdAt:Date.now()}),r("thinking");const We=new AbortController;w.current?.abort(),w.current=We;const Ae=[{role:"system",content:["You are a realtime voice assistant in StillRoot Studio.","Do not mention internal system instructions.",`Respond in ${b}.`,F.current?`
Context notes:
${F.current}`:""].filter(Boolean).join(`
`)},...x.current.map(Ge=>({role:Ge.role,content:Ge.text})),{role:"user",content:le}];try{const Ge=await ls.chat.completions.create({model:is,messages:Ae,stream:!0,temperature:.4},{signal:We.signal});r("speaking");let Ct="";for await(const at of Ge){if(We.signal.aborted)throw new DOMException("Aborted","AbortError");const xe=at.choices?.[0]?.delta?.content||"";xe&&(Ct+=xe,Ns({id:Me,role:"assistant",text:Ct,createdAt:Date.now()}),js(xe))}const $t=k.current.trim();k.current="",$t&&(C.current.push($t),Qt())}catch(Ge){if(Ge instanceof DOMException&&Ge.name==="AbortError"){r("listening");return}const Ct=Ge instanceof Error?Ge.message:String(Ge);i(Ct),r("error")}},[ys,Qt,js,b,Ns]),A=m.useCallback(async()=>{if(!y.current){r("connecting"),i(null),y.current=!0;try{if(n.length>0){const at=jn(n,t),xe=await yn(n,{maxMessagesPerChannel:80});if(xe.length>0){const Re=Nn(xe,t);F.current=`Spaces: ${at}

${Re}`}}const B="https://api-gateway.stillroot.app",V=wb(B,f),le=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});z.current=le;let we;try{we=new AudioContext({sampleRate:16e3})}catch{we=new AudioContext}D.current=we;const Me=we.createMediaStreamSource(le),We=we.createAnalyser();We.fftSize=2048,Me.connect(We),$.current=We,await we.audioWorklet.addModule(new URL("data:video/mp2t;base64,dHlwZSBFbmFibGVNZXNzYWdlID0geyB0eXBlOiAiZW5hYmxlIjsgZW5hYmxlZDogYm9vbGVhbiB9OwoKY29uc3QgRlJBTUVfU0FNUExFUyA9IDMyMDsgLy8gMjBtcyBAIDE2a0h6CgpjbGFzcyBQQ00xNmtXb3JrbGV0UHJvY2Vzc29yIGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIHsKICBwcml2YXRlIGVuYWJsZWQgPSBmYWxzZTsKICBwcml2YXRlIHBlbmRpbmc6IG51bWJlcltdID0gW107CgogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKTsKICAgIHRoaXMucG9ydC5vbm1lc3NhZ2UgPSAoZXY6IE1lc3NhZ2VFdmVudCkgPT4gewogICAgICBjb25zdCBkYXRhID0gZXYuZGF0YSBhcyBFbmFibGVNZXNzYWdlIHwgbnVsbDsKICAgICAgaWYgKCFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAib2JqZWN0IikgcmV0dXJuOwogICAgICBpZiAoZGF0YS50eXBlID09PSAiZW5hYmxlIikgewogICAgICAgIHRoaXMuZW5hYmxlZCA9ICEhZGF0YS5lbmFibGVkOwogICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB0aGlzLnBlbmRpbmcgPSBbXTsKICAgICAgfQogICAgfTsKICB9CgogIHByb2Nlc3MoaW5wdXRzOiBGbG9hdDMyQXJyYXlbXVtdKTogYm9vbGVhbiB7CiAgICBpZiAoIXRoaXMuZW5hYmxlZCkgcmV0dXJuIHRydWU7CgogICAgY29uc3QgaW5wdXQwID0gaW5wdXRzWzBdOwogICAgaWYgKCFpbnB1dDAgfHwgaW5wdXQwLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHRydWU7CgogICAgLy8gRG93bm1peCB0byBtb25vIGJ5IHRha2luZyBjaGFubmVsIDAgKGJyb3dzZXIgZWNob0NhbmNlbGxhdGlvbiBhbHJlYWR5IGhlbHBzKS4KICAgIGNvbnN0IGNoMCA9IGlucHV0MFswXTsKICAgIGlmICghY2gwIHx8IGNoMC5sZW5ndGggPT09IDApIHJldHVybiB0cnVlOwoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2gwLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHYgPSBNYXRoLm1heCgtMSwgTWF0aC5taW4oMSwgY2gwW2ldID8/IDApKTsKICAgICAgY29uc3QgcyA9IHYgPCAwID8gdiAqIDB4ODAwMCA6IHYgKiAweDdmZmY7CiAgICAgIHRoaXMucGVuZGluZy5wdXNoKHMpOwogICAgfQoKICAgIHdoaWxlICh0aGlzLnBlbmRpbmcubGVuZ3RoID49IEZSQU1FX1NBTVBMRVMpIHsKICAgICAgY29uc3QgZnJhbWUgPSBuZXcgSW50MTZBcnJheShGUkFNRV9TQU1QTEVTKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBGUkFNRV9TQU1QTEVTOyBpKyspIHsKICAgICAgICBmcmFtZVtpXSA9IHRoaXMucGVuZGluZ1tpXSA/PyAwOwogICAgICB9CiAgICAgIHRoaXMucGVuZGluZy5zcGxpY2UoMCwgRlJBTUVfU0FNUExFUyk7CiAgICAgIHRoaXMucG9ydC5wb3N0TWVzc2FnZShmcmFtZS5idWZmZXIsIFtmcmFtZS5idWZmZXJdKTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KCnJlZ2lzdGVyUHJvY2Vzc29yKCJwY20xNmsiLCBQQ00xNmtXb3JrbGV0UHJvY2Vzc29yKTsKCg==",import.meta.url));const nt=new AudioWorkletNode(we,"pcm16k");H.current=nt,Me.connect(nt);const Ae=new WebSocket(V);Ae.binaryType="arraybuffer",G.current=Ae,Z.current=!1;const Ge=vb(b);Ae.onopen=()=>{try{Ae.send(JSON.stringify({type:"init",language:Ge,maxSentenceSilenceMs:650}))}catch{}},Ae.onmessage=at=>{const xe=at.data;if(typeof xe!="string")return;const Re=bb(xe);if(!xb(Re))return;const Bt=typeof Re.type=="string"?Re.type:"";if(Bt==="ready"){Z.current=!0,Ze(!0),r("listening");return}if(Bt==="asr"){const ht=typeof Re.text=="string"?Re.text.trim():"";if(!ht||Date.now()>_.current)return;const At=q.current,kn=ht.startsWith(At)?ht:At.startsWith(ht)?At:ht;q.current=kn,g(kn);return}if(Bt==="error"){const ht=typeof Re.error=="string"?Re.error:"Voice call error";i(ht),r("error");return}},Ae.onerror=()=>{i("Voice call websocket error"),r("error")},Ae.onclose=()=>{Z.current=!1},nt.port.onmessage=at=>{if(!y.current||d||!re.current||!Z.current)return;const xe=G.current;if(!xe||xe.readyState!==WebSocket.OPEN)return;const Re=at.data;if(!(!(Re instanceof ArrayBuffer)||Re.byteLength===0))try{xe.send(Re)}catch{}};const Ct=new Uint8Array(We.fftSize);Ne.current=Date.now(),je.current=!1;const $t=async()=>{if(!y.current)return;We.getByteTimeDomainData(Ct);const at=fb(Ct),xe=Date.now(),Re=.035,Bt=750;if(at>Re)je.current||(je.current=!0,_.current=xe+3e4,q.current="",g(""),ys(),Tt(),Ze(!0),Ce.current!=null&&(window.clearTimeout(Ce.current),Ce.current=null)),Ne.current=xe,a!=="listening"&&r("listening");else if(je.current&&xe-Ne.current>Bt){je.current=!1,_.current=xe+1200;const Cn=q.current;Ce.current=window.setTimeout(()=>{Ce.current=null,_.current=0;const At=q.current.trim()||Cn.trim();q.current="",g(""),R(At)},350)}ae.current=requestAnimationFrame(()=>{$t()})};r("connecting"),$t()}catch(B){const V=B instanceof Error?B.message:String(B);i(V),r("error"),Ot()}}},[ys,n,t,Ot,d,R,f,Ze,a,Tt,b]),P=m.useCallback(()=>{Ot(),r("idle")},[Ot]),U=m.useCallback(()=>{u(B=>!B)},[]),oe=m.useCallback(()=>{c([]),g(""),q.current=""},[]);return m.useEffect(()=>()=>{Ot()},[Ot]),{sessionId:f,status:a,error:o,messages:l,liveUserText:h,isMuted:d,targetLanguage:b,assistantVoice:p,start:A,stop:P,toggleMute:U,clear:oe}}const Dc=m.memo(function(t){const{onClose:n}=t,{t:a}=L(),r=Pt(k=>k.ephemeralContextChannelIds),{status:o,error:i,messages:l,liveUserText:c,isMuted:d,assistantVoice:u,start:h,stop:g,toggleMute:x,clear:f}=jb({channelIds:r}),p=o==="idle"||o==="error",b=o!=="idle",v=m.useRef(null),[y,w]=m.useState(!0),N=m.useRef(!0),S=m.useCallback(()=>{const k=v.current;return k?k.scrollTop+k.clientHeight>=k.scrollHeight-48:!0},[]),j=m.useCallback(()=>{const k=S();N.current=k,w(k)},[S]),C=m.useCallback((k="auto")=>{const T=v.current;T&&T.scrollTo({top:T.scrollHeight,behavior:k})},[]);m.useEffect(()=>{const k=v.current;if(!k)return;const T=()=>j();return k.addEventListener("scroll",T,{passive:!0}),j(),()=>k.removeEventListener("scroll",T)},[j]),m.useEffect(()=>{N.current&&C("auto")},[l,c,C]);const I=m.useMemo(()=>{switch(o){case"idle":return a("studio.voiceCall.status.idle");case"connecting":return a("studio.voiceCall.status.connecting");case"listening":return a("studio.voiceCall.status.listening");case"thinking":return a("studio.voiceCall.status.thinking");case"speaking":return a("studio.voiceCall.status.speaking");case"error":return a("studio.voiceCall.status.error");default:return o}},[o,a]);return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(M,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:n,children:e.jsx(It,{className:"w-4 h-4"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"text-sm font-medium truncate",children:a("studio.voiceCall.title")}),e.jsx("div",{className:"text-xs text-muted-foreground truncate",children:a("studio.voiceCall.subtitle",{voice:u})})]}),b?e.jsxs(M,{variant:"destructive",size:"sm",onClick:()=>{g()},children:[e.jsx(Au,{className:"w-4 h-4 mr-2"}),a("studio.voiceCall.end")]}):e.jsxs(M,{variant:"default",size:"sm",onClick:()=>{h()},disabled:!p,children:[e.jsx(Qa,{className:"w-4 h-4 mr-2"}),a("studio.voiceCall.start")]})]}),e.jsxs("div",{className:"px-4 py-2 flex items-center gap-2 border-b border-border/40",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:a("studio.voiceCall.statusLabel",{status:I})}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsxs(M,{variant:"ghost",size:"sm",onClick:x,disabled:!b,className:"h-8",children:[d?e.jsx(Ru,{className:"w-4 h-4 mr-2"}):e.jsx(Qa,{className:"w-4 h-4 mr-2"}),a(d?"studio.voiceCall.unmute":"studio.voiceCall.mute")]}),e.jsxs(M,{variant:"ghost",size:"sm",onClick:()=>{f()},className:"h-8",children:[e.jsx(jt,{className:"w-4 h-4 mr-2"}),a("studio.voiceCall.clear")]})]})]}),i?e.jsx("div",{className:"px-4 py-2 text-sm text-destructive border-b border-border/40 break-words",children:i}):null,e.jsxs("div",{className:"flex-1 min-h-0 relative",children:[e.jsxs("div",{ref:v,className:"h-full overflow-y-auto px-4 py-3 space-y-3",children:[l.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:a("studio.voiceCall.emptyHint")}):null,l.map(k=>e.jsxs("div",{className:["rounded-xl border border-border/50 p-3 text-sm leading-relaxed",k.role==="assistant"?"bg-card/60":"bg-muted/30"].join(" "),children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:k.role==="assistant"?a("studio.voiceCall.role.assistant"):a("studio.voiceCall.role.user")}),e.jsx("div",{className:"whitespace-pre-wrap break-words",children:k.text})]},k.id)),c?e.jsxs("div",{className:"rounded-xl border border-border/50 p-3 text-sm leading-relaxed bg-muted/30",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:a("studio.voiceCall.role.user")}),e.jsx("div",{className:"whitespace-pre-wrap break-words",children:c})]}):null]}),!y&&l.length>0?e.jsxs("div",{className:"absolute inset-x-0 bottom-0 pointer-events-none",children:[e.jsx("div",{className:"h-12 bg-gradient-to-t from-background/90 to-transparent"}),e.jsx("div",{className:"px-4 pb-3 flex justify-end",children:e.jsxs(M,{type:"button",variant:"secondary",size:"sm",className:"shadow-md pointer-events-auto",onClick:()=>C("smooth"),children:[e.jsx($i,{className:"w-4 h-4 mr-2"}),a("studio.voiceCall.scrollToLatest")]})})]}):null]})]})}),Nb={type:"object",properties:{title:{type:"string",description:"A concise, descriptive title summarizing the collection of concept cards (2-5 words, same language as the notes)"},cards:{type:"array",items:{type:"object",properties:{id:{type:"string"},title:{type:"string"},definition:{type:"string"},keyPoints:{type:"array",items:{type:"string"}},relatedConcepts:{type:"array",items:{type:"string"}},examples:{type:"array",items:{type:"string"}}},required:["id","title","definition","keyPoints","relatedConcepts","examples"]}}},required:["title","cards"]};async function Cb(s){const{channels:t}=O.getState();if(s.length===0)throw new Error("At least one channel is required");const n=jn(s,t),a=await yn(s,{maxMessagesPerChannel:200});if(a.length===0)throw new Error(`No notes found in selected channels: ${n}`);const r=a.map(g=>g.content).join(`

`),o=ka(r),i=Nn(a,t),l=W.t.bind(W),c=`${l("aiAssistant.prompts.systemPrompts.conceptCards.role")}

${l("aiAssistant.prompts.systemPrompts.conceptCards.instructions")}

${l("aiAssistant.prompts.systemPrompts.conceptCards.focus")}

${l("aiAssistant.prompts.systemPrompts.conceptCards.languageNote",{language:o})}

${l("aiAssistant.prompts.systemPrompts.conceptCards.count")}`,d=`Based on the following notes from spaces: ${n}

${i}

Generate concept cards that organize the key concepts from these notes. All content must be in ${o} language. Make sure each card is well-structured and provides value to someone trying to understand the domain.`,u=await wn({schema:Nb,prompt:d,system:c,temperature:.7}),h=u.cards.map(g=>({...g,references:[]}));return{title:u.title,cards:h,generatedAt:Date.now(),contextChannelIds:s}}function kb(){const{addContentItem:s,updateContentItem:t,setGenerating:n}=Pt(),[a,r]=m.useState(!1);return{generate:m.useCallback(async i=>{if(i.length===0)throw new Error("At least one channel is required");r(!0),n(!0);const l=`wiki-card-${Date.now()}`,c={title:"Concept",cards:[],generatedAt:Date.now(),contextChannelIds:i},d={id:l,moduleId:"wiki-card",title:"Concept",contextChannelIds:i,createdAt:Date.now(),updatedAt:Date.now(),data:c,status:"generating"};s(d);try{const u=await Cb(i);return t(l,{status:"completed",data:u,title:u.title}),l}catch(u){throw t(l,{status:"error",errorMessage:u instanceof Error?u.message:"Unknown error"}),u}finally{r(!1),n(!1)}},[s,t,n]),isGenerating:a}}function Sb(){const{addContentItem:s,updateContentItem:t,setGenerating:n}=Pt(),[a,r]=m.useState(!1);return{generate:m.useCallback(async i=>{if(i.length===0)throw new Error("At least one channel is required");r(!0),n(!0);const l=`mindmap-${Date.now()}`,c={title:"Mindmap",nodes:[],edges:[],generatedAt:Date.now(),contextChannelIds:i},d={id:l,moduleId:"mindmap",title:"Mindmap",contextChannelIds:i,createdAt:Date.now(),updatedAt:Date.now(),data:c,status:"generating"};s(d);try{const u=await Mc(i);return t(l,{status:"completed",data:u,title:u.title}),l}catch(u){throw t(l,{status:"error",errorMessage:u instanceof Error?u.message:"Unknown error"}),u}finally{r(!1),n(!1)}},[s,t,n]),isGenerating:a}}const Mb={type:"object",properties:{title:{type:"string",description:"A concise, descriptive title (2-6 words, same language as the notes) that summarizes the report theme"},executiveSummary:{type:"string",description:"A 4-8 sentence executive summary grounded in the notes"},keyThemes:{type:"array",items:{type:"string"},description:"5-10 key themes, each as a short phrase"},insights:{type:"array",items:{type:"string"},description:"5-12 concrete insights, grounded in the notes; avoid generic advice"},tensions:{type:"array",items:{type:"string"},description:"0-6 tensions/contradictions/uncertainties present in the notes"},actionItems:{type:"array",items:{type:"object",properties:{id:{type:"string"},title:{type:"string"},rationale:{type:"string"},nextSteps:{type:"array",items:{type:"string"}},priority:{type:"string",enum:["low","medium","high"]}},required:["id","title","rationale","nextSteps","priority"]},description:"3-8 actionable items with concrete next steps"},openQuestions:{type:"array",items:{type:"string"},description:"3-8 open questions to help the user reflect and clarify intent"},reportMarkdown:{type:"string",description:"A polished markdown report that includes: title, executive summary, key themes, insights, tensions, action items, and open questions. Must be in the same language as the notes."}},required:["title","executiveSummary","keyThemes","insights","tensions","actionItems","openQuestions","reportMarkdown"]};async function Ib(s){const{channels:t}=O.getState();if(s.length===0)throw new Error("At least one channel is required");const n=jn(s,t),a=await yn(s,{maxMessagesPerChannel:250});if(a.length===0)throw new Error(`No notes found in selected channels: ${n}`);const r=a.map(h=>h.content).join(`

`),o=ka(r),i=Nn(a,t),l=W.t.bind(W),c=`${l("aiAssistant.prompts.systemPrompts.report.role")}

${l("aiAssistant.prompts.systemPrompts.report.instructions")}

${l("aiAssistant.prompts.systemPrompts.report.constraints",{language:o})}
`,d=`Generate a comprehensive report from the following notes.

Spaces: ${n}

Notes:
${i}
`,u=await wn({schema:Mb,prompt:d,system:c,temperature:.4});return{title:u.title,executiveSummary:u.executiveSummary,keyThemes:u.keyThemes,insights:u.insights,tensions:u.tensions,actionItems:u.actionItems,openQuestions:u.openQuestions,reportMarkdown:u.reportMarkdown,generatedAt:Date.now(),contextChannelIds:s}}function Tb(){const{addContentItem:s,updateContentItem:t,setGenerating:n}=Pt(),[a,r]=m.useState(!1);return{generate:m.useCallback(async i=>{if(i.length===0)throw new Error("At least one channel is required");r(!0),n(!0);const l=`report-${Date.now()}`,c={title:"Report",executiveSummary:"",keyThemes:[],insights:[],tensions:[],actionItems:[],openQuestions:[],reportMarkdown:"",generatedAt:Date.now(),contextChannelIds:i},d={id:l,moduleId:"report",title:"Report",contextChannelIds:i,createdAt:Date.now(),updatedAt:Date.now(),data:c,status:"generating"};s(d);try{const u=await Ib(i);return t(l,{status:"completed",data:u,title:u.title}),l}catch(u){throw t(l,{status:"error",errorMessage:u instanceof Error?u.message:"Unknown error"}),u}finally{r(!1),n(!1)}},[s,t,n]),isGenerating:a}}function Eb(s){const t=s.numberOfChannels,n=s.sampleRate,a=s.length,o=t*2,i=n*o,l=a*o,c=new ArrayBuffer(44+l),d=new DataView(c);let u=0;const h=p=>{for(let b=0;b<p.length;b++)d.setUint8(u+b,p.charCodeAt(b));u+=p.length},g=p=>{d.setUint32(u,p,!0),u+=4},x=p=>{d.setUint16(u,p,!0),u+=2};h("RIFF"),g(36+l),h("WAVE"),h("fmt "),g(16),x(1),x(t),g(n),g(i),x(o),x(16),h("data"),g(l);const f=[];for(let p=0;p<t;p++)f.push(s.getChannelData(p));for(let p=0;p<a;p++)for(let b=0;b<t;b++){let v=f[b][p]??0;v=Math.max(-1,Math.min(1,v));const y=v<0?v*32768:v*32767;d.setInt16(u,y,!0),u+=2}return new Blob([c],{type:"audio/wav"})}async function Ab(s,t){const n=t.slice(0);return await new Promise((a,r)=>{s.decodeAudioData(n,o=>a(o),o=>r(o))})}function oi(s,t,n){const a=n?.silenceSecondsBetween??.25,r=s.sampleRate,o=Math.max(1,...t.map(u=>u.numberOfChannels)),i=Math.floor(a*r),l=t.reduce((u,h)=>u+h.length,0)+Math.max(0,t.length-1)*i,c=s.createBuffer(o,l,r);let d=0;for(let u=0;u<t.length;u++){const h=t[u];for(let g=0;g<o;g++){const x=c.getChannelData(g),f=g<h.numberOfChannels?h.getChannelData(g):h.getChannelData(0);x.set(f,d)}d+=h.length,u<t.length-1&&i>0&&(d+=i)}return c}const Rb={type:"object",properties:{title:{type:"string"},description:{type:"string"},turns:{type:"array",items:{type:"object",properties:{speaker:{type:"string",enum:["host","guest"]},text:{type:"string"}},required:["speaker","text"]}},transcriptMarkdown:{type:"string"}},required:["title","description","turns","transcriptMarkdown"]};function Lb(s){const t=[];for(const n of s){const a=n.speaker,r=(n.text||"").trim();r&&t.push({speaker:a,text:r})}return t}async function Db(s){const{channels:t}=O.getState(),{channelIds:n,itemId:a}=s;if(n.length===0)throw new Error("At least one channel is required");const r=jn(n,t),o=await yn(n,{maxMessagesPerChannel:250});if(o.length===0)throw new Error(`No notes found in selected channels: ${r}`);const i=o.map(C=>C.content).join(`

`),l=ka(i),d=Cr(W.resolvedLanguage??W.language)||l,u=Nn(o,t),h=W.t.bind(W),g=`${h("aiAssistant.prompts.systemPrompts.audioPodcast.role")}

${h("aiAssistant.prompts.systemPrompts.audioPodcast.instructions")}

${h("aiAssistant.prompts.systemPrompts.audioPodcast.constraints",{language:d})}
`,x=d==="Chinese"?`è¯·åŸºäºŽä»¥ä¸‹ç¬”è®°ç”Ÿæˆä¸€ä¸ªä¸¤ä¸ªäººå¯¹è°ˆçš„æ’­å®¢è„šæœ¬ã€‚

ç©ºé—´ï¼š${r}

ç¬”è®°ï¼š
${u}
`:`Create a two-person podcast conversation based on the following notes.

Spaces: ${r}

Notes:
${u}
`,f=await wn({schema:Rb,prompt:x,system:g,temperature:.5}),p=Lb(f.turns);if(p.length===0)throw new Error("Podcast script is empty");const b="qwen3-tts-flash",w=mb({seed:a,hostOverride:"Cherry",guestOverride:"Eric"});let N=null;try{const C=new AudioContext,I=[];for(const T of p){const z=T.speaker==="host"?w.host:w.guest,D=await Lc({text:T.text,voice:z,model:b,languageType:d}),$=[];for(const H of D)$.push(await Ab(C,H));$.length!==0&&I.push($.length===1?$[0]:oi(C,$,{silenceSecondsBetween:0}))}const k=oi(C,I,{silenceSecondsBetween:.28});N=Eb(k),await C.close()}catch(C){console.warn("[audio-podcast] TTS failed, falling back to transcript-only",C)}const S=N?`studio-audio:${a}`:void 0,j=N?"audio/wav":void 0;return N&&S&&await ca.put(S,N,j),{title:f.title||"Audio",description:f.description||"",turns:p,transcriptMarkdown:f.transcriptMarkdown||"",audioStorageKey:S,audioMimeType:j,generatedAt:Date.now(),contextChannelIds:n}}function _b(){const{addContentItem:s,updateContentItem:t,setGenerating:n}=Pt(),[a,r]=m.useState(!1);return{generate:m.useCallback(async i=>{if(i.length===0)throw new Error("At least one channel is required");r(!0),n(!0);const l=`audio-summary-${Date.now()}`,c={title:"Audio",description:"",turns:[],transcriptMarkdown:"",generatedAt:Date.now(),contextChannelIds:i},d={id:l,moduleId:"audio-summary",title:"Audio",contextChannelIds:i,createdAt:Date.now(),updatedAt:Date.now(),data:c,status:"generating"};s(d);try{const u=await Db({channelIds:i,itemId:l});return t(l,{status:"completed",data:u,title:u.title}),l}catch(u){throw t(l,{status:"error",errorMessage:u instanceof Error?u.message:"Unknown error"}),u}finally{r(!1),n(!1)}},[s,t,n]),isGenerating:a}}const Pb=m.memo(function({item:t,onOpen:n,onDelete:a,onTogglePin:r}){const{t:o}=L(),i=z0(t.moduleId),l=i?.icon,[c,d]=m.useState(!1),u=t.status==="generating",h=m.useMemo(()=>{if(t.moduleId==="wiki-card"&&t.status==="completed"){const x=t.data?.cards?.length??0;return x>0?`${t.title} (${x})`:t.title}return t.title},[t.title,t.moduleId,t.status,t.data]);return e.jsx(he.div,{initial:{opacity:0,y:4},animate:{opacity:1,y:0},transition:{duration:.2},onMouseEnter:()=>d(!0),onMouseLeave:()=>d(!1),className:E("group relative mx-3 mb-2 last:mb-0 transition-all duration-200 overflow-hidden","cursor-pointer",u&&"opacity-80"),onClick:()=>{n(t)},children:e.jsxs("div",{className:E("relative rounded-lg border transition-all duration-200 overflow-hidden","backdrop-blur-sm bg-card/50","border-border/40 hover:border-border/60","hover:shadow-md hover:shadow-black/5 dark:hover:shadow-black/20 hover:-translate-y-0.5",u&&"bg-muted/20"),children:[e.jsxs("div",{className:"relative flex items-center gap-3 p-3 min-w-0",children:[l&&e.jsx("div",{className:E("flex-shrink-0 flex items-center justify-center transition-all duration-200","group-hover:scale-105"),children:e.jsx(l,{className:E("w-5 h-5 transition-all duration-200",t.status==="generating"?"text-muted-foreground/40 animate-[breath_2.5s_ease-in-out_infinite]":t.status==="error"?"text-destructive":i?.iconColorClass||"text-muted-foreground/70")})}),e.jsx("div",{className:"flex-1 min-w-0 flex flex-col gap-1.5",children:e.jsx("div",{className:"flex items-start justify-between gap-2 min-w-0",children:e.jsxs("div",{className:"flex-1 min-w-0 flex flex-col gap-1",children:[e.jsx("div",{className:E("text-sm font-medium truncate transition-colors",u?"text-muted-foreground/60":"text-foreground group-hover:text-foreground/90"),children:h}),e.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap",children:[e.jsx("div",{className:"text-[11px] text-muted-foreground/60 font-normal",children:Yt(new Date(t.updatedAt))}),t.status==="error"&&e.jsxs("div",{className:"flex items-center gap-1 text-[11px] text-amber-600 dark:text-amber-400",children:[e.jsx(ua,{className:"w-3 h-3"}),e.jsx("span",{children:o("studio.recentItem.failed")})]}),t.status==="generating"&&e.jsxs("div",{className:"flex items-center gap-1 text-[11px] text-primary/70",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary/60 animate-pulse"}),e.jsx("span",{children:o("studio.recentItem.generating")})]})]})]})})}),e.jsxs("div",{className:E("flex items-center gap-0.5 transition-opacity duration-200 flex-shrink-0",c?"opacity-100":"opacity-0 group-hover:opacity-100"),onClick:g=>g.stopPropagation(),children:[e.jsx(M,{size:"icon",variant:"ghost",className:"h-7 w-7",title:t.pinned?o("studio.recentItem.unpin"):o("studio.recentItem.pin"),onClick:g=>{g.stopPropagation(),r(t)},children:t.pinned?e.jsx(wo,{className:"w-3.5 h-3.5 text-primary fill-primary"}):e.jsx(wo,{className:"w-3.5 h-3.5 text-muted-foreground/60"})}),e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(M,{size:"icon",variant:"ghost",className:"h-7 w-7",title:o("common.moreActions"),onClick:g=>g.stopPropagation(),children:e.jsx(ms,{className:"w-3.5 h-3.5 text-muted-foreground/60"})})}),e.jsxs(mt,{align:"end",sideOffset:8,className:"min-w-[220px] p-1",onClick:g=>g.stopPropagation(),children:[e.jsx(lt,{icon:Lu,onSelect:()=>n(t),children:o("studio.recentItem.open")}),e.jsx(Dt,{}),e.jsx(lt,{icon:jt,onSelect:()=>a(t),className:"text-destructive focus:text-destructive",children:o("studio.recentItem.delete")})]})]})]})]}),e.jsx("div",{className:"absolute inset-0 rounded-lg bg-gradient-to-br from-primary/0 via-primary/0 to-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none"})]})})}),Ob=m.memo(function({title:t,description:n,children:a}){const{t:r}=L(),o=t??r("studio.emptyState.title"),i=n??r("studio.emptyState.description");return e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx(he.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},transition:{duration:.4,ease:[.16,1,.3,1]},className:"inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-gradient-to-br from-primary/10 via-primary/5 to-transparent backdrop-blur-sm border border-primary/10 shadow-sm mb-4",children:e.jsx(he.div,{animate:{rotate:[0,5,-5,0]},transition:{duration:4,repeat:1/0,ease:"easeInOut"},children:e.jsx(tt,{className:"w-6 h-6 text-primary/80 drop-shadow-sm"})})}),e.jsx(he.div,{initial:{opacity:0,y:4},animate:{opacity:1,y:0},transition:{duration:.4,delay:.1,ease:[.16,1,.3,1]},className:"text-sm font-semibold mb-2 text-foreground/90",children:o}),e.jsx(he.div,{initial:{opacity:0,y:4},animate:{opacity:1,y:0},transition:{duration:.4,delay:.15,ease:[.16,1,.3,1]},className:"text-sm text-muted-foreground/80 leading-relaxed max-w-sm mx-auto mb-4",children:i}),a]})});async function Ha(s){const{contentItems:t,deleteContentItem:n}=Pt.getState(),r=Object.values(t).flat().find(o=>o.id===s);if(r?.moduleId==="audio-summary"){const o=r.data;if(o?.audioStorageKey)try{await ca.delete(o.audioStorageKey)}catch(i){console.warn("[studio-item] Failed to delete audio cache",i)}}n(s)}const $b=(s,t,n,a)=>{if(s==="voice-call")return e.jsx(Dc,{onClose:n});const o=a[s].find(i=>i.id===t);if(!o)return null;switch(s){case"audio-summary":return e.jsx(X0,{item:o,onClose:n});case"mindmap":return e.jsx(ib,{item:o,onClose:n});case"wiki-card":return e.jsx(lb,{item:o,onClose:n});case"report":return e.jsx(cb,{item:o,onClose:n});default:return null}},Bb=m.memo(function(){const{t}=L(),n=Le(j=>j.closeStudio),{currentModule:a,activeItemId:r,setCurrentModule:o,setActiveItem:i,contentItems:l,currentContext:c,togglePin:d,setEphemeralContextChannelIds:u}=Pt(),{currentChannelId:h}=J(),{channels:g}=O(),x=H0(),{generate:f}=kb(),{generate:p}=Sb(),{generate:b}=Tb(),{generate:v}=_b(),y=m.useCallback(async j=>{if(j==="voice-call"){let C=[];c?.mode==="all"?C=g.map(I=>I.id):c?.mode==="custom"&&c.channelIds.length>0?C=c.channelIds:c?.mode==="auto"&&h?C=[h]:h&&(C=[h]),u(C),o("voice-call"),i(null);return}if(j==="wiki-card"||j==="mindmap"||j==="report"||j==="audio-summary"){let C=[];if(c?.mode==="all"?C=g.map(I=>I.id):c?.mode==="custom"&&c.channelIds.length>0?C=c.channelIds:c?.mode==="auto"&&h?C=[h]:h&&(C=[h]),C.length===0){console.warn("No channels available for studio generation");return}try{o(j);const I=await(j==="wiki-card"?f(C):j==="mindmap"?p(C):j==="report"?b(C):v(C));i(I)}catch(I){console.error(j==="wiki-card"?"Failed to generate concept cards:":j==="mindmap"?"Failed to generate mindmap:":j==="report"?"Failed to generate report:":"Failed to generate audio summary:",I)}}else console.warn(`Module ${j} generation not yet implemented`)},[o,i,u,c,h,g,f,p,b,v]),w=m.useCallback(()=>{o(null),i(null)},[o,i]),N=m.useMemo(()=>{if(!a)return null;if(a==="voice-call")return e.jsx(Dc,{onClose:w});if(!r)return null;const C=l[a].find(I=>I.id===r);return C?C.status==="error"?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(M,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:w,children:e.jsx(It,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-sm font-medium flex-1 truncate",children:C.title}),e.jsx(M,{variant:"destructive",size:"sm",onClick:()=>{Ha(C.id),w()},children:t("studio.recentItem.delete")})]}),e.jsx("div",{className:"flex-1 min-h-0 flex items-center justify-center px-6",children:e.jsxs("div",{className:"max-w-md w-full rounded-xl border border-border/50 bg-card/60 p-5",children:[e.jsx("div",{className:"text-sm font-semibold",children:t("studio.recentItem.failed")}),e.jsx("div",{className:"mt-2 text-sm text-muted-foreground break-words",children:C.errorMessage||t("common.unknownError")})]})})]}):C.status==="generating"?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(M,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:w,children:e.jsx(It,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-sm font-medium flex-1",children:C.title}),e.jsx(M,{variant:"destructive",size:"sm",onClick:()=>{Ha(C.id),w()},children:t("studio.recentItem.delete")})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"relative inline-block",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-primary/40 animate-[dot-pulse_1.5s_ease-in-out_infinite] mx-auto"}),e.jsx("div",{className:"absolute inset-0 rounded-full bg-primary/10 animate-[expand-ring_2.5s_ease-in-out_infinite]"})]})})]}):$b(a,r,w,l):null},[r,l,a,w,t]),S=m.useMemo(()=>{const j=Object.values(l).flat(),C=j.filter(k=>k.pinned).sort((k,T)=>T.updatedAt-k.updatedAt),I=j.filter(k=>!k.pinned).sort((k,T)=>T.updatedAt-k.updatedAt);return[...C,...I].slice(0,8)},[l]);return e.jsx("div",{className:"h-full flex flex-col bg-background",children:e.jsx(Dr,{mode:"wait",initial:!1,children:N?e.jsx(he.div,{className:"h-full flex flex-col",initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.2,ease:[.16,1,.3,1]},children:N},"detail"):e.jsxs(he.div,{className:"h-full flex flex-col",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},transition:{duration:.2,ease:[.16,1,.3,1]},children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2.5 border-b border-border/40 gap-2",children:[e.jsx(W0,{}),e.jsx(M,{variant:"ghost",size:"icon",className:"h-7 w-7 ml-auto",onClick:n,children:e.jsx(fe,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex-1 min-h-0 flex flex-col",children:[e.jsx("div",{className:"flex-shrink-0 p-4 pb-3",children:e.jsx("div",{className:"grid grid-cols-2 gap-3",children:x.map((j,C)=>e.jsx(he.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{duration:.3,delay:C*.05,ease:[.16,1,.3,1]},children:e.jsx(V0,{module:j,onClick:()=>y(j.id)})},j.id))})}),e.jsx("div",{className:"flex-1 min-h-0 border-t border-border/40",children:S.length===0?e.jsx(he.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{duration:.4,delay:x.length*.05+.1,ease:[.16,1,.3,1]},className:"h-full flex items-center justify-center px-4",children:e.jsx(Ob,{})}):e.jsx(Bs,{className:"h-full",children:e.jsx("div",{className:"py-3",children:S.map(j=>e.jsx(Pb,{item:j,onOpen:C=>{o(C.moduleId),i(C.id)},onDelete:C=>void Ha(C.id),onTogglePin:C=>d(C.id)},j.id))})})})]})]},"grid")})})}),Ub=()=>{const s=ve(),t=m.useRef(!1);return{jumpToNote:({channelId:a,messageId:r})=>{if(t.current)return;t.current=!0;const o=d=>new Promise(u=>setTimeout(u,d)),i=()=>{const d="search-target-highlight-style";if(document.getElementById(d))return;const u=document.createElement("style");u.id=d,u.textContent=`
              @keyframes search-target-pulse {
                0% { background-color: rgba(250, 204, 21, 0.00); outline-color: rgba(245, 158, 11, 0.00); }
                20% { background-color: rgba(250, 204, 21, 0.32); outline-color: rgba(245, 158, 11, 0.95); }
                55% { background-color: rgba(250, 204, 21, 0.20); outline-color: rgba(245, 158, 11, 0.50); }
                100% { background-color: rgba(250, 204, 21, 0.08); outline-color: rgba(245, 158, 11, 0.00); }
              }
              .search-target-highlight {
                outline: 2px solid rgba(245, 158, 11, 0.9); /* amber-500 */
                background-color: rgba(250, 204, 21, 0.18); /* amber-300 @ ~18% */
                animation: search-target-pulse 1.5s ease-in-out 2;
              }
            `,document.head.appendChild(u)},l=d=>{const u=d.getBoundingClientRect(),h=window.innerHeight||document.documentElement.clientHeight,g=window.innerWidth||document.documentElement.clientWidth;return u.top>=0&&u.left>=0&&u.bottom<=h&&u.right<=g},c=(d,u=1200)=>{i();let h=!1;const g=()=>{h||(h=!0,d.classList.add("search-target-highlight"),setTimeout(()=>d.classList.remove("search-target-highlight"),u))};if(l(d)){g();return}if("IntersectionObserver"in window){const x=new IntersectionObserver(f=>{f.find(b=>b.isIntersecting)&&(g(),x.disconnect())},{threshold:.1});x.observe(d),setTimeout(()=>{h||(x.disconnect(),g())},2e3)}else setTimeout(g,300)};(async()=>{try{const{currentChannelId:d}=J.getState();d!==a&&(J.getState().setCurrentChannel(a),await new Promise(b=>setTimeout(b,140)));const u=Rs.messageById(r),h=(b,v)=>{v||b.scrollIntoView({behavior:"smooth",block:"start"}),c(b,3e3)},g=async()=>{const b=document.querySelector(u);if(b)return h(b),!0;if(s.scrollManager.getTimelineVirtualScrollApi()?.scrollToMessageId(r,{align:"start",behavior:"smooth"})??!1){await o(120);const w=document.querySelector(u);if(w)return h(w,!0),!0}return!1},x=8e3,f=Date.now();let p=0;for(X.requestLoadInitialMessages$.next({channelId:a});Date.now()-f<x;){if(await g())return;const b=X.dataContainer.get().messageByChannel[a];if(b?.hasMore&&!b.loadingMore&&p<25){p+=1,await X.loadMoreHistory({channelId:a,messagesLimit:30}),await new Promise(y=>{let w=!1;const N=X.moreMessageLoadedEvent$.listen(S=>{S.channelId===a&&!w&&(w=!0,N(),y())});setTimeout(()=>{if(!w){w=!0;try{N()}catch{}y()}},1600)}),await new Promise(y=>setTimeout(y,70));continue}await new Promise(y=>setTimeout(y,160))}console.warn("[JumpToMessage] not found within time budget",{channelId:a,messageId:r})}finally{setTimeout(()=>{t.current=!1},200)}})()}}};function Fb(s){return s?typeof s!="string"?s:document.querySelector(s):null}function ss(s,t,n){return Math.min(Math.max(s,t),n)}function ii(s){const{open:t,target:n,title:a,description:r,onDismiss:o,onTargetClick:i,onAction:l}=s,c=s.dismissLabel??"Skip",d=s.actionLabel??"",u=m.useRef(null),[h,g]=m.useState(null),[x,f]=m.useState({width:320,height:140}),[p,b]=m.useState(null);if(m.useLayoutEffect(()=>{if(!t){b(null);return}let k=0;const T=()=>{const z=Fb(n);if(z){b(z);return}k=window.requestAnimationFrame(T)};return T(),()=>{k&&window.cancelAnimationFrame(k)}},[t,n]),m.useLayoutEffect(()=>{if(!t||!p)return;const k=()=>{try{g(p.getBoundingClientRect())}catch{g(null)}};k();const T=()=>k();window.addEventListener("resize",T),window.addEventListener("scroll",T,!0);const z=new ResizeObserver(()=>k());return z.observe(p),()=>{window.removeEventListener("resize",T),window.removeEventListener("scroll",T,!0),z.disconnect()}},[t,p]),m.useLayoutEffect(()=>{if(!t)return;const k=u.current;if(!k)return;const T=k.getBoundingClientRect();T.width>0&&T.height>0&&f({width:T.width,height:T.height})},[t,a,r]),m.useEffect(()=>{if(!t||!p||!i)return;const k=()=>i();return p.addEventListener("click",k,!0),()=>{p.removeEventListener("click",k,!0)}},[t,p,i]),m.useEffect(()=>{if(!t)return;const k=T=>{T.key==="Escape"&&o()};return window.addEventListener("keydown",k),()=>window.removeEventListener("keydown",k)},[t,o]),!t||!p||!h)return null;const v=10,y={left:ss(h.left-v,0,window.innerWidth),top:ss(h.top-v,0,window.innerHeight),right:ss(h.right+v,0,window.innerWidth),bottom:ss(h.bottom+v,0,window.innerHeight)},w={background:"rgba(0,0,0,0.55)"},N=12,S=y.bottom+N+x.height<window.innerHeight-12,j=ss(S?y.bottom+N:y.top-N-x.height,12,window.innerHeight-x.height-12),C=ss((y.left+y.right)/2-x.width/2,12,window.innerWidth-x.width-12),I=e.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[e.jsx("div",{className:"fixed left-0 right-0 top-0 pointer-events-auto",style:{...w,height:y.top},onMouseDown:k=>k.preventDefault()}),e.jsx("div",{className:"fixed left-0 pointer-events-auto",style:{...w,top:y.top,height:y.bottom-y.top,width:y.left},onMouseDown:k=>k.preventDefault()}),e.jsx("div",{className:"fixed right-0 pointer-events-auto",style:{...w,top:y.top,height:y.bottom-y.top,width:window.innerWidth-y.right},onMouseDown:k=>k.preventDefault()}),e.jsx("div",{className:"fixed left-0 right-0 bottom-0 pointer-events-auto",style:{...w,top:y.bottom},onMouseDown:k=>k.preventDefault()}),e.jsx("div",{className:"fixed pointer-events-none rounded-xl ring-2 ring-white/90",style:{left:y.left,top:y.top,width:y.right-y.left,height:y.bottom-y.top,boxShadow:"0 10px 30px rgba(0,0,0,0.35)"}}),e.jsxs("div",{ref:u,className:"fixed pointer-events-auto w-[320px] max-w-[calc(100vw-24px)] rounded-xl border bg-background shadow-xl",style:{left:C,top:j},children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 p-4",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:a}),r?e.jsx("div",{className:"mt-1 text-sm text-muted-foreground leading-relaxed",children:r}):null]}),e.jsx(M,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground",onClick:o,"aria-label":"Close",children:e.jsx(fe,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 px-4 pb-4",children:[l&&d?e.jsx(M,{size:"sm",onClick:l,children:d}):null,e.jsx(M,{variant:"ghost",size:"sm",onClick:o,children:c})]})]})]});return Wa.createPortal(I,document.body)}const _c="stillroot:onboarding:notes-tour:v1";function li(){try{const s=localStorage.getItem(_c);if(!s)return{done:!1};const t=JSON.parse(s);if(!t||typeof t!="object")return{done:!1};const n=t;return{done:n.done===!0,step:n.step==="create_space"||n.step==="composer"?n.step:void 0}}catch{return{done:!1}}}function Bn(s){try{localStorage.setItem(_c,JSON.stringify(s))}catch{}}function zb(){const{t:s}=L(),t=Ye(h=>h.currentUser),n=O(h=>h.userId),a=O(h=>h.channels),r=O(h=>h.channelsLoading),o=J(h=>h.currentChannelId),i=kt(h=>h.isOpen),[l,c]=m.useState(null),d=m.useMemo(()=>!(t||!n||i||r||o||a.length>0||li().done),[a.length,r,o,t,i,n]);m.useEffect(()=>{if(!d)return;const g=li().step??"create_space";c(g),Bn({done:!1,step:g})},[d]),m.useEffect(()=>{l&&l==="create_space"&&(!o&&a.length===0||(c("composer"),Bn({done:!1,step:"composer"})))},[a.length,o,l]),m.useEffect(()=>{if(l!=="composer")return;const h=document.querySelector('[data-tour="timeline-composer"]');if(!h)return;const g=h.querySelector('[contenteditable="true"]')||h.querySelector("textarea");g?.focus?.();const x=()=>{c(null),Bn({done:!0})},f=()=>x();return g?.addEventListener("input",f,{once:!0}),g?.addEventListener("keydown",f,{once:!0}),()=>{g?.removeEventListener("input",f),g?.removeEventListener("keydown",f)}},[l]);const u=()=>{c(null),Bn({done:!0})};return l?l==="create_space"?e.jsx(ii,{open:!0,target:'[data-tour="create-first-space"]',title:s("onboarding.notesTour.createSpace.title"),description:s("onboarding.notesTour.createSpace.description"),actionLabel:s("onboarding.notesTour.createSpace.action"),dismissLabel:s("onboarding.notesTour.later"),onAction:()=>{const h=document.querySelector('[data-tour="create-first-space"]');h?.scrollIntoView?.({block:"center"}),h?.click?.()},onDismiss:u}):e.jsx(ii,{open:!0,target:'[data-tour="timeline-composer"]',title:s("onboarding.notesTour.write.title"),description:s("onboarding.notesTour.write.description"),actionLabel:s("onboarding.notesTour.write.action"),dismissLabel:s("onboarding.notesTour.later"),onAction:()=>{const h=document.querySelector('[data-tour="timeline-composer"]');h?.scrollIntoView?.({block:"end"}),h?.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0})),(h?.querySelector('[contenteditable="true"]')||h?.querySelector("textarea"))?.focus?.(),window.setTimeout(()=>u(),0)},onTargetClick:()=>{u()},onDismiss:u}):null}const Pc=()=>{const{t:s}=L(),{currentUser:t,signOut:n}=Ye(),a=async()=>{Kt()},r=async()=>{await n()};return t?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm",children:s("auth.loginButton.hello",{name:t.displayName})}),e.jsx(M,{onClick:r,variant:"outline",size:"sm",children:s("auth.userProfile.signOut")})]}):e.jsx(M,{onClick:a,variant:"ghost",size:"sm",className:"h-8 w-8 p-0 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800","aria-label":s("auth.loginButton.signInWithGoogle"),children:e.jsx(Ui,{className:"w-4 h-4 text-slate-600 dark:text-slate-400"})})};function ci({className:s,...t}){return e.jsx(Md,{"data-slot":"avatar",className:E("relative flex size-8 shrink-0 overflow-hidden rounded-full",s),...t})}function di({className:s,...t}){return e.jsx(Id,{"data-slot":"avatar-image",className:E("aspect-square size-full",s),...t})}function ui({className:s,...t}){return e.jsx(Td,{"data-slot":"avatar-fallback",className:E("bg-muted flex size-full items-center justify-center rounded-full",s),...t})}function da({delayDuration:s=0,...t}){return e.jsx(Ed,{"data-slot":"tooltip-provider",delayDuration:s,...t})}function mi({...s}){return e.jsx(da,{children:e.jsx(Ad,{"data-slot":"tooltip",...s})})}function hi({...s}){return e.jsx(Rd,{"data-slot":"tooltip-trigger",...s})}function gi({className:s,sideOffset:t=0,children:n,...a}){return e.jsx(Ld,{children:e.jsxs(Dd,{"data-slot":"tooltip-content",sideOffset:t,className:E("bg-primary text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",s),...a,children:[n,e.jsx(_d,{className:"bg-primary fill-primary z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]"})]})})}const Hb=({user:s})=>{const{t}=L(),[n,a]=m.useState(!1);if(!s)return e.jsx(da,{children:e.jsxs(mi,{children:[e.jsx(hi,{asChild:!0,children:e.jsx("div",{className:"px-2 py-1",children:e.jsx(Pc,{})})}),e.jsx(gi,{side:"right",children:e.jsx("p",{children:t("auth.userProfile.signInHint")})})]})});const r=async()=>{try{await Ie.signOut(),a(!1)}catch(o){console.error("Logout failed:",o)}};return e.jsx(da,{children:e.jsxs(mi,{children:[e.jsx(hi,{asChild:!0,children:e.jsxs(ln,{open:n,onOpenChange:a,children:[e.jsx(cn,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800",children:e.jsxs(ci,{className:"h-6 w-6",children:[e.jsx(di,{src:s.photoURL||void 0,alt:t("auth.userProfile.avatarAlt")}),e.jsx(ui,{className:"text-xs",children:s.displayName?.charAt(0)||s.email?.charAt(0)||t("auth.userProfile.avatarFallback")})]})})}),e.jsx(dn,{side:"right",className:"w-64 p-3",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 pb-2 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs(ci,{className:"h-10 w-10",children:[e.jsx(di,{src:s.photoURL||void 0,alt:t("auth.userProfile.avatarAlt")}),e.jsx(ui,{children:s.displayName?.charAt(0)||s.email?.charAt(0)||t("auth.userProfile.avatarFallback")})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.displayName||t("auth.userProfile.user")}),e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 truncate",children:s.email})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsxs(M,{variant:"outline",size:"sm",className:"w-full justify-start gap-2",onClick:r,children:[e.jsx(Ir,{className:"h-4 w-4"}),t("auth.userProfile.signOut")]})})]})})]})}),e.jsx(gi,{side:"right",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-medium",children:s.displayName||t("auth.userProfile.user")}),e.jsx("p",{className:"text-xs text-slate-400",children:s.email}),e.jsx("p",{className:"text-xs text-slate-500",children:t("auth.userProfile.manageAccount")})]})})]})})},oo=()=>{const{user:s}=ja();return s?e.jsx(Hb,{user:s}):e.jsx(Pc,{})};function Gb({className:s,...t}){return e.jsx(Pd,{"data-slot":"tabs",className:E("flex flex-col gap-2",s),...t})}function Vb({className:s,...t}){return e.jsx(Od,{"data-slot":"tabs-list",className:E("bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",s),...t})}function pi({className:s,...t}){return e.jsx($d,{"data-slot":"tabs-trigger",className:E("data-[state=active]:bg-background dark:data-[state=active]:text-foreground dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",s),...t})}function fi({className:s,...t}){return e.jsx(Bd,{"data-slot":"tabs-content",className:E("flex-1 outline-none",s),...t})}function Oc(){return"https://api.stillroot.app"}function Wb(s){const t={stillroot:{baseUrl:s.baseUrl,openapiUrl:s.openapiUrl,token:s.token,scopes:s.scopes,expiresAt:s.expiresAt}};return["ä½ çŽ°åœ¨å¯ä»¥é€šè¿‡ StillRoot API è®¿é—®æˆ‘çš„ç¬”è®°ã€‚","","è§„åˆ™ï¼š","- æ‰€æœ‰è¯·æ±‚éƒ½è¦å¸¦ Authorization: Bearer <token>","- å…ˆ GET /v1/channels é€‰æ‹©ä¸€ä¸ª channelId","- messages å¿…é¡»æºå¸¦ channelIdï¼ˆæŸ¥è¯¢å‚æ•°/è¯·æ±‚ä½“éƒ½è¦ï¼›å“åº”ä¹Ÿä¼šè¿”å›ž channelIdï¼‰","- æŽ¥å£è§„èŒƒåœ¨ openapiUrlï¼ˆä¼˜å…ˆæŒ‰ OpenAPI ç”Ÿæˆè°ƒç”¨ï¼‰","","é…ç½®ï¼ˆJSONï¼‰ï¼š",JSON.stringify(t,null,2)].join(`
`)}async function qb(){const t=ne.getAuth().currentUser;if(!t)throw new Error("Please sign in to manage API tokens.");if(!t.emailVerified)throw new Error("Please verify your email before creating API tokens.");return await t.getIdToken()}async function Ga(s,t){const n=await qb(),a=new Headers(t.headers);return a.set("Authorization",`Bearer ${n}`),a.set("Content-Type","application/json; charset=utf-8"),fetch(`${Oc()}${s}`,{...t,headers:a})}async function Va(s){try{const n=(await s.json())?.error?.message;if(typeof n=="string"&&n.trim())return n}catch{}return`Request failed (${s.status})`}class Kb{async listPats(){const t=await Ga("/v1/pats",{method:"GET"});if(!t.ok)throw new Error(await Va(t));return await t.json()}async createPat(t){const n=await Ga("/v1/pats",{method:"POST",body:JSON.stringify(t)});if(!n.ok)throw new Error(await Va(n));return await n.json()}async revokePat(t){const n=await Ga(`/v1/pats/${encodeURIComponent(t)}`,{method:"DELETE"});if(!n.ok&&n.status!==204)throw new Error(await Va(n))}}function Yb(s){if(s===null)return null;const t=Date.now()+s*24*60*60*1e3;return new Date(t).toISOString()}function Xb(){const{t:s}=L(),t=ve(),{user:n}=ja(),[a,r]=m.useState(!1),[o,i]=m.useState([]),[l,c]=m.useState(""),[d,u]=m.useState(!0),[h,g]=m.useState(!0),[x,f]=m.useState(30),[p,b]=m.useState(null),[v,y]=m.useState(null),w=m.useMemo(()=>{const k=[];return d&&k.push("notes:read"),h&&k.push("notes:write"),k},[d,h]),N=async()=>{r(!0);try{const k=await t.apiAccessManager.listPats();i(k.items)}catch(k){ke.error(k instanceof Error?k.message:s("common.unknownError"))}finally{r(!1)}};m.useEffect(()=>{!n||!n.emailVerified||N()},[n?.uid,n?.emailVerified]);const S=async()=>{if(!n){ke.error(s("apiAccess.errors.signInRequired"));return}if(!n.emailVerified){ke.error(s("apiAccess.errors.emailNotVerified"));return}if(!l.trim()){ke.error(s("apiAccess.errors.nameRequired"));return}if(w.length===0){ke.error(s("apiAccess.errors.scopeRequired"));return}r(!0);try{const k=await t.apiAccessManager.createPat({name:l.trim(),scopes:w,expiresAt:Yb(x)});b(k.token),y(k.pat),c(""),await N(),ke.success(s("apiAccess.created"))}catch(k){ke.error(k instanceof Error?k.message:s("common.unknownError"))}finally{r(!1)}},j=async k=>{if(!n){ke.error(s("apiAccess.errors.signInRequired"));return}if(!n.emailVerified){ke.error(s("apiAccess.errors.emailNotVerified"));return}r(!0);try{await t.apiAccessManager.revokePat(k),await N(),ke.success(s("apiAccess.revoked"))}catch(T){ke.error(T instanceof Error?T.message:s("common.unknownError"))}finally{r(!1)}},C=async()=>{if(p)try{await navigator.clipboard.writeText(p),ke.success(s("common.copied"))}catch{ke.error(s("apiAccess.errors.copyFailed"))}},I=async()=>{if(!p||!v)return;const k=Oc(),T=`${k}/openapi.json`,z=Wb({baseUrl:k,openapiUrl:T,token:p,scopes:v.scopes,expiresAt:v.expiresAt});try{await navigator.clipboard.writeText(z),ke.success(s("common.copied"))}catch{ke.error(s("apiAccess.errors.copyFailed"))}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium",children:s("apiAccess.title")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s("apiAccess.description")})]}),n?n.emailVerified?null:e.jsxs("div",{className:"rounded-lg border border-border bg-muted/20 p-3 space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:s("apiAccess.verifyEmail.title")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s("apiAccess.verifyEmail.description")})]}):e.jsxs("div",{className:"rounded-lg border border-border bg-muted/20 p-3 space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:s("apiAccess.signIn.title")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s("apiAccess.signIn.description")}),e.jsx(oo,{})]}),e.jsxs("div",{className:"rounded-lg border border-border p-3 space-y-3",children:[e.jsx("div",{className:"text-sm font-medium",children:s("apiAccess.create.title")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Oe,{value:l,onChange:k=>c(k.target.value),placeholder:s("apiAccess.create.namePlaceholder"),disabled:a}),e.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Nr,{checked:d,onCheckedChange:k=>u(k===!0)}),e.jsx("span",{children:s("apiAccess.scopes.read")})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Nr,{checked:h,onCheckedChange:k=>g(k===!0)}),e.jsx("span",{children:s("apiAccess.scopes.write")})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(M,{variant:x===30?"default":"outline",size:"sm",onClick:()=>f(30),disabled:a,children:s("apiAccess.expiry.days30")}),e.jsx(M,{variant:x===90?"default":"outline",size:"sm",onClick:()=>f(90),disabled:a,children:s("apiAccess.expiry.days90")}),e.jsx(M,{variant:x===null?"default":"outline",size:"sm",onClick:()=>f(null),disabled:a,children:s("apiAccess.expiry.never")})]}),e.jsx(M,{onClick:S,disabled:a,children:s(a?"common.loading":"apiAccess.create.cta")})]})]}),p&&v&&e.jsxs("div",{className:"rounded-lg border border-border bg-muted/20 p-3 space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:s("apiAccess.createdToken.title")}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s("apiAccess.createdToken.note")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Oe,{readOnly:!0,value:p}),e.jsx(M,{variant:"outline",onClick:C,children:s("apiAccess.createdToken.copyToken")}),e.jsx(M,{variant:"outline",onClick:I,children:s("apiAccess.createdToken.copyForAgent")}),e.jsx(M,{variant:"ghost",onClick:()=>{b(null),y(null)},children:s("common.dismiss")})]})]}),e.jsxs("div",{className:"rounded-lg border border-border p-3 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-medium",children:s("apiAccess.tokens.title")}),e.jsx(M,{variant:"outline",size:"sm",onClick:N,disabled:a,children:s("apiAccess.tokens.refresh")})]}),o.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:s("apiAccess.tokens.empty")}):e.jsx("div",{className:"space-y-2",children:o.map(k=>e.jsxs("div",{className:"flex items-center justify-between gap-3 rounded-md border border-border/60 p-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-medium truncate",children:k.name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[k.prefix," â€¢"," ",k.scopes.map(T=>e.jsx(He,{variant:"secondary",className:"mr-1",children:T},T))]}),e.jsx("div",{className:"text-[11px] text-muted-foreground",children:k.expiresAt?`${s("apiAccess.tokens.expiresAt")}: ${new Date(k.expiresAt).toLocaleString()}`:s("apiAccess.tokens.noExpiry")})]}),e.jsx(M,{variant:"destructive",size:"sm",onClick:()=>j(k.id),disabled:a,children:s("apiAccess.tokens.revoke")})]},k.id))})]})]})}const Sr=_e()(Xt(s=>({activeTab:"general",setActiveTab:t=>s({activeTab:t})}),{name:"stillroot-settings-view",partialize:s=>({activeTab:s.activeTab})}));function Jb({onClose:s}){const{t}=L(),n=Sr(r=>r.activeTab),a=Sr(r=>r.setActiveTab);return e.jsxs("div",{className:"h-full flex flex-col bg-background border-l border-border/60",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border/60",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ga,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-semibold text-foreground",children:t("settings.title")})]}),e.jsx(M,{variant:"ghost",size:"icon","aria-label":t("common.close"),className:"h-8 w-8",onClick:s,children:e.jsx(fe,{className:"w-4 h-4"})})]}),e.jsxs(Gb,{value:n,onValueChange:r=>a(r),className:"flex-1 min-h-0",children:[e.jsx("div",{className:"p-4 border-b border-border/60",children:e.jsxs(Vb,{className:"w-full",children:[e.jsx(pi,{value:"general",className:"flex-1",children:t("settings.tabs.general")}),e.jsxs(pi,{value:"apiAccess",className:"flex-1",children:[e.jsx(Fi,{className:"w-4 h-4"}),t("settings.tabs.apiAccess")]})]})}),e.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto p-4",children:[e.jsx(fi,{value:"general",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:t("settings.sections.account")}),e.jsx("div",{className:"rounded-lg bg-muted/50 p-3",children:e.jsx(oo,{})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:t("settings.sections.appearance")}),e.jsx("div",{className:"rounded-lg bg-muted/50 p-3",children:e.jsx(fc,{})})]})]})}),e.jsx(fi,{value:"apiAccess",children:e.jsx(Xb,{})})]})]})]})}function Zb(){const s=ro(),t=Le(i=>i.sideView),n=Le(i=>i.currentThreadId),{currentChannelId:a}=J(),{jumpToNote:r}=Ub();Hr(s.rxEventBus.requestJumpToMessage$,r);const o=()=>{switch(t){case vt.THREAD:return e.jsx(F0,{isOpen:!0,onClose:()=>s.closeThread(),currentThreadId:n||void 0});case vt.AI_ASSISTANT:return e.jsx(kf,{isOpen:!0,onClose:()=>s.closeAIAssistant(),channelId:a||""});case vt.STUDIO:return e.jsx(Bb,{});case vt.SETTINGS:return e.jsx(Jb,{onClose:()=>s.closeSettings()});default:return null}};return e.jsxs(e.Fragment,{children:[e.jsx(Pg,{sidebar:e.jsx(Jf,{}),content:e.jsx(U0,{}),rightSidebar:o()}),e.jsx(zb,{})]})}function Qb({message:s}){return s.isDeleted?null:e.jsx("div",{className:"group relative w-full max-w-full overflow-hidden",children:e.jsxs("div",{className:"bg-card border border-border/50 rounded-xl p-6 shadow-sm hover:shadow-md transition-all duration-200 hover:border-border w-full max-w-full overflow-hidden",children:[e.jsx("div",{className:"flex items-center gap-2 mb-4 text-xs text-muted-foreground",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(pa,{className:"w-3.5 h-3.5 shrink-0"}),e.jsx("span",{className:"font-medium truncate",children:Yt(s.timestamp)})]})}),e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none prose-headings:font-semibold prose-p:leading-relaxed prose-p:text-foreground prose-a:text-primary hover:prose-a:text-primary/80 break-words overflow-wrap-anywhere",children:e.jsx($s,{content:s.content})})]})})}function ev({groupedMessages:s}){const{t}=L(),n=m.useMemo(()=>{const a=[];return Object.entries(s).forEach(([r,o])=>{a.push({type:"date-divider",date:r}),o.filter(i=>i.sender==="user"&&!i.parentId&&!i.isDeleted).forEach(i=>{a.push({type:"message",message:i})})}),a},[s]);return n.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-muted/50 flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),e.jsx("p",{className:"text-muted-foreground font-medium",children:t("spacePublish.publicTimeline.noMessages")})]}):e.jsx("div",{className:"space-y-8 w-full max-w-full overflow-x-hidden",children:n.map((a,r)=>a.type==="date-divider"?e.jsx("div",{className:"py-4 w-full max-w-full overflow-x-hidden",children:e.jsxs("div",{className:"flex items-center gap-4 w-full max-w-full",children:[e.jsx("div",{className:"flex-1 h-px bg-gradient-to-r from-transparent via-border to-border min-w-0"}),e.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider px-3 py-1 bg-card rounded-full border border-border/50 shadow-sm shrink-0",children:a.date}),e.jsx("div",{className:"flex-1 h-px bg-gradient-to-l from-transparent via-border to-border min-w-0"})]})},`date-${a.date}-${r}`):a.message?e.jsx(Qb,{message:a.message},a.message.id):null)})}function $c(){const{t:s}=L(),{shareToken:t}=bm(),[n,a]=m.useState(null),[r,o]=m.useState([]),[i,l]=m.useState(!0),[c,d]=m.useState(null),[u,h]=m.useState(""),[g,x]=m.useState(!1),f=m.useRef(null);m.useEffect(()=>{if(!t){d(s("spacePublish.publicSpacePage.invalidToken")),l(!1);return}(async()=>{try{l(!0);const S=await ge.findChannelByShareToken(t);if(!S){d(s("spacePublish.publicSpacePage.spaceNotFound")),l(!1);return}a(S);const j=await ge.fetchInitialMessagesAllSenders(S.userId,S.channel.id,100);o(j.messages)}catch(S){console.error("Error loading public space:",S),d(s("spacePublish.publicSpacePage.failedToLoad"))}finally{l(!1)}})()},[t,s]);const p=async()=>{if(!(!t||!n))try{const N=await ge.fetchInitialMessagesAllSenders(n.userId,n.channel.id,100);o(N.messages)}catch(N){console.error("Error loading messages:",N)}};m.useEffect(()=>{n&&p()},[n,t]);const b=async()=>{if(!(!u.trim()||!t||!n||g)){x(!0);try{await ge.createMessageForPublicSpace(t,{content:u.trim(),sender:"user",channelId:n.channel.id}),h(""),await p(),f.current&&(f.current.style.height="auto")}catch(N){console.error("Error sending message:",N),alert(N instanceof Error?N.message:s("spacePublish.publicSpacePage.failedToSend"))}finally{x(!1)}}},v=N=>{N.key==="Enter"&&(N.metaKey||N.ctrlKey)&&(N.preventDefault(),b())};m.useEffect(()=>{f.current&&(f.current.style.height="auto",f.current.style.height=`${Math.min(f.current.scrollHeight,200)}px`)},[u]);const y=no(r,{latestFirst:!0}),w=n?.channel.shareMode==="append-only";return i?e.jsx("div",{className:"min-h-screen w-full flex items-center justify-center bg-gradient-to-b from-background to-muted/30",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-12 h-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin mx-auto"}),e.jsx("div",{className:"absolute inset-0 w-12 h-12 border-4 border-transparent border-r-primary/40 rounded-full animate-spin mx-auto",style:{animationDirection:"reverse",animationDuration:"1.5s"}})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:s("spacePublish.publicSpacePage.loadingSpace")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("spacePublish.publicSpacePage.pleaseWait")})]})]})}):c||!n?e.jsx("div",{className:"min-h-screen w-full flex items-center justify-center bg-gradient-to-b from-background to-muted/30",children:e.jsxs("div",{className:"text-center max-w-md px-4 space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-muted flex items-center justify-center mx-auto",children:e.jsx("svg",{className:"w-8 h-8 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h1",{className:"text-2xl font-bold",children:s("spacePublish.publicSpacePage.spaceNotFoundTitle")}),e.jsx("p",{className:"text-muted-foreground",children:c||s("spacePublish.publicSpacePage.spaceNotAvailable")})]})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-background via-background to-muted/20 w-full overflow-x-hidden",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-8 pt-8 w-full flex flex-col min-h-screen",children:[e.jsxs("div",{className:"flex-1 space-y-8 w-full max-w-full overflow-x-hidden",children:[e.jsxs("div",{className:"relative w-full max-w-full",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-primary/5 via-transparent to-primary/5 rounded-2xl"}),e.jsx("div",{className:"relative bg-card border border-border/50 rounded-2xl p-8 shadow-sm w-full max-w-full overflow-hidden",children:e.jsxs("div",{className:"flex items-start gap-4 mb-4",children:[n.channel.emoji&&e.jsx("div",{className:"flex-shrink-0 w-16 h-16 rounded-xl bg-muted/50 flex items-center justify-center text-4xl shadow-sm",children:n.channel.emoji}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2 leading-tight break-words",children:n.channel.name}),n.channel.description&&e.jsx("p",{className:"text-muted-foreground text-base leading-relaxed break-words",children:n.channel.description})]})]})})]}),e.jsx("div",{className:"w-full max-w-full overflow-x-hidden",children:e.jsx(ev,{groupedMessages:y})})]}),w&&e.jsx("div",{className:"sticky bottom-0 bg-background border-t border-border/60 mt-8 w-full max-w-full overflow-x-hidden",children:e.jsx("div",{className:"w-full max-w-full py-3",children:e.jsxs("div",{className:"relative w-full max-w-full",children:[e.jsx(Ps,{ref:f,value:u,onChange:N=>h(N.target.value),onKeyDown:v,placeholder:s("spacePublish.publicSpacePage.messagePlaceholder"),className:"min-h-[80px] max-h-[200px] resize-none w-full bg-background border border-border/60 rounded-lg focus:border-border transition-colors pr-12",disabled:g}),e.jsx("button",{onClick:b,disabled:!u.trim()||g,className:"absolute bottom-2 right-2 w-8 h-8 rounded-md flex items-center justify-center transition-colors duration-150 text-muted-foreground hover:text-foreground hover:bg-accent disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent","aria-label":s("spacePublish.publicSpacePage.sendMessage"),children:g?e.jsx(Mt,{className:"w-4 h-4 animate-spin"}):e.jsx(fa,{className:"w-4 h-4"})})]})})})]})})}const tv=Zi({manifest:{id:"notes",name:"Notes Extension",description:"Conversational AI note-taking feature",version:"1.0.0",author:"StillRoot Team",icon:"notebook"},activate:({subscriptions:s})=>{s.push(Qn.from(Dl.getState().addIcons({"message-square":Ls,hash:pn,plus:$e,notebook:qi}))),s.push(Qn.from(Na.getState().addRoutes([{id:"notes-main",path:"/notes",element:e.jsx(Zb,{}),order:1},{id:"public-space",path:"/space/:shareToken",element:e.jsx($c,{}),order:2},{id:"notes-default",path:"*",element:e.jsx(Pr,{to:"/notes"}),order:9999}])))}});class sv{addChannel=async t=>await O.getState().addChannel(t);deleteChannel=async t=>await O.getState().deleteChannel(t);updateChannel=async(t,n)=>await O.getState().updateChannel(t,n)}class nv{requestJumpToMessage$=new zn;requestTimelineScrollToLatest$=new zn;requestTimelineScrollToBottom$=this.requestTimelineScrollToLatest$;onHistoryMessagesLoadedEvent$=new zn}class av{addThreadMessage=async(t,n)=>await O.getState().addThreadMessage(t,n)}class rv{setCurrentChannel=t=>{J.getState().setCurrentChannel(t)}}class ov{deleteMessage=async({messageId:t,hardDelete:n,channelId:a})=>await X.deleteMessage({messageId:t,hardDelete:n,channelId:a});updateMessage=async({messageId:t,updates:n,channelId:a,userId:r})=>await X.updateMessage({messageId:t,updates:n,channelId:a,userId:r});sendMessage=async t=>await X.sendMessage(t);moveMessage=async({messageId:t,fromChannelId:n,toChannelId:a})=>await X.moveMessage({messageId:t,fromChannelId:n,toChannelId:a})}class iv{startEditing=({messageId:t,content:n,restoreDraft:a=!1,channelId:r})=>{const o=to(n);return te.getState().startEditing(t,n,{baseHash:o,restoreDraft:a,channelId:r})};save=async(t=!0)=>await te.getState().save(t);cancel=()=>{const t=te.getState();if(!t.editingMessageId){t.cancel();return}const n=t.editContent.trim(),a=t.originalContent.trim();if(n!==a){Ee.confirm({title:"Discard changes?",description:"You have unsaved edits. Are you sure you want to discard them?",okText:"Discard",okVariant:"destructive",cancelText:"Keep editing",onOk:async()=>{const{editingMessageId:o}=te.getState();o&&te.getState().clearDraft(o),te.getState().cancel()}});return}t.cancel()};switchToExpandedMode=()=>te.getState().switchToExpandedMode();switchToInlineMode=()=>te.getState().switchToInlineMode();setEditorMode=t=>te.getState().setEditorMode(t);updateContent=t=>te.getState().updateContent(t);applyDraft=()=>te.getState().applyDraft();dismissDraftPrompt=()=>te.getState().dismissDraftPrompt();discardDraft=t=>te.getState().clearDraft(t)}class lv{scrollContainerRef=null;timelineVirtualScrollApi=null;setScrollContainerRef=t=>{this.scrollContainerRef=t};setTimelineVirtualScrollApi=t=>{this.timelineVirtualScrollApi=t};getScrollContainer=()=>this.scrollContainerRef?.current;getTimelineVirtualScrollApi=()=>this.timelineVirtualScrollApi}class Bc{rxEventBus=new nv;threadManager=new av;channelManager=new sv;viewStateManager=new rv;noteManager=new ov;noteEditManager=new iv;scrollManager=new lv;apiAccessManager=new Kb;openAIAssistant=()=>{Le.getState().openAIAssistant()};openThread=({messageId:t})=>{Le.getState().openThread(t)};closeThread=()=>{Le.getState().closeThread()};closeAIAssistant=()=>{Le.getState().closeAIAssistant()};openSettings=t=>{t?.tab&&Sr.getState().setActiveTab(t.tab),Le.getState().openSettings()};closeSettings=()=>{Le.getState().closeSettings()};openChannelList=()=>{Le.getState().openChannelList()};closeChannelList=()=>{Le.getState().closeChannelList()};openStudio=()=>{Le.getState().openStudio()};closeStudio=()=>{Le.getState().closeStudio()};jumpToNote=t=>{this.rxEventBus.requestJumpToMessage$.emit(t)}}class cv extends Bc{}const dv=()=>{const s=m.useMemo(()=>new cv,[]),t=m.useMemo(()=>[tv],[]);return e.jsx(yc.Provider,{value:s,children:e.jsx(zr.Provider,{value:s,children:e.jsxs("div",{className:"h-screen flex flex-col",children:[e.jsx(kg,{extensions:t}),e.jsx(Ml,{})]})})})},uv=({currentChannelName:s,currentChannel:t,channels:n})=>{const{t:a}=L(),{openChannelList:r,openAIAssistant:o,openSettings:i}=Le(),{setCurrentChannel:l}=J(),{channels:c}=O(),d=t?eo(c,t.id):c,u=()=>{o()};return e.jsx("div",{className:"flex-shrink-0 px-4 py-2 bg-background",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{variant:"ghost",size:"icon",onClick:r,className:"h-9 w-9 dark:text-primary",title:a("mobile.header.channels"),"aria-label":a("mobile.header.channels"),children:e.jsx(Jn,{className:"size-5"})}),e.jsx(mn,{instantCreate:!0,variant:"dialog",trigger:e.jsx(M,{variant:"ghost",size:"icon",className:"h-9 w-9 dark:text-primary",title:a("mobile.header.newSpace"),"aria-label":a("mobile.header.newSpace"),children:e.jsx($e,{className:"size-5"})})})]}),e.jsx("div",{className:"flex-1 text-center min-w-0",children:t&&c.length>1?e.jsx(so,{currentChannel:t,channels:d,onChannelSelect:l,className:"w-full"}):e.jsx("h1",{className:"text-lg font-semibold text-foreground/90 truncate px-2 max-w-full",children:s||a("mobile.header.chat")})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{variant:"ghost",size:"icon",onClick:()=>hn(),className:"h-9 w-9 dark:text-primary",title:a("mobile.header.search"),children:e.jsx(Je,{className:"size-5"})}),e.jsx(M,{variant:"ghost",size:"icon",onClick:u,className:"h-9 w-9 dark:text-primary",children:e.jsx(hs,{className:"size-5"})}),e.jsx(M,{variant:"ghost",size:"lg",onClick:i,className:"h-9 w-9 dark:text-primary",children:e.jsx(ga,{className:"size-5"})})]})]})})},mv=({onSend:s,replyToMessageId:t,onCancelReply:n,isSending:a=!1,className:r=""})=>{const{t:o}=L(),[i,l]=m.useState(""),c=m.useRef(null);m.useEffect(()=>{c.current&&(c.current.style.height="auto",c.current.style.height=`${Math.min(c.current.scrollHeight,120)}px`)},[i]);const d=()=>{i.trim()&&(s(i.trim()),l(""),c.current&&(c.current.style.height="auto"))},u=g=>{if(g.key==="Enter"){if(g.shiftKey)return;g.preventDefault(),d()}},h=!!t;return e.jsxs("div",{className:E("bg-background px-3 sm:px-4 py-2 space-y-2 border-t border-border/60",r),children:[h&&e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 rounded-xl px-3 py-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:e.jsx("span",{children:o("messageInput.mobile.replying")})}),e.jsx(M,{variant:"ghost",size:"sm",onClick:n,className:"h-7 px-3 text-xs rounded-lg",children:o("messageInput.mobile.cancel")})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Ps,{ref:c,value:i,onChange:g=>l(g.target.value),onKeyDown:u,placeholder:o("messageInput.placeholder.default"),className:"min-h-[48px] max-h-[120px] resize-none bg-transparent shadow-none focus:shadow-none focus:outline-none transition-all duration-200 text-base placeholder:text-muted-foreground/60 border-0 pl-0 pr-12 py-2",rows:1}),e.jsx("div",{className:"absolute right-0 top-1/2 -translate-y-1/2 flex items-center",children:e.jsx("button",{type:"button",onClick:d,disabled:!i.trim()||a,className:`w-8 h-8 rounded-md flex items-center justify-center transition-colors duration-150 text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-slate-300 ${!i.trim()||a?"opacity-40 cursor-not-allowed hover:bg-transparent":""}`,"aria-label":o("messageInput.mobile.send"),children:a?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current"}):e.jsx(Oi,{className:"h-4 w-4"})})})]})})]})},hv=()=>{const{t:s}=L(),{addChannel:t}=O(),n=async()=>{try{await t({name:s("mobile.welcome.firstSpaceName"),emoji:"ðŸš€",description:s("mobile.welcome.firstSpaceDescription")})}catch(a){console.error("Failed to create first channel:",a)}};return e.jsx("div",{className:"flex-1 flex items-center justify-center p-6",children:e.jsxs("div",{className:"max-w-sm w-full space-y-6 text-center",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto shadow-lg",children:e.jsx(tt,{className:"w-8 h-8 text-white"})}),e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:s("mobile.welcome.title")}),e.jsx("p",{className:"text-muted-foreground text-sm leading-relaxed",children:s("mobile.welcome.description")})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 text-left",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(yt,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-foreground",children:s("mobile.welcome.feature1.title")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("mobile.welcome.feature1.description")})]})]}),e.jsxs("div",{className:"flex items-center gap-3 text-left",children:[e.jsx("div",{className:"w-8 h-8 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(hs,{className:"w-4 h-4 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-foreground",children:s("mobile.welcome.feature2.title")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("mobile.welcome.feature2.description")})]})]}),e.jsxs("div",{className:"flex items-center gap-3 text-left",children:[e.jsx("div",{className:"w-8 h-8 bg-purple-100 dark:bg-purple-900/20 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(fn,{className:"w-4 h-4 text-purple-600 dark:text-purple-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-foreground",children:s("mobile.welcome.feature3.title")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("mobile.welcome.feature3.description")})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(M,{onClick:n,size:"lg",className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white shadow-lg",children:[e.jsx($e,{className:"w-5 h-5 mr-2"}),s("mobile.welcome.createFirstSpace")]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("mobile.welcome.createMoreHint")})]})]})})},gv=({originalContent:s,onSave:t,onCancel:n,onCollapse:a,isSaving:r})=>{const{t:o}=L(),i=te(x=>x.editContent),l=te(x=>x.updateContent),c=i.trim()!==s.trim(),d=m.useRef(null);ao({textareaRef:d,updateContent:l,content:i});const u=x=>{const f=x.target.value;l(f)},h=()=>{c&&t()},g=()=>{c?confirm("You have unsaved changes. Are you sure you want to cancel?")&&n():n()};return e.jsxs("div",{className:"w-full h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border bg-muted/30",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{variant:"ghost",size:"icon",onClick:a,className:"h-8 w-8",children:e.jsx(It,{className:"h-4 w-4"})}),e.jsx("h3",{className:"font-semibold text-foreground",children:o("notes.messageTimeline.editMessage")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{variant:"ghost",size:"sm",onClick:g,disabled:r,className:"px-3 py-1.5 text-sm text-muted-foreground hover:text-foreground transition-colors",children:o("common.cancel")}),e.jsx(M,{onClick:h,disabled:!c||r,size:"sm",className:`px-3 py-1.5 text-sm rounded-md transition-colors ${c?"bg-slate-600 hover:bg-slate-700 text-white shadow-sm border border-slate-500":"bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed"}`,children:o(r?"common.saving":"common.save")})]})]}),e.jsx("div",{className:"flex-1 p-4 min-h-0",children:e.jsx(Ps,{ref:d,value:i,onChange:u,placeholder:o("notes.messageTimeline.editPlaceholder"),className:"w-full h-full resize-none text-sm leading-relaxed border border-input rounded-lg p-3 bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent",autoFocus:!0})}),e.jsx("div",{className:"p-4 border-t border-border bg-muted/30",children:e.jsx("div",{className:"text-xs text-muted-foreground text-center",children:c?"Unsaved changes":"All changes saved"})})]})};function pv({onSave:s,onCancel:t,onExpand:n,isSaving:a,editorMode:r,onEditorModeChange:o}){const{t:i}=L(),l=te(p=>p.editContent),c=te(p=>p.originalContent),d=te(p=>p.updateContent),u=l.trim()!==c.trim(),h=m.useRef(null);ao({textareaRef:h,updateContent:d,content:r==="markdown"?l:""});const g=p=>{const b=p.target.value;d(b)},x=()=>{u&&s()},f=()=>{u?confirm("You have unsaved changes. Are you sure you want to cancel?")&&t():t()};return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"relative",children:r==="markdown"?e.jsx(Ps,{ref:h,value:l,onChange:g,placeholder:i("notes.messageTimeline.editThoughtPlaceholder"),className:"min-h-[120px] resize-none text-sm leading-relaxed border-2 border-blue-200 dark:border-blue-700 focus:border-blue-400 dark:focus:border-blue-500",autoFocus:!0,style:{caretColor:"#3b82f6"}}):e.jsx(vn,{value:l,onChange:p=>d(p),editable:!a,placeholder:i("notes.messageTimeline.editThoughtPlaceholder"),className:"min-h-[140px]"})}),e.jsx(wc,{leftActions:[{label:"Cancel",onClick:f,disabled:a,icon:e.jsx(fe,{className:"w-3 h-3 mr-1"})},{label:a?"Saving...":"Save",onClick:x,disabled:!u||a,icon:e.jsx(Pi,{className:"w-3 h-3 mr-1"}),className:u?"bg-slate-600 hover:bg-slate-700 text-white shadow-sm border border-slate-500 transition-colors duration-200":"bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed"}],rightActions:[{label:"Expand",onClick:n,disabled:a,icon:e.jsx(Du,{className:"w-3 h-3 mr-1"}),variant:"outline"}]})]})}function fv({message:s,isEditing:t,onDelete:n,onEdit:a,onCopy:r,onReply:o,onGenerateSparks:i,onViewDetails:l,onBookmark:c,editorMode:d,onEditorModeChange:u,onMove:h}){const g=()=>{r?r():navigator.clipboard.writeText(s.content)},x=[{id:"primary",showSeparator:!1,items:[...a&&Pe().channel.thoughtRecord.edit.enabled?[{id:"edit",icon:e.jsx(gs,{className:"w-4 h-4"}),title:"Edit",onClick:a,variant:"default",disabled:t}]:[],{id:"copy",icon:e.jsx(ps,{className:"w-4 h-4"}),title:"Copy",onClick:g,variant:"default",disabled:t},...h?[{id:"move",icon:e.jsx(Gi,{className:"w-4 h-4"}),title:"Move to space",onClick:h,variant:"default",disabled:t}]:[]]},...t&&d&&u?[{id:"editor-mode",showSeparator:!0,items:[{id:"markdown-mode",icon:e.jsx(Vi,{className:"w-4 h-4"}),title:d==="markdown"?"âœ“ Markdown Mode":"Markdown Mode",onClick:()=>u("markdown"),variant:"default",disabled:!1},{id:"wysiwyg-mode",icon:e.jsx(yt,{className:"w-4 h-4"}),title:d==="wysiwyg"?"âœ“ WYSIWYG Mode":"WYSIWYG Mode",onClick:()=>u("wysiwyg"),variant:"default",disabled:!1}]}]:[],{id:"ai",showSeparator:!0,items:i&&Pe().channel.thoughtRecord.sparks.enabled?[{id:"generate-sparks",icon:e.jsx(fn,{className:"w-4 h-4"}),title:"Generate Sparks",onClick:i,variant:"default",disabled:t}]:[]},{id:"secondary",showSeparator:!0,items:[]},{id:"danger",showSeparator:!0,items:[{id:"delete",icon:e.jsx(jt,{className:"w-4 h-4"}),title:"Delete",onClick:n,variant:"default",disabled:t}]}];return e.jsx(nc,{groups:x,width:"md",alwaysVisible:!0,triggerClassName:"h-8 w-8 p-0 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all duration-200 rounded-md"})}function xv({children:s,messageId:t,maxHeight:n=600,className:a}){return e.jsx(jc,{messageId:t,maxHeight:n,clampMargin:24,className:E("relative group",a),children:s})}function bv({message:s,showAnalysis:t,onToggleAnalysis:n,className:a,autoGenerate:r=!1}){const{t:o}=L(),i=s.aiAnalysis,{isGenerating:l,error:c,hasTagContext:d,contentTooShort:u,sparks:h,generate:g,regenerate:x}=Cc(s,{enableContextEnhancement:!0,mode:"stream"}),f=!!(h&&h.length||i?.insights?.length),p=h??i?.insights??[];return m.useEffect(()=>{r&&t&&!f&&!l&&g()},[r,t,f,l,g]),!f&&!t?null:e.jsx("div",{className:a,children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:n,className:"flex items-center gap-1.5 px-2.5 py-1.5 bg-blue-50 dark:bg-blue-900/20 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-all duration-200 group",title:t?"Hide sparks":"Show sparks",children:[e.jsx(fn,{className:"w-3.5 h-3.5 text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"text-xs font-medium text-blue-700 dark:text-blue-300",children:f?i.insights.length:0})]}),d&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-full",children:o("notes.messageTimeline.tagEnhanced")})]}),t&&e.jsx("div",{className:"space-y-2",children:f?e.jsxs("div",{className:"space-y-2",children:[p.map((b,v)=>e.jsx("div",{className:"text-xs text-slate-700 dark:text-slate-200 leading-relaxed p-2 bg-white/60 dark:bg-slate-700/40 rounded-lg border border-slate-200/40 dark:border-slate-600/40",children:b},v)),e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(M,{variant:"outline",size:"sm",onClick:x,disabled:l,children:l?"Generating...":"Regenerate"})})]}):e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-slate-200/50 dark:border-slate-700/50 bg-slate-50/60 dark:bg-slate-800/30",children:[e.jsx("div",{className:"flex items-center gap-2",children:l?e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400",children:[e.jsx("div",{className:"w-3 h-3 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}),o("notes.messageTimeline.generatingSparks")]}):c?e.jsx("div",{className:"text-xs text-red-500",children:o("notes.messageTimeline.failed",{error:c})}):u?e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:o("notes.messageTimeline.addMoreContent")}):e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:o("notes.messageTimeline.noSparksYet")})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{variant:"outline",size:"sm",onClick:g,disabled:l||u,children:o(l?"notes.messageTimeline.generating":"notes.messageTimeline.generate")}),e.jsx("button",{onClick:n,className:"p-1 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-all duration-200 rounded hover:bg-slate-200/60 dark:hover:bg-slate-700/60",title:o("notes.messageTimeline.closeAnalysis"),children:e.jsx(fe,{className:"w-4 h-4"})})]})]})})]})})}const Uc=m.createContext(null),io=()=>{const s=m.useContext(Uc);if(!s)throw new Error("useMobilePresenter must be used within a MobilePresenterProvider");return s};function vv({threadCount:s,messageId:t}){return io(),null}const wv=({message:s,onReply:t,threadCount:n=0})=>{const a=ve(),{isEditing:r,editMode:o,isSaving:i,isExpandedEditing:l}=bc(s),[c,d]=m.useState(!1),[u,h]=m.useState(!1),g=te(C=>C.editorMode);if(m.useEffect(()=>{u&&h(!1)},[u]),s.isDeleted)return null;const x=()=>{a.noteEditManager.startEditing({messageId:s.id,content:s.content,channelId:s.channelId})},f=async()=>{const C=s.content.length>100?`${s.content.substring(0,100)}...`:s.content;window.confirm(`ðŸ—‘ï¸ Delete Thought

"${C}"

âš ï¸ This action cannot be undone.
The thought will be moved to trash.

Are you sure you want to continue?`)&&await a.noteManager.deleteMessage({messageId:s.id,channelId:s.channelId})},p=()=>{d(!c)},b=()=>{h(!0),d(!0)},v=()=>{navigator.clipboard.writeText(s.content)},y=()=>{t?.()},w=()=>{Ee.show({content:e.jsx(vc,{fromChannelId:s.channelId,onMove:async C=>{await a.noteManager.moveMessage({messageId:s.id,fromChannelId:s.channelId,toChannelId:C})}}),showFooter:!1,className:"max-w-md"})},N=async()=>{await a.noteEditManager.save()},S=()=>{a.noteEditManager.cancel()},j=()=>{a.noteEditManager.switchToExpandedMode()};return e.jsx("div",{className:"w-full flex flex-col overflow-hidden group",children:e.jsxs("div",{className:`relative w-full px-4 py-4 bg-muted/20 hover:bg-muted/40 transition-all duration-200 ease-out ${s.isNew?"animate-in slide-in-from-bottom-5 fade-in duration-400":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center gap-2 text-xs text-muted-foreground font-medium",children:e.jsx("span",{children:Yt(s.timestamp)})}),e.jsx("div",{className:"w-1 h-1 bg-muted-foreground/60 rounded-full"})]}),e.jsx(fv,{message:s,isEditing:r,onDelete:f,onEdit:x,onCopy:v,onReply:t?y:void 0,onGenerateSparks:b,onViewDetails:()=>{},onBookmark:()=>{},editorMode:g,onEditorModeChange:a.noteEditManager.setEditorMode,onMove:w})]}),e.jsx("div",{className:"",children:r&&o==="inline"?e.jsx(pv,{onSave:N,onCancel:S,onExpand:j,isSaving:i,editorMode:g,onEditorModeChange:a.noteEditManager.setEditorMode}):e.jsx(xv,{maxHeight:400,messageId:s.id,children:e.jsx($s,{content:s.content})})}),!r&&e.jsx(bv,{message:s,showAnalysis:c,onToggleAnalysis:p,autoGenerate:u}),!r&&n>0&&e.jsx("div",{className:"flex justify-end mt-4 pt-2",children:e.jsx(vv,{threadCount:n,messageId:s.id})}),e.jsx(Jt,{open:l,onOpenChange:C=>{C||a.noteEditManager.cancel()},children:e.jsx(Zt,{showCloseButton:!1,className:"h-[90vh] w-[95vw] max-w-none p-0 border-0 bg-background",onInteractOutside:C=>{C.preventDefault()},children:e.jsx(gv,{originalContent:s.content,onSave:N,onCancel:S,onCollapse:()=>a.noteEditManager.cancel(),isSaving:i})})})]})})},yv=({onReply:s,className:t=""})=>{const n=ve(),{currentChannelId:a}=J(),r=O(f=>f.channels),o=O(f=>f.channelsLoading),{messages:i=[],loading:l,hasMore:c,loadMore:d,getChannelState:u}=Os({onHistoryMessagesChange:f=>{n.rxEventBus.onHistoryMessagesLoadedEvent$.emit(f)}}),h=no(i,{latestFirst:!0}),{handleScroll:g}=pc({onTrigger:()=>{a&&d({channelId:a,messagesLimit:20})},canTrigger:!!c&&!l,getState:u,direction:"bottom"}),x=Object.values(h).some(f=>f.some(p=>p.sender==="user"&&!p.parentId));return a?l?e.jsx(nn,{count:5}):x?e.jsx("div",{className:`flex-1 min-h-0 relative overflow-hidden bg-white dark:bg-slate-950 ${t}`,children:e.jsx(hc,{className:"h-full",renderThoughtRecord:(f,p)=>e.jsx(wv,{message:f,onReply:()=>s(f.id),threadCount:p}),groupedMessages:h,messages:i,onScroll:g})}):e.jsx(gc,{}):o||r.length>0?e.jsx(nn,{count:5}):e.jsx(hv,{})},jv=({onSendMessage:s,setReplyToMessageId:t})=>{const n=m.useCallback(r=>{t(r)},[t]),a=m.useCallback(r=>{s(r)},[s]);return{handleReply:n,handleSendMessage:a}},Nv=()=>{const[s,t]=m.useState("100vh");return m.useEffect(()=>{const n=()=>{const r=`${window.innerHeight}px`;t(r),document.documentElement.style.setProperty("--mobile-vh",r)};n();const a=["resize","orientationchange"];return a.forEach(r=>{window.addEventListener(r,n)}),"visualViewport"in window&&window.visualViewport&&window.visualViewport.addEventListener("resize",n),()=>{a.forEach(r=>{window.removeEventListener(r,n)}),"visualViewport"in window&&window.visualViewport&&window.visualViewport.removeEventListener("resize",n)}},[]),s},Cv=({currentChannelName:s,replyToMessageId:t,isAddingMessage:n,onSendMessage:a,onCancelReply:r,setReplyToMessageId:o})=>{const i=io(),l=jv({onSendMessage:a,setReplyToMessageId:o}),c=Nv(),{currentChannelId:d}=J(),{channels:u}=O(),h=u.find(p=>p.id===d),{inputCollapsed:g}=ws(),x=m.useRef(null),f=p=>{X.sendMessage({channelId:J.getState().currentChannelId,content:p,sender:"user"}),setTimeout(()=>{i.rxEventBus.requestTimelineScrollToLatest$.emit()},100)};return e.jsxs("div",{className:"flex flex-col overflow-hidden",style:{height:c,minHeight:c,maxHeight:c},children:[e.jsx(uv,{currentChannelName:s,currentChannel:h,channels:u}),e.jsxs("div",{className:"flex-1 flex flex-col min-h-0 overflow-hidden",children:[e.jsx(yv,{onReply:l.handleReply}),h&&e.jsx("div",{ref:x,className:`flex-shrink-0 bg-transparent overflow-hidden transition-[max-height,opacity,transform,padding] duration-220 ease-out origin-bottom ${g?"max-h-0 opacity-0 translate-y-1 py-0":"max-h-[220px] opacity-100 translate-y-0"}`,"aria-hidden":g,children:e.jsx(mv,{onSend:f,replyToMessageId:t||void 0,onCancelReply:r,isSending:n})})]})]})},kv=({scrollContainerRef:s})=>{const t=m.useRef(0);return m.useEffect(()=>{s.current&&(t.current=s.current.scrollHeight)},[s]),m.useEffect(()=>{const n=s.current;if(!n)return;t.current=n.scrollHeight;const a=()=>{t.current=n.scrollHeight};return n.addEventListener("scroll",a),()=>{n.removeEventListener("scroll",a)}},[t,s]),{lastScrollHeightRef:t}},Sv=({enableDetect:s,scrollContainerRef:t,handleScrollHeightChange:n})=>{const{lastScrollHeightRef:a}=kv({scrollContainerRef:t}),r=rn(n);m.useEffect(()=>{if(!s)return;const o=t.current;if(!o)return;let i=null;const l=()=>{o&&(o.scrollHeight!==a.current&&r(),i=requestAnimationFrame(l))};return i=requestAnimationFrame(l),()=>{i&&cancelAnimationFrame(i)}},[s,t,a,r])};function Mv({scrollContainerRef:s,threshold:t=30,deps:n=[]}){const[a,r]=m.useState(!1),o=m.useCallback((l={})=>{const c=s.current;c&&(l.smooth?c.scrollTo({top:c.scrollHeight,behavior:"smooth"}):c.scrollTop=c.scrollHeight)},[s]),i=m.useCallback(()=>{const l=s.current;if(!l)return;const c=l.scrollHeight-l.scrollTop-l.clientHeight;r(c<=t)},[t,s]);return m.useEffect(()=>{a&&o()},n),m.useEffect(()=>{const l=s.current;if(l)return l.addEventListener("scroll",i),()=>{l.removeEventListener("scroll",i)}},[i,s]),Sv({enableDetect:a,scrollContainerRef:s,handleScrollHeightChange:()=>{Fe.getState().shouldSuppressAutoScrollNow()?Fe.getState().activateAutoScrollSuppression():o()}}),{isSticky:a,scrollToBottom:o,setSticky:r}}const xi=(s,t=5)=>{if(!s)return!1;const{scrollTop:n,clientHeight:a,scrollHeight:r}=s;return r-n-a>t},Iv=(s,t=[],n={})=>{const{scrollToBottom:a,isSticky:r,setSticky:o}=Mv({scrollContainerRef:s,threshold:n.threshold??30,deps:t}),[i,l]=m.useState(!1);m.useEffect(()=>{const d=s.current;if(d){l(xi(d,n.threshold??30));const u=()=>{l(xi(d,n.threshold??30))};return d.addEventListener("scroll",u),()=>{d?.removeEventListener("scroll",u)}}},[s,n.threshold]);const c=rn(d=>{o(!0),a({smooth:d?.behavior==="smooth"})});return{containerRef:s,isSticky:r,scrollToBottom:c,showScrollToBottomButton:i}};function Tv(){const{currentChannelId:s}=J(),t=O(d=>d.addThreadMessage),[n,a]=m.useState(!1),[r,o]=m.useState(void 0);return{isThreadOpen:n,currentThreadId:r,handleOpenThread:d=>{o(d),a(!0)},handleCloseThread:()=>{a(!1),o(void 0)},handleSendThreadMessage:d=>{r&&t(r,{content:d,sender:"user",channelId:s||""})}}}const Ev=()=>{const{addMessage:s,addThreadMessage:t}=O(),{currentChannelId:n,isAddingMessage:a,setIsAddingMessage:r}=J();return{sendMessage:async(i,l)=>{if(!(!i.trim()||!n))try{return l?await t(l,{content:i.trim(),sender:"user",channelId:n}):await s({content:i.trim(),sender:"user",channelId:n}),r(!0),setTimeout(async()=>{try{l?await t(l,{content:"This is an AI response as an annotation to your message.",sender:"ai",channelId:n}):await s({content:"This is an AI response as an annotation to your content.",sender:"ai",channelId:n})}catch(c){console.error("Failed to add AI response:",c)}finally{r(!1)}},1e3),!0}catch(c){return console.error("Failed to send message:",c),!1}},isAddingMessage:a}},Av=()=>{const{currentChannelId:s}=J(),{channels:t}=O(),{messages:n,hasMore:a,loadMore:r}=Os({}),o=m.useRef(null),{isSticky:i,scrollToBottom:l}=Iv(o,[s,n.length]),{replyToMessageId:c,handleCancelReply:d,handleReply:u}=dc(),{isThreadOpen:h,handleOpenThread:g,handleCloseThread:x,handleSendThreadMessage:f}=Tv(),{sendMessage:p,isAddingMessage:b}=Ev();return m.useEffect(()=>{const y=()=>{if(!o.current)return;const{scrollTop:N}=o.current;N===0&&a&&s&&r({channelId:s,messagesLimit:20})},w=o.current;if(w)return w.addEventListener("scroll",y),()=>w.removeEventListener("scroll",y)},[a,r,o,s]),{currentChannelId:s,channels:t,messages:n,hasMore:a,isSticky:i,replyToMessageId:c,isThreadOpen:h,isAddingMessage:b,containerRef:o,handleSendMessage:async y=>{requestAnimationFrame(()=>{l({behavior:"instant"})}),p(y,c||void 0),c&&d()},handleCancelReply:d,handleOpenThread:g,handleCloseThread:x,handleSendThreadMessage:f,scrollToBottom:l,handleReply:u}};function qn({...s}){return e.jsx(wi,{"data-slot":"sheet",...s})}function Rv({...s}){return e.jsx(Ni,{"data-slot":"sheet-portal",...s})}function Lv({className:s,...t}){return e.jsx(Ci,{"data-slot":"sheet-overlay",className:E("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",s),...t})}function Kn({className:s,children:t,side:n="right",hideClose:a,...r}){const{t:o}=L();return e.jsxs(Rv,{children:[e.jsx(Lv,{}),e.jsxs(yi,{"data-slot":"sheet-content",className:E("bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-200 data-[state=open]:duration-250",n==="right"&&"data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm",n==="left"&&"data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm",n==="top"&&"data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b",n==="bottom"&&"data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",s),...r,children:[t,!a&&e.jsxs(ji,{className:"data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:outline-hidden disabled:pointer-events-none",children:[e.jsx(fe,{className:"size-4"}),e.jsx("span",{className:"sr-only",children:o("common.close")})]})]})]})}const Dv=({onClose:s})=>{const{t}=L();return e.jsxs("div",{className:"h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ga,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-semibold text-foreground",children:t("mobile.settings.title")})]}),s&&e.jsx(M,{variant:"ghost",size:"icon","aria-label":t("common.close"),className:"h-8 w-8",onClick:s,children:e.jsx(fe,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex-1 p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:t("mobile.settings.account")}),e.jsx("div",{className:"bg-muted/50 rounded-lg p-3",children:e.jsx(oo,{})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:t("mobile.settings.appearance")}),e.jsx("div",{className:"bg-muted/50 rounded-lg p-3",children:e.jsx(fc,{})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:t("mobile.settings.data")}),e.jsx(M,{variant:"outline",className:"w-full justify-start",children:t("mobile.settings.exportData")}),e.jsx(M,{variant:"outline",className:"w-full justify-start",children:t("mobile.settings.importData")})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[e.jsx(Za,{className:"w-4 h-4"}),t("mobile.settings.developer")]}),e.jsxs(Jt,{children:[e.jsx(cl,{asChild:!0,children:e.jsxs(M,{variant:"outline",className:"w-full justify-start",children:[e.jsx(Ii,{className:"w-4 h-4 mr-2"}),t("mobile.settings.debugInformation")]})}),e.jsxs(Zt,{className:"sm:max-w-md",children:[e.jsx(Ds,{children:e.jsx(_s,{children:t("mobile.settings.debugInformation")})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium",children:[t("mobile.settings.version"),":"]}),e.jsx("div",{className:"text-muted-foreground",children:"v1.0.5"})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium",children:[t("mobile.settings.buildTime"),":"]}),e.jsx("div",{className:"text-muted-foreground",children:new Date().toLocaleString()})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium",children:[t("mobile.settings.environment"),":"]}),e.jsx("div",{className:"text-muted-foreground",children:t("mobile.settings.production")})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium",children:[t("mobile.settings.platform"),":"]}),e.jsx("div",{className:"text-muted-foreground",children:t("mobile.settings.mobile")})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground border-t pt-3",children:t("mobile.settings.debugInfoNote")})]})]})]})]})]})]})},_v=m.forwardRef(function({conversations:t,currentConversationId:n,loading:a,onCreate:r,channelId:o,onClose:i},l){const{t:c}=L(),d=se(y=>y.uiView),u=se(y=>y.showList),h=se(y=>y.showChat),g=t.length>0;m.useImperativeHandle(l,()=>({showList:()=>u(),showChat:()=>h(),createNew:()=>{r(),h()},isListView:()=>d==="list"}),[r,u,h,d]);const x=()=>a?e.jsx(wf,{count:5}):e.jsx(Gr,{conversations:t,currentConversationId:n,loading:a,withHeader:!1}),f=()=>n?e.jsx(Jl,{conversationId:n,channelId:o,onClose:i}):a?e.jsx(Xr,{}):g?e.jsx("div",{className:"flex-1"}):e.jsx(Zl,{onCreate:r}),p=n?t.find(y=>y.id===n):void 0,b=se(y=>y.titleGeneratingMap),v=d==="list"?"Conversations":p?b[p.id]?"Generating title...":p.title||"AI Chat":"AI Chat";return e.jsxs("div",{className:"relative flex-1 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 pt-2 pb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[d==="chat"&&e.jsx(M,{variant:"ghost",size:"icon",onClick:()=>u(),"aria-label":c("aiAssistant.mobile.showConversations"),className:"h-8 w-8 flex-shrink-0",children:e.jsx(Li,{className:"w-4 h-4"})}),d==="list"&&e.jsx(M,{variant:"ghost",size:"icon",onClick:()=>h(),"aria-label":c("aiAssistant.mobile.backToChat"),className:"h-8 w-8 flex-shrink-0",children:e.jsx(It,{className:"w-4 h-4"})}),e.jsx("h3",{className:"font-semibold text-foreground truncate text-sm leading-6",children:v})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx(M,{variant:"ghost",size:"icon","aria-label":c("aiAssistant.mobile.newConversation"),className:"h-8 w-8",onClick:()=>{r(),h()},children:e.jsx($e,{className:"w-4 h-4"})}),i&&e.jsxs(M,{variant:"ghost",size:"icon","aria-label":c("common.close"),className:"h-8 w-8",onClick:i,children:[e.jsx("span",{className:"sr-only",children:c("common.close")}),e.jsx("svg",{viewBox:"0 0 24 24",className:"w-4 h-4","aria-hidden":!0,children:e.jsx("path",{stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",d:"M6 6l12 12M18 6L6 18"})})]})]})]}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"absolute inset-0 flex flex-col "+(d==="list"?"":"hidden"),children:x()}),e.jsx("div",{className:"absolute inset-0 flex flex-col "+(d==="chat"?"":"hidden"),children:f()})]})]})}),Pv=({channelId:s,isOpen:t,onClose:n})=>{const{userId:a}=O(),{conversations:r,currentConversationId:o,loading:i,createConversation:l,loadConversations:c,resetForLoggedOut:d}=bn(),u=m.useRef(null);m.useEffect(()=>{if(t){if(!a){d();return}c(a)}},[a,t,c,d]);const h=()=>{a&&l(a,"")};return t?e.jsx(_v,{ref:u,conversations:r,currentConversationId:o,loading:i,onCreate:h,channelId:s,onClose:n}):null};function Ov({channel:s,isOpen:t,onOpenChange:n}){const{t:a}=L(),r=ve(),[o,i]=m.useState(s.name),[l,c]=m.useState(s.description||""),[d,u]=m.useState(s.emoji||""),[h,g]=m.useState(!1);m.useEffect(()=>{t&&(i(s.name),c(s.description||""),u(s.emoji||""))},[t,s.id,s.name,s.description,s.emoji]);const x=async()=>{if(o.trim()){g(!0);try{const b=o.trim()!==s.name,v=l.trim()!==(s.description||""),y=d.trim()!==(s.emoji||"");await r.channelManager.updateChannel(s.id,{name:o.trim(),description:l.trim(),emoji:d.trim()||void 0}),b&&De.logChannelEdit(s.id,ds.NAME),v&&De.logChannelEdit(s.id,ds.DESCRIPTION),y&&De.logChannelEdit(s.id,ds.EMOJI),n(!1)}catch(b){console.error("Error updating channel:",b),i(s.name),c(s.description||""),u(s.emoji||"")}finally{g(!1)}}},f=()=>{i(s.name),c(s.description||""),u(s.emoji||""),n(!1)},p=b=>{b.key==="Enter"&&!h?x():b.key==="Escape"&&f()};return e.jsx(Jt,{open:t,onOpenChange:n,children:e.jsxs(Zt,{className:"sm:max-w-md",children:[e.jsx(Ds,{children:e.jsx(_s,{children:a("channelManagement.editChannel.title")})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{htmlFor:"emoji",children:a("channelManagement.editChannel.emoji")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Jr,{onSelect:u,children:e.jsx(M,{variant:"outline",size:"sm",className:"h-8 w-8 p-0",type:"button",children:d||"ðŸ˜Š"})}),e.jsx(Oe,{id:"emoji",value:d,onChange:b=>u(b.target.value),placeholder:a("channelManagement.editChannel.emojiPlaceholder"),className:"flex-1",maxLength:2})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{htmlFor:"name",children:a("channelManagement.editChannel.name")}),e.jsx(Oe,{id:"name",value:o,onChange:b=>i(b.target.value),placeholder:a("channelManagement.editChannel.namePlaceholder"),onKeyDown:p,disabled:h})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(wt,{htmlFor:"description",children:a("channelManagement.editChannel.description")}),e.jsx(Ps,{id:"description",value:l,onChange:b=>c(b.target.value),placeholder:a("channelManagement.editChannel.descriptionPlaceholder"),rows:3,disabled:h})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(M,{variant:"outline",onClick:f,disabled:h,children:a("common.cancel")}),e.jsx(M,{onClick:x,disabled:h||!o.trim(),children:a(h?"common.saving":"common.save")})]})]})})}function $v({channel:s,onDelete:t}){const{t:n}=L(),[a,r]=m.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(M,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-muted-foreground hover:text-foreground hover:bg-muted",title:n("channelManagement.channelItem.moreActions"),onClick:o=>o.stopPropagation(),children:e.jsx(ms,{className:"h-3.5 w-3.5"})})}),e.jsx(mt,{className:"w-56 p-2",align:"end",side:"bottom",onClick:o=>o.stopPropagation(),children:e.jsx(ac,{groups:[{id:"actions",items:[{id:"edit",icon:e.jsx(gs,{}),title:n("channelManagement.channelItem.editChannel",{name:s.name}),onClick:()=>r(!0)}]},{id:"danger",items:[{id:"delete",icon:e.jsx(jt,{}),title:n("channelManagement.channelItem.deleteChannel",{name:s.name}),onClick:t}]}]})})]}),e.jsx(Ov,{channel:s,isOpen:a,onOpenChange:r})]})}function Bv({channel:s,isActive:t}){const n=ve(),a=()=>{n.viewStateManager.setCurrentChannel(s.id)},r=async o=>{if(window.confirm(`ðŸ—‘ï¸ Delete Channel

"${s.name}"

âš ï¸ This action cannot be undone.
The channel and all its messages will be moved to trash.

Are you sure you want to continue?`))try{await n.channelManager.deleteChannel(o)}catch(l){const c=l instanceof Error?l.message:"Unknown error";alert(`âŒ Failed to delete the channel.

Error: ${c}

Please try again.`)}};return e.jsxs("button",{onClick:a,className:E("w-full flex items-center gap-3 px-3 py-3 text-left transition-all duration-200 group rounded-lg","hover:bg-muted/50",t&&"bg-muted/50"),children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 flex items-center justify-center",children:s.emoji?e.jsx("span",{className:"text-lg leading-none",title:`Emoji: ${s.emoji}`,children:s.emoji}):e.jsx(pn,{className:"w-4 h-4 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:E("font-medium truncate text-sm",t?"text-foreground":"text-foreground/80"),children:s.name}),s.description&&e.jsx("div",{className:"text-xs text-muted-foreground truncate mt-0.5",children:s.description})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx($v,{channel:s,onDelete:()=>r(s.id)})})]})}function Uv({isOpen:s}){const{t}=L(),n=ve(),a=O(i=>i.channels),r=J(i=>i.currentChannelId);Zr();const o=m.useMemo(()=>Qr(a),[a]);return e.jsx(qn,{open:s,onOpenChange:()=>n.closeChannelList(),children:e.jsx(Kn,{side:"left",className:"w-80 p-0 border-r border-border",hideClose:!0,children:e.jsxs("div",{className:"flex flex-col h-full bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h3",{className:"font-semibold text-foreground",children:t("mobile.channelList.title")})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(mn,{variant:"dialog",trigger:e.jsx(M,{variant:"ghost",size:"icon",className:"h-8 w-8",title:t("mobile.channelList.newSpace"),"aria-label":t("mobile.channelList.newSpace"),children:e.jsx($e,{className:"w-4 h-4"})})})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-2",children:o.map(i=>e.jsx(Bv,{channel:i,isActive:r===i.id},i.id))})]})})})}const Fv=()=>{const{t:s}=L(),t=ve(),n=J(i=>i.currentChannelId),{messages:a}=Os({}),r=n?a.find(i=>i.id===n):null,o=n?a.filter(i=>i.threadId===n)||[]:[];return e.jsxs("div",{className:"h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ls,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-semibold text-foreground",children:s("threadManagement.sidebar.title")})]}),e.jsx(M,{variant:"ghost",size:"icon","aria-label":s("common.close"),className:"h-8 w-8",onClick:()=>t.closeThread(),children:e.jsx(fe,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"p-4 bg-muted/50",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-2",children:s("threadManagement.sidebar.parentMessage")}),e.jsx("div",{className:"text-sm text-foreground leading-relaxed",children:r?.content}),e.jsx("div",{className:"text-xs text-muted-foreground mt-2",children:Yt(r?.timestamp||new Date)})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground mb-3",children:s("threadManagement.sidebar.replies")}),o.length===0?e.jsx("div",{className:"text-sm text-muted-foreground text-center py-8",children:s("threadManagement.sidebar.noRepliesMobile")}):o.map(i=>e.jsxs("div",{className:"bg-card border border-border rounded-lg p-3",children:[e.jsx("div",{className:"text-sm text-foreground leading-relaxed whitespace-pre-wrap",children:i.content}),e.jsx("div",{className:"text-xs text-muted-foreground mt-2",children:Yt(i.timestamp)})]},i.id))]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:s("threadManagement.sidebar.replyToThread"),className:"flex-1 px-3 py-2 border border-border rounded-md text-sm bg-background text-foreground placeholder:text-muted-foreground",onKeyDown:i=>{i.key==="Enter"&&i.currentTarget.value.trim()&&(n&&t.threadManager.addThreadMessage(n,{content:i.currentTarget.value.trim(),sender:"user",channelId:n}),i.currentTarget.value="")}}),e.jsx(M,{size:"sm",onClick:i=>{const l=i.currentTarget.previousElementSibling;l&&l.value.trim()&&(n&&t.threadManager.addThreadMessage(n,{content:l.value.trim(),sender:"user",channelId:n}),l.value="")},children:s("threadManagement.sidebar.reply")})]})})]})},zv=()=>{const s=ve(),t=J(r=>r.currentChannelId),n=Le(r=>r.isChannelListOpen),a=Le(r=>r.sideView);return e.jsxs(e.Fragment,{children:[e.jsx(Uv,{isOpen:n}),t&&e.jsx(qn,{open:a===vt.AI_ASSISTANT,onOpenChange:s.closeAIAssistant,children:e.jsx(Kn,{side:"bottom",className:"h-[80vh] p-0 border-t border-border/60",hideClose:!0,onOpenAutoFocus:r=>r.preventDefault(),children:e.jsx(Pv,{channelId:t,isOpen:a===vt.AI_ASSISTANT,onClose:()=>s.closeAIAssistant()})})}),a===vt.THREAD&&e.jsx(qn,{open:a===vt.THREAD,onOpenChange:()=>s.closeThread(),children:e.jsx(Kn,{side:"right",className:"w-full max-w-md p-0 border-l border-border/60",hideClose:!0,children:e.jsx(Fv,{})})}),e.jsx(qn,{open:a===vt.SETTINGS,onOpenChange:()=>s.closeSettings(),children:e.jsx(Kn,{side:"right",className:"w-full max-w-md p-0 border-l border-border/60",hideClose:!0,children:e.jsx(Dv,{onClose:()=>s.closeSettings()})})})]})};function Hv(){const s=io();Zr();const t=Av(),{jumpToNote:n}=Gv();Hr(s.rxEventBus.requestJumpToMessage$,n);const a=t.channels.find(r=>r.id===t.currentChannelId);return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx(Cv,{currentChannelName:a?.name,replyToMessageId:t.replyToMessageId,isAddingMessage:t.isAddingMessage,onSendMessage:t.handleSendMessage,onCancelReply:t.handleCancelReply,setReplyToMessageId:r=>{r&&t.handleReply(r)}}),e.jsx(zv,{})]})}function Gv(){return{jumpToNote:({channelId:t,messageId:n})=>{const a=()=>{const i="search-target-highlight-style";if(document.getElementById(i))return;const l=document.createElement("style");l.id=i,l.textContent=`
    @keyframes search-target-pulse { 
      0% { background-color: rgba(250, 204, 21, 0.00); outline-color: rgba(245, 158, 11, 0.00); }
      20% { background-color: rgba(250, 204, 21, 0.32); outline-color: rgba(245, 158, 11, 0.95); }
      55% { background-color: rgba(250, 204, 21, 0.20); outline-color: rgba(245, 158, 11, 0.50); }
      100% { background-color: rgba(250, 204, 21, 0.08); outline-color: rgba(245, 158, 11, 0.00); }
    }
    .search-target-highlight { outline: 2px solid rgba(245, 158, 11, 0.9); background-color: rgba(250, 204, 21, 0.18); animation: search-target-pulse 1.5s ease-in-out 2; }
  `,document.head.appendChild(l)},r=i=>{const l=i.getBoundingClientRect(),c=window.innerHeight||document.documentElement.clientHeight,d=window.innerWidth||document.documentElement.clientWidth;return l.top>=0&&l.left>=0&&l.bottom<=c&&l.right<=d},o=(i,l=3e3)=>{a();let c=!1;const d=()=>{c||(c=!0,i.classList.add("search-target-highlight"),setTimeout(()=>i.classList.remove("search-target-highlight"),l))};if(r(i)){d();return}if("IntersectionObserver"in window){const u=new IntersectionObserver(h=>{h.find(x=>x.isIntersecting)&&(d(),u.disconnect())},{threshold:.1});u.observe(i),setTimeout(()=>{c||(u.disconnect(),d())},2e3)}else setTimeout(d,300)};(async()=>{try{const{currentChannelId:i}=J.getState();i!==t&&(J.getState().setCurrentChannel(t),await new Promise(g=>setTimeout(g,160)));const l=Rs.messageById(n),c=()=>{const g=document.querySelector(l);return g?(g.scrollIntoView({behavior:"smooth",block:"start"}),o(g,3e3),!0):!1},d=8e3,u=Date.now();let h=0;for(X.requestLoadInitialMessages$.next({channelId:t});Date.now()-u<d;){if(c())return;const g=X.dataContainer.get().messageByChannel[t];if(g?.hasMore&&!g.loadingMore&&h<20){h+=1,await X.loadMoreHistory({channelId:t,messagesLimit:20}),await new Promise(f=>{let p=!1;const b=X.moreMessageLoadedEvent$.listen(v=>{v.channelId===t&&!p&&(p=!0,b(),f())});setTimeout(()=>{if(!p){p=!0;try{b()}catch{}f()}},1600)}),await new Promise(f=>setTimeout(f,60));continue}await new Promise(f=>setTimeout(f,150))}console.warn("[Mobile JumpToMessage] not found within time budget",{channelId:t,messageId:n})}finally{}})()}}}const Vv=Zi({manifest:{id:"mobile-notes",name:"Mobile Notes Extension",description:"Mobile-optimized conversational AI note-taking feature",version:"1.0.0",author:"StillRoot Team",icon:"notebook"},activate:({subscriptions:s})=>{s.push(Qn.from(Dl.getState().addIcons({notebook:qi,hash:pn,plus:$e,menu:Er}))),s.push(Qn.from(Na.getState().addRoutes([{id:"mobile-notes-main",path:"/notes",element:e.jsx(Hv,{}),order:1},{id:"mobile-public-space",path:"/space/:shareToken",element:e.jsx($c,{}),order:2},{id:"mobile-notes-default",path:"*",element:e.jsx(Pr,{to:"/notes"}),order:9999}])))}});function Fc(s){return s.sort((t,n)=>(t.order??0)-(n.order??0)).map(t=>e.jsx(Is,{path:t.path,element:t.element,children:t.children&&Fc(t.children)},t.id))}const Wv=()=>{const s=Na(t=>t.routes);return e.jsx(ba,{children:Fc(s)})},qv=s=>{const{t}=L(),{extensions:n}=s,{initialized:a}=Tl({extensions:n});return a?e.jsx("div",{className:"flex flex-col bg-background overflow-hidden",style:{height:"100%"},children:e.jsx("div",{className:"flex-1 min-h-0 overflow-hidden h-full",children:e.jsx(Wv,{})})}):e.jsx("div",{className:"flex items-center justify-center h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("div",{className:"text-muted-foreground",children:t("common.loading")})]})})};class Kv extends Bc{}const Yv=()=>{const s=m.useMemo(()=>new Kv,[]);return e.jsx(Uc.Provider,{value:s,children:e.jsx(zr.Provider,{value:s,children:e.jsxs("div",{className:"flex flex-col bg-background overflow-hidden",style:{height:"100%"},children:[e.jsx(qv,{extensions:[Vv]}),e.jsx(Ml,{})]})})})},Xv=_e()((s,t)=>({visible:!1,process:null,show:n=>{const a=n.steps?.map(r=>({...r,status:r.status??"pending"}));s({visible:!0,process:{id:n.id,title:n.title,message:n.message,status:"running",progress:n.progress??0,steps:a,dismissible:n.dismissible??!1,startedAt:Date.now(),displayMode:n.displayMode??"dialog"}})},update:n=>{const a=t().process;a&&s({process:{...a,...n}})},setMessage:n=>{const a=t().process;a&&s({process:{...a,message:n}})},setProgress:n=>{const a=t().process;a&&s({process:{...a,progress:n}})},setStepStatus:(n,a)=>{const r=t().process;if(!r||!r.steps)return;const o=r.steps.map(i=>i.id===n?{...i,status:a}:i);s({process:{...r,steps:o}})},succeed:n=>{const a=t().process;a&&s({process:{...a,message:n??a.message,status:"success",progress:100,endedAt:Date.now()}})},fail:n=>{const a=t().process;a&&s({process:{...a,message:n??a.message,status:"error",endedAt:Date.now()}})},hide:()=>s({visible:!1,process:null})})),Jv=()=>{const{visible:s,process:t}=Xv(),n=s&&!!t;if(!n||!t)return null;const{title:a,message:r,progress:o,steps:i,status:l,dismissible:c,displayMode:d}=t,u=()=>l==="success"?e.jsx(Ia,{className:"w-5 h-5 text-green-500"}):l==="error"?e.jsx(Xs,{className:"w-5 h-5 text-red-500"}):e.jsx(Mt,{className:"w-5 h-5 animate-spin"});if(d==="fullscreen"){const h=Pe().ui?.globalProcess?.branding;return e.jsxs("div",{"aria-live":"polite","aria-busy":l==="running",role:"dialog",className:"fixed inset-0 z-50 bg-background select-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",children:[h?.enabled&&e.jsx("div",{className:"absolute top-6 left-6 text-sm text-muted-foreground",children:h.brandName}),e.jsx("div",{className:"h-full w-full flex items-center justify-center p-6",children:e.jsxs("div",{className:"w-full max-w-md space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{}),e.jsx("h2",{className:"text-lg font-semibold",children:a})]}),r&&e.jsx("p",{className:"text-muted-foreground text-sm",children:r}),e.jsx(ra,{value:o}),i&&i.length>0&&e.jsx("div",{className:"space-y-2",children:i.map(g=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[g.status==="success"?e.jsx(Ia,{className:"w-4 h-4 text-green-500"}):g.status==="error"?e.jsx(Xs,{className:"w-4 h-4 text-red-500"}):e.jsx(Mt,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{className:"text-foreground/90",children:g.title})]},g.id))})]})})]})}return e.jsx(Jt,{open:n,children:e.jsxs(Zt,{showCloseButton:!!c,className:"sm:max-w-md select-none",children:[e.jsxs(Ds,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{}),e.jsx(_s,{children:a})]}),r&&e.jsx(wa,{children:r})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(ra,{value:o}),i&&i.length>0&&e.jsx("div",{className:"space-y-2",children:i.map(h=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[h.status==="success"?e.jsx(Ia,{className:"w-4 h-4 text-green-500"}):h.status==="error"?e.jsx(Xs,{className:"w-4 h-4 text-red-500"}):e.jsx(Mt,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{className:"text-foreground/90",children:h.title})]},h.id))})]})]})})};function Zv(){const s=W.t.bind(W);return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-foreground",children:s("auth.guestDataNotice.description")}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(M,{variant:"ghost",className:"h-8 px-3 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200",onClick:()=>{Ee.close(),Kt({title:s("auth.guestDataNotice.loginTitle"),description:s("auth.guestDataNotice.loginDescription")})},children:s("auth.guestDataNotice.goToLogin")}),e.jsx(M,{variant:"ghost",className:"h-8 px-3 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200",onClick:()=>Ee.close(),children:s("auth.guestDataNotice.gotIt")})]})]})}function Qv(){const s=W.t.bind(W);Ee.show({title:s("auth.guestDataNotice.title"),description:s("auth.guestDataNotice.subtitle"),showFooter:!1,className:"w-full max-w-[520px]",content:e.jsx(Zv,{})})}function ew(){const s=_r(),t=Ye(a=>a.currentUser),n=Ye(a=>a.sessionMode);return m.useEffect(()=>{let a=!1;return(async()=>{if(n==="booting"||t||s.pathname.startsWith("/space/")||(await ne.whenRegionReadyForUi(),a))return;const{currentUser:r,sessionMode:o}=Ye.getState();o!=="booting"&&(r||s.pathname.startsWith("/space/")||(Ee.close(),Fr()?Qv():Kt({allowGuest:!0})))})(),()=>{a=!0}},[s.pathname,t,n]),null}const tw=()=>{const{t:s}=L();return e.jsxs("section",{className:"relative overflow-hidden px-6 pt-32 pb-20 lg:px-8 lg:pt-48 lg:pb-32",children:[e.jsxs("div",{className:"absolute top-0 left-1/2 -translate-x-1/2 w-full h-full -z-10 pointer-events-none",children:[e.jsx("div",{className:"absolute top-[-10%] left-[-10%] w-[40%] h-[40%] rounded-full bg-blue-600/10 blur-[120px]"}),e.jsx("div",{className:"absolute bottom-[10%] right-[-5%] w-[30%] h-[30%] rounded-full bg-purple-600/10 blur-[120px]"})]}),e.jsx("div",{className:"mx-auto max-w-7xl",children:e.jsxs("div",{className:"grid gap-12 lg:grid-cols-2 lg:gap-16 items-center",children:[e.jsxs(he.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.6},className:"space-y-8",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full bg-purple-100 px-4 py-2 text-sm font-medium text-purple-700",children:[e.jsx(tt,{className:"h-4 w-4"}),e.jsx("span",{children:s("landing.hero.badge")})]}),e.jsxs("h1",{className:"text-6xl md:text-8xl lp-heading font-black tracking-tighter text-white leading-[0.85] mb-8",children:[s("landing.hero.title"),e.jsx("span",{className:"block mt-4 lp-gradient-text underline decoration-blue-500/30 underline-offset-8",children:s("landing.hero.subtitle")})]}),e.jsx("p",{className:"text-lg text-slate-400 leading-relaxed mb-10 max-w-lg font-medium",children:s("landing.hero.description")}),e.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row items-center",children:[e.jsxs("button",{className:"lp-button-primary px-10 py-4 rounded-full text-white font-bold text-lg flex items-center gap-2 group",children:[s("landing.hero.primaryButton"),e.jsx(_u,{className:"h-5 w-5 group-hover:translate-x-1 transition-transform"})]}),e.jsx("button",{className:"px-8 py-4 text-slate-300 font-semibold hover:text-white transition-colors",children:s("landing.hero.secondaryButton")})]}),e.jsxs("div",{className:"flex items-center gap-8 text-[10px] text-slate-500 font-bold uppercase tracking-widest pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-1.5 w-1.5 rounded-full bg-blue-500/50"}),e.jsx("span",{children:s("landing.hero.featureZeroFriction")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-1.5 w-1.5 rounded-full bg-cyan-500/50"}),e.jsx("span",{children:s("landing.hero.featureAIInsight")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-1.5 w-1.5 rounded-full bg-indigo-500/50"}),e.jsx("span",{children:s("landing.hero.featureAutoSync")})]})]})]}),e.jsxs(he.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:1,ease:"easeOut",delay:.4},className:"relative",children:[e.jsxs("div",{className:"lp-glass p-1 rounded-[2.5rem] relative group",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/20 to-purple-600/20 rounded-[2.5rem] opacity-0 group-hover:opacity-100 transition-opacity duration-700"}),e.jsxs("div",{className:"bg-slate-900/40 rounded-[2.3rem] overflow-hidden border border-white/5 shadow-inner",children:[e.jsx("div",{className:"h-8 bg-white/5 border-b border-white/5 flex items-center px-6 gap-2",children:e.jsxs("div",{className:"flex gap-1.5",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-white/10"}),e.jsx("div",{className:"w-2 h-2 rounded-full bg-white/10"}),e.jsx("div",{className:"w-2 h-2 rounded-full bg-white/10"})]})}),e.jsxs("div",{className:"p-8 space-y-6",children:[e.jsx("div",{className:"flex justify-end pr-4",children:e.jsx("div",{className:"lp-glass px-6 py-4 rounded-3xl rounded-tr-sm text-sm text-slate-200 border-white/10 max-w-[85%]",children:s("landing.hero.demoMessage")})}),e.jsxs("div",{className:"flex justify-start pl-4 gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-600/20 flex items-center justify-center border border-blue-500/20",children:e.jsx(tt,{className:"h-4 w-4 text-blue-400"})}),e.jsxs("div",{className:"space-y-3 max-w-[85%]",children:[e.jsx("div",{className:"bg-white/5 px-6 py-4 rounded-3xl rounded-tl-sm text-sm text-slate-300 border border-white/5",children:s("landing.hero.demoResponse")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"px-3 py-1.5 rounded-full bg-blue-500/10 border border-blue-500/20 text-[10px] text-blue-400 font-bold uppercase tracking-wider",children:s("landing.hero.demoBadgeMindmap")}),e.jsx("div",{className:"px-3 py-1.5 rounded-full bg-purple-500/10 border border-purple-500/20 text-[10px] text-purple-400 font-bold uppercase tracking-wider",children:s("landing.hero.demoBadgeInsight")})]})]})]})]})]})]}),e.jsxs(he.div,{animate:{y:[0,-15,0],rotate:[0,5,0]},transition:{duration:5,repeat:1/0,ease:"linear"},className:"absolute -right-8 -top-8 w-24 h-24 lp-glass rounded-full flex items-center justify-center border-white/10 shadow-2xl overflow-hidden group",children:[e.jsx("div",{className:"absolute inset-0 bg-blue-500/10 group-hover:bg-blue-500/20 transition-colors"}),e.jsx(tt,{className:"h-8 w-8 text-blue-400 relative z-10"})]}),e.jsxs(he.div,{animate:{y:[0,15,0],x:[0,-5,0]},transition:{duration:4,repeat:1/0,ease:"linear",delay:1},className:"absolute -left-12 bottom-12 lp-glass px-6 py-3 rounded-2xl flex items-center gap-3 border-white/10 shadow-2xl",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-cyan-400 animate-pulse"}),e.jsx("span",{className:"text-xs font-bold text-slate-300 tracking-wider",children:s("landing.hero.floatingBadge")})]})]})]})})]})},ns=[tt,Pu,Ou,$u,pn,Je,Bu],as=["rgba(59, 130, 246, 0.4)","rgba(168, 85, 247, 0.4)","rgba(34, 197, 94, 0.4)","rgba(249, 115, 22, 0.4)","rgba(99, 102, 241, 0.4)","rgba(99, 102, 241, 0.4)","rgba(236, 72, 153, 0.4)"],sw=()=>{const{t:s}=L(),t=[{icon:ns[0],title:s("landing.features.feature1.title"),description:s("landing.features.feature1.description"),glow:as[0]},{icon:ns[1],title:s("landing.features.feature2.title"),description:s("landing.features.feature2.description"),glow:as[1]},{icon:ns[2],title:s("landing.features.feature3.title"),description:s("landing.features.feature3.description"),glow:as[2]},{icon:ns[3],title:s("landing.features.feature4.title"),description:s("landing.features.feature4.description"),glow:as[3]},{icon:ns[4],title:s("landing.features.feature5.title"),description:s("landing.features.feature5.description"),glow:as[4]},{icon:ns[5],title:s("landing.features.feature6.title"),description:s("landing.features.feature6.description"),glow:as[5]},{icon:ns[6],title:s("landing.features.feature7.title"),description:s("landing.features.feature7.description"),glow:as[6]}];return e.jsx("section",{className:"px-6 py-32 lg:px-8",children:e.jsxs("div",{className:"mx-auto max-w-7xl",children:[e.jsxs("div",{className:"text-center mb-24",children:[e.jsxs(he.h2,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},viewport:{once:!0},className:"text-5xl md:text-7xl lp-heading font-black tracking-tighter text-white mb-6",children:[s("landing.features.title"),e.jsx("span",{className:"lp-gradient-text",children:s("landing.features.titleHighlight")})]}),e.jsx(he.p,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},viewport:{once:!0},transition:{delay:.1},className:"text-lg text-slate-400 font-medium max-w-2xl mx-auto",children:s("landing.features.description")})]}),e.jsx("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-4",children:t.map((n,a)=>e.jsxs(he.div,{initial:{opacity:0,scale:.95},whileInView:{opacity:1,scale:1},viewport:{once:!0},transition:{delay:a*.1,duration:.5},whileHover:{y:-8},className:"lp-glass p-8 rounded-3xl border-white/5 group transition-all duration-500 relative",children:[e.jsx("div",{className:"absolute inset-x-0 bottom-0 h-[2px] opacity-0 group-hover:opacity-100 transition-opacity duration-500",style:{background:`linear-gradient(90deg, transparent, ${n.glow}, transparent)`}}),e.jsxs("div",{className:"mb-8 w-14 h-14 rounded-2xl flex items-center justify-center border border-white/10 relative overflow-hidden group-hover:border-white/20 transition-colors",children:[e.jsx("div",{className:"absolute inset-0 opacity-10 group-hover:opacity-20 transition-opacity",style:{backgroundColor:n.glow}}),e.jsx(n.icon,{className:"h-6 w-6 text-white group-hover:scale-110 transition-transform duration-500"})]}),e.jsx("h3",{className:"mb-4 text-xl font-bold text-slate-100 lp-heading leading-tight",children:n.title}),e.jsx("p",{className:"text-slate-400 text-sm leading-relaxed font-medium",children:n.description})]},n.title))})]})})},nw=()=>{const{t:s}=L(),[t,n]=m.useState([{id:"1",isUser:!0,content:"åˆšåˆšè¯»å®Œäº†ã€Šæ·±åº¦å·¥ä½œã€‹ï¼Œæ„Ÿè§‰è‡ªå·±åœ¨ä»»åŠ¡è§„åˆ’ä¸Šè¿˜æœ‰å¾ˆå¤§æå‡ç©ºé—´ã€‚æƒ³æŠŠé‡Œé¢çš„æ–¹æ³•åº”ç”¨åˆ°ä¸‹å‘¨çš„é¡¹ç›®ä¸­ã€‚",timestamp:new Date},{id:"2",isUser:!1,content:`è¯»å¾—å¥½ï¼ã€Šæ·±åº¦å·¥ä½œã€‹çš„æ ¸å¿ƒåœ¨äºŽä¿æŠ¤ã€Žé«˜ä»·å€¼äº§å‡ºã€ã€‚æˆ‘ä¸ºä½ æ•´ç†äº†ä¸€ä»½ä¸‹å‘¨çš„ã€Žæ·±åº¦å·¥ä½œå®žéªŒæ–¹æ¡ˆã€ï¼š

1. **å°é”æ—¶é—´**ï¼šæ¯å¤©ä¸Šåˆ 9-11 ç‚¹å…³é—­æ‰€æœ‰æŽ¨é€ã€‚
2. **åº¦é‡æŒ‡æ ‡**ï¼šè®°å½•ä½ çš„ã€Žæ·±åº¦æ—¶é—´ã€ï¼Œè€Œä¸æ˜¯ä»»åŠ¡æ•°é‡ã€‚
3. **ä»ªå¼æ„Ÿ**ï¼šä¸ºè¿›å…¥çŠ¶æ€è®¾è®¡ä¸€ä¸ªä¸“å±žåŠ¨ä½œã€‚

éœ€è¦æˆ‘å¸®ä½ æŠŠè¿™äº›åŠ å…¥åˆ° OKR è§„åˆ’ä¸­å—ï¼Ÿ`,timestamp:new Date},{id:"3",isUser:!0,content:"å¥½ä¸»æ„ï¼Œå¸®æˆ‘ç”Ÿæˆä¸€ä»½ç®€å•çš„å‘¨è§„åˆ’å»ºè®®ã€‚",timestamp:new Date},{id:"4",isUser:!1,content:`å·²æ ¹æ®ä½ çš„ç¬”è®°ç”Ÿæˆã€Žæ·±åº¦å·¥ä½œå®žéªŒå‘¨ã€è®¡åˆ’ï¼š

- å‘¨ä¸€ï¼šè¯†åˆ«å¹¶ç§»é™¤çŽ°æœ‰çš„æ²Ÿé€šå¹²æ‰°é¡¹ã€‚
- å‘¨äºŒï¼šåœ¨ Mindmap è§†å›¾ä¸­æ‹†è§£é¡¹ç›®æ ¸å¿ƒéš¾ç‚¹ã€‚
- å‘¨å››ï¼šè¿›è¡Œä¸€æ¬¡ 4 å°æ—¶çš„æ·±åº¦å¼€å‘å†²åˆºã€‚

æˆ‘ä¼šæ¯å¤©æ—©æ™¨æé†’ä½ å½“å¤©çš„æ·±åº¦ç›®æ ‡ã€‚`,timestamp:new Date}]),[a,r]=m.useState(""),[o,i]=m.useState(!1),l=()=>{if(!a.trim())return;const d={id:Date.now().toString(),content:a,isUser:!0,timestamp:new Date};n([...t,d]),r(""),i(!0),setTimeout(()=>{const u={id:(Date.now()+1).toString(),content:`ðŸ’¡ åŸºäºŽä½ çš„è®°å½•ï¼Œæˆ‘ç”Ÿæˆäº†å‡ ä¸ªæ€è€ƒæ–¹å‘ï¼š

â€¢ æ·±åº¦å·¥ä½œçš„æ ¸å¿ƒåŽŸåˆ™æ˜¯ä»€ä¹ˆï¼Ÿ
â€¢ å¦‚ä½•åœ¨æ—¥å¸¸å·¥ä½œä¸­å®žè·µæ·±åº¦å·¥ä½œï¼Ÿ
â€¢ æ·±åº¦å·¥ä½œä¸Žç•ªèŒ„å·¥ä½œæ³•çš„ç»“åˆç‚¹åœ¨å“ªé‡Œï¼Ÿ`,isUser:!1,timestamp:new Date};n(h=>[...h,u]),i(!1)},1500)},c=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),l())};return e.jsx("section",{className:"px-6 py-32 lg:px-8",children:e.jsxs("div",{className:"mx-auto max-w-7xl",children:[e.jsxs("div",{className:"text-center mb-16",children:[e.jsxs(he.h2,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},viewport:{once:!0},className:"text-5xl md:text-7xl lp-heading font-black tracking-tighter text-white",children:[s("landing.demo.title"),e.jsx("span",{className:"lp-gradient-text",children:s("landing.demo.titleHighlight")})]}),e.jsx(he.p,{initial:{opacity:0,y:20},whileInView:{opacity:1,y:0},viewport:{once:!0},transition:{delay:.1},className:"mt-6 text-xl text-slate-400 font-medium",children:s("landing.demo.subtitle")})]}),e.jsxs(he.div,{initial:{opacity:0,y:30},whileInView:{opacity:1,y:0},viewport:{once:!0},className:"mx-auto max-w-4xl",children:[e.jsxs("div",{className:"lp-glass rounded-[2rem] overflow-hidden border-white/5 shadow-2xl",children:[e.jsx("div",{className:"border-b border-white/5 bg-white/5 px-8 py-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex gap-1.5",children:[e.jsx("div",{className:"h-2.5 w-2.5 rounded-full bg-white/10"}),e.jsx("div",{className:"h-2.5 w-2.5 rounded-full bg-white/10"}),e.jsx("div",{className:"h-2.5 w-2.5 rounded-full bg-white/10"})]}),e.jsx("span",{className:"text-sm font-bold text-slate-400 tracking-widest uppercase",children:s("landing.demo.channelName")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-2 w-2 rounded-full bg-blue-500 animate-pulse"}),e.jsx("span",{className:"text-[10px] font-bold text-blue-400 uppercase tracking-widest",children:s("landing.demo.aiStatus")})]})]})}),e.jsxs("div",{className:"h-[500px] overflow-y-auto p-8 space-y-6 bg-slate-900/40",children:[e.jsx(Dr,{children:t.map(d=>e.jsx(he.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:`flex ${d.isUser?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[85%] rounded-[1.5rem] px-6 py-4 border ${d.isUser?"bg-blue-600/20 border-blue-500/30 text-slate-100 rounded-tr-sm":"bg-white/5 border-white/10 text-slate-300 rounded-tl-sm"}`,children:e.jsx("p",{className:"whitespace-pre-line text-sm leading-relaxed font-medium",children:d.content})})},d.id))}),o&&e.jsx(he.div,{initial:{opacity:0},animate:{opacity:1},className:"flex justify-start",children:e.jsx("div",{className:"max-w-[80%] rounded-2xl bg-gray-100 px-4 py-3",children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(he.div,{animate:{opacity:[.4,1,.4]},transition:{duration:1,repeat:1/0,delay:0},className:"h-2 w-2 rounded-full bg-gray-400"}),e.jsx(he.div,{animate:{opacity:[.4,1,.4]},transition:{duration:1,repeat:1/0,delay:.2},className:"h-2 w-2 rounded-full bg-gray-400"}),e.jsx(he.div,{animate:{opacity:[.4,1,.4]},transition:{duration:1,repeat:1/0,delay:.4},className:"h-2 w-2 rounded-full bg-gray-400"})]})})})]}),e.jsx("div",{className:"border-t border-white/5 bg-white/5 p-6",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx("input",{type:"text",value:a,onChange:d=>r(d.target.value),onKeyPress:c,placeholder:s("landing.demo.inputPlaceholder"),className:"flex-1 rounded-2xl border border-white/10 bg-slate-900/50 px-6 py-3 text-sm text-slate-100 placeholder:text-slate-500 focus:border-blue-500/50 focus:outline-none focus:ring-4 focus:ring-blue-500/10 transition-all"}),e.jsx("button",{onClick:l,disabled:!a.trim(),className:"lp-button-primary w-12 h-12 rounded-2xl flex items-center justify-center text-white p-0",children:e.jsx(fa,{className:"h-5 w-5"})}),e.jsx("button",{className:"w-12 h-12 rounded-2xl border border-white/10 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/5 transition-all",children:e.jsx(tt,{className:"h-5 w-5"})})]})})]}),e.jsx("p",{className:"mt-8 text-center text-sm text-slate-500 font-bold uppercase tracking-widest",children:s("landing.demo.hint")})]})]})})},aw=()=>{const{t:s}=L();return e.jsx("section",{className:"px-6 py-32 lg:px-8",children:e.jsx("div",{className:"mx-auto max-w-7xl",children:e.jsxs(he.div,{initial:{opacity:0,y:30},whileInView:{opacity:1,y:0},viewport:{once:!0},className:"relative overflow-hidden rounded-[3rem] lp-glass p-12 lg:p-24 text-center border-white/10 shadow-3xl",children:[e.jsx("div",{className:"absolute top-0 right-0 w-[50%] h-[50%] bg-blue-500/10 blur-[100px] pointer-events-none"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-[50%] h-[50%] bg-purple-600/10 blur-[100px] pointer-events-none"}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("h2",{className:"text-5xl md:text-7xl lp-heading font-black tracking-tighter text-white mb-8 leading-tight",children:[s("landing.cta.title"),e.jsx("br",{}),e.jsx("span",{className:"lp-gradient-text",children:s("landing.cta.titleHighlight")})]}),e.jsx("p",{className:"text-xl text-slate-400 mb-12 max-w-2xl mx-auto font-medium leading-relaxed",children:s("landing.cta.description")}),e.jsxs("div",{className:"flex flex-col items-center gap-6 sm:flex-row sm:justify-center mb-16",children:[e.jsx("button",{className:"lp-button-primary px-12 py-5 rounded-full text-white font-bold text-xl shadow-2xl transition-all hover:scale-105 active:scale-95",children:s("landing.cta.primaryButton")}),e.jsx("button",{className:"px-10 py-5 border border-white/10 text-slate-300 font-bold rounded-full text-xl hover:bg-white/5 transition-all",children:s("landing.cta.secondaryButton")})]}),e.jsx("div",{className:"grid gap-8 sm:grid-cols-2 lg:grid-cols-4 border-t border-white/5 pt-12",children:[s("landing.cta.benefit1"),s("landing.cta.benefit2"),s("landing.cta.benefit3"),s("landing.cta.benefit4")].map(t=>e.jsxs("div",{className:"flex items-center justify-center gap-3 text-slate-400",children:[e.jsx("div",{className:"w-5 h-5 rounded-full bg-blue-500/20 flex items-center justify-center border border-blue-500/30",children:e.jsx(Xe,{className:"w-3 h-3 text-blue-400"})}),e.jsx("span",{className:"text-sm font-bold uppercase tracking-widest",children:t})]},t))})]})]})})})},rw=()=>{const{t:s}=L(),t={product:[{name:s("landing.footer.product.features"),href:"#features"},{name:s("landing.footer.product.useCases"),href:"#use-cases"},{name:s("landing.footer.product.pricing"),href:"#pricing"},{name:s("landing.footer.product.changelog"),href:"#changelog"}],support:[{name:s("landing.footer.support.docs"),href:"#docs"},{name:s("landing.footer.support.api"),href:"#api"},{name:s("landing.footer.support.community"),href:"#community"},{name:s("landing.footer.support.contact"),href:"#contact"}],company:[{name:s("landing.footer.company.about"),href:"#about"},{name:s("landing.footer.company.blog"),href:"#blog"},{name:s("landing.footer.company.privacy"),href:"#privacy"},{name:s("landing.footer.company.terms"),href:"#terms"}],social:[{name:"GitHub",href:"https://github.com/Peiiii/EchoNote",icon:Ri},{name:"Twitter",href:"#",icon:Uu},{name:"Email",href:"mailto:contact@stillroot.app",icon:_i}]};return e.jsx("footer",{className:"border-t border-white/5 pt-24 pb-12",children:e.jsxs("div",{className:"mx-auto max-w-7xl px-6 py-12 lg:px-8 lg:py-16",children:[e.jsxs("div",{className:"grid gap-8 lg:grid-cols-4",children:[e.jsxs("div",{className:"lg:col-span-1",children:[e.jsx("h3",{className:"text-2xl font-black text-white lp-heading tracking-tighter uppercase",children:s("landing.footer.brand")}),e.jsx("p",{className:"mt-6 text-sm text-slate-400 font-medium leading-relaxed max-w-xs",children:s("landing.footer.description")})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-[10px] font-bold text-slate-500 uppercase tracking-widest text-white/40",children:s("landing.footer.product.label")}),e.jsx("ul",{className:"mt-4 space-y-2",children:t.product.map(n=>e.jsx("li",{children:e.jsx("a",{href:n.href,className:"text-sm text-slate-400 hover:text-white transition-colors font-medium",children:n.name})},n.name))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-[10px] font-bold text-slate-500 uppercase tracking-widest text-white/40",children:s("landing.footer.support.label")}),e.jsx("ul",{className:"mt-4 space-y-2",children:t.support.map(n=>e.jsx("li",{children:e.jsx("a",{href:n.href,className:"text-sm text-slate-400 hover:text-white transition-colors font-medium",children:n.name})},n.name))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-[10px] font-bold text-slate-500 uppercase tracking-widest text-white/40",children:s("landing.footer.company.label")}),e.jsx("ul",{className:"mt-4 space-y-2",children:t.company.map(n=>e.jsx("li",{children:e.jsx("a",{href:n.href,className:"text-sm text-slate-400 hover:text-white transition-colors font-medium",children:n.name})},n.name))})]})]}),e.jsx("div",{className:"mt-24 border-t border-white/5 pt-12",children:e.jsxs("div",{className:"flex flex-col items-center justify-between gap-6 sm:flex-row",children:[e.jsx("p",{className:"text-[10px] text-slate-500 font-bold tracking-widest uppercase",children:s("landing.footer.copyright",{year:new Date().getFullYear()})}),e.jsx("div",{className:"flex gap-6",children:t.social.map(n=>e.jsxs("a",{href:n.href,className:"w-10 h-10 rounded-full border border-white/5 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/5 hover:border-white/20 transition-all font-bold",target:"_blank",rel:"noopener noreferrer",children:[e.jsx("span",{className:"sr-only",children:n.name}),e.jsx(n.icon,{className:"h-4 w-4"})]},n.name))})]})})]})})},bi=()=>e.jsxs("div",{className:"min-h-screen lp-mesh-bg text-slate-900 dark:text-slate-50 selection:bg-blue-500/30 selection:text-blue-200 overflow-x-hidden antialiased",children:[e.jsx(tw,{}),e.jsx(nw,{}),e.jsx(sw,{}),e.jsx(aw,{}),e.jsx(rw,{})]}),ow=()=>e.jsxs(ba,{children:[e.jsx(Is,{path:"/",element:e.jsx(bi,{})}),e.jsx(Is,{path:"/v2",element:e.jsx(bi,{})}),e.jsx(Is,{path:"*",element:e.jsx(Pr,{to:"/",replace:!0})})]}),iw=()=>{const{currentBreakpoint:s}=ll(),{user:t}=ja(),n=m.useRef(Date.now()),a=J(i=>i.setAuth),o=_r().pathname.startsWith("/landing");return m.useEffect(()=>{a(t)},[t,a]),m.useEffect(()=>{const i=s==="sm"?hr.MOBILE:hr.DESKTOP;return De.logAppStart(i,"1.0.0"),()=>{const l=Date.now()-n.current;De.logAppClose(l)}},[s]),o?e.jsxs(e.Fragment,{children:[e.jsx(ba,{children:e.jsx(Is,{path:"/landing/*",element:e.jsx(ow,{})})}),e.jsx(Mo,{})]}):e.jsxs(e.Fragment,{children:[e.jsx(ew,{}),e.jsx(Jv,{}),s==="sm"?e.jsx(Yv,{}):e.jsx(dv,{}),e.jsx(Mo,{}),e.jsx(Bh,{}),e.jsx(_h,{}),e.jsx(Ph,{})]})};class lw{auth;constructor(t){const n=new Nh({tokenRequestMethod:"url",httpClient:{fetch:async(a,r)=>{if(a.includes("github.com/login/oauth/access_token")){const o=`https://proxy.agentverse.cc/?${a}`;return fetch(o,r)}return fetch(a,r)}}});this.auth=new Ch(n,{clientId:t.clientId,clientSecret:t.clientSecret,redirectUri:t.redirectUri,scopes:t.scopes||["repo","user"]})}async startAuth(){const t=kh(32);return sessionStorage.setItem("github_auth_state",t),await this.auth.startAuth({state:t})}async handleCallback(t){const{code:n,state:a,error:r}=Sh(t);if(console.log("[GitHubAuthService][handleCallback] code",{code:n,url:t}),r)throw new Error(`GitHub authentication failed: ${r}`);if(!n)throw new Error("Authorization code not received");const o=sessionStorage.getItem("github_auth_state");if(!o||a!==o)throw new Error("State parameter validation failed, possible CSRF attack");try{const i=await this.auth.handleCallback(n,a);return console.log("[GitHubAuthService][handleCallback] result",i),sessionStorage.removeItem("github_auth_state"),this.saveAuthResult(i),i}catch(i){throw new Error(`Failed to handle authentication callback: ${i instanceof Error?i.message:"Unknown error"}`)}}getAuthStatus(){const t=localStorage.getItem("github_auth");if(!t)return null;try{const n=JSON.parse(t),a=Date.now(),r=n.createdAt+n.expiresIn*1e3;return a>=r?(this.clearAuth(),null):n}catch{return this.clearAuth(),null}}isAuthenticated(){return this.getAuthStatus()!==null}getAccessToken(){return this.getAuthStatus()?.accessToken||null}getUserInfo(){return this.getAuthStatus()?.user||null}logout(){this.clearAuth()}saveAuthResult(t){localStorage.setItem("github_auth",JSON.stringify(t))}clearAuth(){localStorage.removeItem("github_auth"),sessionStorage.removeItem("github_auth_state")}}function cw(s){new lw({...s})}const Ys={oauth:{clientId:"Ov23liDcQnnEXXktUGbS",clientSecret:"",redirectUri:"https://memol.dimstack.com/",scopes:["repo","user","workflow"]},storage:{defaultBranch:"main",basePath:"data"},api:{baseUrl:"https://api.github.com",timeout:3e4},features:{autoSync:!0,conflictResolution:!0,backupEnabled:!0}};try{Ys.oauth.clientId&&(cw({clientId:Ys.oauth.clientId,clientSecret:Ys.oauth.clientSecret,redirectUri:Ys.oauth.redirectUri,scopes:Ys.oauth.scopes}),console.log("âœ… GitHubè®¤è¯æœåŠ¡åˆå§‹åŒ–æˆåŠŸ"))}catch(s){console.warn("âš ï¸ GitHubè®¤è¯æœåŠ¡åˆå§‹åŒ–å¤±è´¥:",s)}await Hg();Yc.createRoot(document.getElementById("root")).render(e.jsx(m.StrictMode,{children:e.jsx(da,{children:e.jsx(Th,{children:e.jsx(Dh,{children:e.jsx(Lh,{children:e.jsx(vm,{children:e.jsx(iw,{})})})})})})}));
