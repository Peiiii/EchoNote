import{r as o,j as s,R as G}from"./react-vendor-oUiNwJXW.js";import{M as le,r as ie,a as ce,b as de}from"./markdown-DNcxNCP-.js";import{t as ue,c as $,a as he}from"./ui-utils-CjxovF-h.js";import{S as me,R as ee,I as te,F as se}from"./radix-CQ9ZHnUk.js";import{v as U}from"./pkg-uuid-BKrj-4V8.js";import{B as X,S as B}from"./rxjs-BbPesVBQ.js";import{L as fe,S as ge,a as xe,b as pe,T as be,c as ve,R as we,C as ye,U as Ce,B as je,A as Ne,M as Te,d as ke,X as Ae,e as Re,f as Me}from"./icons-XQA4Ujzv.js";import{h as K,v as q}from"./pkg-react-syntax-highlighter-C3NDNpqQ.js";function J(e){const[r,t]=o.useState(e.getValue());return o.useEffect(()=>{const a=e.subscribe(t);return()=>a.unsubscribe()},[e]),r}const Se=(e,r)=>{const[t,a]=o.useState(r);return o.useEffect(()=>{const n=e.subscribe(a);return()=>n.unsubscribe()},[e]),t};let M=(function(e){return e.CALL="call",e.RESULT="result",e.PARTIAL_CALL="partial-call",e.ERROR="error",e.CANCELLED="cancelled",e})({}),E=(function(e){return e.TEXT_START="TEXT_START",e.TEXT_DELTA="TEXT_DELTA",e.TEXT_END="TEXT_END",e.TOOL_CALL_START="TOOL_CALL_START",e.TOOL_CALL_ARGS="TOOL_CALL_ARGS",e.TOOL_CALL_ARGS_DELTA="TOOL_CALL_ARGS_DELTA",e.TOOL_CALL_END="TOOL_CALL_END",e.TOOL_CALL_RESULT="TOOL_CALL_RESULT",e.RUN_STARTED="RUN_STARTED",e.RUN_FINISHED="RUN_FINISHED",e.RUN_ERROR="RUN_ERROR",e})({});var Le=e=>{try{return JSON.parse(e)}catch{return}};const Y=e=>({toolCallId:e.id,toolName:e.function.name,args:e.function.arguments,parsedArgs:Le(e.function.arguments),status:M.CALL});function Ee(e,r){const t={error:"tool_call_interrupted",note:"User continued before tool produced a result."};return e.map(a=>a.parts?.length?{...a,parts:a.parts.map(n=>{if(n.type!=="tool-invocation"||![M.CALL,M.PARTIAL_CALL].includes(n.toolInvocation.status))return n;let l;if(typeof n.toolInvocation.args=="string")try{l=JSON.parse(n.toolInvocation.args)}catch{return{...n,toolInvocation:{...n.toolInvocation,args:JSON.stringify({}),parsedArgs:l,status:M.RESULT,result:{error:"invalid_args",raw:n.toolInvocation.args}}}}return{...n,toolInvocation:{...n.toolInvocation,args:n.toolInvocation.args,parsedArgs:l,status:M.RESULT,result:t}}})}:a)}var Ie=class{disposables=[];addDisposable=e=>{this.disposables.push(e)};dispose=()=>{this.disposables.forEach(e=>e()),this.disposables=[]}},_e=class extends Ie{_messages$=new X([]);messages$;threadId$=new X(null);isAgentResponding$=new X(!1);agentRunSubscriptionRef=o.createRef();addMessagesEvent$=new B;updateMessageEvent$=new B;setMessagesEvent$=new B;toolCall$=new B;eventHandler=new De(this);constructor(e,r){super(),this.agentProvider=e;const{initialMessages:t=[]}=r||{};this._messages$.next(t),this.messages$=this._messages$.asObservable(),this.addDisposable(this.connectToolExecutor())}getMessages=()=>this._messages$.getValue();setMessages=e=>{this._messages$.next(e),this.setMessagesEvent$.next({messages:e})};handleEvent=e=>{this.eventHandler.handleEvent(e)};reset=()=>{this._messages$.next([]),this.eventHandler.reset(),this.threadId$.next(null),this.isAgentResponding$.next(!1),this.abortAgentRun()};addMessages=e=>{this._messages$.next([...this.getMessages(),...e]),this.addMessagesEvent$.next({messages:e})};removeMessages=e=>{e.length!==0&&this._messages$.next(this.getMessages().filter(r=>!e.includes(r.id)))};updateMessage=e=>{this._messages$.next(this.getMessages().map(r=>r.id===e.id?e:r)),this.updateMessageEvent$.next({message:e})};addToolResult=(e,r)=>{const t=this.getMessages().find(n=>n.parts.find(l=>l.type==="tool-invocation"&&l.toolInvocation.toolCallId===e.toolCallId));if(!t)return;const a={...t,parts:t.parts.map(n=>n.type==="tool-invocation"&&n.toolInvocation.toolCallId===e.toolCallId?{...n,toolInvocation:{...n.toolInvocation,result:e.result??void 0,status:e.status,error:e.error??void 0,cancelled:e.cancelled??void 0}}:n)};this.updateMessage(a)};handleAgentResponse=e=>{this.agentRunSubscriptionRef.current&&this.agentRunSubscriptionRef.current.unsubscribe(),this.agentRunSubscriptionRef.current=e.subscribe(r=>{this.handleEvent(r),(r.type===E.RUN_FINISHED||r.type===E.RUN_ERROR)&&(this.isAgentResponding$.next(!1),this.agentRunSubscriptionRef.current=null)})};abortAgentRun=()=>{this.agentProvider.agent.abortRun?.(),this.agentRunSubscriptionRef.current&&(this.agentRunSubscriptionRef.current.unsubscribe(),this.agentRunSubscriptionRef.current=null,this.isAgentResponding$.next(!1))};runAgent=async()=>{this.isAgentResponding$.next(!0);try{const e=Ee(this.getMessages()),r=await this.agentProvider.agent.run({threadId:this.threadId$.getValue()??"",runId:U(),messages:e,tools:this.agentProvider.getToolDefs(),context:this.agentProvider.getContexts()});this.handleAgentResponse(r)}catch(e){e?.name==="AbortError"?console.info("Agent run aborted"):console.error("Error running agent:",e),this.isAgentResponding$.next(!1)}};handleAddToolResult=async(e,r)=>{const{triggerAgent:t=!0}=r||{};await this.addToolResult(e,{triggerAgent:t}),t&&await this.runAgent()};handleAddMessages=async(e,r)=>{const{triggerAgent:t=!0}=r||{};console.log("[useAgentChat] addMessages",e);try{this.addMessages(e),t&&await this.runAgent()}catch(a){console.error("Error adding messages:",a),t&&this.isAgentResponding$.next(!1)}};handleSendMessage=async e=>{e.trim()&&(this.addMessages([{id:U(),role:"user",parts:[{type:"text",text:e}]}]),await this.runAgent())};connectToolExecutor=()=>{const e=this.toolCall$.subscribe(async({toolCall:r})=>{const t=this.agentProvider.getToolExecutor(r.function.name);if(t)try{const a=JSON.parse(r.function.arguments),n=await t(a);this.addToolResult({toolCallId:r.id,result:n,status:M.RESULT}),this.runAgent()}catch(a){console.error("[AgentSessionManager] handleAddToolResult error",a),this.addToolResult({toolCallId:r.id,error:a instanceof Error?a.message:String(a),status:M.ERROR}),this.runAgent()}});return()=>e.unsubscribe()}},De=class{currentMessageId;currentMessageContent="";currentToolCallId;currentToolCallName;currentToolCallArgs="";emittedToolCallIds=new Set;constructor(e){this.sessionManager=e}reset(){this.currentMessageId=void 0,this.currentMessageContent="",this.currentToolCallId=void 0,this.currentToolCallName=void 0,this.currentToolCallArgs="",this.emittedToolCallIds.clear()}emitToolCallEvents(){const e=this.sessionManager.getMessages(),r=e[e.length-1];if(!(!r||r.role!=="assistant"||!r.parts))for(const t of r.parts){if(t.type!=="tool-invocation")continue;const a=t.toolInvocation;a.status===M.CALL&&!this.emittedToolCallIds.has(a.toolCallId)&&(this.emittedToolCallIds.add(a.toolCallId),this.sessionManager.toolCall$.next({toolCall:{id:a.toolCallId,type:"function",function:{name:a.toolName,arguments:a.args}}}))}}handleEvent(e){switch(console.log("[AgentSessionManager] event",e),e.type){case E.RUN_STARTED:break;case E.TEXT_START:this.handleTextStart(e);break;case E.TEXT_DELTA:this.handleTextContent(e);break;case E.TEXT_END:this.handleTextEnd();break;case E.TOOL_CALL_START:this.handleToolCallStart(e);break;case E.TOOL_CALL_ARGS_DELTA:this.handleToolCallArgsDelta(e);break;case E.TOOL_CALL_ARGS:this.handleToolCallArgs(e);break;case E.TOOL_CALL_END:this.handleToolCallEnd(),this.emitToolCallEvents();break;default:console.info("Unknown event type:",e.type);break}}handleTextStart(e){this.currentMessageId=e.messageId,this.currentMessageContent=""}updateTextPart(e,r){const t=e.parts?.[e.parts.length-1];return t&&t.type==="text"?{...e,parts:[...e.parts.slice(0,-1)||[],{type:"text",text:r}]}:{...e,parts:[...e.parts||[],{type:"text",text:r}]}}handleTextContent(e){if(!e.delta||this.currentMessageId!==e.messageId)return;this.currentMessageContent+=e.delta;const r=this.currentMessageContent,t=this.currentMessageId,a=this.sessionManager.getMessages(),n=a[a.length-1];n&&n.role==="assistant"&&n.id===t?this.sessionManager.updateMessage(this.updateTextPart(n,r)):this.sessionManager.addMessages([{id:t,role:"assistant",parts:[{type:"text",text:r}]}])}handleTextEnd(){this.currentMessageId=void 0,this.currentMessageContent=""}handleToolCallStart(e){this.currentToolCallId=e.toolCallId,this.currentToolCallName=e.toolName,this.currentToolCallArgs="";const r=this.sessionManager.getMessages(),t=r[r.length-1],a={type:"tool-invocation",toolInvocation:{status:M.PARTIAL_CALL,toolCallId:this.currentToolCallId,toolName:this.currentToolCallName,args:""}};t&&t.role==="assistant"?this.sessionManager.updateMessage({...t,parts:[...t.parts||[],a]}):this.sessionManager.addMessages([{id:U(),role:"assistant",parts:[a]}])}handleToolCallArgsDelta(e){if(this.currentToolCallId!==e.toolCallId)return;this.currentToolCallArgs+=e.argsDelta;const r=this.sessionManager.getMessages(),t=r[r.length-1];if(!t||t.role!=="assistant"||!t.parts?.length)return;const a=[...t.parts];for(let n=a.length-1;n>=0;n--){const l=a[n];if(l.type==="tool-invocation"&&l.toolInvocation.toolCallId===e.toolCallId){let d;try{d=JSON.parse(this.currentToolCallArgs)}catch{}a[n]={...l,toolInvocation:{...l.toolInvocation,status:M.PARTIAL_CALL,args:this.currentToolCallArgs,parsedArgs:d}};break}}this.sessionManager.updateMessage({...t,parts:a})}handleToolCallArgs(e){this.currentToolCallId===e.toolCallId&&(this.currentToolCallArgs=e.args,this.handleToolCallArgsDelta({type:E.TOOL_CALL_ARGS_DELTA,toolCallId:e.toolCallId,argsDelta:""}))}handleToolCallEnd(){if(!(!this.currentToolCallId||!this.currentToolCallName)){try{const e={id:this.currentToolCallId,type:"function",function:{name:this.currentToolCallName,arguments:this.currentToolCallArgs}},r=this.sessionManager.getMessages(),t=r[r.length-1];if(t&&t.role==="assistant"){const a=[...t.parts||[]];for(let n=a.length-1;n>=0;n--){const l=a[n];if(l.type==="tool-invocation"&&l.toolInvocation.toolCallId===this.currentToolCallId){a[n]={...l,toolInvocation:{...Y(e),status:M.CALL}};break}}this.sessionManager.updateMessage({...t,parts:a})}else this.sessionManager.addMessages([{id:U(),role:"assistant",parts:[{type:"tool-invocation",toolInvocation:{...Y(e),status:M.CALL}}]}])}catch(e){console.error("Error parsing tool call args:",e)}this.currentToolCallId=void 0,this.currentToolCallName=void 0,this.currentToolCallArgs=""}}};const V=e=>{const r=o.useRef(null),t=o.useRef(e);return t.current=e,r.current||(r.current=((...a)=>t.current(...a))),r.current},ut=e=>{const{agent:r,getToolDefs:t,getContexts:a,initialMessages:n,getToolExecutor:l}=e,d=V(t),u=V(a),i=V(l);return o.useRef(new _e({agent:r,getToolDefs:d,getContexts:u,getToolExecutor:i},{initialMessages:n})).current},Oe=e=>{const r=Se(e.messages$,e.getMessages()),t=J(e.isAgentResponding$),a=J(e.threadId$);return{messages:r,isAgentResponding:t,threadId:a}},Pe=(e={})=>{const{maxAttachments:r=5,validateFile:t,classifyAttachment:a,onAppendText:n}=e,[l,d]=o.useState(!1),[u,i]=o.useState(),[m,p]=o.useState([]),[b,g]=o.useState(!1),x=o.useRef(null),v=o.useRef([]),S=o.useCallback(N=>{const T=[];for(const f of N){if(t&&!t(f))continue;const L=a?a(f):f.type.startsWith("image/")?"image":"file";T.push({id:`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,type:L,name:f.name,size:f.size,file:f})}T.length!==0&&p(f=>[...f,...T].slice(0,r))},[r,t,a]),C=o.useCallback(N=>{p(T=>T.filter(f=>f.id!==N))},[]),k=o.useCallback(()=>{p([])},[]),A=o.useCallback(async()=>{try{const N=await navigator.mediaDevices.getUserMedia({audio:!0}),T=new MediaRecorder(N);x.current=T,v.current=[],T.ondataavailable=f=>{f.data.size>0&&v.current.push(f.data)},T.onstop=()=>{const f=new Blob(v.current,{type:"audio/wav"});i(f),N.getTracks().forEach(L=>L.stop())},T.start(),d(!0)}catch(N){console.error("Error starting voice recording:",N)}},[]),y=o.useCallback(()=>{x.current&&l&&(x.current.stop(),d(!1))},[l]),D=o.useCallback(N=>{n&&n(N),g(!1)},[n]),z=o.useCallback(()=>{p([]),i(void 0),g(!1),d(!1)},[]);return[{isVoiceRecording:l,audioBlob:u,attachments:m,showEmojiPicker:b},{startVoiceRecording:A,stopVoiceRecording:y,setAudioBlob:i,addAttachments:S,removeAttachment:C,clearAttachments:k,setShowEmojiPicker:g,insertEmoji:D,reset:z}]};function _(...e){return ue($(e))}var ze=he("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function P({className:e,variant:r,size:t,asChild:a=!1,...n}){return s.jsx(a?me:"button",{"data-slot":"button",className:_(ze({variant:r,size:t,className:e})),...n})}const Fe=({input:e,onInputChange:r,onSend:t,isAgentResponding:a,onAbort:n,placeholder:l="Type a message...",isProcessing:d=!1,processingMessage:u="Processing...",variant:i="default",size:m="md",inputExtensions:p=[],insideLeftSlot:b,insideRightSlot:g,headerLeftSlot:x,headerRightSlot:v,footerLeftSlot:S,footerRightSlot:C})=>{const k=o.useRef(null),A=o.useRef(!1),y=o.useCallback(()=>{const h=k.current;if(!h)return;h.style.height="auto";const I=m==="sm"?120:m==="lg"?300:200,R=window.getComputedStyle(h),c=parseInt(R.lineHeight)||24,j=parseInt(R.paddingTop)||8,w=parseInt(R.paddingBottom)||8,H=c+j+w,W=h.scrollHeight,oe=Math.max(H,Math.min(W,I));h.style.height=`${oe}px`,h.style.overflowY=W>I?"auto":"hidden"},[m]);o.useLayoutEffect(()=>{y()},[e,y]);const D=h=>{r(h.target.value)},z=h=>{const I=h.key==="Enter",R=(h.metaKey||h.ctrlKey)&&I;(I&&!h.shiftKey&&!h.altKey&&!h.metaKey&&!h.ctrlKey||R)&&!A.current&&(h.preventDefault(),!a&&e.trim()&&t()),h.key==="Escape"&&a&&n&&(h.preventDefault(),n())},N=()=>{A.current=!0},T=()=>{A.current=!1},f=e.trim().length>0&&!a&&!d,L=()=>{switch(i){case"minimal":return"border-0 bg-transparent shadow-none focus-within:ring-0";case"glass":return"bg-background/80 backdrop-blur-md border-border/70 shadow-lg";default:return"bg-background/95 backdrop-blur-sm border-border/80 shadow-sm"}},O=()=>{switch(m){case"sm":return"px-3 py-2 text-sm";case"lg":return"px-4 py-3 text-base";default:return"px-3 py-2.5 text-sm"}};return s.jsx("div",{className:"w-full space-y-2",children:s.jsxs("div",{className:_("relative w-full rounded-xl border transition-all duration-200","max-h-[60vh] overflow-hidden flex flex-col",L(),O()),children:[(x||v)&&s.jsx("div",{className:"px-3 pt-3 pb-2",children:s.jsxs("div",{className:"flex items-center gap-2 gap-y-1 flex-wrap",children:[s.jsx("div",{className:"flex items-center gap-2",children:x}),s.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[v,d&&s.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[s.jsx(fe,{className:"h-3 w-3 animate-spin"}),u]})]})]})}),s.jsxs("div",{className:"relative pt-3 flex-1 min-h-0",children:[b&&s.jsx("div",{className:"absolute left-3 top-1/2 -translate-y-1/2 z-10",children:b}),s.jsx("textarea",{ref:k,value:e,onChange:D,onKeyDown:z,onCompositionStart:N,onCompositionEnd:T,placeholder:l,rows:1,"aria-label":"Message input","aria-multiline":"true","aria-busy":a,className:_("w-full resize-none bg-transparent text-foreground","placeholder:text-muted-foreground outline-none","disabled:cursor-not-allowed disabled:opacity-50",b?"pl-10":"pl-3","py-2"),style:{minHeight:"40px",height:"40px"}})]}),s.jsxs("div",{className:"flex items-center justify-between py-2 text-xs text-muted-foreground flex-shrink-0",children:[s.jsx("div",{className:"flex items-center gap-2 flex-nowrap whitespace-nowrap overflow-x-auto",children:S}),s.jsxs("div",{className:"flex items-center gap-1 flex-nowrap whitespace-nowrap overflow-x-auto",children:[p.map(h=>{const I={draft:{text:e,meta:{}},setDraft:R=>{if(typeof R=="function"){const c=R({text:e,meta:{}});c.text!==void 0&&r(c.text)}else R.text!==void 0&&r(R.text)},isAgentResponding:a,requestAbort:n};return s.jsx(o.Fragment,{children:h.render(I)},h.id)}),a?s.jsx(P,{variant:"ghost",size:"icon",onClick:h=>{h.preventDefault(),h.stopPropagation(),n?.()},title:"Stop (Esc)",className:"h-8 w-8 rounded-full text-muted-foreground hover:text-foreground hover:bg-accent/50 active:scale-95",children:s.jsx(xe,{className:"h-4 w-4"})}):s.jsx(P,{variant:f?"default":"ghost",size:"icon",onClick:t,disabled:!f,title:"Send (Enter)",className:_("h-8 w-8 rounded-full transition-all duration-150",f?"shadow-sm hover:shadow-md active:scale-95":"text-muted-foreground"),children:s.jsx(ge,{className:"h-4 w-4"})}),g&&s.jsx("div",{className:"ml-1 flex items-center",children:g}),C&&s.jsx("div",{className:"flex items-center",children:C})]})]})]})})};function $e({threshold:e=10,deps:r=[]}={}){const t=o.useRef(null),[a,n]=o.useState(!0),l=o.useRef(0),d=o.useCallback(()=>{const i=t.current;i&&(i.scrollTop=i.scrollHeight)},[]),u=o.useCallback(()=>{const i=t.current;if(!i)return;const m=i.scrollHeight-i.scrollTop-i.clientHeight;n(m<=e)},[e]);return o.useEffect(()=>{a&&d(),t.current&&(l.current=t.current.scrollHeight)},r),o.useEffect(()=>{if(!a)return;const i=t.current;if(!i)return;let m=null;const p=()=>{i&&(i.scrollHeight!==l.current&&(d(),l.current=i.scrollHeight),m=requestAnimationFrame(p))};return m=requestAnimationFrame(p),()=>{m&&cancelAnimationFrame(m)}},[a,d]),o.useEffect(()=>{const i=t.current;if(i)return i.addEventListener("scroll",u),()=>{i.removeEventListener("scroll",u)}},[u]),{containerRef:t,isSticky:a,scrollToBottom:d,setSticky:n}}const He=e=>s.jsx(Fe,{...e}),Be=({content:e})=>{const r=o.useMemo(()=>({pre({children:t}){const a=Array.isArray(t)?t[0]:t;if(o.isValidElement(a)&&a.type==="code"){const n=a,l=n.props.className,d=/language-(\w+)/.exec(l||""),u=o.Children.toArray(n.props.children).map(i=>typeof i=="string"?i:"").join("").replace(/\n$/,"");return d?s.jsx(K,{style:q,language:d[1],PreTag:"div",className:"rounded-lg my-2 overflow-auto w-full max-w-full min-w-0",wrapLongLines:!0,customStyle:{whiteSpace:"pre",overflowX:"auto",overflowY:"auto",maxWidth:"100%"},children:u}):s.jsx("pre",{className:"rounded-lg my-2 overflow-x-auto overflow-y-auto w-full max-w-full min-w-0 bg-muted p-2",style:{maxWidth:"100%",overflowX:"auto"},children:s.jsx("code",{className:"text-sm whitespace-pre break-normal",style:{overflowWrap:"anywhere",wordBreak:"break-word"},children:u})})}return s.jsx("pre",{className:"rounded-lg my-2 overflow-x-auto overflow-y-auto w-full max-w-full min-w-0 bg-muted p-2",style:{maxWidth:"100%",overflowX:"auto"},children:t})},code(t){const{inline:a,className:n,children:l}=t,d=n||"",u=o.Children.toArray(l).map(m=>typeof m=="string"?m:"").join("").replace(/\n$/,"");if(a||!/language-/.test(d))return s.jsx("code",{className:"bg-muted px-1.5 py-0.5 rounded text-sm break-words align-baseline",style:{overflowWrap:"anywhere",wordBreak:"break-word",display:"inline",whiteSpace:"normal"},children:l});const i=/language-(\w+)/.exec(d);return i?s.jsx(K,{style:q,language:i[1],PreTag:"div",className:"rounded-lg my-2 overflow-auto w-full max-w-full min-w-0",wrapLongLines:!0,customStyle:{whiteSpace:"pre",overflowX:"auto",overflowY:"auto",maxWidth:"100%"},children:u}):s.jsx("pre",{className:"rounded-lg my-2 overflow-x-auto overflow-y-auto w-full max-w-full min-w-0 bg-muted p-2",style:{maxWidth:"100%",overflowX:"auto"},children:s.jsx("code",{className:"text-sm whitespace-pre break-normal",style:{overflowWrap:"anywhere",wordBreak:"break-word"},children:u})})},p({children:t,...a}){return s.jsx("p",{className:"mb-2 leading-relaxed break-words",...a,children:t})},h1({children:t}){return s.jsx("h1",{className:"text-2xl font-bold mt-6 mb-4",children:t})},h2({children:t}){return s.jsx("h2",{className:"text-xl font-bold mt-6 mb-4",children:t})},h3({children:t}){return s.jsx("h3",{className:"text-lg font-bold mt-6 mb-4",children:t})},ul({children:t}){return s.jsx("ul",{className:"list-disc pl-6 mb-4",children:t})},ol({children:t}){return s.jsx("ol",{className:"list-decimal pl-6 mb-4",children:t})},li({children:t}){return s.jsx("li",{className:"mb-1 leading-relaxed break-words",children:t})},a({href:t,children:a}){return s.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline",children:a})},blockquote({children:t}){return s.jsx("blockquote",{className:"border-l-4 border-border pl-4 my-4 py-1 bg-muted rounded-r",children:t})},table({children:t}){return s.jsx("div",{className:"overflow-x-auto my-4 mb-2 rounded-lg border border-border shadow-sm",children:s.jsx("table",{className:"w-full border-collapse",children:t})})},thead({children:t}){return s.jsx("thead",{className:"bg-muted/50",children:t})},tbody({children:t}){return s.jsx("tbody",{className:"divide-y divide-border",children:t})},tr({children:t}){return s.jsx("tr",{className:"hover:bg-muted/30 transition-colors",children:t})},th({children:t}){return s.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-foreground border-b border-border",children:t})},td({children:t}){return s.jsx("td",{className:"px-4 py-3 text-sm text-foreground border-b border-border/50",children:t})}}),[]);return s.jsxs("div",{className:"prose prose-sm dark:prose-invert max-w-none w-full max-w-full min-w-0 overflow-hidden",style:{overflowX:"hidden"},children:[s.jsx("style",{children:`
        .prose p:last-of-type { margin-bottom: 0 !important; }
        .prose pre { overflow-x: auto !important; max-width: 100% !important; }
        .prose code { overflow-wrap: anywhere !important; word-break: break-word !important; }
      `}),s.jsx(le,{remarkPlugins:[ce,de],rehypePlugins:[ie],components:r,children:e})]})};var re=o.forwardRef(({className:e,...r},t)=>s.jsx(ee,{ref:t,className:_("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",e),...r}));re.displayName=ee.displayName;var ae=o.forwardRef(({className:e,...r},t)=>s.jsx(te,{ref:t,className:_("aspect-square h-full w-full",e),...r}));ae.displayName=te.displayName;var ne=o.forwardRef(({className:e,...r},t)=>s.jsx(se,{ref:t,className:_("flex h-full w-full items-center justify-center rounded-full bg-muted",e),...r}));ne.displayName=se.displayName;const Ue=({className:e})=>s.jsxs("div",{className:_("flex items-center py-1",e),children:[s.jsx("style",{children:`
        @keyframes dotBounce {
          0%, 100% {
            transform: translateY(2px);
          }
          50% {
            transform: translateY(-2px);
          }
        }
      `}),s.jsxs("div",{className:"flex items-center space-x-1",children:[s.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full",style:{animation:"dotBounce 1.4s infinite",animationDelay:"-0.3s"}}),s.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full",style:{animation:"dotBounce 1.4s infinite",animationDelay:"-0.15s"}}),s.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full",style:{animation:"dotBounce 1.4s infinite",animationDelay:"0s"}})]})]}),Xe=({actions:e,className:r,showOnHover:t=!0})=>{const[a,n]=o.useState(!t),l=o.useCallback(()=>{t&&n(!0)},[t]),d=o.useCallback(()=>{t&&n(!1)},[t]);return e.length===0?null:s.jsx("div",{className:_("flex items-center gap-1 transition-all duration-200 ease-in-out",a?"opacity-100 translate-y-0":"opacity-0 translate-y-1",r),onMouseEnter:l,onMouseLeave:d,children:e.map(u=>s.jsxs("button",{onClick:u.onClick,disabled:u.disabled,className:"flex items-center justify-center size-9 rounded-md text-muted-foreground hover:text-foreground hover:bg-accent",title:u.label,children:[u.icon,s.jsx("span",{className:"sr-only",children:u.label})]},u.id))})},F={copy:s.jsx(ye,{className:"h-4 w-4"}),regenerate:s.jsx(we,{className:"h-4 w-4"}),like:s.jsx(ve,{className:"h-4 w-4"}),dislike:s.jsx(be,{className:"h-4 w-4"}),share:s.jsx(pe,{className:"h-4 w-4"})},Ve=({toolInvocation:e,toolRenderers:r,onToolResult:t})=>{const a=r[e.toolName];return a?a.render(e,n=>{t&&t(n)}):e.status==="result"?s.jsxs("div",{className:"rounded-lg border bg-background p-2 w-full max-w-full min-w-0 overflow-hidden",children:[s.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[s.jsx("span",{className:"text-sm font-medium",children:"工具调用结果"}),s.jsx("span",{className:"text-xs text-muted-foreground",children:e.toolName})]}),s.jsx("div",{className:"rounded-md bg-muted p-2 w-full max-w-full min-w-0 overflow-auto",children:s.jsx("pre",{className:"text-sm whitespace-pre-wrap break-all",style:{maxHeight:"12rem",overflowY:"auto",overflowX:"auto",wordBreak:"break-word"},children:JSON.stringify(e.result,null,2)})})]}):s.jsxs("div",{className:"rounded-lg border bg-background p-2 w-full max-w-full min-w-0 overflow-hidden",children:[s.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[s.jsxs("span",{className:"text-sm font-medium",children:["工具调用",e.status==="partial-call"&&s.jsx("span",{className:"ml-2 text-xs text-muted-foreground",children:"准备参数中…"}),e.status==="call"&&s.jsx("span",{className:"ml-2 text-xs text-muted-foreground",children:"执行中…"})]}),s.jsx("span",{className:"text-xs text-muted-foreground",children:e.toolName})]}),s.jsx("div",{className:"rounded-md bg-muted p-2 w-full max-w-full min-w-0 overflow-auto",children:s.jsx("pre",{className:"text-sm whitespace-pre-wrap break-all",style:{maxHeight:"12rem",overflowY:"auto",overflowX:"auto",wordBreak:"break-word"},children:typeof e.args=="string"?e.args:JSON.stringify(e.args,null,2)})})]})};function We(e){const r=[];for(const t of e.parts)t.type==="text"&&r.push(t.text);return r.join(`

`)}function Q(e){return e.parts.some(r=>r.type==="text"&&r.text.trim().length>0)}const Ge=(e,r={})=>{const[t,a]=o.useState(!1),[n,l]=o.useState(!1),{onCopy:d,onRegenerate:u,onLike:i,onDislike:m,onShare:p}=r,b=o.useCallback(async()=>{if(!Q(e)||t)return;const k=We(e);a(!0);try{await navigator.clipboard.writeText(k),l(!0),d?.(k),setTimeout(()=>{l(!1)},2e3)}catch(A){console.error("Failed to copy text:",A);try{const y=document.createElement("textarea");y.value=k,y.style.position="fixed",y.style.left="-999999px",y.style.top="-999999px",document.body.appendChild(y),y.focus(),y.select(),document.execCommand("copy"),document.body.removeChild(y),l(!0),d?.(k),setTimeout(()=>{l(!1)},2e3)}catch(y){console.error("Fallback copy failed:",y)}}finally{a(!1)}},[e,t,d]),g=o.useCallback(()=>{u?.(e.id)},[e.id,u]),x=o.useCallback(()=>{i?.(e.id)},[e.id,i]),v=o.useCallback(()=>{m?.(e.id)},[e.id,m]),S=o.useCallback(()=>{p?.(e.id)},[e.id,p]),C=[];return e.role==="assistant"&&(Q(e)&&C.push({id:"copy",label:n?"已复制":"复制",icon:n?G.createElement("svg",{className:"h-4 w-4 text-green-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},G.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})):F.copy,onClick:b,disabled:t}),u&&C.push({id:"regenerate",label:"重新生成",icon:F.regenerate,onClick:g}),i&&C.push({id:"like",label:"点赞",icon:F.like,onClick:x}),m&&C.push({id:"dislike",label:"点踩",icon:F.dislike,onClick:v}),p&&C.push({id:"share",label:"分享",icon:F.share,onClick:S})),{actions:C,isCopying:t,copySuccess:n}},Z=({uiMessage:e,toolRenderers:r,onToolResult:t,className:a,showAvatar:n=!0,isPending:l=!1,onMessageCopy:d,onMessageRegenerate:u,onMessageLike:i,onMessageDislike:m,onMessageShare:p})=>{const b=e.role==="user",{actions:g}=Ge(e,{onCopy:d,onRegenerate:u,onLike:i,onDislike:m,onShare:p});return s.jsx("div",{className:$("flex w-full p-2 min-w-0 group",b?"justify-end":"justify-start",a),style:{overflowX:"hidden",maxWidth:"100%"},children:s.jsxs("div",{className:$("flex flex-col gap-2 min-w-0 relative",b?"items-end w-auto":"items-start w-auto"),style:{maxWidth:"100%",overflowX:"hidden"},children:[n&&s.jsxs(re,{className:"h-10 w-10 shrink-0",children:[s.jsx(ae,{src:"",alt:b?"User":"Assistant"}),s.jsx(ne,{className:"bg-primary text-primary-foreground",children:b?s.jsx(Ce,{className:"h-5 w-5"}):s.jsx(je,{className:"h-5 w-5"})})]}),s.jsx("div",{className:`min-w-0 overflow-hidden rounded-lg px-3 py-4 ${b?"bg-primary text-primary-foreground w-auto":"bg-muted text-foreground w-auto"}`,style:{overflowX:"hidden",maxWidth:"100%"},children:s.jsx("div",{className:"[&>*:last-child]:mb-0",children:l?s.jsx(Ue,{}):e.parts.map((x,v)=>x.type==="text"?s.jsx("div",{className:"break-words min-w-0",style:{overflowX:"hidden",maxWidth:"100%"},children:s.jsx(Be,{content:x.text})},v):x.type==="tool-invocation"?s.jsx("div",{className:"mt-1",children:s.jsx(Ve,{toolInvocation:x.toolInvocation,toolRenderers:r,onToolResult:t})},v):null)})}),!b&&!l&&g.length>0&&s.jsx("div",{className:"mt-1",children:s.jsx(Xe,{actions:g,showOnHover:!1})})]})})},Ke=({promptsProps:e})=>{const{items:r,onItemClick:t}=e;return!r||r.length===0?null:s.jsx("div",{className:"space-y-3",children:s.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2",children:r.map(a=>s.jsx(P,{variant:"outline",size:"sm",className:_("h-auto p-3 text-left justify-start hover:bg-accent/50 transition-all duration-200","group hover:shadow-sm hover:border-primary/20 hover:scale-[1.02]","focus-visible:ring-2 focus-visible:ring-primary/20 focus-visible:border-primary/40"),onClick:()=>t?.(a),onKeyDown:n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),t?.(a))},role:"button",tabIndex:0,"aria-label":`选择提示: ${a.prompt}`,children:s.jsx("span",{className:"text-sm font-medium text-foreground group-hover:text-primary transition-colors duration-200 leading-relaxed",children:a.prompt})},a.id))})})},qe=({uiMessages:e,toolRenderers:r,onToolResult:t,input:a,senderProps:n,onInputChange:l,onSend:d,isAgentResponding:u,onAbort:i,promptsProps:m,messageItemProps:p,aboveInputComponent:b,inputExtensions:g=[],onBeforeSend:x,onSendDraft:v,meta:S,onMetaChange:C})=>{const{containerRef:k,isSticky:A,scrollToBottom:y,setSticky:D}=$e({deps:[e]}),[z]=Pe({onAppendText:c=>l(a+c)}),[N,T]=o.useState({}),f=S??N,L=o.useCallback(c=>{const j=typeof c=="function"?c({text:a,meta:f}):c;j.text!==void 0&&j.text!==a&&l(j.text),j.meta!==void 0&&(C?C(j.meta):T(j.meta))},[a,f,l,C,z.attachments]),O=o.useMemo(()=>{const c={};for(const j of g){let w=j.placement??"inside-left";w==="toolbar-left"&&(w="top-left"),w==="toolbar-right"&&(w="top-right"),w==="below"&&(w="bottom-left"),c[w]||(c[w]=[]),c[w].push(j)}return c},[g]),h=o.useMemo(()=>({draft:{text:a,meta:f},setDraft:L,isAgentResponding:u,requestAbort:i}),[a,f,L,u,i]),I=o.useCallback(async()=>{let c={text:a,meta:f};const j=w=>typeof w=="object"&&w!==null&&"abort"in w;if(x){const w=await x(c);if(j(w))return{aborted:!0};c=w}for(const w of g){if(!w.beforeSend)continue;const H=await w.beforeSend(c);if(j(H))return{aborted:!0};c=H}return{aborted:!1,draft:c}},[a,f,x,g]),R=o.useCallback(async()=>{if(x||g&&g.length>0||v){const c=await I();if(c.aborted)return;const j=c.draft;v?v(j):d()}else d();setTimeout(()=>{D(!0),y()},0)},[x,g,v,d,I,D,y]);return s.jsxs("div",{className:"flex h-full flex-col",children:[s.jsxs("div",{ref:k,className:$("flex-1 overflow-y-auto overflow-x-hidden px-4 py-2",A?" sticky-bottom":""),style:{overflowX:"hidden",maxWidth:"100%"},children:[e.map((c,j)=>s.jsx(Z,{uiMessage:c,toolRenderers:r,onToolResult:t,...p},j)),u&&e.length>0&&e[e.length-1].role!=="assistant"&&s.jsx(Z,{uiMessage:{id:"generating-placeholder",role:"assistant",parts:[]},toolRenderers:r,onToolResult:t,isPending:!0,...p},"generating-placeholder")]}),m&&e.length===0&&s.jsx("div",{className:"border-t border-border/50 bg-gradient-to-b from-muted/30 to-background/95 backdrop-blur-sm px-4 py-6",children:s.jsx(Ke,{promptsProps:m})}),b&&s.jsx("div",{className:"border-t border-border/50 bg-muted/20 px-4 py-3",children:b}),s.jsx("div",{className:"border-t border-border/50 bg-background/95 backdrop-blur-sm px-4 py-4 flex-shrink-0",children:s.jsx(He,{input:a,...n,onInputChange:c=>{l(c)},onSend:R,isAgentResponding:u,onAbort:i,insideLeftSlot:O["inside-left"]?.map(c=>s.jsx(o.Fragment,{children:c.render(h)},c.id)),insideRightSlot:O["inside-right"]?.map(c=>s.jsx(o.Fragment,{children:c.render(h)},c.id)),headerLeftSlot:O["top-left"]?.map(c=>s.jsx(o.Fragment,{children:c.render(h)},c.id)),headerRightSlot:O["top-right"]?.map(c=>s.jsx(o.Fragment,{children:c.render(h)},c.id)),footerLeftSlot:O["bottom-left"]?.map(c=>s.jsx(o.Fragment,{children:c.render(h)},c.id)),footerRightSlot:O["bottom-right"]?.map(c=>s.jsx(o.Fragment,{children:c.render(h)},c.id))})})]})},Je=o.createContext(null),Ye=o.forwardRef(({agentSessionManager:e,toolRenderers:r,className:t,senderProps:a,promptsProps:n,messageItemProps:l,aboveInputComponent:d,inputExtensions:u,onBeforeSend:i,meta:m,onMetaChange:p},b)=>{const[g,x]=o.useState(""),{messages:v,isAgentResponding:S}=Oe(e),{handleSendMessage:C,handleAddToolResult:k,reset:A,addMessages:y,abortAgentRun:D,handleAddMessages:z}=e,N=async()=>{S||(await C(g),x(""))},T=async f=>{if(!S){const L=(f?.text??"").toString();if(L.trim().length===0)return;await C(L),x("")}};return o.useImperativeHandle(b,()=>({reset:A,addMessages:z}),[A,y]),s.jsx("div",{className:t,children:s.jsx(Je.Provider,{value:e,children:s.jsx(qe,{senderProps:a,uiMessages:v,toolRenderers:r,onToolResult:k,input:g,onInputChange:x,onSend:N,onSendDraft:T,isAgentResponding:S,onAbort:D,promptsProps:n,messageItemProps:l,aboveInputComponent:d,inputExtensions:u,onBeforeSend:i,meta:m,onMetaChange:p})})})}),Qe=({title:e,isMaximized:r,isHeightMaximized:t,onMaximize:a,onHeightMaximize:n,onClose:l,children:d,actions:u,width:i=400,height:m=600})=>s.jsxs("div",{className:"fixed bottom-5 right-5 flex flex-col rounded-lg bg-background shadow-lg transition-all duration-300 ease-in-out z-50",style:{width:r?"calc(100vw - 40px)":`${i}px`,height:r||t?"calc(100vh - 40px)":`${m}px`,bottom:"20px",right:"20px"},children:[s.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3 cursor-pointer select-none",children:[s.jsx("span",{className:"font-medium text-foreground",children:e}),s.jsxs("div",{className:"flex items-center space-x-2",onClick:p=>{p.stopPropagation()},children:[u,s.jsx(P,{size:"icon",variant:"ghost",onClick:n,children:s.jsx(Ne,{className:"h-4 w-4"})}),s.jsx(P,{size:"icon",variant:"ghost",onClick:a,children:r?s.jsx(Te,{className:"h-4 w-4"}):s.jsx(ke,{className:"h-4 w-4"})}),s.jsx(P,{size:"icon",variant:"ghost",onClick:l,children:s.jsx(Ae,{className:"h-4 w-4"})})]})]}),s.jsx("div",{className:"flex-1 overflow-hidden flex flex-col",children:d})]});o.forwardRef(({className:e,...r},t)=>{const[a,n]=o.useState(!1),[l,d]=o.useState(!1),[u,i]=o.useState(!0),m=()=>{i(!1)},p=()=>{i(!0)},b=()=>{d(!l),a&&n(!1)},g=o.useRef(null),x=()=>{g.current?.reset()};return u?s.jsx(Qe,{title:"AI Assistant",isMaximized:a,isHeightMaximized:l,onMaximize:()=>{n(!a),l&&d(!1)},onHeightMaximize:b,onClose:m,actions:[s.jsx(P,{variant:"ghost",size:"icon",onClick:x,children:s.jsx(Me,{className:"h-4 w-4"})},"clear")],children:s.jsx(Ye,{ref:v=>{g.current=v,typeof t=="function"?t(v):t&&(t.current=v)},...r,className:$("h-full",e)})}):s.jsx(P,{variant:"default",size:"icon",onClick:p,className:"fixed bottom-5 right-5 h-12 w-12 rounded-full shadow-lg",children:s.jsx(Re,{className:"h-6 w-6"})})});const Ze=e=>({name:e.name,description:e.description,parameters:e.parameters}),et=e=>e.map(r=>({name:r.name,description:r.description,parameters:r.parameters})),tt=e=>Object.fromEntries(e.filter(r=>r.execute).map(r=>[r.name,r.execute])),st=e=>Object.fromEntries(e.filter(r=>r.render).map(r=>[r.name,{render:r.render,definition:Ze(r)}])),ht=e=>{const r=o.useMemo(()=>et(e),[e]),t=o.useMemo(()=>tt(e),[e]),a=o.useMemo(()=>st(e),[e]);return{toolDefs:r,toolExecutors:t,toolRenderers:a}};export{Ye as A,E,M as T,ut as a,Oe as b,ht as u};
