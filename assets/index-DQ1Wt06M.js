const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/pkg-mermaid-CO65k8p_.js","assets/pkg-at-mermaid-js-parser-FFOaRQbu.js","assets/pkg-langium-k-diuD5f.js","assets/pkg-vscode-jsonrpc-CNa_m3dn.js","assets/pkg-chevrotain-CEPHk4zS.js","assets/pkg-at-chevrotain-utils-DXqYm0RC.js","assets/pkg-at-chevrotain-gast-CM_WTRiP.js","assets/lodash-C0JF0MaN.js","assets/pkg-at-chevrotain-regexp-to-ast-CeRRmUFy.js","assets/pkg-chevrotain-allstar-CSJ5eIgA.js","assets/pkg-vscode-languageserver-types-NoPvPymt.js","assets/pkg-vscode-languageserver-textdocument-CKBVUiR3.js","assets/pkg-vscode-uri-BBKMTmn0.js","assets/pkg-ts-dedent-DrFu-skq.js","assets/pkg-d3-transition-BaRlNtC4.js","assets/pkg-d3-dispatch-kxCwF96_.js","assets/pkg-d3-timer-DdKHrDhs.js","assets/pkg-d3-interpolate-Iy2XDU8a.js","assets/pkg-d3-color-amxIadob.js","assets/pkg-d3-selection-DSeOx27A.js","assets/pkg-d3-ease-DRPgKoYJ.js","assets/pkg-d3-zoom-BbI7VOFS.js","assets/pkg-d3-drag-BRlWb_WG.js","assets/pkg-dompurify-CGs5VtEq.js","assets/pkg-stylis-D5iaQeiq.js","assets/pkg-dagre-d3-es-CvYYlzoE.js","assets/pkg-cytoscape-DtBltrT8.js","assets/pkg-cytoscape-cose-bilkent-C9QuRRRD.js","assets/pkg-at-braintree-sanitize-url-DFOppRqi.js","assets/pkg-cose-base-pzx1KLkZ.js","assets/pkg-layout-base-DINsLxBG.js","assets/pkg-khroma-DUX6PT6k.js","assets/pkg-dayjs-CVSRrfvc.js","assets/pkg-d3-scale-BdQTp1Zi.js","assets/pkg-internmap-BkD7Hj8s.js","assets/pkg-d3-array-DzV2ZBVv.js","assets/pkg-d3-format-CzD4bSOQ.js","assets/pkg-d3-time-format-D0g1J26-.js","assets/pkg-d3-time-BJXYiI7q.js","assets/pkg-d3-axis-DSWTncID.js","assets/pkg-d3-shape-B1-Efro7.js","assets/pkg-d3-path-Bai4oqrp.js","assets/pkg-roughjs-CycZv-lV.js","assets/pkg-uuid-BKrj-4V8.js","assets/pkg-d3-sankey-CL8iXfid.js","assets/pkg-d3-scale-chromatic-CvOaoHrI.js","assets/pkg-at-iconify-utils-D2F_yRRF.js","assets/pkg-marked-BGv_dqOO.js","assets/pkg-cytoscape-fcose-DSsTzDQ2.js","assets/pkg-d3-hierarchy-CvYzv8kf.js","assets/pkg-react-syntax-highlighter-CV6PWkyB.js","assets/react-vendor-BmBsKbru.js","assets/pkg-scheduler-Bb8JjhAW.js","assets/pkg-refractor-Ch9JKb1r.js","assets/pkg-hastscript-VmKaH6iJ.js","assets/pkg-property-information-CFHPdWQf.js","assets/pkg-xtend-VQg9yHl6.js","assets/pkg-hast-util-parse-selector-CLnxzGsj.js","assets/pkg-space-separated-tokens-CF7pUylw.js","assets/pkg-comma-separated-tokens-BQxVigOH.js","assets/pkg-parse-entities-xsQacvMO.js","assets/pkg-character-entities-legacy-BSd6ekHp.js","assets/pkg-character-reference-invalid-AKrgFUtc.js","assets/pkg-is-decimal-Bg2oiju0.js","assets/pkg-is-hexadecimal-yh8m6GRc.js","assets/pkg-is-alphanumerical-DYCKc-AM.js","assets/pkg-is-alphabetical-BQ1fjZEF.js","assets/pkg-prismjs-roPZ7vEp.js","assets/pkg-at-babel-runtime-BlVrb8V_.js"])))=>i.map(i=>d[i]);
import{r as h,j as e,H as Mt,a as br,d as Ol}from"./react-vendor-BmBsKbru.js";import{S as fo,a as xo,C as bo,b as vo,T as $l,D as Ul,P as yo,O as wo,c as zl,d as Fl,e as Bl,R as Hl,I as Gl,F as Vl,f as ql,g as Wl,h as Kl,i as Yl,j as Xl,k as Jl,l as Ql,m as Zl,n as ec,o as tc,A as sc,p as nc,q as ac,r as rc,s as oc,L as ic,t as lc,u as cc,G as dc,v as uc,w as hc,x as mc,y as gc,V as pc,z as fc,B as xc,E as bc}from"./radix-Ddyg2AXA.js";import{t as vc,c as yc,a as Ia}from"./ui-utils-CjxovF-h.js";import{g as le,h as as,W as wc,i as jo,j as No,k as Ss,l as ht,m as Co,n as En,I as ko,o as jc,p as Nc,q as So,r as Zn,s as Cc,t as kc,E as Vs,u as In,v as Mo,w as ze,x as Wt,y as Ta,z as Eo,D as Ye,F as ea,P as Me,G as Sc,H as Aa,J as Mc,K as Ec,N as Kt,O as Et,Q as Io,V as To,Y as Ic,Z as Tc,_ as Ac,$ as Xe,a0 as Fe,a1 as Lc,a2 as Rc,a3 as La,a4 as Ra,a5 as ds,a6 as Dc,a7 as _c,a8 as bn,a9 as Pc,aa as Oc,ab as $c,ac as it,ad as Tn,ae as ot,af as An,ag as ta,ah as vn,ai as mt,aj as sa,ak as Os,al as na,am as Ao,an as Lo,ao as Uc,ap as us,aq as zc,ar as Fc,as as Bc,at as Gt,au as rs,av as vr,aw as os,ax as qs,ay as Ro,az as Do,aA as Hc,aB as yr,aC as wr,aD as jr,aE as Nr,aF as Gc,aG as Vc,aH as Cr,aI as kr,aJ as Sr,aK as Fn,aL as aa,aM as Bn,aN as Mr,aO as qc,aP as Wc,aQ as Kc,aR as Yc,aS as Xc,aT as Jc,aU as Da,aV as Qc,aW as Zc,aX as _o,aY as ed,aZ as td,a_ as sd,a$ as ra,b0 as Po,b1 as nd,b2 as Oo,b3 as ad,b4 as oa,b5 as ia,b6 as Hn,b7 as rd,b8 as _a,b9 as od,ba as id,bb as Yt,bc as ld,bd as cd,be as dd,bf as ud,bg as Er,bh as hd,bi as $o,bj as md,bk as gd,bl as Gn}from"./icons-NkHAE_SW.js";import{c as Ee,p as At}from"./pkg-zustand-c3SqYTrA.js";import{T as pd,t as Ut}from"./pkg-sonner-COYOtiVF.js";import{i as fd,s as xd,l as bd,a as vd}from"./pkg-at-firebase-analytics-Bfvuh8nK.js";import"./firebase-SHsZfwsS.js";import{i as yd,c as wd,g as jd,b as Nd,o as Cd,s as bs,a as kd,d as Ir,e as vs,f as Tr,u as Vn,G as Sd,h as Md}from"./pkg-at-firebase-auth-DbTsgscY.js";import{i as Ed}from"./pkg-at-firebase-app-GYc7G31p.js";import"./pkg-at-firebase-logger-CNz1B4Yj.js";import{i as Id,c as Ae,g as ge,q as ce,w as Q,o as Re,a as Ms,l as wt,b as qn,d as se,u as be,s as Z,e as la,f as zt,h as jt,j as Td,k as cn,m as Ad,T as Ld,n as Rd,p as Es,r as Dd,t as _d}from"./pkg-at-firebase-firestore-DvE58EER.js";import{S as Pd,B as dt,R as Uo,d as Ws,f as Ln,s as zo,o as Od,c as Fo,m as Ft,t as $d,a as Ud,b as zd,e as Bo,O as ca,g as Fd,h as Is,i as Bd,j as da,w as Hd}from"./rxjs-CTlMgwGv.js";import{v as It}from"./pkg-uuid-BKrj-4V8.js";import{A as Ho,m as We}from"./pkg-framer-motion-ByyIFi-r.js";import{u as Gd,a as Go,R as Vo,b as qo,c as Vd,N as Wo,H as qd}from"./pkg-react-router-BkbVofjk.js";import{E as Wd,d as Pa,D as ut}from"./pkg-at-cardos-extension-DWCYc5_2.js";import{A as $t}from"./pkg-composite-kit-CDq_DePh.js";import{u as $s}from"./pkg-ahooks-pw93jeL_.js";import{P as Kd,a as Yd,b as Xd}from"./pkg-react-resizable-panels-DkV_pGBO.js";import{O as Ko}from"./ai-sdk-Cs_ets_2.js";import{d as Yo,i as Jd,a as Qd,f as ua,b as Zd}from"./pkg-date-fns-Cc4qOlqn.js";import{T as Ue,E as Ke,u as eu,a as tu,b as su,A as nu}from"./agent-chat-DKAh5MBn.js";import{$ as Xo}from"./lodash-C0JF0MaN.js";import{E as au,a as ru,S as ou,T as Ar}from"./pkg-emoji-picker-react-BaGPy3TE.js";import{_ as ne}from"./pkg-at-mermaid-js-parser-FFOaRQbu.js";import{S as Jo,v as iu,o as lu}from"./pkg-react-syntax-highlighter-CV6PWkyB.js";import{M as cu,a as du,b as Qo,r as Zo}from"./markdown-B4_wTib_.js";import{R as uu,N as hu,a as mu,u as gu,E as pu}from"./pkg-at-tiptap-react-DQcKkSgx.js";import{i as fu}from"./pkg-at-tiptap-extension-bubble-menu-DbBO6TnN.js";import{i as xu}from"./pkg-at-tiptap-extension-placeholder-C61jGW_T.js";import{S as bu}from"./pkg-at-tiptap-starter-kit-BeTqfHQC.js";import{i as vu}from"./pkg-at-tiptap-extension-code-block-lowlight-CeFN_vop.js";import{i as yu}from"./pkg-at-tiptap-extension-underline-Bc-1QzGt.js";import{i as wu}from"./pkg-at-tiptap-extension-link-BpPLl1yG.js";import{i as ju}from"./pkg-at-tiptap-extension-image-BWcc5HCz.js";import{i as Nu}from"./pkg-at-tiptap-extension-typography-BNh8BK4m.js";import{c as Cu}from"./pkg-at-tiptap-extension-table-Cep6OeXh.js";import{i as ku}from"./pkg-at-tiptap-extension-table-row-CDDzHxTi.js";import{i as Su}from"./pkg-at-tiptap-extension-table-header-CBUC3IlF.js";import{i as Mu}from"./pkg-at-tiptap-extension-table-cell-Cbo0s_r5.js";import{i as Eu}from"./pkg-at-tiptap-extension-task-list-BjPe_qK3.js";import{i as Iu}from"./pkg-at-tiptap-extension-task-item-B-JYeMAW.js";import{T as Tu}from"./pkg-turndown-DScDaalG.js";import{g as Au}from"./pkg-turndown-plugin-gfm-CHX_rbMa.js";import{k as ei}from"./pkg-marked-BGv_dqOO.js";import{v as ha}from"./pkg-unist-util-visit-Ddo8Kubz.js";import{E as Lu}from"./pkg-unist-util-visit-parents-BcSs7PJp.js";import{u as Ru}from"./pkg-unified-DkoGxGPE.js";import{r as Du}from"./pkg-rehype-parse-BoGwmf-J.js";import{r as _u}from"./pkg-rehype-remark-gZKLrGxq.js";import{r as Pu}from"./pkg-remark-stringify-EhqeS4xL.js";import{E as Ou}from"./pkg-at-tiptap-core-BEPluX3I.js";import{i as $u}from"./pkg-at-tiptap-suggestion-B7OJ7sq3.js";import{l as Uu}from"./pkg-lowlight-DYSj9Ibr.js";import{i as zu}from"./pkg-at-tiptap-extension-heading-DOz64cif.js";import{q as ti}from"./pkg-react-virtuoso-BimVkHfU.js";import{z as Fu,i as Bu}from"./pkg-d3-zoom-BbI7VOFS.js";import{f as Hu,a as Gu,b as Vu,c as qu,d as Wu}from"./pkg-d3-force-zv4HlRoA.js";import{s as Wn}from"./pkg-d3-selection-DSeOx27A.js";import{a as Ku}from"./pkg-d3-drag-BRlWb_WG.js";import{G as Yu,a as Xu,g as Ju,p as Qu}from"./pkg-at-dimstack-git-auth-HYuP_LUZ.js";import"./pkg-at-braintree-sanitize-url-DFOppRqi.js";import"./pkg-scheduler-Bb8JjhAW.js";import"./pkg-react-remove-scroll-D84cQcFc.js";import"./pkg-tslib-NCTAzukp.js";import"./pkg-react-remove-scroll-bar-HAm2nWq0.js";import"./pkg-react-style-singleton-BtmK1JjA.js";import"./pkg-get-nonce-C-Z93AgS.js";import"./pkg-use-sidecar-Dk7v8vBV.js";import"./pkg-use-callback-ref-C1Qc1SND.js";import"./pkg-aria-hidden-DvXkyWUv.js";import"./pkg-use-sync-external-store-u6TwacNB.js";import"./pkg-at-floating-ui-react-dom-DG-zBnew.js";import"./pkg-at-floating-ui-dom-H_s0ufE4.js";import"./pkg-at-floating-ui-core-Bf0tlPHe.js";import"./pkg-at-floating-ui-utils-CAQGqlS1.js";import"./pkg-at-firebase-util-DvMNs22_.js";import"./pkg-at-firebase-component-bbWpJtj_.js";import"./pkg-at-firebase-installations-BaMcUwQk.js";import"./pkg-idb-BXWtuYvb.js";import"./pkg-at-firebase-webchannel-wrapper-QS5lB7L3.js";import"./pkg-motion-dom-BwV5m02p.js";import"./pkg-motion-utils-CjIqCkNq.js";import"./pkg-dayjs-CVSRrfvc.js";import"./pkg-flairup-CpvKgcza.js";import"./pkg-langium-k-diuD5f.js";import"./pkg-vscode-jsonrpc-CNa_m3dn.js";import"./pkg-chevrotain-CEPHk4zS.js";import"./pkg-at-chevrotain-utils-DXqYm0RC.js";import"./pkg-at-chevrotain-gast-CM_WTRiP.js";import"./pkg-at-chevrotain-regexp-to-ast-CeRRmUFy.js";import"./pkg-chevrotain-allstar-CSJ5eIgA.js";import"./pkg-vscode-languageserver-types-NoPvPymt.js";import"./pkg-vscode-languageserver-textdocument-CKBVUiR3.js";import"./pkg-vscode-uri-BBKMTmn0.js";import"./pkg-refractor-Ch9JKb1r.js";import"./pkg-hastscript-VmKaH6iJ.js";import"./pkg-property-information-CFHPdWQf.js";import"./pkg-xtend-VQg9yHl6.js";import"./pkg-hast-util-parse-selector-CLnxzGsj.js";import"./pkg-space-separated-tokens-CF7pUylw.js";import"./pkg-comma-separated-tokens-BQxVigOH.js";import"./pkg-parse-entities-xsQacvMO.js";import"./pkg-character-entities-legacy-BSd6ekHp.js";import"./pkg-character-reference-invalid-AKrgFUtc.js";import"./pkg-is-decimal-Bg2oiju0.js";import"./pkg-is-hexadecimal-yh8m6GRc.js";import"./pkg-is-alphanumerical-DYCKc-AM.js";import"./pkg-is-alphabetical-BQ1fjZEF.js";import"./pkg-prismjs-roPZ7vEp.js";import"./pkg-at-babel-runtime-BlVrb8V_.js";import"./pkg-devlop-Cl3hj7Sz.js";import"./pkg-remark-parse-BeO-KmVJ.js";import"./pkg-mdast-util-from-markdown-BmEQKP9C.js";import"./pkg-micromark-util-decode-numeric-character-reference-CNs1qBpV.js";import"./pkg-micromark-util-decode-string-CN12p1QQ.js";import"./pkg-decode-named-character-reference-C3-224fz.js";import"./pkg-micromark-util-normalize-identifier-C9ANKk3v.js";import"./pkg-micromark-D5KhfieM.js";import"./pkg-micromark-util-combine-extensions-Do2pbDSt.js";import"./pkg-micromark-util-chunked-DrRIdSP-.js";import"./pkg-micromark-factory-space-BZOpXu4z.js";import"./pkg-micromark-util-character-Cn8n62xE.js";import"./pkg-micromark-core-commonmark-CqZ3B5v2.js";import"./pkg-micromark-util-classify-character-CcNqx0ik.js";import"./pkg-micromark-util-resolve-all-PQCKh0dx.js";import"./pkg-micromark-util-subtokenize-Rnufg-uS.js";import"./pkg-micromark-factory-destination-BpBlAxuG.js";import"./pkg-micromark-factory-label-DyndCtq7.js";import"./pkg-micromark-factory-title--3sarO0x.js";import"./pkg-micromark-factory-whitespace-BFbQeeHj.js";import"./pkg-micromark-util-html-tag-name-DbKNfynz.js";import"./pkg-unist-util-stringify-position-Ch_qCilz.js";import"./pkg-mdast-util-to-string-C_aolqmU.js";import"./pkg-remark-rehype-DYOQqASa.js";import"./pkg-mdast-util-to-hast-Brl7PQp-.js";import"./pkg-at-ungap-structured-clone--gfxRhYI.js";import"./pkg-micromark-util-sanitize-uri-Bcy1OjTd.js";import"./pkg-unist-util-position-B29JQW-R.js";import"./pkg-trim-lines-D8znQY54.js";import"./pkg-vfile-C9sMpkI_.js";import"./pkg-vfile-message-9l3O2Txd.js";import"./pkg-hast-util-to-jsx-runtime-BrcWNXAC.js";import"./pkg-style-to-js-CEKVR7hG.js";import"./pkg-style-to-object-BBLxsZ82.js";import"./pkg-inline-style-parser-D4u_cg7q.js";import"./pkg-hast-util-whitespace-D4Wp6AEg.js";import"./pkg-estree-util-is-identifier-name-BgBfM8ME.js";import"./pkg-html-url-attributes-D46m5wfe.js";import"./pkg-micromark-extension-gfm-B0DctPzH.js";import"./pkg-micromark-extension-gfm-autolink-literal-DBUxU-6S.js";import"./pkg-micromark-extension-gfm-footnote-DBQxKibT.js";import"./pkg-micromark-extension-gfm-strikethrough-DP_nekd2.js";import"./pkg-micromark-extension-gfm-table-BwEzuKcM.js";import"./pkg-micromark-extension-gfm-task-list-item-Bh-RsFa-.js";import"./pkg-mdast-util-gfm-CpKz74zx.js";import"./pkg-mdast-util-gfm-autolink-literal-Dncmbeag.js";import"./pkg-ccount-c2V3InAJ.js";import"./pkg-mdast-util-find-and-replace-DRnaru6o.js";import"./pkg-escape-string-regexp-BaJN9MlJ.js";import"./pkg-unist-util-is-BPZGFiMU.js";import"./pkg-mdast-util-gfm-footnote-Fj4BtPn2.js";import"./pkg-mdast-util-gfm-strikethrough-Cj9qKt6Q.js";import"./pkg-mdast-util-gfm-table-ZH_uo1A0.js";import"./pkg-markdown-table-DvhhVmnL.js";import"./pkg-mdast-util-to-markdown-inCPN5xz.js";import"./pkg-zwitch-C2o2j-tx.js";import"./pkg-longest-streak-CtXnX3Xp.js";import"./pkg-mdast-util-phrasing-CAX20Uul.js";import"./pkg-mdast-util-gfm-task-list-item-BAonFiNm.js";import"./pkg-micromark-extension-math-B9Diwa8Q.js";import"./pkg-mdast-util-math-xlj7Pg1K.js";import"./pkg-hast-util-from-html-isomorphic-Dm2lD_eS.js";import"./pkg-hast-util-from-dom-Bra3Ahul.js";import"./pkg-web-namespaces-Cmx0dTen.js";import"./pkg-hast-util-to-text-C4DEUCmM.js";import"./pkg-hast-util-is-element-Bzxglnm2.js";import"./pkg-unist-util-find-after-DkOernp_.js";import"./pkg-fast-deep-equal-Bz4WhI9j.js";import"./editor-C-B7di21.js";import"./pkg-w3c-keyname-DEtA-KhA.js";import"./pkg-rope-sequence-nfUW61tr.js";import"./pkg-orderedmap-C4TimWWB.js";import"./pkg-at-tiptap-extensions-CsjD9KBa.js";import"./pkg-at-tiptap-extension-blockquote-CIx2_CtX.js";import"./pkg-at-tiptap-extension-bold-CL-3UbJm.js";import"./pkg-at-tiptap-extension-code-DLCV8URN.js";import"./pkg-at-tiptap-extension-code-block-CumulSY5.js";import"./pkg-at-tiptap-extension-document-Dilzfe-S.js";import"./pkg-at-tiptap-extension-hard-break-Cq0Drqhf.js";import"./pkg-at-tiptap-extension-horizontal-rule-CL_RkuIS.js";import"./pkg-at-tiptap-extension-italic-Cjk0aqR1.js";import"./pkg-at-tiptap-extension-list-Dndwv1kf.js";import"./pkg-at-tiptap-extension-paragraph-C7HeI5db.js";import"./pkg-at-tiptap-extension-strike-ByPbP-rY.js";import"./pkg-at-tiptap-extension-text-CSJP2zVF.js";import"./pkg-highlight-js-Bau7PnhN.js";import"./pkg-linkifyjs-DVrXeg1a.js";import"./pkg-bail-FqpXQuLt.js";import"./pkg-extend-gYfrUz6q.js";import"./pkg-is-plain-obj-C1gvLhAf.js";import"./pkg-trough-B_b8ryxu.js";import"./pkg-hast-util-from-html-Dr5jZ0zX.js";import"./pkg-parse5-_EF7DkJg.js";import"./pkg-entities-BglH30t1.js";import"./pkg-hast-util-from-parse5-CbpRgCtS.js";import"./pkg-vfile-location-LfEFwJ2h.js";import"./pkg-hast-util-to-mdast-BPVClNk7.js";import"./pkg-trim-trailing-lines-7L_Z2a2U.js";import"./pkg-hast-util-phrasing-B72AGgQS.js";import"./pkg-hast-util-embedded-CWukGJwN.js";import"./pkg-hast-util-is-body-ok-link-C43KYGFe.js";import"./pkg-hast-util-has-property-BRFdt-Gn.js";import"./pkg-rehype-minify-whitespace-BY0G4hOn.js";import"./pkg-hast-util-minify-whitespace-DPvWwg0h.js";import"./pkg-fault-lzTQDqBo.js";import"./pkg-format-Jkd_0D2M.js";import"./pkg-d3-transition-BaRlNtC4.js";import"./pkg-d3-dispatch-kxCwF96_.js";import"./pkg-d3-timer-DdKHrDhs.js";import"./pkg-d3-interpolate-Iy2XDU8a.js";import"./pkg-d3-color-amxIadob.js";import"./pkg-d3-ease-DRPgKoYJ.js";import"./pkg-d3-quadtree-CSANTnla.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const Zs={md:768,lg:1024,xl:1280,"2xl":1536},Rn=()=>{if(typeof window>"u")return"sm";const s=window.innerWidth;return s>=Zs["2xl"]?"2xl":s>=Zs.xl?"xl":s>=Zs.lg?"lg":s>=Zs.md?"md":"sm"},si=()=>{const s=Rn();return s==="sm"||s==="md"},Zu=()=>Rn()==="lg",eh=()=>{const s=Rn();return s==="xl"||s==="2xl"},ni=h.createContext(void 0);function th({children:s}){const[t,n]=h.useState("sm");h.useEffect(()=>{const r=()=>{n(Rn())};return r(),window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[]);const a={currentBreakpoint:t,isMobile:si(),isTablet:Zu(),isDesktop:eh()};return e.jsx(ni.Provider,{value:a,children:s})}function ai(){const s=h.useContext(ni);if(s===void 0)throw new Error("useBreakpoint must be used within a BreakpointProvider");return s}function M(...s){return vc(yc(s))}const sh=Ia("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function k({className:s,variant:t,size:n,asChild:a=!1,...r}){const o=a?fo:"button";return e.jsx(o,{"data-slot":"button",className:M(sh({variant:t,size:n,className:s})),...r})}function gt({...s}){return e.jsx(xo,{"data-slot":"dialog",...s})}function ri({...s}){return e.jsx(zl,{"data-slot":"dialog-trigger",...s})}function nh({...s}){return e.jsx(yo,{"data-slot":"dialog-portal",...s})}function ah({className:s,...t}){return e.jsx(wo,{"data-slot":"dialog-overlay",className:M("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",s),...t})}function pt({className:s,children:t,showCloseButton:n=!0,onWheel:a,...r}){const o=i=>{i.stopPropagation(),a?.(i)};return e.jsxs(nh,{"data-slot":"dialog-portal",children:[e.jsx(ah,{}),e.jsxs(bo,{"data-slot":"dialog-content",className:M("bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",s),...r,onWheel:o,children:[t,n&&e.jsxs(vo,{"data-slot":"dialog-close",className:"data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",children:[e.jsx(le,{}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]})}function hs({className:s,...t}){return e.jsx("div",{"data-slot":"dialog-header",className:M("flex flex-col gap-2 text-center sm:text-left",s),...t})}function Oa({className:s,...t}){return e.jsx("div",{"data-slot":"dialog-footer",className:M("flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",s),...t})}function ms({className:s,...t}){return e.jsx($l,{"data-slot":"dialog-title",className:M("text-lg leading-none font-semibold",s),...t})}function Dn({className:s,...t}){return e.jsx(Ul,{"data-slot":"dialog-description",className:M("text-muted-foreground text-sm",s),...t})}const ct=Ee()((s,t)=>({isOpen:!1,options:{},isOkLoading:!1,error:null,show:n=>{s({isOpen:!0,options:n,isOkLoading:!1,error:null})},confirm:n=>{t().show({...n,okText:n.okText??"Confirm",cancelText:n.cancelText??"Cancel"})},close:()=>{s({isOpen:!1})},handleOk:async()=>{const{options:n}=t();s({isOkLoading:!0,error:null});try{await n.onOk?.();const a=t().options.afterClose;s({isOpen:!1}),a?.()}catch(a){const r=a instanceof Error?a.message:"Operation failed";s({error:r})}finally{s({isOkLoading:!1})}},handleCancel:()=>{const{options:n}=t();n.onCancel?.();const a=n.afterClose;s({isOpen:!1}),a?.()}})),we={show:s=>ct.getState().show(s),confirm:s=>ct.getState().confirm(s),close:()=>ct.getState().close()};function rh({children:s}){const t=ct(l=>l.isOpen),n=ct(l=>l.options),a=ct(l=>l.isOkLoading),r=ct(l=>l.error),o=ct(l=>l.handleOk),i=ct(l=>l.handleCancel);return e.jsxs(e.Fragment,{children:[s,e.jsx(gt,{open:t,onOpenChange:l=>!l&&i(),children:e.jsxs(pt,{className:M(n.className),children:[n.title&&e.jsxs(hs,{children:[e.jsx(ms,{children:n.title}),n.description&&e.jsx(Dn,{children:n.description})]}),n.content,r&&e.jsx("div",{className:"mt-2 text-sm text-red-600 dark:text-red-400",children:r}),n.showFooter!==!1&&e.jsxs(Oa,{children:[e.jsx(k,{variant:"outline",onClick:i,disabled:a,children:n.cancelText??"Cancel"}),e.jsx(k,{onClick:o,disabled:a,variant:n.okVariant==="destructive"?"destructive":void 0,children:a?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"}),n.okLoadingText??n.okText??"Processing..."]}):n.okText??"Confirm"})]})]})})]})}const oi=h.createContext(null),Lr="app-theme";function Rr(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function oh({children:s}){const[t,n]=h.useState(()=>typeof window>"u"?"system":localStorage.getItem(Lr)||"system"),[a,r]=h.useState(typeof window>"u"?"light":Rr());h.useEffect(()=>{const u=window.matchMedia("(prefers-color-scheme: dark)"),m=p=>{r(p.matches?"dark":"light")};return u.addEventListener("change",m),()=>u.removeEventListener("change",m)},[]);const o=u=>{n(u),localStorage.setItem(Lr,u);const m=window.document.documentElement;if(u==="system"){const p=Rr()==="dark";m.classList.toggle("dark",p)}else m.classList.toggle("dark",u==="dark");m.classList.add("theme-transition"),setTimeout(()=>{m.classList.remove("theme-transition")},300)},i=()=>{o((t==="system"?a:t)==="dark"?"light":"dark")};h.useEffect(()=>{const u=window.document.documentElement,m=t==="system"?a==="dark":t==="dark";u.classList.toggle("dark",m)},[t,a]);const l=t==="system"?a==="dark":t==="dark",c=h.useMemo(()=>M("h-screen w-screen flex flex-col overflow-hidden",l?"bg-gray-900":"bg-gray-50"),[l]),d={theme:t,setTheme:o,isDarkMode:l,toggleDarkMode:i,rootClassName:c};return e.jsx(oi.Provider,{value:d,children:s})}function ih(){const s=h.useContext(oi);if(!s)throw new Error("useTheme must be used within a ThemeProvider");return s}const lh=({...s})=>e.jsx(pd,{position:"top-right",duration:1400,className:"toaster group",...s});function St({className:s,...t}){return e.jsx("div",{"data-slot":"card",className:M("bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",s),...t})}function Ts({className:s,...t}){return e.jsx("div",{"data-slot":"card-header",className:M("@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",s),...t})}function As({className:s,...t}){return e.jsx("div",{"data-slot":"card-title",className:M("leading-none font-semibold",s),...t})}function Ls({className:s,...t}){return e.jsx("div",{"data-slot":"card-description",className:M("text-muted-foreground text-sm",s),...t})}function ss({className:s,...t}){return e.jsx("div",{"data-slot":"card-content",className:M("px-6",s),...t})}const ch=()=>{const[s,t]=h.useState(null),[n,a]=h.useState(!1),[r,o]=h.useState(!1);h.useEffect(()=>{const c=m=>{m.preventDefault(),t(m),!r&&localStorage.getItem("pwa-install-dismissed")!=="true"&&a(!0)},d=()=>{o(!0),a(!1),t(null)};return(()=>{const m=window.matchMedia("(display-mode: standalone)").matches,p=window.navigator.standalone===!0,f=m||p;o(f),f&&a(!1)})(),window.addEventListener("beforeinstallprompt",c),window.addEventListener("appinstalled",d),()=>{window.removeEventListener("beforeinstallprompt",c),window.removeEventListener("appinstalled",d)}},[r]);const i=async()=>{if(!s)return;s.prompt();const{outcome:c}=await s.userChoice;console.log(c==="accepted"?"PWA installation accepted":"PWA installation dismissed"),t(null),a(!1)},l=()=>{a(!1),localStorage.setItem("pwa-install-dismissed","true")};return r||!n||localStorage.getItem("pwa-install-dismissed")==="true"?null:e.jsx("div",{className:"fixed bottom-4 left-4 right-4 z-50 md:left-auto md:right-4 md:max-w-sm",children:e.jsxs(St,{className:"border-2 border-blue-500 shadow-lg",children:[e.jsxs(Ts,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(As,{className:"text-lg",children:"Install StillRoot"}),e.jsx(k,{variant:"ghost",size:"sm",onClick:l,className:"h-6 w-6 p-0",children:e.jsx(le,{className:"h-4 w-4"})})]}),e.jsx(Ls,{children:"Install StillRoot for a better experience with offline access and faster loading."})]}),e.jsx(ss,{className:"pt-0",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{onClick:i,className:"flex-1",children:"Install App"}),e.jsx(k,{variant:"outline",onClick:l,children:"Maybe Later"})]})})]})})},dh=()=>{const[s,t]=h.useState(!1),[n,a]=h.useState(!1);h.useEffect(()=>{const i=()=>{t(!0)};return"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",l=>{l.data&&l.data.type==="SW_UPDATE_AVAILABLE"&&t(!0)}),()=>{"serviceWorker"in navigator&&navigator.serviceWorker.removeEventListener("message",i)}},[]);const r=async()=>{a(!0);try{if("serviceWorker"in navigator){const i=await navigator.serviceWorker.getRegistration();i&&i.waiting&&i.waiting.postMessage({type:"SKIP_WAITING"})}window.location.reload()}catch(i){console.error("Failed to update app:",i),a(!1)}},o=()=>{t(!1)};return s?e.jsx("div",{className:"fixed top-4 left-4 right-4 z-50 md:left-auto md:right-4 md:max-w-sm",children:e.jsxs(St,{className:"border-2 border-green-500 shadow-lg",children:[e.jsxs(Ts,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(As,{className:"text-lg flex items-center gap-2",children:[e.jsx(as,{className:"h-5 w-5"}),"Update Available"]}),e.jsx(k,{variant:"ghost",size:"sm",onClick:o,className:"h-6 w-6 p-0",children:e.jsx(le,{className:"h-4 w-4"})})]}),e.jsx(Ls,{children:"A new version of StillRoot is available. Update now for the latest features and improvements."})]}),e.jsx(ss,{className:"pt-0",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{onClick:r,disabled:n,className:"flex-1",children:n?e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"mr-2 h-4 w-4 animate-spin"}),"Updating..."]}):"Update Now"}),e.jsx(k,{variant:"outline",onClick:o,children:"Later"})]})})]})}):null},uh=()=>{const[s,t]=h.useState({isInstalled:!1,isOnline:navigator.onLine,isUpdateAvailable:!1,installPrompt:null});return h.useEffect(()=>{const r=()=>{const u=window.matchMedia("(display-mode: standalone)").matches,m=window.navigator.standalone===!0;t(p=>({...p,isInstalled:u||m}))},o=()=>t(u=>({...u,isOnline:!0})),i=()=>t(u=>({...u,isOnline:!1})),l=u=>{u.preventDefault(),t(m=>({...m,installPrompt:u}))},c=()=>{t(u=>({...u,isInstalled:!0,installPrompt:null}))},d=()=>{t(u=>({...u,isUpdateAvailable:!0}))};return r(),window.addEventListener("online",o),window.addEventListener("offline",i),window.addEventListener("beforeinstallprompt",l),window.addEventListener("appinstalled",c),"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",u=>{u.data&&u.data.type==="SW_UPDATE_AVAILABLE"&&d()}),()=>{window.removeEventListener("online",o),window.removeEventListener("offline",i),window.removeEventListener("beforeinstallprompt",l),window.removeEventListener("appinstalled",c)}},[]),{...s,installApp:async()=>{if(!s.installPrompt)return!1;try{const r=s.installPrompt;r.prompt();const{outcome:o}=await r.userChoice;return o==="accepted"?(t(i=>({...i,installPrompt:null})),!0):!1}catch(r){return console.error("Failed to install app:",r),!1}},updateApp:async()=>{try{if("serviceWorker"in navigator){const r=await navigator.serviceWorker.getRegistration();r&&r.waiting&&r.waiting.postMessage({type:"SKIP_WAITING"})}window.location.reload()}catch(r){console.error("Failed to update app:",r)}}}},hh=Ia("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 dark:bg-destructive/60",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function De({className:s,variant:t,asChild:n=!1,...a}){const r=n?fo:"span";return e.jsx(r,{"data-slot":"badge",className:M(hh({variant:t}),s),...a})}const mh=()=>{const{isInstalled:s,isOnline:t,isUpdateAvailable:n}=uh();return s&&t&&!n?null:e.jsxs("div",{className:"fixed top-4 right-4 z-40 flex gap-2",children:[!t&&e.jsxs(De,{variant:"destructive",className:"flex items-center gap-1",children:[e.jsx(wc,{className:"h-3 w-3"}),"Offline"]}),n&&e.jsxs(De,{variant:"default",className:"flex items-center gap-1",children:[e.jsx(as,{className:"h-3 w-3"}),"Update Available"]})]})},Dr="https://firebase-auth-api.agentverse.cc",gh="firebase-api.agentverse.cc",ii={apiKey:"AIzaSyAR5kNhhjt2-oJWbbZm_JmyqCT2EkTT60E",authDomain:"echo-note-9fe01.firebaseapp.com",projectId:"echo-note-9fe01",storageBucket:"echo-note-9fe01.firebasestorage.app",messagingSenderId:"339659564131",appId:"1:339659564131:web:2d7e9782ac4423d3384456",measurementId:"G-QS4CHWNFH2"},li=Ed(ii),ph=Id(li,{host:gh,ssl:!0,ignoreUndefinedProperties:!0,experimentalForceLongPolling:!1}),fh=s=>{const t=localStorage.getItem("region");return t||s},xh=s=>{localStorage.setItem("region",s)},_r="CN";class ts{static instance=null;app=li;auth=null;analytics=null;db=ph;region=fh(_r);constructor(){this.getAuth(),this.validateRegionAndMaybeReloadPage()}static getInstance(){return ts.instance||(ts.instance=new ts),ts.instance}getApp(){return this.app}isInCNRegion(){return this.region===_r}supportGoogleAuth(){return!this.isInCNRegion()}async fetchRegion(){let t="";try{const n=await fetch(`${Dr}/api/location`);n.ok&&(t=(await n.json()).country||"XX")}catch(n){console.error("Failed to fetch user country, using restricted auth.",n)}return t}async validateRegionAndMaybeReloadPage(){const t=await this.fetchRegion();xh(t),t!==this.region&&window.location.reload()}getAuth(){return this.auth||(this.isInCNRegion()?(this.auth=yd(this.getApp(),{persistence:Nd}),wd(this.auth,Dr,{disableWarnings:!0})):this.auth=jd(this.getApp())),this.auth}getAnalytics(){return this.analytics?this.analytics:this.isInCNRegion()?(console.log("[FirebaseConfig] In CN region, Analytics is disabled."),null):(console.log("[FirebaseConfig] Initializing Analytics for non-CN region."),ii.measurementId?this.analytics=fd(this.getApp()):console.warn("[FirebaseConfig] measurementId is not provided, Analytics will not be initialized."),this.analytics)}setUserIdForAnalytics(t){this.getAnalytics()&&xd(this.getAnalytics(),t)}getDb(){return this.db}}const J=ts.getInstance(),Pr=["ðŸ’¡","ðŸ“","ðŸ“Œ","ðŸ“š","ðŸ§ ","âœ¨","ðŸ“","ðŸ“’","ðŸ““","ðŸ—‚ï¸","ðŸŒŸ","ðŸ§©","ðŸ—’ï¸","ðŸ“Ž","ðŸ—³ï¸","ðŸŽ¯"];function ma(s){const t=Math.floor(Math.random()*Pr.length);return Pr[t]}const ga="echonote-recent-channels",bh=8;function vh(s){try{const t=localStorage.getItem(ga);let n=t?JSON.parse(t):[];n=n.filter(a=>a.channelId!==s),n.unshift({channelId:s,accessedAt:Date.now()}),n=n.slice(0,bh),localStorage.setItem(ga,JSON.stringify(n))}catch(t){console.warn("Failed to save recent channel",t)}}function yh(){try{const s=localStorage.getItem(ga);return s?JSON.parse(s).map(n=>n.channelId):[]}catch(s){return console.warn("Failed to load recent channels",s),[]}}const W=Ee()(At((s,t)=>({currentChannelId:null,isAddingMessage:!1,isUpdatingMessage:!1,isDeletingMessage:!1,currentUser:null,authIsReady:!1,setAuth:n=>{s({currentUser:n,authIsReady:!0})},setCurrentChannel:n=>{s({currentChannelId:n}),n&&vh(n)},setIsAddingMessage:n=>{s({isAddingMessage:n})},setIsUpdatingMessage:n=>{s({isUpdatingMessage:n})},setIsDeletingMessage:n=>{s({isDeletingMessage:n})},addMessage:async n=>{t().setIsAddingMessage(!0);try{await O.getState().addMessage(n)}finally{t().setIsAddingMessage(!1)}},deleteMessage:async n=>{t().setIsDeletingMessage(!0);try{await O.getState().deleteMessage(n)}finally{t().setIsDeletingMessage(!1)}},updateMessage:async(n,a)=>{t().setIsUpdatingMessage(!0);try{await O.getState().updateMessage(n,a)}finally{t().setIsUpdatingMessage(!1)}}}),{name:"echonote-notes-view-storage"}));class dn extends Pd{emit(t){this.next(t)}listen(t){const n=this.subscribe(t);return()=>n.unsubscribe()}}const en=s=>{const t=s.data();return{id:s.id,name:t.name,description:t.description,emoji:t.emoji,createdAt:t.createdAt?.toDate()||new Date,updatedAt:t.updatedAt?t.updatedAt.toDate():void 0,messageCount:t.messageCount||0,lastMessageTime:t.lastMessageTime?.toDate(),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor,shareToken:t.shareToken,shareMode:t.shareMode||(t.shareToken?"read-only":void 0)}},Qt=s=>{const t=s.data();let n;return t.timestamp?t.timestamp instanceof Ld||t.timestamp.toDate&&typeof t.timestamp.toDate=="function"?n=t.timestamp.toDate():t.timestamp instanceof Date?n=t.timestamp:(console.warn("Invalid timestamp format in document:",s.id,t.timestamp),n=new Date):(console.warn("Missing timestamp in document:",s.id),n=new Date),{id:s.id,content:t.content,sender:t.sender,channelId:t.channelId,timestamp:n,tags:t.tags,parentId:t.parentId,threadId:t.threadId,isThreadExpanded:t.isThreadExpanded,threadCount:t.threadCount,aiAnalysis:t.aiAnalysis,isDeleted:t.isDeleted||!1,deletedAt:t.deletedAt?t.deletedAt.toDate():void 0,deletedBy:t.deletedBy,canRestore:t.canRestore}},Qe=s=>Ae(J.getDb(),`users/${s}/channels`),He=s=>Ae(J.getDb(),`users/${s}/messages`);class wh{async getChannel(t,n){try{const a=await Qe(t),o=(await ge(ce(a,Q("isDeleted","==",!1),Q("__name__","==",n)))).docs[0];return o?en(o):null}catch(a){return console.warn("[firebaseNotesService.getChannel] failed",a),null}}subscribeToChannels=(t,n)=>{console.log("ðŸ”” [firebaseNotesService][subscribeToChannels]:",{userId:t});const a=ce(Qe(t),Q("isDeleted","==",!1),Re("lastMessageTime","desc"));return Ms(a,o=>{const i=o.docs.map(en);n(i)},o=>{console.error("Error subscribing to channels:",o)})};subscribeToChannelMessages=(t,n,a,r)=>{console.log("ðŸ”” [firebaseNotesService][subscribeToChannelMessages]:",{userId:t,channelId:n,messagesLimit:a});const o=ce(He(t),Q("isDeleted","==",!1),Q("channelId","==",n),Q("sender","==","user"),Re("timestamp","desc"),wt(a));return Ms(o,l=>{const c=l.docs.map(Qt),d=c.length>=a;r(c,d)},l=>{console.error("Error subscribing to channel messages:",l)})};fetchChannels=async t=>{console.log("ðŸ”” [firebaseNotesService][fetchChannels]:",{userId:t});const n=ce(Qe(t),Q("isDeleted","==",!1),Re("lastMessageTime","desc"));return(await ge(n)).docs.map(en)};createChannel=async(t,n)=>{const a=Object.fromEntries(Object.entries(n).filter(([,o])=>o!==void 0));return(await qn(Qe(t),{...a,createdAt:Z(),updatedAt:Z(),messageCount:0,isDeleted:!1,lastMessageTime:Z()})).id};updateChannel=async(t,n,a)=>{const r=se(Qe(t),n),o={};for(const[i,l]of Object.entries(a))l===void 0?o[i]=Rd():o[i]=l;o.updatedAt=Z(),await be(r,o)};deleteChannel=async(t,n)=>{console.log("ðŸ”” [firebaseNotesService][deleteChannel]:",{userId:t,channelId:n});const a=se(Qe(t),n);await be(a,{isDeleted:!0,deletedAt:Z(),deletedBy:t});try{const r=ce(He(t),Q("channelId","==",n),Q("isDeleted","==",!1)),o=await ge(r),i=500;for(let l=0;l<o.docs.length;l+=i){const d=o.docs.slice(l,l+i).map(u=>be(u.ref,{isDeleted:!0,deletedAt:Z(),deletedBy:t,deletedChannelId:n}));await Promise.all(d)}console.log("ðŸ”” [firebaseNotesService][deleteChannel]: Successfully soft deleted channel and messages",{channelId:n,messageCount:o.docs.length})}catch(r){throw console.error("ðŸ”” [firebaseNotesService][deleteChannel]: Error soft deleting messages:",r),new Error(`Channel soft deleted but failed to soft delete associated messages: ${r}`)}};restoreChannel=async(t,n)=>{console.log("ðŸ”” [firebaseNotesService][restoreChannel]:",{userId:t,channelId:n});const a=se(Qe(t),n);await be(a,{isDeleted:!1,deletedAt:null,deletedBy:null});try{const r=ce(He(t),Q("channelId","==",n),Q("isDeleted","==",!0),Q("deletedChannelId","==",n)),o=await ge(r),i=500;for(let l=0;l<o.docs.length;l+=i){const d=o.docs.slice(l,l+i).map(u=>be(u.ref,{isDeleted:!1,deletedAt:null,deletedBy:null,deletedChannelId:null}));await Promise.all(d)}console.log("ðŸ”” [firebaseNotesService][restoreChannel]: Successfully restored channel and messages",{channelId:n,messageCount:o.docs.length})}catch(r){throw console.error("ðŸ”” [firebaseNotesService][restoreChannel]: Error restoring messages:",r),new Error(`Channel restored but failed to restore associated messages: ${r}`)}};fetchInitialMessages=async(t,n,a)=>{console.log("ðŸ”” [firebaseNotesService][fetchInitialMessages]:",{userId:t,channelId:n,messagesLimit:a});const r=ce(He(t),Q("isDeleted","==",!1),Q("channelId","==",n),Q("sender","==","user"),Re("timestamp","desc"),wt(a)),o=await ge(r),i=o.docs.map(Qt),l=o.docs[o.docs.length-1],c=i.length<a;return{messages:i,lastVisible:l,allLoaded:c}};fetchInitialMessagesAllSenders=async(t,n,a)=>{const r=ce(He(t),Q("isDeleted","==",!1),Q("channelId","==",n),Re("timestamp","desc"),wt(a));try{const o=await ge(r),i=o.docs.map(Qt),l=o.docs[o.docs.length-1],c=i.length<a;return{messages:i,lastVisible:l,allLoaded:c}}catch(o){throw console.error("âŒ [firebaseNotesService][fetchInitialMessagesAllSenders] failed",o),o}};fetchMoreMessages=async(t,n,a,r)=>{console.log("ðŸ”” [firebaseNotesService][fetchMoreMessages]:",{userId:t,channelId:n,messagesLimit:a,cursor:r});const o=ce(He(t),Q("isDeleted","==",!1),Q("channelId","==",n),Q("sender","==","user"),Re("timestamp","desc"),la(r),wt(a)),i=await ge(o),l=i.docs.map(Qt),c=i.docs[i.docs.length-1],d=l.length<a;return{messages:l,lastVisible:c,allLoaded:d}};subscribeToNewMessages=(t,n,a,r)=>{console.log("ðŸ”” [firebaseNotesService][subscribeToNewMessages]:",{userId:t,channelId:n,afterTimestamp:a});const o=ce(He(t),Q("isDeleted","==",!1),Q("channelId","==",n),Q("sender","==","user"),Q("timestamp",">",a),Re("timestamp","desc"));return Ms(o,l=>{const c=l.docs.map(Qt);r(c)},l=>{console.error("Error subscribing to new messages:",l)})};createMessage=async(t,n)=>{const a=Object.fromEntries(Object.entries(n).filter(([,i])=>i!==void 0)),r=await qn(He(t),{...a,timestamp:Z(),isDeleted:!1}),o=se(Qe(t),n.channelId);return await be(o,{lastMessageTime:Z(),messageCount:zt(1)}),r.id};updateMessage=async(t,n,a)=>{const r=se(J.getDb(),`users/${t}/messages/${n}`);await be(r,a)};moveMessage=async(t,n,a,r)=>{if(a===r)return;const o=J.getDb(),i=se(o,`users/${t}/messages/${n}`),l=await jt(i);if(!l.exists())throw new Error("Message not found");if(l.data()?.channelId===r)return;const d=await ge(ce(He(t),Q("threadId","==",n))),u=Td(o);u.update(i,{channelId:r}),d.docs.forEach(g=>{u.update(g.ref,{channelId:r})});const m=1+d.docs.length,p=se(Qe(t),a),f=se(Qe(t),r);u.update(p,{messageCount:zt(-m),updatedAt:Z()}),u.update(f,{messageCount:zt(m),lastMessageTime:Z(),updatedAt:Z()}),await u.commit()};deleteMessage=async(t,n)=>{const a=se(J.getDb(),`users/${t}/messages/${n}`);await cn(a)};softDeleteMessage=async(t,n)=>{const a=se(J.getDb(),`users/${t}/messages/${n}`);await be(a,{isDeleted:!0,deletedAt:Z(),deletedBy:t})};restoreMessage=async(t,n)=>{const a=se(J.getDb(),`users/${t}/messages/${n}`);await be(a,{isDeleted:!1,deletedAt:null,deletedBy:null})};getDeletedMessages=async(t,n)=>{console.log("ðŸ”” [firebaseNotesService][getDeletedMessages]:",{userId:t,channelId:n});try{let a=ce(He(t),Q("isDeleted","==",!0),Re("deletedAt","desc"));return n&&(a=ce(He(t),Q("isDeleted","==",!0),Q("channelId","==",n),Q("sender","==","user"),Re("deletedAt","desc"))),(await ge(a)).docs.map(Qt)}catch(a){return console.error("ðŸ”” [Firebase] [getDeletedMessages]: Error fetching deleted messages:",a),[]}};publishSpace=async(t,n,a="read-only")=>{const r=It();return await this.updateChannel(t,n,{shareToken:r,shareMode:a}),r};unpublishSpace=async(t,n)=>{await this.updateChannel(t,n,{shareToken:void 0,shareMode:void 0})};findChannelByShareToken=async t=>{try{const n=J.getDb(),a=ce(Ad(n,"channels"),Q("shareToken","==",t),Q("isDeleted","==",!1),wt(1)),r=await ge(a);if(r.empty)return null;const o=r.docs[0],i=en(o),l=o.ref.path.split("/"),c=l.indexOf("users");if(c===-1||c+1>=l.length)return console.warn("[firebaseNotesService.findChannelByShareToken] Invalid document path:",o.ref.path),null;const d=l[c+1];return{channel:i,userId:d}}catch(n){return console.error("[firebaseNotesService.findChannelByShareToken] failed",n),null}};createMessageForPublicSpace=async(t,n)=>{const a=await this.findChannelByShareToken(t);if(!a)throw new Error("Channel not found or not published");if(a.channel.shareMode!=="append-only")throw new Error("This space is read-only. Messages cannot be added.");const r=Object.fromEntries(Object.entries(n).filter(([,l])=>l!==void 0)),o=await qn(He(a.userId),{...r,timestamp:Z(),isDeleted:!1}),i=se(Qe(a.userId),a.channel.id);return await be(i,{lastMessageTime:Z(),messageCount:zt(1)}),o.id}}const oe=new wh;class _n{capabilities={realtime:!0,pagination:"cursor"};static MAX_CURSOR_CACHE=256;cursorMap=new Map;async listChannels(t){return oe.fetchChannels(t)}subscribeChannels(t,n){return oe.subscribeToChannels(t,n)}async createChannel(t,n){return oe.createChannel(t,n)}async updateChannel(t,n,a){return oe.updateChannel(t,n,a)}async deleteChannel(t,n){return oe.deleteChannel(t,n)}async listMessages(t,n,a){const r=a.includeSenders??["user"],o=a.cursor??null,i=a.limit;if(!o){const m=r.includes("ai")&&r.includes("user")?await oe.fetchInitialMessagesAllSenders(t,n,i):await oe.fetchInitialMessages(t,n,i),p=m.allLoaded||!m.lastVisible?null:this.registerCursor(m.lastVisible);return{items:m.messages,nextCursor:p}}const l=this.cursorMap.get(o);if(!l)throw new Error("Invalid cursor (expired). Please reload messages.");this.cursorMap.delete(o),this.cursorMap.set(o,l);const c=await oe.fetchMoreMessages(t,n,i,l),d=c.allLoaded||!c.lastVisible?null:this.registerCursor(c.lastVisible);return{items:c.messages,nextCursor:d}}subscribeNewMessages(t,n,a,r){return oe.subscribeToNewMessages(t,n,a,r)}async createMessage(t,n){return oe.createMessage(t,n)}async updateMessage(t,n,a){return oe.updateMessage(t,n,a)}async deleteMessage(t,n,a={}){return a.hardDelete?oe.deleteMessage(t,n):oe.softDeleteMessage(t,n)}async restoreMessage(t,n){return oe.restoreMessage(t,n)}async moveMessage(t,n,a,r){return oe.moveMessage(t,n,a,r)}async publishSpace(t,n,a="read-only"){return oe.publishSpace(t,n,a)}async unpublishSpace(t,n){return oe.unpublishSpace(t,n)}registerCursor(t){const n=It();if(this.cursorMap.set(n,t),this.cursorMap.size>_n.MAX_CURSOR_CACHE){const a=this.cursorMap.keys().next().value;a&&this.cursorMap.delete(a)}return n}}function ys(s){return{id:s.uid,email:s.email,displayName:s.displayName,emailVerified:s.emailVerified,photoURL:s.photoURL}}class ci{async signInWithGoogle(){const t=await xe.signInWithGoogle();return t?ys(t):null}async signInWithEmail(t,n){const a=await xe.signInWithEmail(t,n);return a?ys(a):null}async signUpWithEmail(t,n,a){const r=await xe.signUpWithEmail(t,n,a);return{user:ys(r.user),verificationSent:r.verificationSent}}async sendSignUpLink(t,n,a){return xe.sendSignUpLink(t,n,a)}async sendPasswordReset(t){return xe.sendPasswordReset(t)}async sendEmailVerification(){const t=await xe.getCurrentUser();if(!t)throw new Error("No user logged in");return xe.sendEmailVerification(t)}async signOut(){return xe.signOut()}async getCurrentUser(){const t=await xe.getCurrentUser();return t?ys(t):null}onAuthStateChanged(t){let n=null;return xe.onAuthStateChanged(a=>{t(a?ys(a):null)}).then(a=>{n=a}),()=>{n&&n()}}}class jh{version="1.0.0";name="Add isDeleted field to messages";description="Add isDeleted field to all messages to support soft delete functionality";createdAt=new Date("2025-01-27");async execute(t){const n=J.getDb(),a=Ae(n,`users/${t}/messages`),r=await ge(a);let o=0;for(const i of r.docs)if(i.data().isDeleted===void 0){const c=se(a,i.id);await be(c,{isDeleted:!1}),o++}o>0?console.log(`   ðŸ“Š Updated ${o} messages with isDeleted field`):console.log("   â„¹ï¸  No messages needed updating")}}class Nh{version="1.0.1";name="Add lastMessageTime to channels";description="Add lastMessageTime and messageCount fields to all channels for sorting and statistics";createdAt=new Date("2025-01-27");async execute(t){const n=J.getDb(),a=Ae(n,`users/${t}/channels`),r=await ge(a);let o=0;for(const i of r.docs){const l=i.data();if(!l.lastMessageTime){const c=se(a,i.id),d=ce(Ae(n,`users/${t}/messages`),Q("channelId","==",i.id),Re("timestamp","desc"),wt(1)),u=await ge(d);if(u.empty)await be(c,{lastMessageTime:l.createdAt||Z(),messageCount:0});else{const p=u.docs[0].data().timestamp;await be(c,{lastMessageTime:p,messageCount:u.size})}o++}}o>0?console.log(`   ðŸ“Š Updated ${o} channels with lastMessageTime field`):console.log("   â„¹ï¸  No channels needed updating")}}class Ch{version="1.1.0";name="Add isDeleted field to channels";description="Add isDeleted field to all channels to support soft delete functionality";createdAt=new Date("2025-01-27");async execute(t){const n=J.getDb(),a=Ae(n,`users/${t}/channels`),r=await ge(a);let o=0;for(const i of r.docs)if(i.data().isDeleted===void 0){const c=se(a,i.id);await be(c,{isDeleted:!1}),o++}o>0?console.log(`   ðŸ“Š Updated ${o} channels with isDeleted field`):console.log("   â„¹ï¸  No channels needed updating")}}class kh{version="1.2.0";name="Create default General channel";description="Create a default channel named 'General' if the user has no channels";createdAt=new Date("2025-02-01");async execute(t){const n=J.getDb(),a=Ae(n,`users/${t}/channels`),r=se(a,"default-general"),o=await ge(ce(a,Q("isDeleted","==",!1),wt(1))),i=(await jt(r)).exists();!o.empty||i||await Es(r,{name:"General",description:"",createdAt:Z(),updatedAt:Z(),messageCount:0,isDeleted:!1,lastMessageTime:Z()})}}class ie{static PREFIX="[Migration]";static PREFIX_STATE="[MigrationState]";static PREFIX_EXECUTOR="[MigrationExecutor]";static PREFIX_SERVICE="[MigrationService]";static printHeader(t){console.log(`${this.PREFIX} ðŸš€ Starting migrations for user: ${t}`)}static printOverview(t,n,a){console.log(`${this.PREFIX} ðŸ“Š Status: ${t} total, ${n} completed, ${a} pending`)}static printAllCompleted(t){console.log(`${this.PREFIX} âœ… All migrations completed (${t} skipped)`)}static printPendingMigrations(t){console.log(`${this.PREFIX} ðŸš€ Pending migrations (${t.length}):`),t.forEach((n,a)=>{console.log(`${this.PREFIX}    ${a+1}. [${n.version}] ${n.name}`)})}static printMigrationStart(t,n,a){console.log(`${this.PREFIX} ðŸ”„ ${t} Executing: ${n} - ${a}`)}static printMigrationComplete(){console.log(`${this.PREFIX}    âœ… Completed`)}static printMigrationFailure(t){const n=t instanceof Error?t.message:String(t);console.log(`${this.PREFIX}    âŒ Failed: ${n}`)}static printExecutionSummary(t,n,a){console.log(`${this.PREFIX} ðŸ“ˆ Summary: ${t} executed, ${n} failed, ${a} skipped`),n===0&&console.log(`${this.PREFIX} ðŸŽ‰ All migrations completed successfully!`)}static printCriticalError(t){console.error(`${this.PREFIX} ðŸ’¥ Critical error:`,t)}static printStateInfo(t){console.log(`${this.PREFIX_STATE} â„¹ï¸  ${t}`)}static printStateError(t,n){console.error(`${this.PREFIX_STATE} âŒ ${t}`,n||"")}static printExecutorInfo(t){console.log(`${this.PREFIX_EXECUTOR} â„¹ï¸  ${t}`)}static printExecutorError(t,n){console.error(`${this.PREFIX_EXECUTOR} âŒ ${t}`,n||"")}static printServiceInfo(t){console.log(`${this.PREFIX_SERVICE} â„¹ï¸  ${t}`)}static printServiceError(t,n){console.error(`${this.PREFIX_SERVICE} âŒ ${t}`,n||"")}}const Se=()=>({channel:{autoCreateDefault:{enabled:!0},settings:{enabled:!1},input:{emoji:{enabled:!1},image:{enabled:!1},file:{enabled:!1},voice:{enabled:!1},more:{enabled:!1},call:{enabled:!1},video:{enabled:!1}},thoughtRecord:{edit:{enabled:!0},sparks:{enabled:!0},viewDetails:{enabled:!1},bookmark:{enabled:!1},reply:{enabled:!1},tags:{enabled:!0},thread:{enabled:!1}}},ui:{globalProcess:{workspaceInit:{displayMode:"fullscreen"},branding:{enabled:!0,brandName:"StillRoot"}}},data:{migrations:{enabled:!1}}});class Sh{getMigrationsCollectionRef=t=>Ae(J.getDb(),`users/${t}/migrations`);async getUserMigrationState(t){try{const n=se(this.getMigrationsCollectionRef(t),"state"),a=await jt(n);if(a.exists()){const r=a.data();return{userId:t,completedMigrations:r.completedMigrations||[],lastMigrationCheck:r.lastMigrationCheck?.toDate()||new Date,version:r.version||"1.0.0"}}return{userId:t,completedMigrations:[],lastMigrationCheck:new Date,version:"1.0.0"}}catch(n){return ie.printStateError("Failed to get migration state",n),{userId:t,completedMigrations:[],lastMigrationCheck:new Date,version:"1.0.0"}}}async updateUserMigrationState(t,n,a){try{const r=se(this.getMigrationsCollectionRef(t),"state");await Es(r,{userId:t,completedMigrations:n,lastMigrationCheck:Z(),version:a}),ie.printStateInfo(`Updated migration state for user ${t}`)}catch(r){throw ie.printStateError("Failed to update migration state",r),r}}async markMigrationCompleted(t,n){try{const a=await this.getUserMigrationState(t),r=[...new Set([...a.completedMigrations,n])];await this.updateUserMigrationState(t,r,a.version),ie.printStateInfo(`Migration ${n} marked as completed for user ${t}`)}catch(a){throw ie.printStateError("Failed to mark migration as completed",a),a}}async resetMigrationState(t){try{await this.updateUserMigrationState(t,[],"1.0.0"),ie.printStateInfo(`Migration state reset for user ${t}`)}catch(n){throw ie.printStateError("Failed to reset migration state",n),n}}}class Mh{migrations=[new jh,new Nh,new Ch,new kh].filter(Boolean);getAllMigrations(){return this.migrations}getPendingMigrations(t){return this.migrations.filter(n=>!t.includes(n.version))}async executeMigration(t,n){try{ie.printExecutorInfo(`Starting migration ${t.version}: ${t.name}`),await t.execute(n),ie.printExecutorInfo(`Migration ${t.version} completed successfully`)}catch(a){throw ie.printExecutorError(`Migration ${t.version} failed`,a),a}}addMigration(t){this.migrations.push(t),ie.printExecutorInfo(`Added new migration: ${t.version} - ${t.name}`)}}class Eh{inProgressUsers=new Set;stateManager=new Sh;executorManager=new Mh;async runAllMigrations(t){try{if(this.inProgressUsers.has(t)){ie.printServiceInfo(`Migration already in progress for user: ${t}, skipping duplicate trigger`);return}this.inProgressUsers.add(t),ie.printHeader(t);const n=await this.stateManager.getUserMigrationState(t),a=this.executorManager.getAllMigrations(),r=this.executorManager.getPendingMigrations(n.completedMigrations),o=a.filter(c=>n.completedMigrations.includes(c.version));if(ie.printOverview(a.length,o.length,r.length),r.length===0){ie.printAllCompleted(o.length);return}ie.printPendingMigrations(r);let i=0,l=0;for(let c=0;c<r.length;c++){const d=r[c],u=`[${c+1}/${r.length}]`;try{ie.printMigrationStart(u,d.version,d.name),await this.executorManager.executeMigration(d,t),await this.stateManager.markMigrationCompleted(t,d.version),ie.printMigrationComplete(),i++}catch(m){ie.printMigrationFailure(m),l++}}ie.printExecutionSummary(i,l,o.length)}catch(n){throw ie.printCriticalError(n),n}finally{this.inProgressUsers.delete(t)}}async checkMigrationStatus(t){try{const n=await this.stateManager.getUserMigrationState(t),a=this.executorManager.getAllMigrations(),r=this.executorManager.getPendingMigrations(n.completedMigrations),o=a.filter(u=>n.completedMigrations.includes(u.version)),l=(await ge(Ae(J.getDb(),`users/${t}/messages`))).docs.filter(u=>u.data().isDeleted===void 0).length,d=(await ge(Ae(J.getDb(),`users/${t}/channels`))).docs.filter(u=>!u.data().lastMessageTime).length;return ie.printServiceInfo(`Status check: ${r.length} pending, ${l} messages, ${d} channels need migration`),{messagesNeedMigration:l,channelsNeedMigration:d,pendingMigrations:r.map(u=>u.version),lastMigrationCheck:n.lastMigrationCheck,totalMigrations:a.length,completedMigrations:o.length,skippedMigrations:o.length}}catch(n){throw ie.printServiceError("Failed to check migration status",n),n}}async forceRerunAllMigrations(t){try{ie.printServiceInfo(`Force rerunning all migrations for user: ${t}`),await this.stateManager.resetMigrationState(t),await this.runAllMigrations(t),ie.printServiceInfo("Force rerun completed successfully")}catch(n){throw ie.printServiceError("Force rerun failed",n),n}}addMigration(t){this.executorManager.addMigration(t)}}const di=new Eh;class Ih{backend="firebase";notes=new _n;auth=new ci;async initializeForUser(t){await di.runAllMigrations(t)}}const Th="echonote-local-notes:";function ui(s){return`${Th}${s}`}function Kn(s){return{...s,createdAt:new Date(s.createdAt),updatedAt:s.updatedAt?new Date(s.updatedAt):void 0,lastMessageTime:s.lastMessageTime?new Date(s.lastMessageTime):void 0}}function un(s){return{...s,createdAt:s.createdAt.toISOString(),updatedAt:s.updatedAt?s.updatedAt.toISOString():void 0,lastMessageTime:s.lastMessageTime?s.lastMessageTime.toISOString():void 0}}function Zt(s){return{...s,timestamp:new Date(s.timestamp),deletedAt:s.deletedAt?new Date(s.deletedAt):void 0}}function ws(s){return{...s,timestamp:s.timestamp.toISOString(),deletedAt:s.deletedAt?s.deletedAt.toISOString():void 0}}function Ve(s){const t=localStorage.getItem(ui(s));if(!t)return{channels:[],messagesByChannel:{}};try{const n=JSON.parse(t);return{channels:Array.isArray(n.channels)?n.channels:[],messagesByChannel:n.messagesByChannel&&typeof n.messagesByChannel=="object"?n.messagesByChannel:{}}}catch{return{channels:[],messagesByChannel:{}}}}function lt(s,t){localStorage.setItem(ui(s),JSON.stringify(t))}function st(s){const t=Ve(s);if(t.channels.length>0)return;const n=new Date,a={id:It(),name:"General",description:"Your local workspace",emoji:"ðŸ“",createdAt:n,updatedAt:n,messageCount:0,lastMessageTime:void 0,backgroundColor:void 0,backgroundImage:void 0,shareToken:void 0,shareMode:void 0};t.channels=[un(a)],t.messagesByChannel[a.id]=[],lt(s,t)}function Ah(s){if(!s)return 0;const t=Number(s);return Number.isFinite(t)&&t>=0?t:0}class hi{capabilities={realtime:!0,pagination:"cursor"};async listChannels(t){return st(t),Ve(t).channels.map(Kn).sort((a,r)=>{const o=a.lastMessageTime?.getTime()??a.updatedAt?.getTime()??a.createdAt.getTime();return(r.lastMessageTime?.getTime()??r.updatedAt?.getTime()??r.createdAt.getTime())-o})}subscribeChannels(t,n){return this.listChannels(t).then(n),()=>{}}async createChannel(t,n){st(t);const a=Ve(t),r=new Date,o=It(),i={id:o,name:n.name,description:n.description,emoji:n.emoji,createdAt:r,updatedAt:r,messageCount:0,lastMessageTime:void 0,backgroundColor:n.backgroundColor,backgroundImage:n.backgroundImage,shareToken:void 0,shareMode:void 0};return a.channels.unshift(un(i)),a.messagesByChannel[o]=[],lt(t,a),o}async updateChannel(t,n,a){st(t);const r=Ve(t),o=r.channels.findIndex(c=>c.id===n);if(o<0)return;const l={...Kn(r.channels[o]),...a,updatedAt:new Date};r.channels[o]=un(l),lt(t,r)}async deleteChannel(t,n){st(t);const a=Ve(t);a.channels=a.channels.filter(r=>r.id!==n),delete a.messagesByChannel[n],lt(t,a)}async listMessages(t,n,a){st(t);const i=(Ve(t).messagesByChannel[n]??[]).map(Zt).filter(p=>!p.isDeleted).filter(p=>(a.includeSenders??["user"]).includes(p.sender)).sort((p,f)=>f.timestamp.getTime()-p.timestamp.getTime()),l=Ah(a.cursor??null),c=Math.max(1,a.limit),d=i.slice(l,l+c),u=l+d.length,m=u>=i.length?null:String(u);return{items:d,nextCursor:m}}subscribeNewMessages(t,n,a,r){let o=!0,i=a.getTime();const l=()=>{if(!o)return;const u=(Ve(t).messagesByChannel[n]??[]).map(Zt).filter(m=>!m.isDeleted).filter(m=>m.sender==="user").filter(m=>m.timestamp.getTime()>i).sort((m,p)=>m.timestamp.getTime()-p.timestamp.getTime());u.length>0&&(i=u[u.length-1].timestamp.getTime(),r(u)),setTimeout(l,1500)};return setTimeout(l,1500),()=>{o=!1}}async createMessage(t,n){st(t);const a=Ve(t),r=It(),o=new Date,i={id:r,content:n.content,sender:n.sender,channelId:n.channelId,timestamp:o,tags:n.tags,parentId:n.parentId,threadId:n.threadId,isThreadExpanded:n.isThreadExpanded,threadCount:n.threadCount,aiAnalysis:n.aiAnalysis,isDeleted:!1,deletedAt:void 0,deletedBy:n.deletedBy,canRestore:n.canRestore,isNew:n.isNew},l=a.messagesByChannel[i.channelId]??[];l.unshift(ws(i)),a.messagesByChannel[i.channelId]=l;const c=a.channels.findIndex(d=>d.id===i.channelId);if(c>=0){const d=Kn(a.channels[c]),u={...d,messageCount:(d.messageCount??0)+1,lastMessageTime:o,updatedAt:o};a.channels[c]=un(u)}return lt(t,a),r}async updateMessage(t,n,a){st(t);const r=Ve(t);for(const[o,i]of Object.entries(r.messagesByChannel)){const l=i.findIndex(u=>u.id===n);if(l<0)continue;const d={...Zt(i[l]),...a};r.messagesByChannel[o][l]=ws(d),lt(t,r);return}}async deleteMessage(t,n,a={}){st(t);const r=Ve(t);for(const[o,i]of Object.entries(r.messagesByChannel)){const l=i.findIndex(c=>c.id===n);if(!(l<0)){if(a.hardDelete)r.messagesByChannel[o]=i.filter(c=>c.id!==n);else{const d={...Zt(i[l]),isDeleted:!0,deletedAt:new Date};r.messagesByChannel[o][l]=ws(d)}lt(t,r);return}}}async restoreMessage(t,n){st(t);const a=Ve(t);for(const[r,o]of Object.entries(a.messagesByChannel)){const i=o.findIndex(d=>d.id===n);if(i<0)continue;const c={...Zt(o[i]),isDeleted:!1,deletedAt:void 0};a.messagesByChannel[r][i]=ws(c),lt(t,a);return}}async moveMessage(t,n,a,r){st(t);const o=Ve(t),i=o.messagesByChannel[a]??[],l=i.findIndex(m=>m.id===n);if(l<0)return;const c=Zt(i[l]);o.messagesByChannel[a]=i.filter(m=>m.id!==n);const d={...c,channelId:r},u=o.messagesByChannel[r]??[];u.unshift(ws(d)),o.messagesByChannel[r]=u,lt(t,o)}async publishSpace(t,n,a){throw new Error("Publishing requires an account. Please sign in.")}async unpublishSpace(t,n){throw new Error("Unpublishing requires an account. Please sign in.")}}class Lh{async signInWithGoogle(){return null}async signInWithEmail(t,n){return null}async signUpWithEmail(t,n,a){throw new Error("Local backend does not support sign-up")}async sendSignUpLink(t,n,a){throw new Error("Local backend does not support sign-up")}async sendPasswordReset(t){throw new Error("Local backend does not support password reset")}async sendEmailVerification(){throw new Error("Local backend does not support email verification")}async signOut(){}async getCurrentUser(){return null}onAuthStateChanged(t){return t(null),()=>{}}}class Rh{backend="local";notes=new hi;auth=new Lh;async initializeForUser(t){}}const mi="echonote-guest-id",$a="guest:";function hn(s){return s.startsWith($a)}function gi(){const s=localStorage.getItem(mi);return!s||!s.startsWith($a)?null:s}function pa(){return gi()!==null}function Dh(){const s=gi();if(s)return s;const t=`${$a}${It()}`;return localStorage.setItem(mi,t),t}class _h{capabilities={realtime:!0,pagination:"cursor"};local=new hi;firebase=new _n;repoFor(t){return hn(t)?this.local:this.firebase}listChannels(t){return this.repoFor(t).listChannels(t)}subscribeChannels(t,n){const a=this.repoFor(t);return a.subscribeChannels?a.subscribeChannels(t,n):()=>{}}createChannel(t,n){return this.repoFor(t).createChannel(t,n)}updateChannel(t,n,a){return this.repoFor(t).updateChannel(t,n,a)}deleteChannel(t,n){return this.repoFor(t).deleteChannel(t,n)}listMessages(t,n,a){return this.repoFor(t).listMessages(t,n,a)}subscribeNewMessages(t,n,a,r){const o=this.repoFor(t);return o.subscribeNewMessages?o.subscribeNewMessages(t,n,a,r):()=>{}}createMessage(t,n){return this.repoFor(t).createMessage(t,n)}updateMessage(t,n,a){return this.repoFor(t).updateMessage(t,n,a)}deleteMessage(t,n,a){return this.repoFor(t).deleteMessage(t,n,a)}restoreMessage(t,n){return this.repoFor(t).restoreMessage(t,n)}moveMessage(t,n,a,r){return this.repoFor(t).moveMessage(t,n,a,r)}publishSpace(t,n,a){if(hn(t))throw new Error("Publishing requires an account. Please sign in.");return this.firebase.publishSpace(t,n,a)}unpublishSpace(t,n){if(hn(t))throw new Error("Unpublishing requires an account. Please sign in.");return this.firebase.unpublishSpace(t,n)}}class Ph{backend="hybrid";notes=new _h;auth=new ci;async initializeForUser(t){hn(t)||await di.runAllMigrations(t)}}const Oh=s=>{switch(s){case"firebase":return new Ih;case"local":return new Rh;case"hybrid":return new Ph}};let tn=null;const fe=()=>tn||(tn=Oh("hybrid"),tn);function $h(s,t=[]){const n=Mt.useRef(!0);Mt.useEffect(()=>n.current===!0?(n.current=!1,()=>{}):s(),t)}const Uh=()=>{let s=!1;const t=[];return{isFrozen:()=>s,freeze:()=>{s=!0},unfreeze:()=>{for(;t.length>0;)t.shift()();s=!1},submit:o=>{s?t.push(o):o()}}},fa=Uh();class Ua extends dt{next(t){fa.submit(()=>super.next(t))}}const xa=(s,t)=>{if(t){const n=t.split("::");let a=s.data;for(let r=0;r<n.length;r+=1){if(!a[n[r]])return a[n[r]];a=a[n[r]]}return a}else return s.data},zh=s=>typeof s=="object"&&s!==null?Array.isArray(s)?[...s]:{...s}:s,Fh=(s,t,n,a)=>{const r=xa(s,n);if(a===r)return;const o=(i,l,c)=>{l!==c&&i.$.next(l),Object.entries(i.children).forEach(([d,u])=>{o(u,l?.[d],c?.[d])})};if(fa.freeze(),!n)s.data=a,o(t,a,r);else{const i=n.split("::");let l=s.data,c=t;const d=[[c,l,void 0]];for(let x=0;x<i.length-1;x+=1)l[i[x]]===void 0&&(l[i[x]]={}),l=l[i[x]],c=c?.children[i[x]],d.push([c,l,i[x]]);const u=c?.children[i[i.length-1]];d.push([u,a,i[i.length-1]]);const m=[],p=[];let f,g;for(let x=d.length-1;x>=0;x-=1){const[y,v,w]=d[x];if(x===d.length-1)p.unshift([y,v]),f=w,g=v;else{const b=zh(v);b[f]=g,p.unshift([y,b]),f=w,g=b}}s.data=g;for(let x=0;x<p.length;x+=1){const[y,v]=p[x];if(y)m.push(()=>y.$.next(v));else break}m.reverse().forEach(x=>x()),u&&Object.entries(u.children).forEach(([x,y])=>{o(y,a?.[x],r?.[x])})}fa.unfreeze()},pi=(s,t,n)=>{if(n){const a=n.split("::");let r=s.data,o=t;for(let i=0;i<a.length;i+=1)i<a.length-1&&r[a[i]]===void 0&&(r[a[i]]={}),o.children[a[i]]===void 0&&(o.children[a[i]]={$:new Ua(r[a[i]]),children:{}}),r=r[a[i]],o=o.children[a[i]];return o}else return t},Bh=(s,t,n)=>{const{$:a}=pi(s,t,n),[,r]=h.useState(()=>a.getValue());return h.useEffect(()=>{const o=a.subscribe(i=>{r(i)});return()=>o.unsubscribe()},[a]),a.getValue()},fi=(s,t,n)=>{const a=t||{$:new Ua(s.data),children:{}},r=o=>n?`${n}::${o}`:o;return new Proxy({$$isBean:!0},{ownKeys(o){return Reflect.ownKeys(o).concat(["use","get","set","$","namespaces"])},get(o,i){if(i in o)return o[i];if(typeof i=="string"){if(["$","get","set","use"].includes(i)){const l=pi(s,a,n);if(i==="$")return l.$;if(i==="get")return l.get||(l.get=()=>xa(s,n)),l.get;if(i==="set")return l.set||(l.set=c=>Fh(s,a,n,typeof c=="function"?c(xa(s,n)):c)),l.set;if(i==="use")return l.use||(l.use=()=>Bh(s,a,n)),l.use}else if(i==="namespaces")return new Proxy({},{get(l,c){return fi(s,a,r(c))}})}else return o[i]}})},xi=(s,t,n)=>fi({data:s},t,n),Or=s=>{const t=h.useMemo(()=>new Ua(s),[]);return $h(()=>{t.next(s)},[s]),t},is=(s,t)=>t.split(".").reduce((a,r)=>a.namespaces[r],s),bi=s=>({value:s.use(),set:s.set,get:s.get}),Yn=async(s,t,n)=>{s();try{await t()}catch(a){throw n(),a}};class Hh{moreMessageLoadedEvent$=new dn;requestLoadInitialMessages$=new Uo(1);dataContainer=xi({messageByChannel:{}});handleRequestWorkflow$=this.requestLoadInitialMessages$.pipe(Ws((t,n)=>t.channelId===n.channelId&&t.messageLimit===n.messageLimit),Ln(t=>{const n=this.dataContainer.get().messageByChannel[t.channelId];return!n||n.hasMore&&!n.loading}),zo(t=>this.loadInitialMessages({channelId:t.channelId,messagesLimit:t.messageLimit||20})));connectToRequestWorkflow=()=>{const t=this.handleRequestWorkflow$.subscribe();return()=>t.unsubscribe()};getIsAnyChannelLoading$=t=>t.length?Fo(t.map(n=>is(this.dataContainer,`messageByChannel.${n}.loading`).$)).pipe(Ft(n=>n.some(a=>a))):Od(!1);getChannelStateControl=t=>{const n=is(this.dataContainer,`messageByChannel.${t}`),{get:a,namespaces:{loading:{set:r},loadingMore:{set:o},messages:{set:i},lastVisible:{set:l},hasMore:{set:c},subscription:{set:d}}}=n,u=g=>{const x=a().messages||[];if(x.find(v=>v.id===g.id))return;const y=x[x.length-1];y&&y.content===g.content?i([...x.slice(0,-1),g]):i([...x,g])},m=g=>{const x=a().messages||[];i(x.filter(y=>y.id!==g))},p=(g,x)=>{const y=a().messages||[],v=y.find(w=>w.id===x);i(v?y.filter(w=>w.id!==g):y.map(w=>w.id===g?{...w,id:x,isNew:!1}:w))},f=()=>{const g=a();i([]),r(!1),o(!1),c(!1),l(null),g?.subscription&&g.subscription.unsubscribe()};return{getChannelState:a,setLoading:r,setLoadingMore:o,addMessage:u,updateMessage:this.updateMessage,setMessages:i,setLastVisible:l,setHasMore:c,setSubscription:d,removeMessage:m,fixFakeMessage:p,clearChannel:f}};loadInitialMessages=async({channelId:t,messagesLimit:n})=>{console.log("[ChannelMessageService] loadInitialMessages",{channelId:t,messagesLimit:n});const{userId:a}=O.getState();if(console.log("[ChannelMessageService] loadInitialMessages",{channelId:t,messagesLimit:n,userId:a}),!a||!t)return;const{setLoading:r,addMessage:o,setLastVisible:i,setHasMore:l,setSubscription:c}=this.getChannelStateControl(t);r(!0);try{const d=await fe().notes.listMessages(a,t,{limit:n,cursor:null,includeSenders:["user"]});if(d.items.forEach(o),i(d.nextCursor),l(!!d.nextCursor),d.items.length>0){const u=d.items[0].timestamp,m=this.subscribeToNewMessages({channelId:t,afterTimestamp:u});c({unsubscribe:m})}}catch(d){console.error("Error loading initial messages:",d)}finally{r(!1)}};loadMoreHistory=async({channelId:t,messagesLimit:n})=>{const{userId:a}=O.getState();if(!a||!t)return;const{getChannelState:r,setLoadingMore:o,setLastVisible:i,setHasMore:l,setMessages:c}=this.getChannelStateControl(t),{loading:d,loadingMore:u,hasMore:m,lastVisible:p,messages:f}=r();if(!(!a||!t||!m||!p||d||u)){o(!0);try{const g=await fe().notes.listMessages(a,t,{limit:n,cursor:p,includeSenders:["user"]});if(g.items.length>0){const x=[...g.items,...f];c(x),i(g.nextCursor),this.moreMessageLoadedEvent$.emit({channelId:t,messages:g.items})}l(!!g.nextCursor)}catch(g){console.error("Error loading more messages:",g)}finally{o(!1)}}};subscribeToNewMessages=({channelId:t,afterTimestamp:n})=>{const{userId:a}=O.getState();if(!a||!t)return()=>{};const{addMessage:r,getChannelState:o,setSubscription:i}=this.getChannelStateControl(t),{subscription:l}=o();l&&(console.log("ðŸ”” [subscribeToNewMessages] å–æ¶ˆä¹‹å‰çš„è®¢é˜…"),l.unsubscribe()),console.log("ðŸ”” [subscribeToNewMessages] å¼€å§‹è®¢é˜…æ–°æ¶ˆæ¯",{channelId:t,afterTimestamp:n});const c=fe().notes;if(!c.subscribeNewMessages)return()=>{};const d=c.subscribeNewMessages(a,t,n,u=>{u.forEach(m=>{r(m)})});return i({unsubscribe:d}),d};deleteMessage=async({messageId:t,hardDelete:n,channelId:a})=>{const{userId:r}=O.getState();if(!r)return;const{removeMessage:o,getChannelState:i,setMessages:l}=this.getChannelStateControl(a),c=i().messages;await Yn(()=>o(t),async()=>{await fe().notes.deleteMessage(r,t,{hardDelete:n}),console.log("Message deleted successfully:",{messageId:t,channelId:a,hardDelete:n})},()=>{l(c),console.error("Failed to delete message, rolling back:",{messageId:t,channelId:a})})};sendMessage=async t=>{const{userId:n}=O.getState();if(!n)return;const{addMessage:a,fixFakeMessage:r}=this.getChannelStateControl(t.channelId),o={...t,id:It(),timestamp:new Date,isNew:!0};a(o);const i=await fe().notes.createMessage(n,t);r(o.id,i)};updateMessage=async({messageId:t,channelId:n,updates:a,userId:r})=>{const{getChannelState:o,setMessages:i}=this.getChannelStateControl(n),{messages:l}=o(),c=l.find(u=>u.id===t);if(!c)throw new Error("Message not found");if(c.sender!=="user")throw new Error("You can only edit user messages, not AI messages");const d={...c,...a};await Yn(()=>i(l.map(u=>u.id===t?d:u)),async()=>{await fe().notes.updateMessage(r,t,a),console.log("Message updated successfully:",{messageId:t,channelId:n,updates:a})},()=>{i(l.map(u=>u.id===t?c:u)),console.error("Failed to update message, rolling back:",{messageId:t,channelId:n})})};moveMessage=async({messageId:t,fromChannelId:n,toChannelId:a})=>{if(n===a)return;const{userId:r}=O.getState();if(!r)throw new Error("User not authenticated");const o=this.getChannelStateControl(n),i=this.getChannelStateControl(a),l=o.getChannelState(),c=i.getChannelState(),d=l?.messages??[],u=c?.messages??[],m=d.find(f=>f.id===t);if(!m)throw new Error("Message not found in source channel");const p={...m,channelId:a};await Yn(()=>{if(o.setMessages(d.filter(f=>f.id!==t)),c?.messages){const f=[...u.filter(g=>g.id!==t),p].sort((g,x)=>x.timestamp.getTime()-g.timestamp.getTime());i.setMessages(f)}},async()=>{await O.getState().moveMessage(t,n,a)},()=>{o.setMessages(d),c?.messages&&i.setMessages(u)})}}const V=new Hh;window.channelMessageService=V;const Ge=s=>async(...t)=>{const{userId:n}=O.getState();n&&await s(n,...t)},Oe=async(s,t)=>{try{return await s()}catch(n){console.error(`Error in ${t}:`,n)}},O=Ee()((s,t)=>({channels:[],channelsLoading:!0,userId:null,unsubscribeChannels:null,isListenerEnabled:!0,messagesByChannel:{},setChannelsLoading:n=>{s({channelsLoading:n})},addChannel:Ge(async(n,a)=>{const r={...a,emoji:a.emoji&&a.emoji.trim()?a.emoji:ma()},o=await Oe(()=>fe().notes.createChannel(n,r),"createChannel");if(typeof o=="string"&&o)try{W.getState().setCurrentChannel(o);const i={id:o,name:r.name,description:r.description,emoji:r.emoji,createdAt:new Date,updatedAt:new Date,messageCount:0,lastMessageTime:new Date,backgroundColor:void 0,backgroundImage:void 0},{channels:l}=O.getState();l.some(d=>d.id===o)||O.setState({channels:[i,...l]})}catch(i){console.warn("[addChannel] Failed to set current channel after creation",i)}}),updateChannel:Ge(async(n,a,r)=>{const{channels:o}=t(),i=o.map(l=>l.id===a?{...l,...r}:l);s({channels:i}),await Oe(()=>fe().notes.updateChannel(n,a,r),"updateChannel")}),deleteChannel:Ge(async(n,a)=>{await Oe(()=>fe().notes.deleteChannel(n,a),"deleteChannel");const{channels:r,messagesByChannel:o}=t(),i=r.filter(d=>d.id!==a);s({channels:i});const{[a]:l,...c}=o;s({messagesByChannel:c}),console.log("ðŸ”” [deleteChannel] æˆåŠŸåˆ é™¤ channel å¹¶æ›´æ–°æœ¬åœ°çŠ¶æ€",{channelId:a,remainingChannelsCount:Object.keys(c).length,removedChannelMessageCount:l?.messages?.length||0})}),addMessage:Ge(async(n,a)=>{await Oe(()=>fe().notes.createMessage(n,a),"createMessage")}),deleteMessage:Ge(async(n,a,r=!1)=>{await Oe(()=>fe().notes.deleteMessage(n,a,{hardDelete:r}),r?"deleteMessage":"softDeleteMessage");const{messagesByChannel:o}=t();console.log("ðŸ”” [deleteMessage] å¼€å§‹æŸ¥æ‰¾æ¶ˆæ¯",{messageId:a,messagesByChannel:o});for(const[i,l]of Object.entries(o))if(l.messages.some(d=>d.id===a)){console.log("ðŸ”” [deleteMessage] æ‰¾åˆ°æ¶ˆæ¯ï¼Œå‡†å¤‡åˆ é™¤",{channelId:i,messageId:a}),t().removeChannelMessage(i,a);break}}),updateMessage:Ge(async(n,a,r)=>{await Oe(()=>fe().notes.updateMessage(n,a,r),"updateMessage")}),moveMessage:Ge(async(n,a,r,o)=>{try{await fe().notes.moveMessage(n,a,r,o)}catch(i){throw console.error("Failed to move message:",{messageId:a,fromChannelId:r,toChannelId:o,error:i}),i}s(i=>{const l=i.messagesByChannel[r],c=i.messagesByChannel[o];if(!l)return i;const d=l.messages.find(p=>p.id===a);if(!d)return i;const u={...l,messages:l.messages.filter(p=>p.id!==a)};let m={...i.messagesByChannel,[r]:u};if(c){const p={...d,channelId:o},f=[...c.messages.filter(g=>g.id!==a),p].sort((g,x)=>x.timestamp.getTime()-g.timestamp.getTime());m={...m,[o]:{...c,messages:f}}}return{messagesByChannel:m}})}),addThreadMessage:Ge(async(n,a,r)=>{await Oe(()=>fe().notes.createMessage(n,{...r,parentId:a,threadId:a}),"createThreadMessage")}),restoreMessage:Ge(async(n,a)=>{await Oe(()=>fe().notes.restoreMessage(n,a),"restoreMessage")}),permanentDeleteMessage:Ge(async(n,a)=>{await Oe(()=>fe().notes.deleteMessage(n,a,{hardDelete:!0}),"permanentDeleteMessage")}),setChannelMessages:(n,a)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[n]:{...r.messagesByChannel[n],messages:a,loading:!1}}}))},addChannelMessage:(n,a)=>{s(r=>{const o=r.messagesByChannel[n];return o?o.messages.some(l=>l.id===a.id)?(console.log("ðŸ”” [addChannelMessage] æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ",{messageId:a.id,channelId:n}),r):(console.log("ðŸ”” [addChannelMessage] æ·»åŠ æ–°æ¶ˆæ¯",{messageId:a.id,channelId:n}),{messagesByChannel:{...r.messagesByChannel,[n]:{...o,messages:[...o.messages,a]}}}):r})},setChannelLoading:(n,a)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[n]:{...r.messagesByChannel[n],loading:a}}}))},setChannelHasMore:(n,a)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[n]:{...r.messagesByChannel[n],hasMore:a}}}))},setChannelLastVisible:(n,a)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[n]:{...r.messagesByChannel[n],lastVisible:a}}}))},clearChannelMessages:n=>{s(a=>{const{[n]:r,...o}=a.messagesByChannel;return{messagesByChannel:o}})},removeChannelMessage:(n,a)=>{s(r=>{const o=r.messagesByChannel[n];if(!o)return r;const i=o.messages.filter(l=>l.id!==a);return console.log("ðŸ”” [removeChannelMessage]",{channelId:n,messageId:a,beforeCount:o.messages.length,afterCount:i.length}),{messagesByChannel:{...r.messagesByChannel,[n]:{...o,messages:i}}}})},initFirebaseListeners:async n=>{const{userId:a,unsubscribeChannels:r}=t();if(r&&a===n)return;t().cleanupListeners(),s({userId:n,channelsLoading:!0});const o=fe().notes;if(!o.subscribeChannels)throw new Error("Current storage backend does not support realtime channel subscriptions");const i=o.subscribeChannels(n,l=>{const{isListenerEnabled:c}=t();c&&(s({channels:l,channelsLoading:!1}),t().validateAndCleanupCurrentChannel(l))});s({unsubscribeChannels:i})},initGuestWorkspace:async()=>{const n=Dh();await t().initFirebaseListeners(n)},cleanupListeners:()=>{const{unsubscribeChannels:n}=t();n&&n(),s({unsubscribeChannels:null,channels:[],channelsLoading:!0,userId:null,messagesByChannel:{}})},fetchInitialData:async n=>{s({channelsLoading:!0}),await Oe(async()=>{const a=await fe().notes.listChannels(n);s({channels:a,channelsLoading:!1}),t().validateAndCleanupCurrentChannel(a)},"fetchChannels")},validateAndCleanupCurrentChannel:n=>{const a=W.getState().currentChannelId;if(!a)return;n.some(o=>o.id===a)||(W.getState().setCurrentChannel(null),V.getChannelStateControl(a).clearChannel(),t().clearChannelMessages(a))},publishSpace:async(n,a="read-only")=>{const{userId:r}=t();if(!r)return"";const o=await Oe(()=>fe().notes.publishSpace(r,n,a),"publishSpace");if(o){const{channels:i}=t(),l=i.map(c=>c.id===n?{...c,shareToken:o,shareMode:a}:c);s({channels:l})}return o||""},unpublishSpace:Ge(async(n,a)=>{await Oe(()=>fe().notes.unpublishSpace(n,a),"unpublishSpace");const{channels:r}=t(),o=r.map(i=>i.id===a?{...i,shareToken:void 0,shareMode:void 0}:i);s({channels:o})}),updatePublishMode:Ge(async(n,a,r)=>{await Oe(()=>fe().notes.updateChannel(n,a,{shareMode:r}),"updatePublishMode");const{channels:o}=t(),i=o.map(l=>l.id===a?{...l,shareMode:r}:l);s({channels:i})})}));var G=(s=>(s.IDLE="idle",s.AUTHENTICATING="authenticating",s.VERIFYING_EMAIL="verifying-email",s.INITIALIZING_DATA="initializing-data",s.COMPLETE="complete",s.ERROR="error",s))(G||{}),Ce=(s=>(s.CONNECTING_GOOGLE="Connecting to Google...",s.VERIFYING_CREDENTIALS="Verifying credentials...",s.CHECKING_EMAIL_VERIFICATION="Checking email verification...",s.SETTING_UP_WORKSPACE="Setting up your workspace...",s.WELCOME_BACK="Welcome back!",s.SIGN_IN_FAILED="Sign-in failed. Please try again.",s.CHECK_CREDENTIALS="Sign-in failed. Please check your credentials.",s.CREATING_ACCOUNT="Creating your account...",s.SENDING_VERIFICATION="Sending verification email...",s.ACCOUNT_CREATED="Account created successfully!",s))(Ce||{}),ke=(s=>(s[s.START=0]="START",s[s.AUTHENTICATING=25]="AUTHENTICATING",s[s.VERIFYING_EMAIL=50]="VERIFYING_EMAIL",s[s.INITIALIZING_DATA=75]="INITIALIZING_DATA",s[s.COMPLETE=100]="COMPLETE",s))(ke||{});let js=!1,bt=!1,es=!1;const xe={signInWithGoogle:async()=>{if(console.log("[firebaseAuthService] signInWithGoogle"),!J.supportGoogleAuth())throw new Error("Google authentication is not supported in this region");const s=new Sd;try{bt=!0;const t=await J.getAuth();return(await Md(t,s)).user}catch(t){return console.error("Google Sign-In Error:",t),null}},sendSignUpLink:async(s,t,n)=>{try{js=!0;try{const a=await J.getAuth(),r=await Tr(a,s,t);return n&&await Vn(r.user,{displayName:n}),await vs(r.user),await bs(a),{verificationSent:!0}}catch(a){if(a.code==="auth/email-already-in-use")try{const r=await J.getAuth(),o=await Ir(r,s,t);if(o.user.emailVerified)throw new Error("EMAIL_ALREADY_VERIFIED");return n&&await Vn(o.user,{displayName:n}),await vs(o.user),await bs(r),{verificationSent:!0}}catch(r){throw r.code==="auth/wrong-password"||r.code==="auth/invalid-credential"?new Error("ACCOUNT_EXISTS_WRONG_PASSWORD"):r}throw a}}catch(a){throw js=!1,console.error("Send Sign-Up Link Error:",a),a}finally{js=!1}},signUpWithEmail:async(s,t,n)=>{try{const a=await J.getAuth(),r=await Tr(a,s,t);return n&&await Vn(r.user,{displayName:n}),await vs(r.user),await bs(a),{user:r.user,verificationSent:!0}}catch(a){throw console.error("Email Sign-Up Error:",a),a}},sendEmailVerification:async s=>{try{await vs(s)}catch(t){throw console.error("Email Verification Error:",t),t}},signInWithEmail:async(s,t)=>{try{console.log("ðŸ” Starting email sign-in process..."),bt=!0,console.log("ðŸ” isSigningIn set to true"),$e.getState().setAuthStep(G.AUTHENTICATING,Ce.VERIFYING_CREDENTIALS,ke.AUTHENTICATING);const n=await J.getAuth(),a=await Ir(n,s,t);if(console.log("âœ… Firebase authentication successful"),console.log("ðŸ“§ Email verified:",a.user.emailVerified),$e.getState().setAuthStep(G.VERIFYING_EMAIL,Ce.CHECKING_EMAIL_VERIFICATION,ke.VERIFYING_EMAIL),!a.user.emailVerified)throw console.log("ðŸ“§ Email not verified, sending verification email..."),await vs(a.user),console.log("ðŸ“§ Verification email sent"),await bs(n),console.log("ðŸšª User signed out due to unverified email"),bt=!1,console.log("ðŸ” isSigningIn reset to false due to unverified email"),new Error("EMAIL_NOT_VERIFIED_RESENT");return console.log("âœ… Email is verified, proceeding with login"),$e.getState().setAuthStep(G.INITIALIZING_DATA,Ce.SETTING_UP_WORKSPACE,ke.INITIALIZING_DATA),J.setUserIdForAnalytics(a.user.uid),console.log("ðŸŽ‰ Login process completed successfully"),a.user}catch(n){throw console.error("âŒ Email Sign-In Error:",n),bt=!1,console.log("ðŸ” isSigningIn reset to false due to error"),$e.getState().setAuthStep(G.ERROR,Ce.SIGN_IN_FAILED,ke.START),n}},sendPasswordReset:async s=>{try{const t=await J.getAuth();await kd(t,s)}catch(t){throw console.error("Password Reset Error:",t),t}},signOut:async()=>{const s=await J.getAuth();await bs(s),es=!1},onAuthStateChanged:async s=>{const t=await J.getAuth();return Cd(t,async n=>{if(console.log("ðŸ”„ Auth state changed:",n?`User: ${n.email} (verified: ${n.emailVerified})`:"No user"),console.log("ðŸ” isRegistering:",js,"isSigningIn:",bt),js){console.log("â¸ï¸ Skipping auth state change due to ongoing registration");return}if(bt&&n&&n.emailVerified){console.log("âœ… Processing login state change - user is verified (init once)"),J.setUserIdForAnalytics(n.uid),es||(es=!0,$e.getState().setAuthStep(G.INITIALIZING_DATA,Ce.SETTING_UP_WORKSPACE,ke.INITIALIZING_DATA),await O.getState().initFirebaseListeners(n.uid)),$e.getState().setAuthStep(G.COMPLETE,Ce.WELCOME_BACK,ke.COMPLETE),bt=!1,s(n);return}else if(bt){console.log("â¸ï¸ Skipping auth state change due to ongoing sign-in (unverified user)");return}n?(J.setUserIdForAnalytics(n.uid),n.emailVerified?(console.log("âœ… User email verified, initializing listeners"),es?console.log("â„¹ï¸ Listeners already initialized, skipping duplicate init"):(es=!0,await O.getState().initFirebaseListeners(n.uid))):(console.log("âŒ User email not verified, cleaning up listeners"),O.getState().cleanupListeners(),pa()&&await O.getState().initGuestWorkspace())):(console.log("ðŸšª No user, cleaning up listeners"),es=!1,pa()?await O.getState().initGuestWorkspace():O.getState().cleanupListeners()),console.log("ðŸ“ž Calling auth state callback"),s(n)})},getCurrentUser:async()=>(await J.getAuth()).currentUser,checkEmailVerification:async()=>{const t=(await J.getAuth()).currentUser;return t?(await t.reload(),t.emailVerified):!1}},$e=Ee()(At((s,t)=>({currentUser:null,authIsReady:!1,isInitializing:!1,isRefreshing:!1,isAuthenticating:!1,authStep:G.IDLE,authMessage:"",authProgress:0,signInWithGoogle:async()=>{if(!J.supportGoogleAuth())throw new Error("Google authentication is not supported in this region");s({isAuthenticating:!0,authStep:G.AUTHENTICATING,authMessage:Ce.CONNECTING_GOOGLE,authProgress:ke.AUTHENTICATING});try{await xe.signInWithGoogle(),s({authStep:G.INITIALIZING_DATA,authMessage:Ce.SETTING_UP_WORKSPACE,authProgress:ke.INITIALIZING_DATA})}catch(n){throw s({authStep:G.ERROR,authMessage:Ce.SIGN_IN_FAILED,authProgress:ke.START}),n}finally{s({isAuthenticating:!1})}},signInWithEmail:async(n,a)=>{s({isAuthenticating:!0,authStep:G.AUTHENTICATING,authMessage:Ce.VERIFYING_CREDENTIALS,authProgress:ke.AUTHENTICATING});try{await xe.signInWithEmail(n,a),s({authStep:G.VERIFYING_EMAIL,authMessage:Ce.CHECKING_EMAIL_VERIFICATION,authProgress:ke.VERIFYING_EMAIL})}catch(r){throw s({authStep:G.ERROR,authMessage:Ce.CHECK_CREDENTIALS,authProgress:ke.START}),r}finally{s({isAuthenticating:!1})}},signUpWithEmail:async(n,a,r)=>{s({isAuthenticating:!0});try{return await xe.signUpWithEmail(n,a,r)}finally{s({isAuthenticating:!1})}},sendSignUpLink:async(n,a,r)=>{s({isAuthenticating:!0});try{return await xe.sendSignUpLink(n,a,r)}finally{s({isAuthenticating:!1})}},sendPasswordReset:async n=>{s({isAuthenticating:!0});try{await xe.sendPasswordReset(n)}finally{s({isAuthenticating:!1})}},sendEmailVerification:async()=>{s({isAuthenticating:!0});try{const n=t().currentUser;if(!n)throw new Error("No user logged in");await xe.sendEmailVerification(n)}finally{s({isAuthenticating:!1})}},signOut:async()=>{s({isAuthenticating:!0});try{await xe.signOut()}finally{s({isAuthenticating:!1})}},setAuth:n=>{s({currentUser:n})},setAuthReady:n=>{s({authIsReady:n})},setInitializing:n=>{s({isInitializing:n})},setRefreshing:n=>{s({isRefreshing:n})},setAuthenticating:n=>{s({isAuthenticating:n})},setAuthStep:(n,a,r)=>{s({authStep:n,authMessage:a,authProgress:r})},initAuthListener:async()=>{const n=t().currentUser!==null;return s(n?{isRefreshing:!0,authIsReady:!1}:{isInitializing:!0,authIsReady:!1}),await xe.onAuthStateChanged(r=>{t().setAuth(r),s(n?{isRefreshing:!1,authIsReady:!0}:{isInitializing:!1,authIsReady:!0})})}}),{name:"echonote-auth-storage",partialize:s=>({currentUser:s.currentUser,authIsReady:s.authIsReady})})),vi=()=>{const{currentUser:s,isInitializing:t,isRefreshing:n,initAuthListener:a}=$e();return h.useEffect(()=>{let r;return(async()=>{r=await a()})(),()=>{r&&r()}},[a]),{user:s,isInitializing:t,isRefreshing:n}},za=h.createContext(null),he=()=>{const s=h.useContext(za);if(!s)throw new Error("useCommonPresenter must be used within a CommonPresenterProvider");return s};class Gh{instances$=new dt([]);baseZIndex=1e3;nextId=0;get instances(){return this.instances$.value}get instancesObservable(){return this.instances$}show(t){const n=`modal-${++this.nextId}`,a=this.baseZIndex+this.instances.length,r={id:n,options:t,zIndex:a},o=[...this.instances,r];return this.instances$.next(o),{id:n,close:i=>this.hide(n,i)}}hide(t,n){const a=this.instances.find(o=>o.id===t);if(!a)return;const r=this.instances.filter(o=>o.id!==t);this.instances$.next(r),a.options.onClose?.(n)}hideAll(){this.instances.forEach(t=>{t.options.onClose?.()}),this.instances$.next([])}}const Rs=new Gh;function yi(s,t){const[n,a]=h.useState(t),r=h.useMemo(()=>typeof s=="function"?s():s,[s]);return h.useEffect(()=>{const o=r.subscribe(a);return()=>o.unsubscribe()},[r]),n}function Vh(){const s=h.useRef(null),t=h.useRef(null);return h.useEffect(()=>{const n=s.current;if(!n)return;t.current=document.activeElement;const a=n.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),r=a[0],o=a[a.length-1];r&&r.focus();const i=l=>{l.key==="Tab"&&(l.shiftKey?document.activeElement===r&&(l.preventDefault(),o?.focus()):document.activeElement===o&&(l.preventDefault(),r?.focus()))};return document.addEventListener("keydown",i),()=>{document.removeEventListener("keydown",i),t.current?.focus()}},[]),s}function qh(s=!0){h.useEffect(()=>{if(!s)return;const t=window.getComputedStyle(document.body).overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=t}},[s])}function Wh({onClose:s,threshold:t=100}){const n=h.useRef(0),a=h.useRef(0),r=h.useRef(!1),o=h.useCallback(c=>{n.current=c.touches[0].clientY,a.current=c.touches[0].clientX,r.current=!1},[]),i=h.useCallback(c=>{if(!r.current){const d=Math.abs(c.touches[0].clientY-n.current),u=Math.abs(c.touches[0].clientX-a.current);r.current=d>u&&d>10}},[]),l=h.useCallback(c=>{r.current&&c.changedTouches[0].clientY-n.current>t&&(c.preventDefault(),s())},[s,t]);return{onTouchStart:o,onTouchMove:i,onTouchEnd:l}}function Kh({instance:s,onClose:t}){const n=Vh();qh(!0);const a=Wh({onClose:()=>t()});h.useEffect(()=>{const m=p=>{p.key==="Escape"&&(p.preventDefault(),t())};return document.addEventListener("keydown",m),()=>document.removeEventListener("keydown",m)},[t]);const r=s.options.position||"center",o=r==="top",i=s.options.topOffset??12,l=()=>{switch(r){case"top":return"fixed inset-x-0 top-0 pointer-events-none flex justify-center items-start";case"center":default:return"fixed inset-0 flex items-center justify-center pointer-events-none"}},d=(()=>{switch(r){case"top":return{initial:{opacity:0,scale:.95,y:-20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:-20}};case"center":default:return{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20}}}})(),u=o?"relative bg-background shadow-lg overflow-hidden pointer-events-auto w-full":"relative bg-background rounded-lg shadow-lg max-w-[90vw] max-h-[90vh] overflow-hidden pointer-events-auto";return e.jsx(Ho,{children:e.jsxs("div",{className:"fixed inset-0 z-50",style:{zIndex:s.zIndex},children:[e.jsx(We.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15},className:"absolute inset-0 bg-black/50",onClick:()=>t()}),e.jsx(We.div,{ref:n,initial:d.initial,animate:d.animate,exit:d.exit,transition:{duration:.15,ease:"easeOut"},className:`${l()}`,...a,children:e.jsx("div",{className:`${u} ${s.options.className||""}`,style:o?{marginTop:`${i}px`}:void 0,children:s.options.content})})]})})}function wi(){const s=yi(Rs.instancesObservable,[]);return e.jsx(e.Fragment,{children:s.map(t=>e.jsx(Kh,{instance:t,onClose:n=>Rs.hide(t.id,n)},t.id))})}const ji={show:s=>Rs.show(s),hide:(s,t)=>Rs.hide(s,t),hideAll:()=>Rs.hideAll()},Nt=Ee(s=>({targetPath:null,currentPath:"/",navigate:t=>s({targetPath:t}),setCurrentPath:t=>s({currentPath:t})})),Yh=()=>{const s=Gd(),t=Go(),n=Nt(r=>r.targetPath),a=Nt(r=>r.currentPath);h.useEffect(()=>{n&&(s(n),Nt.getState().navigate(null))},[n,s]),h.useEffect(()=>{t.pathname!==a&&Nt.getState().setCurrentPath(t.pathname)},[t.pathname,a])},Ns=new Wd,Xh=s=>{const[t,n]=h.useState(!1),a=h.useRef(new Set);return h.useEffect(()=>{s.forEach(r=>{const o=r.manifest.id;Ns.getExtension(o)||Ns.registerExtension(r)})},[s]),h.useEffect(()=>{const r=new Set(s.map(l=>l.manifest.id)),o=a.current;s.forEach(l=>{const c=l.manifest.id;o.has(c)||(Ns.activateExtension(c),o.add(c))}),Array.from(o).filter(l=>!r.has(l)).forEach(l=>{Ns.deactivateExtension(l),o.delete(l)}),n(!0)},[s]),h.useEffect(()=>()=>{const r=a.current;Array.from(r).forEach(i=>{Ns.deactivateExtension(i)}),r.clear()},[]),{initialized:t}},Ni=s=>{Yh();const{initialized:t}=Xh(s.extensions);return{initialized:t}};function Ci({className:s}){const{isDarkMode:t,toggleDarkMode:n}=ih();return e.jsx(k,{variant:"ghost",size:"icon",onClick:n,className:M("hover:bg-muted/80",s),title:t?"Switch to light mode":"Switch to dark mode",children:t?e.jsx(jo,{className:"h-[1.2rem] w-[1.2rem]"}):e.jsx(No,{className:"h-[1.2rem] w-[1.2rem]"})})}const $r={message:ds,users:Ra,settings:La,github:Rc,home:Lc,search:Fe,file:Xe,folder:Ac,calendar:Tc,star:Ic,heart:To,bookmark:Io,bot:Et,download:Kt,upload:Ec,share:Mc,edit:Aa,trash:Sc,plus:Me,minus:ea,check:Ye,x:le,"chevron-left":Eo,"chevron-right":Ta,"chevron-up":Wt,"chevron-down":ze,menu:Mo,"more-horizontal":In,"more-vertical":Vs,sun:jo,moon:No,monitor:kc,bell:Cc,user:Zn,"log-out":So,cog:Nc,"help-circle":jc,info:ko,"alert-circle":En,"alert-triangle":Co,"check-circle":ht,"x-circle":Ss},Fa=Ee()((s,t)=>({icons:$r,addIcon:(n,a)=>(s(r=>({icons:{...r.icons,[n]:a}})),()=>{t().removeIcon(n)}),addIcons:n=>(s(a=>({icons:{...a.icons,...n}})),()=>{Object.keys(n).forEach(a=>{t().removeIcon(a)})}),removeIcon:n=>{s(a=>{const r={...a.icons};return delete r[n],{icons:r}})},getIcon:n=>t().icons[n],reset:()=>{s({icons:$r})}})),Jh=s=>Fa(t=>t.icons[s]);function Ur({id:s,className:t,fallbackIcon:n}){const a=Jh(s||"");if(a){const r=a;return e.jsx(r,{className:M("w-4 h-4",t)})}if(n){const r=n;return e.jsx(r,{className:M("w-4 h-4",t)})}return null}const zr="chat";var ls=(s=>(s.MAIN="main",s.FOOTER="footer",s))(ls||{});const Vt=Ee()(At(s=>({items:[],activeId:void 0,expanded:!1,addItem:t=>(s(n=>({items:[...n.items,t]})),()=>{s(n=>({items:n.items.filter(a=>a.id!==t.id)}))}),removeItem:t=>{s(n=>({items:n.items.filter(a=>a.id!==t),activeId:n.activeId===t?n.items.find(a=>a.id!==t)?.id||zr:n.activeId}))},updateItem:(t,n)=>{s(a=>({items:a.items.map(r=>r.id===t?{...r,...n}:r)}))},setActiveId:t=>{s(n=>{const a=n.items.map(r=>({...r,isActive:r.id===t}));return{activeId:t,items:a}})},toggleExpanded:()=>{s(t=>({expanded:!t.expanded}))},setExpanded:t=>{s({expanded:t})},reset:()=>{s({items:[],activeId:zr,expanded:!1})}}),{name:"activity-bar-store",partialize:s=>({expanded:s.expanded})})),ki=()=>({isGoogleAuthSupported:J.supportGoogleAuth(),isInCNRegion:J.isInCNRegion()});function _e({className:s,type:t,...n}){return e.jsx("input",{type:t,"data-slot":"input",className:M("file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm","aria-invalid:border-destructive",s),...n})}const Qh=({email:s,password:t,confirmPassword:n,isSignUp:a,isAuthenticating:r,error:o,statusMessage:i,onEmailChange:l,onPasswordChange:c,onConfirmPasswordChange:d,onToggleSignUp:u,onPasswordReset:m,onSubmit:p})=>{const[f,g]=h.useState(!1),[x,y]=h.useState(!1);return e.jsxs("form",{onSubmit:v=>{v.preventDefault(),p()},className:"space-y-4",children:[e.jsx(_e,{type:"email",name:"email",placeholder:"Enter your email",value:s,onChange:v=>l(v.target.value),className:"w-full h-12 text-sm rounded-xl border-slate-200 dark:border-slate-600 focus:border-slate-400 dark:focus:border-slate-500 dark:bg-slate-700 dark:text-white dark:placeholder-slate-400",disabled:r,autoComplete:"email"}),e.jsxs("div",{className:"relative",children:[e.jsx(_e,{type:f?"text":"password",name:"password",placeholder:"Enter your password",value:t,onChange:v=>c(v.target.value),className:"w-full h-12 text-sm rounded-xl border-slate-200 dark:border-slate-600 focus:border-slate-400 dark:focus:border-slate-500  dark:bg-slate-700 dark:text-white dark:placeholder-slate-400 pr-10",disabled:r,autoComplete:a?"new-password":"current-password"}),e.jsx("button",{type:"button",onClick:()=>g(!f),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors",disabled:r,children:f?e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"})}):e.jsxs("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})})]}),a&&e.jsxs("div",{className:"relative",children:[e.jsx(_e,{type:x?"text":"password",name:"confirmPassword",placeholder:"Confirm your password",value:n,onChange:v=>d(v.target.value),className:"w-full h-12 text-sm rounded-xl border-slate-200 dark:border-slate-600 focus:border-slate-400 dark:focus:border-slate-500  dark:bg-slate-700 dark:text-white dark:placeholder-slate-400 pr-10",disabled:r,autoComplete:"new-password"}),e.jsx("button",{type:"button",onClick:()=>y(!x),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors",disabled:r,children:x?e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"})}):e.jsxs("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})})]}),o&&e.jsx("div",{className:"text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/30 rounded-lg p-3",children:o}),i&&e.jsx("div",{className:"text-sm text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800/30 rounded-lg p-3",children:i}),e.jsx(k,{type:"submit",disabled:r||!s||!t||a&&(!n||t!==n||t.length<6),className:"w-full h-12 text-sm font-medium rounded-xl bg-slate-600 hover:bg-slate-700 dark:bg-slate-700 dark:hover:bg-slate-600 text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",size:"lg",children:r?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:a?"Creating account...":"Signing in..."})]}):a?"Create Account":"Sign In"}),e.jsx("div",{className:"text-center",children:e.jsx("button",{type:"button",onClick:u,className:"text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors underline underline-offset-2",disabled:r,children:a?"Already have an account? Sign in":"Don't have an account? Sign up"})}),!a&&e.jsx("div",{className:"text-center",children:e.jsx("button",{type:"button",onClick:m,className:"text-sm text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 transition-colors underline underline-offset-2",disabled:r||!s,children:"Forgot your password?"})})]})},Zh=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("p",{className:"text-xs text-slate-500 dark:text-slate-400 leading-relaxed",children:["By continuing, you agree to the"," ",e.jsx("button",{className:"underline underline-offset-2 hover:text-slate-700 dark:hover:text-slate-300 transition-colors font-medium",children:"Terms"}),","," ",e.jsx("button",{className:"underline underline-offset-2 hover:text-slate-700 dark:hover:text-slate-300 transition-colors font-medium",children:"Privacy"}),"."]})}),e.jsxs("div",{className:"flex justify-center gap-4 mt-6",children:[e.jsx("button",{className:"w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center transition-colors",children:e.jsx("svg",{className:"w-4 h-4 text-slate-600 dark:text-slate-400",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"})})}),e.jsx("button",{className:"w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center transition-colors",children:e.jsx("svg",{className:"w-4 h-4 text-slate-600 dark:text-slate-400",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"})})})]})]}),em=({onGoogleLogin:s,isAuthenticating:t})=>{const{isGoogleAuthSupported:n}=ki();return n?e.jsx("div",{className:"mb-6",children:e.jsx(k,{onClick:s,disabled:t,className:"w-full h-12 text-sm font-medium rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 text-slate-900 dark:text-white transition-colors shadow-sm hover:shadow-md",size:"lg",children:t?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-slate-300 dark:border-slate-500 border-t-slate-600 dark:border-t-slate-300 rounded-full animate-spin"}),e.jsx("span",{children:"Signing in..."})]}):e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("svg",{className:"w-5 h-5",viewBox:"0 0 24 24",children:[e.jsx("path",{fill:"currentColor",d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),e.jsx("path",{fill:"currentColor",d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),e.jsx("path",{fill:"currentColor",d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),e.jsx("path",{fill:"currentColor",d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),e.jsx("span",{children:"Continue with Google"})]})})}):null},Si=({size:s="md",variant:t="default",text:n,className:a})=>{const r={sm:"w-4 h-4",md:"w-8 h-8",lg:"w-12 h-12",xl:"w-16 h-16"},o={sm:"text-xs",md:"text-sm",lg:"text-base",xl:"text-lg"},i=()=>e.jsx("div",{className:M("animate-spin rounded-full border-2 border-slate-200 dark:border-slate-700","border-t-blue-600 dark:border-t-blue-400",r[s])}),l=()=>e.jsx("div",{className:M("animate-pulse rounded-full bg-gradient-to-r from-blue-400 to-purple-500",r[s])}),c=()=>e.jsx("div",{className:"flex space-x-1",children:[0,1,2].map(p=>e.jsx("div",{className:M("animate-bounce rounded-full bg-blue-600 dark:bg-blue-400",s==="sm"?"w-1.5 h-1.5":s==="md"?"w-2 h-2":s==="lg"?"w-2.5 h-2.5":"w-3 h-3"),style:{animationDelay:`${p*.1}s`,animationDuration:"1s"}},p))}),d=()=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:M("absolute inset-0 rounded-full bg-blue-600 dark:bg-blue-400 opacity-75",r[s])}),e.jsx("div",{className:M("absolute inset-0 rounded-full bg-blue-600 dark:bg-blue-400 opacity-75",r[s],"animate-ping")}),e.jsx("div",{className:M("relative rounded-full bg-blue-600 dark:bg-blue-400",r[s])})]}),u=()=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:M("animate-spin rounded-full border-2 border-slate-200 dark:border-slate-700","border-t-blue-600 dark:border-t-blue-400",r[s])}),n&&e.jsx("span",{className:M("text-slate-600 dark:text-slate-400 font-medium",o[s]),children:n})]}),m=()=>{switch(t){case"spinner":return i();case"pulse":return l();case"dots":return c();case"ripple":return d();default:return u()}};return e.jsx("div",{className:M("flex items-center justify-center",a),children:m()})};function yn({className:s,value:t,...n}){return e.jsx(Fl,{"data-slot":"progress",className:M("bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",s),...n,children:e.jsx(Bl,{"data-slot":"progress-indicator",className:"bg-primary h-full w-full flex-1 transition-all",style:{transform:`translateX(-${100-(t||0)}%)`}})})}const tm=({authStep:s,authMessage:t,authProgress:n})=>{const a=()=>{switch(s){case G.COMPLETE:return e.jsx(ht,{className:"w-6 h-6 text-green-500"});case G.ERROR:return e.jsx(En,{className:"w-6 h-6 text-red-500"});default:return e.jsx(Si,{variant:"spinner",size:"lg"})}},r=()=>{switch(s){case G.COMPLETE:return"text-green-600 dark:text-green-400";case G.ERROR:return"text-red-600 dark:text-red-400";default:return"text-blue-600 dark:text-blue-400"}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-center",children:a()}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-slate-100",children:s===G.COMPLETE?"Welcome!":"Please wait..."}),e.jsx("p",{className:`text-sm font-medium ${r()}`,children:t}),s!==G.COMPLETE&&s!==G.ERROR&&e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:"This may take a few moments"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(yn,{value:n,className:`${s===G.ERROR?"bg-red-100 dark:bg-red-900/20":s===G.COMPLETE?"bg-green-100 dark:bg-green-900/20":"bg-blue-100 dark:bg-blue-900/20"}`}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500 dark:text-slate-400",children:[e.jsxs("div",{className:`flex items-center gap-2 ${s===G.AUTHENTICATING?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===G.AUTHENTICATING?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:"Authenticating"})]}),e.jsxs("div",{className:`flex items-center gap-2 ${s===G.VERIFYING_EMAIL?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===G.VERIFYING_EMAIL?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:"Verifying"})]}),e.jsxs("div",{className:`flex items-center gap-2 ${s===G.INITIALIZING_DATA?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===G.INITIALIZING_DATA?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:"Setting up"})]})]})]})]})},sm=({authStep:s,authMessage:t,authProgress:n})=>{const a=()=>{switch(s){case G.COMPLETE:return e.jsx(ht,{className:"w-6 h-6 text-green-500"});case G.ERROR:return e.jsx(En,{className:"w-6 h-6 text-red-500"});default:return e.jsx(Si,{variant:"spinner",size:"lg"})}},r=()=>{switch(s){case G.COMPLETE:return"text-green-600 dark:text-green-400";case G.ERROR:return"text-red-600 dark:text-red-400";default:return"text-blue-600 dark:text-blue-400"}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-center",children:a()}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-slate-100",children:s===G.COMPLETE?"Welcome!":"Please wait..."}),e.jsx("p",{className:`text-sm font-medium ${r()}`,children:t}),s!==G.COMPLETE&&s!==G.ERROR&&e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:"This may take a few moments"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(yn,{value:n,className:`${s===G.ERROR?"bg-red-100 dark:bg-red-900/20":s===G.COMPLETE?"bg-green-100 dark:bg-green-900/20":"bg-blue-100 dark:bg-blue-900/20"}`}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500 dark:text-slate-400",children:[e.jsxs("div",{className:`flex items-center gap-2 ${s===G.AUTHENTICATING?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===G.AUTHENTICATING?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:"Creating"})]}),e.jsxs("div",{className:`flex items-center gap-2 ${s===G.VERIFYING_EMAIL?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===G.VERIFYING_EMAIL?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:"Sending link"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-slate-300 dark:bg-slate-600"}),e.jsx("span",{children:"Check inbox"})]})]})]})]})},nm=({email:s,onResendVerification:t,onBackToSignIn:n,resendCooldown:a=0,isResending:r=!1})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(ht,{className:"w-8 h-8 text-green-500"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-xl font-semibold text-slate-900 dark:text-slate-100",children:"Check your email"}),e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/30 rounded-lg p-4",children:[e.jsxs("p",{className:"text-sm text-green-700 dark:text-green-400",children:["We've sent a verification link",s?" to ":"",s&&e.jsx("strong",{className:"font-semibold",children:s}),"."]}),e.jsx("p",{className:"text-xs text-green-600 dark:text-green-500 mt-1",children:"Click the link to complete registration."})]}),e.jsxs("div",{className:"flex items-center justify-center gap-4 pt-2",children:[e.jsx("button",{onClick:t,disabled:a>0||r,className:"px-4 py-2 text-sm font-medium text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30 border border-green-200 dark:border-green-800/30 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:r?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-green-600 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Sending..."})]}):a>0?`Resend in ${a}s`:"Resend link"}),e.jsx("button",{onClick:n,className:"px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700/50 border border-slate-200 dark:border-slate-700 rounded-lg transition-colors",children:"Back to sign in"})]})]})]}),am=({isEmailVerificationSent:s,email:t,onResendVerification:n,onBackToSignIn:a,isSignUpFlow:r,forceOpen:o,onClose:i,resendCooldown:l=0,isResending:c=!1})=>{const{authStep:d,authMessage:u,authProgress:m,isAuthenticating:p}=$e(),f=!!o||p||!!s;if(!f)return null;const g=()=>{i&&i()},x=()=>s?e.jsx(nm,{email:t,onResendVerification:n,onBackToSignIn:a,resendCooldown:l,isResending:c}):r?e.jsx(sm,{authStep:d,authMessage:u,authProgress:m}):e.jsx(tm,{authStep:d,authMessage:u,authProgress:m});return e.jsx(gt,{open:f,onOpenChange:y=>{y||g()},children:e.jsx(pt,{className:"max-w-md w-full mx-4 p-8",children:e.jsx("div",{className:"text-center space-y-6",children:x()})})})},rm=({className:s})=>{const{signInWithGoogle:t,signInWithEmail:n,sendSignUpLink:a,sendPasswordReset:r,sendEmailVerification:o,isAuthenticating:i,setAuthStep:l}=$e(),{isGoogleAuthSupported:c}=ki(),[d,u]=h.useState(""),[m,p]=h.useState(""),[f,g]=h.useState(""),[x,y]=h.useState(!1),[v,w]=h.useState(""),[b,N]=h.useState(""),[j,C]=h.useState(!1),[E,R]=h.useState(!1),[T,D]=h.useState(null),[L,U]=h.useState(!1),[z,K]=h.useState(0),[de,pe]=h.useState(!1);h.useEffect(()=>{let ye;return z>0&&(ye=setTimeout(()=>{K(z-1)},1e3)),()=>{ye&&clearTimeout(ye)}},[z]);const Le=async()=>{try{w(""),await t()}catch(ye){switch(console.error("Google login failed:",ye),ye.code){case"auth/popup-closed-by-user":w("Sign-in was cancelled. Please try again.");break;case"auth/popup-blocked":w("Popup was blocked. Please allow popups and try again.");break;case"auth/network-request-failed":w("Network error. Please check your connection and try again.");break;case"auth/too-many-requests":w("Too many failed attempts. Please try again later.");break;default:w("Google sign-in failed. Please try again.")}}},Ie=async()=>{if(!d||!m){w("Please fill in all fields");return}if(x){if(!f){w("Please confirm your password");return}if(m!==f){w("Passwords do not match");return}if(m.length<6){w("Password must be at least 6 characters long");return}}try{w(""),N(""),x?(U(!0),l(G.AUTHENTICATING,Ce.CREATING_ACCOUNT,ke.AUTHENTICATING),(await a(d,m)).verificationSent&&(l(G.VERIFYING_EMAIL,Ce.SENDING_VERIFICATION,ke.VERIFYING_EMAIL),D({email:d}),R(!0),K(60))):await n(d,m)}catch(ye){console.error("Email auth failed:",ye),N("");const Be=ye;let je="";switch(Be.code){case"auth/user-not-found":je="No account found with this email address";break;case"auth/wrong-password":je="Incorrect password";break;case"auth/invalid-credential":je="Invalid email or password. Please check your credentials and try again.";break;case"auth/email-already-in-use":je="An account with this email already exists";break;case"auth/weak-password":je="Password should be at least 6 characters";break;case"auth/invalid-email":je="Invalid email address";break;case"auth/user-disabled":je="This account has been disabled. Please contact support.";break;case"auth/too-many-requests":je="Too many failed attempts. Please try again later.";break;case"auth/network-request-failed":je="Network error. Please check your connection and try again.";break;case"auth/operation-not-allowed":je="This sign-in method is not enabled. Please try a different method.";break;default:Be.message==="EMAIL_NOT_VERIFIED"?je="Please verify your email address before signing in. Check your inbox for a verification link.":Be.message==="EMAIL_NOT_VERIFIED_RESENT"?je="Please verify your email address before signing in. We've sent a new verification link to your inbox.":Be.message==="EMAIL_ALREADY_VERIFIED"?je="This email is already verified. Please sign in instead.":Be.message==="ACCOUNT_EXISTS_WRONG_PASSWORD"?je="An account with this email already exists, but the password is incorrect. Please check your password or try signing in.":je="Authentication failed. Please check your credentials and try again."}w(je);try{l(G.ERROR,x?"Sign-up failed. Please try again.":Ce.SIGN_IN_FAILED,ke.START)}catch{}}},$=async()=>{if(!d){w("Please enter your email address first");return}try{w(""),await r(d),C(!0)}catch(ye){switch(console.error("Password reset failed:",ye),ye.code){case"auth/user-not-found":w("No account found with this email address");break;case"auth/invalid-email":w("Invalid email address");break;case"auth/too-many-requests":w("Too many reset attempts. Please try again later.");break;case"auth/network-request-failed":w("Network error. Please check your connection and try again.");break;default:w("Failed to send password reset email. Please try again.")}}},B=async()=>{if(!T){w("No pending user found");return}try{if(z>0){w(`Please wait ${z} seconds before resending`);return}pe(!0),w(""),R(!1),l(G.VERIFYING_EMAIL,Ce.SENDING_VERIFICATION,ke.VERIFYING_EMAIL),await o(),R(!0),K(60)}catch(ye){switch(console.error("Failed to resend verification:",ye),ye.code){case"auth/too-many-requests":w("Too many verification attempts. Please try again later."),K(120);break;case"auth/network-request-failed":w("Network error. Please check your connection and try again.");break;default:w("Failed to resend verification email. Please try again.")}}finally{pe(!1)}},A=()=>{y(!1),R(!1),U(!1),w(""),N(""),D(null),K(0),p(""),g(""),pe(!1)},ae=()=>{y(!x),w(""),N(""),C(!1),R(!1),D(null),g(""),K(0),pe(!1)},ue=()=>{U(!1),R(!1),D(null),w(""),K(0),pe(!1)};return e.jsxs("div",{className:s,children:[c&&e.jsxs(e.Fragment,{children:[e.jsx(em,{onGoogleLogin:Le,isAuthenticating:i}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("div",{className:"w-full border-t border-slate-200 dark:border-slate-600"})}),e.jsx("div",{className:"relative flex justify-center text-sm",children:e.jsx("span",{className:"px-2 bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400",children:"or"})})]})]}),e.jsx(Qh,{email:d,password:m,confirmPassword:f,isSignUp:x,isAuthenticating:i,error:v,statusMessage:b,onEmailChange:u,onPasswordChange:p,onConfirmPasswordChange:g,onToggleSignUp:ae,onPasswordReset:$,onSubmit:Ie}),e.jsx(am,{isEmailVerificationSent:E,email:d,onResendVerification:B,onBackToSignIn:A,isSignUpFlow:x||E,forceOpen:L,onClose:ue,resendCooldown:z,isResending:de}),j&&e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/30 rounded-lg p-3",children:"Password reset email sent! Check your inbox."}),e.jsx(Zh,{})]})};function om({allowGuest:s}){const t=$e(a=>a.currentUser),n=O(a=>a.initGuestWorkspace);return h.useEffect(()=>{t&&we.close()},[t]),e.jsxs("div",{className:"space-y-4",children:[s&&e.jsxs("div",{className:"p-3 rounded-lg border border-border bg-muted/30",children:[e.jsx("div",{className:"text-sm font-medium",children:"è¿˜æ²¡æœ‰æ•°æ®ï¼Ÿ"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"ä½ å¯ä»¥å…ˆç”¨æœ¬åœ°æ¨¡å¼ä½“éªŒï¼ˆæ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºï¼Œä¸ä¼šäº‘åŒæ­¥ï¼‰ã€‚"}),e.jsx("div",{className:"mt-3 flex gap-2",children:e.jsx(k,{size:"sm",variant:"ghost",className:"h-8 px-3 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200",onClick:async()=>{await n(),we.close()},children:"æœ¬åœ°ä½“éªŒ"})})]}),e.jsx(rm,{})]})}function ns(s){we.show({title:s?.title??"Sign in",description:s?.description??"Sign in to enable cloud features like publishing and sync.",showFooter:!1,className:"w-full max-w-[560px] sm:max-w-[560px]",content:e.jsx(om,{allowGuest:s?.allowGuest})})}const Mi=()=>{const{currentUser:s,signOut:t}=$e(),n=async()=>{ns()},a=async()=>{await t()};return s?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm",children:["Hello, ",s.displayName]}),e.jsx(k,{onClick:a,variant:"outline",size:"sm",children:"Logout"})]}):e.jsx(k,{onClick:n,variant:"ghost",size:"sm",className:"h-8 w-8 p-0 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800","aria-label":"Sign in with Google",children:e.jsx(Dc,{className:"w-4 h-4 text-slate-600 dark:text-slate-400"})})};function Fr({className:s,...t}){return e.jsx(Hl,{"data-slot":"avatar",className:M("relative flex size-8 shrink-0 overflow-hidden rounded-full",s),...t})}function Br({className:s,...t}){return e.jsx(Gl,{"data-slot":"avatar-image",className:M("aspect-square size-full",s),...t})}function Hr({className:s,...t}){return e.jsx(Vl,{"data-slot":"avatar-fallback",className:M("bg-muted flex size-full items-center justify-center rounded-full",s),...t})}function Us({...s}){return e.jsx(Wl,{"data-slot":"popover",...s})}function zs({...s}){return e.jsx(ql,{"data-slot":"popover-trigger",...s})}function Fs({className:s,align:t="center",sideOffset:n=4,...a}){return e.jsx(Kl,{children:e.jsx(Yl,{"data-slot":"popover-content",align:t,sideOffset:n,className:M("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",s),...a})})}function Gr({...s}){return e.jsx(Xl,{"data-slot":"popover-close",...s})}function wn({delayDuration:s=0,...t}){return e.jsx(Jl,{"data-slot":"tooltip-provider",delayDuration:s,...t})}function Vr({...s}){return e.jsx(wn,{children:e.jsx(Ql,{"data-slot":"tooltip",...s})})}function qr({...s}){return e.jsx(Zl,{"data-slot":"tooltip-trigger",...s})}function Wr({className:s,sideOffset:t=0,children:n,...a}){return e.jsx(ec,{children:e.jsxs(tc,{"data-slot":"tooltip-content",sideOffset:t,className:M("bg-primary text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",s),...a,children:[n,e.jsx(sc,{className:"bg-primary fill-primary z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]"})]})})}const im=({user:s})=>{const[t,n]=h.useState(!1);if(!s)return e.jsx(wn,{children:e.jsxs(Vr,{children:[e.jsx(qr,{asChild:!0,children:e.jsx("div",{className:"px-2 py-1",children:e.jsx(Mi,{})})}),e.jsx(Wr,{side:"right",children:e.jsx("p",{children:"Sign in to sync your data"})})]})});const a=async()=>{try{await xe.signOut(),n(!1)}catch(r){console.error("Logout failed:",r)}};return e.jsx(wn,{children:e.jsxs(Vr,{children:[e.jsx(qr,{asChild:!0,children:e.jsxs(Us,{open:t,onOpenChange:n,children:[e.jsx(zs,{asChild:!0,children:e.jsx(k,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800",children:e.jsxs(Fr,{className:"h-6 w-6",children:[e.jsx(Br,{src:s.photoURL||void 0,alt:"User avatar"}),e.jsx(Hr,{className:"text-xs",children:s.displayName?.charAt(0)||s.email?.charAt(0)||"U"})]})})}),e.jsx(Fs,{side:"right",className:"w-64 p-3",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 pb-2 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs(Fr,{className:"h-10 w-10",children:[e.jsx(Br,{src:s.photoURL||void 0,alt:"User avatar"}),e.jsx(Hr,{children:s.displayName?.charAt(0)||s.email?.charAt(0)||"U"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.displayName||"User"}),e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 truncate",children:s.email})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsxs(k,{variant:"outline",size:"sm",className:"w-full justify-start gap-2",onClick:a,children:[e.jsx(So,{className:"h-4 w-4"}),"Sign Out"]})})]})})]})}),e.jsx(Wr,{side:"right",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-medium",children:s.displayName||"User"}),e.jsx("p",{className:"text-xs text-slate-400",children:s.email}),e.jsx("p",{className:"text-xs text-slate-500",children:"Click to manage account"})]})})]})})},Ei=()=>{const{user:s}=vi();return s?e.jsx(im,{user:s}):e.jsx(Mi,{})};function lm({className:s}){const{activeId:t,setActiveId:n,items:a}=Vt(),r=a.filter(l=>l.group===ls.MAIN),o=a.filter(l=>l.group===ls.FOOTER),i=l=>{l!=="feedback"&&n(l)};return e.jsx("div",{className:M("relative flex-shrink-0 h-full","bg-sidebar border-none","shadow-md",s),children:e.jsxs($t.Root,{toggleable:!1,expanded:!1,activeId:t,expandedWidth:240,onExpandedChange:()=>{},onActiveChange:i,className:"relative z-10 h-full bg-transparent border-none",children:[e.jsx($t.Header,{icon:e.jsx("div",{className:"flex items-center justify-center w-6 h-6",children:e.jsx(_c,{className:"w-5 h-5"})}),title:"StillRoot",showSearch:!1,showSeparator:!1,className:"bg-sidebar"}),e.jsx($t.GroupList,{showSeparator:!1,children:e.jsx($t.Group,{title:"main",children:r.map(l=>e.jsx($t.Item,{id:l.id,className:"activity-bar-item",activeClassName:"bg-sidebar-accent text-sidebar-accent-foreground shadow-sm",collapsedLabel:l.collapsedLabel,icon:e.jsx("div",{"data-testid":l.id,className:M("flex items-center justify-center"),children:e.jsx(Ur,{id:l.icon})}),onClick:l.onClick,label:l.label,title:l.title},l.id))})}),e.jsxs($t.Footer,{className:"bg-sidebar",children:[e.jsx("div",{className:"px-2 py-2 flex justify-center",children:e.jsx(Ei,{})}),e.jsx("div",{className:"px-2 py-2 flex justify-center",children:e.jsx(Ci,{})}),o.map(l=>e.jsx($t.Item,{id:l.id,className:"activity-bar-item",collapsedLabel:l.collapsedLabel,icon:e.jsx("div",{"data-testid":l.id,className:M("flex items-center justify-center",l.iconColor||"text-slate-600 dark:text-slate-400"),children:e.jsx(Ur,{id:l.icon})}),onClick:l.onClick,label:l.label,title:l.title},l.id))]})]})})}function Ii(s,t,n){return n?s.map(a=>a.id===n?{...a,children:a.children?[...a.children,t]:[t]}:a.children?{...a,children:Ii(a.children,t,n)}:a):[...s,t]}function Ti(s,t,n){return n?s.map(a=>a.id===n?{...a,children:a.children?[...a.children,...t]:t}:a.children?{...a,children:Ti(a.children,t,n)}:a):[...s,...t]}function mn(s,t){return s.filter(n=>n.id!==t).map(n=>n.children?{...n,children:mn(n.children,t)}:n)}function Ai(s,t,n){return s.map(a=>a.id===t?{...a,...n}:a.children?{...a,children:Ai(a.children,t,n)}:a)}const Pn=Ee()((s,t)=>({routes:[],addRoute:(n,a)=>(s(r=>({routes:Ii(r.routes,n,a)})),()=>{s(r=>({routes:mn(r.routes,n.id)}))}),addRoutes:(n,a)=>(s(r=>({routes:Ti(r.routes,n,a)})),()=>{s(r=>({routes:n.reduce((o,i)=>mn(o,i.id),r.routes)}))}),removeRoute:n=>{s(a=>({routes:mn(a.routes,n)}))},updateRoute:(n,a)=>{s(r=>({routes:Ai(r.routes,n,a)}))},getRoutes:()=>t().routes,reset:()=>s({routes:[]})}));function Li(s){return s.sort((t,n)=>(t.order??0)-(n.order??0)).map(t=>e.jsx(qo,{path:t.path,element:t.element,children:t.children&&Li(t.children)},t.id))}const cm=()=>{const s=Pn(t=>t.routes);return e.jsx(Vo,{children:Li(s)})},dm=s=>{const{extensions:t}=s,{initialized:n}=Ni({extensions:t});return n?e.jsx("div",{className:"fixed inset-0 flex flex-col",children:e.jsx("div",{className:M("flex flex-col h-full"),children:e.jsxs("div",{className:"flex-1 min-h-0 flex",children:[e.jsx(lm,{className:"flex"}),e.jsx(cm,{})]})})}):e.jsx("div",{children:"Loading..."})};function ba(s,t={}){const{exact:n=!1,sensitive:a=!1}=t,r=s.replace(/:[^/]+/g,"([^/]+)").replace(/\*/g,".*"),o=a?"":"i";return new RegExp(`^${r}${n?"$":""}`,o)}function Ri(s,t,n={}){const a=[...t].sort((r,o)=>{const i=(r.routerPath?.includes(":")||r.routerPaths?.some(u=>u.includes(":")))??!1,l=(o.routerPath?.includes(":")||o.routerPaths?.some(u=>u.includes(":")))??!1,c=(r.routerPath?.includes("*")||r.routerPaths?.some(u=>u.includes("*")))??!1,d=(o.routerPath?.includes("*")||o.routerPaths?.some(u=>u.includes("*")))??!1;return i&&!l?1:!i&&l?-1:c&&!d?1:!c&&d?-1:0});for(const r of a){if(r.routerPath&&ba(r.routerPath,n).test(s))return r;if(r.routerPaths){for(const o of r.routerPaths)if(ba(o,n).test(s))return r}if(r.children){const o=Ri(s,r.children,n);if(o)return o}}}function Kr(s,t,n={}){const a=Ri(s,t,n);a&&Vt.getState().setActiveId(a.activityKey)}function Yr(s,t,n={}){const a=t.find(c=>c.activityKey===s);if(!a)return;const r=Nt.getState().currentPath;if(!r)return;const o=[];a.routerPath&&o.push(a.routerPath),a.routerPaths&&o.push(...a.routerPaths),a.children&&a.children.forEach(c=>{c.routerPath&&o.push(c.routerPath),c.routerPaths&&o.push(...c.routerPaths)});for(const c of o)if(ba(c,n).test(r))return;const l=o.sort((c,d)=>{const u=c.includes(":"),m=d.includes(":"),p=c.includes("*"),f=d.includes("*");return!u&&m?-1:u&&!m?1:!p&&f?-1:p&&!f?1:c.length-d.length})[0];l&&Nt.getState().navigate(l)}function um(s,t={}){const n=Nt.getState().currentPath;return n&&Kr(n,s,t),Nt.subscribe((a,r)=>{if(a.currentPath===r.currentPath)return;const o=a.currentPath;o&&Kr(o,s,t)})}function hm(s){const t=Vt.getState().activeId;return t&&Yr(t,s),Vt.subscribe((n,a)=>{if(n.activeId===a.activeId)return;const r=n.activeId;r&&Yr(r,s)})}function Di(s,t={}){const n=um(s,t),a=hm(s);return()=>{n(),a()}}const Ba=(s,t)=>{const n=$s(t);h.useEffect(()=>s?.listen(n),[s,n])};var nt=(s=>(s.AI_ASSISTANT="ai_assistant",s.THREAD="thread",s.SETTINGS="settings",s.STUDIO="studio",s))(nt||{});const ve=Ee()(At((s,t)=>({sideView:si()?void 0:"ai_assistant",currentThreadId:null,isChannelListOpen:!1,get isStudioOpen(){return t().sideView==="studio"},setSideView:(n,a=null)=>{s({sideView:n,currentThreadId:n==="thread"?a:null})},closeSideView:()=>{s({sideView:void 0,currentThreadId:null})},openAIAssistant:()=>{s({sideView:"ai_assistant",currentThreadId:null})},closeAIAssistant:()=>{t().sideView==="ai_assistant"&&s({sideView:void 0})},openThread:n=>{s({sideView:"thread",currentThreadId:n})},closeThread:()=>{t().sideView==="thread"&&s({sideView:void 0,currentThreadId:null})},openSettings:()=>{s({sideView:"settings",currentThreadId:null})},closeSettings:()=>{t().sideView==="settings"&&s({sideView:void 0})},openStudio:()=>{s({sideView:"studio",currentThreadId:null})},closeStudio:()=>{t().sideView==="studio"&&s({sideView:void 0})},openChannelList:()=>{s({isChannelListOpen:!0})},closeChannelList:()=>{s({isChannelListOpen:!1})}}),{name:"echonote-ui-state",partialize:s=>({sideView:s.sideView})}));var va=(s=>(s.DESKTOP="desktop",s.MOBILE="mobile",s))(va||{}),_i=(s=>(s.TEXT="text",s.IMAGE="image",s.FILE="file",s))(_i||{}),Bt=(s=>(s.NAME="name",s.DESCRIPTION="description",s.EMOJI="emoji",s))(Bt||{}),Pi=(s=>(s.BUTTON="button",s.HOTKEY="hotkey",s.AUTO="auto",s))(Pi||{}),Oi=(s=>(s.LEFT="left",s.RIGHT="right",s))(Oi||{}),ya=(s=>(s.OPEN="open",s.CLOSE="close",s))(ya||{}),wa=(s=>(s.COLLAPSE="collapse",s.EXPAND="expand",s))(wa||{});class mm{logEvent=(t,n)=>{const a=J.getAnalytics();if(a)try{bd(a,t,n)}catch(r){console.error("[Analytics] Failed to log event",r)}};setUserProperties=t=>{const n=J.getAnalytics();n&&vd(n,t)};logAppStart=(t,n)=>{this.logEvent("app_start",{platform:t,version:n})};logAppClose=t=>{this.logEvent("app_close",{session_duration:t})};logChannelCreate=(t,n,a)=>{this.logEvent("channel_create",{channel_id:t,channel_name:n,has_description:a})};logChannelSelect=(t,n,a)=>{this.logEvent("channel_select",{channel_id:t,channel_name:n,message_count:a})};logChannelEdit=(t,n)=>{this.logEvent("channel_edit",{channel_id:t,field:n})};logChannelDelete=(t,n,a)=>{this.logEvent("channel_delete",{channel_id:t,channel_name:n,message_count:a})};logNoteCreate=(t,n,a,r)=>{this.logEvent("note_create",{channel_id:t,note_type:n,content_length:a,has_tags:r})};logMessageEdit=(t,n,a)=>{this.logEvent("message_edit",{message_id:t,channel_id:n,edit_count:a})};logMessageDelete=(t,n,a)=>{this.logEvent("message_delete",{message_id:t,channel_id:n,message_age:a})};logMessageReply=(t,n,a)=>{this.logEvent("message_reply",{message_id:t,channel_id:n,thread_id:a})};logAIAssistantOpen=(t,n)=>{this.logEvent("ai_assistant_open",{channel_id:t,trigger:n})};logAIAssistantClose=(t,n,a)=>{this.logEvent("ai_assistant_close",{channel_id:t,session_duration:n,message_count:a})};logAIMessageSend=(t,n,a)=>{this.logEvent("ai_message_send",{channel_id:t,message_length:n,context_mode:a})};logAIMessageReceive=(t,n,a,r)=>{this.logEvent("ai_message_receive",{channel_id:t,response_length:n,response_time:a,tool_used:r})};logAIToolUse=(t,n,a)=>{this.logEvent("ai_tool_use",{tool_name:t,channel_id:n,success:a})};logThreadOpen=(t,n,a)=>{this.logEvent("thread_open",{message_id:t,channel_id:n,thread_count:a})};logThreadClose=(t,n,a)=>{this.logEvent("thread_close",{message_id:t,channel_id:n,session_duration:a})};logThreadReply=(t,n,a)=>{this.logEvent("thread_reply",{message_id:t,channel_id:n,thread_id:a})};logSearchStart=(t,n)=>{this.logEvent("search_start",{query:t,channel_id:n,search_scope:n?"channel":"global"})};logSearchResult=(t,n,a)=>{this.logEvent("search_result",{query:t,result_count:n,channel_id:a,search_scope:a?"channel":"global"})};logSearchSelect=(t,n,a)=>{this.logEvent("search_select",{query:t,result_index:n,channel_id:a,search_scope:a?"channel":"global"})};logSidebarToggle=(t,n)=>{this.logEvent("sidebar_toggle",{sidebar:t,action:n})};logInputCollapse=t=>{this.logEvent("input_collapse",{action:t})};logScrollToBottom=(t,n)=>{this.logEvent("scroll_to_bottom",{channel_id:t,message_count:n})};logScrollToLatest=(t,n)=>{this.logEvent("scroll_to_latest",{channel_id:t,message_count:n})};logMessageExpand=(t,n,a)=>{this.logEvent("message_expand",{message_id:t,channel_id:n,content_length:a})};logSettingsOpen=t=>{this.logEvent("settings_open",{channel_id:t})};logThemeChange=t=>{this.logEvent("theme_change",{theme:t})};logContextModeChange=(t,n)=>{this.logEvent("context_mode_change",{mode:t,channel_id:n})};logPageLoad=(t,n,a)=>{this.logEvent("page_load",{page:t,load_time:n,platform:a})};logMessageLoad=(t,n,a)=>{this.logEvent("message_load",{channel_id:t,message_count:n,load_time:a})};logVirtualizationPerformance=(t,n,a,r)=>{this.logEvent("virtualization_performance",{channel_id:t,visible_count:n,total_count:a,render_time:r})};logError=(t,n,a,r)=>{this.logEvent("error_occurred",{error_type:t,error_message:n,component:a,channel_id:r})};logAIFailure=(t,n,a)=>{this.logEvent("ai_failure",{channel_id:t,error_type:n,retry_count:a})};logDailyActive=(t,n,a)=>{this.logEvent("daily_active",{message_count:t,channel_count:n,ai_usage_count:a})};logSessionMetrics=(t,n,a,r)=>{this.logEvent("session_metrics",{session_duration:t,message_count:n,ai_interaction_count:a,channel_count:r})};logFeatureUsage=(t,n,a)=>{this.logEvent("feature_usage",{feature:t,action:n,channel_id:a})};logExport=(t,n,a)=>{this.logEvent("export",{format:t,channel_id:n,message_count:a})};logTagUse=(t,n,a)=>{this.logEvent("tag_use",{tag:t,channel_id:n,action:a})};logHotkeyUse=(t,n)=>{this.logEvent("hotkey_use",{hotkey:t,context:n})};logMobileGesture=(t,n)=>{this.logEvent("mobile_gesture",{gesture:t,action:n})};logPWAInstall=t=>{this.logEvent("pwa_install",{platform:t})};logPWAUpdate=t=>{this.logEvent("pwa_update",{version:t})};logBatchOperation=(t,n,a)=>{this.logEvent("batch_operation",{operation:t,item_count:n,channel_id:a})};logFeedback=(t,n,a)=>{this.logEvent("feedback",{type:t,rating:n,channel_id:a})}}const Ne=new mm,$i=h.createContext(null),gm=()=>{const s=h.useContext($i);if(!s)throw new Error("useCollapsibleSidebar must be used within CollapsibleSidebar");return s},pm=({children:s,width:t="w-80",collapsedWidth:n="w-0",className:a="",collapsed:r,onCollapseChange:o})=>{const[i,l]=h.useState(!1),c=r!==void 0?r:i,d=()=>{const m=!c;Ne.logSidebarToggle(Oi.LEFT,m?ya.CLOSE:ya.OPEN),r===void 0&&l(m),o?.(m)};h.useEffect(()=>{r!==void 0&&l(r)},[r]);const u={isCollapsed:c,toggleCollapse:d,onCollapseChange:o};return e.jsx($i.Provider,{value:u,children:e.jsx("div",{"data-component":"collapsible-sidebar",className:M("flex-shrink-0 transition-all duration-300 ease-in-out overflow-hidden",c?n:t,a),children:e.jsx("div",{className:M("h-full flex flex-col transition-opacity duration-300",c?"opacity-0":"opacity-100"),children:s})})})},fm=({children:s,className:t=""})=>e.jsx("div",{className:M("flex items-center justify-between p-3 border-b border-border",t),children:s}),xm=({className:s="",children:t})=>{const{isCollapsed:n,toggleCollapse:a}=gm();return e.jsx(k,{variant:"ghost",size:"sm",onClick:a,className:M("h-8 w-8 hover:bg-accent transition-all duration-300",n?"opacity-0 scale-95":"opacity-100 scale-100",s),title:n?"Expand sidebar":"Collapse sidebar",children:t||e.jsx(bn,{className:"h-4 w-4"})})},bm=({children:s,className:t=""})=>e.jsx("div",{"data-component":"collapsible-sidebar-content",className:M("flex-1 overflow-hidden",t),children:s}),jn=Object.assign(pm,{Header:fm,ToggleButton:xm,Content:bm}),Ct=Ee()(At(s=>({isLeftSidebarCollapsed:!1,rightSidebarVisible:!1,rightSidebarSize:35,layoutMode:"default",showTimestamps:!0,showUserAvatars:!0,timelineCoverCollapsed:!0,timelineInputCollapsed:{},toggleLeftSidebar:()=>{s(t=>({isLeftSidebarCollapsed:!t.isLeftSidebarCollapsed}))},setLeftSidebarCollapsed:t=>{s({isLeftSidebarCollapsed:t})},setRightSidebarVisible:t=>{s({rightSidebarVisible:t})},setRightSidebarSize:t=>{s({rightSidebarSize:t})},setLayoutMode:t=>{s({layoutMode:t})},setShowTimestamps:t=>{s({showTimestamps:t})},setShowUserAvatars:t=>{s({showUserAvatars:t})},setTimelineCoverCollapsed:t=>{s({timelineCoverCollapsed:t})},setTimelineInputCollapsed:(t,n)=>{s(a=>({timelineInputCollapsed:{...a.timelineInputCollapsed,[t]:n}}))}}),{name:"echonote-ui-preferences-storage",partialize:s=>({isLeftSidebarCollapsed:s.isLeftSidebarCollapsed,rightSidebarVisible:s.rightSidebarVisible,rightSidebarSize:s.rightSidebarSize,layoutMode:s.layoutMode,showTimestamps:s.showTimestamps,showUserAvatars:s.showUserAvatars,timelineCoverCollapsed:s.timelineCoverCollapsed,timelineInputCollapsed:s.timelineInputCollapsed}),version:2,migrate:(s,t)=>{if(t<2&&s&&typeof s=="object"){const n=s,a=n.timelineCoverCollapsed;let r;return a&&typeof a=="object"&&!Array.isArray(a)?r=Object.values(a).some(Boolean):r=!!a,{...n,timelineCoverCollapsed:r}}return s}})),vm=({children:s,width:t="w-70",collapsedWidth:n="w-0",className:a=""})=>{const{isLeftSidebarCollapsed:r,setLeftSidebarCollapsed:o}=Ct(),i=l=>{o(l)};return e.jsx(jn,{width:t,collapsedWidth:n,className:a,collapsed:r,onCollapseChange:i,children:e.jsx(jn.Content,{children:s})})};function ym({className:s,...t}){return e.jsx(Kd,{"data-slot":"resizable-panel-group",className:M("flex h-full w-full data-[panel-group-direction=vertical]:flex-col",s),...t})}function Xr({...s}){return e.jsx(Yd,{"data-slot":"resizable-panel",...s})}function wm({withHandle:s,className:t,...n}){return e.jsx(Xd,{"data-slot":"resizable-handle",className:M("bg-border/20 hover:bg-border/40 relative flex w-px items-center justify-center after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:translate-x-0 data-[panel-group-direction=vertical]:after:-translate-y-1/2 [&[data-panel-group-direction=vertical]>div]:rotate-90 transition-colors duration-200",t),...n,children:s&&e.jsx("div",{className:"bg-border/30 hover:bg-border/50 z-10 flex h-4 w-3 items-center justify-center rounded-xs border border-border/20 transition-colors duration-200",children:e.jsx(Pc,{className:"size-2.5 text-muted-foreground/60"})})})}const jm=({children:s,rightSidebar:t,farRightSidebar:n,className:a=""})=>{const{rightSidebarSize:r,setRightSidebarSize:o}=Ct(),l=!!t||!!n?100-r:100;return e.jsxs(ym,{direction:"horizontal",className:"flex-1 min-h-0",children:[e.jsx(Xr,{id:"content-panel",defaultSize:l,minSize:20,children:e.jsx("div",{className:`h-full flex flex-col bg-background overflow-hidden ${a}`,children:s})}),(t||n)&&e.jsxs(e.Fragment,{children:[e.jsx(wm,{withHandle:!0}),e.jsx(Xr,{id:"right-sidebar-panel",defaultSize:r,minSize:20,onResize:c=>{o(c)},children:e.jsxs("div",{className:"h-full border-l border-border/40 bg-muted overflow-hidden flex",children:[t&&e.jsx("div",{className:"h-full flex-1 min-w-0",children:t}),n&&e.jsx("div",{className:`h-full ${t?"w-[450px] min-w-[450px] border-l border-border/40":"flex-1 min-w-0"}`,children:n})]})})]})]})},Nm=({sidebar:s,content:t,rightSidebar:n,farRightSidebar:a,className:r=""})=>e.jsx("div",{className:`flex-1 flex flex-col bg-background ${r} overflow-hidden`,children:e.jsxs("div",{className:"flex-1 flex min-h-0 relative",children:[e.jsx(vm,{className:"bg-card dark:bg-sidebar",children:s}),e.jsx(jm,{rightSidebar:n,farRightSidebar:a,children:t})]})});function ja(s,t=new WeakSet){if(s===null)return null;const n=typeof s;if(n==="string"||n==="number"||n==="boolean")return s;if(n==="bigint")return Number(s);if(!(n==="symbol"||n==="function"||n==="undefined")){if(Array.isArray(s))return s.map(r=>ja(r,t)).filter(r=>r!==void 0);if(n==="object"){const a=s;if(t.has(a))return;t.add(a);const r={};for(const[o,i]of Object.entries(a)){const l=ja(i,t);l!==void 0&&(r[o]=l)}return t.delete(a),r}}}function sn(s){return{id:s.id,role:s.role,parts:ja(s.parts)}}class Cm{getDb(){return J.getDb()}async createConversation(t,n,a){const r=crypto.randomUUID(),o={id:r,title:n,userId:t,createdAt:new Date,updatedAt:new Date,lastMessageAt:new Date,messageCount:0,isArchived:!1,...a?{contexts:a}:{}};return await Es(se(this.getDb(),`users/${t}/aiConversations/${r}`),{...o,createdAt:Z(),updatedAt:Z(),lastMessageAt:Z()}),o}async getConversations(t){const n=this.buildConversationsQuery(t);return(await ge(n)).docs.map(r=>this.docToAIConversation(r))}async listConversations(t,n={}){const a=n.limit??20;let r=ce(Ae(this.getDb(),`users/${t}/aiConversations`),Re("lastMessageAt","desc"),wt(a));n.startAfterLastMessageAt&&(r=ce(r,la(n.startAfterLastMessageAt)));const o=await ge(r),i=o.docs.map(c=>this.docToAIConversation(c));let l=null;return i.length===a&&(l=o.docs[o.docs.length-1].data()?.lastMessageAt?.toDate?.()??i[i.length-1]?.lastMessageAt??null),{items:i,nextCursor:l}}async getConversation(t,n){const a=se(this.getDb(),`users/${t}/aiConversations/${n}`),r=await jt(a);return r.exists()?this.docToAIConversation(r):null}async deleteConversation(t,n){const a=Ae(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages`),o=(await ge(a)).docs.map(i=>cn(i.ref));await Promise.all(o),await cn(se(this.getDb(),`users/${t}/aiConversations/${n}`))}async updateConversation(t,n,a){await be(se(this.getDb(),`users/${t}/aiConversations/${n}`),{...a,updatedAt:Z()})}async addMessage(t,n,a){const r=se(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${a.id}`),i=!(await jt(r)).exists();if(i){console.log("[FirebaseAIConversationService] addMessage new message",a);const c=sn(a);await Es(r,{...c,conversationId:n,timestamp:Z()})}else{console.log("[FirebaseAIConversationService] addMessage existing message",a);const c=sn(a);await be(r,{...c,conversationId:n,timestamp:Z()})}const l={lastMessageAt:Z(),updatedAt:Z()};i&&(l.messageCount=zt(1)),await be(se(this.getDb(),`users/${t}/aiConversations/${n}`),l)}async createMessage(t,n,a){const r=se(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${a.id}`);if((await jt(r)).exists())return;const i=sn(a);await Es(r,{...i,conversationId:n,timestamp:Z()}),await be(se(this.getDb(),`users/${t}/aiConversations/${n}`),{lastMessageAt:Z(),updatedAt:Z(),messageCount:zt(1)})}async getMessages(t,n){const a=ce(Ae(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages`),Re("timestamp","asc"));return(await ge(a)).docs.map(o=>this.docToUIMessage(o))}async listMessages(t,n,a={}){const{limit:r=50,orderBy:o="asc",startAfter:i,endBefore:l}=a;let c=ce(Ae(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages`),Re("timestamp",o));if(r&&(c=ce(c,Dd(r))),i){const u=await jt(se(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${i}`));c=ce(c,la(u))}if(l){const u=await jt(se(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${l}`));c=ce(c,_d(u))}return(await ge(c)).docs.map(u=>this.docToUIMessage(u))}async updateMessage(t,n,a,r){const o={updatedAt:Z()},i=r;if(Object.prototype.hasOwnProperty.call(i,"role")&&(o.role=i.role),Object.prototype.hasOwnProperty.call(i,"parts")){const l=sn({id:a,role:i.role??"assistant",parts:i.parts});o.parts=l.parts}await be(se(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${a}`),o)}async deleteMessage(t,n,a){await cn(se(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages/${a}`)),await be(se(this.getDb(),`users/${t}/aiConversations/${n}`),{messageCount:zt(-1),updatedAt:Z()})}subscribeToMessages(t,n,a){const r=ce(Ae(this.getDb(),`users/${t}/aiConversations/${n}/uiMessages`),Re("timestamp","asc"));return Ms(r,o=>{const i=o.docs.map(l=>this.docToUIMessage(l));a(i)})}subscribeToConversations(t,n){const a=this.buildConversationsQuery(t);return Ms(a,r=>{const o=r.docs.map(i=>this.docToAIConversation(i));n(o)})}buildConversationsQuery(t){return ce(Ae(this.getDb(),`users/${t}/aiConversations`),Re("lastMessageAt","desc"))}docToAIConversation(t){const n=t.data(),a={id:t.id,title:n.title,userId:n.userId,createdAt:n.createdAt?.toDate()||new Date,updatedAt:n.updatedAt?.toDate()||new Date,lastMessageAt:n.lastMessageAt?.toDate()||new Date,messageCount:n.messageCount||0,isArchived:n.isArchived||!1};let r;return n.contexts?r=n.contexts:n.channelId&&(r={mode:"channels",channelIds:[n.channelId]}),r?{...a,contexts:r}:a}docToUIMessage(t){const n=t.data();return{id:t.id,role:n.role,parts:n.parts}}}const qe=new Cm,km="sk-06c61fc3bb2543069ed235e2df877f8a",Sm="https://dashscope.aliyuncs.com/compatible-mode/v1",Ds="qwen-plus-latest",_s=new Ko({apiKey:km,baseURL:Sm,dangerouslyAllowBrowser:!0});async function Mm({prompt:s,system:t,temperature:n}){const r=(await _s.chat.completions.create({model:Ds,messages:[{role:"system",content:t},{role:"user",content:s}],temperature:n})).choices?.[0]?.message?.content;return typeof r=="string"?r:""}class Em{inFlight=new Map;queue=[];running=!1;enabled=!0;minIntervalMs=1500;results=new Map;setEnabled(t){this.enabled=t}request(t,n,a){if(!this.enabled)return Promise.resolve("");const r=this.inFlight.get(t);if(r)return r.promise;const o=new Promise((i,l)=>{const c=a?.mode||"deterministic";this.queue.push(JSON.stringify({id:t,text:n,mode:c})),this.runLoop().catch(()=>{});const d=setInterval(()=>{const u=this.results.get(t);u!==void 0&&(clearInterval(d),this.results.delete(t),u.error?l(u.error):i(u.title||""))},50)});return this.inFlight.set(t,{promise:o,ts:Date.now()}),o.finally(()=>this.inFlight.delete(t)),o}async runLoop(){if(this.running)return;this.running=!0;let t=0;for(;this.queue.length;){const n=this.queue.shift();if(!n)break;const{id:a,text:r,mode:o}=JSON.parse(n),i=Date.now()-t;i<this.minIntervalMs&&await new Promise(l=>setTimeout(l,this.minIntervalMs-i));try{const l=await this.generateTitle(r,o);this.results.set(a,{title:l}),t=Date.now()}catch(l){this.results.set(a,{error:l}),t=Date.now()}}this.running=!1}async generateTitle(t,n){return n==="deterministic"?this.generateDeterministicTitle(t):n==="auto"&&!this.enabled?this.generateDeterministicTitle(t):n==="ai"||n==="auto"&&this.enabled?this.generateAITitle(t):this.generateDeterministicTitle(t)}generateDeterministicTitle(t){return t.trim().replace(/\s+/g," ").slice(0,200)}async generateAITitle(t){try{const n=this.buildTitlePrompt(t),a=await this.callAIService(n),r=this.validateAndTrimTitle(a);return r||this.generateDeterministicTitle(t)}catch(n){return console.warn("AI title generation failed, falling back to deterministic:",n),this.generateDeterministicTitle(t)}}buildTitlePrompt(t){return`Generate a concise, descriptive title for this conversation content. The title should be:
- Maximum 36 characters
- Capture the main topic or theme
- Be clear and informative
- Avoid generic phrases like "New Conversation"

Content: ${t}`}async callAIService(t){return await Mm({prompt:t,system:"You are a helpful assistant that generates concise, descriptive titles for conversations.",temperature:.3})}validateAndTrimTitle(t){const n=t.trim();return n&&n.length<=36?n:null}}const Im=new Em;async function Tm(s){if(!Am(s))return;const t=Lm(s.messages);if(t){s.setTitleGenerating(s.conversationId);try{const n=await Rm(s,t);if(!n){s.completeTitleGenerating(s.conversationId);return}await Dm(s,n),s.completeTitleGenerating(s.conversationId)}catch(n){throw s.completeTitleGenerating(s.conversationId),n}}}function Am(s){const{conversationId:t,conversation:n,autoTitleDone:a}=s;return a[t]?!1:!n.title||/^New Conversation/i.test(n.title)||n.title.startsWith("temp-")}function Lm(s){const t=s.find(a=>a.role==="user");return t&&t.parts.find(a=>a.type==="text")?.text?.trim()||""}async function Rm(s,t){const{conversationId:n,autoTitleEnabled:a,autoTitleMode:r}=s,o=a?r:"deterministic";try{const i=await Im.request(n,t,{mode:o});if(i)return i}catch{return t.replace(/\s+/g," ").slice(0,36)}return t.replace(/\s+/g," ").slice(0,36)}async function Dm(s,t){const{conversationId:n,getUserId:a,update:r,applyLocal:o,markDone:i}=s,l=a();l&&(await r(l,n,t),o(n,t),i(n))}function _m(s,t,n){return s.id.startsWith("temp-")||t.autoTitleDone[s.id]||t.titleGeneratingMap[s.id]||!n.some(o=>o.role==="user")?!1:!s.title||/^New Conversation/i.test(s.title)||s.title.startsWith("temp-")||s.title==="Generating title..."}const Ui=s=>s.startsWith("temp-"),Y=Ee((s,t)=>({conversations:[],currentConversationId:null,loading:!0,loadingMore:!1,error:null,selectionTick:0,uiView:"chat",deletingIds:[],showArchived:!1,query:"",titleGeneratingMap:{},autoTitleEnabled:!0,autoTitleDone:{},autoTitleMode:"ai",nextCursor:null,hasMore:!1,async createConversation(n,a,r){s({error:null});const o=`temp-${crypto.randomUUID()}`,i={id:o,title:a,userId:n,createdAt:new Date,updatedAt:new Date,lastMessageAt:new Date,messageCount:0,isArchived:!1,...r?{contexts:r}:{}};s(l=>({conversations:[i,...l.conversations],currentConversationId:o,uiView:"chat"}));try{const l=await qe.createConversation(n,a,r);return s(c=>({conversations:c.conversations.map(d=>d.id===o?l:d),currentConversationId:l.id,uiView:"chat"})),l}catch(l){throw s(c=>({conversations:c.conversations.filter(d=>d.id!==o),currentConversationId:c.currentConversationId===o?null:c.currentConversationId,error:l instanceof Error?l.message:"Failed to create conversation"})),l}},async loadConversations(n){s({loading:!0,error:null,nextCursor:null,hasMore:!1});try{const{items:a,nextCursor:r}=await qe.listConversations(n,{limit:20}),o=t().currentConversationId;s({conversations:a,loading:!1,nextCursor:r,hasMore:!!r}),a.length>0&&!o&&s({currentConversationId:a[0].id})}catch(a){s({loading:!1,error:a instanceof Error?a.message:"Failed to load conversations"})}},async loadMoreConversations(n){const{nextCursor:a,loadingMore:r,hasMore:o}=t();if(!(!o||r)){s({loadingMore:!0});try{const{items:i,nextCursor:l}=await qe.listConversations(n,{limit:20,startAfterLastMessageAt:a}),d=[...t().conversations];for(const u of i)d.some(m=>m.id===u.id)||d.push(u);s({conversations:d,nextCursor:l,hasMore:!!l})}catch(i){s({error:i instanceof Error?i.message:"Failed to load more conversations"})}finally{s({loadingMore:!1})}}},selectConversation(n){s(a=>({currentConversationId:n,selectionTick:a.selectionTick+1,uiView:"chat"}))},async deleteConversation(n,a){s(i=>({error:null,deletingIds:[...i.deletingIds,a]}));const r=t().conversations,o=t().currentConversationId===a;s(i=>({conversations:i.conversations.filter(l=>l.id!==a),currentConversationId:o?null:i.currentConversationId}));try{await qe.deleteConversation(n,a)}catch(i){throw s({conversations:r,currentConversationId:o?a:t().currentConversationId,error:i instanceof Error?i.message:"Failed to delete conversation"}),i}finally{s(i=>({deletingIds:i.deletingIds.filter(l=>l!==a)}))}},async updateConversation(n,a,r){const o=t().conversations;s(i=>({conversations:i.conversations.map(l=>l.id===a?{...l,...r}:l)}));try{await qe.updateConversation(n,a,r)}catch(i){throw s({conversations:o,error:i instanceof Error?i.message:"Failed to update conversation"}),i}},clearError(){s({error:null})},showList(){s({uiView:"list"})},showChat(){s({uiView:"chat"})},setView(n){s({uiView:n})},setShowArchived(n){s({showArchived:n})},setQuery(n){s({query:n})},async archiveConversation(n,a){await qe.updateConversation(n,a,{isArchived:!0,updatedAt:new Date}),s(r=>({conversations:r.conversations.map(o=>o.id===a?{...o,isArchived:!0}:o)}))},async unarchiveConversation(n,a){await qe.updateConversation(n,a,{isArchived:!1,updatedAt:new Date}),s(r=>({conversations:r.conversations.map(o=>o.id===a?{...o,isArchived:!1}:o)}))},setTitleGenerating(n){s(a=>({titleGeneratingMap:{...a.titleGeneratingMap,[n]:!0}}))},completeTitleGenerating(n){s(a=>{const r={...a.titleGeneratingMap};return delete r[n],{titleGeneratingMap:r}})},clearTitleGenerating(n){s(a=>{const r={...a.titleGeneratingMap};return delete r[n],{titleGeneratingMap:r}})},setAutoTitleDone(n){s(a=>({autoTitleDone:{...a.autoTitleDone,[n]:!0}}))},setAutoTitleMode(n){s({autoTitleMode:n})},onMessagesSnapshot(n,a){const r=t(),o=r.conversations.find(i=>i.id===n);o&&_m(o,r,a)&&Tm({conversationId:n,conversation:o,messages:a,autoTitleEnabled:r.autoTitleEnabled,autoTitleMode:r.autoTitleMode,autoTitleDone:r.autoTitleDone,getUserId:()=>O.getState().userId,update:async(i,l,c)=>{await qe.updateConversation(i,l,{title:c})},applyLocal:(i,l)=>s(c=>({conversations:c.conversations.map(d=>d.id===i?{...d,title:l}:d)})),markDone:i=>s(l=>({autoTitleDone:{...l.autoTitleDone,[i]:!0}})),setTitleGenerating:i=>t().setTitleGenerating(i),completeTitleGenerating:i=>t().completeTitleGenerating(i)})}}));function Ks(){const s=Y(g=>g.conversations),t=Y(g=>g.currentConversationId),n=Y(g=>g.loading),a=Y(g=>g.loadingMore),r=Y(g=>g.error),o=Y(g=>g.hasMore),i=Y(g=>g.createConversation),l=Y(g=>g.loadConversations),c=Y(g=>g.loadMoreConversations),d=Y(g=>g.selectConversation),u=Y(g=>g.deleteConversation),m=Y(g=>g.updateConversation),p=Y(g=>g.clearError),f=h.useMemo(()=>s.find(g=>g.id===t)||null,[s,t]);return{conversations:s,currentConversationId:t,currentConversation:f,loading:n,loadingMore:a,error:r,hasMore:o,createConversation:i,loadConversations:l,loadMoreConversations:c,selectConversation:d,deleteConversation:u,updateConversation:m,clearError:p}}function Pm(s,t){const{sidebar:n=320,chatMin:a=520,gutter:r=0,hysteresis:o=24,debounceMs:i=100}=t||{},[l,c]=h.useState("two-pane"),[d,u]=h.useState(!1),m=h.useRef(l);return m.current=l,h.useLayoutEffect(()=>{const p=s.current;if(!p)return;const f=n+a+r;let g=null;const x=()=>{const w=p.clientWidth||p.getBoundingClientRect().width,b=m.current;let N;b==="two-pane"?N=w>=f-o?"two-pane":"single-pane":N=w>=f+o?"two-pane":"single-pane",N!==b&&(m.current=N,c(N)),u(!0)},y=()=>{g&&clearTimeout(g),g=setTimeout(x,i)};x();const v=new ResizeObserver(()=>y());return v.observe(p),()=>{g&&clearTimeout(g),v.disconnect()}},[s,n,a,r,o,i]),{mode:l,ready:d}}const Tt=s=>{const t=typeof s=="string"?new Date(s):s;if(isNaN(t.getTime()))return"Unknown time";const n=new Date,a=Math.floor((n.getTime()-t.getTime())/(1e3*60)),r=Math.floor(a/60),o=Yo(n,t);return a<1?"Just now":a<60?`${a}m`:r<24?`${r}h`:Jd(t)?"Yesterday":o<3?`${o}d ago`:Qd(t)?ua(t,"MMM d"):ua(t,"MMM d, yyyy")},Ha=s=>{const t=typeof s=="string"?new Date(s):s;if(isNaN(t.getTime()))return"Unknown time";const n=new Date,a=Math.floor((n.getTime()-t.getTime())/(1e3*60)),r=Math.floor(a/60),o=Yo(n,t);return a<1?"Just now":a<60?`${a}m ago`:r<24?`${r}h ago`:o===1?"Yesterday":o<7?`${o}d ago`:o<30?`${Math.floor(o/7)}w ago`:o<365?`${Math.floor(o/30)}mo ago`:`${Math.floor(o/365)}y ago`};function Ga({conversations:s,currentConversationId:t,loading:n}){const{selectConversation:a,deleteConversation:r,updateConversation:o,loadMoreConversations:i,hasMore:l,loadingMore:c}=Ks(),{userId:d}=O(),u=Y(j=>j.deletingIds),m=Y(j=>j.showArchived),p=Y(j=>j.setShowArchived),f=Y(j=>j.query),g=Y(j=>j.setQuery),x=Y(j=>j.titleGeneratingMap),[y,v]=h.useState(null),[w,b]=h.useState(""),N=s.filter(j=>{if(!m&&j.isArchived)return!1;if(!f)return!0;const C=f.toLowerCase();return(j.title||"").toLowerCase().includes(C)});return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-3 sticky top-0 z-10 flex items-center gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{value:f,onChange:j=>g(j.target.value),placeholder:"Search conversations",className:"w-full h-9 px-3 rounded-lg border bg-muted/50 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-colors"})}),e.jsxs(Us,{children:[e.jsx(zs,{asChild:!0,children:e.jsx("button",{type:"button",className:"h-9 w-9 inline-flex items-center justify-center rounded-lg border bg-background hover:bg-accent transition-colors","aria-label":"Filter",children:e.jsx(Oc,{className:"w-4 h-4"})})}),e.jsx(Fs,{align:"end",sideOffset:6,className:"p-2 w-56",onClick:j=>j.stopPropagation(),onMouseDown:j=>j.stopPropagation(),children:e.jsxs("button",{type:"button",onClick:()=>p(!m),className:"w-full h-8 px-3 rounded-md border bg-background text-sm flex items-center justify-between hover:bg-accent transition-colors",children:[e.jsx("span",{children:"Show archived"}),e.jsx("span",{className:"inline-block w-4 h-4 rounded-sm border "+(m?"bg-primary border-primary":"bg-background")})]})})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:n?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"Loading..."}):N.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"No conversations yet"}):e.jsxs(e.Fragment,{children:[N.map(j=>e.jsx("div",{className:`group px-4 py-3 cursor-pointer hover:bg-accent/50 transition-colors ${t===j.id?"bg-accent":""} ${u.includes(j.id)?"opacity-50 pointer-events-none":""}`,onClick:()=>a(j.id),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"text-sm font-medium text-foreground truncate mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"truncate",children:y===j.id?e.jsx("input",{value:w,onChange:C=>b(C.target.value),onKeyDown:C=>{if(C.key==="Enter"){const E=w.trim();E&&d&&o(d,j.id,{title:E}),v(null)}C.key==="Escape"&&v(null)},onBlur:()=>{const C=w.trim();C&&d&&o(d,j.id,{title:C}),v(null)},className:"h-7 px-2 rounded-sm border bg-background text-sm w-full",autoFocus:!0,onClick:C=>C.stopPropagation()}):e.jsx("span",{onDoubleClick:C=>{C.stopPropagation(),v(j.id),b(j.title||"")},children:x[j.id]?"Generating title...":j.title||"New Conversation"})}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsx(ds,{className:"w-3 h-3 text-muted-foreground/60"}),e.jsx("span",{className:"text-xs text-muted-foreground/70",children:j.messageCount})]})]}),j.isArchived&&e.jsx("span",{className:"ml-2 text-[10px] uppercase tracking-wide text-muted-foreground bg-muted px-1.5 py-0.5 rounded",children:"Archived"})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:Tt(j.lastMessageAt)})]}),d&&e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{type:"button",className:"text-muted-foreground hover:text-foreground p-1.5 rounded-md hover:bg-accent/50 transition-colors",onClick:C=>{C.stopPropagation(),j.isArchived?(o(d,j.id,{isArchived:!1}),Ut.success("Conversation restored")):(o(d,j.id,{isArchived:!0}),Ut.success("Conversation archived"))},"aria-label":j.isArchived?"Restore conversation":"Archive conversation",children:e.jsx($c,{className:"w-4 h-4"})}),e.jsxs(Us,{children:[e.jsx(zs,{asChild:!0,children:e.jsx("button",{type:"button",className:"text-muted-foreground hover:text-foreground p-1.5 rounded-md hover:bg-accent/50 transition-colors",onClick:C=>{C.stopPropagation()},onMouseDown:C=>{C.stopPropagation()},onKeyDown:C=>{C.stopPropagation()},"aria-label":"Delete conversation",children:e.jsx(it,{className:"w-4 h-4"})})}),e.jsxs(Fs,{align:"end",sideOffset:6,className:"p-2 w-56",onClick:C=>C.stopPropagation(),onMouseDown:C=>C.stopPropagation(),children:[e.jsx("div",{className:"text-sm mb-2",children:"Delete this conversation?"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(Gr,{asChild:!0,children:e.jsx("button",{type:"button",className:"h-8 px-3 rounded-md text-sm border hover:bg-accent",onClick:C=>{C.stopPropagation()},children:"Cancel"})}),e.jsx(Gr,{asChild:!0,children:e.jsx("button",{type:"button",className:"h-8 px-3 rounded-md text-sm bg-destructive text-destructive-foreground hover:bg-destructive/90",onClick:C=>{C.stopPropagation(),r(d,j.id).then(()=>Ut.success("Conversation deleted")).catch(()=>Ut.error("Delete failed"))},children:"Delete"})})]})]})]})]})]})},j.id)),l&&d&&e.jsx("div",{className:"p-4 border-t",children:e.jsx("button",{type:"button",className:"w-full h-9 px-4 rounded-lg text-sm border bg-background hover:bg-accent disabled:opacity-60 transition-colors",disabled:c,onClick:()=>{i(d)},children:c?"Loadingâ€¦":"Load more"})})]})})]})}function Om(s){const t=new Map;for(const n of s)n?.id&&t.set(n.id,n);return Array.from(t.values())}class $m{dataContainer=xi({messageByConversation:{}});requestLoadInitialMessages$=new Uo(1);handleRequestWorkflow$=this.requestLoadInitialMessages$.pipe(Ws((t,n)=>t===n),$d(t=>console.log("[ConversationMessageService] handleRequestWorkflow$",t)),Ln(t=>!this.dataContainer.get().messageByConversation[t]),zo(t=>zd(this.loadInitialMessages({conversationId:t}))),Ud({bufferSize:1,refCount:!1}));connectToRequestWorkflow=()=>{const t=this.handleRequestWorkflow$.subscribe();return()=>t.unsubscribe()};getConversationStateControl(t){const n=is(this.dataContainer,`messageByConversation.${t}`),{get:a,namespaces:{messages:{set:r},loading:{set:o},loadingMore:{set:i},hasMore:{set:l},subscription:{set:c}}}=n,d=()=>{a()||n.set({messages:[],loading:!1,loadingMore:!1,hasMore:!0})},u=f=>r(Om(f));return{getState:a,ensureInit:d,setMessages:u,setLoading:o,setLoadingMore:i,setHasMore:l,setSubscription:c,mergeAndSet:f=>{const g=a()?.messages||[];u([...g,...f])},upsert:f=>{const g=a()?.messages||[],x=g.findIndex(y=>y.id===f.id);u(x===-1?[...g,f]:[...g.slice(0,x),f,...g.slice(x+1)])}}}loadInitialMessages=async({conversationId:t})=>{const{userId:n}=O.getState();if(!n||!t)return;const{ensureInit:a,setLoading:r,setMessages:o,setSubscription:i}=this.getConversationStateControl(t);a(),r(!0);try{const l=await qe.getMessages(n,t);o(l);const c=this.subscribeToMessages({userId:n,conversationId:t});i({unsubscribe:c})}finally{r(!1)}};subscribeToMessages=({userId:t,conversationId:n})=>{const{setMessages:a}=this.getConversationStateControl(n);return qe.subscribeToMessages(t,n,r=>a(r||[]))};async createMessage(t,n,a){await qe.createMessage(t,n,a)}async updateMessage(t,n,a){await qe.updateMessage(t,n,a.id,a)}}const Cs=new $m;function Um(s){const{userId:t}=O(),n=h.useMemo(()=>is(Cs.dataContainer,`messageByConversation.${s}`),[s]),{value:a}=bi(n);h.useEffect(()=>Cs.connectToRequestWorkflow(),[]),h.useEffect(()=>{!t||!s||Cs.requestLoadInitialMessages$.next(s)},[t,s]);const r=async i=>{t&&await Cs.createMessage(t,s,i)},o=async i=>{t&&await Cs.updateMessage(t,s,i)};return{messages:a?.messages||[],loading:a?.loading||!1,createMessage:r,updateMessage:o}}const vt="https://stillroot-ai-proxy.agentverse.cc",qt=[{id:"qwen-plus",name:"Qwen Plus",description:"Alibaba Cloud Qwen model via DashScope",apiKey:"sk-06c61fc3bb2543069ed235e2df877f8a",model:"qwen-plus-latest",apiUrl:"https://dashscope.aliyuncs.com/compatible-mode/v1",temperature:.7,maxTokens:4e3},{id:"qwen3-max",name:"Qwen3 Max",description:"Alibaba Cloud Qwen3 Max model via DashScope",apiKey:"sk-06c61fc3bb2543069ed235e2df877f8a",model:"qwen3-max",apiUrl:"https://dashscope.aliyuncs.com/compatible-mode/v1",temperature:.7,maxTokens:4e3,isDefault:!0},{id:"cloudflare-worker-openrouter-google-gemini-2.5-pro",name:"Gemini 2.5 Pro",description:"Google Gemini 2.5 Pro via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/google/gemini-2.5-pro",apiUrl:vt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-gemini-2.5-flash",name:"Gemini 2.5 Flash",description:"Google Gemini 2.5 Flash via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/google/gemini-2.5-flash",apiUrl:vt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-grok-4-fast",name:"Grok 4 Fast",description:"Grok 4 Fast via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/x-ai/grok-4-fast:free",apiUrl:vt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-grok-code-fast-1",name:"Grok Code Fast 1",description:"Grok Code Fast 1 via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/x-ai/grok-code-fast-1",apiUrl:vt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-openai-gpt-5-codex",name:"GPT 5 Codex",description:"GPT 5 Codex via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/openai/gpt-5-codex",apiUrl:vt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-openai-gpt-5-chat",name:"GPT 5 Chat",description:"GPT 5 Chat via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/openai/gpt-5-chat",apiUrl:vt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-claude-sonnet-4.5",name:"Claude Sonnet 4.5",description:"Claude Sonnet 4.5 via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/anthropic/claude-sonnet-4.5",apiUrl:vt,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-glm-4.6",name:"GLM 4.6",description:"GLM 4.5 via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/z-ai/glm-4.6",apiUrl:vt,temperature:.7,maxTokens:4e3,isDefault:!1}],Na=()=>qt.find(s=>s.isDefault)||qt[0],Va=s=>qt.find(t=>t.id===s);function Lt({...s}){return e.jsx(nc,{"data-slot":"dropdown-menu",...s})}function Rt({...s}){return e.jsx(ac,{"data-slot":"dropdown-menu-trigger",...s})}function Dt({className:s,sideOffset:t=4,...n}){return e.jsx(rc,{children:e.jsx(oc,{"data-slot":"dropdown-menu-content",sideOffset:t,className:M("bg-popover/95 backdrop-blur-xl text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-xl shadow-[0_0_0_1px_rgba(0,0,0,0.05),0_10px_15px_-3px_rgba(0,0,0,0.1),0_4px_6px_-2px_rgba(0,0,0,0.05)] dark:shadow-[0_0_0_1px_rgba(255,255,255,0.1),0_10px_15px_-3px_rgba(0,0,0,0.3),0_4px_6px_-2px_rgba(0,0,0,0.1)]","data-[state=open]:duration-50 data-[state=closed]:duration-50",s),...n})})}function zm({...s}){return e.jsx(dc,{"data-slot":"dropdown-menu-group",...s})}function rt({className:s,inset:t,variant:n="default",...a}){return e.jsx(cc,{"data-slot":"dropdown-menu-item","data-inset":t,"data-variant":n,className:M("focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",s),...a})}function zi({className:s,inset:t,...n}){return e.jsx(ic,{"data-slot":"dropdown-menu-label","data-inset":t,className:M("px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",s),...n})}function qa({className:s,...t}){return e.jsx(lc,{"data-slot":"dropdown-menu-separator",className:M("bg-border -mx-1 my-1 h-px",s),...t})}const Fm=s=>s.includes("qwen")?"default":s.includes("gemini")?"secondary":s.includes("grok")?"outline":s.includes("claude")?"secondary":s.includes("glm")?"outline":"default";function Bm({selectedModelId:s,onModelChange:t,className:n=""}){const[a,r]=h.useState(!1),o=s?Va(s):qt[0],i=l=>{t?.(l.id),r(!1)};return e.jsx("div",{className:`flex items-center ${n}`,children:e.jsxs(Lt,{open:a,onOpenChange:r,children:[e.jsx(Rt,{asChild:!0,children:e.jsxs(k,{variant:"ghost",size:"sm",className:"h-8 px-3 gap-2 bg-transparent hover:bg-accent/50 text-muted-foreground hover:text-foreground",children:[e.jsx("span",{className:"text-sm font-medium",children:o?.name||"Select Model"}),e.jsx(ze,{className:"w-3 h-3 opacity-50"})]})}),e.jsxs(Dt,{align:"start",className:"w-64 p-1",side:"top",children:[e.jsx(zi,{className:"text-xs text-muted-foreground px-2 py-1.5",children:"Choose AI Model"}),e.jsx(qa,{}),qt.map(l=>e.jsxs(rt,{onClick:()=>i(l),className:"flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-accent/50 rounded-md",children:[e.jsx("span",{className:"text-sm font-medium text-foreground",children:l.name}),e.jsxs("div",{className:"flex items-center gap-1",children:[l.isDefault&&e.jsx(De,{variant:"secondary",className:"text-xs px-1.5 py-0.5",children:"Default"}),s===l.id&&e.jsx(De,{variant:Fm(l.id),className:"text-xs px-1.5 py-0.5",children:"Selected"})]})]},l.id))]})]})})}const Hm=s=>{const{messages:t,assistantMessageId:n}=s,a=t.filter(i=>i.role==="assistant"&&!!i.toolCalls).map(i=>i.toolCalls).flat(),r=t.filter(i=>i.role==="assistant").map(i=>i.content).join(`
`),o=t.filter(i=>i.role==="tool");return[{id:n,role:"assistant",content:r,toolCalls:a.length>0?a:void 0},...o]},Gm=(s,t,n)=>{const{id:a,role:r}=s,o=[],i=`${a}-${n}`;if(t.type==="text")o.push({id:i,role:r,content:t.text});else if(t.type==="tool-invocation"){const l={id:`${i}-tool-call`,role:"assistant",content:"",toolCalls:[{id:t.toolInvocation.toolCallId,type:"function",function:{name:t.toolInvocation.toolName,arguments:t.toolInvocation.args}}]};if([Ue.CALL,Ue.PARTIAL_CALL].includes(t.toolInvocation.status))o.push(l);else{const c={id:`${i}-tool-result`,role:"tool",toolCallId:t.toolInvocation.toolCallId,content:JSON.stringify({result:t.toolInvocation.result,error:t.toolInvocation.error,cancelled:t.toolInvocation.status===Ue.CANCELLED})};o.push(l,c)}}return r==="assistant"?Hm({messages:o,assistantMessageId:a}):o},Vm=s=>s.filter(t=>t.role!=="data").map(t=>t.parts.map((n,a)=>Gm(t,n,a)).flat()).flat();class qm{constructor(){}encode(t){return this.encodeSSE(t)}encodeSSE(t){return`data: ${JSON.stringify(t)}

`}}class Fi{constructor(t){this.encoder=t}async*handle(t,n){if(!n.isMessageStarted){const r={type:Ke.TEXT_START,messageId:n.messageId};yield this.encoder.encode(r),n.isMessageStarted=!0}const a=t.choices[0].delta.content;if(a){n.fullResponse+=a;const r={type:Ke.TEXT_DELTA,messageId:n.messageId,delta:a};yield this.encoder.encode(r)}}async*finalize(t){if(t.isMessageStarted){const n={type:Ke.TEXT_END,messageId:t.messageId};yield this.encoder.encode(n)}}}class Wm{constructor(t){this.encoder=t}async*handle(t,n){const a=t.choices[0].delta.tool_calls?.[0];if(a){if(!n.isToolCallStarted){n.toolCallId=a.id??"",n.toolCallName=a.function?.name??"",n.isToolCallStarted=!0;const r={type:Ke.TOOL_CALL_START,toolCallId:n.toolCallId,toolName:n.toolCallName};yield this.encoder.encode(r)}if(a.function?.arguments){n.toolCallArgs+=a.function.arguments;const r={type:Ke.TOOL_CALL_ARGS_DELTA,toolCallId:n.toolCallId,argsDelta:a.function.arguments};yield this.encoder.encode(r)}}}async*finalize(t){if(t.isToolCallStarted){const n={type:Ke.TOOL_CALL_END,toolCallId:t.toolCallId};yield this.encoder.encode(n)}}}class Km{constructor(t){this.encoder=t,this.context={messageId:It(),toolCallId:"",isMessageStarted:!1,isToolCallStarted:!1,fullResponse:"",toolCallArgs:"",toolCallName:"",getSnapshot:()=>({last_response:this.context.fullResponse,last_tool_call:this.context.isToolCallStarted?{name:this.context.toolCallName,arguments:this.context.toolCallArgs}:null,usage:{prompt_tokens:0,completion_tokens:0,total_tokens:0}})}}handlers=new Map;context;addHandler(t,n){this.handlers.set(t,n)}async*process(t){try{for await(const n of t){const a=this.getChunkType(n),r=this.handlers.get(a);r&&(yield*r.handle(n,this.context))}for(const n of this.handlers.values())yield*n.finalize(this.context)}catch(n){yield*this.handleError(n)}}getChunkType(t){return t.choices[0].delta.tool_calls?"tool":t.choices[0].delta.content?"text":"unknown"}async*handleError(t){const n=new Fi(this.encoder);yield*n.handle({id:"",created:0,model:"",object:"chat.completion.chunk",choices:[{delta:{content:`Error: ${t.message}`},finish_reason:"stop",index:0}],usage:{prompt_tokens:0,completion_tokens:0,total_tokens:0}},this.context),yield*n.finalize(this.context);const a={type:Ke.RUN_ERROR,error:t.message};yield this.encoder.encode(a)}}class Jr{constructor(t){this.config=t,this.client=new Ko({apiKey:t.apiKey,baseURL:t.baseURL,dangerouslyAllowBrowser:!0})}client;currentStream=null;convertToolsToOpenAIFormat(t){return t.map(n=>({type:"function",function:{name:n.name,description:n.description,parameters:n.parameters}}))}convertMessagesToOpenAIFormat(t){return Vm(t).map(a=>a.role==="tool"&&"toolCallId"in a?{role:a.role,content:a.content,tool_call_id:a.toolCallId}:a.role==="developer"||a.role==="system"||a.role==="user"?{role:a.role,content:a.content,id:a.id}:{role:a.role,content:a.content,id:a.id,tool_calls:"toolCalls"in a?a.toolCalls?.map(r=>({id:r.id,type:"function",function:{name:r.function.name,arguments:r.function.arguments}})):void 0})}addContextToMessages(t,n){return[{role:"system",content:n.map(r=>`${r.description}: ${r.value}`).join(`
`)},...t]}async*run(t,n){const a=new qm,r={type:Ke.RUN_STARTED,threadId:t.threadId};yield a.encode(r);try{let i=t.messages?this.convertMessagesToOpenAIFormat(t.messages):[];t.context&&(i=this.addContextToMessages(i,t.context));const l=t.tools?this.convertToolsToOpenAIFormat(t.tools):[],c=await this.client.chat.completions.create({model:this.config.model,messages:i,stream:!0,tools:l.length>0?l:void 0});this.currentStream=c;const d=new Km(a);d.addHandler("text",new Fi(a)),d.addHandler("tool",new Wm(a)),yield*d.process(c)}catch(i){yield*this.handleError(i,a)}const o={type:Ke.RUN_FINISHED,threadId:t.threadId};yield a.encode(o)}abort(){this.currentStream&&this.currentStream.controller.abort()}async*handleError(t,n){const a={type:Ke.RUN_ERROR,error:t.message};console.error("[OpenAIAgent][handleError]:",t),yield n.encode(a)}}function Ym(){return s=>s.pipe(Bo(t=>new ca(n=>{const a=t.split(/\r?\n/);for(const r of a){if(!r.startsWith("data:"))continue;const o=r.slice(5).trim();if(!(!o||o==="[DONE]"))try{const i=JSON.parse(o);n.next(i)}catch{}}n.complete()})))}const Qr=5e4;class nn{openaiAgent;currentConfig;contextCharLimit;constructor(t){this.currentConfig={apiKey:t?.apiKey||"sk-06c61fc3bb2543069ed235e2df877f8a",model:t?.model||"qwen-plus-latest",temperature:t?.temperature||.7,maxTokens:t?.maxTokens||1e3,baseURL:t?.baseURL||"https://dashscope.aliyuncs.com/compatible-mode/v1"};const n=Qr;if(this.contextCharLimit=Number.isFinite(n)&&n>0?n:Qr,!this.currentConfig.apiKey)throw new Error("API key is required. Please set the appropriate API key environment variable.");this.openaiAgent=new Jr(this.currentConfig)}abortRun(){this.openaiAgent.abort()}run(t){const n=this.trimInputByCharLimit(t,this.contextCharLimit),a=r=>new ca(o=>{(async()=>{try{for await(const i of r)o.next(i);o.complete()}catch(i){o.error(i)}})()});return new ca(r=>((async()=>{try{const l=this.openaiAgent.run(n,"application/json");a(l).pipe(Ym(),Ln(c=>!!c&&!!c.type),Fd(c=>(console.error("ðŸ”” [ExperimentalInBrowserAgent][run] error:",c),r.next({type:Ke.RUN_ERROR}),r.error(c),[]))).subscribe({next:c=>{r.next(c)},error:c=>r.error(c),complete:()=>{r.complete()}})}catch(i){console.error("ðŸ”” [ExperimentalInBrowserAgent][run] error:",i),r.next({type:Ke.RUN_ERROR}),r.error(i)}})(),()=>{}))}setConfig(t){this.currentConfig={...this.currentConfig,...t};const n=t?.contextCharLimit;if(typeof n=="number"&&Number.isFinite(n)&&n>0&&(this.contextCharLimit=n),!this.currentConfig.apiKey)throw new Error("API key is required. Please set the appropriate API key environment variable.");this.openaiAgent=new Jr(this.currentConfig)}getConfig(){return{...this.currentConfig,hasApiKey:!!this.currentConfig.apiKey,contextCharLimit:this.contextCharLimit}}trimInputByCharLimit(t,n){try{const a=t.messages||[],r=g=>g.type==="text"&&typeof g.text=="string",o=g=>g.type==="tool-invocation"&&!!g.toolInvocation,i=g=>{if(r(g))return g.text.length;if(o(g)){const x=g.toolInvocation;let y=0;return y+=x.toolName?x.toolName.length:0,typeof x.args=="string"&&(y+=x.args.length),x.toolCallId&&(y+=x.toolCallId.length),x.result!==void 0&&(y+=typeof x.result=="string"?x.result.length:JSON.stringify(x.result).length),x.error!==void 0&&(y+=typeof x.error=="string"?x.error.length:JSON.stringify(x.error).length),y}try{return JSON.stringify(g).length}catch{return 0}},l=g=>(g.parts||[]).reduce((x,y)=>x+i(y),0),c=a.filter(g=>g.role==="user"||g.role==="assistant"),d=c.reduce((g,x)=>g+l(x),0);if(d<=n)return t;const u=[...c],m=new Set;let p=d;for(;p>n&&u.length>0;){const g=u.shift();m.add(g.id),p-=l(g)}const f=a.filter(g=>!m.has(g.id));return{...t,messages:f}}catch(a){return console.warn("trimInputByCharLimit failed, fallback to original input:",a),t}}}function On(s){try{if(s.parsedArgs)return s.parsedArgs;const t=s.args;return typeof t=="string"?JSON.parse(t):t&&typeof t=="object"?t:null}catch{return null}}const Xm={default:"bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800",success:"bg-green-50 dark:bg-green-950 border-green-200 dark:border-green-900",warning:"bg-yellow-50 dark:bg-yellow-950 border-yellow-200 dark:border-yellow-900",error:"bg-red-50 dark:bg-red-950 border-red-200 dark:border-red-900"},Jm={default:"text-gray-700 dark:text-gray-300",success:"text-gray-700 dark:text-gray-200",warning:"text-gray-700 dark:text-gray-200",error:"text-gray-600 dark:text-gray-300"};function Ca({content:s,variant:t="default",maxHeight:n,showScrollbar:a=!0,className:r,placeholder:o="Loading content..."}){const i=s||o;return e.jsx("div",{className:M("rounded-md border p-3",Xm[t],a&&"overflow-y-auto",r),style:n?{maxHeight:n}:void 0,children:e.jsx("p",{className:M("text-sm whitespace-pre-wrap",Jm[t]),children:i})})}const Qm=Ia("relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",{variants:{variant:{default:"bg-card text-card-foreground",destructive:"text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90"}},defaultVariants:{variant:"default"}});function Nn({className:s,variant:t,...n}){return e.jsx("div",{"data-slot":"alert",role:"alert",className:M(Qm({variant:t}),s),...n})}function Cn({className:s,...t}){return e.jsx("div",{"data-slot":"alert-description",className:M("text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",s),...t})}function kn({error:s,fallbackMessage:t="An error occurred",variant:n="text",className:a}){const r=typeof s=="string"?s:s instanceof Error?s.message:t;return n==="alert"?e.jsx(Nn,{variant:"destructive",className:a,children:e.jsx(Cn,{children:r})}):e.jsx("div",{className:M("text-red-700 dark:text-red-300 text-sm",a),children:r})}function Bi({icon:s,message:t,className:n}){return e.jsxs("div",{className:M("flex items-center gap-2 text-gray-500 dark:text-gray-400",n),children:[e.jsx(s,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t})]})}const Zm={sm:"gap-2",md:"gap-4",lg:"gap-6"},eg={default:"text-gray-500 dark:text-gray-400",mono:"font-mono text-gray-500 dark:text-gray-400",highlight:"text-gray-700 dark:text-gray-300 font-medium"};function tg({items:s,className:t,gap:n="md"}){return s.length===0?null:e.jsx("div",{className:M("flex items-center",Zm[n],t),children:s.map((a,r)=>e.jsx("div",{className:"flex items-center gap-1",children:a.variant==="mono"?e.jsx(De,{variant:"outline",className:"text-xs font-mono",children:a.value}):e.jsx("span",{className:M("text-xs",eg[a.variant||"default"]),children:a.value})},r))})}function Zr({original:s,updated:t,showLabels:n=!0,className:a}){return e.jsxs("div",{className:M("space-y-3",a),children:[n&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:s.label||"Original"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"â†’"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:t.label||"Updated"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ca,{content:s.content,variant:"default",className:"max-h-48",showScrollbar:!0,placeholder:s.placeholder||"Loading original content..."}),e.jsx(Ca,{content:t.content,variant:"success",className:"max-h-48",showScrollbar:!0,placeholder:t.placeholder||"Loading updated content..."})]})]})}function sg({icon:s,title:t,status:n,statusText:a,hasDetails:r=!1,isExpanded:o=!1,onToggleExpanded:i}){const c={loading:{icon:e.jsx(ot,{className:"h-4 w-4 animate-spin text-blue-600"}),color:"text-blue-600"},success:{icon:e.jsx(ht,{className:"h-4 w-4 text-green-600"}),color:"text-green-600"},error:{icon:e.jsx(Ss,{className:"h-4 w-4 text-red-600"}),color:"text-red-600"},ready:{icon:e.jsx(Tn,{className:"h-4 w-4 text-gray-500"}),color:"text-gray-500"}}[n];return e.jsxs("div",{className:"px-2 flex gap-2 items-center overflow-hidden",children:[e.jsx("div",{className:"flex items-center gap-2 flex-shrink-0",children:s}),e.jsx("div",{className:"overflow-y-auto flex-shrink-0",children:t}),e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:c.icon}),e.jsx("span",{className:`text-sm font-medium truncate overflow-hidden ${c.color}`,children:a})]}),e.jsx("div",{className:"flex-1 w-[9999px]"}),r&&e.jsx(k,{variant:"ghost",size:"sm",onClick:i,className:"h-8 w-8 p-0 hover:bg-gray-100 flex-shrink-0","aria-label":o?"Collapse details":"Expand details",children:o?e.jsx(ze,{className:"h-4 w-4"}):e.jsx(Ta,{className:"h-4 w-4"})})]})}function ng({children:s,maxHeight:t="400px",isExpanded:n=!1,scrollable:a=!0}){return n?e.jsx("div",{className:"p-4 w-full",children:e.jsx("div",{className:a?"overflow-y-auto w-full":"w-full",style:a?{maxHeight:t}:void 0,children:s})}):null}function ag({children:s,header:t,content:n,headerCardClassName:a="border-gray-200 dark:border-gray-800",contentCardClassName:r="border-gray-200 dark:border-gray-800 mt-2"}){return e.jsxs("div",{className:"w-full flex flex-col","data-echo-tool":!0,children:[e.jsx("div",{className:"flex w-full overflow-hidden",children:e.jsx(St,{className:M(a,"overflow-hidden py-2 px-2"),children:e.jsx(sg,{...t})})}),n&&n.isExpanded&&e.jsx("div",{className:"w-full",children:e.jsx(St,{className:r,children:e.jsx(ng,{...n})})}),s&&e.jsx("div",{className:"w-full mt-2",children:s})]})}function at({icon:s,title:t,status:n,statusText:a,children:r,maxHeight:o="400px",defaultExpanded:i,expandable:l,forceExpanded:c,contentScrollable:d,headerCardClassName:u,contentCardClassName:m}){const p=!!r,f=l!==!1&&p&&!c,[g,x]=h.useState(i??!1),y=c?!0:g,v=h.useMemo(()=>({icon:s,title:t,status:n,statusText:a,hasDetails:f,isExpanded:y,onToggleExpanded:f?()=>x(b=>!b):void 0}),[s,t,n,a,f,y]),w=p?{children:r,maxHeight:o,isExpanded:y,scrollable:d!==!1}:void 0;return e.jsx("div",{className:"w-full","data-echo-tool":!0,children:e.jsx(ag,{header:v,content:w,headerCardClassName:u,contentCardClassName:m})})}function Hi(s){try{if(s.parsedArgs)return s.parsedArgs;const t=s.args;return typeof t=="string"?JSON.parse(t):t&&typeof t=="object"?t:null}catch{return null}}function Wa({invocation:s,icon:t,title:n,loadingText:a="Loading...",loadingIcon:r,successIcon:o,errorIcon:i,readyIcon:l,successStatusText:c,errorStatusText:d,readyStatusText:u="Ready",contentScrollable:m=!0,headerCardClassName:p,contentCardClassName:f,children:g}){const x=Hi(s)||{};if(s.status===Ue.PARTIAL_CALL)return e.jsx(at,{icon:r||t,title:n,status:"loading",statusText:a,contentScrollable:m,headerCardClassName:p||"border-blue-200 dark:border-blue-800",contentCardClassName:f||"border-gray-200 dark:border-gray-800 mt-2",children:g(x)});if(s.status===Ue.CALL)return e.jsx(at,{icon:r||t,title:n,status:"loading",statusText:a,contentScrollable:m,headerCardClassName:p||"border-blue-200 dark:border-blue-800",contentCardClassName:f||"border-gray-200 dark:border-gray-800 mt-2",children:g(x)});if(s.status===Ue.RESULT){const y=s.result;return e.jsx(at,{icon:o||t,title:n,status:"success",statusText:c?c(y):"Success",contentScrollable:m,headerCardClassName:p||"border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950",contentCardClassName:f||"border-gray-200 dark:border-gray-800 mt-2",children:g(x,y)})}if(s.status===Ue.ERROR){const y=s.error;return e.jsx(at,{icon:i||t,title:n,status:"error",statusText:d?d(y):"Error occurred",contentScrollable:m,headerCardClassName:p||"border-red-200 dark:border-red-800",contentCardClassName:f||"border-red-200 dark:border-red-800 mt-2",children:g(x,void 0,y)})}return e.jsx(at,{icon:l||t,title:n,status:"ready",statusText:u,contentScrollable:m,headerCardClassName:p||"border-gray-200 dark:border-gray-800",contentCardClassName:f||"border-gray-200 dark:border-gray-800 mt-2",children:g(x)})}function eo({confirmLabel:s,cancelLabel:t="Cancel",onConfirm:n,onCancel:a,isLoading:r,confirmIcon:o,loadingLabel:i,variant:l="default"}){return e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(k,{onClick:n,disabled:r,className:"flex-1",variant:l,children:r?e.jsxs(e.Fragment,{children:[e.jsx(ot,{className:"h-4 w-4 mr-2 animate-spin"}),i||`${s}...`]}):e.jsxs(e.Fragment,{children:[o,o?e.jsx("span",{className:"ml-2",children:s}):s]})}),e.jsx(k,{variant:"outline",onClick:a,disabled:r,children:t})]})}function rg({invocation:s,onResult:t,confirm:n}){const[a,r]=h.useState(!1),[o,i]=h.useState(null);return{isLoading:a,error:o,handleConfirm:async()=>{r(!0),i(null);try{const d=await n();t({toolCallId:s.toolCallId,result:d,status:Ue.RESULT})}catch(d){const u=d instanceof Error?d.message:"Operation failed";i(u),r(!1)}},handleCancel:()=>{t({toolCallId:s.toolCallId,status:Ue.CANCELLED,cancelled:!0})}}}function Ka(s){const{invocation:t,onResult:n,icon:a,title:r,loadingText:o="Loading...",callStatusText:i,preview:l,confirm:c,confirmLabel:d,confirmIcon:u,confirmVariant:m,resultStatusText:p,resultContent:f,cancelStatusText:g,contentScrollable:x,stickyFooter:y=!0}=s,v=Hi(t)||{},{isLoading:w,error:b,handleConfirm:N,handleCancel:j}=rg({invocation:t,onResult:n,confirm:c});if(t.status===Ue.PARTIAL_CALL)return e.jsx(at,{icon:a,title:r,status:"loading",statusText:o,contentScrollable:x,headerCardClassName:"border-blue-200 dark:border-blue-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:l(v)});if(t.status===Ue.CALL)return e.jsx(at,{icon:a,title:r,status:"ready",statusText:i,forceExpanded:!0,contentScrollable:x,headerCardClassName:"border-amber-200 dark:border-amber-800",children:y?e.jsxs("div",{className:"relative w-full",children:[e.jsxs("div",{className:"space-y-4 w-full pb-16",children:[l(v),b&&e.jsx(Nn,{variant:"destructive",children:e.jsx(Cn,{children:b})})]}),e.jsx("div",{className:"sticky bottom-0 w-full bg-background border-t dark:border-gray-800 pt-3 pb-3",children:e.jsx(eo,{confirmLabel:d,loadingLabel:`${d}...`,onConfirm:N,onCancel:j,isLoading:w,confirmIcon:u,variant:m})})]}):e.jsxs("div",{className:"space-y-4 w-full",children:[l(v),b&&e.jsx(Nn,{variant:"destructive",children:e.jsx(Cn,{children:b})}),e.jsx(eo,{confirmLabel:d,loadingLabel:`${d}...`,onConfirm:N,onCancel:j,isLoading:w,confirmIcon:u,variant:m})]})});if(t.status===Ue.RESULT){const C=t.result;return e.jsx(at,{icon:a,title:r,status:"success",statusText:p(C),contentScrollable:x,headerCardClassName:"border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:f(v,C)})}return t.status===Ue.CANCELLED?e.jsx(at,{icon:a,title:r,status:"ready",statusText:g||"Cancelled",contentScrollable:x,headerCardClassName:"border-gray-200 dark:border-gray-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:l(v)}):e.jsx(at,{icon:a,title:r,status:"ready",statusText:"",headerCardClassName:"border-gray-200 dark:border-gray-800"})}function Bs({content:s,showMetadata:t=!1,metadata:n,variant:a="preview",maxHeight:r,className:o,placeholder:i}){const l=[];t&&n&&(n.noteId&&l.push({label:"ID",value:n.noteId,variant:"mono"}),n.timestamp&&l.push({label:"Time",value:n.timestamp,variant:"default"}),n.contentLength&&l.push({label:"Length",value:`${n.contentLength} chars`,variant:"default"}));const c=a==="detail"?"success":a==="error"?"error":"default",d=a==="comparison";return e.jsxs("div",{className:o,children:[t&&l.length>0&&e.jsx(tg,{items:l,className:"mb-3"}),e.jsx(Ca,{content:s,variant:c,className:d?"max-h-48":void 0,maxHeight:d?void 0:r,showScrollbar:a==="comparison",placeholder:i})]})}function og({noteId:s,content:t,contentLength:n,timestampReadable:a,showIdPrefix:r=!0,idPrefixLength:o=8,showCharCount:i=!0,charCountThreshold:l=60,className:c}){return e.jsxs("div",{className:M("p-3 bg-gray-50 dark:bg-gray-900 rounded-md border dark:border-gray-800",c),children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(An,{className:"w-3 h-3 text-gray-400 dark:text-gray-500"}),r&&e.jsxs(De,{variant:"outline",className:"text-xs font-mono",children:[s.substring(0,o),"..."]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx(Tn,{className:"w-3 h-3"}),e.jsx("span",{children:a})]})]}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap",children:t}),i&&n>l&&e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:["(",n," characters total)"]})]})}function ig(s,t){const[n,a]=Mt.useState("");return Mt.useEffect(()=>{if(!(!s||!t))try{const o=V.dataContainer.get().messageByChannel[t]?.messages.find(i=>i.id===s);o&&a(o.content)}catch(r){console.error("Failed to fetch note content:",r)}},[s,t]),n}function lg({invocation:s,onResult:t}){const n=On(s),a=n?.noteId||"",r=n?.content||"",o=n?.channelId||"",i=ig(a,o);return e.jsx(Ka,{invocation:s,onResult:t,icon:e.jsx(Aa,{className:"h-5 w-5 text-amber-600 dark:text-amber-400"}),title:"Update Note",loadingText:"Preparing parameters...",callStatusText:"Ready to update",contentScrollable:!1,stickyFooter:!1,preview:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(De,{variant:"outline",className:"font-mono text-xs",children:a||"Loading..."})}),e.jsx(Zr,{original:{content:i||"",label:"Original",placeholder:"Loading original content..."},updated:{content:r,label:"Updated",placeholder:"Loading updated content..."},showLabels:!0})]}),confirm:async()=>(await V.updateMessage({messageId:a,channelId:o,updates:{content:r},userId:O.getState().userId}),{status:"updated",message:"Note updated successfully"}),confirmLabel:"Update Note",confirmIcon:e.jsx(ht,{className:"h-4 w-4"}),resultStatusText:()=>"Note Updated Successfully!",resultContent:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(De,{variant:"outline",className:"font-mono text-xs",children:a})}),e.jsx(Zr,{original:{content:i||"",label:"Original",placeholder:"Original content"},updated:{content:r,label:"Updated",placeholder:"Updated content"},showLabels:!0})]}),cancelStatusText:"Update Cancelled"})}function cg({invocation:s,onResult:t}){const[n,a]=h.useState(""),r=On(s),o=r?.noteId||"",i=r?.channelId||"";return Mt.useEffect(()=>{try{const c=V.dataContainer.get().messageByChannel[i]?.messages.find(d=>d.id===o);c&&a(c.content)}catch(l){console.error("Failed to fetch note content:",l)}},[o,i]),e.jsx(Ka,{invocation:s,onResult:t,icon:e.jsx(it,{className:"h-5 w-5 text-amber-600 dark:text-amber-400"}),title:"Delete Note",loadingText:"Preparing parameters...",callStatusText:"Ready to delete",preview:()=>e.jsxs("div",{className:"space-y-4 w-full",children:[e.jsx(Nn,{variant:"destructive",children:e.jsxs(Cn,{children:[e.jsx("strong",{children:"Warning:"})," This action will permanently delete the note. This cannot be undone."]})}),e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(De,{variant:"outline",className:"font-mono text-xs",children:o||"Loading..."})}),e.jsx(Bs,{content:n,variant:"preview",showMetadata:!1,maxHeight:"max-h-32",placeholder:"Loading note content..."})]}),confirm:async()=>(await V.deleteMessage({messageId:o,channelId:W.getState().currentChannelId}),{status:"deleted",message:"Note deleted successfully"}),confirmLabel:"Delete Note",confirmIcon:e.jsx(it,{className:"h-4 w-4"}),confirmVariant:"destructive",resultStatusText:()=>"Note Deleted Successfully!",resultContent:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(De,{variant:"outline",className:"font-mono text-xs",children:o})}),e.jsx(Bs,{content:n,variant:"error",showMetadata:!1,placeholder:"Deleted note content"})]})})}function dg({invocation:s}){const n=On(s)?.noteId;return e.jsx(Wa,{invocation:s,icon:e.jsx(Xe,{className:"h-5 w-5 text-blue-600"}),title:"Read Note",loadingText:`Reading note ${n?.substring(0,8)||"unknown"}...`,successIcon:e.jsx(Xe,{className:"h-5 w-5 text-green-600"}),errorIcon:e.jsx(Co,{className:"w-5 h-5 text-red-600"}),successStatusText:()=>"Note loaded successfully",errorStatusText:a=>a&&typeof a=="object"&&"found"in a&&!a.found?"Note not found":"Failed to load note",readyStatusText:"Preparing to read note...",contentScrollable:!0,headerCardClassName:"border-blue-200 dark:border-blue-900",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:(a,r,o)=>o?e.jsx(kn,{error:o,fallbackMessage:"An error occurred while loading the note"}):r?.found?e.jsx(Bs,{content:r.content,variant:"detail",showMetadata:!0,metadata:{noteId:r.noteId,timestamp:r.timestampReadable,contentLength:r.contentLength}}):e.jsx(kn,{error:"Note not found",fallbackMessage:"Note not found"})})}function ug({invocation:s}){const n=(s.parsedArgs||{}).limit||10;return e.jsx(Wa,{invocation:s,icon:e.jsx(ta,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),title:"List Notes",loadingText:"Loading notes from channel...",successStatusText:a=>`Found ${a?.notes?.length||0} note${(a?.notes?.length||0)!==1?"s":""}`,errorStatusText:a=>"Failed to load notes",readyStatusText:"Preparing to list notes...",contentScrollable:!0,headerCardClassName:"border-blue-200 dark:border-blue-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:(a,r,o)=>o?e.jsx(kn,{error:o,fallbackMessage:"An error occurred while loading notes",variant:"alert"}):!r?.notes||!Array.isArray(r.notes)||r.notes.length===0?e.jsx(Bi,{icon:Xe,message:"No notes found in this channel"}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3",children:["Showing up to ",n," notes from the channel"]}),r.notes.map((i,l)=>e.jsx(og,{noteId:i.noteId,content:i.content,contentLength:i.contentLength,timestampReadable:i.timestampReadable},i.noteId||l))]})})}function hg({invocation:s}){const t=a=>{const r=a||{},o=["grep"];r.ignoreCase&&o.push("-i"),r.word&&o.push("-w"),r.fixedStrings&&o.push("-F"),r.onlyMatching&&o.push("-o"),r.countOnly&&o.push("-c"),r.listOnly&&o.push("-l"),r.context!==void 0&&o.push("-C",String(r.context)),r.before!==void 0&&o.push("-B",String(r.before)),r.after!==void 0&&o.push("-A",String(r.after)),r.maxMatches!==void 0&&o.push("--max-count",String(r.maxMatches));const i=r.pattern??"",l=`'${String(i).replace(/'/g,"'\\''")}'`;return r.isRegex,o.push("--",l),o.join(" ")},n=({args:a,scope:r,effectiveIncludeCount:o})=>{const i=t(a);return e.jsxs("div",{className:"rounded-md border p-3 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800 space-y-2",children:[e.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Command"}),e.jsx("pre",{className:"text-xs bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-2 py-1 rounded overflow-x-auto",children:i}),e.jsxs("div",{className:"text-xs text-gray-700 dark:text-gray-300",children:[e.jsxs("span",{className:"inline-block mr-2",children:["scope: ",e.jsx("code",{children:r||"global"})]}),typeof o=="number"&&e.jsxs("span",{className:"inline-block",children:["channels: ",e.jsx("code",{children:o})]})]}),e.jsx("div",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:"Scope is enforced by conversation/UI context and is not part of the grep command."})]})};return e.jsx(Wa,{invocation:s,icon:e.jsx(Fe,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),title:"Grep Notes",loadingText:"Searching notes...",successStatusText:a=>{const r=a?.summary;if(!r)return"Search finished";const o=r.timedOut?" (timed out)":"";return`Matches ${r.totalMatches} in ${r.matchedNotes}/${r.scannedNotes} notes â€¢ ${r.tookMs}ms${o}`},errorStatusText:()=>"Search failed",readyStatusText:"Ready to search",contentScrollable:!0,headerCardClassName:"border-blue-200 dark:border-blue-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:(a,r,o)=>{const i=e.jsx(n,{args:a,effectiveIncludeCount:r?.effectiveIncludeCount});return o?e.jsxs("div",{className:"space-y-3",children:[i,e.jsx(kn,{error:o,fallbackMessage:"An error occurred while searching",variant:"alert"})]}):r?r.noteIds&&r.noteIds.length>0&&(!r.matches||r.matches.length===0)?e.jsxs("div",{className:"space-y-3",children:[i,e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Matched notes:"}),e.jsx("div",{className:"rounded-md border p-3 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800",children:e.jsx("ul",{className:"list-disc pl-6 text-sm",children:r.noteIds.map(l=>e.jsx("li",{children:e.jsx("code",{children:l})},l))})})]}):!r.matches||r.matches.length===0?e.jsxs("div",{className:"space-y-3",children:[i,e.jsx(Bi,{icon:Fe,message:"No matches found"})]}):e.jsxs("div",{className:"space-y-4",children:[i,r.matches.map(l=>e.jsxs("div",{className:"rounded-md border p-3 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800 space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:["note: ",e.jsx("code",{children:l.noteId})," â€¢ channel: ",e.jsx("code",{children:l.channelId})," â€¢"," ",l.timestamp]}),e.jsx("div",{className:"font-mono text-sm",children:l.contexts.map((c,d)=>e.jsxs("div",{className:"mb-3",children:[c.before?.map((u,m)=>e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:u},`b-${m}`)),e.jsx("div",{className:"bg-yellow-100 dark:bg-yellow-900/40 px-1 rounded",children:c.match}),c.after?.map((u,m)=>e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:u},`a-${m}`))]},d))})]},l.noteId))]}):i}})}function mg({invocation:s,onResult:t}){const n=On(s),a=n?.content||"",r=n?.channelId||"";return e.jsx(Ka,{invocation:s,onResult:t,icon:e.jsx(Xe,{className:"h-5 w-5 text-amber-600 dark:text-amber-400"}),title:"Create Note",loadingText:"Preparing parameters...",callStatusText:"Ready to create",preview:()=>e.jsx(Bs,{content:a,variant:"preview",showMetadata:!1}),confirm:async()=>(await V.sendMessage({channelId:r,content:a,sender:"user"}),{status:"created",message:"Note created successfully"}),confirmLabel:"Create Note",confirmIcon:e.jsx(ht,{className:"h-4 w-4"}),resultStatusText:()=>"Note Created Successfully!",resultContent:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx(Bs,{content:a,variant:"detail",showMetadata:!1}),e.jsx("p",{className:"text-sm text-green-600 dark:text-green-400",children:"Your note has been saved to the channel."})]}),cancelStatusText:"Creation Cancelled"})}function gg(){return{name:"listNotes",description:"List notes/thoughts in the specified channel, optionally sorted by time",parameters:{type:"object",properties:{limit:{type:"number",description:"Maximum number of notes/thoughts to return (default: 10)"},order:{type:"string",enum:["asc","desc"],description:"Sort order by timestamp (default: desc)"},channelId:{type:"string",description:"ID of the channel to list notes from"}},required:["channelId"]},execute:async s=>{try{const{limit:t=10,order:n="desc",channelId:a}=s,{userId:r}=O.getState();if(!r)throw new Error("User not signed in");const{messages:o}=await oe.fetchInitialMessagesAllSenders(r,a,t);return{notes:(n==="asc"?[...o].sort((c,d)=>c.timestamp.getTime()-d.timestamp.getTime()):[...o].sort((c,d)=>d.timestamp.getTime()-c.timestamp.getTime())).map(c=>({content:c.content.substring(0,200)+(c.content.length>200?"...":""),contentLength:c.content.length,timestamp:c.timestamp,timestampReadable:Tt(c.timestamp),noteId:c.id}))}}catch(t){throw console.error("ðŸ”” [listNotesTool][execute][error]:",t),new Error(`Failed to list notes: ${t instanceof Error?t.message:"Unknown error"}`)}},render:s=>e.jsx(ug,{invocation:s})}}class Ps{notes$=new dt([]);channels$=new dt([]);updateStatus$=new dt({isUpdating:!1,lastUpdateTime:0});channelUpdateStatus$=new dt({});static STALE_MS=3600*1e3;constructor(){this.loadFromCache()}getNotes(t){return this.notes$.pipe(Ft(n=>this.filterNotes(n,t)))}getChannels(t){return this.channels$.pipe(Ft(n=>this.filterChannels(n,t)))}getNoteById(t){return this.notes$.pipe(Ft(n=>n.find(a=>a.id===t)||null))}getUpdateStatus(){return this.updateStatus$}getChannelUpdateStatus(t){return this.channelUpdateStatus$.pipe(Ft(n=>n[t]||null))}async updateAll(){this.setUpdateStatus({isUpdating:!0,lastUpdateTime:0});try{const n=(await xe.getCurrentUser())?.uid;if(!n)return;const a=this.getLastFullUpdateTime();if(a&&Date.now()-a<Ps.STALE_MS){(this.notes$.value.length===0||this.channels$.value.length===0)&&await this.loadFromCache(),this.setUpdateStatus({isUpdating:!1,lastUpdateTime:a});return}const o=await oe.fetchChannels(n);let i=[];this.notes$.value.length>0?i=[...this.notes$.value]:i=[...(await this.loadFromIndexedDB()).notes],console.debug("[NoteSearch][updateAll] start",{channels:o.length});for(const l of o){const c=this.getChannelLastUpdateTime(l.id),d=c&&Date.now()-c<Ps.STALE_MS,u=i.some(f=>f.channelId===l.id);if(d&&u)continue;let m=[];try{const f=await oe.fetchInitialMessagesAllSenders(n,l.id,1e3);console.debug("[NoteSearch][updateAll] channel fetched (all senders)",{channelId:l.id,count:f.messages.length}),m=f.messages}catch(f){console.warn("[NoteSearch][updateAll] all-senders fetch failed, fallback to user-only",{channelId:l.id,err:f}),m=(await oe.fetchInitialMessages(n,l.id,1e3)).messages}const p=m.map(f=>{const g=f;return{id:g.id,channelId:g.channelId,content:g.content,tags:g.tags||[],aiAnalysis:g.aiAnalysis,timestamp:g.timestamp,sender:g.sender,isDeleted:g.isDeleted||!1}});i=i.filter(f=>f.channelId!==l.id).concat(p),this.notes$.next([...i]),this.setChannelLastUpdateTime(l.id,Date.now())}this.notes$.next(i),this.channels$.next(o),await this.saveToCache(i,o),this.setLastFullUpdateTime(Date.now()),this.setUpdateStatus({isUpdating:!1,lastUpdateTime:Date.now()})}catch(t){console.warn("[NoteSearch][updateAll] failed",t),this.setUpdateStatus({isUpdating:!1,lastUpdateTime:Date.now(),error:t instanceof Error?t.message:"Unknown error"})}}async updateChannel(t){this.setChannelUpdateStatus(t,{isUpdating:!0,lastUpdateTime:0});try{const a=(await xe.getCurrentUser())?.uid;if(!a)return;const r=this.getChannelLastUpdateTime(t);if(r&&Date.now()-r<Ps.STALE_MS&&(this.notes$.value.length===0&&await this.loadFromCache(),this.notes$.value.some(m=>m.channelId===t))){this.setChannelUpdateStatus(t,{isUpdating:!1,lastUpdateTime:r});return}console.debug("[NoteSearch][updateChannel] start",{channelId:t});let i=[];try{const u=await oe.fetchInitialMessagesAllSenders(a,t,1e3);console.debug("[NoteSearch][updateChannel] fetched (all senders)",{channelId:t,count:u.messages.length}),i=u.messages}catch(u){console.warn("[NoteSearch][updateChannel] all-senders fetch failed, fallback to user-only",{channelId:t,err:u}),i=(await oe.fetchInitialMessages(a,t,1e3)).messages}const l=i.map(u=>{const m=u;return{id:m.id,channelId:m.channelId,content:m.content,tags:m.tags||[],aiAnalysis:m.aiAnalysis,timestamp:m.timestamp,sender:m.sender,isDeleted:m.isDeleted||!1}}),d=this.notes$.value.filter(u=>u.channelId!==t).concat(l);this.notes$.next(d),await this.saveNotesToCache(d),this.setChannelLastUpdateTime(t,Date.now()),this.setChannelUpdateStatus(t,{isUpdating:!1,lastUpdateTime:Date.now()})}catch(n){console.warn("[NoteSearch][updateChannel] failed",n),this.setChannelUpdateStatus(t,{isUpdating:!1,lastUpdateTime:0})}}async forceUpdate(){await this.updateAll()}filterNotes(t,n){return n?t.filter(a=>{if(n.channelIds&&!n.channelIds.includes(a.channelId)||n.tags&&!n.tags.some(r=>a.tags.includes(r))||n.sender&&a.sender!==n.sender)return!1;if(n.dateRange){const r=new Date(a.timestamp).getTime();if(n.dateRange.start&&r<n.dateRange.start||n.dateRange.end&&r>n.dateRange.end)return!1}return!0}):t}filterChannels(t,n){return n?t.filter(a=>!(n.ids&&!n.ids.includes(a.id)||n.name&&!a.name.toLowerCase().includes(n.name.toLowerCase()))):t}setUpdateStatus(t){this.updateStatus$.next(t)}setChannelUpdateStatus(t,n){const a=this.channelUpdateStatus$.value;this.channelUpdateStatus$.next({...a,[t]:n})}async loadFromCache(){try{const t=await this.loadFromIndexedDB();t.notes.length>0&&this.notes$.next(t.notes),t.channels.length>0&&this.channels$.next(t.channels)}catch(t){console.warn("Failed to load from cache:",t)}}async saveToCache(t,n){try{await this.saveToIndexedDB({notes:t,channels:n})}catch(a){console.warn("Failed to save to cache:",a)}}async saveNotesToCache(t){try{const n=await this.loadFromIndexedDB();await this.saveToIndexedDB({...n,notes:t})}catch(n){console.warn("Failed to save notes to cache:",n)}}async loadFromIndexedDB(){return new Promise((t,n)=>{const a=indexedDB.open("echonote_data",1);a.onupgradeneeded=()=>{const r=a.result;r.objectStoreNames.contains("notes")||r.createObjectStore("notes",{keyPath:"id"}),r.objectStoreNames.contains("channels")||r.createObjectStore("channels",{keyPath:"id"})},a.onsuccess=()=>{const r=a.result,o=r.transaction(["notes","channels"],"readonly"),i=o.objectStore("notes"),l=o.objectStore("channels"),c=i.getAll(),d=l.getAll();Promise.all([new Promise((u,m)=>{c.onsuccess=()=>u(c.result),c.onerror=()=>m(c.error)}),new Promise((u,m)=>{d.onsuccess=()=>u(d.result),d.onerror=()=>m(d.error)})]).then(([u,m])=>{r.close(),t({notes:u,channels:m})}).catch(n)},a.onerror=()=>n(a.error)})}async saveToIndexedDB(t){return new Promise((n,a)=>{const r=indexedDB.open("echonote_data",1);r.onupgradeneeded=()=>{const o=r.result;o.objectStoreNames.contains("notes")||o.createObjectStore("notes",{keyPath:"id"}),o.objectStoreNames.contains("channels")||o.createObjectStore("channels",{keyPath:"id"})},r.onsuccess=()=>{const o=r.result,i=o.transaction(["notes","channels"],"readwrite"),l=i.objectStore("notes"),c=i.objectStore("channels");l.clear(),c.clear(),t.notes.forEach(d=>l.add(d)),t.channels.forEach(d=>c.add(d)),i.oncomplete=()=>{o.close(),n()},i.onerror=()=>a(i.error)},r.onerror=()=>a(r.error)})}getLastFullUpdateTime(){if(typeof window>"u")return null;const t=window.localStorage.getItem("echonote_search_last_full_update");return t?Number(t):null}setLastFullUpdateTime(t){typeof window>"u"||window.localStorage.setItem("echonote_search_last_full_update",String(t))}getChannelLastUpdateTime(t){if(typeof window>"u")return null;const n=window.localStorage.getItem(`echonote_search_channel_update_${t}`);return n?Number(n):null}setChannelLastUpdateTime(t,n){typeof window>"u"||window.localStorage.setItem(`echonote_search_channel_update_${t}`,String(n))}}const Ze=new Ps;function pg(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function fg(s){return/[|*+?^${}()[\]\\]/.test(s)}function xg(s){const t=s.pattern??"",n=s.ignoreCase?"i":"";if(!t)return{test:()=>({matched:!1})};if(s.fixedStrings){const i=s.ignoreCase?t.toLowerCase():t;return{test:l=>{const d=(s.ignoreCase?l.toLowerCase():l).indexOf(i);return{matched:d>=0,matchText:t,index:d>=0?d:void 0}}}}let r=s.isRegex??fg(t)?t:pg(t);s.word&&(r=`\\b${r}\\b`);let o;try{o=new RegExp(r,n)}catch{const i=s.ignoreCase?t.toLowerCase():t;return{test:l=>{const d=(s.ignoreCase?l.toLowerCase():l).indexOf(i);return{matched:d>=0,matchText:t,index:d>=0?d:void 0}}}}return{test:i=>{const l=o.exec(i);return{matched:!!l,matchText:l?.[0],index:l?.index}}}}async function bg(s){const t=Date.now(),n=Math.max(500,Math.min(s.timeoutMs??3e3,15e3)),a=Math.max(1,Math.min(s.maxMatches??200,5e3)),r=Math.max(1,Math.min(s.maxNotes??500,5e3)),o=s.context!==void 0?s.context:s.before??0,i=s.context!==void 0?s.context:s.after??0,l={};let c="global",d=null;if(s.includeChannels&&s.includeChannels.length>0)d=s.includeChannels,c="args";else{const v=Y.getState(),w=v.currentConversationId,b=v.conversations.find(j=>j.id===w),N=b?.contexts?.mode;if(N==="channels"&&b?.contexts?.channelIds&&b.contexts.channelIds.length>0)d=b.contexts.channelIds,c="contexts:channels";else if(N==="all")d=null,c="contexts:all";else{const{currentChannelId:j}=W.getState();j?(d=[j],c="currentChannel"):(d=null,c="global")}}if(d&&d.length>0&&(l.channelIds=d),s.tags&&s.tags.length>0&&(l.tags=s.tags),s.sender&&(l.sender=s.sender),s.dateRange){const v=s.dateRange.start??0,w=s.dateRange.end??Number.MAX_SAFE_INTEGER;l.dateRange={start:v,end:w}}let u=await Is(Ze.getNotes(l));if(u.length===0||s.includeChannels&&s.includeChannels.every(v=>!u.some(w=>w.channelId===v)))try{if(s.includeChannels&&s.includeChannels.length>0)for(const v of s.includeChannels)await Ze.updateChannel(v);else await Ze.updateAll();u=await Is(Ze.getNotes(l))}catch{}if(s.excludeChannels&&s.excludeChannels.length>0){const v=new Set(s.excludeChannels);u=u.filter(w=>!v.has(w.channelId))}let m=0,p=0,f=0;const g=[],x=xg(s);for(const v of u){if(Date.now()-t>n||m>=r)break;m++;const w=v.content||"";if(!w)continue;const b=w.split(/\r?\n/),N=[];let j=!1;for(let C=0;C<b.length;C++){const E=b[C],R=x.test(E);if(R.matched){j=!0,f++;const T=[],D=[];for(let U=Math.max(0,C-o);U<C;U++)T.push(b[U]);for(let U=C+1;U<=Math.min(b.length-1,C+i);U++)D.push(b[U]);const L=s.onlyMatching&&R.matchText?R.matchText:E;if(N.push({before:T,match:L,after:D,line:C+1,offset:R.index}),f>=a)break}if(Date.now()-t>n)break}if(j&&(p++,s.countOnly||g.push({noteId:v.id,channelId:v.channelId,timestamp:v.timestamp?.toLocaleString?.()||"",contexts:N})),f>=a)break}const y={summary:{scannedNotes:m,matchedNotes:p,totalMatches:f,tookMs:Date.now()-t,timedOut:Date.now()-t>n},scope:c,effectiveIncludeCount:d?d.length:void 0};return s.countOnly||(s.listOnly?y.noteIds=g.map(v=>v.noteId):y.matches=g),y}function vg(){return{name:"grepNotes",description:"Search notes with grep-like semantics (equivalent to 'grep -E' by default). Automatically detects and enables extended regex mode when pattern contains special characters (|, *, +, ?, etc). Supports regex alternation (e.g., 'äº§å“|æ—¶é—´çº¿'), case-insensitive, word boundary, context lines, and filtering by channel/tags/date. Use fixedStrings=true for literal string search (like 'grep -F').",parameters:{type:"object",properties:{pattern:{type:"string",description:"Search pattern. Extended regex mode is automatically enabled if pattern contains special characters like | (alternation), *, +, ?, etc. Matches 'grep -E' behavior."},isRegex:{type:"boolean",description:"Force regex mode on/off. By default, mode is auto-detected based on pattern content."},ignoreCase:{type:"boolean",description:"Case-insensitive search (like 'grep -i')"},word:{type:"boolean",description:"Match whole words only (like 'grep -w')"},fixedStrings:{type:"boolean",description:"Disable regex and search for literal string (like 'grep -F')"},before:{type:"number",description:"Print N lines of leading context before each match (like 'grep -B N')"},after:{type:"number",description:"Print N lines of trailing context after each match (like 'grep -A N')"},context:{type:"number",description:"Print N lines of surrounding context (like 'grep -C N')"},countOnly:{type:"boolean",description:"Only output count of matching lines (like 'grep -c')"},listOnly:{type:"boolean",description:"Only output filenames with matches (like 'grep -l')"},onlyMatching:{type:"boolean",description:"Only output the matching part (like 'grep -o')"},includeChannels:{type:"array",items:{type:"string"}},excludeChannels:{type:"array",items:{type:"string"}},tags:{type:"array",items:{type:"string"}},sender:{type:"string",enum:["user","ai"]},dateRange:{type:"object",properties:{start:{type:"number"},end:{type:"number"}}},maxMatches:{type:"number"},maxNotes:{type:"number"},snippetSize:{type:"number"},timeoutMs:{type:"number"}},required:["pattern"]},execute:async s=>await bg(s),render:s=>Mt.createElement(hg,{invocation:s})}}async function yg(s,t){const r=V.dataContainer.get().messageByChannel[s];if(r&&!r.loading)return;r||V.requestLoadInitialMessages$.next({channelId:s});const o=Date.now();await new Promise((i,l)=>{const c=()=>{const d=V.dataContainer.get().messageByChannel[s];if(d&&!d.loading)return i();if(Date.now()-o>1e4)return l(new Error(`Timeout waiting channel ${s} messages to load`));setTimeout(c,100)};c()})}class wg{getChannelTools(){return[this.createNoteTool(),this.readNoteTool(),this.updateNoteTool(),this.deleteNoteTool(),this.listNotesTool(),this.grepNotesTool()]}createNoteTool(){return{name:"createNote",description:"Create a new note/thought in the specified channel (requires user confirmation).",parameters:{type:"object",properties:{content:{type:"string",description:"Content of the note/thought"},channelId:{type:"string",description:"ID of the channel to create the note in"}},required:["content","channelId"]},render:(t,n)=>h.createElement(mg,{invocation:t,onResult:n})}}readNoteTool(){return{name:"readNote",description:"Read a specific note/thought by its ID from the specified channel",parameters:{type:"object",properties:{noteId:{type:"string",description:"ID of the note/thought to read"},channelId:{type:"string",description:"ID of the channel to read the note from"}},required:["noteId","channelId"]},execute:async t=>{const{noteId:n,channelId:a}=t;try{await yg(a);const o=V.dataContainer.get().messageByChannel[a]?.messages.find(i=>i.id===n);if(!o)throw new Error(`Note with ID ${n} not found`);return{found:!0,noteId:o.id,content:o.content,timestamp:o.timestamp,timestampReadable:o.timestamp.toLocaleString(),contentLength:o.content.length}}catch(r){throw console.error("ðŸ”” [readNoteTool][error]:",r),new Error(`Failed to read note: ${r instanceof Error?r.message:"Unknown error"}`)}},render:t=>h.createElement(dg,{invocation:t})}}updateNoteTool(){return{name:"updateNote",description:"Update an existing note/thought by its ID in the specified channel (requires user confirmation).",parameters:{type:"object",properties:{noteId:{type:"string",description:"ID of the note/thought to update"},content:{type:"string",description:"New content for the note/thought"},channelId:{type:"string",description:"ID of the channel containing the note"}},required:["noteId","content","channelId"]},render:(t,n)=>h.createElement(lg,{invocation:t,onResult:n})}}deleteNoteTool(){return{name:"deleteNote",description:"Delete a note/thought by its ID from the specified channel (requires user confirmation).",parameters:{type:"object",properties:{noteId:{type:"string",description:"ID of the note/thought to delete"},channelId:{type:"string",description:"ID of the channel containing the note"}},required:["noteId","channelId"]},render:(t,n)=>h.createElement(cg,{invocation:t,onResult:n})}}listNotesTool(){return gg()}grepNotesTool(){return vg()}}const jg=new wg;class Ng{summarizeMessages(t,n){const a=t.filter(i=>i.sender==="user");if(a.length===0)return[{description:"No user content available",value:JSON.stringify({message:"No user thoughts or notes found in this context."})}];const r=a.reduce((i,l)=>{const c=l.channelId;return i[c]||(i[c]=[]),i[c].push(l),i},{}),o=[];return Object.entries(r).forEach(([i,l])=>{const c=O.getState().channels.find(u=>u.id===i),d=l.sort((u,m)=>m.timestamp.getTime()-u.timestamp.getTime());o.push({description:`Channel ${i} - All messages (${d.length} messages)`,value:JSON.stringify({channelId:i,messageCount:c?.messageCount,channelName:c?.name,messages:d.map(u=>({id:u.id,content:u.content,timestamp:u.timestamp.toISOString(),sender:u.sender,channelId:u.channelId,tags:u.tags}))})})}),o}}class Cg{TIER_LIMITS={latest:1e4,recent:2e3,historical:300,archive:30};MAX_LENGTH=35e3;summarizeMessages(t,n){const a=n||this.MAX_LENGTH,r=t.filter(l=>l.sender==="user");if(r.length===0)return[{description:"User Notes Context",value:JSON.stringify({empty:!0,message:"No user notes available"})}];const o=this.groupMessagesByTier(r),i=this.buildContextJSON(o,a);return[{description:"User Notes Context (Structured)",value:JSON.stringify(i)}]}groupMessagesByTier(t){const n=[{name:"1",description:"Most recent note (full content)",items:[],charLimit:this.TIER_LIMITS.latest},{name:"2-5",description:"Recent notes (detailed)",items:[],charLimit:this.TIER_LIMITS.recent},{name:"6-30",description:"Historical notes (summarized)",items:[],charLimit:this.TIER_LIMITS.historical},{name:"31+",description:"Archive notes (brief)",items:[],charLimit:this.TIER_LIMITS.archive}];return t.forEach((a,r)=>{const o=this.getMessageGroupIndex(r);o>=0&&o<n.length&&n[o].items.push(a)}),n}getMessageGroupIndex(t){return t===0?0:t>=1&&t<=4?1:t>=5&&t<=29?2:3}buildContextJSON(t,n){const a=t.flatMap(c=>c.items);if(a.length===0)return{empty:!0,message:"No user notes available",sampling_rules:this.getSamplingRulesDescription()};const r={sampling_rules:this.getSamplingRulesDescription(),groups:[]};let o=0,i=0;for(const c of t){if(c.items.length===0)continue;const d=this.buildGroupJSON(c),u=this.getTextLength(JSON.stringify(d));if(o+u<=n)r.groups.push(d),o+=u,i+=c.items.length;else break}const l=a.length-i;return l>0&&(r.additional_notes={count:l,message:"Use search tools to access more content"}),r}buildGroupJSON(t){const n={name:t.name,description:t.description,items:[]};return t.items.forEach(a=>{const r=this.processMessageContent(a,t.charLimit),o={id:a.id,timestamp:a.timestamp.toISOString(),channel_id:a.channelId,content:r.content};r.truncated&&(o.truncated=!0,o.original_length=r.originalLength,o.truncated_length=r.truncatedLength),n.items.push(o)}),n}processMessageContent(t,n){if(t.content.length<=n)return{content:t.content};const a=this.truncateContent(t.content,n);return{content:a,truncated:!0,originalLength:t.content.length,truncatedLength:a.length}}truncateContent(t,n){if(t.length<=n)return t;const a=.7,r=.3,o="...",i=Math.floor(n*a),l=Math.floor(n*r),c=Math.max(0,i-o.length),d=Math.max(0,l-o.length),u=t.substring(0,c),m=t.substring(t.length-d);return`${u}${o}${m}`}getTextLength(t){return t?.length||0}getSamplingRulesDescription(){return`USER NOTES CONTEXT ORGANIZATION:

Notes are sorted by timestamp (newest first) and organized into groups by position with different detail levels:

1. POSITION 1 (Most Recent):
   - Contains: The single most recent user note
   - Detail level: FULL CONTENT (up to ${this.TIER_LIMITS.latest} characters)
   - Purpose: Provides complete context of user's latest thoughts
   - Usage: Reference for immediate context and current user state

2. POSITIONS 2-5 (Recent Notes):
   - Contains: Notes from positions 2, 3, 4, and 5 (if they exist)
   - Detail level: DETAILED (up to ${this.TIER_LIMITS.recent} characters each)
   - Purpose: Recent context and immediate history
   - Usage: Understanding recent user patterns and immediate background

3. POSITIONS 6-30 (Historical Notes):
   - Contains: Notes from positions 6 through 30 (if they exist)
   - Detail level: SUMMARIZED (up to ${this.TIER_LIMITS.historical} characters each)
   - Purpose: Historical context and patterns
   - Usage: Understanding user's longer-term thinking patterns and themes

4. POSITIONS 31+ (Archive Notes):
   - Contains: All notes from position 31 onwards (if they exist)
   - Detail level: BRIEF (up to ${this.TIER_LIMITS.archive} characters each)
   - Purpose: Distant historical context
   - Usage: Identifying long-term themes and patterns

CONTENT PROCESSING:
- Long content is intelligently truncated preserving 70% from start + 30% from end
- Truncated items include metadata: truncated=true, original_length, truncated_length
- Each note includes: id, timestamp, channel_id, content
- Use search tools to access full content of truncated or additional notes

GROUP STRUCTURE:
Each group contains: name (position range), description (purpose), and items array (actual notes)
Groups are processed in priority order (1 â†’ 2-5 â†’ 6-30 â†’ 31+) until token limit is reached`}debugSummarizeMessages(t){const n=t||this.generateSampleMessages();console.group("ðŸ” Message Summarizer Debug"),console.log("ðŸ“ Input Messages:",n);const a=this.summarizeMessages(n);if(console.log("ðŸ“Š Summary Result:",a),a[0]?.value)try{const r=JSON.parse(a[0].value);console.log("ðŸ“‹ Parsed JSON:",r),console.log("ðŸ“ Length:",this.getTextLength(a[0].value)),console.log("ðŸ“ Character Count:",a[0].value.length)}catch(r){console.error("âŒ Failed to parse JSON:",r)}console.groupEnd()}generateSampleMessages(){const t=new Date;return[{id:"1",content:"This is the latest note with full content that should be preserved completely. It contains important information about the current project status and next steps.",timestamp:new Date(t.getTime()-1e3*60*5),sender:"user",channelId:"channel1"},{id:"2",content:"This is a recent note that should be included with good detail. It discusses the implementation approach and technical considerations.",timestamp:new Date(t.getTime()-1e3*60*30),sender:"user",channelId:"channel1"},{id:"3",content:"This is a historical note that should be summarized. It contains older information that is less critical but still relevant for context.",timestamp:new Date(t.getTime()-1e3*60*60*2),sender:"user",channelId:"channel2"},{id:"4",content:"This is an archive note that should be brief. Very old information that provides minimal context.",timestamp:new Date(t.getTime()-1e3*60*60*24),sender:"user",channelId:"channel1"}]}}class Gi{rawSummarizer=new Ng;tieredSummarizer=new Cg;LENGTH_LIMIT=3e4;summarizeMessages(t){if(t.length===0)return[];const n=this.rawSummarizer.summarizeMessages(t),a=this.calculateTotalLength(n);if(a<=this.LENGTH_LIMIT)return console.log(`[HybridMessageSummarizer] Using raw strategy (${a} chars)`),n;console.log(`[HybridMessageSummarizer] Raw strategy exceeds limit (${a} chars), switching to tiered strategy`);const r=this.tieredSummarizer.summarizeMessages(t),o=this.calculateTotalLength(r);return console.log(`[HybridMessageSummarizer] Tiered strategy result: ${o} chars`),r}calculateTotalLength(t){return t.reduce((n,a)=>n+(a.value?.length||0),0)}getStrategyInfo(t){const n=this.rawSummarizer.summarizeMessages(t),a=this.tieredSummarizer.summarizeMessages(t),r=this.calculateTotalLength(n),o=this.calculateTotalLength(a),i=r<=this.LENGTH_LIMIT,l=i?"raw":"tiered";return{messageCount:t.length,rawLength:r,tieredLength:o,strategyUsed:l,withinLimit:i}}}function kg(s,t,n){return`You are StillRoot AI, a specialized assistant focused on personal growth and cognitive enhancement. Your mission is to help users become who they want to be.

You are currently assisting in the channel: ${s}
This channel contains ${t} thought records that represent the collective knowledge and ideas of the team.

## Your Three Core Objectives (in priority order):

### Objective 1: Personal Growth Supervision & Guidance (Highest Priority)
- Actively monitor users' growth progress and regularly review their status
- Provide objective and comprehensive analysis, pointing out problems in users' thinking and behavior
- Offer specific improvement suggestions and action plans
- Act like a responsible mentor who supervises and encourages user growth

### Objective 2: Uncovering Problem Essence & Achieving High Cognition (Medium Priority)
- Help users dig deeper from surface phenomena to underlying essence and patterns
- Guide users to achieve higher levels of cognition and understanding
- Encourage users to question assumptions and break through cognitive boundaries
- Provide multi-dimensional thinking frameworks

### Objective 3: Knowledge Insight Discovery (Basic Priority)
- Analyze hidden connections between notes and identify recurring themes
- Discover users' knowledge blind spots and cognitive gaps
- Provide new insights and connections
- Help users build comprehensive knowledge systems

## Your Working Approach:
In every conversation, you should:
1. First focus on the user's growth status, actively analyze and point out problems
2. Then help users uncover the essence of problems and enhance cognitive levels
3. Finally provide insights and discoveries from a knowledge perspective

## Terminology clarification:
- 'Thoughts' and 'Notes' are interchangeable terms in this platform
- A thought record is the same as a note - both represent user-created content
- When users refer to notes, thoughts, or thought records, they mean the same thing

## Important Rules:
- DO NOT create thoughts/notes unless explicitly requested by the user
- Focus on analyzing, organizing, and providing insights about existing content
- Suggest improvements and connections, but don't generate new content without permission
- Maintain an objective but warm attitude
- Actively identify problems without avoiding pointing out shortcomings
- Provide specific and actionable suggestions
- Always prioritize user growth and happiness as the ultimate goal

## Tool Usage Guidelines:
- When using any tool (createNote, readNote, updateNote, deleteNote, listNotes), you MUST provide the channelId parameter
- The channelId should be the ID of the channel you want to operate on
- For operations in the current channel, use the channelId: "${n}"
- For operations in other channels, use the specific channel ID provided by the user
- Always specify the channelId explicitly - it is a required parameter for all tools
- AVOID calling readNote if you already have the complete note content from conversation context

Always be concise, actionable, and focused on helping users maximize their potential in this collaborative knowledge space.`}class Sg{summarizer=new Gi;getChannelContext(t){const n=V.dataContainer.get().messageByChannel[t],{channels:a}=O.getState(),r=a.find(c=>c.id===t),o=n?.messages||[];if(!r)return[{description:"Channel Context",value:JSON.stringify({info:"Channel meta loading...",channelId:t,timestamp:new Date().toISOString()})}];const i=o.filter(c=>c.sender==="user").sort((c,d)=>d.timestamp.getTime()-c.timestamp.getTime()),l=this.summarizer.summarizeMessages(i);return[{description:"System Instructions",value:JSON.stringify({instructions:kg(r.name,i.length,t)})},...l]}}const Mg=new Sg;var H=(s=>(s.NONE="none",s.CHANNELS="channels",s.ALL="all",s.AUTO="auto",s))(H||{});const an=1e3;class Eg{summarizer=new Gi;generateSystemInstructions(t,n,a,r){const o=t>1;return`You are StillRoot AI, a specialized assistant focused on personal growth and cognitive enhancement. Your mission is to help users become who they want to be.

You are currently assisting in ${o?`a multi-channel context spanning ${t} channels: ${a.join(", ")}`:`the channel: ${a[0]}`}
This context contains ${n} thought records, representing the collective knowledge and ideas.

## Your Three Core Objectives (in priority order):

### Objective 1: Personal Growth Supervision & Guidance (Highest Priority)
- Actively monitor users' growth progress and regularly review their status
- Provide objective and comprehensive analysis, pointing out problems in users' thinking and behavior
- Offer specific improvement suggestions and action plans
- Act like a responsible mentor who supervises and encourages user growth

### Objective 2: Uncovering Problem Essence & Achieving High Cognition (Medium Priority)
- Help users dig deeper from surface phenomena to underlying essence and patterns
- Guide users to achieve higher levels of cognition and understanding
- Encourage users to question assumptions and break through cognitive boundaries
- Provide multi-dimensional thinking frameworks

### Objective 3: Knowledge Insight Discovery (Basic Priority)
- Analyze hidden connections between notes${o?" across different channels":""}
- Discover users' knowledge blind spots and cognitive gaps
- Provide new insights and connections${o?" across channel boundaries":""}
- Help users build comprehensive knowledge systems

## Your Working Approach:
In every conversation, you should:
1. First focus on the user's growth status, actively analyze and point out problems
2. Then help users uncover the essence of problems and enhance cognitive levels
3. Finally provide insights and discoveries from a knowledge perspective

## Context Understanding:
${o?`- You have access to notes from multiple channels, each representing different topics or contexts
- Notes are organized by recency with different detail levels across all channels
- Use channel information to understand the source and context of each note
- Look for patterns and connections that span across different channels`:`- You have access to notes from this channel, representing the user's thoughts and ideas
- Notes are organized by recency with different detail levels
- Use this context to understand the user's thinking patterns and provide relevant insights`}

## Terminology clarification:
- 'Thoughts' and 'Notes' are interchangeable terms in this platform
- A thought record is the same as a note - both represent user-created content
- When users refer to notes, thoughts, or thought records, they mean the same thing

## Important Rules:
- DO NOT create thoughts/notes unless explicitly requested by the user
- Focus on analyzing, organizing, and providing insights about existing content
- Suggest improvements and connections, but don't generate new content without permission
- Maintain an objective but warm attitude
- Actively identify problems without avoiding pointing out shortcomings
- Provide specific and actionable suggestions
- Always prioritize user growth and happiness as the ultimate goal

## Tool Usage Guidelines:
- When using any tool (createNote, readNote, updateNote, deleteNote, listNotes), you MUST provide the channelId parameter
- The channelId should be the ID of the channel you want to operate on
- For operations in the current context, use the channelId: "${r}"
- For operations in other channels, use the specific channel ID provided by the user
- Always specify the channelId explicitly - it is a required parameter for all tools
- AVOID calling readNote if you already have the complete note content from conversation context

Always be concise, actionable, and focused on helping users maximize their potential in this collaborative knowledge space.`}ensureContextsLoaded(t,n){if(!t){const o=V.dataContainer.get().messageByChannel[n];(!o||o.hasMore)&&V.requestLoadInitialMessages$.next({channelId:n,messageLimit:an});return}const{mode:a,channelIds:r}=t;if(a===H.AUTO){const o=W.getState().currentChannelId,i=V.dataContainer.get().messageByChannel[o];(!i||i.hasMore)&&V.requestLoadInitialMessages$.next({channelId:o,messageLimit:an});return}if(a===H.CHANNELS&&r)r.forEach(o=>{const i=V.dataContainer.get().messageByChannel[o];(!i||i.hasMore)&&V.requestLoadInitialMessages$.next({channelId:o,messageLimit:an})});else if(a===H.ALL){const{channels:o}=O.getState();o.forEach(i=>{const l=V.dataContainer.get().messageByChannel[i.id];(!l||l.hasMore)&&V.requestLoadInitialMessages$.next({channelId:i.id,messageLimit:an})})}}getSessionContexts(t,n){const a=Y.getState().conversations.find(d=>d.id===t);if(!a||!a.contexts)return this.getUnifiedContext([n]);const{mode:r,channelIds:o}=a.contexts;if(r===H.NONE)return[{description:"System Instructions",value:JSON.stringify({instructions:"No external context is attached to this conversation. Respond based on user input only unless the user explicitly asks to reference notes."})}];if(r===H.CHANNELS){const d=o||[];return d.length===0?[]:this.getUnifiedContext(d)}const{channels:i}=O.getState(),l=V.dataContainer.get().messageByChannel,c=i.map(d=>d.id).filter(d=>{const u=l[d];return u&&!u.loading});return c.length===0?this.getUnifiedContext([n]):this.getUnifiedContext(c)}getUnifiedContext(t){const{channels:n}=O.getState(),a=V.dataContainer.get().messageByChannel,r=[];t.forEach(u=>{const m=n.find(f=>f.id===u),p=a[u];if(m&&p?.messages){const f=p.messages.filter(g=>g.sender==="user").map(g=>({...g,channelId:u,channelName:m.name}));r.push(...f)}}),r.sort((u,m)=>m.timestamp.getTime()-u.timestamp.getTime());const o=this.summarizer.summarizeMessages(r),i=t.map(u=>{const m=n.find(p=>p.id===u);return{id:u,name:m?.name||"Unknown",note_count:m?.messageCount||0}}),l=i.map(u=>u.name),c=r.length;return[{description:"System Instructions",value:this.generateSystemInstructions(t.length,c,l,t[0])},{description:"Channel Information",value:JSON.stringify({channels:i,total_channels:t.length,total_notes:c})},...o]}}const Ya=new Eg,Ig=h.createContext(null),Tg=({children:s,open:t,onOpenChange:n,modal:a})=>{const[r,o]=h.useState(!1),i=t!==void 0?t:r,l=n||o,c={isOpen:i,onOpenChange:l};return e.jsx(Ig.Provider,{value:c,children:e.jsx(Us,{open:i,onOpenChange:l,modal:a,children:s})})},Ag=({children:s,className:t=""})=>e.jsx("div",{className:M("flex items-center gap-2.5 mb-5",t),children:s}),Lg=({children:s,className:t=""})=>e.jsx("div",{className:M("space-y-4",t),children:s}),Rg=({children:s,className:t=""})=>e.jsx("div",{className:M("flex justify-end gap-2.5 pt-3 mt-2",t),children:s}),Dg=zs,Vi=h.forwardRef(({className:s,variant:t="default",size:n="md",...a},r)=>{const o="h-8 px-4 rounded-lg text-sm transition-all duration-200 font-medium flex items-center justify-center",i={default:"bg-primary text-primary-foreground hover:bg-primary/90",outline:"text-muted-foreground hover:text-foreground hover:bg-accent/30",ghost:"text-muted-foreground hover:text-foreground hover:bg-accent/30"},l={sm:"h-7 px-3 text-xs",md:"h-8 px-4 text-sm"};return e.jsx("button",{className:M(o,i[t],l[n],"disabled:opacity-50",s),ref:r,...a})});Vi.displayName="RefinedPopoverButton";const _g=({children:s,width:t="w-80",className:n="",align:a="center",side:r="bottom",sideOffset:o=6,onInteractOutside:i})=>e.jsx(Fs,{className:M(t,"p-4 border border-slate-200/60 dark:border-slate-700/60 shadow-lg bg-popover text-popover-foreground rounded-xl overflow-hidden max-w-[90vw] max-h-[70vh] mr-4 sm:mr-0",n),align:a,side:r,sideOffset:o,onInteractOutside:i,children:s}),q=Object.assign(Tg,{Trigger:Dg,Content:_g,Header:Ag,Body:Lg,Actions:Rg,Button:Vi});function Pg({conversationId:s,fallbackChannelId:t,onActiveToolChannelChange:n,activeToolChannelId:a}){const r=Y(f=>f.conversations.find(g=>g.id===s)),o=Y(f=>f.updateConversation),{userId:i}=O(),[l,c]=h.useState(r?.contexts?r.contexts.mode:H.AUTO),[d,u]=h.useState(r?.contexts?.mode===H.CHANNELS?r?.contexts?.channelIds||[t]:[t]);h.useEffect(()=>{c(r?.contexts?r.contexts.mode:H.AUTO),u(r?.contexts?.mode===H.CHANNELS?r?.contexts?.channelIds||[t]:[t])},[s,r?.contexts,t]);const m=h.useCallback(f=>{u(g=>g.includes(f)?g.filter(x=>x!==f):[...g,f])},[]),p=h.useCallback(async()=>{if(!i||!r)return;if(l===H.AUTO){await o(i,r.id,{contexts:{mode:H.AUTO}});return}let f;if(l===H.NONE)f={mode:H.NONE};else if(l===H.ALL)f={mode:H.ALL};else{const g=d.length?d:[t];if(f={mode:H.CHANNELS,channelIds:g},n){const x=a&&g.includes(a)?a:g[0];n(x)}}await o(i,r.id,{contexts:f}),Ya.ensureContextsLoaded(f,t)},[i,r,l,d,t,n,a,o]);return{draftMode:l,setDraftMode:c,draftChannelIds:d,toggleChannel:m,apply:p,isSelectedMode:l===H.CHANNELS}}function Og(s,t,n,a){if(s===H.AUTO)return[n];if(s===H.NONE)return[];if(s===H.CHANNELS){const r=t?.channelIds||[];return r.length>0?r:[n]}else return a.map(r=>r.id)}function $g(s,t,n){return s.length===0?"":s.map(r=>{const o=t[r],i=n(r),l=o?.loading?"loading":"ready";return`${i}(${l})`}).join(", ")}function Ug({conversationId:s,fallbackChannelId:t,contexts:n,getChannelName:a}){const r=V.dataContainer.use(),{channels:o}=O();h.useEffect(()=>{Ya.ensureContextsLoaded(n||null,t)},[s,t,n]);const{anyLoading:i,tooltip:l}=h.useMemo(()=>{const c=n?n.mode:H.AUTO,d=Og(c,n,t,o),m=d.map(f=>r.messageByChannel[f]?.loading||!1).some(f=>f),p=$g(d,r.messageByChannel,a);return{anyLoading:m,tooltip:p}},[n,t,o,r,a]);return{anyLoading:i,tooltip:l}}function zg(s){const[t,n]=h.useState(""),a=W(o=>o.currentChannelId),r=h.useMemo(()=>{let o=s;if(t.trim()){const i=t.toLowerCase();o=s.filter(l=>l.name.toLowerCase().includes(i)||l.description?.toLowerCase().includes(i))}return o.sort((i,l)=>{if(a){if(i.id===a&&l.id!==a)return-1;if(l.id===a&&i.id!==a)return 1}return i.messageCount!==l.messageCount?l.messageCount-i.messageCount:i.name.localeCompare(l.name)})},[s,t,a]);return{searchQuery:t,setSearchQuery:n,filteredChannels:r}}function Fg({contexts:s,fallbackChannelId:t,getChannelName:n,channelsLength:a}){const r=h.useMemo(()=>{const l=s;if(!l)return`Auto (${n(t)})`;if(l.mode===H.NONE)return"No Context";if(l.mode===H.ALL)return"All Spaces";const c=l.channelIds||[];return c.length===0?"No Context":(c.length===1,n(c[0]))},[s,t,n]),o=h.useMemo(()=>{const l=s;if(!l||l.mode!==H.CHANNELS)return 0;const c=l.channelIds||[];return Math.max(0,c.length-1)},[s]),i=h.useMemo(()=>{const l=s;return l?l.mode===H.NONE?0:l.mode===H.ALL?a:(l.channelIds||[]).length:1},[s,a]);return{label:r,otherCount:o,totalCount:i}}function Bg({variant:s,label:t,tooltip:n,totalCount:a,anyLoading:r,conv:o,showModeNameInCompact:i=!1,modeName:l}){return s==="compact"?e.jsxs("div",{className:"relative h-8 w-8 inline-flex items-center justify-center",children:[(()=>{const c=o?.contexts;return c?c.mode===H.NONE?e.jsx(sa,{className:"w-4 h-4"}):c.mode===H.ALL?e.jsx(Os,{className:"w-4 h-4"}):c.mode===H.CHANNELS?e.jsx(na,{className:"w-4 h-4"}):e.jsx(vn,{className:"w-4 h-4"}):e.jsx(mt,{className:"w-4 h-4"})})(),a>0&&e.jsx("span",{className:"absolute top-0 right-0.5 min-w-[14px] h-3 px-1 rounded-full bg-muted text-foreground/80 text-[10px] leading-3 flex items-center justify-center",children:a}),e.jsx("span",{className:"absolute bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full "+(r?"bg-primary animate-pulse":"bg-emerald-500")})]}):e.jsxs("div",{className:"relative inline-flex items-center gap-1.5 text-sm",children:[(()=>{const c=o?.contexts;return!c||c.mode===H.AUTO?e.jsx(mt,{className:"w-4 h-4 text-muted-foreground/70"}):c.mode===H.NONE?e.jsx(sa,{className:"w-4 h-4 text-muted-foreground/70"}):c.mode===H.ALL?e.jsx(Os,{className:"w-4 h-4 text-muted-foreground/70"}):c.mode===H.CHANNELS?e.jsx(na,{className:"w-4 h-4 text-muted-foreground/70"}):e.jsx(vn,{className:"w-4 h-4 text-muted-foreground/70"})})(),e.jsx("span",{className:"font-medium text-foreground/90 truncate max-w-[10rem]",children:t}),a>0&&e.jsx("span",{className:"min-w-[18px] h-4 px-1.5 rounded-full bg-muted text-foreground/80 text-[10px] leading-4 flex items-center justify-center",children:a}),e.jsx("span",{className:"w-1.5 h-1.5 rounded-full "+(r?"bg-primary animate-pulse":"bg-emerald-500")})]})}function rn({mode:s,currentMode:t,icon:n,title:a,description:r,onClick:o,showChevron:i=!1,isExpanded:l=!1}){const c=t===s;return e.jsxs("div",{className:M("flex items-center gap-2.5 px-2.5 py-2 rounded-lg cursor-pointer transition-all duration-200",c?"bg-primary/8 text-primary":"hover:bg-accent/30 text-foreground"),onClick:o,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("div",{className:M("transition-colors",c?"text-primary":"text-muted-foreground"),children:n}),e.jsx("span",{className:"text-sm font-medium",children:a})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground/70",children:r}),i&&e.jsx(ze,{className:M("w-3.5 h-3.5 text-muted-foreground/60 transition-all duration-200",l?"rotate-180":"")})]})]})}function Hg({searchQuery:s,setSearchQuery:t,filteredChannels:n,draftChannelIds:a,toggleChannel:r,fallbackChannelId:o}){return e.jsxs("div",{className:"bg-muted/35 border border-muted/50 rounded-lg shadow-sm transition-all",children:[e.jsx("div",{className:"p-2.5 border-b border-muted/45 bg-muted/15",children:e.jsxs("div",{className:"relative",children:[e.jsx(Fe,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground/60"}),e.jsx(_e,{placeholder:"Search spaces...",value:s,onChange:i=>t(i.target.value),className:"pl-9 h-7 text-sm border-0 bg-background/95 focus:bg-background focus:ring-1 focus:ring-primary/20"})]})}),e.jsx("div",{className:"max-h-32 overflow-y-auto",children:n.length===0?e.jsxs("div",{className:"text-center py-6",children:[e.jsx("div",{className:"text-muted-foreground/50 mb-1.5 text-lg",children:s?"ðŸ”":"ðŸ“"}),e.jsx("div",{className:"text-xs text-muted-foreground/70",children:s?"No spaces found":"No spaces available"})]}):e.jsx("div",{className:"p-1.5 space-y-0.5",children:n.map(i=>{const l=a.includes(i.id),c=i.id===o;return e.jsxs("div",{className:M("flex items-center gap-2.5 px-2.5 py-1.5 rounded-lg text-sm transition-all duration-200 cursor-pointer",l?"bg-primary/6 text-primary":"hover:bg-accent/25 text-foreground"),onClick:()=>r(i.id),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("span",{className:"text-sm",children:i.emoji||"ðŸ“"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:i.name}),c&&e.jsx("div",{className:"text-xs text-primary/80",children:"Current space"})]})]}),l&&e.jsx(Ye,{className:"w-4 h-4 text-primary"})]},i.id)})})})]})}function Gg({activeToolChannelId:s,draftChannelIds:t,onActiveToolChannelChange:n,getChannelName:a}){return e.jsxs("div",{className:"p-2.5 rounded-lg bg-muted/35 border border-muted/50 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(vn,{className:"w-4 h-4 text-muted-foreground/70"}),e.jsx("span",{className:"text-sm font-medium text-foreground/90",children:"Active Tool Space"})]}),e.jsxs("select",{value:s&&t.includes(s)?s:t[0]||"",onChange:r=>n(r.target.value||null),className:"w-full h-7 px-2.5 rounded-lg border-0 bg-background/95 text-sm focus:bg-background focus:ring-1 focus:ring-primary/20 transition-all duration-200",children:[t.length===0&&e.jsx("option",{value:"",children:"(none)"}),t.map(r=>e.jsx("option",{value:r,children:a(r)},r))]})]})}function Vg({conversationId:s,fallbackChannelId:t,onActiveToolChannelChange:n,activeToolChannelId:a,variant:r="inline",className:o,showModeNameInCompact:i=!1}){const[l,c]=h.useState(!1),d=Y(U=>U.conversations.find(z=>z.id===s)),{channels:u}=O(),m=h.useCallback(U=>u.find(z=>z.id===U)?.name||U,[u]),{draftMode:p,setDraftMode:f,draftChannelIds:g,toggleChannel:x,apply:y}=Pg({conversationId:s,fallbackChannelId:t,onActiveToolChannelChange:n,activeToolChannelId:a}),{searchQuery:v,setSearchQuery:w,filteredChannels:b}=zg(u),{anyLoading:N,tooltip:j}=Ug({conversationId:s,fallbackChannelId:t,contexts:d?.contexts,getChannelName:m}),{label:C,totalCount:E}=Fg({contexts:d?.contexts,fallbackChannelId:t,getChannelName:m,channelsLength:u.length}),[R,T]=h.useState(p===H.CHANNELS),D=M(r==="banner"?"flex items-center gap-2 px-3 py-2 border-b bg-background/60":r==="compact"?"inline-flex items-center":"inline-flex items-center gap-1",o),L=()=>{const U=d?.contexts;return!U||U.mode===H.AUTO?"Auto":U.mode===H.NONE?"None":U.mode===H.ALL?"All":U.mode===H.CHANNELS?"Custom":"Auto"};return e.jsx("div",{className:D,children:e.jsxs(q,{open:l,onOpenChange:c,modal:!0,children:[e.jsx(q.Trigger,{asChild:!0,children:e.jsxs("div",{className:"flex items-center gap-0.5 h-8 rounded-md bg-transparent hover:bg-accent/50 text-muted-foreground hover:text-foreground transition-colors duration-200",children:[e.jsx(Bg,{variant:r,label:C,tooltip:j,totalCount:E,anyLoading:N,conv:d,showModeNameInCompact:i,modeName:L()}),(r!=="compact"||i)&&e.jsxs("div",{className:"flex items-center gap-0.5 pr-2",children:[e.jsx("span",{className:"text-sm font-medium",children:L()}),e.jsx(ze,{className:"w-3 h-3 opacity-50"})]})]})}),e.jsxs(q.Content,{width:"w-80",align:"center",side:"bottom",children:[e.jsxs(q.Header,{children:[e.jsx(vn,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:"Context Settings"}),e.jsx(q.Button,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:()=>c(!1),title:"Close",children:e.jsx(le,{className:"h-3 w-3"})})]}),e.jsxs(q.Body,{children:[N&&e.jsx("div",{className:"mb-3 p-2.5 rounded-lg bg-primary/6",children:e.jsxs("div",{className:"flex items-center gap-2 text-xs text-primary/90",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-primary animate-pulse"}),e.jsx("span",{children:"Loading context data..."})]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(rn,{mode:H.AUTO,currentMode:p,icon:e.jsx(mt,{className:"w-4 h-4 text-muted-foreground"}),title:"Auto",description:"Current space only",onClick:()=>{f(H.AUTO),T(!1)}}),e.jsx(rn,{mode:H.NONE,currentMode:p,icon:e.jsx(sa,{className:"w-4 h-4 text-muted-foreground"}),title:"None",description:"No context access",onClick:()=>{f(H.NONE),T(!1)}}),e.jsx(rn,{mode:H.ALL,currentMode:p,icon:e.jsx(Os,{className:"w-4 h-4 text-muted-foreground"}),title:"All",description:"All spaces access",onClick:()=>{f(H.ALL),T(!1)}}),e.jsx(rn,{mode:H.CHANNELS,currentMode:p,icon:e.jsx(na,{className:"w-4 h-4 text-muted-foreground"}),title:"Custom",description:"Select specific spaces",showChevron:!0,isExpanded:R,onClick:()=>{p===H.CHANNELS?T(!R):(f(H.CHANNELS),T(!0))}}),R&&e.jsx(Hg,{searchQuery:v,setSearchQuery:w,filteredChannels:b,draftChannelIds:g,toggleChannel:x,fallbackChannelId:t}),p===H.CHANNELS&&n&&e.jsx(Gg,{activeToolChannelId:a||null,draftChannelIds:g,onActiveToolChannelChange:n,getChannelName:m})]})]}),e.jsxs(q.Actions,{children:[e.jsx(q.Button,{type:"button",variant:"outline",onClick:()=>c(!1),children:"Cancel"}),e.jsx(q.Button,{type:"button",variant:"default",onClick:()=>{y(),c(!1)},children:"Apply Changes"})]})]})]})})}const qi=Ee()(At((s,t)=>{const n=Na();return{selectedModelId:n.id,selectedModel:n,setSelectedModel:a=>{const r=qt.find(o=>o.id===a);r&&s({selectedModelId:a,selectedModel:r})},getSelectedModel:()=>t().selectedModel}},{name:"model-selection-storage",partialize:s=>({selectedModelId:s.selectedModelId}),onRehydrateStorage:()=>s=>{if(s){const t=qt.find(n=>n.id===s.selectedModelId);if(t)s.selectedModel=t;else{const n=Na();s.selectedModelId=n.id,s.selectedModel=n}}}}));class qg{agent=null;getAgent(){if(!this.agent){const{getSelectedModel:t}=qi.getState(),n=t();this.agent=new nn({apiKey:n.apiKey,model:n.model,temperature:n.temperature,maxTokens:n.maxTokens,baseURL:n.apiUrl})}return this.agent}updateAgentConfig(t){this.agent||(this.agent=new nn),this.agent.setConfig({apiKey:t.apiKey,model:t.model,temperature:t.temperature,maxTokens:t.maxTokens,baseURL:t.apiUrl})}createAgentWithModel(t){return new nn({apiKey:t.apiKey,model:t.model,temperature:t.temperature,maxTokens:t.maxTokens,baseURL:t.apiUrl})}createAgentWithConfig(t){const n=Na();return new nn({apiKey:t.apiKey||n.apiKey,model:t.model||n.model,temperature:t.temperature??n.temperature,maxTokens:t.maxTokens??n.maxTokens,baseURL:t.baseURL||n.apiUrl})}getChannelTools(){return jg.getChannelTools()}getChannelContext(t){return Mg.getChannelContext(t)}getSessionContexts(t,n){return Ya.getSessionContexts(t,n)}}const gn=new qg,Wg=({draft:s,setDraft:t,props:n})=>{const{selectedModelId:a,setSelectedModel:r}=qi(),o=s.meta?.modelId,i=l=>{const c=Va(l);c&&(r(l),gn.updateAgentConfig(c),t({...s,meta:{...s.meta,modelId:l,modelConfig:{apiKey:c.apiKey,model:c.model,apiUrl:c.apiUrl,temperature:c.temperature,maxTokens:c.maxTokens}}}),n.onModelChange?.(l))};return e.jsx(Bm,{selectedModelId:o||a||n.selectedModelId,onModelChange:i,className:n.className})},Kg=s=>({id:"model-selector",placement:"bottom-left",render:({draft:t,setDraft:n})=>e.jsx(Wg,{draft:t,setDraft:n,props:s}),beforeSend:async t=>{const n=t.meta?.modelId;if(n){const a=Va(n);if(a)return{...t,meta:{...t.meta,modelConfig:{apiKey:a.apiKey,model:a.model,apiUrl:a.apiUrl,temperature:a.temperature,maxTokens:a.maxTokens}}}}return t}}),Yg=({props:s})=>e.jsx(Vg,{conversationId:s.conversationId,fallbackChannelId:s.fallbackChannelId,onActiveToolChannelChange:s.onActiveToolChannelChange,activeToolChannelId:s.activeToolChannelId,variant:"compact",className:s.className,showModeNameInCompact:s.showModeNameInCompact}),Xg=s=>({id:"context-selector",placement:"bottom-left",render:({draft:t,setDraft:n})=>e.jsx(Yg,{draft:t,setDraft:n,props:s})}),F=({className:s,children:t})=>t?e.jsx("div",{className:M("animate-pulse",s),children:t}):e.jsx("div",{className:M("animate-pulse rounded-md bg-slate-200 dark:bg-slate-700",s)});function Xa(){return e.jsxs("div",{className:"h-full w-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(F,{className:"w-8 h-8 rounded-full"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(F,{className:"h-4 w-32"}),e.jsx(F,{className:"h-3 w-24"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(F,{className:"w-8 h-8 rounded-md"}),e.jsx(F,{className:"w-8 h-8 rounded-md"})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(F,{className:"w-8 h-8 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(F,{className:"h-4 w-16"}),e.jsx(F,{className:"h-3 w-20"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{className:"h-4 w-full"}),e.jsx(F,{className:"h-4 w-5/6"}),e.jsx(F,{className:"h-4 w-3/4"}),e.jsx(F,{className:"h-4 w-2/3"})]})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 justify-end",children:[e.jsxs("div",{className:"flex-1 space-y-2 min-w-0 max-w-[80%]",children:[e.jsxs("div",{className:"flex items-center space-x-2 justify-end",children:[e.jsx(F,{className:"h-3 w-20"}),e.jsx(F,{className:"h-4 w-16"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{className:"h-4 w-full"}),e.jsx(F,{className:"h-4 w-4/5"})]})]}),e.jsx(F,{className:"w-8 h-8 rounded-full flex-shrink-0"})]}),e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(F,{className:"w-8 h-8 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(F,{className:"h-4 w-16"}),e.jsx(F,{className:"h-3 w-20"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{className:"h-4 w-full"}),e.jsx(F,{className:"h-4 w-4/5"}),e.jsx(F,{className:"h-4 w-3/4"})]})]})]})]}),e.jsx("div",{className:"p-4 border-t border-border",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(F,{className:"flex-1 h-10 rounded-md"}),e.jsx(F,{className:"w-10 h-10 rounded-md"})]})})]})}function Jg({count:s=5}){return e.jsxs("div",{className:"h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsx(F,{className:"h-6 w-32"}),e.jsx(F,{className:"w-8 h-8 rounded-md"})]}),e.jsx("div",{className:"flex-1 overflow-hidden p-4 space-y-3",children:Array.from({length:s}).map((t,n)=>e.jsx("div",{className:"p-3 border border-border rounded-lg",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{className:"h-4 w-3/4"}),e.jsx(F,{className:"h-3 w-1/2"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(F,{className:"h-3 w-20"}),e.jsx(F,{className:"h-3 w-16"})]})]})},n))}),e.jsx("div",{className:"p-4 border-t border-border",children:e.jsx(F,{className:"w-full h-10 rounded-md"})})]})}function Wi({conversationId:s,channelId:t}){const{messages:n,createMessage:a,updateMessage:r,loading:o}=Um(s),i=Y(f=>f.conversations.find(g=>g.id===s)),l=Y(f=>f.conversations),c=!!i&&i.messageCount===0,d=l.filter(f=>!f.id.startsWith("temp-")).length===1&&c,u=o&&!c,m=h.useRef(s),p=h.useMemo(()=>{const f=m.current;if(f!==s)return m.current=s,Ui(f)?f:s},[s]);return e.jsx("div",{className:"h-full flex flex-col bg-background",children:e.jsx("div",{className:"flex-1 overflow-hidden",children:u?e.jsx(Xa,{}):e.jsx(Qg,{conversationId:s,channelId:t,messages:n,createMessage:a,updateMessage:r,isFirstConversation:d},p)})})}function Qg({conversationId:s,channelId:t,messages:n,createMessage:a,updateMessage:r,isFirstConversation:o}){const{isMobile:i}=ai(),l=h.useMemo(()=>gn.getAgent(),[]),c=h.useMemo(()=>gn.getChannelTools(),[]),{toolDefs:d,toolExecutors:u,toolRenderers:m}=eu(c),p=h.useMemo(()=>()=>{const b=gn.getSessionContexts(s,t);return o?[{description:"Product Information & First Session Guide",value:JSON.stringify({welcomeMessage:"This is the user's first AI conversation. Please DEMONSTRATE your agent capabilities by actively using tools to show what you can do.",productInfo:{name:"StillRoot",purpose:"A personal growth companion platform that helps users become who they want to be",coreFeatures:["Personal Growth Guidance: Monitor progress, identify problems in thinking and behavior, provide specific improvement suggestions","Deep Understanding: Help users dig deeper from surface phenomena to underlying essence and patterns","Insight Discovery: Analyze connections between notes, discover knowledge blind spots, provide new insights","Note Management: Create, read, update, and organize notes across channels with AI assistance"],valueProposition:"StillRoot helps users track thoughts, discover patterns, and grow personally through AI-powered analysis of their notes and ideas.",mission:"Help users become who they want to be through cognitive enhancement and personal growth supervision"},engagementStrategy:"Be enthusiastic, show value by USING TOOLS, demonstrate capabilities, and encourage exploration. Make them feel excited about using StillRoot regularly.",demonstrationRequirements:["You MUST actively use at least 2-3 tools to demonstrate your capabilities","Use listNotes to show you can access their notes and provide insights","Use grepNotes to search their notes and find patterns or interesting content","Analyze their notes to provide meaningful insights","Show excitement about their data and suggest ways to explore it","CRITICAL: Call tools ONE AT A TIME. Wait for each tool to complete before calling the next one. Do not send multiple tool calls in parallel.","For example, first call listNotes, wait for results, then call grepNotes, wait for results, then analyze"],suggestedApproach:["Greet them warmly as their personal growth companion","Briefly introduce StillRoot's mission and your role","IMMEDIATELY start using tools (listNotes, grepNotes, etc.) to demonstrate your capabilities","Show actual insights from their notes, even if they're just starting out","Highlight the value of having AI-powered analysis of their thoughts","Invite them to try asking questions or exploring specific topics","Be encouraging and show enthusiasm about helping them grow"]})},...b]:b},[s,t,o]),f=h.useMemo(()=>o&&!Ui(s)&&n.length===0?[{id:`welcome-${s}`,role:"user",parts:[{type:"text",text:"Hi! I'm new here. Could you please introduce yourself and explain what you can do to help me?"}]}]:n,[o,s,n]),g=tu({agent:l,getToolDefs:()=>d,getContexts:p,initialMessages:f,getToolExecutor:b=>u[b]}),x=h.useRef(!1);h.useEffect(()=>{o&&(x.current||(x.current=!0,g.runAgent()))},[o,s,g]);const y=$s(a),v=$s(r);h.useEffect(()=>{const b=g.addMessagesEvent$.subscribe(({messages:N})=>{N.forEach(async j=>{y(j)})});return()=>b.unsubscribe()},[g.addMessagesEvent$,y]),h.useEffect(()=>{const b=g.updateMessageEvent$.pipe(Ft(({message:N})=>N),Bd(N=>N.id),Bo(N=>N.pipe(da(300),Ws((j,C)=>Xo(j,C))))).subscribe(N=>{v(N)});return()=>b.unsubscribe()},[g.updateMessageEvent$,v]),h.useEffect(()=>{const b=g.messages$.pipe(da(100)).subscribe(N=>{Y.getState().onMessagesSnapshot(s,N)});return()=>b.unsubscribe()},[g,s]);const w=h.useMemo(()=>[Xg({conversationId:s,fallbackChannelId:t,showModeNameInCompact:!i}),Kg({onModelChange:b=>{console.log("Model changed to:",b)}})],[s,t,i]);return su(g),e.jsx("div",{className:"h-full flex flex-col agent-chat-fullwidth",children:e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(nu,{agentSessionManager:g,toolRenderers:m,className:"h-full w-full",messageItemProps:{showAvatar:!1},promptsProps:{items:Zg(),onItemClick:({prompt:b})=>{g.handleAddMessages([{id:crypto.randomUUID(),role:"user",parts:[{type:"text",text:b}]}])}},inputExtensions:w})})})}function Zg(s){return[{id:"prompt-1",prompt:"Analyze my recent notes"},{id:"prompt-2",prompt:"Summarize my thoughts"},{id:"prompt-3",prompt:"What patterns do you see?"},{id:"prompt-4",prompt:"Help me organize these ideas"},{id:"prompt-5",prompt:"What am I missing?"},{id:"prompt-6",prompt:"Suggest improvements"}]}function Ki({onCreate:s}){return e.jsx("div",{className:"flex-1 flex items-center justify-center p-6",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx("svg",{className:"w-8 h-8 text-primary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"})})}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"AI Note Agent"}),e.jsx("p",{className:"text-muted-foreground text-sm leading-relaxed",children:"I can see all your notes in this space and help you manage them. Ask me to analyze, organize, create, or update your notes. I'll help you discover insights and connections in your thoughts."})]}),e.jsx("div",{className:"space-y-3 mb-6",children:e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("p",{className:"font-medium",children:"Try asking:"}),e.jsx("p",{children:'"What are the main themes in my notes?"'}),e.jsx("p",{children:'"Help me organize these ideas better"'}),e.jsx("p",{children:'"Create a summary note of key insights"'})]})}),e.jsx("button",{onClick:s,className:"inline-flex h-10 items-center justify-center whitespace-nowrap rounded-md px-4 text-sm font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90",children:"Start Conversation"})]})})}function Yi({currentConversationId:s,channelId:t,hasConversations:n,onClose:a}){const{createConversation:r}=Ks(),{userId:o}=O();return s?e.jsx(Wi,{conversationId:s,channelId:t,onClose:a}):n?e.jsx("div",{className:"flex-1"}):e.jsx(Ki,{onCreate:()=>{o&&r(o,"New Conversation")}})}function ep({conversations:s,currentConversationId:t,loading:n,channelId:a,onClose:r}){const o=s.length>0;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-80 flex flex-col",children:e.jsx(Ga,{conversations:s,currentConversationId:t,loading:n,withHeader:!1})}),e.jsx("div",{className:"flex-1 flex flex-col",children:e.jsx(Yi,{currentConversationId:t,channelId:a,hasConversations:o,onClose:r})})]})}const tp=h.forwardRef(function({conversations:t,currentConversationId:n,loading:a,channelId:r,onClose:o},i){const l=Y(m=>m.uiView),c=Y(m=>m.showList),d=Y(m=>m.showChat),u=t.length>0;return h.useImperativeHandle(i,()=>({showList:()=>c(),showChat:()=>d()}),[c,d]),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"absolute inset-0 flex flex-col "+(l==="list"?"":"hidden"),children:e.jsx(Ga,{conversations:t,currentConversationId:n,loading:a,withHeader:!1})}),e.jsx("div",{className:"absolute inset-0 flex flex-col "+(l==="chat"?"":"hidden"),children:e.jsx(Yi,{currentConversationId:n,channelId:r,hasConversations:u,onClose:o})})]})}),sp=h.forwardRef(function({channelId:t,onClose:n},a){const{userId:r}=O(),{conversations:o,currentConversationId:i,loading:l,createConversation:c,loadConversations:d}=Ks(),u=h.useRef(null),{mode:m,ready:p}=Pm(u,{sidebar:320,chatMin:520,hysteresis:12,debounceMs:80}),f=m==="single-pane",g=h.useRef(null),x=h.useCallback(()=>{r&&c(r,"New Conversation")},[r,c]);return h.useImperativeHandle(a,()=>({showList:()=>g.current?.showList(),showChat:()=>g.current?.showChat(),createNew:()=>x(),isSinglePane:()=>f}),[f,x]),h.useEffect(()=>{r&&d(r)},[r,d]),l||!p?e.jsx("div",{ref:u,className:"h-full flex "+(p?"":"invisible"),children:e.jsx(Xa,{})}):e.jsx("div",{ref:u,className:"h-full flex "+(p?"":"invisible"),children:m==="two-pane"?e.jsx(ep,{conversations:o,currentConversationId:i,loading:l,channelId:t,onClose:n}):e.jsx(tp,{ref:g,conversations:o,currentConversationId:i,loading:l,channelId:t,onClose:n})})});function np({isOpen:s,onClose:t,channelId:n}){const{userId:a}=O(),r=h.useRef(null),{currentConversation:o,createConversation:i}=Ks(),l=Y(u=>u.uiView),c=Y(u=>u.titleGeneratingMap);if(!s)return null;const d=()=>l==="list"?"Conversations":o?c[o.id]?"Generating Title...":o.title||"AI Conversations":"AI Conversations";return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"px-3 py-2 bg-background",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2 min-w-0",children:e.jsx("h3",{className:"font-semibold text-foreground truncate",children:d()})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>{const u=r.current;u&&u.isSinglePane()&&u.showList()},"aria-label":"Conversations",children:e.jsx(Ao,{className:"w-5 h-5"})}),e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>{a&&i(a,"New Conversation")},"aria-label":"New conversation",children:e.jsx(Me,{className:"w-5 h-5"})}),e.jsx(k,{variant:"ghost",size:"icon",onClick:t,"aria-label":"Close",children:e.jsx(le,{className:"w-5 h-5"})})]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(sp,{ref:r,channelId:n,onClose:t})})]})}function Ja({onSelect:s,children:t}){const[n,a]=h.useState(!1),[r,o]=h.useState(!1);h.useEffect(()=>{const l=()=>{const u=document.documentElement.classList.contains("dark")||window.matchMedia("(prefers-color-scheme: dark)").matches;o(u)};l();const c=new MutationObserver(l);c.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]});const d=window.matchMedia("(prefers-color-scheme: dark)");return d.addEventListener("change",l),()=>{c.disconnect(),d.removeEventListener("change",l)}},[]);const i=l=>{s(l.emoji),a(!1)};return e.jsxs(q,{open:n,onOpenChange:a,children:[e.jsx(q.Trigger,{asChild:!0,children:t}),e.jsx(q.Content,{align:"start",sideOffset:8,className:"p-0",children:e.jsx("div",{className:"w-80",children:e.jsx(au,{onEmojiClick:i,autoFocusSearch:!1,searchDisabled:!1,skinTonesDisabled:!1,width:"100%",height:350,theme:r?Ar.DARK:Ar.LIGHT,previewConfig:{showPreview:!1},searchPlaceHolder:"Search emojis...",defaultSkinTone:ou.NEUTRAL,emojiStyle:ru.NATIVE,lazyLoadEmojis:!0})})})]})}function et({className:s,...t}){return e.jsx(uc,{"data-slot":"label",className:M("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",s),...t})}function gs({className:s,...t}){return e.jsx("textarea",{"data-slot":"textarea",className:M("border-input placeholder:text-muted-foreground aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),...t})}function Hs({trigger:s,variant:t="popover",instantCreate:n=!1,defaultName:a="Untitled"}){const r=he(),[o,i]=h.useState(!1),[l,c]=h.useState(""),[d,u]=h.useState(""),[m,p]=h.useState(ma()),f=async C=>{await r.channelManager.addChannel(C),Ne.logChannelCreate(C.name,C.name,!!C.description)},g=C=>{C&&C.preventDefault(),l.trim()&&(f({name:l.trim(),description:d.trim(),emoji:m?.trim()||void 0}),i(!1))},x=async()=>{await f({name:a,description:"",emoji:void 0})},y=()=>{c(""),u(""),i(!1)},v=C=>{C.key==="Enter"&&l.trim()?(C.preventDefault(),g()):C.key==="Escape"&&(C.preventDefault(),y())},w=C=>{i(C),C&&(c(""),u(""),p(ma()))},b=e.jsxs(k,{variant:"outline",className:"w-full h-10 text-muted-foreground hover:text-foreground border-dashed",onClick:n?x:void 0,children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"New Space"]}),N=e.jsxs("div",{className:"space-y-4 pb-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(et,{htmlFor:"emoji",children:"Emoji"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ja,{onSelect:p,children:e.jsx(k,{type:"button",variant:"outline",size:"sm",className:"h-10 w-16 text-sm",children:m||"Select"})}),m&&e.jsx(k,{type:"button",variant:"ghost",size:"sm",onClick:()=>p(""),className:"h-10 px-2 text-muted-foreground",children:"Clear"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(et,{htmlFor:"name",children:"Name"}),e.jsx(_e,{id:"name",value:l,onChange:C=>c(C.target.value),onKeyDown:v,placeholder:"Enter space name",required:!0,autoFocus:t==="popover"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(et,{htmlFor:"description",children:"Description (Optional)"}),t==="dialog"?e.jsx(gs,{id:"description",value:d,onChange:C=>u(C.target.value),placeholder:"Describe what this space is for",rows:3}):e.jsx(_e,{id:"description",value:d,onChange:C=>u(C.target.value),onKeyDown:v,placeholder:"Describe the theme of this space..."})]})]}),j=e.jsxs(e.Fragment,{children:[e.jsx(q.Button,{type:"button",variant:"outline",onClick:y,children:"Cancel"}),e.jsx(q.Button,{type:"submit",variant:"default",disabled:!l.trim(),onClick:g,children:"Create Space"})]});if(n){if(s){if(h.isValidElement(s)){const C=s.props.onClick,E=async R=>{C?.(R),await x()};return h.cloneElement(s,{onClick:E})}return e.jsx("span",{onClick:x,children:s})}return b}return t==="dialog"?e.jsxs(gt,{open:o,onOpenChange:w,children:[e.jsx(ri,{asChild:!0,children:s??b}),e.jsxs(pt,{className:"sm:max-w-md",children:[e.jsxs(hs,{children:[e.jsx(ms,{children:"Create New Thought Space"}),e.jsx(Dn,{children:"Create a new space for organizing your thoughts and conversations."})]}),e.jsxs("form",{onSubmit:g,children:[N,e.jsx(Oa,{className:"gap-2 pt-4",children:j})]})]})]}):e.jsxs(q,{open:o,onOpenChange:w,children:[e.jsx(q.Trigger,{asChild:!0,children:s??b}),e.jsxs(q.Content,{align:"center",side:"bottom",children:[e.jsxs(q.Header,{children:[e.jsx(Me,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:"Create New Thought Space"})]}),e.jsx(q.Body,{children:N}),e.jsx(q.Actions,{children:j})]})]})}const Qa=()=>{const s=O(o=>o.channels),t=Or(s),n=W(o=>o.setCurrentChannel),a=W(o=>o.currentChannelId),r=Or(a);h.useEffect(()=>{const o=t.pipe(Ln(i=>i.length>0),Ws((i,l)=>Xo(i,l)),Hd(r)).subscribe(([i,l])=>{i.length>0&&(!l||!i.some(c=>c.id===l))&&n(i[0].id)});return()=>o.unsubscribe()},[t,r,n])};function to(s){const t=s.lastMessageTime?.getTime(),n=s.updatedAt?.getTime(),a=s.createdAt?.getTime?.()?s.createdAt.getTime():0;return t??n??a??0}function Za(s){return[...s].sort((t,n)=>to(n)-to(t))}function er(s,t){const n=Za(s),a=n.findIndex(r=>r.id===t);if(a>0){const[r]=n.splice(a,1);n.unshift(r)}return n}const so={general:mt,work:Fc,study:zc,ideas:us,personal:To,goals:Uc,team:Ra,default:Lo},Xi=s=>{const t=so[s]||so.default;return e.jsx(t,{className:"w-4 h-4"})};function ap({children:s,trigger:t,triggerClassName:n,contentClassName:a,align:r="end",sideOffset:o=4,width:i="md",alwaysVisible:l=!1}){const c={sm:"w-44",md:"w-52",lg:"w-60",xl:"w-72"},d=e.jsxs(k,{variant:"ghost",size:"sm",className:M("h-8 w-8 p-0 transition-all duration-200 rounded-md","text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200","hover:bg-slate-200/60 dark:hover:bg-slate-700/60","focus:outline-none",l?"opacity-100":"opacity-0 group-hover:opacity-100",n),children:[e.jsx(In,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"More actions"})]});return e.jsxs(Lt,{children:[e.jsx(Rt,{asChild:!0,children:t||d}),e.jsx(Dt,{align:r,className:M("p-1 rounded-xl bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl","min-w-[200px] max-w-[280px]","shadow-[0_0_0_1px_rgba(0,0,0,0.05),0_10px_15px_-3px_rgba(0,0,0,0.1),0_4px_6px_-2px_rgba(0,0,0,0.05)] dark:shadow-[0_0_0_1px_rgba(255,255,255,0.1),0_10px_15px_-3px_rgba(0,0,0,0.3),0_4px_6px_-2px_rgba(0,0,0,0.1)]",c[i],a),sideOffset:o,children:s})]})}function Ji({icon:s,title:t,description:n,onClick:a,variant:r="default",disabled:o=!1,className:i}){const l={default:"text-slate-700 dark:text-slate-200 hover:text-slate-900 dark:hover:text-slate-100 hover:bg-slate-50/40 dark:hover:bg-slate-800/30",destructive:"text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 hover:bg-red-50/40 dark:hover:bg-red-900/5",warning:"text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300 hover:bg-amber-50/40 dark:hover:bg-amber-900/5"},c={default:"text-slate-500 dark:text-slate-400",destructive:"text-red-500 dark:text-red-400",warning:"text-amber-500 dark:text-amber-400"};return e.jsxs(rt,{onClick:o?void 0:a,disabled:o,className:M("flex items-center gap-3 px-3 py-2.5 cursor-pointer transition-all duration-100 group","rounded-lg text-sm font-medium",l[r],o&&"opacity-50 cursor-not-allowed",i),children:[e.jsx("div",{className:M("w-4 h-4 flex-shrink-0 transition-all duration-100",c[r],"group-hover:scale-110 group-hover:rotate-1"),children:s}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"truncate",children:t}),n&&e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400 truncate mt-0.5",children:n})]})]})}function Qi({title:s,children:t,variant:n="default",showSeparator:a=!0,className:r}){const o={default:"text-slate-500 dark:text-slate-400",warning:"text-amber-500 dark:text-amber-400",danger:"text-red-500 dark:text-red-400"};return e.jsxs(e.Fragment,{children:[a&&e.jsx(qa,{className:"my-1 bg-slate-200/50 dark:bg-slate-700/50"}),e.jsxs(zm,{className:M("space-y-0.5",r),children:[s&&e.jsx(zi,{className:M("px-3 py-1.5 text-xs font-medium text-slate-500 dark:text-slate-400",o[n]),children:s}),t]})]})}function Zi({groups:s,trigger:t,triggerClassName:n,contentClassName:a,align:r="end",sideOffset:o=4,width:i="md",alwaysVisible:l=!1}){const c=s.map(d=>({...d,items:d.items.filter(u=>!u.hidden)})).filter(d=>d.items.length>0);return e.jsx(ap,{trigger:t,triggerClassName:n,contentClassName:a,align:r,sideOffset:o,width:i,alwaysVisible:l,children:c.map((d,u)=>e.jsx(Qi,{title:d.title,variant:d.variant,showSeparator:d.showSeparator!==!1&&u>0,children:d.items.map(m=>e.jsx(Ji,{icon:m.icon,title:m.title,description:m.description,onClick:m.onClick,variant:m.variant,disabled:m.disabled},m.id))},d.id))})}function el({groups:s}){const t=s.map(n=>({...n,items:n.items.filter(a=>!a.hidden)})).filter(n=>n.items.length>0);return e.jsx(e.Fragment,{children:t.map((n,a)=>e.jsx(Qi,{title:n.title,variant:n.variant,showSeparator:a>0||n.showSeparator===!0,children:n.items.map(r=>e.jsx(Ji,{icon:r.icon,title:r.title,description:r.description,onClick:r.onClick,variant:r.variant,className:r.disabled?"opacity-50 cursor-not-allowed":""},r.id))},n.id))})}function no({channel:s}){const t=he();return e.jsxs(Lt,{children:[e.jsx(Rt,{asChild:!0,children:e.jsx(k,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 hover:bg-slate-200 dark:hover:bg-slate-600",title:"More actions",onClick:n=>n.stopPropagation(),children:e.jsx(Vs,{className:"h-3 w-3"})})}),e.jsx(Dt,{className:"w-56 p-2",align:"end",side:"bottom",onClick:n=>n.stopPropagation(),children:e.jsx(el,{groups:[{id:"danger",items:[{id:"delete",icon:e.jsx(it,{}),title:`Delete ${s.name}`,onClick:()=>we.confirm({title:"Delete Channel",description:`This will permanently delete the channel "${s.name}" and all its messages. This action cannot be undone.`,okText:"Delete",okLoadingText:"Deleting...",okVariant:"destructive",cancelText:"Cancel",onOk:async()=>{await t.channelManager.deleteChannel(s.id)}}),variant:"default"}]}]})})]})}const Sn=({channel:s,children:t})=>{const n=he(),[a,r]=h.useState(!1),[o,i]=h.useState(s.name),[l,c]=h.useState(s.description),[d,u]=h.useState(s.emoji||""),[m,p]=h.useState(!1);h.useEffect(()=>{a&&(i(s.name),c(s.description),u(s.emoji||""))},[a,s.id,s.name,s.description,s.emoji]);const f=async()=>{if(o.trim()){p(!0);try{const y=o.trim()!==s.name,v=l.trim()!==(s.description||""),w=d.trim()!==(s.emoji||"");await n.channelManager.updateChannel(s.id,{name:o.trim(),description:l.trim(),emoji:d.trim()||void 0}),y&&Ne.logChannelEdit(s.id,Bt.NAME),v&&Ne.logChannelEdit(s.id,Bt.DESCRIPTION),w&&Ne.logChannelEdit(s.id,Bt.EMOJI),r(!1)}catch(y){console.error("Error updating channel:",y),i(s.name),c(s.description),u(s.emoji||"")}finally{p(!1)}}},g=()=>{i(s.name),c(s.description),u(s.emoji||""),r(!1)},x=y=>{y.key==="Enter"&&!m?f():y.key==="Escape"&&g()};return e.jsxs(q,{open:a,onOpenChange:r,children:[e.jsx(q.Trigger,{asChild:!0,children:t}),e.jsxs(q.Content,{align:"center",side:"bottom",children:[e.jsxs(q.Header,{children:[e.jsx(Bc,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:"Edit Thought Space"})]}),e.jsx(q.Body,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(et,{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Emoji"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ja,{value:d,onSelect:u,children:e.jsx(k,{variant:"outline",size:"sm",className:"h-10 w-16 text-lg border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800",children:d||"ðŸ˜Š"})}),d&&e.jsx(k,{variant:"ghost",size:"sm",onClick:()=>u(""),className:"h-10 px-2 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200",children:"Clear"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(et,{htmlFor:"channel-name",className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Channel Name"}),e.jsx(_e,{id:"channel-name",value:o,onChange:y=>i(y.target.value),onKeyDown:x,placeholder:"Enter channel name",disabled:m,className:"h-10 px-3 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg transition-colors duration-200 focus:border-slate-400 dark:focus:border-slate-500  hover:border-slate-300 dark:hover:border-slate-600"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(et,{htmlFor:"channel-description",className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Description"}),e.jsx(_e,{id:"channel-description",value:l,onChange:y=>c(y.target.value),onKeyDown:x,placeholder:"Enter channel description",disabled:m,className:"h-10 px-3 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg transition-colors duration-200 focus:border-slate-400 dark:focus:border-slate-500  hover:border-slate-300 dark:hover:border-slate-600"})]})]})}),e.jsxs(q.Actions,{children:[e.jsx(q.Button,{type:"button",variant:"outline",onClick:g,disabled:m,children:"Cancel"}),e.jsx(q.Button,{type:"button",variant:"default",onClick:f,disabled:!o.trim()||m,children:m?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Saving..."]}):"Save"})]})]})]})},rp=({channel:s,isActive:t,onClick:n})=>{const a=!!(s.description&&s.description.trim());return e.jsx("div",{className:"w-full group cursor-pointer",onClick:n,children:e.jsx("div",{className:`relative px-2.5 py-2 rounded-md transition-colors ${t?"bg-accent/60":"bg-transparent hover:bg-accent/50"}`,children:e.jsxs("div",{className:"flex gap-2.5",children:[e.jsx("div",{className:"w-7 h-7 rounded flex items-center justify-center flex-shrink-0",children:s.emoji?e.jsx("span",{className:"text-lg",title:`Emoji: ${s.emoji}`,children:s.emoji}):Xi(s.id)}),e.jsx("div",{className:`flex-1 min-w-0 ${a?"flex flex-col":"flex items-center justify-between"}`,children:a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:`text-sm font-medium truncate ${t?"text-slate-900 dark:text-slate-100":"text-slate-700 dark:text-slate-300"}`,children:s.name}),e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 flex-shrink-0",children:[e.jsx(Sn,{channel:s,children:e.jsx(k,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 hover:bg-slate-200 dark:hover:bg-slate-700",title:"Edit channel",onClick:r=>r.stopPropagation(),children:e.jsx(Gt,{className:"h-3.5 w-3.5"})})}),e.jsx(no,{channel:s})]})]}),e.jsx("p",{className:`text-xs truncate mt-1 ${t?"text-slate-600 dark:text-slate-400":"text-slate-500 dark:text-slate-500"}`,children:s.description})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:`text-sm font-medium truncate ${t?"text-slate-900 dark:text-slate-100":"text-slate-700 dark:text-slate-300"}`,children:s.name}),e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 flex-shrink-0",children:[e.jsx(Sn,{channel:s,children:e.jsx(k,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 hover:bg-slate-200 dark:hover:bg-slate-700",title:"Edit channel",onClick:r=>r.stopPropagation(),children:e.jsx(Gt,{className:"h-3.5 w-3.5"})})}),e.jsx(no,{channel:s})]})]})})]})})})},op=()=>{const s=he(),t=async n=>{await s.channelManager.addChannel(n),Ne.logChannelCreate(n.name,n.name,!!n.description)};return e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4",children:e.jsx(Me,{className:"w-8 h-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No spaces yet"}),e.jsx("p",{className:"text-muted-foreground text-sm mb-4 max-w-xs",children:"Create your first thought space to start organizing your ideas and thoughts."}),e.jsx("button",{onClick:()=>t({name:"My First Space",emoji:"ðŸš€",description:"Start your journey here"}),className:"text-sm text-primary hover:text-primary/80 font-medium",children:"Create your first space"})]})};function ip({count:s=12}){return e.jsxs("div",{"data-component":"channel-list",className:"w-full h-full overflow-hidden flex flex-col bg-card shadow-sm",children:[e.jsxs("div",{"data-component":"channel-list-header",className:"h-12 px-4 flex items-center justify-between",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx(F,{className:"h-5 w-16"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-8 w-8 rounded-md"}),e.jsx(F,{className:"h-8 w-8 rounded-md"}),e.jsx(jn.ToggleButton,{})]})]}),e.jsx("div",{"data-component":"channel-list-content",className:"flex-1 overflow-y-auto p-3 space-y-1 min-h-0 channel-list-content",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:Array.from({length:s}).map((t,n)=>e.jsx("div",{className:"w-full group transition-all duration-200 cursor-pointer",children:e.jsx("div",{className:"relative p-3 rounded-lg transition-all duration-200 bg-transparent",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(F,{className:"w-8 h-8 rounded-lg flex-shrink-0"}),e.jsxs("div",{className:"flex-1 text-left min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx(F,{className:"w-20 h-4"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(F,{className:"w-24 h-3"}),e.jsx(F,{className:"w-16 h-3"})]})]}),e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1",children:[e.jsx(F,{className:"w-6 h-6 rounded"}),e.jsx(F,{className:"w-6 h-6 rounded"})]})]})})},n))}),e.jsx("div",{"data-component":"channel-list-footer",className:"p-3 border-t border-slate-200 dark:border-slate-700",children:e.jsx(F,{className:"w-full h-10 rounded-lg"})})]})}class lp{docs=new Map;byChannelCount=new Map;indexNotes(t){this.docs.clear(),this.byChannelCount.clear();for(const n of t)n.isDeleted||(this.docs.set(n.id,n),this.byChannelCount.set(n.channelId,(this.byChannelCount.get(n.channelId)||0)+1))}upsertNote(t){const n=this.docs.get(t.id);if(!t.isDeleted)this.docs.set(t.id,t),n||this.byChannelCount.set(t.channelId,(this.byChannelCount.get(t.channelId)||0)+1);else if(this.docs.delete(t.id),n){const a=(this.byChannelCount.get(n.channelId)||1)-1;a>0?this.byChannelCount.set(n.channelId,a):this.byChannelCount.delete(n.channelId)}}upsertNotes(t){for(const n of t)this.upsertNote(n)}search(t,n){const a=(t||"").trim().toLowerCase();if(!a)return[];const r=n?.channelIds?new Set(n.channelIds):null,o=[];for(const i of this.docs.values()){if(r&&!r.has(i.channelId))continue;const l=this.scoreNote(i,a);l.score>0&&o.push(l)}return o.sort((i,l)=>l.score-i.score||l.timestamp.getTime()-i.timestamp.getTime()),n?.limit?o.slice(0,n.limit):o}getChannelDocCount(t){return this.byChannelCount.get(t)||0}getIndexedChannelIds(){return Array.from(this.byChannelCount.keys())}getTotalDocs(){return this.docs.size}scoreNote(t,n){const a=[];let r=0;const o=(t.content||"").toLowerCase(),i=this.countOccurrences(o,n);i>0&&(a.push("content"),r+=i*10);const c=(t.tags||[]).map(f=>f.toLowerCase()).filter(f=>f.includes(n)).length;c>0&&(a.push("tags"),r+=c*6);const u=(t.aiAnalysis?.keywords||[]).map(f=>f.toLowerCase()).filter(f=>f.includes(n)).length;u>0&&(a.push("keywords"),r+=u*5);const m=(t.aiAnalysis?.summary||"").toLowerCase(),p=this.countOccurrences(m,n);return p>0&&(a.push("summary"),r+=p*3),{id:t.id,channelId:t.channelId,score:r,snippet:this.buildSnippet(t.content,n),matchedFields:a,timestamp:t.timestamp}}countOccurrences(t,n){if(!t||!n)return 0;let a=0,r=0;for(;(r=t.indexOf(n,r))!==-1;)a++,r+=n.length;return a}buildSnippet(t,n){const a=t||"",o=a.toLowerCase().indexOf(n);if(o===-1)return;const i=Math.max(0,o-30),l=Math.min(a.length,o+n.length+30),c=a.slice(i,l),d=i>0?"â€¦":"",u=l<a.length?"â€¦":"";return d+c+u}}const Xn={limits:{maxResults:50},ui:{debounceMs:150,minQueryLength:1}};class cp{searchIndex;searchQuery$=new dt("");searchFilters$=new dt({});indexStats$=new dt({totalDocs:0,indexedChannelIds:[]});indexedDataHash="";isIndexing=!1;constructor(){this.searchIndex=new lp,this.initializeIndex()}search(t,n){return this.searchQuery$.next(t),n&&this.searchFilters$.next(n),Fo([Ze.getNotes(this.searchFilters$.value),this.searchQuery$.pipe(da(Xn.ui.debounceMs),Ws())]).pipe(Ft(([a,r])=>!r||r.trim().length<Xn.ui.minQueryLength?[]:(this.updateIndexIfNeeded(a),this.searchIndex.search(r,{channelIds:this.searchFilters$.value.channelIds,limit:Xn.limits.maxResults}))))}async updateAllData(){await Ze.updateAll()}async updateChannelData(t){await Ze.updateChannel(t)}async preIndexData(){if(!this.isIndexing){this.isIndexing=!0;try{const t=await Is(Ze.getNotes());t&&(this.searchIndex.indexNotes(t),this.indexedDataHash=this.calculateDataHash(t),this.updateIndexStats())}finally{this.isIndexing=!1}}}async preIndexChannel(t){if(!this.isIndexing){this.isIndexing=!0;try{const n=await Is(Ze.getNotes({channelIds:[t]}));if(n){this.searchIndex.upsertNotes(n);const a=await Is(Ze.getNotes());this.indexedDataHash=this.calculateDataHash(a),this.updateIndexStats()}}finally{this.isIndexing=!1}}}getIndexStats(){return{totalDocs:this.searchIndex.getTotalDocs(),indexedChannelIds:this.searchIndex.getIndexedChannelIds()}}getIndexStats$(){return this.indexStats$.asObservable()}initializeIndex(){Ze.getNotes().subscribe(t=>{this.updateIndexIfNeeded(t);const n=this.getIndexStats();typeof window<"u"&&console.debug("[NoteSearchService] notes updated, index stats",n)})}updateIndexIfNeeded(t){const n=this.calculateDataHash(t);n!==this.indexedDataHash&&(this.searchIndex.indexNotes(t),this.indexedDataHash=n,this.updateIndexStats())}updateIndexStats(){this.indexStats$.next({totalDocs:this.searchIndex.getTotalDocs(),indexedChannelIds:this.searchIndex.getIndexedChannelIds()})}calculateDataHash(t){const n=JSON.stringify(t.map(r=>{const o=r;return{id:o.id,content:o.content,tags:o.tags,aiAnalysis:o.aiAnalysis,timestamp:o.timestamp}}));let a=0;for(let r=0;r<n.length;r++){const o=n.charCodeAt(r);a=(a<<5)-a+o,a=a&a}return a.toString()}}const yt=new cp;function dp({items:s,activeIndex:t,setActiveIndex:n,onSelect:a,onEscape:r,onTab:o,enabled:i=!0}){h.useEffect(()=>{if(!i)return;const l=c=>{if(c.key==="Escape"){c.preventDefault(),r?.();return}if(c.key==="ArrowDown"){c.preventDefault(),n(d=>Math.min(d+1,Math.max(0,s.length-1)));return}if(c.key==="ArrowUp"){c.preventDefault(),n(d=>Math.max(0,d-1));return}if(c.key==="Tab"){c.preventDefault(),o?.();return}c.key==="Enter"&&s[t]&&(c.preventDefault(),a?.(s[t],t))};return window.addEventListener("keydown",l),()=>window.removeEventListener("keydown",l)},[s,t,n,a,r,o,i])}function up({onSwipeLeft:s,onSwipeRight:t,onSwipeUp:n,onSwipeDown:a,threshold:r=50,enabled:o=!0}){h.useEffect(()=>{if(!o)return;let i=0,l=0,c=!1;const d=p=>{i=p.touches[0].clientY,l=p.touches[0].clientX,c=!1},u=p=>{if(!c){const f=Math.abs(p.touches[0].clientY-i),g=Math.abs(p.touches[0].clientX-l);c=g>f&&g>10}},m=p=>{if(c){const f=p.changedTouches[0].clientX-l,g=p.changedTouches[0].clientY-i;Math.abs(f)>r?(p.preventDefault(),f>0?t?.():s?.()):Math.abs(g)>r&&(p.preventDefault(),g>0?a?.():n?.())}};return document.addEventListener("touchstart",d,{passive:!0}),document.addEventListener("touchmove",u,{passive:!0}),document.addEventListener("touchend",m,{passive:!1}),()=>{document.removeEventListener("touchstart",d),document.removeEventListener("touchmove",u),document.removeEventListener("touchend",m)}},[s,t,n,a,r,o])}function hp({activeId:s,scrollBehavior:t="smooth",block:n="nearest",enabled:a=!0}){h.useEffect(()=>{if(!a||!s)return;const r=document.getElementById(s);r&&r.scrollIntoView({behavior:t,block:n})},[s,t,n,a])}function mp({operation:s,onSuccess:t,onError:n}){const[a,r]=h.useState(!1),[o,i]=h.useState(null);return{execute:h.useCallback(async()=>{if(!a){r(!0),i(null);try{const c=await s();return t?.(c),c}catch(c){const d=c instanceof Error?c:new Error(String(c));throw i(d),n?.(d),d}finally{r(!1)}}},[s,t,n,a]),isLoading:a,error:o}}function gp({q:s,setQ:t,scope:n,setScope:a,indexing:r}){const o=h.useRef(null);h.useEffect(()=>{setTimeout(()=>o.current?.focus(),0)},[]);const i=r&&n==="all";return e.jsxs("div",{className:"sticky top-0 z-10 bg-background shrink-0",children:[e.jsx("div",{className:"h-[env(safe-area-inset-top)] sm:hidden"}),e.jsxs("div",{className:"px-4 py-3 sm:px-6 sm:py-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Fe,{className:"absolute left-0 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground/50"}),e.jsx("input",{ref:o,type:"text",placeholder:n==="current"?"Search current spaceâ€¦":"Search all spacesâ€¦",value:s,onChange:l=>t(l.target.value),className:"w-full h-auto py-2 pl-7 pr-9 bg-transparent border-0 text-base placeholder:text-muted-foreground/50 focus:outline-none focus:ring-0 transition-all duration-200"}),s&&e.jsx("button",{className:"absolute right-0 top-1/2 -translate-y-1/2 h-6 w-6 inline-flex items-center justify-center rounded hover:bg-muted/50 text-muted-foreground hover:text-foreground transition-colors",onClick:()=>t(""),"aria-label":"Clear search",children:e.jsx(le,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center gap-0.5 rounded-md bg-muted/30 p-0.5 shrink-0",children:[e.jsx("button",{role:"radio","aria-checked":n==="current",className:`px-2 py-0.5 text-sm font-medium rounded transition-all duration-150 ${n==="current"?"bg-background text-foreground":"text-muted-foreground hover:text-foreground"}`,onClick:()=>a("current"),children:"Current"}),e.jsx("button",{role:"radio","aria-checked":n==="all",className:`px-2 py-0.5 text-sm font-medium rounded transition-all duration-150 ${n==="all"?"bg-background text-foreground":"text-muted-foreground hover:text-foreground"}`,onClick:()=>a("all"),children:"All"})]})]}),i&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1 bg-muted/30 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary animate-pulse",style:{width:"30%"}})}),e.jsx("span",{className:"text-xs text-muted-foreground/60 whitespace-nowrap",children:"Indexingâ€¦"})]})]})]})}function pp(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function fp({text:s,query:t}){if(!s||!t)return e.jsx(e.Fragment,{children:s});const n=pp(t);try{const a=new RegExp(`(${n})`,"ig"),r=s.split(a);return e.jsx(e.Fragment,{children:r.map((o,i)=>o.toLowerCase()===t.toLowerCase()?e.jsx("mark",{className:"bg-yellow-200/80 dark:bg-yellow-600/50 text-foreground rounded px-0.5",children:o},i):e.jsx("span",{children:o},i))})}catch{return e.jsx(e.Fragment,{children:s})}}function xp({results:s,activeIndex:t,setActiveIndex:n,onPick:a,channelName:r,q:o}){return e.jsx("div",{className:"flex-1 py-2",children:s.map((i,l)=>{const c=l===t,d=Zd(new Date(i.timestamp),{addSuffix:!0});return e.jsx("button",{id:i.id,type:"button",role:"option","aria-selected":c,className:`relative w-full text-left px-4 py-2.5 rounded transition-colors duration-150 ${c?"bg-muted/50":"hover:bg-muted/30"}`,onMouseEnter:()=>n(l),onClick:()=>a(i.id,i.channelId),children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground/80",children:r(i.channelId)}),e.jsx("span",{className:"text-xs text-foreground/50",children:"Â·"}),e.jsx("span",{className:"text-xs text-foreground/50",children:d})]}),e.jsx("div",{className:"text-sm text-foreground/70 leading-relaxed",children:i.snippet?e.jsx(fp,{text:i.snippet,query:o}):"(no preview)"})]})},i.id)})})}function bp({q:s,scope:t,isRefreshing:n,onRefresh:a}){return s.trim()===""?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center py-16 px-6 text-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-muted/30 flex items-center justify-center mb-4",children:e.jsx(Fe,{className:"h-6 w-6 text-muted-foreground/50"})}),e.jsxs("p",{className:"text-sm text-muted-foreground/70",children:["Search ",t==="current"?"current space":"all spaces"]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center py-16 px-6 text-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl bg-muted/30 flex items-center justify-center mb-4",children:e.jsx(Fe,{className:"h-6 w-6 text-muted-foreground/50"})}),e.jsx("p",{className:"text-sm text-muted-foreground/70 mb-4",children:"No results found"}),e.jsx("button",{onClick:a,disabled:n,className:"text-xs text-muted-foreground/60 hover:text-foreground transition-colors disabled:opacity-50",children:n?"Refreshing...":"Refresh index"})]})}function vp({onClose:s,defaultScope:t="current"}){const{currentChannelId:n}=W(),a=O(E=>E.channels),r=he(),[o,i]=h.useState(""),[l,c]=h.useState(t),[d,u]=h.useState([]),[m,p]=h.useState(!1),[f,g]=h.useState(0),x=h.useRef(null),y=h.useMemo(()=>l==="current"&&n?[n]:void 0,[l,n]);h.useEffect(()=>{let E=!1;return(async()=>l==="all"&&(p(!0),await yt.updateAllData(),await yt.preIndexData(),E||p(!1)))(),()=>{E=!0}},[l]),h.useEffect(()=>{let E=!1;return(async()=>{if(l!=="current"||!n)return;console.debug("[QuickSearch] current scope pre-index start",{currentChannelId:n}),p(!0),await yt.updateChannelData(n),await yt.preIndexChannel(n);const R=yt.getIndexStats();console.debug("[QuickSearch] current scope pre-index done",{stats:R}),E||p(!1)})(),()=>{E=!0}},[l,n]);const v=E=>a.find(R=>R.id===E)?.name||E,w=h.useCallback((E,R)=>{s(),r.rxEventBus.requestJumpToMessage$.emit({channelId:R,messageId:E})},[s,r.rxEventBus.requestJumpToMessage$]);dp({items:d,activeIndex:f,setActiveIndex:g,onSelect:E=>w(E.id,E.channelId),onEscape:s,onTab:()=>c(E=>E==="current"?"all":"current")}),up({onSwipeLeft:()=>c("all"),onSwipeRight:()=>c("current")}),hp({activeId:d[f]?.id||null});const b=h.useMemo(()=>yt.search(o,{channelIds:y}),[o,y]),N=yi(b,[]);h.useEffect(()=>{u(N),g(0),o&&console.debug("[QuickSearch] search results",{q:o,scope:l,channelIds:y,count:N.length})},[N,o,l,y]);const{execute:j,isLoading:C}=mp({operation:async()=>{await yt.updateAllData(),await yt.preIndexData()}});return e.jsxs("div",{className:"flex flex-col w-full h-full min-h-0",children:[e.jsx(gp,{q:o,setQ:i,scope:l,setScope:c,indexing:m}),e.jsx("div",{ref:x,className:"flex-1 min-h-0 overflow-y-auto overscroll-contain flex flex-col",role:"listbox","aria-activedescendant":d[f]?.id,children:o.trim()===""||d.length===0?e.jsx(bp,{q:o,scope:l,isRefreshing:C,onRefresh:j}):e.jsx(xp,{results:d,activeIndex:f,setActiveIndex:g,onPick:w,channelName:v,q:o})}),e.jsx("div",{className:"px-4 py-2 sm:px-6 sm:py-3 shrink-0 border-t border-border/40",children:e.jsxs("div",{className:"flex items-center justify-center gap-4 text-xs text-muted-foreground/60",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted/50 rounded text-xs font-mono",children:"â†‘"}),e.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted/50 rounded text-xs font-mono",children:"â†“"}),e.jsx("span",{children:"Navigate"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted/50 rounded text-xs font-mono",children:"Enter"}),e.jsx("span",{children:"Open"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("kbd",{className:"px-1.5 py-0.5 bg-muted/50 rounded text-xs font-mono",children:"Esc"}),e.jsx("span",{children:"Close"})]})]})})]})}function Gs(s){const{defaultScope:t="current"}=s||{};let n=null;return n=ji.show({content:e.jsx(vp,{onClose:()=>n?.close(),defaultScope:t}),className:["w-screen max-w-none h-svh max-h-none rounded-none","sm:w-full sm:rounded-xl","sm:max-w-2xl","sm:h-[70vh] sm:max-h-[70vh]"].join(" "),position:"top",topOffset:96}),n}function yp({showFadeEffect:s=!1}){const t=he(),n=O(d=>d.channels),a=O(d=>d.channelsLoading),r=W(d=>d.currentChannelId),o=h.useRef(null),[i,l]=h.useState(!1);Qa();const c=h.useMemo(()=>Za(n),[n]);return h.useEffect(()=>{if(o.current){const{scrollHeight:d,clientHeight:u}=o.current;l(d>u)}}),a?e.jsx(ip,{}):e.jsxs("div",{"data-component":"channel-list",className:"flex flex-col h-full overflow-hidden bg-card",children:[e.jsxs("div",{"data-component":"channel-list-header",className:"h-11 px-4 flex items-center justify-between border-b border-slate-200/50 dark:border-slate-700/50",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("h3",{className:"text-sm font-semibold text-slate-900 dark:text-slate-100 truncate",children:"Spaces"})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("button",{type:"button",onClick:()=>Gs({defaultScope:"all"}),className:"h-7 w-7 inline-flex items-center justify-center rounded-md hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors","aria-label":"Search all notes",title:"Search all notes (Cmd/Ctrl+K)",children:e.jsx(Fe,{className:"w-4 h-4"})}),e.jsx(Hs,{instantCreate:!0,trigger:e.jsx("button",{type:"button",className:"h-7 w-7 inline-flex items-center justify-center rounded-md hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors","aria-label":"New space",title:"New space",children:e.jsx(Me,{className:"w-4 h-4"})})}),e.jsx(jn.ToggleButton,{})]})]}),e.jsx("div",{ref:o,"data-component":"channel-list-content",className:"flex-1 overflow-y-auto px-2.5 py-2 space-y-1 min-h-0 channel-list-content",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:c.length===0?e.jsx(op,{}):c.map(d=>e.jsx(rp,{channel:d,isActive:r===d.id,onClick:()=>{Ne.logChannelSelect(d.id,d.name,d.messageCount||0),t.viewStateManager.setCurrentChannel(d.id)}},d.id))}),i&&s&&e.jsx("div",{className:"relative",children:e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-6 bg-gradient-to-t from-slate-100/90 dark:from-slate-800/90 to-transparent pointer-events-none"})})]})}function wp(){return h.useEffect(()=>{const s=t=>{(navigator.platform.toUpperCase().includes("MAC")?t.metaKey:t.ctrlKey)&&(t.key==="k"||t.key==="K")&&(t.preventDefault(),Gs())};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[]),null}function tr(s){let t=0;for(let a=0;a<s.length;a+=1)t=Math.imul(31,t)+s.charCodeAt(a),t|=0;return(t>>>0).toString(16).padStart(8,"0")}const X=Ee()(At((s,t)=>({editingMessageId:null,editContent:"",originalContent:"",isDirty:!1,isSaving:!1,baseHash:null,showDraftPrompt:!1,restoredFromDraft:!1,drafts:{},editMode:"inline",editorMode:"wysiwyg",startEditing:(n,a,r)=>{const o=r?.baseHash??tr(a),i=t().drafts[n],l=!!i&&i.baseHash===o;i&&!l&&s(m=>{const p={...m.drafts};return delete p[n],{drafts:p}});const c=!!r?.restoreDraft&&l,d=c&&i?i.content:a,u=t().editorMode;s({editingMessageId:n,editContent:d,originalContent:a,isDirty:d!==a,isSaving:!1,baseHash:o,showDraftPrompt:l&&!c,restoredFromDraft:c,editMode:"inline",editorMode:u})},updateContent:n=>{const a=t();if(!a.editingMessageId)return;const r=a.editingMessageId,o=n.trim(),i=a.originalContent.trim(),l=o!==i,c=l&&o.length>0,d=a.drafts[r];a.editContent===n&&a.isDirty===l&&(c&&d&&d.content===n||!c&&(!d||a.showDraftPrompt))||s(m=>{let p=m.drafts;if(c&&m.baseHash){const g=m.drafts[r];(!g||g.content!==n||g.baseHash!==m.baseHash)&&(p={...m.drafts,[r]:{content:n,baseHash:m.baseHash,updatedAt:Date.now()}})}else if(m.drafts[r]&&(!m.showDraftPrompt||m.restoredFromDraft)){const{[r]:g,...x}=m.drafts;p=x}const f=50;if(Object.keys(p).length>f){const x=Object.entries(p).sort((y,v)=>(v[1].updatedAt||0)-(y[1].updatedAt||0)).slice(0,f);p=Object.fromEntries(x)}return{editContent:n,isDirty:l,drafts:p,showDraftPrompt:!1}})},switchToExpandedMode:()=>{s({editMode:"expanded"})},switchToInlineMode:()=>{s({editMode:"inline"})},setEditorMode:n=>{s({editorMode:n})},save:async(n=!0)=>{const{editingMessageId:a,editContent:r}=t();if(!(!a||!r.trim())){s({isSaving:!0});try{const{userId:o}=O.getState();if(!o)throw new Error("User not authenticated");const{currentChannelId:i}=W.getState();if(!i)throw new Error("No current channel selected");await V.updateMessage({messageId:a,channelId:i,updates:{content:r.trim()},userId:o}),t().clearDraft(a),n?t().reset():s({isSaving:!1,isDirty:!1,originalContent:r.trim(),restoredFromDraft:!1})}catch(o){console.error("Failed to save message:",o)}finally{n&&s({isSaving:!1})}}},cancel:()=>{t().reset()},reset:()=>{s({editingMessageId:null,editContent:"",originalContent:"",isDirty:!1,isSaving:!1,baseHash:null,showDraftPrompt:!1,restoredFromDraft:!1,editMode:"inline",editorMode:"wysiwyg"})},applyDraft:()=>{const{editingMessageId:n,drafts:a,originalContent:r}=t();if(!n)return;const o=a[n];o&&s({editContent:o.content,isDirty:o.content!==r,showDraftPrompt:!1,restoredFromDraft:!0})},dismissDraftPrompt:()=>{const{editingMessageId:n}=t();s(a=>{let r=a.drafts;if(n&&a.drafts[n]){const{[n]:o,...i}=a.drafts;r=i}return r===a.drafts?{showDraftPrompt:!1}:{showDraftPrompt:!1,drafts:r}})},clearDraft:n=>{s(a=>{if(!a.drafts[n])return{};const r={...a.drafts};return delete r[n],{drafts:r}})}}),{name:"echonote-edit-state-storage",partialize:s=>({drafts:s.drafts,editorMode:s.editorMode})}));function jp({isOpen:s,onClose:t,content:n,title:a,onDownload:r,showDownload:o=!0}){const[i,l]=h.useState(!1),[c,d]=h.useState(!1);return h.useEffect(()=>{if(s){l(!1),d(!0);const u=setTimeout(()=>l(!0),100);return()=>clearTimeout(u)}},[s]),h.useEffect(()=>{if(s&&c){const u=setTimeout(()=>d(!1),3e3);return()=>clearTimeout(u)}},[s,c]),h.useEffect(()=>(s?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[s]),h.useEffect(()=>{const u=m=>{m.key==="Escape"&&s&&t()};return s&&document.addEventListener("keydown",u),()=>{document.removeEventListener("keydown",u)}},[s,t]),s?e.jsxs("div",{className:"fixed inset-0 z-[9999] bg-black/95 backdrop-blur-sm",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx("div",{className:`relative w-full h-full flex items-center justify-center transition-all duration-300 ${i?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"relative w-full h-full flex items-center justify-center overflow-hidden bg-white dark:bg-gray-900 rounded-lg p-4",children:e.jsx("div",{className:"w-full h-full flex items-center justify-center [&_svg]:max-w-full [&_svg]:max-h-full [&_svg]:w-auto [&_svg]:h-auto",dangerouslySetInnerHTML:{__html:n}})})})}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-4",children:[a&&e.jsx("div",{className:"text-white/90 text-sm font-medium truncate max-w-[60%] bg-black/50 backdrop-blur-sm rounded-full px-3 py-1",children:a}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[o&&r&&e.jsx(k,{variant:"ghost",size:"sm",onClick:r,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(Kt,{className:"w-4 h-4"})}),e.jsx(k,{variant:"ghost",size:"sm",onClick:t,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(le,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"absolute inset-0 -z-10",onClick:t,"aria-label":"Close viewer"}),e.jsxs("div",{className:`absolute top-16 left-1/2 transform -translate-x-1/2 bg-black/50 backdrop-blur-sm rounded-full px-4 py-2 text-white/60 text-xs transition-all duration-500 ${c?"opacity-100 translate-y-0":"opacity-0 -translate-y-2 pointer-events-none"}`,children:["Press ",e.jsx("kbd",{className:"px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono",children:"ESC"})," to close"]})]}):null}function Np({code:s}){const[t,n]=h.useState(null),[a,r]=h.useState(null),[o,i]=h.useState(!1),l=h.useRef(null),c=h.useMemo(()=>`mermaid-${Math.random().toString(36).slice(2)}`,[]),[d,u]=h.useState(!1),[m,p]=h.useState(!1);h.useEffect(()=>{let x=!1;async function y(){try{const v=await ne(()=>import("./pkg-mermaid-CO65k8p_.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49])),w=document.documentElement.classList.contains("dark");v.default.initialize({startOnLoad:!1,securityLevel:"loose",theme:w?"dark":"default"});const{svg:b,bindFunctions:N}=await v.default.render(c,s);if(x)return;n(b),N&&l.current&&N(l.current)}catch(v){if(x)return;const w=typeof v=="object"&&v&&"message"in v?String(v.message):"Failed to render mermaid diagram";r(w)}}return y(),()=>{x=!0}},[s,c]);const f=async()=>{try{await navigator.clipboard.writeText(s),i(!0),setTimeout(()=>i(!1),1500)}catch(x){console.warn("Copy mermaid source failed:",x)}},g=()=>{if(t)try{const x=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),y=URL.createObjectURL(x),v=document.createElement("a");v.href=y,v.download="diagram.svg",document.body.appendChild(v),v.click(),v.remove(),URL.revokeObjectURL(y)}catch(x){console.warn("Download SVG failed:",x)}};return a?e.jsxs("div",{className:"group/code relative my-4",children:[e.jsxs("div",{className:"flex items-center justify-between bg-slate-100 dark:bg-gray-900 border border-slate-200 dark:border-gray-700 rounded-t px-2 py-1",children:[e.jsx("span",{className:"text-[11px] font-medium uppercase tracking-wide text-slate-600 dark:text-gray-300",children:"MERMAID"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>p(x=>!x),className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:m?"View diagram":"View source",children:m?e.jsx(rs,{className:"w-3 h-3"}):e.jsx(vr,{className:"w-3 h-3"})}),e.jsx("button",{onClick:f,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:o?"Copied!":"Copy source",children:o?e.jsx(Ye,{className:"w-3 h-3"}):e.jsx(os,{className:"w-3 h-3"})})]})]}),m?e.jsx("pre",{className:"bg-slate-50 dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700 border-t-0",children:e.jsx("code",{className:"text-sm leading-relaxed font-mono text-slate-800 dark:text-gray-200 whitespace-pre",children:s})}):e.jsx("div",{className:"bg-white dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700",children:e.jsx("code",{className:"text-sm text-red-400",children:"Failed to render mermaid diagram"})})]}):e.jsxs("div",{className:"group/code relative my-4",ref:l,children:[e.jsxs("div",{className:"flex items-center justify-between bg-slate-100 dark:bg-gray-900 border border-slate-200 dark:border-gray-700 rounded-t px-2 py-1",children:[e.jsx("span",{className:"text-[11px] font-medium uppercase tracking-wide text-slate-600 dark:text-gray-300",children:"MERMAID"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>p(x=>!x),className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:m?"View diagram":"View source",children:m?e.jsx(rs,{className:"w-3 h-3"}):e.jsx(vr,{className:"w-3 h-3"})}),!m&&e.jsx("button",{onClick:()=>u(!0),className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:"View larger",children:e.jsx(qs,{className:"w-3 h-3"})}),e.jsx("button",{onClick:m?()=>{try{const x=new Blob([s],{type:"text/plain;charset=utf-8"}),y=URL.createObjectURL(x),v=document.createElement("a");v.href=y,v.download="diagram.mmd",document.body.appendChild(v),v.click(),v.remove(),URL.revokeObjectURL(y)}catch(x){console.warn("Download mmd failed:",x)}}:g,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:m?"Download .mmd":"Download SVG",children:e.jsx(Kt,{className:"w-3 h-3"})}),e.jsx("button",{onClick:f,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:o?"Copied!":"Copy source",children:o?e.jsx(Ye,{className:"w-3 h-3"}):e.jsx(os,{className:"w-3 h-3"})})]})]}),m?e.jsx("pre",{className:"bg-slate-50 dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700",children:e.jsx("code",{className:"text-sm leading-relaxed font-mono text-slate-800 dark:text-gray-200 whitespace-pre",children:s})}):e.jsx("div",{className:"bg-white dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700 border-t-0 cursor-zoom-in",onDoubleClick:()=>u(!0),dangerouslySetInnerHTML:{__html:t||""}}),e.jsx(jp,{isOpen:d,onClose:()=>u(!1),content:t||"",title:"Diagram Preview",onDownload:g,showDownload:!!t})]})}const Cp={javascript:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.j),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),jsx:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.a),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),typescript:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.t),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),tsx:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.b),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),json:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.c),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),bash:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.d),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),shell:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.d),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),sh:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.d),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),yaml:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.y),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),yml:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.y),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),markdown:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.m),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),md:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.m),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),css:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.e),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),scss:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.s),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),html:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.f),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),xml:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.f),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),graphql:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.g),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),go:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.i),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),java:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.k),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),python:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.p),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),ruby:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.r),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),rust:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.l),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),php:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.n),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),c:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.q),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),cpp:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.u),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),docker:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.w),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),nginx:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.x),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),sql:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.z),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68])),diff:()=>ne(()=>import("./pkg-react-syntax-highlighter-CV6PWkyB.js").then(s=>s.A),__vite__mapDeps([50,51,28,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68]))},ka=new Set,Jn={};async function kp(s){if(!s)return;const t=s.toLowerCase();if(t==="mermaid"||ka.has(t))return;const n=Cp[t];n&&(Jn[t]||(Jn[t]=n().then(a=>{const o=a.default??a;Jo.registerLanguage(t,o),ka.add(t)}).catch(a=>{console.warn("Failed to load prism language:",t,a)})),await Jn[t])}const ao=s=>{const t=/language-([a-z0-9]+)/i.exec(s||"");return t?t[1]:""},Sa=s=>typeof s=="string"||typeof s=="number"?String(s):Array.isArray(s)?s.map(Sa).join(""):h.isValidElement(s)?Sa(s.props.children):"",Sp=s=>Sa(s).replace(/\n$/,""),Mp=({code:s,languageHint:t,containerClassName:n})=>{const a=t.toLowerCase(),[r,o]=h.useState(0),[i,l]=h.useState(()=>typeof document<"u"?document.documentElement.classList.contains("dark"):!1),[c,d]=h.useState(!1),u=!!(a&&ka.has(a));h.useMemo(()=>{!a||a==="mermaid"||(async()=>(await kp(a),o(p=>p+1)))()},[a]),h.useEffect(()=>{if(typeof document>"u")return;const p=document.documentElement,f=()=>l(p.classList.contains("dark"));f();const g=new MutationObserver(f);return g.observe(p,{attributes:!0,attributeFilter:["class"]}),()=>g.disconnect()},[]);const m=async()=>{try{await navigator.clipboard.writeText(s),d(!0),setTimeout(()=>d(!1),2e3)}catch(p){console.error("Failed to copy code:",p)}};return e.jsxs("div",{className:["group/code relative my-4",n].filter(Boolean).join(" "),children:[e.jsxs("div",{className:"flex items-center justify-between bg-slate-100 dark:bg-gray-900 border border-slate-200 dark:border-gray-700 rounded-t px-2 py-1",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("span",{className:"text-[11px] font-medium uppercase tracking-wide text-slate-600 dark:text-gray-300",children:t||"text"})}),e.jsx("button",{onClick:m,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:c?"Copied!":"Copy code",children:c?e.jsx(Ye,{className:"w-3 h-3"}):e.jsx(os,{className:"w-3 h-3"})})]}),u?e.jsx(Jo,{style:i?iu:lu,language:a,PreTag:"div",className:"rounded-b overflow-auto w-full max-w-full min-w-0 border border-slate-200 dark:border-gray-700 border-t-0",wrapLongLines:!0,customStyle:{whiteSpace:"pre",overflowX:"auto",overflowY:"auto",background:i?"#0b0b0b":"#f8fafc",margin:0,padding:"0.75rem"},children:s},r):e.jsx("pre",{className:"bg-slate-50 dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700 border-t-0",children:e.jsx("code",{className:"text-sm leading-relaxed font-mono text-slate-800 dark:text-gray-200",children:s})})]})},Ep=({children:s,className:t})=>{const n=h.Children.toArray(s),a=ao(t)||n.reduce((o,i)=>o||h.isValidElement(i)&&typeof i.props.className=="string"&&ao(i.props.className)||o,""),r=Sp(s);return r?a.toLowerCase()==="mermaid"?e.jsx(Np,{code:r}):e.jsx(Mp,{code:r,languageHint:a,containerClassName:t}):e.jsx("pre",{className:t,children:s})},Ip=({className:s,children:t,...n})=>e.jsx("code",{className:`inline-block bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-1.5 py-0.5 rounded text-sm font-mono border border-gray-300 dark:border-gray-600${s?` ${s}`:""}`,...n,children:t});function Tp({className:s,...t}){return e.jsx(hc,{"data-slot":"checkbox",className:M("peer border-slate-300 dark:border-slate-600 dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",s),...t,children:e.jsx(mc,{"data-slot":"checkbox-indicator",className:"flex items-center justify-center text-current transition-none",children:e.jsx(Ye,{className:"size-3.5"})})})}function Ap({minScale:s=.1,maxScale:t=5,initialScale:n=1}={}){const[a,r]=h.useState(n),[o,i]=h.useState({x:0,y:0}),[l,c]=h.useState(!1),[d,u]=h.useState({x:0,y:0}),[m,p]=h.useState(0),f=h.useCallback(j=>{a>1&&(c(!0),u({x:j.clientX-o.x,y:j.clientY-o.y}))},[a,o]),g=h.useCallback(j=>{l&&a>1&&i({x:j.clientX-d.x,y:j.clientY-d.y})},[l,a,d]),x=h.useCallback(()=>{c(!1)},[]),y=h.useCallback(j=>{j.preventDefault();const C=Date.now();if(C-m<16)return;p(C);const E=Math.abs(j.deltaY);let R;E<50?R=j.deltaY>0?.98:1.02:E<100?R=j.deltaY>0?.96:1.04:R=j.deltaY>0?.94:1.06;const T=Math.max(s,Math.min(t,a*R));r(T),T<=1&&i({x:0,y:0})},[m,a,s,t]),v=h.useCallback(()=>{r(j=>Math.min(t,j*1.1))},[t]),w=h.useCallback(()=>{r(j=>{const C=Math.max(s,j*.9);return C<=1&&i({x:0,y:0}),C})},[s]),b=h.useCallback(()=>{r(n),i({x:0,y:0})},[n]),N=h.useCallback(()=>{r(n),i({x:0,y:0}),c(!1)},[n]);return{scale:a,position:o,isDragging:l,handleMouseDown:f,handleMouseMove:g,handleMouseUp:x,handleWheel:y,zoomIn:v,zoomOut:w,resetView:b,reset:N}}function Lp({isOpen:s,onClose:t,src:n,alt:a,title:r,onDownload:o,showDownload:i=!0}){const[l,c]=h.useState(!1),[d,u]=h.useState(!1),[m,p]=h.useState(!1),{scale:f,position:g,isDragging:x,handleMouseDown:y,handleMouseMove:v,handleMouseUp:w,handleWheel:b,zoomIn:N,zoomOut:j,resetView:C,reset:E}=Ap();return h.useEffect(()=>{if(s){c(!1),u(!0);const R=setTimeout(()=>c(!0),100);return()=>clearTimeout(R)}},[s]),h.useEffect(()=>{if(s&&d){const R=setTimeout(()=>u(!1),3e3);return()=>clearTimeout(R)}},[s,d]),h.useEffect(()=>(s?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[s]),h.useEffect(()=>{const R=T=>{T.key==="Escape"&&s&&t()};return s&&document.addEventListener("keydown",R),()=>{document.removeEventListener("keydown",R)}},[s,t]),h.useEffect(()=>{s&&(E(),p(!1))},[s,E]),s?e.jsxs("div",{className:"fixed inset-0 z-[9999] bg-black/95 backdrop-blur-sm",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx("div",{className:`relative w-full h-full flex items-center justify-center transition-all duration-300 ${l?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"relative w-full h-full flex items-center justify-center overflow-hidden",onWheel:b,children:e.jsx("img",{src:n,alt:a,className:`max-w-full max-h-full object-contain transition-all duration-200 ${m?"opacity-100":"opacity-0"} ${x?"cursor-grabbing":f>1?"cursor-grab":"cursor-zoom-in"}`,style:{transform:`scale(${f}) translate(${g.x/f}px, ${g.y/f}px)`,transformOrigin:"center center"},onLoad:()=>p(!0),onMouseDown:y,onMouseMove:v,onMouseUp:w,onMouseLeave:w,draggable:!1})})})}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-4",children:[r&&e.jsx("div",{className:"text-white/90 text-sm font-medium truncate max-w-[60%] bg-black/50 backdrop-blur-sm rounded-full px-3 py-1",children:r}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[i&&o&&e.jsx(k,{variant:"ghost",size:"sm",onClick:o,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(Kt,{className:"w-4 h-4"})}),e.jsx(k,{variant:"ghost",size:"sm",onClick:t,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(le,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"absolute inset-0 -z-10",onClick:t,"aria-label":"Close viewer"}),e.jsxs("div",{className:`absolute top-16 left-1/2 transform -translate-x-1/2 bg-black/50 backdrop-blur-sm rounded-full px-4 py-2 text-white/60 text-xs transition-all duration-500 ${d?"opacity-100 translate-y-0":"opacity-0 -translate-y-2 pointer-events-none"}`,children:["Press ",e.jsx("kbd",{className:"px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono",children:"ESC"})," to close"]}),e.jsxs("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 flex items-center gap-2 bg-black/50 backdrop-blur-sm rounded-full px-4 py-2",children:[e.jsx(k,{variant:"ghost",size:"sm",onClick:j,className:"text-white/80 hover:text-white hover:bg-white/10 border-0 h-8 w-8 p-0",children:e.jsx(Ro,{className:"w-4 h-4"})}),e.jsxs("span",{className:"text-white/80 text-xs font-medium min-w-[3rem] text-center",children:[Math.round(f*100),"%"]}),e.jsx(k,{variant:"ghost",size:"sm",onClick:N,className:"text-white/80 hover:text-white hover:bg-white/10 border-0 h-8 w-8 p-0",children:e.jsx(Do,{className:"w-4 h-4"})}),e.jsx("div",{className:"w-px h-4 bg-white/20"}),e.jsx(k,{variant:"ghost",size:"sm",onClick:C,className:"text-white/80 hover:text-white hover:bg-white/10 border-0 h-8 w-8 p-0",children:e.jsx(Hc,{className:"w-4 h-4"})})]})]}):null}function Rp({src:s,alt:t,className:n}){const[a,r]=h.useState(!1),[o,i]=h.useState(!1),[l,c]=h.useState(!1),d=(()=>{if(!s)return"image";try{return new URL(s,window.location.href).pathname.split("/").pop()||"image"||"image"}catch{return"image"}})(),u=async()=>{if(s)try{const p=await(await fetch(s)).blob(),f=URL.createObjectURL(p),g=document.createElement("a");g.href=f,g.download=d,document.body.appendChild(g),g.click(),g.remove(),URL.revokeObjectURL(f)}catch{const m=document.createElement("a");m.href=s,m.download=d,document.body.appendChild(m),m.click(),m.remove()}};return e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"inline-block relative",onMouseEnter:()=>c(!0),onMouseLeave:()=>c(!1),children:[e.jsx("img",{src:s,alt:t,className:`${o?"cursor-default":"cursor-zoom-in"} ${n??""}`,loading:"lazy",onLoad:()=>i(!1),onError:()=>i(!0),onClick:()=>!o&&r(!0)}),!o&&l&&e.jsx("button",{type:"button",className:"absolute top-1 right-1 flex items-center justify-center w-6 h-6 rounded bg-black/50 text-white transition-opacity duration-200",title:"View larger",onClick:()=>r(!0),children:e.jsx(qs,{className:"w-3 h-3"})})]}),e.jsx(Lp,{isOpen:a,onClose:()=>r(!1),src:s||"",alt:t,title:t||d,onDownload:o?void 0:u,showDownload:!o})]})}function Ys({content:s,className:t=""}){return e.jsx("div",{className:`prose prose-slate dark:prose-invert max-w-none [&_ul_ul]:ml-6 [&_ul_ul_ul]:ml-6 [&_ul_ul_ul_ul]:ml-6 [&_ul_ul_ul_ul_ul]:ml-6 [&_ol_ol]:ml-6 [&_ol_ol_ol]:ml-6 [&_ol_ol_ol_ol]:ml-6 [&_ol_ol_ol_ol_ol]:ml-6 [&_ul_ol]:ml-6 [&_ol_ul]:ml-6 [&_ul_p]:mb-0 [&_ol_p]:mb-0 ${t}`,children:e.jsx(cu,{remarkPlugins:[Qo,Zo],rehypePlugins:[du],components:{pre:Ep,code:Ip,a({children:n,href:a,...r}){return e.jsx("a",{href:a,className:"text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline transition-colors duration-150",target:"_blank",rel:"noopener noreferrer",...r,children:n})},table({children:n,...a}){return e.jsx("div",{className:"my-4 overflow-x-auto",children:e.jsx("table",{className:"min-w-full border-collapse border border-gray-300 dark:border-gray-600",...a,children:n})})},th({children:n,...a}){return e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-900 dark:text-gray-100 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600",...a,children:n})},td({children:n,...a}){return e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600",...a,children:n})},blockquote({children:n,...a}){return e.jsx("blockquote",{className:"my-4 pl-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-800/30 border-l-4 border-gray-300 dark:border-gray-600 [&>p:last-child]:mb-0",...a,children:n})},ul({children:n,...a}){return e.jsx("ul",{className:"my-2 space-y-2 list-disc pl-6",...a,children:n})},li({children:n,...a}){return e.jsx("li",{className:"text-gray-800 dark:text-gray-200 mb-2 leading-relaxed",...a,children:n})},input({type:n,checked:a,...r}){return n==="checkbox"?e.jsx(Tp,{checked:a,className:"mr-2 mt-0.5 inline-block align-top",disabled:!0}):e.jsx("input",{type:n,checked:a,...r})},ol({children:n,...a}){return e.jsx("ol",{className:"my-2 space-y-2 list-decimal pl-6 text-gray-800 dark:text-gray-200",...a,children:n})},h1({children:n,...a}){return e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-3 mt-5 leading-7",...a,children:n})},h2({children:n,...a}){return e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3 mt-4 leading-6",...a,children:n})},h3({children:n,...a}){return e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2 mt-3 leading-5",...a,children:n})},h4({children:n,...a}){return e.jsx("h4",{className:"text-base font-medium text-gray-900 dark:text-gray-100 mb-2 mt-3 leading-5",...a,children:n})},h5({children:n,...a}){return e.jsx("h5",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 mb-2 mt-3 leading-5",...a,children:n})},h6({children:n,...a}){return e.jsx("h6",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 mt-3 leading-5",...a,children:n})},p({children:n,...a}){return e.jsx("p",{className:"text-base leading-6 text-gray-800 dark:text-gray-200 break-words font-normal mb-2",...a,children:n})},hr({...n}){return e.jsx("hr",{className:"my-6 border-0 h-px bg-gray-300 dark:bg-gray-600",...n})},strong({children:n,...a}){return e.jsx("strong",{className:"font-semibold text-gray-900 dark:text-gray-100",...a,children:n})},em({children:n,...a}){return e.jsx("em",{className:"italic text-gray-700 dark:text-gray-300",...a,children:n})},img({src:n,alt:a}){return e.jsx(Rp,{src:n,alt:a?.toString(),className:"my-2"})}},children:s})})}class Dp{textarea;updateContent;pendingOperations=[];constructor(t,n){this.textarea=t,this.updateContent=n,this.setupEventListeners()}setupEventListeners=()=>{this.textarea.addEventListener("keydown",this.handleKeyDown)};handleKeyDown=t=>{t.key==="Tab"&&(t.preventDefault(),this.handleTabIndentation(t.shiftKey))};handleTabIndentation=t=>{const n=this.textarea.selectionStart,a=this.textarea.selectionEnd,r=this.textarea.value;if(n===a)if(t){const o=r.substring(0,n),i=r.substring(a),l=Math.min(2,o.length-o.trimEnd().length),c=o.slice(0,-l)+i,d=n-l;this.setContentAndFocus(c,d,d)}else{const o=r.slice(0,n)+"  "+r.slice(a),i=n+2;this.setContentAndFocus(o,i,i)}else{const o=r.split(`
`),i=r.substring(0,n).split(`
`).length-1,l=r.substring(0,a).split(`
`).length-1;let c=n,d=a;const m=o.map((p,f)=>{if(f>=i&&f<=l)if(t){const g=p.replace(/^ {2}/,""),x=p.length-g.length;return f===i&&(c=Math.max(0,c-x)),f===l&&(d=Math.max(0,d-x)),g}else{const g="  "+p;return f===i&&(c+=2),f===l&&(d+=2),g}return p}).join(`
`);this.setContentAndFocus(m,c,d)}};setContentAndFocus=(t,n,a)=>{this.addPendingOperation(()=>{this.textarea&&document.contains(this.textarea)&&(this.textarea.focus(),this.textarea.setSelectionRange(n,a))}),this.updateContent(t)};addPendingOperation=t=>{this.pendingOperations.push(t)};consumePendingOperations=()=>{for(;this.pendingOperations.length>0;){const t=this.pendingOperations.shift();t&&t()}};hasPendingOperations=()=>this.pendingOperations.length>0;destroy=()=>{this.textarea.removeEventListener("keydown",this.handleKeyDown)}}const $n=s=>{const{textareaRef:t,updateContent:n,content:a}=s,r=h.useRef(null),o=h.useRef(n);return h.useEffect(()=>{o.current=n},[n]),h.useEffect(()=>(t.current&&(r.current&&r.current.destroy(),r.current=new Dp(t.current,i=>{o.current(i)})),()=>{r.current&&(r.current.destroy(),r.current=null)}),[]),h.useEffect(()=>{r.current&&setTimeout(()=>{r.current?.consumePendingOperations()},0)},[a]),{editor:r.current}},_p=()=>navigator.platform.toUpperCase().includes("MAC"),sr=s=>s.metaKey||s.ctrlKey,Pp=s=>`âŒ˜+${s} / Ctrl+${s}`,Ma={SAVE:Pp("Enter"),CANCEL:"Esc"},ro={js:"javascript",jsx:"jsx",ts:"typescript",tsx:"tsx","c++":"cpp","c#":"csharp",sh:"bash",zsh:"bash",shell:"bash",yml:"yaml",md:"markdown",py:"python",golang:"go"};function oo(s,t){const n=s.trim().toLowerCase();return n?ro[n]?ro[n]:t.includes(n)?n:n==="text"||n==="plain"||n==="plaintext"?null:n:null}let on=[];const Op=({node:s,updateAttributes:t,extension:n})=>{const[a,r]=h.useState(!1),[o,i]=h.useState(""),[l,c]=h.useState(!1),d=h.useRef(!1),u=h.useRef(null),m=h.useRef(null),p=n.options&&n.options.lowlight||void 0,f=h.useMemo(()=>p?.listLanguages?p.listLanguages():[],[p]),g=s.attrs.language||null,x=h.useMemo(()=>{const w=o.trim().toLowerCase();return w?f.filter(b=>b.toLowerCase().includes(w)):f},[f,o]),y=w=>{t({language:w}),r(!1),w&&(on=[w,...on.filter(b=>b!==w)].slice(0,6))},v=async()=>{try{const w=m.current;if(!w)return;const b=w.textContent||"";await navigator.clipboard.writeText(b),c(!0),u.current&&window.clearTimeout(u.current),u.current=window.setTimeout(()=>{d.current||c(!1)},1200)}catch{}};return Mt.useEffect(()=>(d.current=!1,()=>{d.current=!0,u.current&&window.clearTimeout(u.current)}),[]),e.jsxs(hu,{as:"div",className:"relative group",children:[e.jsxs("div",{className:"absolute right-2 top-2 z-10 flex items-center gap-1 opacity-95",onMouseDown:w=>{w.preventDefault()},children:[e.jsx("button",{type:"button",className:"px-2 h-6 rounded text-xs bg-slate-800/80 text-white hover:bg-slate-800",onClick:()=>r(w=>!w),children:g||"Plain text"}),e.jsx("button",{type:"button",className:"px-2 h-6 rounded text-xs bg-slate-800/80 text-white hover:bg-slate-800",onClick:v,children:l?"Copied":"Copy"})]}),a&&e.jsxs("div",{className:"absolute right-2 top-10 z-20 w-56 rounded-md border bg-white dark:bg-slate-800 shadow-lg p-1 text-sm",onMouseDown:w=>w.preventDefault(),children:[e.jsx("div",{className:"p-1",children:e.jsx("input",{autoFocus:!0,placeholder:"Search language",value:o,onChange:w=>i(w.target.value),className:"w-full px-2 py-1 rounded border bg-transparent text-sm"})}),e.jsxs("div",{className:"max-h-64 overflow-auto",children:[on.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-2 py-1 text-xs text-slate-500",children:"Recent"}),on.map(w=>e.jsx("button",{className:["w-full text-left px-2 py-1 rounded",g===w?"bg-slate-100 dark:bg-slate-700":"hover:bg-slate-100 dark:hover:bg-slate-700"].join(" "),onClick:()=>y(oo(w,f)),children:w},`recent-${w}`)),e.jsx("div",{className:"my-1 border-t border-slate-200 dark:border-slate-700"})]}),e.jsx("button",{className:"w-full text-left px-2 py-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700",onClick:()=>y(null),children:"Plain text"}),x.map(w=>e.jsx("button",{className:["w-full text-left px-2 py-1 rounded",g===w?"bg-slate-100 dark:bg-slate-700":"hover:bg-slate-100 dark:hover:bg-slate-700"].join(" "),onClick:()=>y(oo(w,f)),children:w},w))]})]}),e.jsx("div",{className:"codeblock-grid",children:e.jsx("pre",{ref:m,className:"codeblock-pre",children:e.jsx(mu,{className:"hljs"})})})]})},$p=vu.extend({addNodeView(){return uu(Op)}});function Pe(s,t){if(!s)return!1;const n=s;return n.type!=="element"?!1:t?n.tagName===t:!0}function Up(s){if(!s)return;const t=/text-align\s*:\s*(left|center|right)/i.exec(s);if(!t)return;const n=t[1].toLowerCase();if(n==="left"||n==="center"||n==="right")return n}function zp(s){let t=!1;return ha(s,"element",n=>{if(!Pe(n))return;const a=n;if(a.tagName==="th"||a.tagName==="td"){const r=a.properties||{},o=parseInt(r.colspan||"1",10),i=parseInt(r.rowspan||"1",10);if((Number.isFinite(o)?o:1)>1||(Number.isFinite(i)?i:1)>1)return t=!0,Lu}}),t}function Fp(s){const t=s.children;for(let n=0;n<t.length;n++){const a=t[n];if(Pe(a,"p")){const r=a.children||[];t.splice(n,1,...r),n+=r.length-1}}}function Bp(s={}){const{flattenCells:t=!0,forceHeader:n=!0}=s;return function(r){ha(r,"element",o=>{if(!Pe(o,"table"))return;const i=o;if(zp(i))return;const l=i.children,c=l.findIndex(b=>Pe(b,"thead")),d=l.findIndex(b=>Pe(b,"tbody")),u=b=>b?(b.children||[]).find(C=>Pe(C,"tr")):void 0,m=l.find(b=>Pe(b,"tr")),p=c>=0?l[c]:void 0,f=d>=0?l[d]:void 0;let g=u(p)||u(f)||m;if(!g)return;const x=p&&g&&g===u(p)?p:f&&g&&g===u(f)?f:i,y=(g.children||[]).every(b=>Pe(b,"th")),w=x&&Pe(x,"thead")||y;if(n&&!w){const b={type:"element",tagName:"tr",properties:{},children:(g.children||[]).map(E=>{const R=E;if(!Pe(R))return R;const T=R.properties?.style||"",D=Up(T);return{type:"element",tagName:"th",properties:D?{align:D}:{},children:R.children||[]}})},N={type:"element",tagName:"thead",properties:{},children:[b]};let j=l.findIndex(E=>Pe(E,"tbody")||Pe(E,"tr")||Pe(E,"tfoot"));j===-1&&(j=l.length),i.children.splice(j,0,N);const C=[i];p&&C.unshift(p),f&&C.unshift(f);for(const E of C){const R=E.children||[],T=R.indexOf(g);if(T>=0){R.splice(T,1);break}}g=b}t&&ha(i,"element",b=>{if(!Pe(b))return;const N=b;(N.tagName==="th"||N.tagName==="td")&&Fp(N)})})}}ei.setOptions({gfm:!0,breaks:!1});const Hp=new Tu({headingStyle:"atx",codeBlockStyle:"fenced",bulletListMarker:"-"});Hp.use(Au);function Gp(s){if(typeof window>"u"||!s||s.indexOf('type="checkbox"')===-1)return s;try{const t=document.implementation.createHTMLDocument(""),n=t.createElement("div");return n.innerHTML=s,Array.from(n.querySelectorAll("ul")).forEach(a=>{const r=Array.from(a.querySelectorAll(":scope > li"));r.some(i=>i.querySelector('input[type="checkbox"]'))&&(a.setAttribute("data-type","taskList"),r.forEach(i=>{const l=i.querySelector('input[type="checkbox"]');if(!l)return;const c=l.checked||l.hasAttribute("checked"),d=Array.from(i.childNodes);l.parentElement&&l.parentElement.removeChild(l),i.innerHTML="",i.setAttribute("data-type","taskItem"),i.setAttribute("data-checked",c?"true":"false");const u=t.createElement("label");u.setAttribute("contenteditable","false"),u.appendChild(l);const m=t.createElement("span");u.appendChild(m),i.appendChild(u);const p=t.createElement("div");p.setAttribute("class","content");const f=d.filter(x=>x!==l);if(f.some(x=>x.nodeType===1&&/^(P|UL|OL|DIV|H[1-6]|BLOCKQUOTE|PRE|TABLE)$/i.test(x.tagName)))f.forEach(x=>{x.nodeType===3&&!x.textContent?.trim()||p.appendChild(x.cloneNode(!0))});else{const x=t.createElement("p");f.forEach(y=>{y.nodeType===3&&!y.textContent?.trim()||x.appendChild(y.cloneNode(!0))}),x.firstChild||x.appendChild(t.createTextNode("")),p.appendChild(x)}i.appendChild(p)}))}),n.innerHTML}catch{return s}}function Vp(s){if(typeof window>"u"||!s||s.indexOf('data-type="taskList"')===-1)return s;try{const t=document.implementation.createHTMLDocument(""),n=t.createElement("div");return n.innerHTML=s,n.querySelectorAll('ul[data-type="taskList"]').forEach(a=>{a.classList.add("contains-task-list"),a.querySelectorAll(":scope > li").forEach(r=>{const o=r.getAttribute("data-checked"),i=o==="true"||o==="checked",l=r.querySelector(":scope > label"),c=r.querySelector(":scope > div.content")||r.querySelector(":scope > div"),d=t.createElement("input");d.type="checkbox",d.setAttribute("aria-label","Task item"),d.setAttribute("disabled","true"),i&&d.setAttribute("checked","true"),r.removeAttribute("data-checked"),l&&l.remove();const u=[];if(c){for(;c.firstChild;)u.push(c.firstChild),c.removeChild(c.firstChild);c.remove()}u.length||Array.from(r.childNodes).forEach(m=>{m.nodeType===1&&m.tagName==="INPUT"||u.push(m.cloneNode(!0))}),r.classList.add("task-list-item"),r.innerHTML="",r.appendChild(d),r.appendChild(t.createTextNode(" ")),u.forEach(m=>{if(m.nodeType===1&&m.tagName==="P"){const p=m;for(;p.firstChild;)r.appendChild(p.firstChild)}else{if(m.nodeType===3&&!m.textContent?.trim())return;r.appendChild(m)}})}),a.removeAttribute("data-type")}),n.innerHTML}catch{return s}}function Qn(s){if(!s)return"";try{const t=ei.parse(s);return Gp(t)}catch{return s}}function qp(s){if(!s)return"";try{const t=Vp(s),n={fences:!0,bullet:"-",rule:"-",listItemIndent:"one"},a=Ru().use(Du,{fragment:!0}).use(Bp).use(_u).use(Zo).use(Qo).use(Pu,n).processSync(t);return String(a.value)}catch{return s}}const Wp=Ou.create({name:"slashCommand",addOptions(){return{char:"/",onOpen:()=>{},onUpdate:()=>{},onClose:()=>{},onMoveIndex:()=>{},onEnter:()=>{},onCommand:()=>{}}},addProseMirrorPlugins(){const s=this.editor,t=this.options,n={editor:s,char:t.char??"/",startOfLine:!0,allowSpaces:!0,command:({editor:a,range:r,props:o})=>{const i=o.action;i&&t.onCommand(a,r,i)},render:()=>({onStart:a=>{const r=a.clientRect?.()??null,o=i=>a.command(i);t.onOpen({query:a.query??"",range:a.range,clientRect:r,invoke:o})},onUpdate:a=>{const r=a.clientRect?.()??null,o=i=>a.command(i);t.onUpdate({query:a.query??"",range:a.range,clientRect:r,invoke:o})},onKeyDown:({event:a})=>a.key==="ArrowDown"?(t.onMoveIndex(1),a.preventDefault(),!0):a.key==="ArrowUp"?(t.onMoveIndex(-1),a.preventDefault(),!0):a.key==="Enter"?(t.onEnter(),a.preventDefault(),!0):a.key==="Escape"?(t.onClose(),a.preventDefault(),a.stopPropagation(),!0):!1,onExit:()=>{t.onClose()}})};return[$u(n)]}}),Kp=/^(#{1,6})$/,Yp=zu.extend({addKeyboardShortcuts(){const s=this.parent?.()??{};return{...s,Space:({editor:t})=>{const n=s.Space,{state:a}=t,{selection:r}=a;if(!r.empty)return n?n({editor:t}):!1;const{$from:o}=r,i=o.start(),l=a.doc.textBetween(i,r.from,`
`,`
`),c=Kp.exec(l);if(!c)return n?n({editor:t}):!1;const d=c[1].length,u=r.from-l.length;return t.chain().focus().deleteRange({from:u,to:r.from}).toggleHeading({level:d}).run(),!0}}}}),te=Mt.forwardRef(({disabled:s,active:t,onClick:n,children:a,size:r="md",className:o="",...i},l)=>{const c=r==="sm"?"h-5 w-5 text-[11px]":"h-7 w-7 text-[13px]";return e.jsx("button",{ref:l,type:"button",onClick:n,disabled:s,className:["inline-flex items-center justify-center rounded transition-colors",c,s?"opacity-40 cursor-not-allowed":"hover:bg-slate-100 dark:hover:bg-slate-800",t?"bg-slate-100 dark:bg-slate-800":"bg-transparent",o].join(" "),...i,children:a})});te.displayName="ToolbarButton";function Xs({value:s,onChange:t,editable:n=!0,placeholder:a="Write here...",className:r="",variant:o="default",maxHeight:i,minHeight:l,enterSends:c=!1,onSubmitEnter:d,hideToolbar:u,suspended:m=!1}){const p=h.useMemo(()=>{const I=document.createElement("div");return I.style.zIndex="1100",I.style.pointerEvents="auto",I},[]),f=h.useMemo(()=>Qn(s||""),[s]),g=h.useRef(s||""),x=h.useRef(null),y=h.useRef(null),[v,w]=h.useState({open:!1,x:0,y:0,index:0,query:""}),b=h.useRef(v);h.useEffect(()=>{b.current=v},[v]);const N=h.useRef(null),[j,C]=h.useState({open:!1,rowX:0,rowY:0,colX:0,colY:0}),[E,R]=h.useState({x:-9999,y:-9999}),[T,D]=h.useState({row:!1,col:!1}),[L,U]=h.useState({open:!1,x:0,y:0,value:"",text:""}),z=h.useRef(null),[K,de]=h.useState({open:!1,x:0,y:0,value:""}),pe=h.useRef(null),Le=()=>{const I=y.current?.getBoundingClientRect(),S=window.getSelection();if(!I||!S||S.rangeCount===0)return{x:8,y:8};const _=S.getRangeAt(0).getBoundingClientRect();return{x:Math.max(8,_.left-I.left+(y.current?.scrollLeft||0)),y:Math.max(8,_.bottom-I.top+(y.current?.scrollTop||0))}},Ie=()=>{const{x:I,y:S}=Le(),_=x.current,P=_?.getAttributes("link")?.href||"";let ee="";try{if(_){const re=_.state.selection;re.empty||(ee=_.state.doc.textBetween(re.from,re.to))}}catch{ee=""}U({open:!0,x:I,y:S,value:P,text:ee})},$=()=>{const{x:I,y:S}=Le();de({open:!0,x:I,y:S,value:""})},B=h.useMemo(()=>[bu.configure({codeBlock:!1,heading:!1}),Yp,yu,wu.configure({openOnClick:!0,autolink:!0,linkOnPaste:!0,HTMLAttributes:{rel:"noopener noreferrer nofollow",target:"_blank"}}),ju.configure({allowBase64:!0}),Nu,Cu.configure({resizable:!0}),ku,Su,Mu,Eu,Iu.configure({nested:!0}),$p.configure({lowlight:Uu,defaultLanguage:null}),fu.configure({element:p,options:{placement:"top"},appendTo:()=>document.body,shouldShow:({editor:I,state:S})=>I.isEditable?!S.selection.empty:!1}),xu.configure({placeholder:a,showOnlyWhenEditable:!0,showOnlyCurrent:!1}),Wp.configure({onOpen:I=>{const S=I.clientRect||{left:8,top:8,bottom:16},_=typeof window<"u"?window.innerWidth:1024,P=typeof window<"u"?window.innerHeight:768,ee=S.top,re=S.left,me="bottom"in S&&typeof S.bottom=="number"?S.bottom:ee+16,Je=Math.max(0,ee),tt=Math.max(0,P-me)>=Je?"down":"up",Qs=Math.max(8,Math.min(re,_-260));w({open:!0,x:Qs,y:tt==="up"?ee:me,fixed:!0,place:tt,range:I.range,index:0,query:I.query,invoke:I.invoke})},onUpdate:I=>{const S=I.clientRect||{left:8,top:8,bottom:16},_=typeof window<"u"?window.innerWidth:1024,P=typeof window<"u"?window.innerHeight:768,ee=S.top,re=S.left,me="bottom"in S&&typeof S.bottom=="number"?S.bottom:ee+16,Je=Math.max(0,ee),tt=Math.max(0,P-me)>=Je?"down":"up",Qs=Math.max(8,Math.min(re,_-260)),Pt=tt==="up"?ee:me;w(ft=>({...ft||{open:!0,index:0},open:!0,x:Qs,y:Pt,fixed:!0,place:tt,range:I.range,query:I.query,invoke:I.invoke}))},onClose:()=>w({open:!1,x:0,y:0,index:0,query:""}),onMoveIndex:I=>w(S=>{const _=Un(),P=Math.max(0,Math.min(_.length-1,S.index+I));return{...S,index:P}}),onEnter:()=>{const I=b.current,S=Un().at(I.index);S&&I.invoke&&I.invoke({action:S.id})},onCommand:(I,S,_)=>{const P=I.chain().focus().deleteRange(S).setTextSelection(S.from);switch(_){case"h1":P.toggleHeading({level:1}).run();break;case"h2":P.toggleHeading({level:2}).run();break;case"h3":P.toggleHeading({level:3}).run();break;case"h4":P.toggleHeading({level:4}).run();break;case"h5":P.toggleHeading({level:5}).run();break;case"h6":P.toggleHeading({level:6}).run();break;case"bullet":P.toggleBulletList().run();break;case"ordered":P.toggleOrderedList().run();break;case"task":P.toggleTaskList().run();break;case"quote":P.toggleBlockquote().run();break;case"code":P.toggleCodeBlock().run();break;case"icode":P.toggleCode().run();break;case"hr":P.setHorizontalRule().run();break;case"table":P.insertTable({rows:3,cols:3,withHeaderRow:!0}).run();break;case"table-row-above":P.addRowBefore().run();break;case"table-row-below":P.addRowAfter().run();break;case"table-row-delete":P.deleteRow().run();break;case"table-col-left":P.addColumnBefore().run();break;case"table-col-right":P.addColumnAfter().run();break;case"table-col-delete":P.deleteColumn().run();break;case"table-delete":P.deleteTable().run();break;case"image":{P.run(),$();break}case"link":{P.run(),Ie();break}case"clear":P.unsetAllMarks().clearNodes().run();break;default:P.run()}}})],[a,p,w,$,Ie]),A=gu({extensions:B,content:f,editable:n,editorProps:{attributes:{spellcheck:"false",style:o==="frameless"?"padding: 4px 6px; outline: none; height: 100%;":"min-height: 240px; padding: 12px; outline: none;"},handlePaste(I,S){const _=S.clipboardData?.getData("text/plain")||"";if(_.includes("```")){const re=Qn(_);if(re)return x.current?.chain().focus().insertContent(re).run(),!0}const ee=Array.from(S.clipboardData?.items||[]).find(re=>re.type.startsWith("image/"));if(ee){const re=ee.getAsFile();if(re){const me=new FileReader;return me.onload=()=>{typeof me.result=="string"&&x.current?.chain().focus().setImage({src:me.result}).run()},me.readAsDataURL(re),!0}}return!1},handleKeyDown(I,S){if(c&&S.key==="Enter")return S.metaKey||S.ctrlKey?(S.preventDefault(),d?.(),!0):!1;if(S.key==="Tab"){const _=x.current;if(!_)return!0;if(S.shiftKey)return _.can().liftListItem("taskItem")?(_.chain().focus().liftListItem("taskItem").run(),S.preventDefault(),!0):_.can().liftListItem("listItem")?(_.chain().focus().liftListItem("listItem").run(),S.preventDefault(),!0):!1;if(_.can().sinkListItem("taskItem"))return _.chain().focus().sinkListItem("taskItem").run(),S.preventDefault(),!0;if(_.can().sinkListItem("listItem"))return _.chain().focus().sinkListItem("listItem").run(),S.preventDefault(),!0;const{$from:P}=_.state.selection,re=P.parent?.textContent??"",me=/^\s*([-*+])\s+/.exec(re),Je=/^\s*(\d+)[.)]\s+/.exec(re);return me?(_.chain().focus().toggleBulletList().run(),S.preventDefault(),!0):Je?(_.chain().focus().toggleOrderedList().run(),S.preventDefault(),!0):!1}if((S.metaKey||S.ctrlKey)&&S.key.toLowerCase()==="k")return S.preventDefault(),Ie(),!0;if((S.metaKey||S.ctrlKey)&&S.altKey){const _=S.key;if(_==="1")return x.current?.chain().focus().toggleHeading({level:1}).run(),S.preventDefault(),!0;if(_==="2")return x.current?.chain().focus().toggleHeading({level:2}).run(),S.preventDefault(),!0;if(_==="3")return x.current?.chain().focus().toggleHeading({level:3}).run(),S.preventDefault(),!0;if(_==="4")return x.current?.chain().focus().toggleHeading({level:4}).run(),S.preventDefault(),!0;if(_==="5")return x.current?.chain().focus().toggleHeading({level:5}).run(),S.preventDefault(),!0;if(_==="6")return x.current?.chain().focus().toggleHeading({level:6}).run(),S.preventDefault(),!0;if(_==="0")return x.current?.chain().focus().setParagraph().run(),S.preventDefault(),!0}return!1},handleDOMEvents:{dblclick:(I,S)=>{const _=S.target;if(_&&_.tagName==="IMG"){const P=window.prompt("Image URL (leave empty to remove)",_.src||"");return P===null?!0:P.trim()?(x.current?.chain().focus().setImage({src:P.trim(),alt:_.alt}).run(),!0):(x.current?.chain().focus().deleteSelection().run(),!0)}return!1},click:(I,S)=>{const _=S.target;return v.open&&!y.current?.contains(_)&&w({open:!1,x:0,y:0,index:0,query:""}),L.open&&(z.current&&z.current.contains(_)||_t()),K.open&&(pe.current&&pe.current.contains(_)||Xt()),!1},mousedown:(I,S)=>{const _=S.target;return L.open&&(z.current&&z.current.contains(_)||_t()),K.open&&(pe.current&&pe.current.contains(_)||Xt()),!1}}},onCreate:({editor:I})=>{x.current=I},onUpdate({editor:I}){const S=I.getHTML(),_=qp(S);_!==g.current&&(g.current=_,t?.(_))}});h.useEffect(()=>{if(A&&s!==g.current){g.current=s;const I=Qn(s||"");A.commands.setContent(I)}},[s,A]),h.useEffect(()=>{A&&A.setEditable(n)},[n,A]),h.useEffect(()=>{if(!A)return;const I=A.extensionManager.extensions.find(S=>S.name==="placeholder");I&&I.options&&(I.options.placeholder=a,A.view.dom.querySelectorAll("[data-placeholder]").forEach(P=>{P.setAttribute("data-placeholder",a)}))},[a,A]),h.useEffect(()=>{if(x.current&&m){try{x.current.commands.blur()}catch{}w({open:!1,x:0,y:0,index:0,query:""}),U({open:!1,x:0,y:0,value:"",text:""}),de({open:!1,x:0,y:0,value:""})}},[m]),h.useEffect(()=>{if(!v.open)return;const I=N.current;if(!I)return;const S=I.querySelector(`[data-slash-index="${v.index}"]`);if(S){const{offsetTop:_}=S,P=_+S.offsetHeight,ee=I.scrollTop,re=ee+I.clientHeight;if(_<ee)I.scrollTo({top:_,behavior:"auto"});else if(P>re){const me=P-re;I.scrollTo({top:ee+me,behavior:"auto"})}}},[v.index,v.open]);const ae=(I,S)=>A?.isActive(I,S)??!1,ue=I=>A?I():!1,ye=[1,2,3,4,5,6],Be=A?ye.find(I=>A.isActive("heading",{level:I})):void 0,je=Be?`H${Be}`:"Text",_t=()=>U({open:!1,x:0,y:0,value:"",text:""}),Xt=()=>de({open:!1,x:0,y:0,value:""});h.useEffect(()=>{if(!A)return;const I=A.extensionManager.extensions.find(S=>S.name==="bubbleMenu");I&&(I.options.shouldShow=({editor:S,state:_})=>!S.isEditable||v.open||L.open||K.open?!1:!_.selection.empty,A.view.dispatch(A.state.tr.setMeta("bubbleMenu","updatePosition")))},[A,v.open,L.open,K.open]),h.useEffect(()=>{if(!A)return;let I=0;const S=()=>{try{const me=A.view,{from:Je}=A.state.selection,tt=me.domAtPos(Je).node,Pt=(tt&&tt.nodeType===3?tt.parentElement:tt)?.closest("td,th"),ft=Pt?.closest("tr"),cr=Pt?.closest("table");if(!Pt||!ft||!cr){C(Ot=>Ot.open?{...Ot,open:!1}:Ot);return}const dr=ft.cells&&ft.cells.length>0?ft.cells[0]:ft.querySelector("th,td"),ur=cr.querySelector("tr"),hr=ur?ur.cells[Pt.cellIndex]:null;if(!dr||!hr){C(Ot=>Ot.open?{...Ot,open:!1}:Ot);return}const Jt=y.current?.getBoundingClientRect(),mr=y.current?.scrollLeft||0,gr=y.current?.scrollTop||0,pr=ft.getBoundingClientRect(),El=dr.getBoundingClientRect(),zn=hr.getBoundingClientRect(),Il=El.left-(Jt?.left||0)+mr,Tl=pr.top+pr.height/2-(Jt?.top||0)+gr,Al=zn.left+zn.width/2-(Jt?.left||0)+mr,Ll=zn.top-(Jt?.top||0)+gr,fr=Jt?.width||0,xr=Jt?.height||0,xt=1,Rl=Math.max(xt,Math.min(Il,fr-xt)),Dl=Math.max(xt,Math.min(Tl,xr-xt)),_l=Math.max(xt,Math.min(Al,fr-xt)),Pl=Math.max(xt,Math.min(Ll,xr-xt));C({open:!0,rowX:Rl,rowY:Dl,colX:_l,colY:Pl})}catch{C(me=>me.open?{...me,open:!1}:me)}},_=()=>{cancelAnimationFrame(I),I=requestAnimationFrame(S)};A.on("selectionUpdate",_),A.on("transaction",_);const P=()=>_(),ee=()=>_(),re=me=>{const Je=y.current?.getBoundingClientRect();Je&&R({x:me.clientX-Je.left+(y.current?.scrollLeft||0),y:me.clientY-Je.top+(y.current?.scrollTop||0)})};return y.current?.addEventListener("scroll",P),y.current?.addEventListener("mousemove",re),window.addEventListener("resize",ee),_(),()=>{A.off("selectionUpdate",_),A.off("transaction",_),y.current?.removeEventListener("scroll",P),y.current?.removeEventListener("mousemove",re),window.removeEventListener("resize",ee),cancelAnimationFrame(I)}},[A]),h.useEffect(()=>{const S=Math.hypot(E.x-j.rowX,E.y-j.rowY),_=Math.hypot(E.x-j.colX,E.y-j.colY);D({row:j.open&&S<=20,col:j.open&&_<=20})},[E,j]);const ir=[{label:"Heading 1",id:"h1",group:"Headings",aliases:["h1","title"]},{label:"Heading 2",id:"h2",group:"Headings",aliases:["h2"]},{label:"Heading 3",id:"h3",group:"Headings",aliases:["h3"]},{label:"Bulleted list",id:"bullet",group:"Lists",aliases:["ul","unordered"]},{label:"Numbered list",id:"ordered",group:"Lists",aliases:["ol","ordered","number"]},{label:"Task list",id:"task",group:"Lists",aliases:["todo","checkbox"]},{label:"Quote",id:"quote",group:"Blocks",aliases:["blockquote"]},{label:"Code block",id:"code",group:"Blocks",aliases:["fence","```"]},{label:"Inline code",id:"icode",group:"Blocks",aliases:["code inline"]},{label:"Horizontal rule",id:"hr",group:"Blocks",aliases:["divider","line"]},{label:"Table",id:"table",group:"Table"},{label:"Table: add row above",id:"table-row-above",group:"Table"},{label:"Table: add row below",id:"table-row-below",group:"Table"},{label:"Table: delete row",id:"table-row-delete",group:"Table"},{label:"Table: add column left",id:"table-col-left",group:"Table"},{label:"Table: add column right",id:"table-col-right",group:"Table"},{label:"Table: delete column",id:"table-col-delete",group:"Table"},{label:"Table: delete table",id:"table-delete",group:"Table"},{label:"Imageâ€¦",id:"image",group:"Media & Links",aliases:["img","picture"]},{label:"Linkâ€¦",id:"link",group:"Media & Links",aliases:["url"]},{label:"Clear formatting",id:"clear",group:"Editing",aliases:["reset","remove style"]}],Un=()=>{const I=(v.query??"").toLowerCase();return I?ir.filter(S=>S.label.toLowerCase().includes(I)||(S.aliases||[]).some(_=>_.toLowerCase().includes(I))):ir},Sl=I=>{const S="w-4 h-4 text-slate-500";switch(I){case"h1":return e.jsx(Jc,{className:S});case"h2":return e.jsx(Xc,{className:S});case"h3":return e.jsx(Yc,{className:S});case"h4":return e.jsx(Kc,{className:S});case"h5":return e.jsx(Wc,{className:S});case"h6":return e.jsx(qc,{className:S});case"bullet":return e.jsx(ta,{className:S});case"ordered":return e.jsx(kr,{className:S});case"task":return e.jsx(ht,{className:S});case"quote":return e.jsx(Sr,{className:S});case"code":return e.jsx(aa,{className:S});case"icode":return e.jsx(Fn,{className:S});case"hr":return e.jsx(ea,{className:S});case"table":return e.jsx(Mr,{className:S});case"image":return e.jsx(rs,{className:S});case"link":return e.jsx(Bn,{className:S});case"clear":return e.jsx(Cr,{className:S});default:return null}},Ml={...i?{maxHeight:typeof i=="number"?`${i}px`:String(i)}:{},...l?{minHeight:typeof l=="number"?`${l}px`:String(l)}:{}};return e.jsxs("div",{style:Ml,className:[o==="frameless"?"border-0 rounded-none bg-transparent":"border rounded-md bg-background","flex flex-col min-h-0 gap-y-0",r].join(" "),children:[!u&&e.jsxs("div",{className:"flex items-center gap-0.5 px-1 pb-2 shrink-0",children:[e.jsx(te,{active:ae("bold"),disabled:!ue(()=>A.can().chain().focus().toggleBold().run()),onClick:()=>A?.chain().focus().toggleBold().run(),children:e.jsx(yr,{className:"w-4 h-4"})}),e.jsx(te,{active:ae("italic"),disabled:!ue(()=>A.can().chain().focus().toggleItalic().run()),onClick:()=>A?.chain().focus().toggleItalic().run(),children:e.jsx(wr,{className:"w-4 h-4"})}),e.jsx(te,{active:ae("underline"),disabled:!ue(()=>A.can().chain().focus().toggleUnderline().run()),onClick:()=>A?.chain().focus().toggleUnderline().run(),children:e.jsx(jr,{className:"w-4 h-4"})}),e.jsx(te,{active:ae("strike"),disabled:!ue(()=>A.can().chain().focus().toggleStrike().run()),onClick:()=>A?.chain().focus().toggleStrike().run(),children:e.jsx(Nr,{className:"w-4 h-4"})}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsx(te,{disabled:!ue(()=>A.can().chain().focus().undo().run()),onClick:()=>A?.chain().focus().undo().run(),children:e.jsx(Gc,{className:"w-4 h-4"})}),e.jsx(te,{disabled:!ue(()=>A.can().chain().focus().redo().run()),onClick:()=>A?.chain().focus().redo().run(),children:e.jsx(Vc,{className:"w-4 h-4"})}),e.jsx(te,{onClick:()=>A?.chain().focus().unsetAllMarks().clearNodes().run(),children:e.jsx(Cr,{className:"w-4 h-4"})}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsxs(Lt,{children:[e.jsx(Rt,{asChild:!0,children:e.jsxs(te,{active:!!Be,onClick:()=>{},className:"px-1.5 min-w-[44px] justify-between gap-1 text-xs",children:[e.jsx("span",{className:"font-medium text-xs",children:je}),e.jsx(ze,{className:"h-3 w-3 opacity-60"})]})}),e.jsxs(Dt,{align:"start",className:"w-36 p-1 text-xs",children:[e.jsxs(rt,{onSelect:()=>A?.chain().focus().setParagraph().run(),className:"flex items-center gap-2",children:[e.jsx("span",{className:"flex h-6 w-6 items-center justify-center rounded bg-slate-100 text-xs font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-200",children:"Â¶"}),e.jsx("span",{className:"font-medium",children:"Text"})]}),e.jsx(qa,{className:"my-1"}),ye.map(I=>e.jsxs(rt,{onSelect:()=>A?.chain().focus().toggleHeading({level:I}).run(),className:"flex items-center gap-2",children:[e.jsxs("span",{className:"flex h-6 w-6 items-center justify-center rounded bg-slate-100 text-xs font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-200",children:["H",I]}),e.jsxs("span",{className:"font-medium",children:["Heading ",I]})]},I))]})]}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsx(te,{active:ae("bulletList"),onClick:()=>A?.chain().focus().toggleBulletList().run(),children:e.jsx(ta,{className:"w-4 h-4"})}),e.jsx(te,{active:ae("orderedList"),onClick:()=>A?.chain().focus().toggleOrderedList().run(),children:e.jsx(kr,{className:"w-4 h-4"})}),e.jsx(te,{active:ae("taskList"),onClick:()=>A?.chain().focus().toggleTaskList().run(),children:e.jsx(ht,{className:"w-4 h-4"})}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsx(te,{active:ae("blockquote"),onClick:()=>A?.chain().focus().toggleBlockquote().run(),children:e.jsx(Sr,{className:"w-4 h-4"})}),e.jsx(te,{active:ae("code"),disabled:!ue(()=>A.can().chain().focus().toggleCode().run()),onClick:()=>A?.chain().focus().toggleCode().run(),children:e.jsx(Fn,{className:"w-4 h-4"})}),e.jsx(te,{active:ae("codeBlock"),onClick:()=>A?.chain().focus().toggleCodeBlock().run(),children:e.jsx(aa,{className:"w-4 h-4"})}),e.jsx(te,{onClick:()=>A?.chain().focus().setHorizontalRule().run(),children:e.jsx(ea,{className:"w-4 h-4"})}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsx(te,{onClick:()=>{Ie()},children:e.jsx(Bn,{className:"w-4 h-4"})}),e.jsx(te,{onClick:()=>{const I=window.prompt("Image URL or base64");I&&A?.chain().focus().setImage({src:I}).run()},children:e.jsx(rs,{className:"w-4 h-4"})}),e.jsx(te,{onClick:()=>A?.chain().focus().insertTable({rows:3,cols:3,withHeaderRow:!0}).run(),children:e.jsx(Mr,{className:"w-4 h-4"})})]}),e.jsxs("div",{ref:y,className:"relative min-h-0 flex-1 overflow-y-auto",children:[e.jsx("div",{className:["relative h-full",u?"":"mt-0.5",o==="frameless"?"px-3 pb-0":"px-3 pb-3"].join(" "),children:e.jsx(pu,{editor:A,className:[o==="frameless"?"tiptap max-w-none h-full outline-none focus:outline-none":"tiptap prose dark:prose-invert max-w-none h-full outline-none focus:outline-none"].join(" ")})}),L.open&&e.jsx("div",{ref:z,style:{position:"absolute",left:L.x,top:L.y,zIndex:1e3,minWidth:320},className:"rounded-md border bg-white dark:bg-slate-800 shadow-lg p-2 text-sm",onMouseDown:I=>I.preventDefault(),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{autoFocus:!0,value:L.value,onChange:I=>U(S=>({...S,value:I.target.value})),placeholder:"https://",className:"w-56 px-2 py-1 rounded border bg-transparent text-sm"}),e.jsx("input",{value:L.text,onChange:I=>U(S=>({...S,text:I.target.value})),placeholder:"Link text",className:"w-40 px-2 py-1 rounded border bg-transparent text-sm"}),e.jsx("button",{type:"button",className:"px-2 h-7 rounded text-xs bg-slate-900 text-white dark:bg-slate-200 dark:text-slate-900",onClick:()=>{const I=L.value.trim(),S=(L.text||"").trim(),_=A;if(_){if(!I){_.chain().focus().unsetLink().run(),_t();return}if(S){const P=I.replace(/"/g,"&quot;"),ee=S.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");_.chain().focus().insertContent(`<a href="${P}">${ee}</a>`).run(),_t();return}if(!_.state.selection.empty)_.chain().focus().setLink({href:I}).run();else{const P=I.replace(/"/g,"&quot;"),ee=I.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");_.chain().focus().insertContent(`<a href="${P}">${ee}</a>`).run()}_t()}},children:"Save"}),e.jsx("button",{type:"button",className:"px-2 h-7 rounded text-xs bg-slate-100 dark:bg-slate-700",onClick:()=>{A?.chain().focus().unsetLink().run(),_t()},children:"Unlink"}),e.jsx("button",{type:"button",className:"px-2 h-7 rounded text-xs bg-slate-100 dark:bg-slate-700",onClick:()=>_t(),"aria-label":"Close link editor",children:"Close"})]})}),K.open&&e.jsx("div",{ref:pe,style:{position:"absolute",left:K.x,top:K.y,zIndex:1e3,minWidth:280},className:"rounded-md border bg-white dark:bg-slate-800 shadow-lg p-2 text-sm",onMouseDown:I=>I.preventDefault(),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{autoFocus:!0,value:K.value,onChange:I=>de(S=>({...S,value:I.target.value})),onKeyDown:I=>{if(I.key==="Enter"){const S=K.value.trim();S&&A?.chain().focus().setImage({src:S}).run(),Xt()}I.key==="Escape"&&Xt()},placeholder:"Image URL or base64",className:"w-56 px-2 py-1 rounded border bg-transparent text-sm"}),e.jsx("button",{type:"button",className:"px-2 h-7 rounded text-xs bg-slate-900 text-white dark:bg-slate-200 dark:text-slate-900",onClick:()=>{const I=K.value.trim();I&&A?.chain().focus().setImage({src:I}).run(),Xt()},children:"Insert"}),e.jsx("button",{type:"button",className:"px-2 h-7 rounded text-xs bg-slate-100 dark:bg-slate-700",onClick:()=>Xt(),"aria-label":"Close image editor",children:"Close"})]})}),A&&p&&br.createPortal(e.jsxs("div",{className:"rounded-lg bg-white dark:bg-slate-800 shadow-lg border border-slate-200 dark:border-slate-700 p-1 flex items-center gap-0.5",onMouseDown:I=>I.preventDefault(),children:[e.jsx(te,{active:ae("bold"),onClick:()=>A?.chain().focus().toggleBold().run(),children:e.jsx(yr,{className:"w-4 h-4"})}),e.jsx(te,{active:ae("italic"),onClick:()=>A?.chain().focus().toggleItalic().run(),children:e.jsx(wr,{className:"w-4 h-4"})}),e.jsx(te,{active:ae("underline"),onClick:()=>A?.chain().focus().toggleUnderline().run(),children:e.jsx(jr,{className:"w-4 h-4"})}),e.jsx(te,{active:ae("strike"),onClick:()=>A?.chain().focus().toggleStrike().run(),children:e.jsx(Nr,{className:"w-4 h-4"})}),e.jsx("div",{className:"mx-0.5 h-4 w-px bg-slate-200/60 dark:bg-slate-700/60"}),e.jsx(te,{active:ae("code"),onClick:()=>A?.chain().focus().toggleCode().run(),children:e.jsx(Fn,{className:"w-4 h-4"})}),e.jsx(te,{active:ae("link"),onClick:()=>{Ie()},children:e.jsx(Bn,{className:"w-4 h-4"})})]}),p),j.open&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{position:"absolute",left:j.rowX,top:j.rowY,zIndex:1e3,transform:"translateX(-100%) translateX(-1px) translateY(-50%)"},className:["bg-transparent border-0 shadow-none p-0 flex flex-col items-center gap-0.5 transition-opacity",T.row?"opacity-100":"opacity-30"].join(" "),onMouseDown:I=>I.preventDefault(),children:[e.jsx(te,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!ue(()=>A.can().chain().focus().addRowBefore().run()),onClick:()=>A?.chain().focus().addRowBefore().run(),children:e.jsx(Wt,{className:"w-3 h-3",strokeWidth:2})}),e.jsx(te,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!ue(()=>A.can().chain().focus().deleteRow().run()),onClick:()=>A?.chain().focus().deleteRow().run(),children:e.jsx(it,{className:"w-3 h-3",strokeWidth:2})}),e.jsx(te,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!ue(()=>A.can().chain().focus().addRowAfter().run()),onClick:()=>A?.chain().focus().addRowAfter().run(),children:e.jsx(ze,{className:"w-3 h-3",strokeWidth:2})})]}),e.jsxs("div",{style:{position:"absolute",left:j.colX,top:j.colY,zIndex:1e3,transform:"translateY(-100%) translateY(-1px) translateX(-50%)"},className:["bg-transparent border-0 shadow-none p-0 flex items-center gap-0.5 transition-opacity",T.col?"opacity-100":"opacity-30"].join(" "),onMouseDown:I=>I.preventDefault(),children:[e.jsx(te,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!ue(()=>A.can().chain().focus().addColumnBefore().run()),onClick:()=>A?.chain().focus().addColumnBefore().run(),children:e.jsx(Eo,{className:"w-3 h-3",strokeWidth:2})}),e.jsx(te,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!ue(()=>A.can().chain().focus().deleteColumn().run()),onClick:()=>A?.chain().focus().deleteColumn().run(),children:e.jsx(it,{className:"w-3 h-3",strokeWidth:2})}),e.jsx(te,{size:"sm",className:"hover:bg-slate-900/10 dark:hover:bg-white/15",disabled:!ue(()=>A.can().chain().focus().addColumnAfter().run()),onClick:()=>A?.chain().focus().addColumnAfter().run(),children:e.jsx(Ta,{className:"w-3 h-3",strokeWidth:2})})]})]}),v.open&&br.createPortal(e.jsx("div",{style:{position:"fixed",left:v.x,top:v.y,zIndex:1100,minWidth:240,transform:v.place==="up"?"translateY(-100%) translateY(-8px)":"translateY(8px)"},className:"rounded-md border bg-white dark:bg-slate-800 shadow-lg p-1 text-sm",children:e.jsx("div",{ref:N,className:"max-h-64 overflow-auto",children:(()=>{const I=Un(),S=[];let _;return I.forEach((P,ee)=>{P.group&&P.group!==_&&S.push(e.jsx("div",{className:"px-2 pt-2 pb-1 text-[11px] uppercase tracking-wide text-slate-400",children:P.group},`group-${P.group}-${ee}`)),S.push(e.jsxs("button",{"data-slash-index":ee,className:["w-full text-left px-2 py-1 rounded flex items-center gap-2",ee===v.index?"bg-slate-100 dark:bg-slate-700":"hover:bg-slate-100 dark:hover:bg-slate-700"].join(" "),onMouseDown:re=>{re.preventDefault()},onClick:()=>v.invoke?.({action:P.id}),children:[e.jsx("span",{className:"shrink-0",children:Sl(P.id)}),e.jsx("span",{children:P.label})]},`item-${P.label}-${ee}`)),_=P.group}),S})()})}),document.body)]})]})}function Xp({content:s,onSave:t,onCancel:n,onCollapse:a,isSaving:r}){const[o,i]=h.useState(s),[l,c]=h.useState(!1),d=h.useRef(null),u=he(),m=X(j=>j.editorMode),p=X(j=>j.editingMessageId),f=X(j=>j.showDraftPrompt),g=X(h.useCallback(j=>p?j.drafts[p]:void 0,[p])),x=h.useMemo(()=>f&&!!g,[f,g]),y=g?.updatedAt;$n({textareaRef:d,updateContent:u.noteEditManager.updateContent,content:m==="markdown"?s:""}),h.useEffect(()=>{d.current&&d.current.focus()},[]),h.useEffect(()=>{i(s)},[s]);const v=j=>{i(j),u.noteEditManager.updateContent(j)},w=async()=>{if(o.trim()){c(!0);try{await t()}finally{c(!1)}}},b=()=>{n()},N=j=>{j.key==="Escape"?b():j.key==="s"&&sr(j)&&(j.preventDefault(),w())};return e.jsxs("div",{className:"w-full h-full min-h-0 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b border-slate-200 dark:border-slate-700 bg-slate-50/40 dark:bg-slate-800/30",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500 animate-pulse"}),e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Editing Thought"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(k,{variant:"ghost",size:"sm",onClick:a,className:"h-8 px-3 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200",children:[e.jsx(Da,{className:"w-3.5 h-3.5 mr-1.5"}),"Collapse"]})})]}),e.jsxs("div",{className:"flex-1 min-h-0 flex overflow-hidden",children:[e.jsxs("div",{className:[m==="wysiwyg"?"w-full":"w-1/2","min-h-0",m==="markdown"?"border-r border-slate-200 dark:border-slate-700":"","flex flex-col overflow-hidden"].join(" "),children:[e.jsx("div",{className:"px-3 py-2 border-b border-slate-200 dark:border-slate-700 bg-slate-50/30 dark:bg-slate-800/20",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-600 dark:text-slate-400",children:"Editor"}),e.jsxs("div",{className:"flex items-center gap-1 rounded-md border border-slate-200 dark:border-slate-700 p-0.5",children:[e.jsx(k,{variant:m==="markdown"?"secondary":"ghost",size:"sm",onClick:()=>u.noteEditManager.setEditorMode("markdown"),className:"h-7 px-2",children:"Markdown"}),e.jsx(k,{variant:m==="wysiwyg"?"secondary":"ghost",size:"sm",onClick:()=>u.noteEditManager.setEditorMode("wysiwyg"),className:"h-7 px-2",children:"WYSIWYG"})]})]}),e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-500",children:[o.length," characters"]})]})}),e.jsxs("div",{className:"flex-1 min-h-0 p-3 overflow-hidden flex flex-col",children:[x&&e.jsx("div",{className:"mb-3 rounded-md border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900 dark:border-amber-400/30 dark:bg-amber-500/10 dark:text-amber-100",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Unsaved draft available."}),y&&e.jsxs("span",{className:"ml-2 text-xs text-amber-700/80 dark:text-amber-100/80",children:["Saved ",Ha(new Date(y))]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-8 rounded-md bg-amber-500 px-3 text-xs font-medium text-white transition-colors hover:bg-amber-600",onClick:()=>u.noteEditManager.applyDraft(),children:"Restore draft"}),e.jsx("button",{type:"button",className:"h-8 rounded-md px-3 text-xs font-medium text-amber-700 transition-colors hover:bg-amber-100 hover:text-amber-900 dark:text-amber-100 dark:hover:bg-amber-500/20",onClick:()=>u.noteEditManager.dismissDraftPrompt(),children:"Dismiss"})]})]})}),m==="markdown"?e.jsx("textarea",{ref:d,value:o,onChange:j=>v(j.target.value),onKeyDown:N,placeholder:"Write your thought in Markdown...",className:"w-full h-full resize-none bg-transparent border-0 rounded-none text-base leading-relaxed placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:ring-0 focus:outline-none focus:border-0 shadow-none text-slate-800 dark:text-slate-200 font-mono",disabled:r,style:{caretColor:"#3b82f6"}}):e.jsx("div",{className:"w-full h-full",onKeyDown:N,children:e.jsx(Xs,{value:o,onChange:v,editable:!r,placeholder:"Write your thought...",variant:"frameless",className:"h-full px-4 pt-2"})})]})]}),m==="markdown"&&e.jsxs("div",{className:"w-1/2 min-h-0 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"px-3 py-2 border-b border-slate-200 dark:border-slate-700 bg-slate-50/30 dark:bg-slate-800/20",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-600 dark:text-slate-400",children:"Preview"}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-500",children:"Live Preview"})]})}),e.jsx("div",{className:"flex-1 min-h-0 p-3 overflow-y-auto",children:e.jsx("div",{className:"prose prose-slate dark:prose-invert max-w-none",children:o.trim()?e.jsx(Ys,{content:o}):e.jsx("div",{className:"text-slate-400 dark:text-slate-500 italic text-center py-8",children:"Start typing to see preview..."})})})]})]}),e.jsx("div",{className:"px-4 py-2 border-t border-slate-200 dark:border-slate-700 bg-slate-50/40 dark:bg-slate-800/30",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:[e.jsx("kbd",{className:"px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs border border-slate-200 dark:border-slate-700",children:"Cmd+S"}),e.jsx("span",{className:"ml-2",children:"to save,"}),e.jsx("kbd",{className:"px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs border border-slate-200 dark:border-slate-700 ml-2",children:Ma.CANCEL}),e.jsx("span",{className:"ml-2",children:"to cancel"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(k,{variant:"ghost",size:"sm",onClick:b,disabled:l,className:"h-8 px-3 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800",children:[e.jsx(le,{className:"w-3.5 h-3.5 mr-1.5"}),"Cancel"]}),e.jsx(k,{size:"sm",onClick:w,disabled:l||!o.trim(),className:"h-8 px-3 bg-blue-600 hover:bg-blue-700 text-white shadow-sm",children:l?e.jsxs(e.Fragment,{children:[e.jsx(ot,{className:"w-3.5 h-3.5 mr-1.5 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"w-3.5 h-3.5 mr-1.5"}),"Save"]})})]})]})})]})}const Jp=({className:s=""})=>{const t=he(),n=X(o=>!!(o.editingMessageId&&o.editMode==="expanded")),a=X(o=>o.editContent),r=X(o=>o.isSaving);return e.jsx(gt,{open:n,onOpenChange:o=>{o||t.noteEditManager.cancel()},children:e.jsx(pt,{showCloseButton:!1,className:`p-0 gap-0 overflow-hidden !inset-0 !max-w-none !w-screen !h-screen !translate-x-0 !translate-y-0 !rounded-none ${s}`,children:e.jsx(Xp,{content:a,onSave:()=>t.noteEditManager.save(!1),onCancel:()=>t.noteEditManager.cancel(),onCollapse:()=>t.noteEditManager.cancel(),isSaving:r})})})},Qp=600,Te=Ee((s,t)=>({statusMap:{},activeMessageId:null,inlineOverlap:!1,activeVisibleHeight:null,pendingCollapseId:null,layoutSync:null,shouldSuppressAutoScroll:!1,suppressionTimestamp:null,setStatus:(n,a)=>s(r=>({statusMap:{...r.statusMap,[n]:a}})),setActiveInfo:(n,a,r)=>s({activeMessageId:n,inlineOverlap:a,activeVisibleHeight:r}),requestCollapse:n=>s({pendingCollapseId:n}),acknowledgeCollapse:()=>s({pendingCollapseId:null}),registerLayoutSync:n=>s({layoutSync:n}),notifyLayoutChange:()=>{const n=t().layoutSync;n?.()},activateAutoScrollSuppression:()=>s({shouldSuppressAutoScroll:!0,suppressionTimestamp:Date.now()}),shouldSuppressAutoScrollNow:()=>{const n=t();return n.shouldSuppressAutoScroll?n.suppressionTimestamp&&Date.now()-n.suppressionTimestamp>Qp?(s({shouldSuppressAutoScroll:!1,suppressionTimestamp:null}),!1):!0:!1}})),tl=s=>{const t=s.activeMessageId;if(!t)return!1;const n=s.statusMap[t];return!n||!n.long||!n.expanded||!s.inlineOverlap?!1:n.collapseThreshold<=0||s.activeVisibleHeight==null?!0:s.activeVisibleHeight>n.collapseThreshold+1};function ps(){const{currentChannelId:s}=W(),t=Ct(h.useCallback(i=>s?i.timelineInputCollapsed[s]??!1:!1,[s])),n=Ct(h.useCallback(i=>i.setTimelineInputCollapsed,[])),a=Te(h.useCallback(i=>i.notifyLayoutChange,[])),r=h.useCallback(()=>{s&&(Ne.logInputCollapse(wa.COLLAPSE),n(s,!0),a())},[s,n,a]),o=h.useCallback(()=>{s&&(Ne.logInputCollapse(wa.EXPAND),n(s,!1),a())},[s,n,a]);return{inputCollapsed:t,handleCollapseInput:r,handleExpandInput:o,currentChannelId:s}}const kt=Ee()(s=>({expanded:!1,drafts:{},setExpanded:t=>s({expanded:t}),setDraft:(t,n)=>s(a=>({drafts:{...a.drafts,[t]:n}})),clearDraft:t=>s(n=>{const a={...n.drafts};return delete a[t],{drafts:a}})}));function Zp({message:s,onMessageChange:t,onKeyDown:n,placeholder:a,disabled:r}){const{handleExpandInput:o,inputCollapsed:i}=ps(),l=kt(u=>u.expanded);return e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"relative min-h-[80px]",onMouseDown:o,children:e.jsx(Xs,{value:s,onChange:t,editable:!r,placeholder:a,variant:"frameless",hideToolbar:!0,minHeight:80,maxHeight:120,enterSends:!0,suspended:i||l,onSubmitEnter:()=>{n({key:"Enter",metaKey:!0,ctrlKey:!0,preventDefault:()=>{}})}})})})}function ef({replyToMessage:s,onCancelReply:t}){return e.jsx("div",{className:"px-3 py-1.5 bg-blue-50 dark:bg-blue-900/20",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qc,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm text-blue-700 dark:text-blue-300",children:"Reply:"}),e.jsxs("span",{className:"text-sm text-slate-600 dark:text-slate-400 truncate",children:[s.content.substring(0,50),"..."]})]}),e.jsx("button",{onClick:t,className:"text-slate-400 hover:text-slate-600 dark:hover:text-slate-300",children:e.jsx(In,{className:"w-4 h-4"})})]})})}function pn({icon:s,onClick:t,title:n,disabled:a=!1,className:r=""}){const o="w-7 h-7 rounded-md flex items-center justify-center text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-slate-300 transition-all duration-200",i=a?"opacity-50 cursor-not-allowed":"cursor-pointer";return e.jsx("button",{onClick:()=>t?.(),disabled:a,className:`${o} ${i} ${r}`,title:n,children:e.jsx(s,{className:"w-4 h-4"})})}function tf({onSend:s,canSend:t,shortcutHint:n}){const a=[{icon:rs,title:"Image",onClick:void 0,enabled:Se().channel.input.image.enabled},{icon:Xe,title:"File",onClick:void 0,enabled:Se().channel.input.file.enabled},{icon:Zc,title:"Voice",onClick:void 0,enabled:Se().channel.input.voice.enabled},{icon:In,title:"More",onClick:void 0,enabled:Se().channel.input.more.enabled}].filter(r=>r.enabled);return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-1.5",children:a.map((r,o)=>e.jsx(pn,{icon:r.icon,onClick:r.onClick,title:r.title},o))}),e.jsxs("div",{className:"flex items-center gap-2",children:[n&&e.jsxs("span",{className:"text-xs text-slate-500 dark:text-slate-400",children:[n," to send"]}),e.jsx("button",{onClick:s,disabled:!t,className:`w-8 h-8 rounded-md flex items-center justify-center transition-colors duration-150 text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-slate-300 ${t?"":"opacity-40 cursor-not-allowed hover:bg-transparent"}`,"aria-label":"Send note",children:e.jsx(_o,{className:"w-4 h-4"})})]})]})}function sf(){const{sideView:s}=ve(),t=!s,{inputCollapsed:n,handleCollapseInput:a,handleExpandInput:r}=ps(),o=kt(i=>i.setExpanded);return e.jsxs("div",{className:`flex items-center justify-between px-2 ${t?"pt-1.5 pb-0.5":"pt-2 pb-1"}`,children:[e.jsx("div",{className:"flex items-center gap-1.5",children:e.jsx(pn,{icon:qs,onClick:()=>o(!0),title:"Expand composer"})}),e.jsx("div",{className:"flex items-center gap-1.5",children:n?e.jsx(pn,{icon:ed,onClick:r,title:"Show composer"}):e.jsx(pn,{icon:td,onClick:a,title:"Hide composer"})})]})}const fs=({onHistoryMessagesChange:s})=>{const{currentChannelId:t}=W(),n=h.useMemo(()=>is(V.dataContainer,`messageByChannel.${t}`),[t]),{value:{messages:a=[],loading:r,hasMore:o,loadingMore:i}={},get:l}=bi(n);return h.useEffect(()=>V.moreMessageLoadedEvent$.listen(({messages:c})=>s?.(c)),[]),h.useEffect(()=>V.connectToRequestWorkflow(),[]),h.useEffect(()=>{t&&V.requestLoadInitialMessages$.next({channelId:t})},[t]),{messages:a,loading:r,hasMore:o,loadMore:V.loadMoreHistory,loadingMore:i,getChannelState:l}},sl=()=>{const[s,t]=h.useState(void 0);return{replyToMessageId:s,clearReplyToMessageId:()=>{t(void 0)},handleCancelReply:()=>{t(void 0)},handleReply:o=>{t(o)}}};function nl(){const s=he(),t=h.useRef(null),{currentChannelId:n,isAddingMessage:a}=W(),{messages:r=[]}=fs({}),{clearReplyToMessageId:o,replyToMessageId:i,handleCancelReply:l}=sl(),c=h.useMemo(()=>i&&r.length>0?r.find(b=>b.id===i):null,[i,r]),d=kt(b=>b.expanded),u=kt(b=>n?b.drafts[n]??"":""),m=kt(b=>b.setDraft),p=kt(b=>b.clearDraft),f=u,g=async()=>{if(!f.trim()||!n)return;const b=f.trim(),N=b.includes("#"),j=_i.TEXT;Ne.logNoteCreate(n,j,b.length,N),i?(Ne.logMessageReply(i,n,i),s.threadManager.addThreadMessage(i,{content:b,sender:"user",channelId:n})):s.noteManager.sendMessage({content:b,sender:"user",channelId:n}),o(),s.rxEventBus.requestTimelineScrollToLatest$.emit(),p(n)},x=b=>{!d&&b.key==="Enter"&&(b.metaKey||b.ctrlKey)&&(b.preventDefault(),g())},y=b=>{n&&m(n,b)};h.useEffect(()=>{t.current&&(t.current.style.height="auto",t.current.style.height=`${Math.min(t.current.scrollHeight,200)}px`)},[f]);const v=h.useMemo(()=>c?"Reply to this message...":"What's on your mind...",[c]),w=h.useMemo(()=>`${_p()?"Command":"Ctrl"}+Enter`,[]);return{message:f,textareaRef:t,replyToMessage:c,isAddingMessage:a,handleSend:g,handleKeyDown:x,handleMessageChange:y,placeholder:v,shortcutHint:w,currentChannelId:n,handleCancelReply:l}}function nf(){const{message:s,textareaRef:t,replyToMessage:n,isAddingMessage:a,handleSend:r,handleKeyDown:o,handleMessageChange:i,placeholder:l,shortcutHint:c,handleCancelReply:d}=nl(),{sideView:u}=ve(),m=!u,{inputCollapsed:p}=ps(),[f,g]=h.useState(!1),x=f,y=`sticky bottom-0 z-10 shrink-0 ${m?"pb-4":""}`,v="overflow-hidden transition-[max-height,opacity,transform,padding] duration-220 ease-out will-change-[max-height,opacity,transform] origin-bottom",w="max-h-[180px] opacity-100 translate-y-0",b="max-h-0 opacity-0 translate-y-1 py-0",N=m?"rounded-xl border border-border/60 shadow-xs":"border-t border-border/60",j=h.useRef(null);return h.useEffect(()=>{const C=j.current;if(!C)return;const E=()=>g(!0),R=T=>{C.contains(T.relatedTarget)||g(!1)};return C.addEventListener("focusin",E),C.addEventListener("focusout",R),()=>{C.removeEventListener("focusin",E),C.removeEventListener("focusout",R)}},[]),e.jsx("div",{className:y,children:e.jsx("div",{ref:j,className:`${v} ${p?b:w} bg-background ${p?"":N}`,"aria-hidden":p,children:e.jsxs("div",{children:[n&&e.jsx(ef,{replyToMessage:n,onCancelReply:d}),e.jsx(sf,{}),e.jsx("div",{className:`relative px-2 ${m?"pt-1":"pt-0"}`,children:e.jsx(Zp,{message:s,onMessageChange:i,onKeyDown:o,placeholder:l,disabled:a,textareaRef:t})}),e.jsx("div",{className:"px-2 pb-1",children:e.jsx(tf,{onSend:r,canSend:!!s.trim()&&!a,shortcutHint:x?c:void 0})})]})})})}const af=()=>e.jsx("div",{className:"w-full p-4 space-y-3 border-b border-border/50",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(F,{className:"w-8 h-8 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(F,{className:"h-4 w-24"}),e.jsx(F,{className:"h-3 w-16"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{className:"h-4 w-full"}),e.jsx(F,{className:"h-4 w-3/4"}),e.jsx(F,{className:"h-4 w-1/2"})]}),e.jsxs("div",{className:"flex items-center space-x-2 pt-2",children:[e.jsx(F,{className:"h-6 w-16"}),e.jsx(F,{className:"h-6 w-16"}),e.jsx(F,{className:"h-6 w-16"})]})]})]})}),al=({count:s=3})=>e.jsx("div",{className:"w-full h-full overflow-hidden",children:Array.from({length:s}).map((t,n)=>e.jsx(af,{},n))}),Ea=({onClick:s,children:t,ariaLabel:n,isVisible:a=!0,className:r})=>a?e.jsx(k,{size:"sm",variant:"secondary",className:M("h-8 w-8 rounded-full p-0 shadow-lg",r),onClick:s,"aria-label":n,children:t}):null,rf=({onClick:s,isVisible:t})=>e.jsx(Ea,{onClick:s,isVisible:t,ariaLabel:"Scroll to top",children:e.jsx(Wt,{className:"h-4 w-4"})}),io=s=>typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(s):s.replace(/["\\]/g,"\\$&"),Ht={messageId:"data-message-id",collapseInlineFor:"data-collapse-inline-for"},cs={message:`[${Ht.messageId}]`,messageById:s=>`[${Ht.messageId}="${io(s)}"]`,collapseInlineFor:s=>`[${Ht.collapseInlineFor}="${io(s)}"]`},of=s=>s.getAttribute(Ht.messageId);function lf(s){const{container:t,element:n,onCollapse:a}=s,r=t.getBoundingClientRect(),i=n.getBoundingClientRect().top>=r.top;a(),i||setTimeout(()=>{const d=n.getBoundingClientRect().top-r.top;t.scrollTop+=d},300)}const cf=(s,t)=>{const n=s.getBoundingClientRect(),a=t.getBoundingClientRect(),r=n.top-a.top;t.scrollTop+=r};function df(s){const{container:t,element:n,onCollapse:a}=s,r=t.getBoundingClientRect();if(n.getBoundingClientRect().top>=r.top){a();return}else cf(n,t),setTimeout(()=>{a()},200)}function uf(s){if(!s)return 8;const n=getComputedStyle(s).getPropertyValue("--collapse-float-offset"),a=parseFloat(n);return Number.isFinite(a)?a:8}function hf(s){const t=Array.from(s.querySelectorAll(cs.message));if(!t.length)return{id:null,inlineOverlap:!1,visibleHeight:null};const n=s.getBoundingClientRect();let a=null;for(const d of t){const u=d.getBoundingClientRect();if(u.bottom<n.top||u.top>n.bottom)continue;const m=of(d);if(!m)continue;const p=Math.max(0,n.bottom-u.bottom);(!a||p<a.distance)&&(a={id:m,distance:p,rect:u})}if(!a)return{id:null,inlineOverlap:!1,visibleHeight:null};const o=s.querySelector(cs.collapseInlineFor(a.id))?.getBoundingClientRect(),i=uf(s),l=o?n.bottom-o.bottom<=i+.5:!1,c=Math.max(0,Math.min(n.bottom,a.rect.bottom)-Math.max(n.top,a.rect.top));return{id:a.id,inlineOverlap:l,visibleHeight:c}}function mf(s){const t=Te(tl),n=Te(h.useCallback(u=>u.requestCollapse,[])),a=Te(h.useCallback(u=>u.setActiveInfo,[])),r=Te(h.useCallback(u=>u.registerLayoutSync,[])),o=h.useRef(null),i=h.useRef(null),l=h.useCallback(()=>{const u=s.current;u&&(o.current&&cancelAnimationFrame(o.current),o.current=requestAnimationFrame(()=>{const{id:m,inlineOverlap:p,visibleHeight:f}=hf(u);a(m,p,f)}))},[s,a]);h.useEffect(()=>()=>{o.current&&cancelAnimationFrame(o.current),i.current?.disconnect()},[]),h.useEffect(()=>{const u=s.current;if(!u)return;const m=new MutationObserver(p=>{p.some(g=>g.type!=="childList"?!1:[...Array.from(g.addedNodes),...Array.from(g.removedNodes)].some(y=>y instanceof HTMLElement&&y.hasAttribute(Ht.messageId)))&&l()});return m.observe(u,{childList:!0,subtree:!0}),i.current=m,l(),()=>{m.disconnect()}},[s,l]),h.useEffect(()=>(r(l),()=>r(null)),[r,l]),h.useEffect(()=>(window.addEventListener("resize",l),()=>window.removeEventListener("resize",l)),[l]);const c=h.useCallback(()=>{l()},[l]),d=h.useCallback(()=>{const m=Te.getState().activeMessageId,p=s.current;if(!m||!p)return;const f=p.querySelector(cs.messageById(m));f&&lf({container:p,element:f,onCollapse:()=>n(m)})},[s,n]);return{showFloatingCollapse:t,handleScroll:c,collapseCurrent:d}}const gf=({date:s})=>{const t=ua(new Date(s),"MMM dd, yyyy");return e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"px-4 py-1.5 bg-slate-50/60 dark:bg-slate-900/40 rounded-lg",children:e.jsx("span",{className:"text-xs font-normal text-slate-500 dark:text-slate-400 tracking-wide",children:t})}),e.jsx("div",{className:"absolute -left-12 top-1/2 transform -translate-y-1/2 w-8 h-px bg-slate-200/40 dark:bg-slate-700/40"}),e.jsx("div",{className:"absolute -right-12 top-1/2 transform -translate-y-1/2 w-8 h-px bg-slate-200/40 dark:bg-slate-700/40"})]})})},rl=({renderThoughtRecord:s,className:t="",groupedMessages:n,messages:a,onScroll:r})=>{const o=he(),i=ve($=>$.sideView),l=W($=>$.currentChannelId),{inputCollapsed:c,handleExpandInput:d,handleCollapseInput:u}=ps(),[m,p]=h.useState(!1);h.useEffect(()=>{let B=null;return c?B=window.setTimeout(()=>p(!0),260):p(!1),()=>{B&&window.clearTimeout(B)}},[c]);const f=h.useRef(null);o.scrollManager.setScrollContainerRef(f);const g=h.useRef(null),[x,y]=h.useState(!1),v=30,w=h.useCallback($=>{const B=$?.behavior==="smooth"?"smooth":"auto";if(g.current){g.current.scrollTo({top:0,behavior:B});return}f.current?.scrollTo({top:0,behavior:B})},[]),{showFloatingCollapse:b,handleScroll:N,collapseCurrent:j}=mf(f),C=h.useRef(null),E=100,R=8,T=320,D=h.useRef(0),L=h.useCallback($=>{r?.($),N();const B=f.current;if(B){y(B.scrollTop>v);const A=Date.now();if(A<D.current)return;B.scrollTop>E?C.current!=="away"&&(u(),C.current="away",D.current=A+T):B.scrollTop<=R&&C.current!=="top"&&(d(),C.current="top",D.current=A+T)}},[r,N,u,d]);h.useEffect(()=>{C.current=c?"away":"top"},[c]),h.useEffect(()=>{const $=f.current;if(!$)return;const B=A=>{L(A)};return $.addEventListener("scroll",B,{passive:!0}),()=>$.removeEventListener("scroll",B)},[L]),Ba(o.rxEventBus.requestTimelineScrollToLatest$,$=>{const B=$?.behavior||"instant";w({behavior:B})}),h.useEffect(()=>{w({behavior:"instant"})},[w]),h.useEffect(()=>{d()},[l]);const U=h.useMemo(()=>{const $=new Map;for(const B of a??[]){const A=B.threadId||B.id;$.set(A,($.get(A)??0)+1)}return $},[a]),{items:z,indexMap:K}=h.useMemo(()=>{const $=[],B=new Map;return Object.entries(n).forEach(([A,ae])=>{$.push({type:"date-divider",date:A}),ae.filter(ue=>ue.sender==="user"&&!ue.parentId).forEach(ue=>{$.push({type:"message",message:ue}),B.set(ue.id,$.length-1)})}),{items:$,indexMap:B}},[n]),de=h.useRef(K);de.current=K,h.useEffect(()=>{const $={scrollToMessageId:(B,A)=>{const ae=de.current.get(B),ue=g.current;return ae===void 0||!ue?!1:(ue.scrollToIndex({index:ae,align:A?.align??"start",behavior:A?.behavior??"auto"}),!0)}};return o.scrollManager.setTimelineVirtualScrollApi($),()=>{o.scrollManager.setTimelineVirtualScrollApi(null)}},[o]);const pe=$=>{const B=$.threadId||$.id,A=U.get(B)??0,ae=A>1?A-1:0;return e.jsx("div",{[Ht.messageId]:$.id,className:"w-full",style:{height:"auto",minHeight:"auto"},children:s($,ae)},$.id)},Le=$=>e.jsx("div",{className:"w-full",style:{height:"auto",minHeight:"auto"},children:e.jsx(gf,{date:$})},$),Ie=$=>$.type==="date-divider"?Le($.date):pe($.message);return console.log("ðŸ”” [MessageTimeline][items]:",{items:z}),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`w-full bg-background flex-1 overflow-hidden min-h-0 ${t}`,style:{height:"100%",minHeight:"100%",maxHeight:"100%"},children:e.jsx(ti,{ref:$=>{g.current=$},data:z,itemContent:($,B)=>Ie(B),scrollerRef:$=>{f.current=$||null,$ instanceof HTMLDivElement&&$.classList.add("timeline-scroll")},style:{height:"100%",width:"100%"}})}),e.jsx("div",{className:"absolute top-8 right-4 z-20 pointer-events-none",children:e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsx("div",{className:"pointer-events-auto",children:e.jsx(Ea,{onClick:()=>{Ne.logAIAssistantOpen("",Pi.BUTTON),o.openAIAssistant()},isVisible:i!==nt.AI_ASSISTANT,ariaLabel:"Open AI Assistant",children:e.jsx(Et,{className:"h-4 w-4"})})}),e.jsx("div",{className:"pointer-events-auto",children:e.jsx(rf,{onClick:()=>{Ne.logScrollToLatest("",a.length),w({behavior:"smooth"})},isVisible:x})})]})}),e.jsx("div",{className:"absolute right-4 z-20 pointer-events-none",style:{bottom:"calc(env(safe-area-inset-bottom, 0px) + 16px)"},children:e.jsx("div",{className:`transition-opacity duration-150 ${m?"opacity-100":"opacity-0"}`,children:m&&e.jsx("div",{className:"pointer-events-auto",children:e.jsx(Ea,{onClick:d,ariaLabel:"Show composer",children:e.jsx(sd,{className:"h-4 w-4"})})})})}),e.jsx("div",{className:`pointer-events-none absolute left-1/2 -translate-x-1/2 z-20 transition-all duration-150 ${b?"opacity-100 -translate-y-1":"opacity-0 translate-y-0"}`,style:{bottom:"calc(env(safe-area-inset-bottom, 0px) + var(--collapse-float-offset, 8px))"},children:b&&e.jsx("div",{className:"pointer-events-auto",children:e.jsxs(k,{size:"sm",variant:"secondary",className:"h-8 rounded-full px-2.5 shadow-lg flex items-center gap-1 hover:bg-secondary",onClick:j,"aria-label":"Collapse current",children:[e.jsx(Wt,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs leading-none",children:"Collapse"})]})})})]})},ol=({className:s=""})=>e.jsx("div",{className:`flex-1 flex items-center justify-center p-8 ${s}`,children:e.jsx(St,{className:"max-w-md w-full border-2 border-dashed border-muted-foreground/20 bg-gradient-to-br from-background to-muted/20 shadow-lg",children:e.jsxs(ss,{className:"p-8 text-center space-y-6",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-blue-500/10 to-purple-500/10 rounded-2xl flex items-center justify-center mx-auto shadow-inner",children:e.jsx(mt,{className:"w-10 h-10 text-blue-500 dark:text-blue-400"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground",children:"Your space is ready!"}),e.jsx("p",{className:"text-muted-foreground leading-relaxed",children:"Start capturing your thoughts and ideas here. Your AI assistant will help you explore and develop them further."})]}),e.jsxs("div",{className:"bg-muted/30 rounded-lg p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"}),e.jsx("span",{children:"Type your first thought below"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("div",{className:"w-2 h-2 bg-purple-500 rounded-full"}),e.jsx("span",{children:"AI will help expand your ideas"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),e.jsx("span",{children:"Connect your ideas together"})]})]})]})})}),nr=(s,t={})=>{const{latestFirst:n=!1}=t;return h.useMemo(()=>{if(!s||s.length===0)return{};const a={};s.forEach(i=>{const l=new Date(i.timestamp).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"});a[l]||(a[l]=[]),a[l].push(i)}),Object.keys(a).forEach(i=>{a[i].sort((l,c)=>{const d=new Date(l.timestamp).getTime()-new Date(c.timestamp).getTime();return n?-d:d})});const r=Object.keys(a).sort((i,l)=>{const c=new Date(a[i][0]?.timestamp||0),d=new Date(a[l][0]?.timestamp||0),u=c.getTime()-d.getTime();return n?-u:u}),o={};return r.forEach(i=>{o[i]=a[i]}),o},[s,n])},il=({onTrigger:s,canTrigger:t,threshold:n=.2,direction:a="top",getState:r})=>({handleScroll:h.useCallback(i=>{if(!t||!r().hasMore||r().loading||r().loadingMore)return;const{scrollTop:l,scrollHeight:c,clientHeight:d}=i.currentTarget;a==="top"?l/(c-d)<n&&s():(c-l-d)/(c-d)<n&&s()},[t,r,n,s,a])}),pf=()=>{const{addChannel:s}=O(),t=async()=>{try{await s({name:"My First Space",emoji:"ðŸš€",description:"Start your journey here"})}catch(n){console.error("Failed to create first channel:",n)}};return e.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:e.jsxs("div",{className:"max-w-2xl w-full space-y-8",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto shadow-lg",children:e.jsx(mt,{className:"w-10 h-10 text-white"})}),e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Welcome to StillRoot"}),e.jsx("p",{className:"text-lg text-muted-foreground max-w-lg mx-auto",children:"Your personal space for thoughts, ideas, and AI-powered conversations. Let's create your first thought space to get started."})]}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-6",children:[e.jsxs(St,{className:"text-center",children:[e.jsxs(Ts,{className:"pb-3",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center mx-auto mb-2",children:e.jsx(Xe,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"})}),e.jsx(As,{className:"text-base",children:"Organize Thoughts"})]}),e.jsx(ss,{children:e.jsx(Ls,{className:"text-sm",children:"Create dedicated spaces for different topics and organize your thoughts systematically."})})]}),e.jsxs(St,{className:"text-center",children:[e.jsxs(Ts,{className:"pb-3",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center mx-auto mb-2",children:e.jsx(Et,{className:"w-6 h-6 text-green-600 dark:text-green-400"})}),e.jsx(As,{className:"text-base",children:"AI Assistant"})]}),e.jsx(ss,{children:e.jsx(Ls,{className:"text-sm",children:"Get help from AI to explore ideas, answer questions, and enhance your thinking process."})})]}),e.jsxs(St,{className:"text-center",children:[e.jsxs(Ts,{className:"pb-3",children:[e.jsx("div",{className:"w-12 h-12 bg-purple-100 dark:bg-purple-900/20 rounded-lg flex items-center justify-center mx-auto mb-2",children:e.jsx(us,{className:"w-6 h-6 text-purple-600 dark:text-purple-400"})}),e.jsx(As,{className:"text-base",children:"Spark Ideas"})]}),e.jsx(ss,{children:e.jsx(Ls,{className:"text-sm",children:"Capture inspiration, brainstorm solutions, and develop your creative potential."})})]})]}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs(k,{onClick:t,size:"lg",className:"bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white shadow-lg",children:[e.jsx(Me,{className:"w-5 h-5 mr-2"}),"Create Your First Space"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"You can always create more spaces later from the sidebar"})]})]})})};function ll(s){const t=X(u=>u.editingMessageId),n=X(u=>u.editContent),a=X(u=>u.editMode),r=X(u=>u.isSaving),o=t===s.id,i=o?n:s.content;return{isEditing:o,editContent:i,editMode:o?a:"inline",isSaving:o?r:!1,isExpandedEditing:o&&a==="expanded"}}function ff({icon:s,onClick:t,title:n,disabled:a,active:r,indicator:o}){return e.jsxs("button",{onClick:()=>t?.(),disabled:a,className:`relative p-2 transition-all duration-200 rounded-lg hover:scale-105 ${r?"bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-400":"text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 hover:bg-slate-200/60 dark:hover:bg-slate-700/60"} ${a?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,title:n,children:[e.jsx(s,{className:"w-4 h-4"}),o&&!a&&e.jsx("span",{className:"absolute -top-0.5 -right-0.5 h-2.5 w-2.5 rounded-full bg-red-500 shadow-[0_0_0_2px] shadow-white dark:shadow-slate-900"})]})}function xf({message:s,onDelete:t,onEdit:n,onCopy:a,onShare:r,onReport:o,onMove:i}){const l=()=>{a?a():navigator.clipboard.writeText(s.content)},c=[{id:"primary",showSeparator:!1,items:[...n?[{id:"edit",icon:e.jsx(Aa,{}),title:"Edit thought",description:"Modify this thought",onClick:n,variant:"default"}]:[],{id:"copy",icon:e.jsx(os,{}),title:"Copy content",onClick:l,variant:"default"},...r?[{id:"share",icon:e.jsx(ra,{}),title:"Share thought",description:"Share with others",onClick:r,variant:"default"}]:[],...i?[{id:"move",icon:e.jsx(Po,{}),title:"Move to space",onClick:i,variant:"default"}]:[],{id:"delete",icon:e.jsx(it,{}),title:"Delete thought",onClick:t,variant:"default"}]},{id:"secondary",title:"Statistics",variant:"default",items:[{id:"word-count",icon:e.jsx(Xe,{}),title:`${s.content.length} characters`,onClick:()=>{},disabled:!0}]},{id:"advanced",title:"Advanced",variant:"default",items:o?[{id:"report",icon:e.jsx(nd,{}),title:"Report",description:"Report inappropriate content",onClick:o,variant:"warning"}]:[]}];return e.jsx(Zi,{groups:c})}h.createContext(null);function xs({className:s,children:t,...n}){return e.jsxs(gc,{"data-slot":"scroll-area",className:M("relative",s),...n,children:[e.jsx(pc,{"data-slot":"scroll-area-viewport",className:"size-full rounded-[inherit] transition-[color,box-shadow] outline-none",children:t}),e.jsx(bf,{}),e.jsx(fc,{})]})}function bf({className:s,orientation:t="vertical",...n}){return e.jsx(xc,{"data-slot":"scroll-area-scrollbar",orientation:t,className:M("flex touch-none p-px transition-colors select-none",t==="vertical"&&"h-full w-2.5 border-l border-l-transparent",t==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent",s),...n,children:e.jsx(bc,{"data-slot":"scroll-area-thumb",className:"bg-border relative flex-1 rounded-full"})})}function cl({fromChannelId:s,onMove:t}){const n=O(x=>x.channels),[a,r]=h.useState(""),[o,i]=h.useState(null),[l,c]=h.useState(!1),[d,u]=h.useState(null),m=h.useMemo(()=>n.filter(x=>x.id!==s),[n,s]),p=h.useMemo(()=>{if(!a.trim())return m;const x=a.trim().toLowerCase();return m.filter(y=>y.name.toLowerCase().includes(x)||(y.description||"").toLowerCase().includes(x))},[m,a]),f=o?n.find(x=>x.id===o)??null:null,g=async()=>{if(!(!o||l)){c(!0),u(null);try{await t(o),we.close()}catch(x){const y=x instanceof Error?x.message:"Failed to move note. Please try again.";u(y),c(!1)}}};return e.jsxs("div",{className:"w-full max-w-md p-1 max-h-[80vh] flex flex-col",children:[e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900 dark:text-slate-100",children:"Move to space"}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:"Select a destination space for this thought. Any replies in the same thread move with it."})]}),m.length===0?e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400",children:"Create another space first to move this thought."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400",children:"Destination space"}),e.jsx(_e,{placeholder:"Search spaces",value:a,onChange:x=>r(x.target.value),disabled:l})]}),e.jsx(xs,{className:"mt-3 flex-1 min-h-[220px] max-h-[320px] pr-1",children:e.jsx("div",{className:"space-y-1.5 py-1",children:p.length===0?e.jsx("p",{className:"px-3 py-2 text-sm text-slate-500 dark:text-slate-400",children:"No spaces match your search."}):p.map(x=>{const y=x.id===o;return e.jsxs("button",{type:"button",className:M("w-full px-3 py-2 flex items-center gap-2.5 text-left text-sm transition-all duration-200 rounded-lg","hover:bg-accent/30 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary/20",y?"bg-primary/8 text-primary":"text-foreground"),onClick:()=>{i(x.id)},disabled:l,"aria-pressed":y,children:[x.emoji&&e.jsx("span",{className:"text-lg",children:x.emoji}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsx("p",{className:"font-medium truncate",children:x.name}),x.description&&e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 truncate",children:x.description})]}),y&&e.jsx(Ye,{className:"h-4 w-4 text-primary"})]},x.id)})})}),f&&e.jsxs("div",{className:"mt-3 rounded-md border border-slate-200/70 dark:border-slate-700/60 bg-slate-50 dark:bg-slate-800/40 px-3 py-2 text-xs text-slate-600 dark:text-slate-300",children:[e.jsx("span",{className:"font-semibold",children:"Will move to: "}),f.emoji&&e.jsx("span",{className:"mr-1",children:f.emoji}),e.jsx("span",{className:"font-medium",children:f.name}),f.description&&e.jsxs("span",{className:"ml-1 text-slate-500 dark:text-slate-400",children:["â€” ",f.description]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx(k,{type:"button",variant:"ghost",onClick:()=>we.close(),disabled:l,children:"Cancel"}),e.jsx(k,{type:"button",onClick:g,disabled:!o||l,children:l?e.jsxs(e.Fragment,{children:[e.jsx(ot,{className:"h-4 w-4 animate-spin mr-2"}),"Movingâ€¦"]}):"Confirm move"})]})]}),d&&e.jsx("p",{className:"mt-3 text-sm text-red-500",children:d})]})}function vf({onToggleAnalysis:s,onReply:t,message:n,isEditing:a,editorMode:r,onEditorModeChange:o,hasDraft:i=!1,draftEntry:l=null}){const c=he(),d=W(g=>g.currentChannelId)||"",u=async()=>{const g=n.content.length>100?`${n.content.substring(0,100)}...`:n.content;we.confirm({title:"Delete Thought",description:`This will move the thought to trash.

"${g}"

This action cannot be undone.`,okText:"Delete",okLoadingText:"Deleting...",okVariant:"destructive",cancelText:"Cancel",onOk:async()=>{try{await c.noteManager.deleteMessage({messageId:n.id,hardDelete:!1,channelId:d})}catch(x){const y=x instanceof Error?x.message:"Unknown error";alert(`âŒ Failed to delete the message.

Error: ${y}

Please try again.`)}}})},m=()=>{d&&we.show({content:e.jsx(cl,{fromChannelId:d,onMove:async g=>{await c.noteManager.moveMessage({messageId:n.id,fromChannelId:d,toChannelId:g})}}),showFooter:!1,className:"max-w-md"})},p=()=>{if(i&&l?.content){const g=l.updatedAt?Ha(new Date(l.updatedAt)):null,x=()=>{we.close(),c.noteEditManager.startEditing({messageId:n.id,content:n.content,restoreDraft:!0})},y=()=>{c.noteEditManager.discardDraft(n.id),we.close(),c.noteEditManager.startEditing({messageId:n.id,content:n.content})},v=()=>{we.close(),c.noteEditManager.startEditing({messageId:n.id,content:n.content})};we.show({title:"Unsaved draft available",content:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm text-slate-600 dark:text-slate-300",children:[g?`We kept a draft saved ${g}.`:"We kept an unsaved draft for you.",e.jsx("br",{}),"Choose how you want to continue."]}),e.jsx("div",{className:"max-h-48 overflow-y-auto rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 p-3 text-sm",children:e.jsx(Ys,{content:l.content})}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:justify-end",children:[e.jsx(k,{variant:"ghost",size:"sm",onClick:v,className:"sm:order-1",children:"Ignore draft"}),e.jsx(k,{variant:"ghost",size:"sm",onClick:y,className:"text-red-600 hover:text-red-700 hover:bg-red-50 dark:text-red-300 dark:hover:bg-red-500/20 sm:order-0",children:"Discard draft"}),e.jsx(k,{size:"sm",onClick:x,className:"bg-blue-600 text-white hover:bg-blue-700 sm:order-2",children:"Restore draft"})]})]}),showFooter:!1,className:"max-w-xl"});return}c.noteEditManager.startEditing({messageId:n.id,content:n.content})},f=[...a&&r&&o?[{icon:Oo,onClick:()=>o("markdown"),title:"Markdown mode",disabled:!1,enabled:!0,active:r==="markdown"},{icon:Xe,onClick:()=>o("wysiwyg"),title:"WYSIWYG mode",disabled:!1,enabled:!0,active:r==="wysiwyg"}]:[],{icon:Gt,onClick:p,title:i?"Edit thought (draft available)":"Edit thought",disabled:a,enabled:Se().channel.thoughtRecord.edit.enabled,indicator:i},{icon:us,onClick:s,title:"Toggle sparks",disabled:a,enabled:Se().channel.thoughtRecord.sparks.enabled},{icon:ad,onClick:void 0,title:"View details",disabled:a,enabled:Se().channel.thoughtRecord.viewDetails.enabled},{icon:Io,onClick:void 0,title:"Bookmark",disabled:a,enabled:Se().channel.thoughtRecord.bookmark.enabled},{icon:oa,onClick:t,title:"Reply to thought",disabled:a,enabled:Se().channel.thoughtRecord.reply.enabled}].filter(g=>g.enabled);return e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out",children:[f.map(({icon:g,onClick:x,title:y,disabled:v,active:w,indicator:b})=>e.jsx(ff,{icon:g,onClick:x,title:y,disabled:v,active:w,indicator:b},y)),e.jsx(xf,{message:n,onDelete:u,onCopy:()=>navigator.clipboard.writeText(n.content),onMove:d?m:void 0})]})}const dl=({actions:s,className:t,leftActions:n,rightActions:a})=>{const r=(o,i)=>e.jsxs(k,{variant:o.variant||"ghost",size:o.size||"sm",onClick:o.onClick,disabled:o.disabled,className:M("h-8 px-3 text-xs",o.className),children:[o.icon,o.label]},i);return e.jsxs("div",{className:M("flex items-center justify-between",t),children:[e.jsx("div",{className:"flex items-center gap-2",children:n?.map(r)}),s&&s.length>0&&e.jsx("div",{className:"flex items-center gap-2",children:s.map(r)}),e.jsx("div",{className:"flex items-center gap-2",children:a?.map(r)})]})};function yf({content:s,isSaving:t,editorMode:n,onEditorModeChange:a,className:r}){const o=he(),[i,l]=h.useState(s),c=h.useRef(null),d=X(b=>b.updateContent),u=X(b=>b.editingMessageId),m=X(b=>b.showDraftPrompt),p=X(h.useCallback(b=>u?b.drafts[u]:void 0,[u])),f=h.useMemo(()=>m&&!!p,[m,p]),g=p?.updatedAt;$n({textareaRef:c,updateContent:d,content:n==="markdown"?s:""}),h.useEffect(()=>{c.current&&c.current.focus()},[]),h.useEffect(()=>{l(s)},[s]),h.useEffect(()=>{if(c.current){c.current.style.height="auto";const b=300;c.current.style.height=`${Math.min(c.current.scrollHeight,b)}px`}},[i]);const x=b=>{l(b),d(b)},y=()=>{i.trim()&&o.noteEditManager.save()},v=()=>{o.noteEditManager.cancel()},w=b=>{b.key==="Escape"?v():b.key==="Enter"&&sr(b)&&y()};return e.jsxs("div",{className:M("space-y-4",r),children:[f&&e.jsx("div",{className:"rounded-md border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900 dark:border-amber-400/30 dark:bg-amber-500/10 dark:text-amber-100",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"We found an unsaved draft."}),g&&e.jsxs("span",{className:"ml-2 text-xs text-amber-700/80 dark:text-amber-100/80",children:["Saved ",Ha(new Date(g))]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-8 rounded-md bg-amber-500 px-3 text-xs font-medium text-white transition-colors hover:bg-amber-600",onClick:()=>o.noteEditManager.applyDraft(),children:"Restore draft"}),e.jsx("button",{type:"button",className:"h-8 rounded-md px-3 text-xs font-medium text-amber-700 transition-colors hover:bg-amber-100 hover:text-amber-900 dark:text-amber-100 dark:hover:bg-amber-500/20",onClick:()=>o.noteEditManager.dismissDraftPrompt(),children:"Dismiss"})]})]})}),e.jsx("div",{className:"relative rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm",children:n==="markdown"?e.jsx("textarea",{ref:c,value:i,onChange:b=>x(b.target.value),onKeyDown:w,placeholder:"Edit your thought...",className:"w-full min-h-[200px] max-h-[400px] resize-none bg-transparent border-0 rounded-none py-3 text-base leading-relaxed placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:ring-0 focus:outline-none focus:border-0 shadow-none text-slate-800 dark:text-slate-200 font-normal",disabled:t,style:{caretColor:"#3b82f6"}}):e.jsx("div",{onKeyDown:w,children:e.jsx(Xs,{value:i,onChange:x,editable:!t,placeholder:"Edit your thought...",variant:"frameless",compactToolbar:!0,minHeight:200,maxHeight:360,className:"px-3 pt-3"})})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:[e.jsx("kbd",{className:"px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs border border-slate-200 dark:border-slate-700",children:Ma.SAVE}),e.jsx("span",{className:"ml-2",children:"to save,"}),e.jsx("kbd",{className:"px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs border border-slate-200 dark:border-slate-700 ml-2",children:Ma.CANCEL}),e.jsx("span",{className:"ml-2",children:"to cancel"})]}),e.jsx(dl,{rightActions:[{label:"Expand",onClick:()=>o.noteEditManager.switchToExpandedMode(),disabled:t,icon:e.jsx(qs,{className:"w-3.5 h-3.5 mr-1.5"}),className:"text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800"},{label:"Cancel",onClick:()=>o.noteEditManager.cancel(),disabled:t,icon:e.jsx(le,{className:"w-3.5 h-3.5 mr-1.5"}),className:"text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800"},{label:t?"Saving...":"Save",onClick:()=>o.noteEditManager.save(),disabled:t||!i.trim(),icon:t?e.jsx(ot,{className:"w-3.5 h-3.5 mr-1.5 animate-spin"}):e.jsx(Ye,{className:"w-3.5 h-3.5 mr-1.5"}),className:"bg-blue-600 hover:bg-blue-700 text-white shadow-sm"}]})]})]})}function wf({children:s,onClick:t,className:n=""}){const a="hover:text-slate-600 dark:hover:text-slate-300 transition-colors duration-200",r=t?"cursor-pointer":"";return t?e.jsx("button",{onClick:t,className:`${a} ${r} ${n}`,children:s}):e.jsx("span",{className:`${a} ${n}`,children:s})}const ul=h.createContext(null),ar=()=>{const s=h.useContext(ul);if(!s)throw new Error("useDesktopPresenter must be used within a DesktopPresenterProvider");return s};function jf({message:s,hasSparks:t,aiAnalysis:n,onToggleAnalysis:a,threadCount:r}){return e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-400 dark:text-slate-500 px-6",children:[e.jsx("div",{className:"flex items-center gap-4 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out",children:t&&Se().channel.thoughtRecord.sparks.enabled&&e.jsxs(wf,{onClick:a,children:[n.insights.length," sparks"]})}),e.jsx("div",{className:"flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out",children:Se().channel.thoughtRecord.thread.enabled})]})}function hl({children:s,messageId:t,maxHeight:n,clampMargin:a=0,className:r,gradientClassName:o,readMoreLabel:i="Read more",collapseLabel:l="Collapse"}){const c=he(),d=Te(h.useCallback(D=>D.setStatus,[])),u=Te(D=>D.pendingCollapseId),m=Te(h.useCallback(D=>D.acknowledgeCollapse,[])),[p,f]=h.useState(!1),[g,x]=h.useState(!1),y=h.useRef(null),v=Te(tl),w=Te(h.useCallback(D=>D.activeMessageId,[])),b=Te(h.useCallback(D=>D.notifyLayoutChange,[])),N=Te(h.useCallback(D=>D.activateAutoScrollSuppression,[])),j=h.useRef(!1);h.useEffect(()=>{if(!y.current)return;const D=y.current.scrollHeight;x(D>n+a)},[s,n,a,p]),h.useEffect(()=>{d(t,{long:g,expanded:p,collapseThreshold:n+a})},[t,g,p,n,a,d]),h.useEffect(()=>{u===t&&p&&(f(!1),m())},[u,t,p,m]),h.useEffect(()=>{b()},[b,p,g]),h.useEffect(()=>{p&&!j.current&&N(),j.current=p},[p,N]);const C=()=>{const D=c.scrollManager.getScrollContainer();if(!D)return;const L=D.querySelector(cs.messageById(t));df({container:D,element:L,onCollapse:()=>f(!1)})},E=()=>{if(p)C();else{f(!0);return}},R=v&&w===t&&p,T={[Ht.collapseInlineFor]:t};return e.jsxs("div",{className:M("relative group overflow-hidden",r),children:[e.jsx("div",{ref:y,className:M("transition-all duration-100 ease-in-out",!p&&g?"overflow-hidden":"",p&&g?"pb-12":""),style:{maxHeight:!p&&g?`${n}px`:"none"},children:s}),!p&&g&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:M("pointer-events-none absolute inset-x-0 bottom-0 h-16 bg-gradient-to-t from-background via-background/60 to-transparent transition-colors duration-200 group-hover:from-muted group-hover:via-muted/50 group-hover:to-transparent z-0",o)}),e.jsxs("button",{type:"button",onClick:E,className:"absolute bottom-2 left-1/2 -translate-x-1/2 z-10 text-xs px-2 py-1.5 rounded-full bg-white/80 dark:bg-slate-900/60 backdrop-blur-sm text-muted-foreground shadow-sm border border-slate-200/30 dark:border-slate-700/30 flex items-center gap-1 active:scale-[0.98] transition-all duration-150 hover:bg-white/90 dark:hover:bg-slate-900/70 hover:shadow-md",children:[e.jsx("span",{children:i}),e.jsx(ze,{className:"w-3 h-3"})]})]}),p&&g&&e.jsxs("button",{type:"button",...T,onClick:E,className:M("absolute bottom-4 left-1/2 -translate-x-1/2 z-10 text-xs px-2 py-1.5 rounded-full bg-white/80 dark:bg-slate-900/60 backdrop-blur-sm text-muted-foreground shadow-sm border border-slate-200/30 dark:border-slate-700/30 flex items-center gap-1 active:scale-[0.98] transition-all duration-150 hover:bg-white/90 dark:hover:bg-slate-900/70 hover:shadow-md",R&&"opacity-0 pointer-events-none"),children:[e.jsx(Wt,{className:"w-3 h-3"}),e.jsx("span",{children:l})]})]})}function Nf({children:s,maxHeight:t=300,className:n="",messageId:a}){return e.jsx(hl,{messageId:a,maxHeight:t,className:M("relative overflow-hidden pb-2",n),children:s})}async function rr({schema:s,prompt:t,system:n,temperature:a,jsonOnly:r=!0}){if(!r){const c=(await _s.chat.completions.create({model:Ds,messages:[{role:"system",content:n||"You are a helpful assistant."},{role:"user",content:t}],temperature:typeof a=="number"?a:.3})).choices?.[0]?.message?.content;if(!c)throw new Error("No content generated");return c}const o={type:"function",function:{name:"generate_structured_data",description:"Generate structured data according to the specified schema",parameters:s}},i=n||"You are a helpful assistant that generates structured data according to specifications.";try{const c=(await _s.chat.completions.create({model:Ds,messages:[{role:"system",content:i},{role:"user",content:t}],tools:[o],tool_choice:{type:"function",function:{name:"generate_structured_data"}},temperature:typeof a=="number"?a:.3})).choices?.[0]?.message?.tool_calls?.[0];if(!c||c.type!=="function")throw new Error("No tool call generated");if(c.function.name!=="generate_structured_data")throw new Error("Unexpected tool call function name");const d=c.function.arguments;if(!d)throw new Error("No arguments in tool call");return JSON.parse(d)}catch(l){console.error("Failed to generate structured data using tools:",l),console.warn("Falling back to manual JSON generation...");const c=JSON.stringify(s,null,2),d=`You are a strict JSON generator. Return ONLY valid JSON that conforms to the following JSON schema:

${c}

IMPORTANT: Your response must be a valid JSON object that matches this schema exactly.`,u=`

Required output format: A single JSON object that matches the schema above. No markdown, no comments, no additional text.`,m=async(g,x=1)=>{const y=x>1?`

This is attempt ${x}. Please ensure the output strictly follows the schema.`:"",w=(await _s.chat.completions.create({model:Ds,messages:[{role:"system",content:`${d}${g?`
${g}`:""}${y}`},{role:"user",content:`${t}${u}`}],temperature:typeof a=="number"?a:.3})).choices?.[0]?.message?.content;return typeof w=="string"?w:""};let p=await m(),f;try{return f=JSON.parse(p),f}catch(g){console.warn("First fallback attempt failed, retrying...",g);const x=`The previous output did not match the expected JSON schema. 
Please fix the output to strictly conform to this schema:

${c}

Common issues to avoid:
- Extra text before or after JSON
- Missing required fields
- Wrong data types
- Extra commas or syntax errors

Output ONLY the valid JSON object.`;p=await m(x,2);try{return f=JSON.parse(p),f}catch(y){throw console.error("All attempts failed:",y),console.error("Generated text:",p),new Error(`Failed to generate valid JSON. Tool-based generation failed and fallback also failed. Last error: ${y}`)}}}}class Mn{static DEFAULT_OPTIONS={maxMessages:20,maxContentLength:2e3,excludeCurrentMessage:!0};static getChannelContext(t,n,a={}){const r={...this.DEFAULT_OPTIONS,...a},o=is(V.dataContainer,`messageByChannel.${t}`).get();if(!o?.messages)return console.warn(`[ChannelContextService] No messages found for channel: ${t}`),null;let i=o.messages;return r.excludeCurrentMessage&&n&&(i=i.filter(d=>d.id!==n)),{recentMessages:i.sort((d,u)=>u.timestamp.getTime()-d.timestamp.getTime()).slice(0,r.maxMessages).map(d=>({...d,content:this.truncateContent(d.content,r.maxContentLength)})),totalMessageCount:o.messages.length,channelId:t}}static formatContextForPrompt(t){return t.recentMessages.length===0?"":[`
<channel_context>`,"  <metadata>",`    <recent_messages_count>${t.recentMessages.length}</recent_messages_count>`,`    <total_messages_count>${t.totalMessageCount}</total_messages_count>`,`    <channel_id>${t.channelId}</channel_id>`,"  </metadata>","  <recent_thoughts>",...t.recentMessages.map((a,r)=>{const o=this.formatReadableTime(a.timestamp);return`    <thought index="${r+1}" timestamp="${o}">${a.content}</thought>`}),"  </recent_thoughts>",`</channel_context>
`].join(`
`)}static formatReadableTime(t){return t.toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}static truncateContent(t,n){if(t.length<=n)return t;const a=t.substring(0,n),r=Math.max(a.lastIndexOf("."),a.lastIndexOf("!"),a.lastIndexOf("?"));if(r>n*.7)return a.substring(0,r+1)+"...";const o=a.lastIndexOf(" ");return o>n*.8?a.substring(0,o)+"...":a+"..."}}const lo={type:"object",properties:{sparks:{type:"array",items:{type:"string"},minItems:3,maxItems:5}},required:["sparks"]};async function Cf(s){const{content:t,channelId:n,messageId:a,options:r={}}=s;let o="";if(r.includeChannelContext&&n){const l=Mn.getChannelContext(n,a,r.contextOptions);l&&(o=Mn.formatContextForPrompt(l))}const i=`<role>
You are StillRoot's intelligent thinking expansion assistant, designed to help users deepen their thoughts and promote cognitive growth.
</role>

<task>
Generate 3-5 thoughtful sparks based on the user's recorded thought below.

<strategy>
Since you can generate multiple sparks (3-5), strategically utilize this space to fully address different objectives and requirements. Each spark can focus on a different aspect, approach, or perspective to provide comprehensive coverage of the user's needs.

<spark_distribution_guide>
- Use 3 sparks minimum, 5 sparks maximum
- Distribute sparks across different objectives to maximize value
- Each spark should have a distinct focus and approach
- Vary the tone and style across sparks (analytical, creative, supportive, etc.)
- Ensure each spark provides unique value rather than repeating similar points
- Pay special attention to additional instructions - they may contain specific generation requirements or preferences that should be prioritized
- If additional instructions specify particular needs, adjust spark allocation and focus accordingly
</spark_distribution_guide>
</strategy>
</task>

<objectives>
<objective priority="high" spark_allocation="1-2">Expand thinking - Provide knowledge, insights, or perspectives that deepen understanding. Use 1-2 sparks to offer different angles of analysis or expertise.</objective>
<objective priority="high" spark_allocation="1">Show care - Express warmth, understanding, and support like a thoughtful friend. Use 1 spark to provide emotional support and encouragement.</objective>
<objective priority="high" spark_allocation="1-2">Adapt intelligently - Match the content type (analytical, emotional, creative, philosophical, etc.). Use 1-2 sparks to demonstrate different thinking styles or approaches.</objective>
<objective priority="high" spark_allocation="1">Promote growth - Help users learn, reflect, and develop their thinking. Use 1 spark to suggest actionable next steps or reflection questions.</objective>
${o?'<objective priority="medium" spark_allocation="1">Connect contextually - Consider related thoughts from the same channel to provide more relevant and connected insights. Use 1 spark to draw connections with previous thoughts.</objective>':""}
<objective priority="highest" spark_allocation="flexible">Additional Instructions - If additional instructions are provided, prioritize and incorporate them into spark generation. Adjust spark allocation and focus to meet specific user requirements mentioned in additional instructions.</objective>
</objectives>

<quality_requirements>
<requirement>Highly relevant to the user's thought</requirement>
<requirement>Educational and thought-provoking</requirement>
<requirement>Warm and supportive in tone</requirement>
<requirement>Varied in approach and perspective</requirement>
${o?"<requirement>Connected to the broader context of their thinking journey</requirement>":""}
</quality_requirements>

<user_content>
${t}
</user_content>
${o?`<context>${o}</context>`:""}${r.additionalInstructions?`

<additional_instructions>${r.additionalInstructions}</additional_instructions>`:""}`;console.log("Generating creative sparks with schema:",lo);try{const l=await rr({schema:lo,prompt:i,temperature:.9,jsonOnly:!0});return console.log("Successfully generated creative sparks:",l.sparks),l.sparks}catch(l){throw console.error("Failed to generate creative sparks:",l),l}}async function*kf(s,t){const{content:n,channelId:a,messageId:r,options:o={}}=s;if(!n||!n.trim())return;let i="";if(o.includeChannelContext&&a){const f=Mn.getChannelContext(a,r,o.contextOptions);f&&(i=Mn.formatContextForPrompt(f))}const l=`<role>
You are StillRoot's intelligent thinking expansion assistant.
</role>
<task>
Write 3-5 concise sparks (one per line, no numbering, each starting with "- ") for the user's thought below.
Keep them warm, insightful, and varied. No extra text before/after the list.
</task>
${o.additionalInstructions?`<additional_instructions>${o.additionalInstructions}</additional_instructions>`:""}
<user_content>
${n}
</user_content>
${i?`<context>${i}</context>`:""}`,c=await _s.chat.completions.create({model:Ds,stream:!0,temperature:.9,messages:[{role:"system",content:"You are a helpful assistant."},{role:"user",content:l}]}),d=[];let u="";const m=5,p=/^\s*[-*â€¢]\s+/;try{for await(const g of c){if(t?.signal?.aborted)throw new DOMException("Aborted","AbortError");const x=g.choices?.[0]?.delta?.content||"";if(!x)continue;u+=x;const y=u.split(/\r?\n/);u=y.pop()||"";for(const v of y){const w=String(v).trim();if(!w)continue;const b=p.test(w)?w.replace(p,"").trim():w;b&&(d.includes(b)||(d.push(b),d.length>m&&d.splice(m),yield[...d]))}d.length>=3}const f=u.trim();if(f){const g=p.test(f)?f.replace(p,"").trim():f;g&&!d.includes(g)&&d.length<m&&(d.push(g),yield[...d])}}catch(f){throw f.name==="AbortError"||console.error("generateSparksStream error:",f),f}}class Sf{rules=[];constructor(){this.initializeDefaultRules()}addRule(t){this.rules.push(t),this.rules.sort((n,a)=>(a.priority||0)-(n.priority||0))}removeRule(t){this.rules=this.rules.filter(n=>n.pattern.toString()!==t.toString())}processTags(t,n){const a=[];for(const o of n){const i=this.findMatchingRule(o);if(i){const l=i.handler(o,t);l&&a.push(l)}}return a.length===0?{enhancedPrompt:t,hasTagContext:!1}:{enhancedPrompt:`Special instructions:
${a.join(`
`)}`,hasTagContext:!0}}hasTagContext(t){return this.findMatchingRule(t)!==null}getSupportedPatterns(){return this.rules.map(t=>({pattern:t.pattern.toString(),description:t.description||"No description",priority:t.priority||0}))}findMatchingRule(t){for(const n of this.rules)if(typeof n.pattern=="string"){if(t.toLowerCase()===n.pattern.toLowerCase())return n}else if(n.pattern.test(t))return n;return null}initializeDefaultRules(){this.addRule({pattern:"prompt",handler:(t,n)=>`<instruction>${n}</instruction>`,priority:10,description:"Convert content to instruction"}),this.addRule({pattern:"translate",handler:(t,n)=>`<translate>${n}</translate>`,priority:10,description:"Translate content"}),this.addRule({pattern:"to-english",handler:(t,n)=>`<translate-to-english>${n}</translate-to-english>`,priority:10,description:"Translate content to English"}),this.addRule({pattern:/^prompt:/i,handler:t=>{const n=t.substring(7).trim();return n?`<instruction>${n}</instruction>`:""},priority:20,description:"Any tag starting with prompt: becomes an instruction"})}}const Mf=new Sf;function Ef(s,t){return Mf.processTags(s,t)}function ml(s,t){const{enableContextEnhancement:n=!0,mode:a="batch",minContentLength:r=8}=t||{},[o,i]=h.useState(!1),[l,c]=h.useState(null),[d,u]=h.useState(null),[m,p]=h.useState(!1),f=h.useRef(null),g=(s.content||"").trim().length<r,{hasTagContext:x,enhancedPrompt:y}=h.useMemo(()=>Ef(s.content,s.tags||[]),[s.content,s.tags]),v=h.useCallback(async E=>{const{userId:R}=O.getState();if(!R)throw new Error("User not authenticated");await V.updateMessage({messageId:s.id,channelId:s.channelId,updates:{aiAnalysis:{...s.aiAnalysis||{},insights:E,keywords:s.aiAnalysis?.keywords??[],topics:s.aiAnalysis?.topics??[],sentiment:s.aiAnalysis?.sentiment??"neutral",summary:s.aiAnalysis?.summary??"",tags:s.aiAnalysis?.tags??[],relatedTopics:s.aiAnalysis?.relatedTopics??[]}},userId:R})},[s.id,s.channelId,s.aiAnalysis]),w=h.useCallback(()=>{f.current?.abort()},[]),b=h.useCallback(async()=>{c(null),i(!0);try{const E=await Cf({content:s.content,channelId:s.channelId,messageId:s.id,options:{includeChannelContext:n,additionalInstructions:x?y:void 0}});u(E),await v(E)}finally{i(!1)}},[s.content,s.channelId,s.id,n,x,y,v]),N=h.useCallback(async()=>{c(null),i(!0),p(!0);const E=new AbortController;f.current=E;const R=[];try{for await(const T of kf({content:s.content,channelId:s.channelId,messageId:s.id,options:{includeChannelContext:n,additionalInstructions:x?y:void 0}},{signal:E.signal}))u(T);R.length===0&&d?.length?await v(d):R.length>0&&await v(R)}catch(T){T?.name==="AbortError"||c(T.message||"Failed to generate sparks")}finally{p(!1),i(!1),f.current=null}},[s.content,s.channelId,s.id,n,x,y,v,d]),j=h.useCallback(async()=>{o||g||(a==="stream"?await N():await b())},[o,g,a,b,N]),C=h.useCallback(async()=>{u(null),await j()},[j]);return{isGenerating:o,isStreaming:m,error:l,hasTagContext:x,contentTooShort:g,sparks:d,generate:j,regenerate:C,cancel:w}}function If({message:s,showAnalysis:t,className:n,onClose:a,enableContextEnhancement:r=!0,mode:o="stream"}){const i=s.aiAnalysis,l=!!(i&&i.insights&&i.insights.length>0),{isGenerating:c,error:d,hasTagContext:u,sparks:m,generate:p,regenerate:f}=ml(s,{enableContextEnhancement:r,mode:o}),g=!!(m&&m.length||l),x=m??i?.insights??[];return t?e.jsx("div",{className:M("mb-4 p-4 bg-slate-50/60 dark:bg-slate-800/30 rounded-lg border border-slate-200/50 dark:border-slate-700/50",n),children:e.jsx("div",{className:"space-y-4",children:g?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Creative Sparks"}),u&&e.jsx("span",{className:"text-xs px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-full",children:"Tag-enhanced"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{onClick:f,variant:"outline",disabled:c,children:c?"Generating...":"Regenerate"}),a&&e.jsx("button",{onClick:a,className:"p-1 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-all duration-200 rounded hover:bg-slate-200/60 dark:hover:bg-slate-700/60",title:"Close analysis",children:e.jsx(le,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"space-y-3",children:[x.map((y,v)=>e.jsx("div",{className:"p-3 bg-white/60 dark:bg-slate-700/40 rounded-lg border border-slate-200/40 dark:border-slate-600/40",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-yellow-500/80 mt-2 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-slate-700 dark:text-slate-200 leading-relaxed",children:y})]})},v)),d&&e.jsx("div",{className:"text-xs text-red-500 px-1.5",children:d})]})]}):e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Creative Sparks"}),u&&e.jsx("span",{className:"text-xs px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-full",children:"Tag-enhanced"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"outline",onClick:p,disabled:c,children:c?"Generating...":"Generate Sparks"}),a&&e.jsx("button",{onClick:a,className:"p-1 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-all duration-200 rounded hover:bg-slate-200/60 dark:hover:bg-slate-700/60",title:"Close analysis",children:e.jsx(le,{className:"w-4 h-4"})})]})]})})}):null}function Tf(s){const[t,n]=h.useState(!1),a=s.aiAnalysis,r=!!a?.insights?.length;return{showAnalysis:t,handleToggleAnalysis:()=>{n(!t)},aiAnalysis:a,hasSparks:r}}function Af({tags:s,onTagsChange:t,trigger:n,maxTags:a=10,placeholder:r="Add a tag..."}){const[o,i]=h.useState(!1),[l,c]=h.useState(""),[d,u]=h.useState(null),m=h.useRef(null);h.useEffect(()=>{o&&m.current&&m.current.focus()},[o]);const p=N=>{const j=N.trim().toLowerCase();if(j){if(s.includes(j)){c("");return}s.length>=a||(t([...s,j]),c(""))}},f=N=>{t(s.filter(j=>j!==N))},g=N=>{N.key==="Enter"?(N.preventDefault(),p(l)):N.key==="Escape"&&i(!1)},x=()=>{p(l)},y=N=>{u(N),c(N),m.current&&m.current.focus()},v=()=>{if(d&&l.trim()){const N=l.trim().toLowerCase();N!==d&&!s.includes(N)&&t(s.map(j=>j===d?N:j)),u(null),c("")}},w=()=>{u(null),c("")},b=N=>{N.key==="Enter"?(N.preventDefault(),v()):N.key==="Escape"&&w()};return e.jsxs(Us,{open:o,onOpenChange:i,children:[e.jsx(zs,{asChild:!0,children:n||e.jsxs(k,{variant:"ghost",size:"sm",className:"h-8 px-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 dark:text-slate-400 dark:hover:text-slate-100 dark:hover:bg-slate-800",children:[e.jsx(ia,{className:"h-4 w-4 mr-1"}),"Tags",s.length>0&&e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-xs bg-slate-200 dark:bg-slate-700 rounded-full",children:s.length})]})}),e.jsxs(Fs,{className:"w-80 p-0",align:"start",side:"bottom",children:[e.jsxs("div",{className:"p-3 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(ia,{className:"h-4 w-4 text-slate-600 dark:text-slate-400"}),e.jsx("h3",{className:"text-sm font-medium text-slate-900 dark:text-slate-100",children:"Edit Tags"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_e,{ref:m,value:l,onChange:N=>c(N.target.value),onKeyPress:d?b:g,placeholder:d?`Edit "${d}"`:r,className:"flex-1"}),d?e.jsxs("div",{className:"flex gap-1",children:[e.jsx(k,{size:"sm",variant:"outline",onClick:w,className:"px-2",children:e.jsx(le,{className:"h-3 w-3"})}),e.jsx(k,{size:"sm",onClick:v,disabled:!l.trim(),className:"px-2",children:"âœ“"})]}):e.jsx(k,{size:"sm",onClick:x,disabled:!l.trim()||s.length>=a,className:"px-2",children:e.jsx(Me,{className:"h-3 w-3"})})]})]}),e.jsx("div",{className:"p-3",children:s.length===0?e.jsx("div",{className:"text-center py-4 text-slate-500 dark:text-slate-400 text-sm",children:"No tags yet. Add some above."}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400 mb-2",children:[s.length," of ",a," tags"]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:s.map(N=>e.jsxs("div",{className:"group flex items-center gap-1 bg-slate-100 dark:bg-slate-800 rounded-md px-2 py-1 text-sm",children:[e.jsx("span",{className:"cursor-pointer hover:text-blue-600 dark:hover:text-blue-400",onClick:()=>y(N),children:N}),e.jsx("button",{onClick:()=>f(N),className:"opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-slate-600 dark:hover:text-slate-300",children:e.jsx(le,{className:"h-3 w-3"})})]},N))})]})})]})]})}const Lf={default:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",secondary:"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200",outline:"border border-gray-300 text-gray-700 dark:border-gray-600 dark:text-gray-300",destructive:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200",footer:"bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200"},Rf={sm:"px-2 py-1 text-xs",md:"px-2.5 py-1.5 text-sm",lg:"px-3 py-2 text-base"};function Df({name:s,variant:t="default",size:n="sm",removable:a=!1,onClick:r,onRemove:o,className:i,truncate:l=!1,maxWidth:c="80px"}){const d=u=>{u.stopPropagation(),o?.()};return e.jsxs("span",{className:M("inline-flex items-center gap-1 rounded-full font-medium transition-colors",Lf[t],Rf[n],r&&"cursor-pointer hover:opacity-80",l&&"max-w-[80px]",i),style:l?{maxWidth:c}:void 0,onClick:r,title:l?s:void 0,children:[e.jsxs("span",{className:M(l&&"truncate"),children:["#",s]}),a&&e.jsx(k,{variant:"ghost",size:"sm",className:"h-4 w-4 p-0 hover:bg-transparent",onClick:d,children:e.jsx(le,{className:"h-3 w-3"})})]})}function _f({tags:s,variant:t="default",size:n="sm",removable:a=!1,onTagClick:r,onTagRemove:o,className:i,maxTags:l,truncate:c=!1,maxWidth:d="80px"}){const u=l?s.slice(0,l):s,m=l&&s.length>l?s.length-l:0;return s.length===0?null:e.jsxs("div",{className:M("flex flex-wrap gap-1",i),children:[u.map(p=>e.jsx(Df,{name:p,variant:t,size:n,removable:a,onClick:()=>r?.(p),onRemove:()=>o?.(p),truncate:c,maxWidth:d},p)),m>0&&e.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:["+",m," more"]})]})}function Pf({tags:s,onTagsChange:t,maxTags:n=10}){return e.jsxs("div",{className:"flex items-center gap-2",children:[s.length>0&&e.jsx(_f,{tags:s,variant:"footer",size:"sm",maxTags:2,truncate:!0,maxWidth:"80px"}),e.jsx(Af,{tags:s,onTagsChange:t,maxTags:n,trigger:e.jsx("button",{type:"button",className:"inline-flex items-center justify-center rounded-lg p-1.5 transition-all duration-200 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 hover:bg-slate-200/60 dark:hover:bg-slate-700/60 cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-slate-400 dark:focus-visible:ring-slate-500",title:s.length>0?`${s.length} tags`:"Add tags","aria-label":s.length>0?`${s.length} tags`:"Add tags",children:e.jsx(ia,{className:"h-3 w-3"})})})]})}function Of({message:s,onReply:t,threadCount:n=0}){const a=he(),r=W(C=>C.currentChannelId)||"",o=O(C=>C.userId),{isEditing:i,editContent:l,editMode:c,isSaving:d}=ll(s),{showAnalysis:u,aiAnalysis:m,hasSparks:p,handleToggleAnalysis:f}=Tf(s),[g,x]=h.useState(s.tags||[]),y=X(h.useCallback(C=>C.drafts[s.id]??null,[s.id])),v=h.useMemo(()=>tr(s.content),[s.content]),w=!!y&&y.baseHash===v,b=X(C=>C.editorMode);h.useEffect(()=>{x(s.tags||[])},[s.tags]);const N=async C=>{if(x(C),!(!o||!r))try{await a.noteManager.updateMessage({messageId:s.id,channelId:r,updates:{tags:C},userId:o})}catch(E){console.error("Failed to update tags:",E),x(s.tags||[])}};if(s.isDeleted)return null;const j=Se().channel.thoughtRecord.tags.enabled;return e.jsx("div",{className:"w-full","data-component":"thought-record",children:e.jsxs("div",{className:`group relative w-full py-2 transition-all duration-300 ease-out ${i?"bg-gray-100/60 dark:bg-gray-800/30":"hover:bg-gray-100/80 dark:hover:bg-gray-800/20"} ${s.isNew?"animate-in slide-in-from-bottom-5 fade-in duration-400":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 px-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 font-medium",children:[e.jsx(Tn,{className:"w-3 h-3"}),e.jsx("span",{children:Tt(s.timestamp)})]}),!i&&j&&e.jsx("div",{className:"opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto transition-all duration-300 ease-out",children:e.jsx(Pf,{tags:g,onTagsChange:N,maxTags:10})})]}),e.jsx(vf,{onToggleAnalysis:f,onReply:t,message:s,isEditing:i,editorMode:b,onEditorModeChange:a.noteEditManager.setEditorMode,hasDraft:!i&&w,draftEntry:y??null})]}),i&&c==="inline"?e.jsx(yf,{content:l,isSaving:d,editorMode:b,onEditorModeChange:a.noteEditManager.setEditorMode,className:"px-6"}):e.jsx("div",{className:"px-6",children:e.jsx(Nf,{maxHeight:300,messageId:s.id,children:e.jsx(Ys,{content:s.content})})}),!i&&e.jsx(If,{message:s,showAnalysis:u,className:"px-6 mx-6",onClose:f}),!i&&e.jsx(jf,{message:s,hasSparks:p,aiAnalysis:m||null,onToggleAnalysis:f,threadCount:n})]})})}const ln=({children:s="",className:t=""})=>e.jsx("div",{className:`flex-1 flex flex-col min-h-0 relative ${t}`,children:s}),$f=({className:s=""})=>{const t=he(),{currentChannelId:n}=W(),{messages:a,loading:r,hasMore:o,loadMore:i,getChannelState:l}=fs({onHistoryMessagesChange:m=>{t.rxEventBus.onHistoryMessagesLoadedEvent$.emit(m)}}),{handleScroll:c}=il({onTrigger:()=>n&&i({channelId:n,messagesLimit:20}),canTrigger:!!o&&!r,getState:l,direction:"bottom"}),d=nr(a,{latestFirst:!0}),u=Object.values(d).some(m=>m.some(p=>p.sender==="user"&&!p.parentId));return n?r?e.jsx(ln,{children:e.jsx(al,{count:5})}):u?e.jsx(ln,{className:s,children:e.jsx("div",{className:`flex-1 flex flex-col min-h-0 relative ${s}`,children:e.jsx(rl,{renderThoughtRecord:(m,p)=>e.jsx(Of,{message:m,threadCount:p}),groupedMessages:d,messages:a,onScroll:c})})}):e.jsx(ln,{children:e.jsx(ol,{})}):e.jsx(ln,{children:e.jsx(pf,{})})},Uf=[{id:"gradient-1",name:"Ocean Breeze",type:"gradient",value:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",preview:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"},{id:"gradient-2",name:"Sunset Glow",type:"gradient",value:"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",preview:"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"},{id:"gradient-3",name:"Forest Mist",type:"gradient",value:"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",preview:"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"},{id:"gradient-4",name:"Warm Sand",type:"gradient",value:"linear-gradient(135deg, #fa709a 0%, #fee140 100%)",preview:"linear-gradient(135deg, #fa709a 0%, #fee140 100%)"},{id:"gradient-5",name:"Purple Haze",type:"gradient",value:"linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",preview:"linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)"},{id:"gradient-6",name:"Midnight Sky",type:"gradient",value:"linear-gradient(135deg, #2c3e50 0%, #3498db 100%)",preview:"linear-gradient(135deg, #2c3e50 0%, #3498db 100%)"}],zf=[{id:"color-1",name:"Soft Blue",type:"color",value:"#e3f2fd",preview:"#e3f2fd"},{id:"color-2",name:"Warm Gray",type:"color",value:"#f5f5f5",preview:"#f5f5f5"},{id:"color-3",name:"Mint Green",type:"color",value:"#e8f5e8",preview:"#e8f5e8"},{id:"color-4",name:"Lavender",type:"color",value:"#f3e5f5",preview:"#f3e5f5"},{id:"color-5",name:"Peach",type:"color",value:"#fff3e0",preview:"#fff3e0"},{id:"color-6",name:"Rose",type:"color",value:"#fce4ec",preview:"#fce4ec"}],Ff=(s=6)=>{const t=[],n=new Set;for(;t.length<s;){const a=Math.floor(Math.random()*1e3)+1;n.has(a)||(n.add(a),t.push({id:`random-${a}`,name:`Image ${t.length+1}`,type:"image",value:`https://picsum.photos/id/${a}/800/400`,preview:`https://picsum.photos/id/${a}/100/100`}))}return t},Bf=({currentBackground:s,onBackgroundSelect:t})=>{const n=a=>s===a.value;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Gradients"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:Uf.map(a=>e.jsx("button",{onClick:r=>{r.preventDefault(),r.stopPropagation(),t(a)},className:`relative aspect-square rounded-lg border-2 transition-all duration-200 hover:scale-105 cursor-pointer ${n(a)?"border-primary":"border-border hover:border-primary/50"}`,style:{background:a.preview},title:a.name,children:n(a)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 rounded-lg",children:e.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})},a.id))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Solid Colors"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:zf.map(a=>e.jsx("button",{onClick:r=>{r.preventDefault(),r.stopPropagation(),t(a)},className:`relative aspect-square rounded-lg border-2 transition-all duration-200 hover:scale-105 cursor-pointer ${n(a)?"border-primary":"border-border hover:border-primary/50"}`,style:{background:a.preview},title:a.name,children:n(a)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 rounded-lg",children:e.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})},a.id))})]})]})},Hf=({currentBackground:s,onBackgroundSelect:t})=>{const[n,a]=h.useState(""),[r,o]=h.useState([]),[i,l]=h.useState(!1),c=f=>s===f.value,d=async()=>{l(!0);try{const f=Ff(6);o(f)}finally{l(!1)}},u=()=>{d()},m=()=>{if(!n.trim())return;const f={id:`custom-${Date.now()}`,name:"Custom Image",type:"image",value:n.trim(),preview:n.trim()};t(f),a("")},p=f=>{try{return new URL(f),f.match(/\.(jpg|jpeg|png|gif|webp|svg)(\?.*)?$/i)}catch{return!1}};return h.useEffect(()=>{d()},[]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground",children:"Random Images"}),e.jsx(k,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:u,disabled:i,children:i?e.jsx(ot,{className:"h-3 w-3 animate-spin"}):e.jsx(as,{className:"h-3 w-3"})})]}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:i?Array.from({length:6}).map((f,g)=>e.jsx("div",{className:"aspect-square rounded-lg border-2 border-border bg-muted animate-pulse"},g)):r.map(f=>e.jsxs("button",{onClick:g=>{g.preventDefault(),g.stopPropagation(),t(f)},className:`relative aspect-square rounded-lg border-2 transition-all duration-200 hover:scale-105 cursor-pointer overflow-hidden ${c(f)?"border-primary":"border-border hover:border-primary/50"}`,title:f.name,children:[e.jsx("img",{src:f.preview,alt:f.name,className:"w-full h-full object-cover",onError:g=>{const x=g.target;x.style.display="none"}}),c(f)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 rounded-lg",children:e.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})]},f.id))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Custom Image URL"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{type:"url",placeholder:"Enter image URL (jpg, png, gif, webp, svg)",value:n,onChange:f=>a(f.target.value),className:"text-xs"}),e.jsxs(k,{variant:"outline",size:"sm",className:"w-full",onClick:m,disabled:!n.trim()||!p(n),children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Add Image"]}),n&&!p(n)&&e.jsx("p",{className:"text-xs text-destructive",children:"Please enter a valid image URL"})]})]})]})};function Gf({currentBackground:s,onBackgroundChange:t,onRemoveBackground:n,buttonClassName:a="h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105"}){const[r,o]=h.useState(!1),[i,l]=h.useState("colors"),[c,d]=h.useState(s),u=h.useRef(!1);h.useEffect(()=>{u.current=r},[r]);const m=g=>{g&&d(s),o(g)},p=g=>{g.type==="gradient"||g.type==="color"?t({type:"color",value:g.value}):g.type==="image"&&t({type:"image",value:g.value})},f=()=>{c?(console.log("ðŸŽ¨ [BackgroundSwitcher] Resetting background to:",{originalBackground:c}),t({type:c.type,value:c.value||""})):n()};return e.jsxs(q,{open:r,onOpenChange:m,children:[e.jsx(q.Trigger,{asChild:!0,children:e.jsx(k,{variant:"ghost",size:"sm",className:a,title:"Change background",children:e.jsx(Hn,{className:"h-4 w-4"})})}),e.jsxs(q.Content,{width:"w-80",align:"center",side:"bottom",onInteractOutside:g=>{g.preventDefault()},children:[e.jsxs(q.Header,{children:[e.jsx(Hn,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:"Background"}),e.jsx(q.Button,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:()=>o(!1),title:"Close",children:e.jsx(le,{className:"h-3 w-3"})})]}),e.jsxs(q.Body,{children:[e.jsxs("div",{className:"flex space-x-1 mb-4",children:[e.jsxs(q.Button,{variant:i==="colors"?"default":"outline",size:"sm",className:"flex-1",onClick:()=>l("colors"),children:[e.jsx(Hn,{className:"h-4 w-4 mr-2"}),"Colors"]}),e.jsxs(q.Button,{variant:i==="images"?"default":"outline",size:"sm",className:"flex-1",onClick:()=>l("images"),children:[e.jsx(rs,{className:"h-4 w-4 mr-2"}),"Images"]})]}),e.jsx("div",{className:"max-h-64 overflow-y-auto",children:i==="colors"?e.jsx(Bf,{currentBackground:s?.value,onBackgroundSelect:p}):e.jsx(Hf,{currentBackground:s?.value,onBackgroundSelect:p})}),e.jsx("div",{className:"mt-4 pt-3 border-t border-border",children:e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Choose a background to personalize your channel"}),e.jsx("div",{className:"flex justify-center",children:e.jsx(q.Button,{variant:"outline",size:"sm",className:"h-6 px-3 text-xs",onClick:f,title:"Reset to original background",children:"Reset"})})]})})]})]})]})}const Vf=({channel:s,isSelected:t,isCurrent:n,onSelect:a,highlightQuery:r})=>{const o=h.useCallback(()=>{a(s.id)},[s.id,a]),i=(l,c)=>{if(!c)return l;const d=l.split(new RegExp(`(${c})`,"gi"));return e.jsx(e.Fragment,{children:d.map((u,m)=>u.toLowerCase()===c.toLowerCase()?e.jsx("mark",{className:"bg-primary/20 text-primary font-medium px-0.5 rounded",children:u},m):e.jsx("span",{children:u},m))})};return e.jsxs("div",{role:"option","aria-selected":t,onClick:o,className:M("flex items-center gap-2 px-2.5 py-1.5 rounded-lg cursor-pointer transition-all duration-200 min-h-[40px]",t?"bg-primary/6 text-primary":"hover:bg-accent/25 text-foreground",n&&!t&&"ring-1 ring-primary/30"),children:[e.jsx("div",{className:"w-5 h-5 rounded flex items-center justify-center flex-shrink-0 text-muted-foreground",children:s.emoji?e.jsx("span",{className:"text-sm leading-none",children:s.emoji}):Xi(s.id)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"font-medium text-sm truncate",children:r?i(s.name,r):s.name}),s.messageCount!==void 0&&s.messageCount>0&&e.jsx(De,{variant:"secondary",className:"text-[10px] px-1.5 py-0 h-4 flex-shrink-0 font-normal",children:s.messageCount})]}),s.description&&e.jsx("div",{className:"text-xs text-muted-foreground truncate mt-0.5",children:s.description})]}),e.jsxs("div",{className:"flex-shrink-0 ml-1",children:[t&&e.jsx(Ye,{className:"w-4 h-4 text-primary"}),n&&!t&&e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-primary/60"})]})]})},gl=({currentChannel:s,channels:t,onChannelSelect:n,trigger:a,className:r="",maxHeight:o=400,itemHeight:i=40})=>{const[l,c]=h.useState(!1),[d,u]=h.useState(""),[m,p]=h.useState(0),f=h.useRef(null),g=h.useRef(null),x=h.useMemo(()=>er(t,s.id),[t,s.id]),{recentChannels:y,otherChannels:v,allChannels:w}=h.useMemo(()=>{if(d.trim()){const z=d.toLowerCase().trim(),K=x.filter(de=>de.name.toLowerCase().includes(z)||de.description?.toLowerCase().includes(z));return{recentChannels:[],otherChannels:[],allChannels:K}}const T=yh(),D=new Map,L=[];for(const z of x)T.includes(z.id)&&z.id!==s.id?D.set(z.id,z):z.id!==s.id&&L.push(z);return{recentChannels:T.map(z=>D.get(z)).filter(z=>z!==void 0).slice(0,8),otherChannels:L,allChannels:[]}},[x,s.id,d]);h.useEffect(()=>{l&&f.current&&setTimeout(()=>{f.current?.focus()},0)},[l]);const b=h.useMemo(()=>{if(d.trim()||w.length>0)return w.map(D=>({type:"channel",channel:D}));const T=[];return y.length>0&&(y.forEach(D=>{T.push({type:"channel",channel:D})}),v.length>0&&T.push({type:"separator",label:"All spaces"})),v.forEach(D=>{T.push({type:"channel",channel:D})}),T},[y,v,w,d]);h.useEffect(()=>{l||u(""),p(0)},[l,b.length]);const N=h.useCallback(T=>{n(T),c(!1)},[n]),j=h.useMemo(()=>b.filter(T=>T.type==="channel"),[b]),C=h.useCallback(T=>{if(T.key==="ArrowDown"){T.preventDefault();const D=Math.min(m+1,j.length-1);p(D),g.current&&D<j.length&&g.current.scrollToIndex({index:D,align:"center",behavior:"smooth"})}else if(T.key==="ArrowUp"){T.preventDefault();const D=Math.max(m-1,0);p(D),g.current&&D>=0&&g.current.scrollToIndex({index:D,align:"center",behavior:"smooth"})}else T.key==="Enter"&&j[m]?(T.preventDefault(),N(j[m].channel.id)):T.key==="Escape"&&c(!1)},[m,j,N]),E=h.useCallback(T=>{u(T.target.value),p(0),g.current&&g.current.scrollToIndex({index:0,behavior:"auto"})},[]),R=h.useCallback(()=>{u(""),p(0),f.current?.focus(),g.current&&g.current.scrollToIndex({index:0,behavior:"auto"})},[]);return e.jsx("div",{className:r,children:e.jsxs(Lt,{open:l,onOpenChange:c,children:[e.jsx(Rt,{asChild:!0,children:a}),e.jsxs(Dt,{className:"w-80 p-0 overflow-hidden",align:"start",sideOffset:8,onKeyDown:C,children:[e.jsx("div",{className:"p-2 border-b",children:e.jsxs("div",{className:"relative",children:[e.jsx(Fe,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground pointer-events-none"}),e.jsx(_e,{ref:f,placeholder:"Search spaces...",value:d,onChange:E,onKeyDown:C,className:"pl-8 pr-8 h-8 text-sm"}),d&&e.jsx("button",{onClick:R,className:"absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground hover:text-foreground transition-colors","aria-label":"Clear search",children:e.jsx(le,{className:"w-4 h-4"})})]})}),e.jsx("div",{className:"overflow-hidden py-1",style:{maxHeight:`${o}px`},children:j.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-4 text-center",children:[e.jsx("div",{className:"text-muted-foreground/50 mb-2 text-2xl",children:d?"ðŸ”":"ðŸ“"}),e.jsx("div",{className:"text-sm text-muted-foreground font-medium mb-1",children:d?"No spaces found":"No spaces available"}),d&&e.jsx("div",{className:"text-xs text-muted-foreground/70",children:"Try a different search term"})]}):e.jsx(ti,{ref:g,data:b,totalCount:b.length,itemContent:(T,D)=>{if(D.type==="separator")return e.jsx("div",{className:"px-3 py-1.5 h-8 flex items-center",children:e.jsx("div",{className:"text-xs font-medium text-muted-foreground/70 uppercase tracking-wide",children:D.label})});const L=b.slice(0,T+1).filter(U=>U.type==="channel").length-1;return e.jsx("div",{className:"px-2 py-0.5",children:e.jsx(Vf,{channel:D.channel,isSelected:L===m,isCurrent:D.channel.id===s.id,onSelect:N,highlightQuery:d||void 0})})},defaultItemHeight:i+4,style:{height:`${Math.min(b.reduce((T,D)=>T+(D.type==="separator"?32:i+4),0),o-72)}px`,maxHeight:`${o-72}px`},overscan:5})})]})]})})},qf=({currentChannel:s,channels:t,onChannelSelect:n,className:a=""})=>{const r=e.jsxs("div",{className:"flex items-center space-x-1.5 min-w-0 p-2 rounded-lg hover:bg-accent/50 transition-all duration-200 cursor-pointer group",children:[s.emoji&&e.jsx("div",{className:"text-lg flex-shrink-0 group-hover:scale-105 transition-transform duration-200",children:s.emoji}),e.jsx("h1",{className:"text-lg font-semibold text-muted-foreground group-hover:text-foreground truncate transition-colors duration-200 min-w-0 flex-1",children:s.name}),e.jsx(De,{variant:"secondary",className:"text-xs flex-shrink-0 text-muted-foreground group-hover:text-foreground transition-colors duration-200",children:s.messageCount}),e.jsx(ze,{className:"h-4 w-4 text-muted-foreground group-hover:text-foreground flex-shrink-0 transition-colors duration-200"})]});return e.jsx(gl,{currentChannel:s,channels:t,onChannelSelect:n,trigger:r,className:a,maxHeight:400,itemHeight:40})};function Wf({channel:s,isOpen:t,onOpenChange:n}){const{publishSpace:a,unpublishSpace:r,updatePublishMode:o}=O(),i=$e(C=>C.currentUser),[l,c]=h.useState(!1),[d,u]=h.useState(!1),[m,p]=h.useState(s.shareMode||"read-only");h.useEffect(()=>{p(s.shareMode||"read-only")},[s.shareMode]);const f=s.shareToken&&m!==s.shareMode,g=s.shareToken&&!f,x=s.shareToken?`${window.location.origin}/#/space/${s.shareToken}`:"",y=async()=>{if(!i){Ut("Sign in to publish this space"),ns({title:"Sign in to publish",description:"Publishing creates a shareable cloud link for this space."});return}c(!0);try{await a(s.id,m)}catch(C){console.error("Error publishing space:",C)}finally{c(!1)}},v=async()=>{if(!i){Ut("Sign in to unpublish this space"),ns({title:"Sign in to manage publishing",description:"Unpublishing is a cloud action and requires an account."});return}we.confirm({title:"Unpublish Space",description:`This will make the space "${s.name}" private. Anyone with the share link will no longer be able to access it.`,okText:"Unpublish",okLoadingText:"Unpublishing...",okVariant:"destructive",cancelText:"Cancel",onOk:async()=>{c(!0);try{await r(s.id),u(!1),n(!1)}catch(C){console.error("Error unpublishing space:",C)}finally{c(!1)}}})},w=async()=>{if(x)try{await navigator.clipboard.writeText(x),u(!0),setTimeout(()=>u(!1),2e3)}catch(C){console.error("Error copying link:",C)}},b=C=>{C!==m&&p(C)},N=async()=>{if(!(!s.shareToken||!f)){if(!i){Ut("Sign in to update publish mode"),ns({title:"Sign in to update publish mode",description:"Updating publish mode is a cloud action and requires an account."});return}c(!0);try{await o(s.id,m)}catch(C){console.error("Error updating publish mode:",C)}finally{c(!1)}}},j=()=>{p(s.shareMode||"read-only")};return e.jsx(gt,{open:t,onOpenChange:n,children:e.jsxs(pt,{className:"sm:max-w-md",children:[e.jsxs(hs,{children:[e.jsx(ms,{children:"Publish Space"}),e.jsx(Dn,{children:s.shareToken?s.shareMode==="append-only"?"Your space is published. Anyone with the link can view and add messages.":"Your space is published. Anyone with the link can view messages.":"Make this space accessible via a shareable link."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(et,{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Mode"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{onClick:()=>b("read-only"),className:M("flex items-center gap-2.5 px-2.5 py-2 rounded-lg cursor-pointer transition-all duration-200",m==="read-only"?"bg-primary/8 text-primary":"hover:bg-accent/30 text-foreground"),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("div",{className:M("transition-colors",m==="read-only"?"text-primary":"text-muted-foreground"),children:e.jsx(rd,{className:"w-4 h-4"})}),e.jsx("span",{className:"text-sm font-medium",children:"Read-Only"})]}),e.jsx("div",{className:"flex items-center gap-1.5",children:e.jsx("span",{className:"text-xs text-muted-foreground/70",children:"View only"})})]}),e.jsxs("div",{onClick:()=>b("append-only"),className:M("flex items-center gap-2.5 px-2.5 py-2 rounded-lg cursor-pointer transition-all duration-200",m==="append-only"?"bg-primary/8 text-primary":"hover:bg-accent/30 text-foreground"),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("div",{className:M("transition-colors",m==="append-only"?"text-primary":"text-muted-foreground"),children:e.jsx(ds,{className:"w-4 h-4"})}),e.jsx("span",{className:"text-sm font-medium",children:"Collaborative"})]}),e.jsx("div",{className:"flex items-center gap-1.5",children:e.jsx("span",{className:"text-xs text-muted-foreground/70",children:"Anyone can add"})})]})]}),e.jsx("div",{className:"mt-3 pt-3 border-t border-border/60",children:e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed",children:m==="read-only"?"Anyone with the link can view messages, but cannot add, modify, or delete them.":"Anyone with the link can view and add messages. Existing messages cannot be modified or deleted."})})]}),g&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(et,{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Share Link"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{value:x,readOnly:!0,className:"flex-1 font-mono text-xs bg-muted/30 border-border/60",onClick:C=>C.target.select()}),e.jsx(k,{type:"button",variant:"outline",size:"icon",onClick:w,className:"shrink-0 h-9 w-9",children:d?e.jsx(Ye,{className:"h-4 w-4 text-primary"}):e.jsx(os,{className:"h-4 w-4"})})]})]})]}),e.jsx(Oa,{children:s.shareToken?f?e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsx(k,{type:"button",variant:"outline",onClick:j,disabled:l,className:"flex-1",children:"Cancel"}),e.jsx(k,{type:"button",onClick:N,disabled:l,className:"flex-1",children:l?"Changing...":"Confirm Change"})]}):e.jsx(k,{type:"button",variant:"outline",onClick:v,disabled:l,className:"w-full",children:l?"Unpublishing...":"Unpublish"}):e.jsx(k,{type:"button",onClick:y,disabled:l,className:"w-full",children:l?"Publishing...":"Publish"})})]})})}const Kf=s=>{let t=0;for(let n=0;n<s.length;n++)t=t*31+s.charCodeAt(n);return Math.abs(t)},Yf=s=>({background:`url(https://picsum.photos/800/400?random=${s%100+1})`,isImage:!0}),Xf=s=>{if(s.backgroundImage)return{background:`url(${s.backgroundImage})`,isImage:!0};if(s.backgroundColor)return{background:s.backgroundColor,isImage:!1};const t=Kf(s.id);return Yf(t)},Jf=({channel:s,className:t="",defaultCollapsed:n=!1})=>{const[a,r]=h.useState(!1),o=ar(),[i,l]=h.useState(!1),c=h.useRef(null),d=Te(h.useCallback(L=>L.notifyLayoutChange,[])),u=Ct(h.useCallback(L=>L.setTimelineCoverCollapsed,[])),m=Ct(h.useCallback(L=>L.timelineCoverCollapsed??n,[n])),p=Ct(h.useCallback(L=>L.isLeftSidebarCollapsed,[])),f=Ct(h.useCallback(L=>L.setLeftSidebarCollapsed,[])),g=O(L=>L.channels),{setCurrentChannel:x}=W(),y=er(g,s.id),{background:v,isImage:w}=Xf(s),b=v.includes("gradient"),N=()=>w?{backgroundImage:v,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"}:b?{background:v}:{backgroundColor:v},j=()=>{if(i)return;l(!0),u(!m),d(),setTimeout(()=>{l(!1),d()},300)},C=()=>{f(!1)},E=async({type:L,value:U})=>{try{L==="color"?await o.channelManager.updateChannel(s.id,{backgroundColor:U,backgroundImage:void 0}):L==="image"&&await o.channelManager.updateChannel(s.id,{backgroundImage:U,backgroundColor:void 0})}catch(z){console.error("Failed to update channel background:",z)}},R=async()=>{try{await o.channelManager.updateChannel(s.id,{backgroundColor:void 0,backgroundImage:void 0})}catch(L){console.error("Failed to remove channel background:",L)}},T=e.jsxs("div",{className:"flex items-center space-x-2 min-w-0 w-full max-w-full overflow-hidden",children:[p&&e.jsxs(e.Fragment,{children:[e.jsx(k,{variant:"ghost",size:"sm",onClick:C,className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105 flex-shrink-0 animate-in fade-in slide-in-from-left-2 duration-300",title:"Expand sidebar",children:e.jsx(bn,{className:"h-4 w-4"})}),e.jsx(Hs,{instantCreate:!0,trigger:e.jsx(k,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105 flex-shrink-0",title:"New space","aria-label":"New space",children:e.jsx(Me,{className:"h-4 w-4"})})})]}),p?e.jsxs("div",{className:"flex flex-1 min-w-0 max-w-full items-center gap-1",children:[e.jsx(qf,{currentChannel:s,channels:y,onChannelSelect:x,className:"min-w-0 max-w-full"}),e.jsx(Sn,{channel:s,children:e.jsx(k,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105 flex-shrink-0",title:"Edit space","aria-label":"Edit space",onClick:L=>L.stopPropagation(),children:e.jsx(Gt,{className:"h-4 w-4"})})})]}):e.jsxs(e.Fragment,{children:[s.emoji&&e.jsx("div",{className:"text-lg flex-shrink-0 transition-all duration-300 ease-out hover:scale-110 cursor-pointer",children:s.emoji}),e.jsxs("div",{className:"flex items-center space-x-1.5 min-w-0 p-2 rounded-lg hover:bg-accent/50 transition-all duration-200 cursor-pointer group flex-1 overflow-hidden",children:[e.jsx("h1",{className:"text-lg font-semibold text-muted-foreground group-hover:text-foreground truncate transition-all duration-200 min-w-0",children:s.name}),e.jsx(De,{variant:"secondary",className:"text-xs flex-shrink-0 transition-all duration-200 text-muted-foreground group-hover:text-foreground",children:s.messageCount})]})]})]}),D=e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative z-10 flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2 min-w-0 flex-1",children:[p&&e.jsxs(e.Fragment,{children:[e.jsx(k,{variant:"ghost",size:"sm",onClick:C,className:"h-8 w-8 p-0 text-white/80 hover:text-white hover:bg-white/20 transition-all duration-200 hover:scale-105 flex-shrink-0 animate-in fade-in slide-in-from-left-2 duration-300",title:"Expand sidebar",children:e.jsx(bn,{className:"h-4 w-4"})}),e.jsx(Hs,{instantCreate:!0,trigger:e.jsx(k,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-white hover:bg-white/20 transition-all duration-200 hover:scale-105 flex-shrink-0",title:"New space","aria-label":"New space",children:e.jsx(Me,{className:"h-4 w-4"})})})]}),s.emoji&&e.jsx("div",{className:"text-4xl drop-shadow-lg flex-shrink-0 transition-all duration-300 ease-out",children:s.emoji}),e.jsxs("div",{className:"flex-1 min-w-0 ml-3",children:[e.jsx("h1",{className:"text-3xl font-bold text-white drop-shadow-lg truncate transition-all duration-300 ease-out min-w-0",children:s.name}),s.description&&e.jsx("p",{className:"text-white/90 text-sm mt-1.5 drop-shadow-md line-clamp-2 transition-all duration-300 ease-out",children:s.description})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-4 flex-shrink-0",children:[p&&e.jsx(Sn,{channel:s,children:e.jsx(k,{variant:"ghost",size:"sm",className:"text-white hover:bg-white/20 transition-all duration-200 hover:scale-105",title:"Edit space","aria-label":"Edit space",onClick:L=>L.stopPropagation(),children:e.jsx(Gt,{className:"h-4 w-4"})})}),e.jsx(k,{variant:"ghost",size:"sm",className:"text-white hover:bg-white/20 transition-all duration-200 hover:scale-105",onClick:()=>Gs(),title:"Search",children:e.jsx(Fe,{className:"h-4 w-4"})}),e.jsx(k,{variant:"ghost",size:"sm",className:"text-white hover:bg-white/20 transition-all duration-200 hover:scale-105",onClick:()=>r(!0),title:s.shareToken?"Published - Manage sharing":"Publish space",children:s.shareToken?e.jsx(ra,{className:"h-4 w-4"}):e.jsx(Os,{className:"h-4 w-4"})}),Se().channel.settings.enabled,e.jsx(Gf,{currentBackground:{type:s.backgroundColor?"color":"image",value:s.backgroundColor||s.backgroundImage},onBackgroundChange:E,onRemoveBackground:R,buttonClassName:"h-8 w-8 p-0 text-white hover:text-white hover:bg-white/20 transition-all duration-200 hover:scale-105"}),e.jsx(k,{variant:"ghost",size:"sm",className:"text-white hover:bg-white/20 transition-all duration-200 hover:scale-105",onClick:j,children:e.jsx(Wt,{className:"h-4 w-4 transition-transform duration-200"})})]})]}),e.jsxs("div",{className:"relative z-10 flex items-center justify-between mt-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(De,{variant:"secondary",className:"bg-white/25 text-white border-white/40 backdrop-blur-sm transition-all duration-300 ease-out",children:[e.jsx(ds,{className:"h-3 w-3 mr-1.5"}),e.jsx("span",{className:"font-medium",children:s.messageCount}),e.jsx("span",{className:"ml-1 text-xs opacity-90",children:"messages"})]}),s.lastMessageTime&&e.jsxs(De,{variant:"secondary",className:"bg-white/25 text-white border-white/40 backdrop-blur-sm transition-all duration-300 ease-out",children:[e.jsx(Ra,{className:"h-3 w-3 mr-1.5"}),e.jsx("span",{className:"text-xs",children:new Date(s.lastMessageTime).toLocaleDateString()})]})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs(k,{variant:"secondary",size:"sm",className:"bg-white/25 text-white border-white/40 hover:bg-white/35 backdrop-blur-sm transition-all duration-200 hover:scale-105",onClick:()=>o.openAIAssistant(),children:[e.jsx(Et,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"font-medium",children:"AI Assistant"})]})})]})]});return e.jsxs("div",{ref:c,className:M("relative w-full overflow-hidden transition-all duration-300 ease-out",m?"h-12":"h-52",m?"flex items-center justify-between px-4":"",t),style:m?{}:N(),children:[m?e.jsxs(e.Fragment,{children:[T,e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(k,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105",onClick:()=>Gs(),title:"Search",children:e.jsx(Fe,{className:"h-4 w-4"})}),e.jsx(k,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105",onClick:()=>r(!0),title:s.shareToken?"Published - Manage sharing":"Publish space",children:s.shareToken?e.jsx(ra,{className:"h-4 w-4"}):e.jsx(Os,{className:"h-4 w-4"})}),e.jsx(k,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105",onClick:()=>o.openAIAssistant(),children:e.jsx(Et,{className:"h-4 w-4"})}),e.jsx(k,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105",onClick:()=>o.openStudio(),title:"Studio",children:e.jsx(mt,{className:"h-4 w-4"})}),Se().channel.settings.enabled,e.jsx(k,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105",onClick:j,children:e.jsx(ze,{className:"h-4 w-4 transition-transform duration-200"})})]})]}):e.jsxs("div",{className:"relative w-full h-full flex flex-col justify-between p-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-black/10 via-black/20 to-black/30 z-0"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-transparent to-black/10 z-0"}),D]}),e.jsx(Wf,{channel:s,isOpen:a,onOpenChange:r})]})},Qf=({content:s,actions:t,channel:n,className:a="",overlay:r})=>{const{sideView:o}=ve(),l=!o?"w-full max-w-[850px] mx-auto px-4 sm:px-6":"w-full",c=h.useRef(null);return e.jsx("div",{className:`relative w-full h-full ${a}`,"data-component":"timeline-layout",children:e.jsxs("div",{ref:c,className:"relative flex-1 flex flex-col h-full",children:[n&&e.jsx(sx,{channel:n,layoutRef:c}),e.jsx("div",{className:`flex-1 flex flex-col min-h-0 ${l}`,children:s}),t&&e.jsx("div",{className:`${l} shrink-0`,children:t}),r&&e.jsx("div",{className:"absolute inset-0 z-30",children:r})]})})},Zf=120,co=60,ex=20,tx=80,sx=({channel:s,layoutRef:t})=>{const n=ar(),a=h.useRef(null),r=h.useRef(null),o=h.useRef(null),i=h.useRef(0),l=h.useRef(0),[c,d]=h.useState(0),[u,m]=h.useState(!1),[p,f]=h.useState(!1);h.useEffect(()=>{const y=r.current;if(!y)return;const v=N=>{d(j=>Math.abs(j-N)>.5?N:j)},w=y.getBoundingClientRect().height;if(v(w),typeof ResizeObserver>"u")return;const b=new ResizeObserver(N=>{const j=N[0];j&&v(j.contentRect.height)});return b.observe(y),()=>b.disconnect()},[]),h.useEffect(()=>{const y=()=>{const j=o.current;if(!j)return;const C=j.scrollTop,E=i.current,R=C-E;m(T=>{let D=T;return T?C<=co?(l.current=0,D=!1):R<0?(l.current+=-R,l.current>=tx&&(D=!1,l.current=0)):R>0&&(l.current=0):C<=co?(D=!1,l.current=0):R>0&&C>Zf?(D=!0,l.current=0):R!==0&&(l.current=0),D}),i.current=C},v=()=>{o.current&&(o.current.removeEventListener("scroll",y),o.current=null)},w=j=>{o.current!==j&&(v(),o.current=j,o.current.addEventListener("scroll",y,{passive:!0}),i.current=j.scrollTop,l.current=0,y())};let b=null;const N=()=>{const j=n.scrollManager.getScrollContainer();j&&j instanceof HTMLDivElement?w(j):v()};return N(),b=window.setInterval(N,500),()=>{b!==null&&window.clearInterval(b),v()}},[n]),h.useEffect(()=>{if(!u){f(!1);return}const y=v=>{const w=t.current;if(!w)return;const b=w.getBoundingClientRect(),N=v.clientX>=b.left&&v.clientX<=b.right,j=v.clientY>=b.top&&v.clientY<=b.bottom;if(!N||!j){f(R=>R&&!1);return}const E=v.clientY-b.top<=ex;f(R=>R===E?R:E)};return window.addEventListener("mousemove",y),()=>{window.removeEventListener("mousemove",y)}},[u,t]);const g=!u||p,x={transition:"transform 240ms ease, margin-bottom 240ms ease, opacity 180ms ease",transform:"translateY(0)",marginBottom:0,opacity:1,pointerEvents:"auto",willChange:"transform, margin-bottom, opacity"};return!g&&c>0&&(x.transform=`translateY(-${c}px)`,x.marginBottom=`-${c}px`,x.opacity=0,x.pointerEvents="none"),e.jsx("div",{ref:a,className:"relative z-20",style:x,children:e.jsx("div",{ref:r,children:e.jsx(Jf,{channel:s})})})};function pl(){const{channels:s}=O(),{currentChannelId:t}=W();return s.find(n=>n.id===t)||null}const fl=({currentChannel:s,channels:t,onChannelSelect:n,className:a=""})=>{const r=e.jsx(k,{variant:"ghost",className:`h-auto px-2 py-1.5 hover:bg-muted/50 active:bg-muted/70 transition-all duration-200 touch-manipulation min-h-[36px] ${a}`,children:e.jsxs("div",{className:"flex items-center space-x-1.5 min-w-0 max-w-full",children:[s.emoji&&e.jsx("div",{className:"text-base flex-shrink-0",children:s.emoji}),e.jsx("div",{className:"flex items-center min-w-0 flex-1",children:e.jsx("h1",{className:"text-base font-medium text-foreground/90 truncate",children:s.name})}),e.jsx(ze,{className:"h-3.5 w-3.5 text-muted-foreground flex-shrink-0"})]})});return e.jsx(gl,{currentChannel:s,channels:t,onChannelSelect:n,trigger:r,className:a,maxHeight:360,itemHeight:44})};function nx(){const s=he(),{currentChannelId:t}=W(),{message:n,handleMessageChange:a,handleSend:r}=nl(),o=kt(d=>d.setExpanded),i=pl(),l=O(d=>d.channels),c=W(d=>d.setCurrentChannel);return e.jsxs("div",{className:"w-full h-full min-h-0 flex flex-col bg-background","data-component":"expanded-composer",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-slate-200 dark:border-slate-700 bg-slate-50/40 dark:bg-slate-800/30",children:[e.jsxs("div",{className:"flex items-center gap-1.5 min-w-0",children:[i&&e.jsx(fl,{currentChannel:i,channels:l,onChannelSelect:c,className:"max-w-[240px]"}),e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>{!n.trim()||!t||(r(),o(!1),s.rxEventBus.requestTimelineScrollToLatest$.emit())},disabled:!n.trim(),className:"h-9 w-9 text-muted-foreground hover:text-foreground","aria-label":"Send",title:"Send",children:e.jsx(_a,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex items-center gap-1.5",children:e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>o(!1),className:"h-9 w-9","aria-label":"Collapse",title:"Collapse",children:e.jsx(Da,{className:"w-4 h-4"})})})]}),e.jsx("div",{className:"flex-1 min-h-0 p-3 overflow-hidden",children:e.jsx("div",{className:"w-full h-full",onKeyDown:d=>{d.key==="Escape"&&o(!1),d.key==="Enter"&&d.shiftKey&&(d.preventDefault(),n.trim()&&(r(),o(!1),s.rxEventBus.requestTimelineScrollToLatest$.emit()))},children:e.jsx(Xs,{value:n,onChange:a,editable:!0,placeholder:"",className:"h-full",variant:"frameless"})})})]})}const ax=({className:s=""})=>{const t=pl();ps();const n=kt(a=>a.expanded);return e.jsxs(e.Fragment,{children:[e.jsx(Qf,{channel:t||void 0,content:e.jsx($f,{}),actions:t&&!n?e.jsx(nf,{}):null,overlay:n?e.jsx(nx,{}):null,className:s}),e.jsx(Jp,{}),e.jsx(wp,{})]})},rx=({isOpen:s,onClose:t,onSendMessage:n,currentThreadId:a})=>{const{messages:r}=fs({}),o=a&&r?.find(g=>g.id===a)||null,i=a?r?.filter(g=>g.threadId===a)||[]:[],[l,c]=h.useState(""),[d,u]=h.useState(!1),m=()=>{l.trim()&&(n?.(l.trim()),c(""))},p=g=>{g.key==="Enter"&&sr(g)&&(g.preventDefault(),m())},f=(g,x=200)=>g.length<=x?g:g.substring(0,x)+"...";return s?e.jsxs("div",{className:"h-full flex flex-col bg-white dark:bg-slate-900",children:[e.jsxs("div",{className:"flex-shrink-0 flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oa,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),e.jsx("h3",{className:"font-semibold text-slate-800 dark:text-slate-200",children:"Discussion"}),i.length>0&&e.jsx("span",{className:"px-2 py-1 text-xs bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-full",children:i.length})]}),e.jsx("button",{onClick:t,className:"p-2 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors duration-200 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800",children:e.jsx(le,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto timeline-scroll",children:[o&&e.jsx("div",{className:"p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/30",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0",children:e.jsx(Zn,{className:"w-4 h-4 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-slate-800 dark:text-slate-200 mb-1",children:"Original Thought"}),e.jsx("div",{className:"text-sm text-slate-600 dark:text-slate-400 leading-relaxed",children:d?o.content:f(o.content)}),o.content.length>200&&e.jsx("button",{onClick:()=>u(!d),className:"mt-2 flex items-center gap-1 text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors duration-200",children:d?e.jsxs(e.Fragment,{children:[e.jsx(Wt,{className:"w-3 h-3"}),"Show less"]}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"w-3 h-3"}),"Show more"]})})]})]})}),e.jsx("div",{className:"p-4 space-y-4",children:i.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(oa,{className:"w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-4"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-sm",children:"No replies yet. Start the discussion!"})]}):i.map(g=>e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${g.sender==="user"?"bg-blue-500":"bg-slate-500"}`,children:g.sender==="user"?e.jsx(Zn,{className:"w-4 h-4 text-white"}):e.jsx(Et,{className:"w-4 h-4 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-slate-800 dark:text-slate-200 mb-1",children:g.sender==="user"?"You":"AI Assistant"}),e.jsx("div",{className:"text-sm text-slate-600 dark:text-slate-400 leading-relaxed",children:g.content})]})]},g.id))})]}),e.jsx("div",{className:"flex-shrink-0 p-4 border-t border-slate-200 dark:border-slate-700",children:e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx("textarea",{value:l,onChange:g=>c(g.target.value),onKeyDown:p,placeholder:"Add to discussion...",className:"w-full px-3 py-2 text-sm border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder:text-slate-500 resize-none focus:outline-none  focus:border-transparent",rows:2})}),e.jsx("button",{onClick:m,disabled:!l.trim(),className:"p-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:text-blue-600 text-white rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(_a,{className:"w-4 h-4"})})]})})]}):null},xl=[{id:"audio-summary",title:"Audio",description:"Generate audio summaries from your notes",icon:od,colorClass:"bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30 border-blue-100/60 dark:border-blue-900/40",iconColorClass:"text-blue-600 dark:text-blue-400",order:1,enabled:!0},{id:"mindmap",title:"Mindmap",description:"Visualize connections and relationships",icon:id,colorClass:"bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-950/30 dark:to-pink-950/30 border-purple-100/60 dark:border-purple-900/40",iconColorClass:"text-purple-600 dark:text-purple-400",order:2,enabled:!0},{id:"wiki-card",title:"Concept",description:"Create wiki-style concept cards",icon:Lo,colorClass:"bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950/30 dark:to-orange-950/30 border-amber-100/60 dark:border-amber-900/40",iconColorClass:"text-amber-600 dark:text-amber-400",order:3,enabled:!0},{id:"report",title:"Report",description:"Generate comprehensive reports",icon:Xe,colorClass:"bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-950/30 dark:to-teal-950/30 border-emerald-100/60 dark:border-emerald-900/40",iconColorClass:"text-emerald-600 dark:text-emerald-400",order:4,enabled:!0}],ox=s=>xl.find(t=>t.id===s),ix=()=>xl.filter(s=>s.enabled).sort((s,t)=>s.order-t.order),Js=Ee()(At(s=>({currentContext:null,currentModule:null,contentItems:{"audio-summary":[],mindmap:[],"wiki-card":[],report:[]},activeItemId:null,isGenerating:!1,setCurrentContext:t=>s({currentContext:t}),setCurrentModule:t=>s({currentModule:t}),addContentItem:t=>s(n=>({contentItems:{...n.contentItems,[t.moduleId]:[...n.contentItems[t.moduleId],t]}})),updateContentItem:(t,n)=>s(a=>{const r={...a.contentItems};for(const o in r){const i=r[o].findIndex(l=>l.id===t);if(i>=0){r[o]=[...r[o].slice(0,i),{...r[o][i],...n},...r[o].slice(i+1)];break}}return{contentItems:r}}),deleteContentItem:t=>s(n=>{const a={...n.contentItems};for(const r in a)a[r]=a[r].filter(o=>o.id!==t);return{contentItems:a,activeItemId:n.activeItemId===t?null:n.activeItemId}}),setActiveItem:t=>s({activeItemId:t}),setGenerating:t=>s({isGenerating:t}),togglePin:t=>s(n=>{const a={...n.contentItems};for(const r in a){const o=a[r],i=o.findIndex(l=>l.id===t);if(i>=0){const l=o[i];o[i]={...l,pinned:!l.pinned};break}}return{contentItems:a}})}),{name:"echonote-studio",partialize:s=>({contentItems:s.contentItems,currentContext:s.currentContext})})),lx=s=>s?s.includes("blue")?"bg-blue-100/80 dark:bg-blue-900/40":s.includes("purple")?"bg-purple-100/80 dark:bg-purple-900/40":s.includes("amber")||s.includes("orange")?"bg-amber-100/80 dark:bg-amber-900/40":s.includes("emerald")||s.includes("teal")?"bg-emerald-100/80 dark:bg-emerald-900/40":"bg-muted/50 dark:bg-muted/30":"bg-muted/50 dark:bg-muted/30",cx=h.memo(function({module:t,onClick:n}){const a=t.icon,r=lx(t.iconColorClass);return e.jsx(We.div,{whileHover:{scale:1.02,y:-2},whileTap:{scale:.98},transition:{duration:.2,ease:[.16,1,.3,1]},className:"relative",children:e.jsxs("div",{className:M("relative overflow-hidden p-0 transition-all duration-300 group cursor-pointer rounded-lg","backdrop-blur-sm bg-card/80",t.colorClass,"before:absolute before:inset-0 before:rounded-xl before:opacity-0 before:transition-opacity before:duration-300","before:bg-gradient-to-br before:from-white/40 before:to-transparent dark:before:from-white/5","hover:before:opacity-100","active:scale-[0.98]"),onClick:n,children:[e.jsxs("div",{className:"relative flex items-center",children:[e.jsx("div",{className:M("flex-shrink-0 w-14 flex items-center justify-center py-2.5 transition-all duration-300","rounded-l-lg",r),children:e.jsx("div",{className:M("relative flex items-center justify-center w-10 h-10 rounded-lg transition-all duration-300","group-hover:scale-110"),children:e.jsx(a,{className:M("w-5 h-5 transition-all duration-300 relative z-10",t.iconColorClass||"text-muted-foreground","group-hover:scale-110","drop-shadow-sm")})})}),e.jsx("div",{className:"flex-1 min-w-0 px-3 py-2.5 flex items-center",children:e.jsx("div",{className:M("text-sm font-semibold transition-all duration-300","text-foreground group-hover:text-foreground/90 drop-shadow-sm"),children:t.title})})]}),e.jsx("div",{className:"absolute inset-0 rounded-xl bg-gradient-to-br from-white/0 via-white/0 to-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"})]})})}),dx=h.memo(function(){const{channels:t}=O(),{currentContext:n,setCurrentContext:a}=Js(),[r,o]=h.useState(!1),[i,l]=h.useState(""),c=h.useMemo(()=>n?.channelIds||[],[n?.channelIds]),d=n?.mode||"auto",u=t.filter(g=>g.name.toLowerCase().includes(i.toLowerCase())),m=h.useCallback(g=>{const x=c.includes(g)?c.filter(y=>y!==g):[...c,g];a({mode:"custom",channelIds:x})},[c,a]),p=h.useCallback(g=>{g==="all"?a({mode:"all",channelIds:t.map(x=>x.id)}):g==="none"?a({mode:"none",channelIds:[]}):g==="auto"&&a({mode:"auto",channelIds:[]}),o(!1)},[t,a]),f=()=>d==="all"?"All spaces":d==="none"?"No spaces":d==="auto"?"Auto":c.length===0?"No spaces selected":c.length===1?t.find(x=>x.id===c[0])?.name||"1 space":`${c.length} spaces`;return e.jsxs(q,{open:r,onOpenChange:o,children:[e.jsx(q.Trigger,{asChild:!0,children:e.jsxs("div",{className:"flex items-center gap-1.5 h-8 px-3 rounded-md bg-transparent hover:bg-accent/50 text-muted-foreground hover:text-foreground transition-colors cursor-pointer",children:[e.jsx("span",{className:"text-sm font-medium truncate",children:f()}),e.jsx(ze,{className:"w-3 h-3 opacity-50 flex-shrink-0"})]})}),e.jsxs(q.Content,{className:"w-80",children:[e.jsx(q.Header,{children:e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:"Context"})}),e.jsx(q.Body,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{variant:d==="auto"?"default":"ghost",size:"sm",className:"w-full justify-start",onClick:()=>p("auto"),children:"Auto"}),e.jsx(k,{variant:d==="all"?"default":"ghost",size:"sm",className:"w-full justify-start",onClick:()=>p("all"),children:"All spaces"}),e.jsx(k,{variant:d==="none"?"default":"ghost",size:"sm",className:"w-full justify-start",onClick:()=>p("none"),children:"No spaces"}),e.jsxs("div",{className:"border-t pt-2 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2 px-2 mb-2",children:[e.jsx(Fe,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("input",{type:"text",placeholder:"Search spaces...",value:i,onChange:g=>l(g.target.value),className:"flex-1 bg-transparent border-0 outline-none text-sm"})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:u.length===0?e.jsx("div",{className:"text-center py-4 text-sm text-muted-foreground",children:i?"No spaces found":"No spaces available"}):e.jsx("div",{className:"space-y-1",children:u.map(g=>{const x=c.includes(g.id);return e.jsxs("div",{className:M("flex items-center gap-2 px-2 py-1.5 rounded-lg text-sm cursor-pointer transition-colors",x?"bg-primary/10 text-primary":"hover:bg-accent"),onClick:()=>{p("custom"),m(g.id)},children:[e.jsx("span",{children:g.emoji||"ðŸ“"}),e.jsx("span",{className:"flex-1 truncate",children:g.name}),x&&e.jsx(Ye,{className:"w-4 h-4"})]},g.id)})})})]})]})})]})]})}),ux=h.memo(function({item:t,onClose:n}){const a=()=>{};return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(k,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:n,children:e.jsx(Yt,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-sm font-medium flex-1 truncate",children:t.title})]}),e.jsx(xs,{className:"flex-1",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Audio Overview Content"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"outline",size:"sm",onClick:a,children:e.jsx(ld,{className:"w-4 h-4"})}),e.jsx(k,{variant:"outline",size:"sm",children:e.jsx(Kt,{className:"w-4 h-4"})})]})]})})]})}),hx={type:"object",properties:{title:{type:"string",description:"A short title (2-5 words, same language as the notes) that describes the theme of the mindmap"},nodes:{type:"array",items:{type:"object",properties:{id:{type:"string"},label:{type:"string"},importance:{type:"number"},group:{type:"string"}},required:["id","label"]}},edges:{type:"array",items:{type:"object",properties:{source:{type:"string"},target:{type:"string"},weight:{type:"number"}},required:["source","target"]}},tree:{type:"object",description:"Hierarchical mindmap structure with a single root for XMind-like layout",properties:{id:{type:"string"},label:{type:"string"},children:{type:"array",items:{$ref:"#/properties/tree"}}},required:["id","label"]}},required:["title","nodes","edges"]};function mx(s){const t=/[\u4e00-\u9fff]/,n=/[\u3040-\u309f\u30a0-\u30ff]/,a=/[\uac00-\ud7af]/,r=/[\u0600-\u06ff]/,o=/[\u0400-\u04ff]/;return t.test(s)?"Chinese":n.test(s)?"Japanese":a.test(s)?"Korean":r.test(s)?"Arabic":o.test(s)?"Russian":"English"}async function bl(s){const{channels:t}=O.getState();if(s.length===0)throw new Error("At least one channel is required");const n=[];for(const u of s){const m=V.dataContainer.get().messageByChannel[u];if(m?.messages){const p=m.messages.filter(f=>f.sender==="user");for(const f of p)n.push({channelId:u,content:f.content||"",timestamp:f.timestamp||new Date(0)})}}if(n.length===0)throw new Error("No notes found in selected channels");const a=n.map(u=>u.content).join(`

`),r=mx(a),o=s.map(u=>t.find(m=>m.id===u)?.name||u).join(", "),i=n.sort((u,m)=>{const p=u.timestamp instanceof Date?u.timestamp.getTime():u.timestamp;return(m.timestamp instanceof Date?m.timestamp.getTime():m.timestamp)-p}).map((u,m)=>{const p=t.find(f=>f.id===u.channelId)?.name||u.channelId;return`Note ${m+1} (from ${p}):
${u.content}`}).join(`

---

`),l=`You are a knowledge organizer. Build two complementary structures from notes:

1) A graph representation (for free-form exploration):
   - nodes: 12â€“30 key concepts (unique id + label)
   - edges: 15â€“50 relations (source -> target)
   - optional: node importance (1â€“5), edge weight (0.5â€“2.0)

2) A hierarchical mindmap (for XMind-like view):
   - tree: a single root topic with nested children (3â€“5 branches per level is ideal)
   - keep tree labels concise (2â€“4 words) and avoid duplicates

Constraints:
- Everything must be in ${r}
- Normalize concept labels and merge duplicates
- Prefer recurring and connective concepts as higher-level topics
`,c=`Build a mindmap from the following notes from spaces: ${o}

${i}

Return a JSON object with title, nodes, and edges. All labels must be in ${r}.`,d=await rr({schema:hx,prompt:c,system:l,temperature:.4});return{title:d.title,nodes:d.nodes,edges:d.edges,generatedAt:Date.now(),contextChannelIds:s,tree:d.tree}}function gx(){const s=h.useRef(null),[t,n]=h.useState({width:0,height:0});return h.useEffect(()=>{if(!s.current)return;const a=s.current,r=new ResizeObserver(i=>{const l=i[0];if(!l)return;const c=l.contentRect;n({width:Math.floor(c.width),height:Math.floor(c.height)})});r.observe(a);const o=a.getBoundingClientRect();return n({width:Math.floor(o.width),height:Math.floor(o.height)}),()=>r.disconnect()},[]),{ref:s,size:t}}function px(s,t){const n=new Map;for(const a of s)n.set(a.id,0);for(const a of t)n.set(a.source,(n.get(a.source)||0)+1),n.set(a.target,(n.get(a.target)||0)+1);return n}function fx(s,t){const n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download=s,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}function xx({data:s,onPersist:t}){const n=h.useRef(null),a=h.useRef(null),r=h.useRef(null),{ref:o,size:i}=gx(),[l,c]=h.useState(null),[d,u]=h.useState([]),[m,p]=h.useState([]);h.useEffect(()=>{p(s.edges);const v=Math.max(200,i.width),w=Math.max(200,i.height);if(s.nodes.every(T=>typeof T.x=="number"&&typeof T.y=="number")){const T=s.nodes.map(D=>({...D,x:D.x,y:D.y,r:6+Math.min(10,D.importance||0)}));u(T);return}const N=s.nodes.map(T=>({...T})),j=s.edges.map(T=>({source:T.source,target:T.target,weight:T.weight})),C=px(s.nodes,s.edges),E=Hu(N).force("link",Gu(j).id(T=>T.id).distance(T=>{const D=typeof T.source=="object"?T.source.id:T.source;return 40+Math.min(100,12*Math.max(1,C.get(D)||1))}).strength(.12)).force("charge",Vu().strength(-120)).force("collide",qu().radius(T=>18+Math.min(12,C.get(T.id)||0))).force("center",Wu(v/2,w/2)).stop();for(let T=0;T<200;T++)E.tick();const R=N.map(T=>({...T,x:T.x??v/2,y:T.y??w/2,r:6+Math.min(10,(C.get(T.id)||0)*.6+(T.importance||0))}));u(R),t(R.map(({r:T,...D})=>D))},[s.nodes,s.edges,i.width,i.height,t]),h.useEffect(()=>{if(!a.current||!r.current)return;const v=Wn(a.current),w=Wn(r.current),b=j=>{w.attr("transform",j.transform.toString())},N=Fu().scaleExtent([.25,3]).on("zoom",b);return v.call(N),N.transform(v,Bu.translate(0,0).scale(1)),()=>{v.on("wheel.zoom",null),v.on("mousedown.zoom",null),v.on("touchstart.zoom",null)}},[i.width,i.height]);const f=h.useMemo(()=>Ku().on("start",w=>{w.sourceEvent?.stopPropagation?.()}).on("drag",(w,b)=>{const N=w.x,j=w.y;b.x=N,b.y=j,u(C=>C.map(E=>E.id===b.id?{...E,x:N,y:j}:E))}).on("end",()=>{t(d.map(({r:w,...b})=>b))}),[d,t]);h.useEffect(()=>{if(!r.current)return;Wn(r.current).selectAll("g.node").call(f)},[d,f]);const g=h.useMemo(()=>new Map(d.map(v=>[v.id,v])),[d]),x=h.useCallback(v=>l&&(v.source===l||v.target===l),[l]),y=h.useCallback((v,w)=>{const b=(v.x+w.x)/2,N=(v.y+w.y)/2,j=w.x-v.x,C=w.y-v.y,E=Math.hypot(j,C)||1,R=-C/E,T=j/E,D=.16,L=b+R*E*D,U=N+T*E*D;return`M ${v.x},${v.y} Q ${L},${U} ${w.x},${w.y}`},[]);return e.jsx("div",{ref:v=>{o.current=v,n.current=v},className:"w-full h-full",children:e.jsxs("svg",{ref:a,id:"mindmap-svg",width:i.width,height:i.height,className:"block",children:[e.jsx("defs",{children:e.jsxs("filter",{id:"softGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"2.5",result:"coloredBlur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"coloredBlur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})}),e.jsxs("g",{ref:r,children:[e.jsx("g",{children:m.map((v,w)=>{const b=g.get(v.source),N=g.get(v.target);if(!b||!N)return null;const j=v.weight??1,C=x(v),E=C?"hsl(var(--primary))":"hsl(var(--border))",R=C?.9:.6;return e.jsx("path",{d:y(b,N),stroke:E,strokeOpacity:R,strokeWidth:1+Math.min(2.5,Math.max(0,(j-.5)*1.2)),fill:"none",strokeLinecap:"round",pointerEvents:"none"},w)})}),e.jsx("g",{children:d.map(v=>{const w=l===v.id,b=m.some(N=>N.source===v.id||N.target===v.id);return e.jsxs("g",{className:"node",transform:`translate(${v.x}, ${v.y})`,onMouseEnter:()=>c(v.id),onMouseLeave:()=>c(null),style:{cursor:"grab"},children:[e.jsx("circle",{r:v.r,fill:w?"hsl(var(--primary))":b?"hsl(var(--accent))":"hsl(var(--muted))",fillOpacity:w?.95:.9,stroke:w?"hsl(var(--primary-foreground))":"hsl(var(--border))",strokeWidth:w?1.5:1,filter:w?"url(#softGlow)":void 0}),e.jsx("text",{x:v.r+6,y:4,className:"select-none",fontSize:12,fill:w?"hsl(var(--foreground))":"hsl(var(--muted-foreground))",children:v.label})]},v.id)})})]})]})})}const uo=160,ho=44,bx=30,mo=4,vx=.005,go=1.25;function vl(s,t,n=0){const a=t.has(s.id),o=(s.children&&!a?s.children:[]).map(u=>vl(u,t,n+1)),i=o.length?o.reduce((u,m)=>u+m.subtreeHeight,0)+(o.length-1)*mo:0,l=Math.max(ho,i);let c=-l/2;for(const u of o)u.y=c+u.subtreeHeight/2,c+=u.subtreeHeight+mo;const d={...s,width:uo,height:ho,x:n*(uo+bx),y:0,children:o,originalChildren:s.children,subtreeHeight:l};if(o.length>0){const u=o[0].y,m=o[o.length-1].y;d.y=(u+m)/2}return d}function yl(s,t=0){s.y+=t,s.children.forEach(n=>yl(n,s.y))}function yx(s,t){const[n,a]=[s.x,s.y],[r,o]=[t.x,t.y],i=n+(r-n)/2;return`M ${n},${a} C ${i},${a} ${i},${o} ${r},${o}`}function wx({node:s,onToggle:t,collapsed:n,onNodeClick:a,active:r}){const o=(s.originalChildren?.length||0)>0;return e.jsxs("g",{className:"mindmap-node-group",transform:`translate(${s.x}, ${s.y-s.height/2})`,onClick:()=>a?.(s.id),style:{cursor:a?"pointer":"default"},children:[e.jsx("foreignObject",{width:s.width,height:s.height,children:e.jsx("div",{className:"w-full h-full flex items-center justify-center p-1",children:e.jsx("div",{className:"w-full h-full bg-slate-200/50 dark:bg-slate-800/50 border rounded-xl shadow-sm flex items-center justify-center transition-colors "+(r?"border-indigo-500":"border-slate-300 dark:border-slate-700"),children:e.jsx("p",{className:"truncate px-2 "+(r?"text-indigo-700 dark:text-indigo-200 font-medium":"text-slate-800 dark:text-slate-100"),children:s.label})})})}),o&&e.jsxs("g",{transform:`translate(${s.width}, ${s.height/2})`,onClick:i=>{i.stopPropagation(),t(s.id)},children:[e.jsx("circle",{r:16,fill:"transparent"}),e.jsx("circle",{r:10,className:"fill-slate-50 dark:fill-slate-900"}),e.jsx("path",{d:n?"M -4 0 L 4 0 M 0 -4 L 0 4":"M -4 0 L 4 0",stroke:"currentColor",className:"stroke-slate-600 dark:stroke-slate-300",strokeWidth:2,strokeLinecap:"round"})]})]})}function wl(s,t,n,a,r){const o=n.has(s.id),i=r?.has(s.id)??!1;let l=[e.jsx(wx,{node:s,onToggle:t,collapsed:o,onNodeClick:a,active:i},s.id)];return o||s.children.forEach(c=>{const d=i&&(r?.has(c.id)??!1);l.push(e.jsx("path",{d:yx({x:s.x+s.width,y:s.y},{x:c.x,y:c.y}),stroke:"currentColor",className:"transition-colors "+(d?"text-indigo-400 dark:text-indigo-500":"text-slate-300 dark:text-slate-600"),fill:"none",strokeWidth:1.5,strokeLinecap:"round"},`${s.id}-${c.id}`)),l=l.concat(wl(c,t,n,a,r))}),l}function jx({data:s,onRegenerate:t,isLoading:n,onNodeClick:a,activeNodePath:r}){const o=h.useRef(null),i=h.useRef(null),[l,c]=h.useState(new Set),[d,u]=h.useState({x:0,y:0,width:1200,height:800}),m=h.useRef(!1),p=h.useRef({x:0,y:0}),[f,g]=h.useState(!1),x=h.useMemo(()=>{const L=vl(s,l);return yl(L),L},[s,l]),y=h.useCallback((L,U,z)=>{u(K=>{const de=K.width*L,pe=K.height*L,Le=U-(U-K.x)*L,Ie=z-(z-K.y)*L;return{x:Le,y:Ie,width:de,height:pe}})},[]);h.useEffect(()=>{const L=o.current;if(!L)return;const U=z=>{const{clientX:K,clientY:de,deltaY:pe,deltaX:Le,ctrlKey:Ie}=z;if(Ie){z.preventDefault();const $=new DOMPoint(K,de),B=L.getScreenCTM();if(!B)return;const A=$.matrixTransform(B.inverse()),ae=1+pe*vx;y(ae,A.x,A.y)}else if(f){z.preventDefault();const $=d.width/(L.clientWidth||1);u(B=>({...B,x:B.x+Le*$*.5,y:B.y+pe*$*.5}))}};return L.addEventListener("wheel",U,{passive:!1}),()=>L.removeEventListener("wheel",U)},[f,y,d.width]),h.useEffect(()=>{const L=()=>g(!!document.fullscreenElement);return document.addEventListener("fullscreenchange",L),()=>document.removeEventListener("fullscreenchange",L)},[]);const v=h.useCallback(()=>{if(!o.current)return;let U=1/0,z=1/0,K=-1/0,de=-1/0;const pe=B=>{U=Math.min(U,B.x),z=Math.min(z,B.y-B.height/2),K=Math.max(K,B.x+B.width),de=Math.max(de,B.y+B.height/2),l.has(B.id)||B.children.forEach(pe)};pe(x);const Le=80,Ie=K-U,$=de-z;Ie>0&&$>0&&u({x:U-Le,y:z-Le,width:Ie+Le*2,height:$+Le*2})},[x,l]),w=L=>{m.current=!0,p.current={x:L.clientX,y:L.clientY}},b=L=>{if(!m.current||!o.current)return;const U=d.width/(o.current.clientWidth||1),z=(L.clientX-p.current.x)*U,K=(L.clientY-p.current.y)*U;u(de=>({...de,x:de.x-z,y:de.y-K})),p.current={x:L.clientX,y:L.clientY}},N=()=>{m.current=!1},j=h.useCallback(L=>{c(U=>{const z=new Set(U);return z.has(L)?z.delete(L):z.add(L),z})},[]),C=h.useRef(v);h.useEffect(()=>{C.current=v}),h.useEffect(()=>{setTimeout(()=>C.current(),50)},[s,f]);const E=h.useMemo(()=>wl(x,j,l,a,r),[x,j,l,a,r]),R=f?"fixed inset-0 z-50 w-screen h-screen bg-slate-100 dark:bg-slate-900":"relative w-full h-full",T=h.useCallback(()=>{const L=i.current;L&&(document.fullscreenElement?document.exitFullscreen():L.requestFullscreen().catch(()=>{}))},[]),D=L=>{if(!o.current)return;const U=d.x+d.width/2,z=d.y+d.height/2;y(L==="in"?1/go:go,U,z)};return e.jsxs("div",{ref:i,className:R,children:[e.jsx("svg",{ref:o,className:"w-full h-full",viewBox:`${d.x} ${d.y} ${d.width} ${d.height}`,onMouseDown:w,onMouseMove:b,onMouseUp:N,onMouseLeave:N,children:e.jsx("g",{children:E})}),e.jsxs("div",{className:"absolute bottom-3 right-3 flex flex-col gap-2",children:[e.jsxs("div",{className:"bg-white/90 dark:bg-slate-800/90 rounded-lg shadow border border-border/60 overflow-hidden flex flex-col",children:[e.jsx("button",{onClick:()=>D("in"),title:"Zoom In",className:"p-2 hover:bg-muted/60 transition-colors",children:e.jsx(Do,{className:"w-4 h-4"})}),e.jsx("div",{className:"h-px bg-border/60"}),e.jsx("button",{onClick:()=>D("out"),title:"Zoom Out",className:"p-2 hover:bg-muted/60 transition-colors",children:e.jsx(Ro,{className:"w-4 h-4"})}),e.jsx("div",{className:"h-px bg-border/60"}),e.jsx("button",{onClick:v,title:"Fit to View",className:"p-2 hover:bg-muted/60 transition-colors",children:e.jsx(ud,{className:"w-4 h-4"})}),e.jsx("div",{className:"h-px bg-border/60"}),e.jsx("button",{onClick:T,title:f?"Exit Fullscreen":"Enter Fullscreen",className:"p-2 hover:bg-muted/60 transition-colors",children:f?e.jsx(Da,{className:"w-4 h-4"}):e.jsx(qs,{className:"w-4 h-4"})})]}),e.jsx("button",{onClick:t,disabled:n,title:"Regenerate",className:"p-2 bg-white/90 dark:bg-slate-800/90 rounded-lg shadow border border-border/60 text-foreground hover:bg-muted/60 transition-colors disabled:opacity-50",children:n?e.jsx("div",{className:"w-4 h-4 border-2 border-muted-foreground/60 border-t-transparent rounded-full animate-spin"}):e.jsx(as,{className:"w-4 h-4"})})]})]})}const Nx=h.memo(function({item:t,onClose:n}){const a=t.data||{title:t.title,nodes:[],edges:[],generatedAt:Date.now(),contextChannelIds:[]},{updateContentItem:r}=Js(),[o,i]=h.useState(a.tree?"mindmap":"graph"),[l,c]=h.useState(!1);h.useEffect(()=>{i(a.tree?"mindmap":"graph")},[t.id,!!a.tree]);const d=h.useCallback(x=>{const y={...a,nodes:a.nodes.map(v=>{const w=x.find(b=>b.id===v.id);return w?{...v,x:w.x,y:w.y}:v})};r(t.id,{data:y,updatedAt:Date.now()})},[a,t.id,r]),u=h.useCallback(()=>{const x=a.nodes.map(({x:v,y:w,...b})=>({...b})),y={...a,nodes:x};r(t.id,{data:y,updatedAt:Date.now()})},[a,t.id,r]),m=h.useCallback(()=>{const x=(a.title||"mindmap").toLowerCase().replace(/[^a-z0-9-_]+/gi,"-");fx(`${x||"mindmap"}.json`,a)},[a]),p=h.useCallback(()=>{const x=document.querySelector("#mindmap-svg");if(!x)return;const y=x.cloneNode(!0);y.setAttribute("xmlns","http://www.w3.org/2000/svg");const w=new XMLSerializer().serializeToString(y),b=new Blob([w],{type:"image/svg+xml;charset=utf-8"}),N=URL.createObjectURL(b),j=document.createElement("a");j.href=N,j.download=`${(a.title||"mindmap").replace(/\s+/g,"-")}.svg`,document.body.appendChild(j),j.click(),document.body.removeChild(j),URL.revokeObjectURL(N)},[a.title]),f=h.useCallback(async()=>{const x=document.querySelector("#mindmap-svg");if(!x)return;const v=new XMLSerializer().serializeToString(x),w=new Blob([v],{type:"image/svg+xml;charset=utf-8"}),b=URL.createObjectURL(w),N=new Image,j=()=>new Promise((C,E)=>{N.onload=()=>C(N),N.onerror=E,N.src=b});try{const C=await j(),E=x.getBoundingClientRect(),R=document.createElement("canvas");R.width=Math.max(1,Math.floor(E.width)),R.height=Math.max(1,Math.floor(E.height));const T=R.getContext("2d");if(!T)return;T.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--background")||"#fff",T.fillRect(0,0,R.width,R.height),T.drawImage(C,0,0);const D=R.toDataURL("image/png"),L=document.createElement("a");L.href=D,L.download=`${(a.title||"mindmap").replace(/\s+/g,"-")}.png`,document.body.appendChild(L),L.click(),document.body.removeChild(L)}finally{URL.revokeObjectURL(b)}},[a.title]),g=h.useCallback(async()=>{if(!(!Array.isArray(a.contextChannelIds)||a.contextChannelIds.length===0))try{c(!0);const x=await bl(a.contextChannelIds);r(t.id,{data:x,title:x.title,updatedAt:Date.now(),status:"completed"}),x.tree&&i("mindmap")}catch(x){console.error("Regenerate mindmap failed",x)}finally{c(!1)}},[a.contextChannelIds,t.id,r]);return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(k,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:n,children:e.jsx(Yt,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-sm font-medium flex-1 truncate",children:t.title}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(k,{variant:o==="mindmap"?"secondary":"ghost",size:"sm",className:"h-7 px-2",onClick:()=>i("mindmap"),disabled:!a.tree,title:a.tree?"Mindmap view":"Mindmap tree not available for this item",children:"Mindmap"}),e.jsx(k,{variant:o==="graph"?"secondary":"ghost",size:"sm",className:"h-7 px-2",onClick:()=>i("graph"),children:"Graph"})]}),e.jsxs(Lt,{children:[e.jsx(Rt,{asChild:!0,children:e.jsx(k,{variant:"ghost",size:"icon",className:"h-7 w-7",title:"More options",children:e.jsx(Vs,{className:"w-4 h-4"})})}),e.jsxs(Dt,{align:"end",className:"w-44 p-1.5",children:[e.jsxs(rt,{className:"cursor-pointer",onClick:u,children:[e.jsx(as,{className:"w-4 h-4 mr-2"}),"Reset Layout"]}),e.jsxs(rt,{className:"cursor-pointer",onClick:m,children:[e.jsx(cd,{className:"w-4 h-4 mr-2"}),"Download JSON"]}),e.jsxs(rt,{className:"cursor-pointer",onClick:p,children:[e.jsx(Kt,{className:"w-4 h-4 mr-2"}),"Download SVG"]}),e.jsxs(rt,{className:"cursor-pointer",onClick:f,children:[e.jsx(dd,{className:"w-4 h-4 mr-2"}),"Download PNG"]})]})]})]}),e.jsx(xs,{className:"flex-1",children:e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Mindmap Visualization",a.nodes.length>0?` Â· ${a.nodes.length} nodes, ${a.edges.length} links`:""]}),e.jsx("div",{className:"w-full h-96 border border-border/40 rounded-lg bg-background/60",children:o==="mindmap"&&a.tree?e.jsx("div",{className:"w-full h-full",children:e.jsx(jx,{data:a.tree,onRegenerate:g,isLoading:l})}):o==="mindmap"&&!a.tree?e.jsx("div",{className:"w-full h-full flex items-center justify-center text-muted-foreground",children:"No mindmap tree available. Try regenerating."}):a.nodes.length===0?e.jsx("div",{className:"w-full h-full flex items-center justify-center text-muted-foreground",children:"No mindmap generated yet"}):e.jsx("div",{className:"w-full h-full",children:e.jsx(xx,{data:a,onPersist:d})})})]})})]})}),Cx=h.memo(function({item:t,onClose:n}){const r=t.data?.cards||[];return e.jsxs("div",{className:"h-full flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(k,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:n,children:e.jsx(Yt,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-sm font-medium flex-1 truncate",children:r.length>0?`${t.title} (${r.length})`:t.title})]}),e.jsx(xs,{className:"flex-1 min-h-0",children:e.jsx("div",{className:"p-4 space-y-4",children:r.length===0?e.jsx("div",{className:"text-sm text-muted-foreground text-center py-8",children:"No concept cards generated yet"}):r.map((o,i)=>{const l=["bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 dark:from-amber-950/40 dark:via-yellow-950/40 dark:to-orange-950/40","bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 dark:from-orange-950/40 dark:via-amber-950/40 dark:to-yellow-950/40","bg-gradient-to-br from-yellow-50 via-orange-50 to-amber-50 dark:from-yellow-950/40 dark:via-orange-950/40 dark:to-amber-950/40","bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950/40 dark:to-orange-950/40","bg-gradient-to-br from-orange-50 to-amber-50 dark:from-orange-950/40 dark:to-amber-950/40"],c=l[i%l.length];return e.jsxs("div",{className:M("p-5 rounded-xl transition-all duration-300",c),children:[e.jsx("h3",{className:"text-base font-semibold mb-3 text-amber-900 dark:text-amber-100",children:o.title}),e.jsx("div",{className:"text-sm text-foreground/90 mb-4 leading-relaxed",children:o.definition}),o.keyPoints.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-amber-700 dark:text-amber-300 mb-2 uppercase tracking-wide",children:"Key Points"}),e.jsx("ul",{className:"space-y-1.5",children:o.keyPoints.map((d,u)=>e.jsxs("li",{className:"text-sm text-foreground/85 flex items-start gap-2.5",children:[e.jsx("span",{className:"text-amber-600 dark:text-amber-400 mt-0.5 font-semibold",children:"â€¢"}),e.jsx("span",{children:d})]},u))})]}),o.examples.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-amber-700 dark:text-amber-300 mb-2 uppercase tracking-wide",children:"Examples"}),e.jsx("ul",{className:"space-y-1.5",children:o.examples.map((d,u)=>e.jsxs("li",{className:"text-sm text-foreground/85 flex items-start gap-2.5",children:[e.jsx("span",{className:"text-amber-600 dark:text-amber-400 mt-0.5 font-semibold",children:"â€”"}),e.jsx("span",{children:d})]},u))})]}),o.relatedConcepts.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-amber-700 dark:text-amber-300 mb-2 uppercase tracking-wide",children:"Related Concepts"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:o.relatedConcepts.map((d,u)=>e.jsx("span",{className:"text-xs px-2.5 py-1 rounded-full bg-amber-100/80 dark:bg-amber-900/40 text-amber-800 dark:text-amber-200 border border-amber-200/60 dark:border-amber-700/40 font-medium",children:d},u))})]})]},o.id)})})})]})}),kx=h.memo(function({item:t,onClose:n}){return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(k,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:n,children:e.jsx(Yt,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-sm font-medium flex-1 truncate",children:t.title}),e.jsx(k,{variant:"ghost",size:"icon",className:"h-7 w-7",children:e.jsx(Kt,{className:"w-4 h-4"})})]}),e.jsx(xs,{className:"flex-1",children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"prose prose-sm dark:prose-invert max-w-none",children:[e.jsx("h1",{children:t.title}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Based on ",t.contextChannelIds.length," source(s)"]}),e.jsx("div",{className:"mt-6",children:e.jsx("p",{children:"Report content will be displayed here in a structured format."})})]})})})]})}),Sx={type:"object",properties:{title:{type:"string",description:"A concise, descriptive title summarizing the collection of concept cards (2-5 words, same language as the notes)"},cards:{type:"array",items:{type:"object",properties:{id:{type:"string"},title:{type:"string"},definition:{type:"string"},keyPoints:{type:"array",items:{type:"string"}},relatedConcepts:{type:"array",items:{type:"string"}},examples:{type:"array",items:{type:"string"}}},required:["id","title","definition","keyPoints","relatedConcepts","examples"]}}},required:["title","cards"]};function Mx(s){const t=/[\u4e00-\u9fff]/,n=/[\u3040-\u309f\u30a0-\u30ff]/,a=/[\uac00-\ud7af]/,r=/[\u0600-\u06ff]/,o=/[\u0400-\u04ff]/;return t.test(s)?"Chinese":n.test(s)?"Japanese":a.test(s)?"Korean":r.test(s)?"Arabic":o.test(s)?"Russian":"English"}async function Ex(s){const{channels:t}=O.getState();if(s.length===0)throw new Error("At least one channel is required");const n=[];for(const m of s){const p=V.dataContainer.get().messageByChannel[m];if(p?.messages){const f=p.messages.filter(g=>g.sender==="user");for(const g of f)n.push({channelId:m,content:g.content||"",timestamp:g.timestamp||new Date(0)})}}if(n.length===0)throw new Error("No notes found in selected channels");const a=n.map(m=>m.content).join(`

`),r=Mx(a),o=s.map(m=>t.find(p=>p.id===m)?.name||m).join(", "),i=n.sort((m,p)=>{const f=m.timestamp instanceof Date?m.timestamp.getTime():m.timestamp;return(p.timestamp instanceof Date?p.timestamp.getTime():p.timestamp)-f}).map((m,p)=>{const f=t.find(g=>g.id===m.channelId)?.name||m.channelId;return`Note ${p+1} (from ${f}):
${m.content}`}).join(`

---

`),l=`You are an expert knowledge organizer. Your task is to extract and organize key concepts from the user's notes into structured concept cards (like Wikipedia entries).

First, generate a concise title (2-5 words) that summarizes the overall theme or domain of these concept cards. This title should capture the essence of the knowledge collection.

Then, create concept cards where each card should:
1. Have a clear, concise title
2. Include a comprehensive definition
3. List 3-5 key points about the concept
4. Identify 2-4 related concepts
5. Provide 1-3 concrete examples

Focus on concepts that are:
- Important and recurring themes mentioned in the notes
- Core ideas that define the topics discussed
- Concepts that would help someone understand the domain covered in these notes
- Ideas that connect multiple notes together

IMPORTANT: Generate everything in ${r} language. The overall title, all card titles, definitions, key points, related concepts, and examples must be in ${r}.

Generate 5-10 concept cards that best represent the knowledge in these notes.`,c=`Based on the following notes from spaces: ${o}

${i}

Generate concept cards that organize the key concepts from these notes. All content must be in ${r} language. Make sure each card is well-structured and provides value to someone trying to understand the domain.`,d=await rr({schema:Sx,prompt:c,system:l,temperature:.7}),u=d.cards.map(m=>({...m,references:[]}));return{title:d.title,cards:u,generatedAt:Date.now(),contextChannelIds:s}}function Ix(){const{addContentItem:s,updateContentItem:t,setGenerating:n}=Js(),[a,r]=h.useState(!1);return{generate:h.useCallback(async i=>{if(i.length===0)throw new Error("At least one channel is required");r(!0),n(!0);const l=`wiki-card-${Date.now()}`,c={title:"Concept",cards:[],generatedAt:Date.now(),contextChannelIds:i},d={id:l,moduleId:"wiki-card",title:"Concept",contextChannelIds:i,createdAt:Date.now(),updatedAt:Date.now(),data:c,status:"generating"};s(d);try{const u=await Ex(i);return t(l,{status:"completed",data:u,title:u.title}),l}catch(u){throw t(l,{status:"error",errorMessage:u instanceof Error?u.message:"Unknown error"}),u}finally{r(!1),n(!1)}},[s,t,n]),isGenerating:a}}function Tx(){const{addContentItem:s,updateContentItem:t,setGenerating:n}=Js(),[a,r]=h.useState(!1);return{generate:h.useCallback(async i=>{if(i.length===0)throw new Error("At least one channel is required");r(!0),n(!0);const l=`mindmap-${Date.now()}`,c={title:"Mindmap",nodes:[],edges:[],generatedAt:Date.now(),contextChannelIds:i},d={id:l,moduleId:"mindmap",title:"Mindmap",contextChannelIds:i,createdAt:Date.now(),updatedAt:Date.now(),data:c,status:"generating"};s(d);try{const u=await bl(i);return t(l,{status:"completed",data:u,title:u.title}),l}catch(u){throw t(l,{status:"error",errorMessage:u instanceof Error?u.message:"Unknown error"}),u}finally{r(!1),n(!1)}},[s,t,n]),isGenerating:a}}const Ax=h.memo(function({item:t,onOpen:n,onDelete:a,onTogglePin:r}){const o=ox(t.moduleId),i=o?.icon,[l,c]=h.useState(!1),d=h.useMemo(()=>{if(t.moduleId==="wiki-card"&&t.status==="completed"){const p=t.data?.cards?.length??0;return p>0?`${t.title} (${p})`:t.title}return t.title},[t.title,t.moduleId,t.status,t.data]),u=h.useMemo(()=>t.status==="generating"?"Still generating":t.status==="error"?t.errorMessage||"Generation failed":null,[t.status,t.errorMessage]);return e.jsx(We.div,{initial:{opacity:0,y:4},animate:{opacity:1,y:0},transition:{duration:.2},onMouseEnter:()=>c(!0),onMouseLeave:()=>c(!1),className:M("group relative mx-3 mb-2 last:mb-0 transition-all duration-200",u?"opacity-60 cursor-not-allowed":"cursor-pointer"),onClick:()=>{u||n(t)},children:e.jsxs("div",{className:M("relative rounded-lg border transition-all duration-200 overflow-hidden","backdrop-blur-sm bg-card/50","border-border/40 hover:border-border/60",!u&&"hover:shadow-md hover:shadow-black/5 dark:hover:shadow-black/20 hover:-translate-y-0.5",u&&"bg-muted/20"),children:[e.jsxs("div",{className:"relative flex items-center gap-3 p-3",children:[i&&e.jsx("div",{className:M("flex-shrink-0 flex items-center justify-center transition-all duration-200",!u&&"group-hover:scale-105"),children:e.jsx(i,{className:M("w-5 h-5 transition-all duration-200",t.status==="generating"?"text-muted-foreground/40 animate-[breath_2.5s_ease-in-out_infinite]":t.status==="error"?"text-destructive":o?.iconColorClass||"text-muted-foreground/70")})}),e.jsx("div",{className:"flex-1 min-w-0 flex flex-col gap-1.5",children:e.jsx("div",{className:"flex items-start justify-between gap-2",children:e.jsxs("div",{className:"flex-1 min-w-0 flex flex-col gap-1",children:[e.jsx("div",{className:M("text-sm font-medium truncate transition-colors",u?"text-muted-foreground/60":"text-foreground group-hover:text-foreground/90"),children:d}),e.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap",children:[e.jsx("div",{className:"text-[11px] text-muted-foreground/60 font-normal",children:Tt(new Date(t.updatedAt))}),t.status==="error"&&e.jsxs("div",{className:"flex items-center gap-1 text-[11px] text-amber-600 dark:text-amber-400",children:[e.jsx(En,{className:"w-3 h-3"}),e.jsx("span",{children:"Failed"})]}),t.status==="generating"&&e.jsxs("div",{className:"flex items-center gap-1 text-[11px] text-primary/70",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary/60 animate-pulse"}),e.jsx("span",{children:"Generating..."})]})]})]})})}),!u&&e.jsxs("div",{className:M("flex items-center gap-0.5 transition-opacity duration-200 flex-shrink-0",l?"opacity-100":"opacity-0 group-hover:opacity-100"),onClick:m=>m.stopPropagation(),children:[e.jsx(k,{size:"icon",variant:"ghost",className:"h-7 w-7",title:t.pinned?"Unpin":"Pin",onClick:m=>{m.stopPropagation(),r(t)},children:t.pinned?e.jsx(Er,{className:"w-3.5 h-3.5 text-primary fill-primary"}):e.jsx(Er,{className:"w-3.5 h-3.5 text-muted-foreground/60"})}),e.jsxs(Lt,{children:[e.jsx(Rt,{asChild:!0,children:e.jsx(k,{size:"icon",variant:"ghost",className:"h-7 w-7",onClick:m=>m.stopPropagation(),children:e.jsx(Vs,{className:"w-3.5 h-3.5 text-muted-foreground/60"})})}),e.jsxs(Dt,{align:"end",className:"w-48 p-1.5",onClick:m=>m.stopPropagation(),children:[e.jsxs(rt,{onClick:m=>{m.stopPropagation(),n(t)},className:"cursor-pointer",children:[e.jsx(hd,{className:"w-4 h-4 mr-2"}),"Open"]}),e.jsxs(rt,{onClick:m=>{m.stopPropagation(),a(t)},className:"text-destructive cursor-pointer focus:text-destructive",children:[e.jsx(it,{className:"w-4 h-4 mr-2"}),"Delete"]})]})]})]})]}),!u&&e.jsx("div",{className:"absolute inset-0 rounded-lg bg-gradient-to-br from-primary/0 via-primary/0 to-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none"})]})})}),Lx=h.memo(function({title:t="Your Ideas, Elevated",description:n="Pick a module to generate insights from your notes. Simple, focused, worldâ€‘class.",children:a}){return e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx(We.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},transition:{duration:.4,ease:[.16,1,.3,1]},className:"inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-gradient-to-br from-primary/10 via-primary/5 to-transparent backdrop-blur-sm border border-primary/10 shadow-sm mb-4",children:e.jsx(We.div,{animate:{rotate:[0,5,-5,0]},transition:{duration:4,repeat:1/0,ease:"easeInOut"},children:e.jsx(mt,{className:"w-6 h-6 text-primary/80 drop-shadow-sm"})})}),e.jsx(We.div,{initial:{opacity:0,y:4},animate:{opacity:1,y:0},transition:{duration:.4,delay:.1,ease:[.16,1,.3,1]},className:"text-sm font-semibold mb-2 text-foreground/90",children:t}),e.jsx(We.div,{initial:{opacity:0,y:4},animate:{opacity:1,y:0},transition:{duration:.4,delay:.15,ease:[.16,1,.3,1]},className:"text-sm text-muted-foreground/80 leading-relaxed max-w-sm mx-auto mb-4",children:n}),a]})}),Rx=(s,t,n,a)=>{const o=a[s].find(i=>i.id===t);if(!o)return null;switch(s){case"audio-summary":return e.jsx(ux,{item:o,onClose:n});case"mindmap":return e.jsx(Nx,{item:o,onClose:n});case"wiki-card":return e.jsx(Cx,{item:o,onClose:n});case"report":return e.jsx(kx,{item:o,onClose:n});default:return null}},Dx=h.memo(function(){const t=ve(b=>b.closeStudio),{currentModule:n,activeItemId:a,setCurrentModule:r,setActiveItem:o,contentItems:i,currentContext:l,deleteContentItem:c,togglePin:d}=Js(),{currentChannelId:u}=W(),{channels:m}=O(),p=ix(),{generate:f}=Ix(),{generate:g}=Tx(),x=h.useCallback(async b=>{if(b==="wiki-card"||b==="mindmap"){let N=[];if(l?.mode==="all"?N=m.map(j=>j.id):l?.mode==="custom"&&l.channelIds.length>0?N=l.channelIds:l?.mode==="auto"&&u?N=[u]:u&&(N=[u]),N.length===0){console.warn("No channels available for concept cards generation");return}try{r(b);const j=b==="wiki-card"?await f(N):await g(N);o(j)}catch(j){console.error(b==="wiki-card"?"Failed to generate concept cards:":"Failed to generate mindmap:",j)}}else console.warn(`Module ${b} generation not yet implemented`)},[r,o,l,u,m,f]),y=h.useCallback(()=>{r(null),o(null)},[r,o]),v=h.useMemo(()=>{if(!n||!a)return null;const N=i[n].find(j=>j.id===a);return N?N.status==="generating"?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-2.5 border-b border-border/40 flex-shrink-0",children:[e.jsx(k,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:y,children:e.jsx(Yt,{className:"w-4 h-4"})}),e.jsx("div",{className:"text-sm font-medium flex-1",children:N.title}),e.jsx(k,{variant:"ghost",size:"icon",className:"h-7 w-7 opacity-0 pointer-events-none",children:e.jsx(le,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"relative inline-block",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-primary/40 animate-[dot-pulse_1.5s_ease-in-out_infinite] mx-auto"}),e.jsx("div",{className:"absolute inset-0 rounded-full bg-primary/10 animate-[expand-ring_2.5s_ease-in-out_infinite]"})]})})]}):Rx(n,a,y,i):null},[a,i,n,y]),w=h.useMemo(()=>{const b=Object.values(i).flat(),N=b.filter(C=>C.pinned).sort((C,E)=>E.updatedAt-C.updatedAt),j=b.filter(C=>!C.pinned).sort((C,E)=>E.updatedAt-C.updatedAt);return[...N,...j].slice(0,8)},[i]);return e.jsx("div",{className:"h-full flex flex-col bg-background",children:e.jsx(Ho,{mode:"wait",initial:!1,children:v?e.jsx(We.div,{className:"h-full flex flex-col",initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{duration:.2,ease:[.16,1,.3,1]},children:v},"detail"):e.jsxs(We.div,{className:"h-full flex flex-col",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},transition:{duration:.2,ease:[.16,1,.3,1]},children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2.5 border-b border-border/40 gap-2",children:[e.jsx(dx,{}),e.jsx(k,{variant:"ghost",size:"icon",className:"h-7 w-7 ml-auto",onClick:t,children:e.jsx(le,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex-1 min-h-0 flex flex-col",children:[e.jsx("div",{className:"flex-shrink-0 p-4 pb-3",children:e.jsx("div",{className:"grid grid-cols-2 gap-3",children:p.map((b,N)=>e.jsx(We.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{duration:.3,delay:N*.05,ease:[.16,1,.3,1]},children:e.jsx(cx,{module:b,onClick:()=>x(b.id)})},b.id))})}),e.jsx("div",{className:"flex-1 min-h-0 border-t border-border/40",children:w.length===0?e.jsx(We.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{duration:.4,delay:p.length*.05+.1,ease:[.16,1,.3,1]},className:"h-full flex items-center justify-center px-4",children:e.jsx(Lx,{})}):e.jsx(xs,{className:"h-full",children:e.jsx("div",{className:"py-3",children:w.map(b=>e.jsx(Ax,{item:b,onOpen:N=>{r(N.moduleId),o(N.id)},onDelete:N=>c(N.id),onTogglePin:N=>d(N.id)},b.id))})})})]})]},"grid")})})}),_x=()=>{const s=he(),t=h.useRef(!1);return{jumpToNote:({channelId:a,messageId:r})=>{if(t.current)return;t.current=!0;const o=d=>new Promise(u=>setTimeout(u,d)),i=()=>{const d="search-target-highlight-style";if(document.getElementById(d))return;const u=document.createElement("style");u.id=d,u.textContent=`
              @keyframes search-target-pulse {
                0% { background-color: rgba(250, 204, 21, 0.00); outline-color: rgba(245, 158, 11, 0.00); }
                20% { background-color: rgba(250, 204, 21, 0.32); outline-color: rgba(245, 158, 11, 0.95); }
                55% { background-color: rgba(250, 204, 21, 0.20); outline-color: rgba(245, 158, 11, 0.50); }
                100% { background-color: rgba(250, 204, 21, 0.08); outline-color: rgba(245, 158, 11, 0.00); }
              }
              .search-target-highlight {
                outline: 2px solid rgba(245, 158, 11, 0.9); /* amber-500 */
                background-color: rgba(250, 204, 21, 0.18); /* amber-300 @ ~18% */
                animation: search-target-pulse 1.5s ease-in-out 2;
              }
            `,document.head.appendChild(u)},l=d=>{const u=d.getBoundingClientRect(),m=window.innerHeight||document.documentElement.clientHeight,p=window.innerWidth||document.documentElement.clientWidth;return u.top>=0&&u.left>=0&&u.bottom<=m&&u.right<=p},c=(d,u=1200)=>{i();let m=!1;const p=()=>{m||(m=!0,d.classList.add("search-target-highlight"),setTimeout(()=>d.classList.remove("search-target-highlight"),u))};if(l(d)){p();return}if("IntersectionObserver"in window){const f=new IntersectionObserver(g=>{g.find(y=>y.isIntersecting)&&(p(),f.disconnect())},{threshold:.1});f.observe(d),setTimeout(()=>{m||(f.disconnect(),p())},2e3)}else setTimeout(p,300)};(async()=>{try{const{currentChannelId:d}=W.getState();d!==a&&(W.getState().setCurrentChannel(a),await new Promise(y=>setTimeout(y,140)));const u=cs.messageById(r),m=(y,v)=>{v||y.scrollIntoView({behavior:"smooth",block:"start"}),c(y,3e3)},p=async()=>{const y=document.querySelector(u);if(y)return m(y),!0;if(s.scrollManager.getTimelineVirtualScrollApi()?.scrollToMessageId(r,{align:"start",behavior:"smooth"})??!1){await o(120);const b=document.querySelector(u);if(b)return m(b,!0),!0}return!1},f=8e3,g=Date.now();let x=0;for(V.requestLoadInitialMessages$.next({channelId:a});Date.now()-g<f;){if(await p())return;const y=V.dataContainer.get().messageByChannel[a];if(y?.hasMore&&!y.loadingMore&&x<25){x+=1,await V.loadMoreHistory({channelId:a,messagesLimit:30}),await new Promise(w=>{let b=!1;const N=V.moreMessageLoadedEvent$.listen(j=>{j.channelId===a&&!b&&(b=!0,N(),w())});setTimeout(()=>{if(!b){b=!0;try{N()}catch{}w()}},1600)}),await new Promise(w=>setTimeout(w,70));continue}await new Promise(w=>setTimeout(w,160))}console.warn("[JumpToMessage] not found within time budget",{channelId:a,messageId:r})}finally{setTimeout(()=>{t.current=!1},200)}})()}}};function Px(){const s=ar(),t=ve(i=>i.sideView),n=ve(i=>i.currentThreadId),{currentChannelId:a}=W(),{jumpToNote:r}=_x();Ba(s.rxEventBus.requestJumpToMessage$,r);const o=()=>{switch(t){case nt.THREAD:return e.jsx(rx,{isOpen:!0,onClose:()=>s.closeThread(),currentThreadId:n||void 0});case nt.AI_ASSISTANT:return e.jsx(np,{isOpen:!0,onClose:()=>s.closeAIAssistant(),channelId:a||""});case nt.STUDIO:return e.jsx(Dx,{});default:return null}};return e.jsx(Nm,{sidebar:e.jsx(yp,{}),content:e.jsx(ax,{}),rightSidebar:o()})}function Ox({message:s}){return s.isDeleted?null:e.jsx("div",{className:"group relative w-full max-w-full overflow-hidden",children:e.jsxs("div",{className:"bg-card border border-border/50 rounded-xl p-6 shadow-sm hover:shadow-md transition-all duration-200 hover:border-border w-full max-w-full overflow-hidden",children:[e.jsx("div",{className:"flex items-center gap-2 mb-4 text-xs text-muted-foreground",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Tn,{className:"w-3.5 h-3.5 shrink-0"}),e.jsx("span",{className:"font-medium truncate",children:Tt(s.timestamp)})]})}),e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none prose-headings:font-semibold prose-p:leading-relaxed prose-p:text-foreground prose-a:text-primary hover:prose-a:text-primary/80 break-words overflow-wrap-anywhere",children:e.jsx(Ys,{content:s.content})})]})})}function $x({groupedMessages:s}){const t=h.useMemo(()=>{const n=[];return Object.entries(s).forEach(([a,r])=>{n.push({type:"date-divider",date:a}),r.filter(o=>o.sender==="user"&&!o.parentId&&!o.isDeleted).forEach(o=>{n.push({type:"message",message:o})})}),n},[s]);return t.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-muted/50 flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),e.jsx("p",{className:"text-muted-foreground font-medium",children:"This space doesn't have any messages yet."})]}):e.jsx("div",{className:"space-y-8 w-full max-w-full overflow-x-hidden",children:t.map((n,a)=>n.type==="date-divider"?e.jsx("div",{className:"py-4 w-full max-w-full overflow-x-hidden",children:e.jsxs("div",{className:"flex items-center gap-4 w-full max-w-full",children:[e.jsx("div",{className:"flex-1 h-px bg-gradient-to-r from-transparent via-border to-border min-w-0"}),e.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider px-3 py-1 bg-card rounded-full border border-border/50 shadow-sm shrink-0",children:n.date}),e.jsx("div",{className:"flex-1 h-px bg-gradient-to-l from-transparent via-border to-border min-w-0"})]})},`date-${n.date}-${a}`):n.message?e.jsx(Ox,{message:n.message},n.message.id):null)})}function jl(){const{shareToken:s}=Vd(),[t,n]=h.useState(null),[a,r]=h.useState([]),[o,i]=h.useState(!0),[l,c]=h.useState(null),[d,u]=h.useState(""),[m,p]=h.useState(!1),f=h.useRef(null);h.useEffect(()=>{if(!s){c("Invalid share token"),i(!1);return}(async()=>{try{i(!0);const N=await oe.findChannelByShareToken(s);if(!N){c("Space not found"),i(!1);return}n(N);const j=await oe.fetchInitialMessagesAllSenders(N.userId,N.channel.id,100);r(j.messages)}catch(N){console.error("Error loading public space:",N),c("Failed to load space")}finally{i(!1)}})()},[s]);const g=async()=>{if(!(!s||!t))try{const b=await oe.fetchInitialMessagesAllSenders(t.userId,t.channel.id,100);r(b.messages)}catch(b){console.error("Error loading messages:",b)}};h.useEffect(()=>{t&&g()},[t,s]);const x=async()=>{if(!(!d.trim()||!s||!t||m)){p(!0);try{await oe.createMessageForPublicSpace(s,{content:d.trim(),sender:"user",channelId:t.channel.id}),u(""),await g(),f.current&&(f.current.style.height="auto")}catch(b){console.error("Error sending message:",b),alert(b instanceof Error?b.message:"Failed to send message")}finally{p(!1)}}},y=b=>{b.key==="Enter"&&(b.metaKey||b.ctrlKey)&&(b.preventDefault(),x())};h.useEffect(()=>{f.current&&(f.current.style.height="auto",f.current.style.height=`${Math.min(f.current.scrollHeight,200)}px`)},[d]);const v=nr(a,{latestFirst:!0}),w=t?.channel.shareMode==="append-only";return o?e.jsx("div",{className:"min-h-screen w-full flex items-center justify-center bg-gradient-to-b from-background to-muted/30",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-12 h-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin mx-auto"}),e.jsx("div",{className:"absolute inset-0 w-12 h-12 border-4 border-transparent border-r-primary/40 rounded-full animate-spin mx-auto",style:{animationDirection:"reverse",animationDuration:"1.5s"}})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Loading space"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Please wait a moment..."})]})]})}):l||!t?e.jsx("div",{className:"min-h-screen w-full flex items-center justify-center bg-gradient-to-b from-background to-muted/30",children:e.jsxs("div",{className:"text-center max-w-md px-4 space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-muted flex items-center justify-center mx-auto",children:e.jsx("svg",{className:"w-8 h-8 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Space Not Found"}),e.jsx("p",{className:"text-muted-foreground",children:l||"This space is not available or has been removed."})]})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-background via-background to-muted/20 w-full overflow-x-hidden",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-8 pt-8 w-full flex flex-col min-h-screen",children:[e.jsxs("div",{className:"flex-1 space-y-8 w-full max-w-full overflow-x-hidden",children:[e.jsxs("div",{className:"relative w-full max-w-full",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-primary/5 via-transparent to-primary/5 rounded-2xl"}),e.jsx("div",{className:"relative bg-card border border-border/50 rounded-2xl p-8 shadow-sm w-full max-w-full overflow-hidden",children:e.jsxs("div",{className:"flex items-start gap-4 mb-4",children:[t.channel.emoji&&e.jsx("div",{className:"flex-shrink-0 w-16 h-16 rounded-xl bg-muted/50 flex items-center justify-center text-4xl shadow-sm",children:t.channel.emoji}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2 leading-tight break-words",children:t.channel.name}),t.channel.description&&e.jsx("p",{className:"text-muted-foreground text-base leading-relaxed break-words",children:t.channel.description})]})]})})]}),e.jsx("div",{className:"w-full max-w-full overflow-x-hidden",children:e.jsx($x,{groupedMessages:v})})]}),w&&e.jsx("div",{className:"sticky bottom-0 bg-background border-t border-border/60 mt-8 w-full max-w-full overflow-x-hidden",children:e.jsx("div",{className:"w-full max-w-full py-3",children:e.jsxs("div",{className:"relative w-full max-w-full",children:[e.jsx(gs,{ref:f,value:d,onChange:b=>u(b.target.value),onKeyDown:y,placeholder:"Type your message... (Ctrl/Cmd+Enter to send)",className:"min-h-[80px] max-h-[200px] resize-none w-full bg-background border border-border/60 rounded-lg focus:border-border transition-colors pr-12",disabled:m}),e.jsx("button",{onClick:x,disabled:!d.trim()||m,className:"absolute bottom-2 right-2 w-8 h-8 rounded-md flex items-center justify-center transition-colors duration-150 text-muted-foreground hover:text-foreground hover:bg-accent disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent","aria-label":"Send message",children:m?e.jsx(ot,{className:"w-4 h-4 animate-spin"}):e.jsx(_a,{className:"w-4 h-4"})})]})})})]})})}const Ux=Pa({manifest:{id:"notes",name:"Notes Extension",description:"Conversational AI note-taking feature",version:"1.0.0",author:"StillRoot Team",icon:"notebook"},activate:({subscriptions:s})=>{s.push(ut.from(Fa.getState().addIcons({"message-square":ds,hash:An,plus:Me,notebook:$o}))),s.push(ut.from(Vt.getState().addItem({id:"notes",label:"Notes",title:"Conversational Notes",group:ls.MAIN,collapsedLabel:"Notes",icon:"notebook",order:1}))),s.push(ut.from(Pn.getState().addRoutes([{id:"notes-main",path:"/notes",element:e.jsx(Px,{}),order:1},{id:"public-space",path:"/space/:shareToken",element:e.jsx(jl,{}),order:2},{id:"notes-default",path:"*",element:e.jsx(Wo,{to:"/notes"}),order:9999}]))),s.push(ut.from(Di([{activityKey:"notes",routerPath:"/notes"}])))}}),zx="https://stillroot.app/#/space/18ec8262-2f5b-4c07-8dd1-fb3cdda8f1e7";function Fx(){let s=null;return s=ji.show({content:e.jsxs("div",{className:"flex flex-col w-screen max-w-[1024px] h-[80vh]",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b border-border bg-background",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Product Feedback"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Share your thoughts in the space below, we'll review them regularly"})]}),e.jsx("button",{type:"button",className:"text-xs text-muted-foreground hover:text-foreground px-2 py-1 rounded",onClick:()=>s?.close(),children:"Close"})]}),e.jsx("div",{className:"flex-1 bg-muted",children:e.jsx("iframe",{src:zx,title:"Feedback Space",className:"w-full h-full border-0"})})]}),className:"w-full max-w-[1024px] h-[80vh] flex flex-col",position:"center"}),s}const Bx=Pa({manifest:{id:"feedback",name:"Feedback",description:"Send product feedback to the StillRoot team",version:"1.0.0",author:"StillRoot Team",icon:"heart"},activate:({subscriptions:s})=>{s.push(ut.from(Vt.getState().addItem({id:"feedback",label:"Feedback",title:"Product Feedback",group:ls.FOOTER,icon:"heart",order:1e3,iconColor:"text-pink-600 dark:text-pink-400",onClick:()=>{Fx()}})))}});class Hx{addChannel=async t=>await O.getState().addChannel(t);deleteChannel=async t=>await O.getState().deleteChannel(t);updateChannel=async(t,n)=>await O.getState().updateChannel(t,n)}class Gx{requestJumpToMessage$=new dn;requestTimelineScrollToLatest$=new dn;requestTimelineScrollToBottom$=this.requestTimelineScrollToLatest$;onHistoryMessagesLoadedEvent$=new dn}class Vx{addThreadMessage=async(t,n)=>await O.getState().addThreadMessage(t,n)}class qx{setCurrentChannel=t=>{W.getState().setCurrentChannel(t)}}class Wx{deleteMessage=async({messageId:t,hardDelete:n,channelId:a})=>await V.deleteMessage({messageId:t,hardDelete:n,channelId:a});updateMessage=async({messageId:t,updates:n,channelId:a,userId:r})=>await V.updateMessage({messageId:t,updates:n,channelId:a,userId:r});sendMessage=async t=>await V.sendMessage(t);moveMessage=async({messageId:t,fromChannelId:n,toChannelId:a})=>await V.moveMessage({messageId:t,fromChannelId:n,toChannelId:a})}class Kx{startEditing=({messageId:t,content:n,restoreDraft:a=!1})=>{const r=tr(n);return X.getState().startEditing(t,n,{baseHash:r,restoreDraft:a})};save=async(t=!0)=>await X.getState().save(t);cancel=()=>{const t=X.getState();if(!t.editingMessageId){t.cancel();return}const n=t.editContent.trim(),a=t.originalContent.trim();if(n!==a){we.confirm({title:"Discard changes?",description:"You have unsaved edits. Are you sure you want to discard them?",okText:"Discard",okVariant:"destructive",cancelText:"Keep editing",onOk:async()=>{const{editingMessageId:o}=X.getState();o&&X.getState().clearDraft(o),X.getState().cancel()}});return}t.cancel()};switchToExpandedMode=()=>X.getState().switchToExpandedMode();switchToInlineMode=()=>X.getState().switchToInlineMode();setEditorMode=t=>X.getState().setEditorMode(t);updateContent=t=>X.getState().updateContent(t);applyDraft=()=>X.getState().applyDraft();dismissDraftPrompt=()=>X.getState().dismissDraftPrompt();discardDraft=t=>X.getState().clearDraft(t)}class Yx{scrollContainerRef=null;timelineVirtualScrollApi=null;setScrollContainerRef=t=>{this.scrollContainerRef=t};setTimelineVirtualScrollApi=t=>{this.timelineVirtualScrollApi=t};getScrollContainer=()=>this.scrollContainerRef?.current;getTimelineVirtualScrollApi=()=>this.timelineVirtualScrollApi}class Nl{rxEventBus=new Gx;threadManager=new Vx;channelManager=new Hx;viewStateManager=new qx;noteManager=new Wx;noteEditManager=new Kx;scrollManager=new Yx;openAIAssistant=()=>{ve.getState().openAIAssistant()};openThread=({messageId:t})=>{ve.getState().openThread(t)};closeThread=()=>{ve.getState().closeThread()};closeAIAssistant=()=>{ve.getState().closeAIAssistant()};openSettings=()=>{ve.getState().openSettings()};closeSettings=()=>{ve.getState().closeSettings()};openChannelList=()=>{ve.getState().openChannelList()};closeChannelList=()=>{ve.getState().closeChannelList()};openStudio=()=>{ve.getState().openStudio()};closeStudio=()=>{ve.getState().closeStudio()};jumpToNote=t=>{this.rxEventBus.requestJumpToMessage$.emit(t)}}class Xx extends Nl{}const Jx=()=>{const s=h.useMemo(()=>new Xx,[]),t=h.useMemo(()=>[Ux,Bx],[]);return e.jsx(ul.Provider,{value:s,children:e.jsx(za.Provider,{value:s,children:e.jsxs("div",{className:"h-screen flex flex-col",children:[e.jsx(dm,{extensions:t}),e.jsx(wi,{})]})})})},Qx=({currentChannelName:s,currentChannel:t,channels:n})=>{const{openChannelList:a,openAIAssistant:r,openSettings:o}=ve(),{setCurrentChannel:i}=W(),{channels:l}=O(),c=t?er(l,t.id):l,d=()=>{r()};return e.jsx("div",{className:"flex-shrink-0 px-4 py-2 bg-background",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"ghost",size:"icon",onClick:a,className:"h-9 w-9 dark:text-primary",title:"Channels","aria-label":"Channels",children:e.jsx(bn,{className:"size-5"})}),e.jsx(Hs,{instantCreate:!0,variant:"dialog",trigger:e.jsx(k,{variant:"ghost",size:"icon",className:"h-9 w-9 dark:text-primary",title:"New space","aria-label":"New space",children:e.jsx(Me,{className:"size-5"})})})]}),e.jsx("div",{className:"flex-1 text-center min-w-0",children:t&&l.length>1?e.jsx(fl,{currentChannel:t,channels:c,onChannelSelect:i,className:"w-full"}):e.jsx("h1",{className:"text-lg font-semibold text-foreground/90 truncate px-2 max-w-full",children:s||"Chat"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>Gs(),className:"h-9 w-9 dark:text-primary",title:"Search",children:e.jsx(Fe,{className:"size-5"})}),e.jsx(k,{variant:"ghost",size:"icon",onClick:d,className:"h-9 w-9 dark:text-primary",children:e.jsx(Et,{className:"size-5"})}),e.jsx(k,{variant:"ghost",size:"lg",onClick:o,className:"h-9 w-9 dark:text-primary",children:e.jsx(La,{className:"size-5"})})]})]})})},Zx=({onSend:s,replyToMessageId:t,onCancelReply:n,isSending:a=!1,className:r=""})=>{const[o,i]=h.useState(""),l=h.useRef(null);h.useEffect(()=>{l.current&&(l.current.style.height="auto",l.current.style.height=`${Math.min(l.current.scrollHeight,120)}px`)},[o]);const c=()=>{o.trim()&&(s(o.trim()),i(""),l.current&&(l.current.style.height="auto"))},d=m=>{if(m.key==="Enter"){if(m.shiftKey)return;m.preventDefault(),c()}},u=!!t;return e.jsxs("div",{className:M("bg-background px-3 sm:px-4 py-2 space-y-2 border-t border-border/60",r),children:[u&&e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 rounded-xl px-3 py-2",children:[e.jsx("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:e.jsx("span",{children:"Replying to message"})}),e.jsx(k,{variant:"ghost",size:"sm",onClick:n,className:"h-7 px-3 text-xs rounded-lg",children:"Cancel"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(gs,{ref:l,value:o,onChange:m=>i(m.target.value),onKeyDown:d,placeholder:"What's on your mind?",className:"min-h-[48px] max-h-[120px] resize-none bg-transparent shadow-none focus:shadow-none focus:outline-none transition-all duration-200 text-base placeholder:text-muted-foreground/60 border-0 pl-0 pr-12 py-2",rows:1}),e.jsx("div",{className:"absolute right-0 top-1/2 -translate-y-1/2 flex items-center",children:e.jsx("button",{type:"button",onClick:c,disabled:!o.trim()||a,className:`w-8 h-8 rounded-md flex items-center justify-center transition-colors duration-150 text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-slate-300 ${!o.trim()||a?"opacity-40 cursor-not-allowed hover:bg-transparent":""}`,"aria-label":"Send",children:a?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current"}):e.jsx(_o,{className:"h-4 w-4"})})})]})})]})},e0=()=>{const{addChannel:s}=O(),t=async()=>{try{await s({name:"My First Space",emoji:"ðŸš€",description:"Start your journey here"})}catch(n){console.error("Failed to create first channel:",n)}};return e.jsx("div",{className:"flex-1 flex items-center justify-center p-6",children:e.jsxs("div",{className:"max-w-sm w-full space-y-6 text-center",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto shadow-lg",children:e.jsx(mt,{className:"w-8 h-8 text-white"})}),e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Welcome to StillRoot"}),e.jsx("p",{className:"text-muted-foreground text-sm leading-relaxed",children:"Your personal space for thoughts, ideas, and AI-powered conversations. Create your first thought space to get started."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 text-left",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(Xe,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-foreground",children:"Organize Thoughts"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Create dedicated spaces for different topics"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 text-left",children:[e.jsx("div",{className:"w-8 h-8 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(Et,{className:"w-4 h-4 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-foreground",children:"AI Assistant"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Get help from AI to explore ideas"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 text-left",children:[e.jsx("div",{className:"w-8 h-8 bg-purple-100 dark:bg-purple-900/20 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(us,{className:"w-4 h-4 text-purple-600 dark:text-purple-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-foreground",children:"Spark Ideas"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Capture inspiration and brainstorm solutions"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(k,{onClick:t,size:"lg",className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white shadow-lg",children:[e.jsx(Me,{className:"w-5 h-5 mr-2"}),"Create Your First Space"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"You can create more spaces later from the menu"})]})]})})},t0=({originalContent:s,onSave:t,onCancel:n,onCollapse:a,isSaving:r})=>{const o=X(p=>p.editContent),i=X(p=>p.updateContent),l=o.trim()!==s.trim(),c=h.useRef(null);$n({textareaRef:c,updateContent:i,content:o});const d=p=>{const f=p.target.value;i(f)},u=()=>{l&&t()},m=()=>{l?confirm("You have unsaved changes. Are you sure you want to cancel?")&&n():n()};return e.jsxs("div",{className:"w-full h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border bg-muted/30",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"ghost",size:"icon",onClick:a,className:"h-8 w-8",children:e.jsx(Yt,{className:"h-4 w-4"})}),e.jsx("h3",{className:"font-semibold text-foreground",children:"Edit Message"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"ghost",size:"sm",onClick:m,disabled:r,className:"px-3 py-1.5 text-sm text-muted-foreground hover:text-foreground transition-colors",children:"Cancel"}),e.jsx(k,{onClick:u,disabled:!l||r,size:"sm",className:`px-3 py-1.5 text-sm rounded-md transition-colors ${l?"bg-slate-600 hover:bg-slate-700 text-white shadow-sm border border-slate-500":"bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed"}`,children:r?"Saving...":"Save"})]})]}),e.jsx("div",{className:"flex-1 p-4 min-h-0",children:e.jsx(gs,{ref:c,value:o,onChange:d,placeholder:"Edit your message...",className:"w-full h-full resize-none text-sm leading-relaxed border border-input rounded-lg p-3 bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent",autoFocus:!0})}),e.jsx("div",{className:"p-4 border-t border-border bg-muted/30",children:e.jsx("div",{className:"text-xs text-muted-foreground text-center",children:l?"Unsaved changes":"All changes saved"})})]})};function s0({onSave:s,onCancel:t,onExpand:n,isSaving:a,editorMode:r,onEditorModeChange:o}){const i=X(g=>g.editContent),l=X(g=>g.originalContent),c=X(g=>g.updateContent),d=i.trim()!==l.trim(),u=h.useRef(null);$n({textareaRef:u,updateContent:c,content:r==="markdown"?i:""});const m=g=>{const x=g.target.value;c(x)},p=()=>{d&&s()},f=()=>{d?confirm("You have unsaved changes. Are you sure you want to cancel?")&&t():t()};return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"relative",children:r==="markdown"?e.jsx(gs,{ref:u,value:i,onChange:m,placeholder:"Edit your thought...",className:"min-h-[120px] resize-none text-sm leading-relaxed border-2 border-blue-200 dark:border-blue-700 focus:border-blue-400 dark:focus:border-blue-500",autoFocus:!0,style:{caretColor:"#3b82f6"}}):e.jsx(Xs,{value:i,onChange:g=>c(g),editable:!a,placeholder:"Edit your thought...",className:"min-h-[140px]"})}),e.jsx(dl,{leftActions:[{label:"Cancel",onClick:f,disabled:a,icon:e.jsx(le,{className:"w-3 h-3 mr-1"})},{label:a?"Saving...":"Save",onClick:p,disabled:!d||a,icon:e.jsx(gd,{className:"w-3 h-3 mr-1"}),className:d?"bg-slate-600 hover:bg-slate-700 text-white shadow-sm border border-slate-500 transition-colors duration-200":"bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed"}],rightActions:[{label:"Expand",onClick:n,disabled:a,icon:e.jsx(md,{className:"w-3 h-3 mr-1"}),variant:"outline"}]})]})}function n0({message:s,isEditing:t,onDelete:n,onEdit:a,onCopy:r,onReply:o,onGenerateSparks:i,onViewDetails:l,onBookmark:c,editorMode:d,onEditorModeChange:u,onMove:m}){const p=()=>{r?r():navigator.clipboard.writeText(s.content)},f=[{id:"primary",showSeparator:!1,items:[...a&&Se().channel.thoughtRecord.edit.enabled?[{id:"edit",icon:e.jsx(Gt,{className:"w-4 h-4"}),title:"Edit",onClick:a,variant:"default",disabled:t}]:[],{id:"copy",icon:e.jsx(os,{className:"w-4 h-4"}),title:"Copy",onClick:p,variant:"default",disabled:t},...m?[{id:"move",icon:e.jsx(Po,{className:"w-4 h-4"}),title:"Move to space",onClick:m,variant:"default",disabled:t}]:[]]},...t&&d&&u?[{id:"editor-mode",showSeparator:!0,items:[{id:"markdown-mode",icon:e.jsx(Oo,{className:"w-4 h-4"}),title:d==="markdown"?"âœ“ Markdown Mode":"Markdown Mode",onClick:()=>u("markdown"),variant:"default",disabled:!1},{id:"wysiwyg-mode",icon:e.jsx(Xe,{className:"w-4 h-4"}),title:d==="wysiwyg"?"âœ“ WYSIWYG Mode":"WYSIWYG Mode",onClick:()=>u("wysiwyg"),variant:"default",disabled:!1}]}]:[],{id:"ai",showSeparator:!0,items:i&&Se().channel.thoughtRecord.sparks.enabled?[{id:"generate-sparks",icon:e.jsx(us,{className:"w-4 h-4"}),title:"Generate Sparks",onClick:i,variant:"default",disabled:t}]:[]},{id:"secondary",showSeparator:!0,items:[]},{id:"danger",showSeparator:!0,items:[{id:"delete",icon:e.jsx(it,{className:"w-4 h-4"}),title:"Delete",onClick:n,variant:"default",disabled:t}]}];return e.jsx(Zi,{groups:f,width:"md",alwaysVisible:!0,triggerClassName:"h-8 w-8 p-0 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all duration-200 rounded-md"})}function a0({children:s,messageId:t,maxHeight:n=600,className:a}){return e.jsx(hl,{messageId:t,maxHeight:n,clampMargin:24,className:M("relative group",a),children:s})}function r0({message:s,showAnalysis:t,onToggleAnalysis:n,className:a,autoGenerate:r=!1}){const o=s.aiAnalysis,{isGenerating:i,error:l,hasTagContext:c,contentTooShort:d,sparks:u,generate:m,regenerate:p}=ml(s,{enableContextEnhancement:!0,mode:"stream"}),f=!!(u&&u.length||o?.insights?.length),g=u??o?.insights??[];return h.useEffect(()=>{r&&t&&!f&&!i&&m()},[r,t,f,i,m]),!f&&!t?null:e.jsx("div",{className:a,children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:n,className:"flex items-center gap-1.5 px-2.5 py-1.5 bg-blue-50 dark:bg-blue-900/20 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-all duration-200 group",title:t?"Hide sparks":"Show sparks",children:[e.jsx(us,{className:"w-3.5 h-3.5 text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"text-xs font-medium text-blue-700 dark:text-blue-300",children:f?o.insights.length:0})]}),c&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-full",children:"Tagâ€‘enhanced"})]}),t&&e.jsx("div",{className:"space-y-2",children:f?e.jsxs("div",{className:"space-y-2",children:[g.map((x,y)=>e.jsx("div",{className:"text-xs text-slate-700 dark:text-slate-200 leading-relaxed p-2 bg-white/60 dark:bg-slate-700/40 rounded-lg border border-slate-200/40 dark:border-slate-600/40",children:x},y)),e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(k,{variant:"outline",size:"sm",onClick:p,disabled:i,children:i?"Generating...":"Regenerate"})})]}):e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-lg border border-slate-200/50 dark:border-slate-700/50 bg-slate-50/60 dark:bg-slate-800/30",children:[e.jsx("div",{className:"flex items-center gap-2",children:i?e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400",children:[e.jsx("div",{className:"w-3 h-3 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}),"Generating sparks..."]}):l?e.jsxs("div",{className:"text-xs text-red-500",children:["Failed: ",l]}):d?e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:"Add a bit more content to get meaningful sparks"}):e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:"No sparks yet"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"outline",size:"sm",onClick:m,disabled:i||d,children:i?"Generating...":"Generate"}),e.jsx("button",{onClick:n,className:"p-1 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-all duration-200 rounded hover:bg-slate-200/60 dark:hover:bg-slate-700/60",title:"Close analysis",children:e.jsx(le,{className:"w-4 h-4"})})]})]})})]})})}const Cl=h.createContext(null),or=()=>{const s=h.useContext(Cl);if(!s)throw new Error("useMobilePresenter must be used within a MobilePresenterProvider");return s};function o0({threadCount:s,messageId:t}){return or(),null}const i0=({message:s,onReply:t,threadCount:n=0})=>{const a=he(),{isEditing:r,editMode:o,isSaving:i,isExpandedEditing:l}=ll(s),[c,d]=h.useState(!1),[u,m]=h.useState(!1),p=X(E=>E.editorMode);if(h.useEffect(()=>{u&&m(!1)},[u]),s.isDeleted)return null;const f=()=>{a.noteEditManager.startEditing({messageId:s.id,content:s.content})},g=async()=>{const E=s.content.length>100?`${s.content.substring(0,100)}...`:s.content;window.confirm(`ðŸ—‘ï¸ Delete Thought

"${E}"

âš ï¸ This action cannot be undone.
The thought will be moved to trash.

Are you sure you want to continue?`)&&await a.noteManager.deleteMessage({messageId:s.id,channelId:s.channelId})},x=()=>{d(!c)},y=()=>{m(!0),d(!0)},v=()=>{navigator.clipboard.writeText(s.content)},w=()=>{t?.()},b=()=>{we.show({content:e.jsx(cl,{fromChannelId:s.channelId,onMove:async E=>{await a.noteManager.moveMessage({messageId:s.id,fromChannelId:s.channelId,toChannelId:E})}}),showFooter:!1,className:"max-w-md"})},N=async()=>{await a.noteEditManager.save()},j=()=>{a.noteEditManager.cancel()},C=()=>{a.noteEditManager.switchToExpandedMode()};return e.jsx("div",{className:"w-full flex flex-col overflow-hidden group",children:e.jsxs("div",{className:`relative w-full px-4 py-4 bg-muted/20 hover:bg-muted/40 transition-all duration-200 ease-out ${s.isNew?"animate-in slide-in-from-bottom-5 fade-in duration-400":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center gap-2 text-xs text-muted-foreground font-medium",children:e.jsx("span",{children:Tt(s.timestamp)})}),e.jsx("div",{className:"w-1 h-1 bg-muted-foreground/60 rounded-full"})]}),e.jsx(n0,{message:s,isEditing:r,onDelete:g,onEdit:f,onCopy:v,onReply:t?w:void 0,onGenerateSparks:y,onViewDetails:()=>{},onBookmark:()=>{},editorMode:p,onEditorModeChange:a.noteEditManager.setEditorMode,onMove:b})]}),e.jsx("div",{className:"",children:r&&o==="inline"?e.jsx(s0,{onSave:N,onCancel:j,onExpand:C,isSaving:i,editorMode:p,onEditorModeChange:a.noteEditManager.setEditorMode}):e.jsx(a0,{maxHeight:400,messageId:s.id,children:e.jsx(Ys,{content:s.content})})}),!r&&e.jsx(r0,{message:s,showAnalysis:c,onToggleAnalysis:x,autoGenerate:u}),!r&&n>0&&e.jsx("div",{className:"flex justify-end mt-4 pt-2",children:e.jsx(o0,{threadCount:n,messageId:s.id})}),e.jsx(gt,{open:l,onOpenChange:E=>{E||a.noteEditManager.cancel()},children:e.jsx(pt,{showCloseButton:!1,className:"h-[90vh] w-[95vw] max-w-none p-0 border-0 bg-background",onInteractOutside:E=>{E.preventDefault()},children:e.jsx(t0,{originalContent:s.content,onSave:N,onCancel:j,onCollapse:()=>a.noteEditManager.cancel(),isSaving:i})})})]})})},l0=({onReply:s,className:t=""})=>{const n=he(),{currentChannelId:a}=W(),{messages:r=[],loading:o,hasMore:i,loadMore:l,getChannelState:c}=fs({onHistoryMessagesChange:p=>{n.rxEventBus.onHistoryMessagesLoadedEvent$.emit(p)}}),d=nr(r,{latestFirst:!0}),{handleScroll:u}=il({onTrigger:()=>{a&&l({channelId:a,messagesLimit:20})},canTrigger:!!i&&!o,getState:c,direction:"bottom"}),m=Object.values(d).some(p=>p.some(f=>f.sender==="user"&&!f.parentId));return a?o?e.jsx(al,{count:5}):m?e.jsx("div",{className:`flex-1 min-h-0 relative overflow-hidden bg-white dark:bg-slate-950 ${t}`,children:e.jsx(rl,{className:"h-full",renderThoughtRecord:(p,f)=>e.jsx(i0,{message:p,onReply:()=>s(p.id),threadCount:f}),groupedMessages:d,messages:r,onScroll:u})}):e.jsx(ol,{}):e.jsx(e0,{})},c0=({onSendMessage:s,setReplyToMessageId:t})=>{const n=h.useCallback(r=>{t(r)},[t]),a=h.useCallback(r=>{s(r)},[s]);return{handleReply:n,handleSendMessage:a}},d0=()=>{const[s,t]=h.useState("100vh");return h.useEffect(()=>{const n=()=>{const r=`${window.innerHeight}px`;t(r),document.documentElement.style.setProperty("--mobile-vh",r)};n();const a=["resize","orientationchange"];return a.forEach(r=>{window.addEventListener(r,n)}),"visualViewport"in window&&window.visualViewport&&window.visualViewport.addEventListener("resize",n),()=>{a.forEach(r=>{window.removeEventListener(r,n)}),"visualViewport"in window&&window.visualViewport&&window.visualViewport.removeEventListener("resize",n)}},[]),s},u0=({currentChannelName:s,replyToMessageId:t,isAddingMessage:n,onSendMessage:a,onCancelReply:r,setReplyToMessageId:o})=>{const i=or(),l=c0({onSendMessage:a,setReplyToMessageId:o}),c=d0(),{currentChannelId:d}=W(),{channels:u}=O(),m=u.find(x=>x.id===d),{inputCollapsed:p}=ps(),f=h.useRef(null),g=x=>{V.sendMessage({channelId:W.getState().currentChannelId,content:x,sender:"user"}),setTimeout(()=>{i.rxEventBus.requestTimelineScrollToLatest$.emit()},100)};return e.jsxs("div",{className:"flex flex-col overflow-hidden",style:{height:c,minHeight:c,maxHeight:c},children:[e.jsx(Qx,{currentChannelName:s,currentChannel:m,channels:u}),e.jsxs("div",{className:"flex-1 flex flex-col min-h-0 overflow-hidden",children:[e.jsx(l0,{onReply:l.handleReply}),m&&e.jsx("div",{ref:f,className:`flex-shrink-0 bg-transparent overflow-hidden transition-[max-height,opacity,transform,padding] duration-220 ease-out origin-bottom ${p?"max-h-0 opacity-0 translate-y-1 py-0":"max-h-[220px] opacity-100 translate-y-0"}`,"aria-hidden":p,children:e.jsx(Zx,{onSend:g,replyToMessageId:t||void 0,onCancelReply:r,isSending:n})})]})]})},h0=({scrollContainerRef:s})=>{const t=h.useRef(0);return h.useEffect(()=>{s.current&&(t.current=s.current.scrollHeight)},[s]),h.useEffect(()=>{const n=s.current;if(!n)return;t.current=n.scrollHeight;const a=()=>{t.current=n.scrollHeight};return n.addEventListener("scroll",a),()=>{n.removeEventListener("scroll",a)}},[t,s]),{lastScrollHeightRef:t}},m0=({enableDetect:s,scrollContainerRef:t,handleScrollHeightChange:n})=>{const{lastScrollHeightRef:a}=h0({scrollContainerRef:t}),r=$s(n);h.useEffect(()=>{if(!s)return;const o=t.current;if(!o)return;let i=null;const l=()=>{o&&(o.scrollHeight!==a.current&&r(),i=requestAnimationFrame(l))};return i=requestAnimationFrame(l),()=>{i&&cancelAnimationFrame(i)}},[s,t,a,r])};function g0({scrollContainerRef:s,threshold:t=30,deps:n=[]}){const[a,r]=h.useState(!1),o=h.useCallback((l={})=>{const c=s.current;c&&(l.smooth?c.scrollTo({top:c.scrollHeight,behavior:"smooth"}):c.scrollTop=c.scrollHeight)},[s]),i=h.useCallback(()=>{const l=s.current;if(!l)return;const c=l.scrollHeight-l.scrollTop-l.clientHeight;r(c<=t)},[t,s]);return h.useEffect(()=>{a&&o()},n),h.useEffect(()=>{const l=s.current;if(l)return l.addEventListener("scroll",i),()=>{l.removeEventListener("scroll",i)}},[i,s]),m0({enableDetect:a,scrollContainerRef:s,handleScrollHeightChange:()=>{Te.getState().shouldSuppressAutoScrollNow()?Te.getState().activateAutoScrollSuppression():o()}}),{isSticky:a,scrollToBottom:o,setSticky:r}}const po=(s,t=5)=>{if(!s)return!1;const{scrollTop:n,clientHeight:a,scrollHeight:r}=s;return r-n-a>t},p0=(s,t=[],n={})=>{const{scrollToBottom:a,isSticky:r,setSticky:o}=g0({scrollContainerRef:s,threshold:n.threshold??30,deps:t}),[i,l]=h.useState(!1);h.useEffect(()=>{const d=s.current;if(d){l(po(d,n.threshold??30));const u=()=>{l(po(d,n.threshold??30))};return d.addEventListener("scroll",u),()=>{d?.removeEventListener("scroll",u)}}},[s,n.threshold]);const c=$s(d=>{o(!0),a({smooth:d?.behavior==="smooth"})});return{containerRef:s,isSticky:r,scrollToBottom:c,showScrollToBottomButton:i}};function f0(){const{currentChannelId:s}=W(),t=O(d=>d.addThreadMessage),[n,a]=h.useState(!1),[r,o]=h.useState(void 0);return{isThreadOpen:n,currentThreadId:r,handleOpenThread:d=>{o(d),a(!0)},handleCloseThread:()=>{a(!1),o(void 0)},handleSendThreadMessage:d=>{r&&t(r,{content:d,sender:"user",channelId:s||""})}}}const x0=()=>{const{addMessage:s,addThreadMessage:t}=O(),{currentChannelId:n,isAddingMessage:a,setIsAddingMessage:r}=W();return{sendMessage:async(i,l)=>{if(!(!i.trim()||!n))try{return l?await t(l,{content:i.trim(),sender:"user",channelId:n}):await s({content:i.trim(),sender:"user",channelId:n}),r(!0),setTimeout(async()=>{try{l?await t(l,{content:"This is an AI response as an annotation to your message.",sender:"ai",channelId:n}):await s({content:"This is an AI response as an annotation to your content.",sender:"ai",channelId:n})}catch(c){console.error("Failed to add AI response:",c)}finally{r(!1)}},1e3),!0}catch(c){return console.error("Failed to send message:",c),!1}},isAddingMessage:a}},b0=()=>{const{currentChannelId:s}=W(),{channels:t}=O(),{messages:n,hasMore:a,loadMore:r}=fs({}),o=h.useRef(null),{isSticky:i,scrollToBottom:l}=p0(o,[s,n.length]),{replyToMessageId:c,handleCancelReply:d,handleReply:u}=sl(),{isThreadOpen:m,handleOpenThread:p,handleCloseThread:f,handleSendThreadMessage:g}=f0(),{sendMessage:x,isAddingMessage:y}=x0();return h.useEffect(()=>{const w=()=>{if(!o.current)return;const{scrollTop:N}=o.current;N===0&&a&&s&&r({channelId:s,messagesLimit:20})},b=o.current;if(b)return b.addEventListener("scroll",w),()=>b.removeEventListener("scroll",w)},[a,r,o,s]),{currentChannelId:s,channels:t,messages:n,hasMore:a,isSticky:i,replyToMessageId:c,isThreadOpen:m,isAddingMessage:y,containerRef:o,handleSendMessage:async w=>{requestAnimationFrame(()=>{l({behavior:"instant"})}),x(w,c||void 0),c&&d()},handleCancelReply:d,handleOpenThread:p,handleCloseThread:f,handleSendThreadMessage:g,scrollToBottom:l,handleReply:u}};function fn({...s}){return e.jsx(xo,{"data-slot":"sheet",...s})}function v0({...s}){return e.jsx(yo,{"data-slot":"sheet-portal",...s})}function y0({className:s,...t}){return e.jsx(wo,{"data-slot":"sheet-overlay",className:M("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",s),...t})}function xn({className:s,children:t,side:n="right",hideClose:a,...r}){return e.jsxs(v0,{children:[e.jsx(y0,{}),e.jsxs(bo,{"data-slot":"sheet-content",className:M("bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-200 data-[state=open]:duration-250",n==="right"&&"data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm",n==="left"&&"data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm",n==="top"&&"data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b",n==="bottom"&&"data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",s),...r,children:[t,!a&&e.jsxs(vo,{className:"data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:outline-hidden disabled:pointer-events-none",children:[e.jsx(le,{className:"size-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]})}const w0=({onClose:s})=>e.jsxs("div",{className:"h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(La,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-semibold text-foreground",children:"Settings"})]}),s&&e.jsx(k,{variant:"ghost",size:"icon","aria-label":"Close",className:"h-8 w-8",onClick:s,children:e.jsx(le,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex-1 p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:"Account"}),e.jsx("div",{className:"bg-muted/50 rounded-lg p-3",children:e.jsx(Ei,{})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:"Appearance"}),e.jsx("div",{className:"bg-muted/50 rounded-lg p-3",children:e.jsx(Ci,{})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:"Data"}),e.jsx(k,{variant:"outline",className:"w-full justify-start",children:"Export Data"}),e.jsx(k,{variant:"outline",className:"w-full justify-start",children:"Import Data"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[e.jsx(aa,{className:"w-4 h-4"}),"Developer"]}),e.jsxs(gt,{children:[e.jsx(ri,{asChild:!0,children:e.jsxs(k,{variant:"outline",className:"w-full justify-start",children:[e.jsx(ko,{className:"w-4 h-4 mr-2"}),"Debug Information"]})}),e.jsxs(pt,{className:"sm:max-w-md",children:[e.jsx(hs,{children:e.jsx(ms,{children:"Debug Information"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Version:"}),e.jsx("div",{className:"text-muted-foreground",children:"v1.0.5"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Build Time:"}),e.jsx("div",{className:"text-muted-foreground",children:new Date().toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Environment:"}),e.jsx("div",{className:"text-muted-foreground",children:"Production"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Platform:"}),e.jsx("div",{className:"text-muted-foreground",children:"Mobile"})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground border-t pt-3",children:"This debug information is only visible to developers and support staff."})]})]})]})]})]})]}),j0=h.forwardRef(function({conversations:t,currentConversationId:n,loading:a,onCreate:r,channelId:o,onClose:i},l){const c=Y(v=>v.uiView),d=Y(v=>v.showList),u=Y(v=>v.showChat),m=t.length>0;h.useImperativeHandle(l,()=>({showList:()=>d(),showChat:()=>u(),createNew:()=>{r(),u()},isListView:()=>c==="list"}),[r,d,u,c]);const p=()=>a?e.jsx(Jg,{count:5}):e.jsx(Ga,{conversations:t,currentConversationId:n,loading:a,withHeader:!1}),f=()=>n?e.jsx(Wi,{conversationId:n,channelId:o,onClose:i}):a?e.jsx(Xa,{}):m?e.jsx("div",{className:"flex-1"}):e.jsx(Ki,{onCreate:r}),g=n?t.find(v=>v.id===n):void 0,x=Y(v=>v.titleGeneratingMap),y=c==="list"?"Conversations":g?x[g.id]?"Generating title...":g.title||"AI Chat":"AI Chat";return e.jsxs("div",{className:"relative flex-1 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 pt-2 pb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[c==="chat"&&e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>d(),"aria-label":"Show conversations",className:"h-8 w-8 flex-shrink-0",children:e.jsx(Ao,{className:"w-4 h-4"})}),c==="list"&&e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>u(),"aria-label":"Back to chat",className:"h-8 w-8 flex-shrink-0",children:e.jsx(Yt,{className:"w-4 h-4"})}),e.jsx("h3",{className:"font-semibold text-foreground truncate text-sm leading-6",children:y})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx(k,{variant:"ghost",size:"icon","aria-label":"New conversation",className:"h-8 w-8",onClick:()=>{r(),u()},children:e.jsx(Me,{className:"w-4 h-4"})}),i&&e.jsxs(k,{variant:"ghost",size:"icon","aria-label":"Close",className:"h-8 w-8",onClick:i,children:[e.jsx("span",{className:"sr-only",children:"Close"}),e.jsx("svg",{viewBox:"0 0 24 24",className:"w-4 h-4","aria-hidden":!0,children:e.jsx("path",{stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",d:"M6 6l12 12M18 6L6 18"})})]})]})]}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"absolute inset-0 flex flex-col "+(c==="list"?"":"hidden"),children:p()}),e.jsx("div",{className:"absolute inset-0 flex flex-col "+(c==="chat"?"":"hidden"),children:f()})]})]})}),N0=({channelId:s,isOpen:t,onClose:n})=>{const{userId:a}=O(),{conversations:r,currentConversationId:o,loading:i,createConversation:l,loadConversations:c}=Ks(),d=h.useRef(null);h.useEffect(()=>{a&&t&&c(a)},[a,t,c]);const u=()=>{a&&l(a,"New Conversation")};return t?e.jsx(j0,{ref:d,conversations:r,currentConversationId:o,loading:i,onCreate:u,channelId:s,onClose:n}):null};function C0({channel:s,isOpen:t,onOpenChange:n}){const a=he(),[r,o]=h.useState(s.name),[i,l]=h.useState(s.description||""),[c,d]=h.useState(s.emoji||""),[u,m]=h.useState(!1);h.useEffect(()=>{t&&(o(s.name),l(s.description||""),d(s.emoji||""))},[t,s.id,s.name,s.description,s.emoji]);const p=async()=>{if(r.trim()){m(!0);try{const x=r.trim()!==s.name,y=i.trim()!==(s.description||""),v=c.trim()!==(s.emoji||"");await a.channelManager.updateChannel(s.id,{name:r.trim(),description:i.trim(),emoji:c.trim()||void 0}),x&&Ne.logChannelEdit(s.id,Bt.NAME),y&&Ne.logChannelEdit(s.id,Bt.DESCRIPTION),v&&Ne.logChannelEdit(s.id,Bt.EMOJI),n(!1)}catch(x){console.error("Error updating channel:",x),o(s.name),l(s.description||""),d(s.emoji||"")}finally{m(!1)}}},f=()=>{o(s.name),l(s.description||""),d(s.emoji||""),n(!1)},g=x=>{x.key==="Enter"&&!u?p():x.key==="Escape"&&f()};return e.jsx(gt,{open:t,onOpenChange:n,children:e.jsxs(pt,{className:"sm:max-w-md",children:[e.jsx(hs,{children:e.jsx(ms,{children:"Edit Space"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(et,{htmlFor:"emoji",children:"Emoji"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ja,{onSelect:d,children:e.jsx(k,{variant:"outline",size:"sm",className:"h-8 w-8 p-0",type:"button",children:c||"ðŸ˜Š"})}),e.jsx(_e,{id:"emoji",value:c,onChange:x=>d(x.target.value),placeholder:"Choose an emoji",className:"flex-1",maxLength:2})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(et,{htmlFor:"name",children:"Name"}),e.jsx(_e,{id:"name",value:r,onChange:x=>o(x.target.value),placeholder:"Enter space name",onKeyDown:g,disabled:u})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(et,{htmlFor:"description",children:"Description"}),e.jsx(gs,{id:"description",value:i,onChange:x=>l(x.target.value),placeholder:"Enter space description (optional)",rows:3,disabled:u})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(k,{variant:"outline",onClick:f,disabled:u,children:"Cancel"}),e.jsx(k,{onClick:p,disabled:u||!r.trim(),children:u?"Saving...":"Save"})]})]})})}function k0({channel:s,onDelete:t}){const[n,a]=h.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(Lt,{children:[e.jsx(Rt,{asChild:!0,children:e.jsx(k,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-muted-foreground hover:text-foreground hover:bg-muted",title:"More actions",onClick:r=>r.stopPropagation(),children:e.jsx(Vs,{className:"h-3.5 w-3.5"})})}),e.jsx(Dt,{className:"w-56 p-2",align:"end",side:"bottom",onClick:r=>r.stopPropagation(),children:e.jsx(el,{groups:[{id:"actions",items:[{id:"edit",icon:e.jsx(Gt,{}),title:`Edit ${s.name}`,onClick:()=>a(!0)}]},{id:"danger",items:[{id:"delete",icon:e.jsx(it,{}),title:`Delete ${s.name}`,onClick:t}]}]})})]}),e.jsx(C0,{channel:s,isOpen:n,onOpenChange:a})]})}function S0({channel:s,isActive:t}){const n=he(),a=()=>{n.viewStateManager.setCurrentChannel(s.id)},r=async o=>{if(window.confirm(`ðŸ—‘ï¸ Delete Channel

"${s.name}"

âš ï¸ This action cannot be undone.
The channel and all its messages will be moved to trash.

Are you sure you want to continue?`))try{await n.channelManager.deleteChannel(o)}catch(l){const c=l instanceof Error?l.message:"Unknown error";alert(`âŒ Failed to delete the channel.

Error: ${c}

Please try again.`)}};return e.jsxs("button",{onClick:a,className:M("w-full flex items-center gap-3 px-3 py-3 text-left transition-all duration-200 group rounded-lg","hover:bg-muted/50",t&&"bg-muted/50"),children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 flex items-center justify-center",children:s.emoji?e.jsx("span",{className:"text-lg leading-none",title:`Emoji: ${s.emoji}`,children:s.emoji}):e.jsx(An,{className:"w-4 h-4 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:M("font-medium truncate text-sm",t?"text-foreground":"text-foreground/80"),children:s.name}),s.description&&e.jsx("div",{className:"text-xs text-muted-foreground truncate mt-0.5",children:s.description})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx(k0,{channel:s,onDelete:()=>r(s.id)})})]})}function M0({isOpen:s}){const t=he(),n=O(o=>o.channels),a=W(o=>o.currentChannelId);Qa();const r=h.useMemo(()=>Za(n),[n]);return e.jsx(fn,{open:s,onOpenChange:()=>t.closeChannelList(),children:e.jsx(xn,{side:"left",className:"w-80 p-0 border-r border-border",hideClose:!0,children:e.jsxs("div",{className:"flex flex-col h-full bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h3",{className:"font-semibold text-foreground",children:"Spaces"})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(Hs,{variant:"dialog",trigger:e.jsx(k,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"New space","aria-label":"New space",children:e.jsx(Me,{className:"w-4 h-4"})})})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-2",children:r.map(o=>e.jsx(S0,{channel:o,isActive:a===o.id},o.id))})]})})})}const E0=()=>{const s=he(),t=W(o=>o.currentChannelId),{messages:n}=fs({}),a=t?n.find(o=>o.id===t):null,r=t?n.filter(o=>o.threadId===t)||[]:[];return e.jsxs("div",{className:"h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ds,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-semibold text-foreground",children:"Thread"})]}),e.jsx(k,{variant:"ghost",size:"icon","aria-label":"Close",className:"h-8 w-8",onClick:()=>s.closeThread(),children:e.jsx(le,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"p-4 bg-muted/50",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-2",children:"Parent Message"}),e.jsx("div",{className:"text-sm text-foreground leading-relaxed",children:a?.content}),e.jsx("div",{className:"text-xs text-muted-foreground mt-2",children:Tt(a?.timestamp||new Date)})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground mb-3",children:"Replies"}),r.length===0?e.jsx("div",{className:"text-sm text-muted-foreground text-center py-8",children:"No replies yet. Start the conversation!"}):r.map(o=>e.jsxs("div",{className:"bg-card border border-border rounded-lg p-3",children:[e.jsx("div",{className:"text-sm text-foreground leading-relaxed whitespace-pre-wrap",children:o.content}),e.jsx("div",{className:"text-xs text-muted-foreground mt-2",children:Tt(o.timestamp)})]},o.id))]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"Reply to thread...",className:"flex-1 px-3 py-2 border border-border rounded-md text-sm bg-background text-foreground placeholder:text-muted-foreground",onKeyDown:o=>{o.key==="Enter"&&o.currentTarget.value.trim()&&(t&&s.threadManager.addThreadMessage(t,{content:o.currentTarget.value.trim(),sender:"user",channelId:t}),o.currentTarget.value="")}}),e.jsx(k,{size:"sm",onClick:o=>{const i=o.currentTarget.previousElementSibling;i&&i.value.trim()&&(t&&s.threadManager.addThreadMessage(t,{content:i.value.trim(),sender:"user",channelId:t}),i.value="")},children:"Reply"})]})})]})},I0=()=>{const s=he(),t=W(r=>r.currentChannelId),n=ve(r=>r.isChannelListOpen),a=ve(r=>r.sideView);return e.jsxs(e.Fragment,{children:[e.jsx(M0,{isOpen:n}),t&&e.jsx(fn,{open:a===nt.AI_ASSISTANT,onOpenChange:s.closeAIAssistant,children:e.jsx(xn,{side:"bottom",className:"h-[80vh] p-0 border-t border-border/60",hideClose:!0,onOpenAutoFocus:r=>r.preventDefault(),children:e.jsx(N0,{channelId:t,isOpen:a===nt.AI_ASSISTANT,onClose:()=>s.closeAIAssistant()})})}),a===nt.THREAD&&e.jsx(fn,{open:a===nt.THREAD,onOpenChange:()=>s.closeThread(),children:e.jsx(xn,{side:"right",className:"w-full max-w-md p-0 border-l border-border/60",hideClose:!0,children:e.jsx(E0,{})})}),e.jsx(fn,{open:a===nt.SETTINGS,onOpenChange:()=>s.closeSettings(),children:e.jsx(xn,{side:"right",className:"w-full max-w-md p-0 border-l border-border/60",hideClose:!0,children:e.jsx(w0,{onClose:()=>s.closeSettings()})})})]})};function T0(){const s=or();Qa();const t=b0(),{jumpToNote:n}=A0();Ba(s.rxEventBus.requestJumpToMessage$,n);const a=t.channels.find(r=>r.id===t.currentChannelId);return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx(u0,{currentChannelName:a?.name,replyToMessageId:t.replyToMessageId,isAddingMessage:t.isAddingMessage,onSendMessage:t.handleSendMessage,onCancelReply:t.handleCancelReply,setReplyToMessageId:r=>{r&&t.handleReply(r)}}),e.jsx(I0,{})]})}function A0(){return{jumpToNote:({channelId:t,messageId:n})=>{const a=()=>{const i="search-target-highlight-style";if(document.getElementById(i))return;const l=document.createElement("style");l.id=i,l.textContent=`
    @keyframes search-target-pulse { 
      0% { background-color: rgba(250, 204, 21, 0.00); outline-color: rgba(245, 158, 11, 0.00); }
      20% { background-color: rgba(250, 204, 21, 0.32); outline-color: rgba(245, 158, 11, 0.95); }
      55% { background-color: rgba(250, 204, 21, 0.20); outline-color: rgba(245, 158, 11, 0.50); }
      100% { background-color: rgba(250, 204, 21, 0.08); outline-color: rgba(245, 158, 11, 0.00); }
    }
    .search-target-highlight { outline: 2px solid rgba(245, 158, 11, 0.9); background-color: rgba(250, 204, 21, 0.18); animation: search-target-pulse 1.5s ease-in-out 2; }
  `,document.head.appendChild(l)},r=i=>{const l=i.getBoundingClientRect(),c=window.innerHeight||document.documentElement.clientHeight,d=window.innerWidth||document.documentElement.clientWidth;return l.top>=0&&l.left>=0&&l.bottom<=c&&l.right<=d},o=(i,l=3e3)=>{a();let c=!1;const d=()=>{c||(c=!0,i.classList.add("search-target-highlight"),setTimeout(()=>i.classList.remove("search-target-highlight"),l))};if(r(i)){d();return}if("IntersectionObserver"in window){const u=new IntersectionObserver(m=>{m.find(f=>f.isIntersecting)&&(d(),u.disconnect())},{threshold:.1});u.observe(i),setTimeout(()=>{c||(u.disconnect(),d())},2e3)}else setTimeout(d,300)};(async()=>{try{const{currentChannelId:i}=W.getState();i!==t&&(W.getState().setCurrentChannel(t),await new Promise(p=>setTimeout(p,160)));const l=cs.messageById(n),c=()=>{const p=document.querySelector(l);return p?(p.scrollIntoView({behavior:"smooth",block:"start"}),o(p,3e3),!0):!1},d=8e3,u=Date.now();let m=0;for(V.requestLoadInitialMessages$.next({channelId:t});Date.now()-u<d;){if(c())return;const p=V.dataContainer.get().messageByChannel[t];if(p?.hasMore&&!p.loadingMore&&m<20){m+=1,await V.loadMoreHistory({channelId:t,messagesLimit:20}),await new Promise(g=>{let x=!1;const y=V.moreMessageLoadedEvent$.listen(v=>{v.channelId===t&&!x&&(x=!0,y(),g())});setTimeout(()=>{if(!x){x=!0;try{y()}catch{}g()}},1600)}),await new Promise(g=>setTimeout(g,60));continue}await new Promise(g=>setTimeout(g,150))}console.warn("[Mobile JumpToMessage] not found within time budget",{channelId:t,messageId:n})}finally{}})()}}}const L0=Pa({manifest:{id:"mobile-notes",name:"Mobile Notes Extension",description:"Mobile-optimized conversational AI note-taking feature",version:"1.0.0",author:"StillRoot Team",icon:"notebook"},activate:({subscriptions:s})=>{s.push(ut.from(Fa.getState().addIcons({notebook:$o,hash:An,plus:Me,menu:Mo}))),s.push(ut.from(Vt.getState().addItem({id:"mobile-notes",label:"Notes",title:"Mobile Notes",group:ls.MAIN,icon:"notebook",order:1,iconColor:"text-blue-600 dark:text-blue-400"}))),s.push(ut.from(Pn.getState().addRoutes([{id:"mobile-notes-main",path:"/notes",element:e.jsx(T0,{}),order:1},{id:"mobile-public-space",path:"/space/:shareToken",element:e.jsx(jl,{}),order:2},{id:"mobile-notes-default",path:"*",element:e.jsx(Wo,{to:"/notes"}),order:9999}]))),s.push(ut.from(Di([{activityKey:"mobile-notes",routerPath:"/notes"}])))}});function kl(s){return s.sort((t,n)=>(t.order??0)-(n.order??0)).map(t=>e.jsx(qo,{path:t.path,element:t.element,children:t.children&&kl(t.children)},t.id))}const R0=()=>{const s=Pn(t=>t.routes);return e.jsx(Vo,{children:kl(s)})},D0=s=>{const{extensions:t}=s,{initialized:n}=Ni({extensions:t});return n?e.jsx("div",{className:"flex flex-col bg-background overflow-hidden",style:{height:"100%"},children:e.jsx("div",{className:"flex-1 min-h-0 overflow-hidden h-full",children:e.jsx(R0,{})})}):e.jsx("div",{className:"flex items-center justify-center h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("div",{className:"text-muted-foreground",children:"Loading..."})]})})};class _0 extends Nl{}const P0=()=>{const s=h.useMemo(()=>new _0,[]);return e.jsx(Cl.Provider,{value:s,children:e.jsx(za.Provider,{value:s,children:e.jsxs("div",{className:"flex flex-col bg-background overflow-hidden",style:{height:"100%"},children:[e.jsx(D0,{extensions:[L0]}),e.jsx(wi,{})]})})})},O0=Ee()((s,t)=>({visible:!1,process:null,show:n=>{const a=n.steps?.map(r=>({...r,status:r.status??"pending"}));s({visible:!0,process:{id:n.id,title:n.title,message:n.message,status:"running",progress:n.progress??0,steps:a,dismissible:n.dismissible??!1,startedAt:Date.now(),displayMode:n.displayMode??"dialog"}})},update:n=>{const a=t().process;a&&s({process:{...a,...n}})},setMessage:n=>{const a=t().process;a&&s({process:{...a,message:n}})},setProgress:n=>{const a=t().process;a&&s({process:{...a,progress:n}})},setStepStatus:(n,a)=>{const r=t().process;if(!r||!r.steps)return;const o=r.steps.map(i=>i.id===n?{...i,status:a}:i);s({process:{...r,steps:o}})},succeed:n=>{const a=t().process;a&&s({process:{...a,message:n??a.message,status:"success",progress:100,endedAt:Date.now()}})},fail:n=>{const a=t().process;a&&s({process:{...a,message:n??a.message,status:"error",endedAt:Date.now()}})},hide:()=>s({visible:!1,process:null})})),$0=()=>{const{visible:s,process:t}=O0(),n=s&&!!t;if(!n||!t)return null;const{title:a,message:r,progress:o,steps:i,status:l,dismissible:c,displayMode:d}=t,u=()=>l==="success"?e.jsx(Gn,{className:"w-5 h-5 text-green-500"}):l==="error"?e.jsx(Ss,{className:"w-5 h-5 text-red-500"}):e.jsx(ot,{className:"w-5 h-5 animate-spin"});if(d==="fullscreen"){const m=Se().ui?.globalProcess?.branding;return e.jsxs("div",{"aria-live":"polite","aria-busy":l==="running",role:"dialog",className:"fixed inset-0 z-50 bg-background select-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",children:[m?.enabled&&e.jsx("div",{className:"absolute top-6 left-6 text-sm text-muted-foreground",children:m.brandName}),e.jsx("div",{className:"h-full w-full flex items-center justify-center p-6",children:e.jsxs("div",{className:"w-full max-w-md space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{}),e.jsx("h2",{className:"text-lg font-semibold",children:a})]}),r&&e.jsx("p",{className:"text-muted-foreground text-sm",children:r}),e.jsx(yn,{value:o}),i&&i.length>0&&e.jsx("div",{className:"space-y-2",children:i.map(p=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[p.status==="success"?e.jsx(Gn,{className:"w-4 h-4 text-green-500"}):p.status==="error"?e.jsx(Ss,{className:"w-4 h-4 text-red-500"}):e.jsx(ot,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{className:"text-foreground/90",children:p.title})]},p.id))})]})})]})}return e.jsx(gt,{open:n,children:e.jsxs(pt,{showCloseButton:!!c,className:"sm:max-w-md select-none",children:[e.jsxs(hs,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{}),e.jsx(ms,{children:a})]}),r&&e.jsx(Dn,{children:r})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(yn,{value:o}),i&&i.length>0&&e.jsx("div",{className:"space-y-2",children:i.map(m=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[m.status==="success"?e.jsx(Gn,{className:"w-4 h-4 text-green-500"}):m.status==="error"?e.jsx(Ss,{className:"w-4 h-4 text-red-500"}):e.jsx(ot,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{className:"text-foreground/90",children:m.title})]},m.id))})]})]})})};function U0(){we.show({title:"è®¿å®¢æ¨¡å¼æç¤º",description:"ä½ å½“å‰åœ¨ä½¿ç”¨æœ¬åœ°æ•°æ®é›†",showFooter:!1,className:"w-full max-w-[520px]",content:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-foreground",children:"ä½ çš„æ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºï¼ˆä¸ä¼šäº‘åŒæ­¥ï¼Œæ¢è®¾å¤‡ä¸å¯è§ï¼‰ã€‚ç™»å½•åŽå¯å¯ç”¨äº‘åŒæ­¥ä¸Žå‘å¸ƒèƒ½åŠ›ã€‚"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(k,{variant:"ghost",className:"h-8 px-3 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200",onClick:()=>{we.close(),ns({title:"ç™»å½•ä»¥å¯ç”¨äº‘ç«¯èƒ½åŠ›",description:"ç™»å½•åŽå¯äº‘åŒæ­¥ã€å‘å¸ƒç©ºé—´ï¼Œå¹¶åœ¨å¤šè®¾å¤‡è®¿é—®ä½ çš„æ•°æ®ã€‚"})},children:"åŽ»ç™»å½•"}),e.jsx(k,{variant:"ghost",className:"h-8 px-3 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200",onClick:()=>we.close(),children:"æˆ‘çŸ¥é“äº†"})]})]})})}function z0(){const s=Go(),t=$e(n=>n.currentUser);return h.useEffect(()=>{t||s.pathname.startsWith("/space/")||(we.close(),pa()?U0():ns({title:"ç™»å½•æˆ–æœ¬åœ°ä½“éªŒ",description:"ç™»å½•åŽå¯äº‘åŒæ­¥ã€å‘å¸ƒç©ºé—´ï¼›ä¹Ÿå¯ä»¥å…ˆç”¨æœ¬åœ°æ¨¡å¼ä½“éªŒã€‚",allowGuest:!0}))},[s.pathname,t]),null}const F0=()=>{const{currentBreakpoint:s}=ai(),{user:t}=vi(),n=h.useRef(Date.now()),a=W(r=>r.setAuth);return h.useEffect(()=>{a(t)},[t,a]),h.useEffect(()=>{const r=s==="sm"?va.MOBILE:va.DESKTOP;return Ne.logAppStart(r,"1.0.0"),()=>{const o=Date.now()-n.current;Ne.logAppClose(o)}},[s]),e.jsxs(e.Fragment,{children:[e.jsx(z0,{}),e.jsx($0,{}),s==="sm"?e.jsx(P0,{}):e.jsx(Jx,{}),e.jsx(lh,{}),e.jsx(mh,{}),e.jsx(ch,{}),e.jsx(dh,{})]})};class B0{auth;constructor(t){const n=new Yu({tokenRequestMethod:"url",httpClient:{fetch:async(a,r)=>{if(a.includes("github.com/login/oauth/access_token")){const o=`https://proxy.agentverse.cc/?${a}`;return fetch(o,r)}return fetch(a,r)}}});this.auth=new Xu(n,{clientId:t.clientId,clientSecret:t.clientSecret,redirectUri:t.redirectUri,scopes:t.scopes||["repo","user"]})}async startAuth(){const t=Ju(32);return sessionStorage.setItem("github_auth_state",t),await this.auth.startAuth({state:t})}async handleCallback(t){const{code:n,state:a,error:r}=Qu(t);if(console.log("[GitHubAuthService][handleCallback] code",{code:n,url:t}),r)throw new Error(`GitHub authentication failed: ${r}`);if(!n)throw new Error("Authorization code not received");const o=sessionStorage.getItem("github_auth_state");if(!o||a!==o)throw new Error("State parameter validation failed, possible CSRF attack");try{const i=await this.auth.handleCallback(n,a);return console.log("[GitHubAuthService][handleCallback] result",i),sessionStorage.removeItem("github_auth_state"),this.saveAuthResult(i),i}catch(i){throw new Error(`Failed to handle authentication callback: ${i instanceof Error?i.message:"Unknown error"}`)}}getAuthStatus(){const t=localStorage.getItem("github_auth");if(!t)return null;try{const n=JSON.parse(t),a=Date.now(),r=n.createdAt+n.expiresIn*1e3;return a>=r?(this.clearAuth(),null):n}catch{return this.clearAuth(),null}}isAuthenticated(){return this.getAuthStatus()!==null}getAccessToken(){return this.getAuthStatus()?.accessToken||null}getUserInfo(){return this.getAuthStatus()?.user||null}logout(){this.clearAuth()}saveAuthResult(t){localStorage.setItem("github_auth",JSON.stringify(t))}clearAuth(){localStorage.removeItem("github_auth"),sessionStorage.removeItem("github_auth_state")}}function H0(s){new B0({...s})}const ks={oauth:{clientId:"Ov23liDcQnnEXXktUGbS",clientSecret:"841c1b9d65c056d80110162472a330d7cd1673af",redirectUri:"http://localhost:5173/",scopes:["repo","user","workflow"]},storage:{defaultBranch:"main",basePath:"data"},api:{baseUrl:"https://api.github.com",timeout:3e4},features:{autoSync:!0,conflictResolution:!0,backupEnabled:!0}};try{ks.oauth.clientId&&(H0({clientId:ks.oauth.clientId,clientSecret:ks.oauth.clientSecret,redirectUri:ks.oauth.redirectUri,scopes:ks.oauth.scopes}),console.log("âœ… GitHubè®¤è¯æœåŠ¡åˆå§‹åŒ–æˆåŠŸ"))}catch(s){console.warn("âš ï¸ GitHubè®¤è¯æœåŠ¡åˆå§‹åŒ–å¤±è´¥:",s)}Ol.createRoot(document.getElementById("root")).render(e.jsx(h.StrictMode,{children:e.jsx(wn,{children:e.jsx(th,{children:e.jsx(oh,{children:e.jsx(rh,{children:e.jsx(qd,{children:e.jsx(F0,{})})})})})})}));
