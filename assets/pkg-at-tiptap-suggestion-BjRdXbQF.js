import{d as L,P as z,aa as G,ab as H}from"./editor-CPE0OFX2.js";import{B as J}from"./pkg-at-tiptap-core-CbjUX6lY.js";function Q(p){var c;const{char:w,allowSpaces:b,allowToIncludeChar:P,allowedPrefixes:_,startOfLine:k,$position:m}=p,B=b&&!P,x=J(w),F=new RegExp(`\\s${x}$`),y=k?"^":"",D=P?"":x,M=B?new RegExp(`${y}${x}.*?(?=\\s${D}|$)`,"gm"):new RegExp(`${y}(?:^)?${x}[^\\s${D}]*`,"gm"),h=((c=m.nodeBefore)==null?void 0:c.isText)&&m.nodeBefore.text;if(!h)return null;const K=m.pos-h.length,a=Array.from(h.matchAll(M)).pop();if(!a||a.input===void 0||a.index===void 0)return null;const e=a.input.slice(Math.max(0,a.index-1),a.index),O=new RegExp(`^[${_?.join("")}\0]?$`).test(e);if(_!==null&&!O)return null;const S=K+a.index;let v=S+a[0].length;return B&&F.test(h.slice(v-1,v+1))&&(a[0]+=" ",v+=1),S<m.pos&&v>=m.pos?{range:{from:S,to:v},query:a[0].slice(w.length),text:a[0]}:null}var V=new L("suggestion");function W({pluginKey:p=V,editor:c,char:w="@",allowSpaces:b=!1,allowToIncludeChar:P=!1,allowedPrefixes:_=[" "],startOfLine:k=!1,decorationTag:m="span",decorationClass:B="suggestion",decorationContent:x="",decorationEmptyClass:F="is-empty",command:y=()=>null,items:D=()=>[],render:M=()=>({}),allow:h=()=>!0,findSuggestionMatch:K=Q}){let a;const e=M?.(),O=()=>{const n=c.state.selection.$anchor.pos,l=c.view.coordsAtPos(n),{top:r,right:s,bottom:o,left:i}=l;try{return new DOMRect(i,r,s-i,o-r)}catch{return null}},S=(n,l)=>l?()=>{const r=p.getState(c.state),s=r?.decorationId,o=n.dom.querySelector(`[data-decoration-id="${s}"]`);return o?.getBoundingClientRect()||null}:O;function v(n,l){var r;try{const o=p.getState(n.state),i=o?.decorationId?n.dom.querySelector(`[data-decoration-id="${o.decorationId}"]`):null,u={editor:c,range:o?.range||{from:0,to:0},query:o?.query||null,text:o?.text||null,items:[],command:f=>y({editor:c,range:o?.range||{from:0,to:0},props:f}),decorationNode:i,clientRect:S(n,i)};(r=e?.onExit)==null||r.call(e,u)}catch{}const s=n.state.tr.setMeta(l,{exit:!0});n.dispatch(s)}const N=new z({key:p,view(){return{update:async(n,l)=>{var r,s,o,i,u,f,q;const t=(r=this.key)==null?void 0:r.getState(l),g=(s=this.key)==null?void 0:s.getState(n.state),d=t.active&&g.active&&t.range.from!==g.range.from,E=!t.active&&g.active,C=t.active&&!g.active,I=!E&&!C&&t.query!==g.query,R=E||d&&I,A=I||d,j=C||d&&I;if(!R&&!A&&!j)return;const $=j&&!R?t:g,T=n.dom.querySelector(`[data-decoration-id="${$.decorationId}"]`);a={editor:c,range:$.range,query:$.query,text:$.text,items:[],command:U=>y({editor:c,range:$.range,props:U}),decorationNode:T,clientRect:S(n,T)},R&&((o=e?.onBeforeStart)==null||o.call(e,a)),A&&((i=e?.onBeforeUpdate)==null||i.call(e,a)),(A||R)&&(a.items=await D({editor:c,query:$.query})),j&&((u=e?.onExit)==null||u.call(e,a)),A&&((f=e?.onUpdate)==null||f.call(e,a)),R&&((q=e?.onStart)==null||q.call(e,a))},destroy:()=>{var n;a&&((n=e?.onExit)==null||n.call(e,a))}}},state:{init(){return{active:!1,range:{from:0,to:0},query:null,text:null,composing:!1}},apply(n,l,r,s){const{isEditable:o}=c,{composing:i}=c.view,{selection:u}=n,{empty:f,from:q}=u,t={...l},g=n.getMeta(p);if(g&&g.exit)return t.active=!1,t.decorationId=null,t.range={from:0,to:0},t.query=null,t.text=null,t;if(t.composing=i,o&&(f||c.view.composing)){(q<l.range.from||q>l.range.to)&&!i&&!l.composing&&(t.active=!1);const d=K({char:w,allowSpaces:b,allowToIncludeChar:P,allowedPrefixes:_,startOfLine:k,$position:u.$from}),E=`id_${Math.floor(Math.random()*4294967295)}`;d&&h({editor:c,state:s,range:d.range,isActive:l.active})?(t.active=!0,t.decorationId=l.decorationId?l.decorationId:E,t.range=d.range,t.query=d.query,t.text=d.text):t.active=!1}else t.active=!1;return t.active||(t.decorationId=null,t.range={from:0,to:0},t.query=null,t.text=null),t}},props:{handleKeyDown(n,l){var r,s,o,i;const{active:u,range:f}=N.getState(n.state);if(!u)return!1;if(l.key==="Escape"||l.key==="Esc"){const t=N.getState(n.state),g=(r=a?.decorationNode)!=null?r:null,d=g??(t?.decorationId?n.dom.querySelector(`[data-decoration-id="${t.decorationId}"]`):null);if(((s=e?.onKeyDown)==null?void 0:s.call(e,{view:n,event:l,range:t.range}))||!1)return!0;const C={editor:c,range:t.range,query:t.query,text:t.text,items:[],command:I=>y({editor:c,range:t.range,props:I}),decorationNode:d,clientRect:d?()=>d.getBoundingClientRect()||null:null};return(o=e?.onExit)==null||o.call(e,C),v(n,p),!0}return((i=e?.onKeyDown)==null?void 0:i.call(e,{view:n,event:l,range:f}))||!1},decorations(n){const{active:l,range:r,decorationId:s,query:o}=N.getState(n);if(!l)return null;const i=!o?.length,u=[B];return i&&u.push(F),G.create(n.doc,[H.inline(r.from,r.to,{nodeName:m,class:u.join(" "),"data-decoration-id":s,"data-decoration-content":x})])}}});return N}var Z=W;export{Z as i};
