const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/pkg-mermaid-2J7i20Jj.js","assets/pkg-at-mermaid-js-parser-FFOaRQbu.js","assets/pkg-langium-k-diuD5f.js","assets/pkg-vscode-jsonrpc-CNa_m3dn.js","assets/pkg-chevrotain-CEPHk4zS.js","assets/pkg-at-chevrotain-utils-DXqYm0RC.js","assets/pkg-at-chevrotain-gast-CM_WTRiP.js","assets/lodash-C0JF0MaN.js","assets/pkg-at-chevrotain-regexp-to-ast-CeRRmUFy.js","assets/pkg-chevrotain-allstar-CSJ5eIgA.js","assets/pkg-vscode-languageserver-types-NoPvPymt.js","assets/pkg-vscode-languageserver-textdocument-CKBVUiR3.js","assets/pkg-vscode-uri-BBKMTmn0.js","assets/pkg-ts-dedent-DrFu-skq.js","assets/pkg-d3-transition-Bm45eg7o.js","assets/pkg-d3-timer-DdKHrDhs.js","assets/pkg-d3-dispatch-kxCwF96_.js","assets/pkg-d3-interpolate-CBh3lkVs.js","assets/pkg-d3-color-amxIadob.js","assets/pkg-d3-selection-Bj1BqfTz.js","assets/pkg-d3-ease-DRPgKoYJ.js","assets/pkg-d3-zoom-D9tDBzqk.js","assets/pkg-dompurify-CGs5VtEq.js","assets/pkg-stylis-D5iaQeiq.js","assets/pkg-dagre-d3-es-CvYYlzoE.js","assets/pkg-cytoscape-DtBltrT8.js","assets/pkg-cytoscape-cose-bilkent-C9QuRRRD.js","assets/pkg-at-braintree-sanitize-url-DFOppRqi.js","assets/pkg-cose-base-pzx1KLkZ.js","assets/pkg-layout-base-DINsLxBG.js","assets/pkg-khroma-DUX6PT6k.js","assets/pkg-dayjs-CVSRrfvc.js","assets/pkg-d3-scale-BZwn9nFs.js","assets/pkg-internmap-BkD7Hj8s.js","assets/pkg-d3-array-DzV2ZBVv.js","assets/pkg-d3-format-CzD4bSOQ.js","assets/pkg-d3-time-format-D0g1J26-.js","assets/pkg-d3-time-BJXYiI7q.js","assets/pkg-d3-axis-DSWTncID.js","assets/pkg-d3-shape-B1-Efro7.js","assets/pkg-d3-path-Bai4oqrp.js","assets/pkg-roughjs-CycZv-lV.js","assets/pkg-uuid-BKrj-4V8.js","assets/pkg-d3-sankey-CL8iXfid.js","assets/pkg-d3-scale-chromatic-CvOaoHrI.js","assets/pkg-at-iconify-utils-D2F_yRRF.js","assets/pkg-marked-4Gk_dWmY.js","assets/pkg-cytoscape-fcose-DSsTzDQ2.js","assets/pkg-d3-hierarchy-CvYzv8kf.js","assets/pkg-react-syntax-highlighter-D_Ci07Lc.js","assets/react-vendor-oUiNwJXW.js","assets/pkg-scheduler-Bb8JjhAW.js","assets/pkg-refractor-Ch9JKb1r.js","assets/pkg-hastscript-VmKaH6iJ.js","assets/pkg-property-information-CFHPdWQf.js","assets/pkg-xtend-VQg9yHl6.js","assets/pkg-hast-util-parse-selector-CLnxzGsj.js","assets/pkg-space-separated-tokens-CF7pUylw.js","assets/pkg-comma-separated-tokens-BQxVigOH.js","assets/pkg-parse-entities-xsQacvMO.js","assets/pkg-character-entities-legacy-BSd6ekHp.js","assets/pkg-character-reference-invalid-AKrgFUtc.js","assets/pkg-is-decimal-Bg2oiju0.js","assets/pkg-is-hexadecimal-yh8m6GRc.js","assets/pkg-is-alphanumerical-DYCKc-AM.js","assets/pkg-is-alphabetical-BQ1fjZEF.js","assets/pkg-prismjs-roPZ7vEp.js","assets/pkg-at-babel-runtime-BlVrb8V_.js"])))=>i.map(i=>d[i]);
import{r as h,j as e,R as st,e as Vr}from"./react-vendor-oUiNwJXW.js";import{S as un,a as hn,C as mn,b as gn,P as pn,O as xn,T as qr,D as Wr,c as Kr,d as Yr,e as Xr,R as Jr,I as Qr,F as Zr,f as eo,g as to,h as so,i as ao,j as no,k as ro,l as oo,m as io,n as lo,o as co,A as uo,p as ho,q as mo,r as go,s as po,t as xo,L as fo,u as bo,v as vo,G as yo,w as wo,x as jo}from"./radix-CcDHHQBz.js";import{t as No,c as Co,a as aa}from"./ui-utils-CjxovF-h.js";import{g as Z,h as fn,i as _t,j as it,k as as,W as ko,l as bn,m as vn,n as yn,o as ns,I as wn,p as So,q as Io,r as jn,s as Os,t as Mo,u as Eo,E as na,v as ps,w as Nn,x as we,y as Pt,z as Cn,D as To,F as Ue,G as Ao,P as ae,H as Lo,J as ra,K as Ro,N as Do,O as xs,Q as Fe,V as kn,Y as Sn,Z as _o,_ as Po,$ as Oo,a0 as Ee,a1 as Ce,a2 as $o,a3 as Uo,a4 as oa,a5 as ia,a6 as Fo,a7 as rs,a8 as zo,a9 as Bo,aa as lt,ab as Ho,ac as Go,ad as et,ae as Vo,af as Te,ag as os,ah as qo,ai as Wo,aj as Ko,ak as la,al as ze,am as Ot,an as Yo,ao as Ms,ap as Es,aq as Ts,ar as qt,as as In,at as $s,au as $t,av as is,aw as ja,ax as It,ay as ca,az as Xo,aA as Jo,aB as Qo,aC as Zo,aD as ei,aE as ti,aF as si,aG as Us,aH as ai,aI as ni,aJ as ri,aK as oi,aL as ii,aM as li,aN as As,aO as Mn,aP as En,aQ as ci,aR as di,aS as ui}from"./icons-CjMauG4q.js";import{i as hi,s as mi,l as gi,a as pi}from"./pkg-at-firebase-analytics-BMLfws2Q.js";import"./firebase-D_zC2MhX.js";import{i as xi,c as fi,g as bi,b as vi,o as yi,s as gt,a as wi,d as Na,e as pt,f as Ca,u as Ls,G as ji,h as Ni}from"./pkg-at-firebase-auth-DfkLc4it.js";import{i as Ci}from"./pkg-at-firebase-app-B-jb69A0.js";import"./pkg-at-firebase-logger-CNz1B4Yj.js";import{i as ki,c as le,g as te,q as Q,w as z,o as ie,a as yt,l as Qe,b as ka,d as q,u as ee,s as X,e as Fs,f as Wt,h as Kt,T as Si,j as Ii,k as Je,m as Yt,n as Mi,p as Ei}from"./pkg-at-firebase-firestore-Dn_XiGxb.js";import{c as de,p as ct}from"./pkg-zustand-B13jvSHf.js";import{S as Ti,B as _e,R as Tn,d as fs,f as bs,s as An,o as Ai,c as Ln,m as qe,t as Li,w as Ri,a as Di,b as _i,e as Rn,O as zs,g as Pi,h as wt,i as Oi,j as Bs}from"./rxjs-BbPesVBQ.js";import{v as Dn}from"./pkg-uuid-BKrj-4V8.js";import{t as Ie,T as $i}from"./pkg-sonner-Cj0YiWO0.js";import{u as Ui,a as Fi,R as _n,b as Pn,N as On,H as zi}from"./pkg-react-router-DVb0qvGM.js";import{E as Bi,d as $n,D as Pe}from"./pkg-at-cardos-extension-BMuxnzIh.js";import{A as Ge}from"./pkg-composite-kit-tPYGb2sN.js";import{E as Hi,a as Gi,S as Vi,T as Sa}from"./pkg-emoji-picker-react-DVnBGjBe.js";import{P as qi,a as Wi,b as Ki}from"./pkg-react-resizable-panels-Dcz_UWfb.js";import{O as Un}from"./ai-sdk-Cs_ets_2.js";import{d as Yi,i as Xi,a as Ji,f as Hs}from"./pkg-date-fns-iJ11a159.js";import{T as ue,E as pe,u as Qi,a as Zi,b as el,A as tl}from"./agent-chat-CMDgzPSY.js";import{M as sl,r as al,a as nl,b as rl}from"./markdown-DNcxNCP-.js";import{u as ls}from"./pkg-ahooks-C6kCsxuL.js";import{$ as ol}from"./lodash-C0JF0MaN.js";import{_ as F}from"./pkg-at-mermaid-js-parser-FFOaRQbu.js";import{S as Fn,v as il,o as ll}from"./pkg-react-syntax-highlighter-D_Ci07Lc.js";import{G as cl,a as dl,g as ul,p as hl}from"./pkg-at-dimstack-git-auth-HYuP_LUZ.js";import"./pkg-at-braintree-sanitize-url-DFOppRqi.js";import"./pkg-scheduler-Bb8JjhAW.js";import"./pkg-react-remove-scroll-B7pFWHa3.js";import"./pkg-tslib-NCTAzukp.js";import"./pkg-react-remove-scroll-bar-DdUfnHNq.js";import"./pkg-react-style-singleton-D3MLhYSm.js";import"./pkg-get-nonce-C-Z93AgS.js";import"./pkg-use-sidecar-BnsZ5Zf2.js";import"./pkg-use-callback-ref-cFmKBFWa.js";import"./pkg-aria-hidden-DvXkyWUv.js";import"./pkg-use-sync-external-store-CUEmIM_2.js";import"./pkg-at-floating-ui-react-dom-BY_aGZ9K.js";import"./pkg-at-floating-ui-dom-CFTGs4ej.js";import"./pkg-at-floating-ui-core-BQBd5mEs.js";import"./pkg-at-floating-ui-utils-ye2j5HVc.js";import"./pkg-at-firebase-util-DEf2dHJc.js";import"./pkg-at-firebase-component-uLb4jufn.js";import"./pkg-at-firebase-installations-BMfcZu_0.js";import"./pkg-idb-BXWtuYvb.js";import"./pkg-at-firebase-webchannel-wrapper-QS5lB7L3.js";import"./pkg-flairup-CpvKgcza.js";import"./pkg-devlop-Cl3hj7Sz.js";import"./pkg-unified-DkoGxGPE.js";import"./pkg-bail-FqpXQuLt.js";import"./pkg-extend-gYfrUz6q.js";import"./pkg-is-plain-obj-C1gvLhAf.js";import"./pkg-trough-B_b8ryxu.js";import"./pkg-vfile-C9sMpkI_.js";import"./pkg-vfile-message-9l3O2Txd.js";import"./pkg-unist-util-stringify-position-Ch_qCilz.js";import"./pkg-remark-parse-BeO-KmVJ.js";import"./pkg-mdast-util-from-markdown-BmEQKP9C.js";import"./pkg-micromark-util-decode-numeric-character-reference-CNs1qBpV.js";import"./pkg-micromark-util-decode-string-CN12p1QQ.js";import"./pkg-decode-named-character-reference-C3-224fz.js";import"./pkg-micromark-util-normalize-identifier-C9ANKk3v.js";import"./pkg-micromark-D5KhfieM.js";import"./pkg-micromark-util-combine-extensions-Do2pbDSt.js";import"./pkg-micromark-util-chunked-DrRIdSP-.js";import"./pkg-micromark-factory-space-BZOpXu4z.js";import"./pkg-micromark-util-character-Cn8n62xE.js";import"./pkg-micromark-core-commonmark-CqZ3B5v2.js";import"./pkg-micromark-util-classify-character-CcNqx0ik.js";import"./pkg-micromark-util-resolve-all-PQCKh0dx.js";import"./pkg-micromark-util-subtokenize-Rnufg-uS.js";import"./pkg-micromark-factory-destination-BpBlAxuG.js";import"./pkg-micromark-factory-label-DyndCtq7.js";import"./pkg-micromark-factory-title--3sarO0x.js";import"./pkg-micromark-factory-whitespace-BFbQeeHj.js";import"./pkg-micromark-util-html-tag-name-DbKNfynz.js";import"./pkg-mdast-util-to-string-C_aolqmU.js";import"./pkg-remark-rehype-DqkJKlgj.js";import"./pkg-mdast-util-to-hast-DlZh3eKX.js";import"./pkg-at-ungap-structured-clone--gfxRhYI.js";import"./pkg-micromark-util-sanitize-uri-Bcy1OjTd.js";import"./pkg-unist-util-position-60F3QETU.js";import"./pkg-trim-lines-D8znQY54.js";import"./pkg-unist-util-visit-Ddo8Kubz.js";import"./pkg-unist-util-visit-parents-BcSs7PJp.js";import"./pkg-unist-util-is-BPZGFiMU.js";import"./pkg-hast-util-to-jsx-runtime-cC1HIdZ6.js";import"./pkg-comma-separated-tokens-BQxVigOH.js";import"./pkg-property-information-CFHPdWQf.js";import"./pkg-xtend-VQg9yHl6.js";import"./pkg-space-separated-tokens-CF7pUylw.js";import"./pkg-style-to-js-CEKVR7hG.js";import"./pkg-style-to-object-BBLxsZ82.js";import"./pkg-inline-style-parser-D4u_cg7q.js";import"./pkg-hast-util-whitespace-D4Wp6AEg.js";import"./pkg-estree-util-is-identifier-name-BgBfM8ME.js";import"./pkg-html-url-attributes-D46m5wfe.js";import"./pkg-micromark-extension-gfm-B0DctPzH.js";import"./pkg-micromark-extension-gfm-autolink-literal-DBUxU-6S.js";import"./pkg-micromark-extension-gfm-footnote-DBQxKibT.js";import"./pkg-micromark-extension-gfm-strikethrough-DP_nekd2.js";import"./pkg-micromark-extension-gfm-table-BwEzuKcM.js";import"./pkg-micromark-extension-gfm-task-list-item-Bh-RsFa-.js";import"./pkg-mdast-util-gfm-aIzNSdlS.js";import"./pkg-mdast-util-gfm-autolink-literal-Dncmbeag.js";import"./pkg-ccount-c2V3InAJ.js";import"./pkg-mdast-util-find-and-replace-DRnaru6o.js";import"./pkg-escape-string-regexp-BaJN9MlJ.js";import"./pkg-mdast-util-gfm-footnote-Fj4BtPn2.js";import"./pkg-mdast-util-gfm-strikethrough-Cj9qKt6Q.js";import"./pkg-mdast-util-gfm-table-DuQMzM81.js";import"./pkg-markdown-table-DvhhVmnL.js";import"./pkg-mdast-util-to-markdown-Dub4U_X5.js";import"./pkg-longest-streak-CtXnX3Xp.js";import"./pkg-mdast-util-phrasing-CAX20Uul.js";import"./pkg-mdast-util-gfm-task-list-item-DwxNh12H.js";import"./pkg-micromark-extension-math-mrCcKm4A.js";import"./pkg-mdast-util-math-xlj7Pg1K.js";import"./pkg-hast-util-from-html-isomorphic-Dm2lD_eS.js";import"./pkg-hast-util-from-dom-Bra3Ahul.js";import"./pkg-web-namespaces-Cmx0dTen.js";import"./pkg-hastscript-VmKaH6iJ.js";import"./pkg-hast-util-parse-selector-CLnxzGsj.js";import"./pkg-hast-util-to-text-CFD99NF2.js";import"./pkg-hast-util-is-element-CuOmiqQi.js";import"./pkg-unist-util-find-after-DkOernp_.js";import"./pkg-dayjs-CVSRrfvc.js";import"./pkg-langium-k-diuD5f.js";import"./pkg-vscode-jsonrpc-CNa_m3dn.js";import"./pkg-chevrotain-CEPHk4zS.js";import"./pkg-at-chevrotain-utils-DXqYm0RC.js";import"./pkg-at-chevrotain-gast-CM_WTRiP.js";import"./pkg-at-chevrotain-regexp-to-ast-CeRRmUFy.js";import"./pkg-chevrotain-allstar-CSJ5eIgA.js";import"./pkg-vscode-languageserver-types-NoPvPymt.js";import"./pkg-vscode-languageserver-textdocument-CKBVUiR3.js";import"./pkg-vscode-uri-BBKMTmn0.js";import"./pkg-refractor-Ch9JKb1r.js";import"./pkg-parse-entities-xsQacvMO.js";import"./pkg-character-entities-legacy-BSd6ekHp.js";import"./pkg-character-reference-invalid-AKrgFUtc.js";import"./pkg-is-decimal-Bg2oiju0.js";import"./pkg-is-hexadecimal-yh8m6GRc.js";import"./pkg-is-alphanumerical-DYCKc-AM.js";import"./pkg-is-alphabetical-BQ1fjZEF.js";import"./pkg-prismjs-roPZ7vEp.js";import"./pkg-at-babel-runtime-BlVrb8V_.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function a(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=a(r);fetch(r.href,o)}})();const zt={md:768,lg:1024,xl:1280,"2xl":1536},vs=()=>{if(typeof window>"u")return"sm";const s=window.innerWidth;return s>=zt["2xl"]?"2xl":s>=zt.xl?"xl":s>=zt.lg?"lg":s>=zt.md?"md":"sm"},zn=()=>{const s=vs();return s==="sm"||s==="md"},ml=()=>vs()==="lg",gl=()=>{const s=vs();return s==="xl"||s==="2xl"},Bn=h.createContext(void 0);function pl({children:s}){const[t,a]=h.useState("sm");h.useEffect(()=>{const r=()=>{a(vs())};return r(),window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[]);const n={currentBreakpoint:t,isMobile:zn(),isTablet:ml(),isDesktop:gl()};return e.jsx(Bn.Provider,{value:n,children:s})}function xl(){const s=h.useContext(Bn);if(s===void 0)throw new Error("useBreakpoint must be used within a BreakpointProvider");return s}function j(...s){return No(Co(s))}const fl=aa("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function N({className:s,variant:t,size:a,asChild:n=!1,...r}){const o=n?un:"button";return e.jsx(o,{"data-slot":"button",className:j(fl({variant:t,size:a,className:s})),...r})}function Be({...s}){return e.jsx(hn,{"data-slot":"dialog",...s})}function Hn({...s}){return e.jsx(Kr,{"data-slot":"dialog-trigger",...s})}function bl({...s}){return e.jsx(pn,{"data-slot":"dialog-portal",...s})}function Gn({className:s,...t}){return e.jsx(xn,{"data-slot":"dialog-overlay",className:j("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",s),...t})}function He({className:s,children:t,showCloseButton:a=!0,...n}){return e.jsxs(bl,{"data-slot":"dialog-portal",children:[e.jsx(Gn,{}),e.jsxs(mn,{"data-slot":"dialog-content",className:j("bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",s),...n,children:[t,a&&e.jsxs(gn,{"data-slot":"dialog-close",className:"data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",children:[e.jsx(Z,{}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]})}function ys({className:s,...t}){return e.jsx("div",{"data-slot":"dialog-header",className:j("flex flex-col gap-2 text-center sm:text-left",s),...t})}function da({className:s,...t}){return e.jsx("div",{"data-slot":"dialog-footer",className:j("flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",s),...t})}function ws({className:s,...t}){return e.jsx(qr,{"data-slot":"dialog-title",className:j("text-lg leading-none font-semibold",s),...t})}function ua({className:s,...t}){return e.jsx(Wr,{"data-slot":"dialog-description",className:j("text-muted-foreground text-sm",s),...t})}const vl=h.createContext(null);function yl({children:s}){const[t,a]=h.useState({isOpen:!1,options:{}}),n=h.useCallback(()=>{a(c=>(c.options.afterClose?.(),{...c,isOpen:!1}))},[]),r=h.useCallback(c=>{a({isOpen:!0,options:c})},[]),o=h.useCallback(c=>{r({...c,okText:c.okText??"Confirm",cancelText:c.cancelText??"Cancel"})},[r]),i=async()=>{try{await t.options.onOk?.(),a(c=>(c.options.afterClose?.(),{...c,isOpen:!1}))}catch(c){console.error("Modal onOk error:",c)}},l=()=>{t.options.onCancel?.(),a(c=>(c.options.afterClose?.(),{...c,isOpen:!1}))};return e.jsxs(vl.Provider,{value:{show:r,confirm:o,close:n},children:[s,e.jsx(Be,{open:t.isOpen,onOpenChange:c=>!c&&l(),children:e.jsxs(He,{className:j(t.options.className),children:[t.options.title&&e.jsxs(ys,{children:[e.jsx(ws,{children:t.options.title}),t.options.description&&e.jsx(ua,{children:t.options.description})]}),t.options.content,t.options.showFooter!==!1&&e.jsxs(da,{children:[e.jsx(N,{variant:"outline",onClick:l,children:t.options.cancelText??"Cancel"}),e.jsx(N,{onClick:i,children:t.options.okText??"Confirm"})]})]})})]})}const Vn=h.createContext(null),Ia="app-theme";function Ma(){return window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function wl({children:s}){const[t,a]=h.useState(()=>typeof window>"u"?"system":localStorage.getItem(Ia)||"system"),[n,r]=h.useState(typeof window>"u"?"light":Ma());h.useEffect(()=>{const u=window.matchMedia("(prefers-color-scheme: dark)"),m=x=>{r(x.matches?"dark":"light")};return u.addEventListener("change",m),()=>u.removeEventListener("change",m)},[]);const o=u=>{a(u),localStorage.setItem(Ia,u);const m=window.document.documentElement;if(u==="system"){const x=Ma()==="dark";m.classList.toggle("dark",x)}else m.classList.toggle("dark",u==="dark");m.classList.add("theme-transition"),setTimeout(()=>{m.classList.remove("theme-transition")},300)},i=()=>{o((t==="system"?n:t)==="dark"?"light":"dark")};h.useEffect(()=>{const u=window.document.documentElement,m=t==="system"?n==="dark":t==="dark";u.classList.toggle("dark",m)},[t,n]);const l=t==="system"?n==="dark":t==="dark",c=h.useMemo(()=>j("h-screen w-screen flex flex-col overflow-hidden",l?"bg-gray-900":"bg-gray-50"),[l]),d={theme:t,setTheme:o,isDarkMode:l,toggleDarkMode:i,rootClassName:c};return e.jsx(Vn.Provider,{value:d,children:s})}function jl(){const s=h.useContext(Vn);if(!s)throw new Error("useTheme must be used within a ThemeProvider");return s}const Ea="https://firebase-auth-api.agentverse.cc",Nl="firebase-api.agentverse.cc",qn={apiKey:"AIzaSyAR5kNhhjt2-oJWbbZm_JmyqCT2EkTT60E",authDomain:"echo-note-9fe01.firebaseapp.com",projectId:"echo-note-9fe01",storageBucket:"echo-note-9fe01.firebasestorage.app",messagingSenderId:"339659564131",appId:"1:339659564131:web:2d7e9782ac4423d3384456",measurementId:"G-QS4CHWNFH2"},Wn=Ci(qn),Cl=ki(Wn,{host:Nl,ssl:!0,ignoreUndefinedProperties:!0,experimentalForceLongPolling:!1}),kl=s=>{const t=localStorage.getItem("region");return t||s},Sl=s=>{localStorage.setItem("region",s)},Ta="CN";class Ze{static instance=null;app=Wn;auth=null;analytics=null;db=Cl;region=kl(Ta);constructor(){console.log("[FirebaseConfig] constructor, region",this.region),this.getAuth(),this.validateRegionAndMaybeReloadPage()}static getInstance(){return Ze.instance||(Ze.instance=new Ze),Ze.instance}getApp(){return this.app}isInCNRegion(){return this.region===Ta}supportGoogleAuth(){return!this.isInCNRegion()}async fetchRegion(){let t="";try{const a=await fetch(`${Ea}/api/location`);a.ok&&(t=(await a.json()).country||"XX")}catch(a){console.error("Failed to fetch user country, using restricted auth.",a)}return t}async validateRegionAndMaybeReloadPage(){const t=await this.fetchRegion();Sl(t),t!==this.region&&window.location.reload()}getAuth(){return this.auth||(this.isInCNRegion()?(this.auth=xi(this.getApp(),{persistence:vi}),fi(this.auth,Ea,{disableWarnings:!0})):this.auth=bi(this.getApp())),this.auth}getAnalytics(){return this.analytics?this.analytics:this.isInCNRegion()?(console.log("[FirebaseConfig] In CN region, Analytics is disabled."),null):(console.log("[FirebaseConfig] Initializing Analytics for non-CN region."),qn.measurementId?this.analytics=hi(this.getApp()):console.warn("[FirebaseConfig] measurementId is not provided, Analytics will not be initialized."),this.analytics)}setUserIdForAnalytics(t){this.getAnalytics()&&mi(this.getAnalytics(),t)}getDb(){return this.db}}const U=Ze.getInstance(),ha=()=>({isGoogleAuthSupported:U.supportGoogleAuth(),isInCNRegion:U.isInCNRegion()}),Rs=s=>{const t=s.data();return{id:s.id,name:t.name,description:t.description,emoji:t.emoji,createdAt:t.createdAt?.toDate()||new Date,updatedAt:t.updatedAt?t.updatedAt.toDate():void 0,messageCount:t.messageCount||0,lastMessageTime:t.lastMessageTime?.toDate(),backgroundImage:t.backgroundImage,backgroundColor:t.backgroundColor}},Xe=s=>{const t=s.data();let a;return t.timestamp?t.timestamp instanceof Si||t.timestamp.toDate&&typeof t.timestamp.toDate=="function"?a=t.timestamp.toDate():t.timestamp instanceof Date?a=t.timestamp:(console.warn("Invalid timestamp format in document:",s.id,t.timestamp),a=new Date):(console.warn("Missing timestamp in document:",s.id),a=new Date),{id:s.id,content:t.content,sender:t.sender,channelId:t.channelId,timestamp:a,tags:t.tags,parentId:t.parentId,threadId:t.threadId,isThreadExpanded:t.isThreadExpanded,threadCount:t.threadCount,aiAnalysis:t.aiAnalysis,isDeleted:t.isDeleted||!1,deletedAt:t.deletedAt?t.deletedAt.toDate():void 0,deletedBy:t.deletedBy,canRestore:t.canRestore}},Le=s=>le(U.getDb(),`users/${s}/channels`),je=s=>le(U.getDb(),`users/${s}/messages`);class Il{async getChannel(t,a){try{const n=await Le(t),o=(await te(Q(n,z("isDeleted","==",!1),z("__name__","==",a)))).docs[0];return o?Rs(o):null}catch(n){return console.warn("[firebaseNotesService.getChannel] failed",n),null}}subscribeToChannels=(t,a)=>{console.log("🔔 [firebaseNotesService][subscribeToChannels]:",{userId:t});const n=Q(Le(t),z("isDeleted","==",!1),ie("lastMessageTime","desc"));return yt(n,o=>{const i=o.docs.map(Rs);a(i)},o=>{console.error("Error subscribing to channels:",o)})};subscribeToChannelMessages=(t,a,n,r)=>{console.log("🔔 [firebaseNotesService][subscribeToChannelMessages]:",{userId:t,channelId:a,messagesLimit:n});const o=Q(je(t),z("isDeleted","==",!1),z("channelId","==",a),z("sender","==","user"),ie("timestamp","desc"),Qe(n));return yt(o,l=>{const c=l.docs.map(Xe),d=c.length>=n;r(c,d)},l=>{console.error("Error subscribing to channel messages:",l)})};fetchChannels=async t=>{console.log("🔔 [firebaseNotesService][fetchChannels]:",{userId:t});const a=Q(Le(t),z("isDeleted","==",!1),ie("lastMessageTime","desc"));return(await te(a)).docs.map(Rs)};createChannel=async(t,a)=>{const n=Object.fromEntries(Object.entries(a).filter(([,o])=>o!==void 0));return(await ka(Le(t),{...n,createdAt:X(),updatedAt:X(),messageCount:0,isDeleted:!1,lastMessageTime:X()})).id};updateChannel=async(t,a,n)=>{const r=q(Le(t),a),o={};for(const[i,l]of Object.entries(n))l===void 0?o[i]=Ii():o[i]=l;o.updatedAt=X(),await ee(r,o)};deleteChannel=async(t,a)=>{console.log("🔔 [firebaseNotesService][deleteChannel]:",{userId:t,channelId:a});const n=q(Le(t),a);await ee(n,{isDeleted:!0,deletedAt:X(),deletedBy:t});try{const r=Q(je(t),z("channelId","==",a),z("isDeleted","==",!1)),o=await te(r),i=500;for(let l=0;l<o.docs.length;l+=i){const d=o.docs.slice(l,l+i).map(u=>ee(u.ref,{isDeleted:!0,deletedAt:X(),deletedBy:t,deletedChannelId:a}));await Promise.all(d)}console.log("🔔 [firebaseNotesService][deleteChannel]: Successfully soft deleted channel and messages",{channelId:a,messageCount:o.docs.length})}catch(r){throw console.error("🔔 [firebaseNotesService][deleteChannel]: Error soft deleting messages:",r),new Error(`Channel soft deleted but failed to soft delete associated messages: ${r}`)}};restoreChannel=async(t,a)=>{console.log("🔔 [firebaseNotesService][restoreChannel]:",{userId:t,channelId:a});const n=q(Le(t),a);await ee(n,{isDeleted:!1,deletedAt:null,deletedBy:null});try{const r=Q(je(t),z("channelId","==",a),z("isDeleted","==",!0),z("deletedChannelId","==",a)),o=await te(r),i=500;for(let l=0;l<o.docs.length;l+=i){const d=o.docs.slice(l,l+i).map(u=>ee(u.ref,{isDeleted:!1,deletedAt:null,deletedBy:null,deletedChannelId:null}));await Promise.all(d)}console.log("🔔 [firebaseNotesService][restoreChannel]: Successfully restored channel and messages",{channelId:a,messageCount:o.docs.length})}catch(r){throw console.error("🔔 [firebaseNotesService][restoreChannel]: Error restoring messages:",r),new Error(`Channel restored but failed to restore associated messages: ${r}`)}};fetchInitialMessages=async(t,a,n)=>{console.log("🔔 [firebaseNotesService][fetchInitialMessages]:",{userId:t,channelId:a,messagesLimit:n});const r=Q(je(t),z("isDeleted","==",!1),z("channelId","==",a),z("sender","==","user"),ie("timestamp","desc"),Qe(n)),o=await te(r),i=o.docs.map(Xe),l=o.docs[o.docs.length-1],c=i.length<n;return{messages:i,lastVisible:l,allLoaded:c}};fetchInitialMessagesAllSenders=async(t,a,n)=>{const r=Q(je(t),z("isDeleted","==",!1),z("channelId","==",a),ie("timestamp","desc"),Qe(n));try{const o=await te(r),i=o.docs.map(Xe),l=o.docs[o.docs.length-1],c=i.length<n;return{messages:i,lastVisible:l,allLoaded:c}}catch(o){throw console.error("❌ [firebaseNotesService][fetchInitialMessagesAllSenders] failed",o),o}};fetchMoreMessages=async(t,a,n,r)=>{console.log("🔔 [firebaseNotesService][fetchMoreMessages]:",{userId:t,channelId:a,messagesLimit:n,cursor:r});const o=Q(je(t),z("isDeleted","==",!1),z("channelId","==",a),z("sender","==","user"),ie("timestamp","desc"),Fs(r),Qe(n)),i=await te(o),l=i.docs.map(Xe),c=i.docs[i.docs.length-1],d=l.length<n;return{messages:l,lastVisible:c,allLoaded:d}};subscribeToNewMessages=(t,a,n,r)=>{console.log("🔔 [firebaseNotesService][subscribeToNewMessages]:",{userId:t,channelId:a,afterTimestamp:n});const o=Q(je(t),z("isDeleted","==",!1),z("channelId","==",a),z("sender","==","user"),z("timestamp",">",n),ie("timestamp","desc"));return yt(o,l=>{const c=l.docs.map(Xe);r(c)},l=>{console.error("Error subscribing to new messages:",l)})};createMessage=async(t,a)=>{const n=Object.fromEntries(Object.entries(a).filter(([,i])=>i!==void 0)),r=await ka(je(t),{...n,timestamp:X(),isDeleted:!1}),o=q(Le(t),a.channelId);return await ee(o,{lastMessageTime:X(),messageCount:Wt(1)}),r.id};updateMessage=async(t,a,n)=>{const r=q(U.getDb(),`users/${t}/messages/${a}`);await ee(r,n)};deleteMessage=async(t,a)=>{const n=q(U.getDb(),`users/${t}/messages/${a}`);await Kt(n)};softDeleteMessage=async(t,a)=>{const n=q(U.getDb(),`users/${t}/messages/${a}`);await ee(n,{isDeleted:!0,deletedAt:X(),deletedBy:t})};restoreMessage=async(t,a)=>{const n=q(U.getDb(),`users/${t}/messages/${a}`);await ee(n,{isDeleted:!1,deletedAt:null,deletedBy:null})};getDeletedMessages=async(t,a)=>{console.log("🔔 [firebaseNotesService][getDeletedMessages]:",{userId:t,channelId:a});try{let n=Q(je(t),z("isDeleted","==",!0),ie("deletedAt","desc"));return a&&(n=Q(je(t),z("isDeleted","==",!0),z("channelId","==",a),z("sender","==","user"),ie("deletedAt","desc"))),(await te(n)).docs.map(Xe)}catch(n){return console.error("🔔 [Firebase] [getDeletedMessages]: Error fetching deleted messages:",n),[]}}}const K=new Il,Aa=["💡","📝","📌","📚","🧠","✨","📁","📒","📓","🗂️","🌟","🧩","🗒️","📎","🗳️","🎯"];function Gs(s){const t=Math.floor(Math.random()*Aa.length);return Aa[t]}class Ml{version="1.0.0";name="Add isDeleted field to messages";description="Add isDeleted field to all messages to support soft delete functionality";createdAt=new Date("2025-01-27");async execute(t){const a=U.getDb(),n=le(a,`users/${t}/messages`),r=await te(n);let o=0;for(const i of r.docs)if(i.data().isDeleted===void 0){const c=q(n,i.id);await ee(c,{isDeleted:!1}),o++}o>0?console.log(`   📊 Updated ${o} messages with isDeleted field`):console.log("   ℹ️  No messages needed updating")}}class El{version="1.0.1";name="Add lastMessageTime to channels";description="Add lastMessageTime and messageCount fields to all channels for sorting and statistics";createdAt=new Date("2025-01-27");async execute(t){const a=U.getDb(),n=le(a,`users/${t}/channels`),r=await te(n);let o=0;for(const i of r.docs){const l=i.data();if(!l.lastMessageTime){const c=q(n,i.id),d=Q(le(a,`users/${t}/messages`),z("channelId","==",i.id),ie("timestamp","desc"),Qe(1)),u=await te(d);if(u.empty)await ee(c,{lastMessageTime:l.createdAt||X(),messageCount:0});else{const x=u.docs[0].data().timestamp;await ee(c,{lastMessageTime:x,messageCount:u.size})}o++}}o>0?console.log(`   📊 Updated ${o} channels with lastMessageTime field`):console.log("   ℹ️  No channels needed updating")}}class Tl{version="1.1.0";name="Add isDeleted field to channels";description="Add isDeleted field to all channels to support soft delete functionality";createdAt=new Date("2025-01-27");async execute(t){const a=U.getDb(),n=le(a,`users/${t}/channels`),r=await te(n);let o=0;for(const i of r.docs)if(i.data().isDeleted===void 0){const c=q(n,i.id);await ee(c,{isDeleted:!1}),o++}o>0?console.log(`   📊 Updated ${o} channels with isDeleted field`):console.log("   ℹ️  No channels needed updating")}}class W{static PREFIX="[Migration]";static PREFIX_STATE="[MigrationState]";static PREFIX_EXECUTOR="[MigrationExecutor]";static PREFIX_SERVICE="[MigrationService]";static printHeader(t){console.log(`${this.PREFIX} 🚀 Starting migrations for user: ${t}`)}static printOverview(t,a,n){console.log(`${this.PREFIX} 📊 Status: ${t} total, ${a} completed, ${n} pending`)}static printAllCompleted(t){console.log(`${this.PREFIX} ✅ All migrations completed (${t} skipped)`)}static printPendingMigrations(t){console.log(`${this.PREFIX} 🚀 Pending migrations (${t.length}):`),t.forEach((a,n)=>{console.log(`${this.PREFIX}    ${n+1}. [${a.version}] ${a.name}`)})}static printMigrationStart(t,a,n){console.log(`${this.PREFIX} 🔄 ${t} Executing: ${a} - ${n}`)}static printMigrationComplete(){console.log(`${this.PREFIX}    ✅ Completed`)}static printMigrationFailure(t){const a=t instanceof Error?t.message:String(t);console.log(`${this.PREFIX}    ❌ Failed: ${a}`)}static printExecutionSummary(t,a,n){console.log(`${this.PREFIX} 📈 Summary: ${t} executed, ${a} failed, ${n} skipped`),a===0&&console.log(`${this.PREFIX} 🎉 All migrations completed successfully!`)}static printCriticalError(t){console.error(`${this.PREFIX} 💥 Critical error:`,t)}static printStateInfo(t){console.log(`${this.PREFIX_STATE} ℹ️  ${t}`)}static printStateError(t,a){console.error(`${this.PREFIX_STATE} ❌ ${t}`,a||"")}static printExecutorInfo(t){console.log(`${this.PREFIX_EXECUTOR} ℹ️  ${t}`)}static printExecutorError(t,a){console.error(`${this.PREFIX_EXECUTOR} ❌ ${t}`,a||"")}static printServiceInfo(t){console.log(`${this.PREFIX_SERVICE} ℹ️  ${t}`)}static printServiceError(t,a){console.error(`${this.PREFIX_SERVICE} ❌ ${t}`,a||"")}}const se=()=>({channel:{autoCreateDefault:{enabled:!1},settings:{enabled:!1},input:{emoji:{enabled:!1},image:{enabled:!1},file:{enabled:!1},voice:{enabled:!1},more:{enabled:!1},call:{enabled:!1},video:{enabled:!1}},thoughtRecord:{edit:{enabled:!0},sparks:{enabled:!0},viewDetails:{enabled:!1},bookmark:{enabled:!1},reply:{enabled:!1},tags:{enabled:!0},thread:{enabled:!1}}}});class Al{getMigrationsCollectionRef=t=>le(U.getDb(),`users/${t}/migrations`);async getUserMigrationState(t){try{const a=q(this.getMigrationsCollectionRef(t),"state"),n=await Je(a);if(n.exists()){const r=n.data();return{userId:t,completedMigrations:r.completedMigrations||[],lastMigrationCheck:r.lastMigrationCheck?.toDate()||new Date,version:r.version||"1.0.0"}}return{userId:t,completedMigrations:[],lastMigrationCheck:new Date,version:"1.0.0"}}catch(a){return W.printStateError("Failed to get migration state",a),{userId:t,completedMigrations:[],lastMigrationCheck:new Date,version:"1.0.0"}}}async updateUserMigrationState(t,a,n){try{const r=q(this.getMigrationsCollectionRef(t),"state");await Yt(r,{userId:t,completedMigrations:a,lastMigrationCheck:X(),version:n}),W.printStateInfo(`Updated migration state for user ${t}`)}catch(r){throw W.printStateError("Failed to update migration state",r),r}}async markMigrationCompleted(t,a){try{const n=await this.getUserMigrationState(t),r=[...new Set([...n.completedMigrations,a])];await this.updateUserMigrationState(t,r,n.version),W.printStateInfo(`Migration ${a} marked as completed for user ${t}`)}catch(n){throw W.printStateError("Failed to mark migration as completed",n),n}}async resetMigrationState(t){try{await this.updateUserMigrationState(t,[],"1.0.0"),W.printStateInfo(`Migration state reset for user ${t}`)}catch(a){throw W.printStateError("Failed to reset migration state",a),a}}}class Ll{migrations=[new Ml,new El,new Tl,se().channel.autoCreateDefault.enabled].filter(Boolean);getAllMigrations(){return this.migrations}getPendingMigrations(t){return this.migrations.filter(a=>!t.includes(a.version))}async executeMigration(t,a){try{W.printExecutorInfo(`Starting migration ${t.version}: ${t.name}`),await t.execute(a),W.printExecutorInfo(`Migration ${t.version} completed successfully`)}catch(n){throw W.printExecutorError(`Migration ${t.version} failed`,n),n}}addMigration(t){this.migrations.push(t),W.printExecutorInfo(`Added new migration: ${t.version} - ${t.name}`)}}class Rl{stateManager=new Al;executorManager=new Ll;async runAllMigrations(t){try{W.printHeader(t);const a=await this.stateManager.getUserMigrationState(t),n=this.executorManager.getAllMigrations(),r=this.executorManager.getPendingMigrations(a.completedMigrations),o=n.filter(c=>a.completedMigrations.includes(c.version));if(W.printOverview(n.length,o.length,r.length),r.length===0){W.printAllCompleted(o.length);return}W.printPendingMigrations(r);let i=0,l=0;for(let c=0;c<r.length;c++){const d=r[c],u=`[${c+1}/${r.length}]`;try{W.printMigrationStart(u,d.version,d.name),await this.executorManager.executeMigration(d,t),await this.stateManager.markMigrationCompleted(t,d.version),W.printMigrationComplete(),i++}catch(m){W.printMigrationFailure(m),l++}}W.printExecutionSummary(i,l,o.length)}catch(a){throw W.printCriticalError(a),a}}async checkMigrationStatus(t){try{const a=await this.stateManager.getUserMigrationState(t),n=this.executorManager.getAllMigrations(),r=this.executorManager.getPendingMigrations(a.completedMigrations),o=n.filter(u=>a.completedMigrations.includes(u.version)),l=(await te(le(U.getDb(),`users/${t}/messages`))).docs.filter(u=>u.data().isDeleted===void 0).length,d=(await te(le(U.getDb(),`users/${t}/channels`))).docs.filter(u=>!u.data().lastMessageTime).length;return W.printServiceInfo(`Status check: ${r.length} pending, ${l} messages, ${d} channels need migration`),{messagesNeedMigration:l,channelsNeedMigration:d,pendingMigrations:r.map(u=>u.version),lastMigrationCheck:a.lastMigrationCheck,totalMigrations:n.length,completedMigrations:o.length,skippedMigrations:o.length}}catch(a){throw W.printServiceError("Failed to check migration status",a),a}}async forceRerunAllMigrations(t){try{W.printServiceInfo(`Force rerunning all migrations for user: ${t}`),await this.stateManager.resetMigrationState(t),await this.runAllMigrations(t),W.printServiceInfo("Force rerun completed successfully")}catch(a){throw W.printServiceError("Force rerun failed",a),a}}addMigration(t){this.executorManager.addMigration(t)}}const Dl=new Rl,O=de()(ct((s,t)=>({currentChannelId:null,isAddingMessage:!1,isUpdatingMessage:!1,isDeletingMessage:!1,currentUser:null,authIsReady:!1,setAuth:a=>{s({currentUser:a,authIsReady:!0})},setCurrentChannel:a=>{s({currentChannelId:a})},setIsAddingMessage:a=>{s({isAddingMessage:a})},setIsUpdatingMessage:a=>{s({isUpdatingMessage:a})},setIsDeletingMessage:a=>{s({isDeletingMessage:a})},addMessage:async a=>{t().setIsAddingMessage(!0);try{await T.getState().addMessage(a)}finally{t().setIsAddingMessage(!1)}},deleteMessage:async a=>{t().setIsDeletingMessage(!0);try{await T.getState().deleteMessage(a)}finally{t().setIsDeletingMessage(!1)}},updateMessage:async(a,n)=>{t().setIsUpdatingMessage(!0);try{await T.getState().updateMessage(a,n)}finally{t().setIsUpdatingMessage(!1)}}}),{name:"echonote-notes-view-storage"}));class De extends Ti{emit(t){this.next(t)}listen(t){const a=this.subscribe(t);return()=>a.unsubscribe()}}function _l(s,t=[]){const a=st.useRef(!0);st.useEffect(()=>a.current===!0?(a.current=!1,()=>{}):s(),t)}const Pl=()=>{let s=!1;const t=[];return{isFrozen:()=>s,freeze:()=>{s=!0},unfreeze:()=>{for(;t.length>0;)t.shift()();s=!1},submit:o=>{s?t.push(o):o()}}},Vs=Pl();class ma extends _e{next(t){Vs.submit(()=>super.next(t))}}const qs=(s,t)=>{if(t){const a=t.split("::");let n=s.data;for(let r=0;r<a.length;r+=1){if(!n[a[r]])return n[a[r]];n=n[a[r]]}return n}else return s.data},Ol=s=>typeof s=="object"&&s!==null?Array.isArray(s)?[...s]:{...s}:s,$l=(s,t,a,n)=>{const r=qs(s,a);if(n===r)return;const o=(i,l,c)=>{l!==c&&i.$.next(l),Object.entries(i.children).forEach(([d,u])=>{o(u,l?.[d],c?.[d])})};if(Vs.freeze(),!a)s.data=n,o(t,n,r);else{const i=a.split("::");let l=s.data,c=t;const d=[[c,l,void 0]];for(let f=0;f<i.length-1;f+=1)l[i[f]]===void 0&&(l[i[f]]={}),l=l[i[f]],c=c?.children[i[f]],d.push([c,l,i[f]]);const u=c?.children[i[i.length-1]];d.push([u,n,i[i.length-1]]);const m=[],x=[];let p,g;for(let f=d.length-1;f>=0;f-=1){const[b,v,y]=d[f];if(f===d.length-1)x.unshift([b,v]),p=y,g=v;else{const I=Ol(v);I[p]=g,x.unshift([b,I]),p=y,g=I}}s.data=g;for(let f=0;f<x.length;f+=1){const[b,v]=x[f];if(b)m.push(()=>b.$.next(v));else break}m.reverse().forEach(f=>f()),u&&Object.entries(u.children).forEach(([f,b])=>{o(b,n?.[f],r?.[f])})}Vs.unfreeze()},Kn=(s,t,a)=>{if(a){const n=a.split("::");let r=s.data,o=t;for(let i=0;i<n.length;i+=1)i<n.length-1&&r[n[i]]===void 0&&(r[n[i]]={}),o.children[n[i]]===void 0&&(o.children[n[i]]={$:new ma(r[n[i]]),children:{}}),r=r[n[i]],o=o.children[n[i]];return o}else return t},Ul=(s,t,a)=>{const{$:n}=Kn(s,t,a),[,r]=h.useState(()=>n.getValue());return h.useEffect(()=>{const o=n.subscribe(i=>{r(i)});return()=>o.unsubscribe()},[n]),n.getValue()},Yn=(s,t,a)=>{const n=t||{$:new ma(s.data),children:{}},r=o=>a?`${a}::${o}`:o;return new Proxy({$$isBean:!0},{ownKeys(o){return Reflect.ownKeys(o).concat(["use","get","set","$","namespaces"])},get(o,i){if(i in o)return o[i];if(typeof i=="string"){if(["$","get","set","use"].includes(i)){const l=Kn(s,n,a);if(i==="$")return l.$;if(i==="get")return l.get||(l.get=()=>qs(s,a)),l.get;if(i==="set")return l.set||(l.set=c=>$l(s,n,a,typeof c=="function"?c(qs(s,a)):c)),l.set;if(i==="use")return l.use||(l.use=()=>Ul(s,n,a)),l.use}else if(i==="namespaces")return new Proxy({},{get(l,c){return Yn(s,n,r(c))}})}else return o[i]}})},Xn=(s,t,a)=>Yn({data:s},t,a),La=s=>{const t=h.useMemo(()=>new ma(s),[]);return _l(()=>{t.next(s)},[s]),t},at=(s,t)=>t.split(".").reduce((n,r)=>n.namespaces[r],s),Jn=s=>({value:s.use(),set:s.set,get:s.get}),Ra=async(s,t,a)=>{s();try{await t()}catch(n){throw a(),n}};class Fl{moreMessageLoadedEvent$=new De;requestLoadInitialMessages$=new Tn(1);dataContainer=Xn({messageByChannel:{}});handleRequestWorkflow$=this.requestLoadInitialMessages$.pipe(fs((t,a)=>t.channelId===a.channelId&&t.messageLimit===a.messageLimit),bs(t=>{const a=this.dataContainer.get().messageByChannel[t.channelId];return!a||a.hasMore&&!a.loading}),An(t=>this.loadInitialMessages({channelId:t.channelId,messagesLimit:t.messageLimit||20})));connectToRequestWorkflow=()=>{const t=this.handleRequestWorkflow$.subscribe();return()=>t.unsubscribe()};getIsAnyChannelLoading$=t=>t.length?Ln(t.map(a=>at(this.dataContainer,`messageByChannel.${a}.loading`).$)).pipe(qe(a=>a.some(n=>n))):Ai(!1);getChannelStateControl=t=>{const a=at(this.dataContainer,`messageByChannel.${t}`),{get:n,namespaces:{loading:{set:r},loadingMore:{set:o},messages:{set:i},lastVisible:{set:l},hasMore:{set:c},subscription:{set:d}}}=a,u=g=>{const f=n().messages||[];if(f.find(v=>v.id===g.id))return;const b=f[f.length-1];b&&b.content===g.content?i([...f.slice(0,-1),g]):i([...f,g])},m=g=>{const f=n().messages||[];i(f.filter(b=>b.id!==g))},x=(g,f)=>{const b=n().messages||[],v=b.find(y=>y.id===f);i(v?b.filter(y=>y.id!==g):b.map(y=>y.id===g?{...y,id:f}:y))},p=()=>{const g=n();i([]),r(!1),o(!1),c(!1),l(null),g?.subscription&&g.subscription.unsubscribe()};return{getChannelState:n,setLoading:r,setLoadingMore:o,addMessage:u,updateMessage:this.updateMessage,setMessages:i,setLastVisible:l,setHasMore:c,setSubscription:d,removeMessage:m,fixFakeMessage:x,clearChannel:p}};loadInitialMessages=async({channelId:t,messagesLimit:a})=>{console.log("[ChannelMessageService] loadInitialMessages",{channelId:t,messagesLimit:a});const{currentUser:n}=O.getState(),r=n?.uid;if(console.log("[ChannelMessageService] loadInitialMessages",{channelId:t,messagesLimit:a,userId:r}),!r||!t)return;const{setLoading:o,addMessage:i,setLastVisible:l,setHasMore:c,setSubscription:d}=this.getChannelStateControl(t);o(!0);try{const u=await K.fetchInitialMessages(r,t,a);if(u.messages.forEach(i),l(u.lastVisible),c(!u.allLoaded),u.messages.length>0){const m=u.messages[0].timestamp,x=this.subscribeToNewMessages({channelId:t,afterTimestamp:m});d({unsubscribe:x})}}catch(u){console.error("Error loading initial messages:",u)}finally{o(!1)}};loadMoreHistory=async({channelId:t,messagesLimit:a})=>{const{userId:n}=T.getState();if(!n||!t)return;const{getChannelState:r,setLoadingMore:o,setLastVisible:i,setHasMore:l,setMessages:c}=this.getChannelStateControl(t),{loading:d,loadingMore:u,hasMore:m,lastVisible:x,messages:p}=r();if(!(!n||!t||!m||!x||d||u)){o(!0);try{const g=await K.fetchMoreMessages(n,t,a,x);if(g.messages.length>0){const f=[...g.messages,...p];c(f),i(g.lastVisible),this.moreMessageLoadedEvent$.emit({channelId:t,messages:g.messages})}l(!g.allLoaded)}catch(g){console.error("Error loading more messages:",g)}finally{o(!1)}}};subscribeToNewMessages=({channelId:t,afterTimestamp:a})=>{const{userId:n}=T.getState();if(!n||!t)return()=>{};const{addMessage:r,getChannelState:o,setSubscription:i}=this.getChannelStateControl(t),{subscription:l}=o();l&&(console.log("🔔 [subscribeToNewMessages] 取消之前的订阅"),l.unsubscribe()),console.log("🔔 [subscribeToNewMessages] 开始订阅新消息",{channelId:t,afterTimestamp:a});const c=K.subscribeToNewMessages(n,t,a,d=>{d.forEach(u=>{r(u)})});return i({unsubscribe:c}),c};deleteMessage=async({messageId:t,hardDelete:a,channelId:n})=>{const{userId:r}=T.getState();if(!r)return;const{removeMessage:o,getChannelState:i,setMessages:l}=this.getChannelStateControl(n),c=i().messages;await Ra(()=>o(t),async()=>{a?await K.deleteMessage(r,t):await K.softDeleteMessage(r,t),console.log("Message deleted successfully:",{messageId:t,channelId:n,hardDelete:a})},()=>{l(c),console.error("Failed to delete message, rolling back:",{messageId:t,channelId:n})})};sendMessage=async t=>{const{userId:a}=T.getState();if(!a)return;const{addMessage:n,fixFakeMessage:r}=this.getChannelStateControl(t.channelId),o={...t,id:Dn(),timestamp:new Date};n(o);const i=await K.createMessage(a,t);r(o.id,i)};updateMessage=async({messageId:t,channelId:a,updates:n,userId:r})=>{const{getChannelState:o,setMessages:i}=this.getChannelStateControl(a),{messages:l}=o(),c=l.find(u=>u.id===t);if(!c)throw new Error("Message not found");if(c.sender!=="user")throw new Error("You can only edit user messages, not AI messages");const d={...c,...n};await Ra(()=>i(l.map(u=>u.id===t?d:u)),async()=>{await K.updateMessage(r,t,n),console.log("Message updated successfully:",{messageId:t,channelId:a,updates:n})},()=>{i(l.map(u=>u.id===t?c:u)),console.error("Failed to update message, rolling back:",{messageId:t,channelId:a})})}}const _=new Fl;window.channelMessageService=_;const ke=s=>async(...t)=>{const{userId:a}=T.getState();a&&await s(a,...t)},xe=async(s,t)=>{try{return await s()}catch(a){console.error(`Error in ${t}:`,a)}},T=de()((s,t)=>({channels:[],channelsLoading:!0,userId:null,unsubscribeChannels:null,isListenerEnabled:!0,messagesByChannel:{},setChannelsLoading:a=>{s({channelsLoading:a})},addChannel:ke(async(a,n)=>{const r={...n,emoji:n.emoji&&n.emoji.trim()?n.emoji:Gs()},o=await xe(()=>K.createChannel(a,r),"createChannel");if(typeof o=="string"&&o)try{O.getState().setCurrentChannel(o)}catch(i){console.warn("[addChannel] Failed to set current channel after creation",i)}}),updateChannel:ke(async(a,n,r)=>{const{channels:o}=t(),i=o.map(l=>l.id===n?{...l,...r}:l);s({channels:i}),await xe(()=>K.updateChannel(a,n,r),"updateChannel")}),deleteChannel:ke(async(a,n)=>{await xe(()=>K.deleteChannel(a,n),"deleteChannel");const{channels:r,messagesByChannel:o}=t(),i=r.filter(d=>d.id!==n);s({channels:i});const{[n]:l,...c}=o;s({messagesByChannel:c}),console.log("🔔 [deleteChannel] 成功删除 channel 并更新本地状态",{channelId:n,remainingChannelsCount:Object.keys(c).length,removedChannelMessageCount:l?.messages?.length||0})}),addMessage:ke(async(a,n)=>{await xe(()=>K.createMessage(a,n),"createMessage")}),deleteMessage:ke(async(a,n,r=!1)=>{await xe(r?()=>K.deleteMessage(a,n):()=>K.softDeleteMessage(a,n),r?"deleteMessage":"softDeleteMessage");const{messagesByChannel:i}=t();console.log("🔔 [deleteMessage] 开始查找消息",{messageId:n,messagesByChannel:i});for(const[l,c]of Object.entries(i))if(c.messages.some(u=>u.id===n)){console.log("🔔 [deleteMessage] 找到消息，准备删除",{channelId:l,messageId:n}),t().removeChannelMessage(l,n);break}}),updateMessage:ke(async(a,n,r)=>{await xe(()=>K.updateMessage(a,n,r),"updateMessage")}),addThreadMessage:ke(async(a,n,r)=>{await xe(()=>K.createMessage(a,{...r,parentId:n,threadId:n}),"createThreadMessage")}),restoreMessage:ke(async(a,n)=>{await xe(()=>K.restoreMessage(a,n),"restoreMessage")}),permanentDeleteMessage:ke(async(a,n)=>{await xe(()=>K.deleteMessage(a,n),"permanentDeleteMessage")}),setChannelMessages:(a,n)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[a]:{...r.messagesByChannel[a],messages:n,loading:!1}}}))},addChannelMessage:(a,n)=>{s(r=>{const o=r.messagesByChannel[a];return o?o.messages.some(l=>l.id===n.id)?(console.log("🔔 [addChannelMessage] 消息已存在，跳过添加",{messageId:n.id,channelId:a}),r):(console.log("🔔 [addChannelMessage] 添加新消息",{messageId:n.id,channelId:a}),{messagesByChannel:{...r.messagesByChannel,[a]:{...o,messages:[...o.messages,n]}}}):r})},setChannelLoading:(a,n)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[a]:{...r.messagesByChannel[a],loading:n}}}))},setChannelHasMore:(a,n)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[a]:{...r.messagesByChannel[a],hasMore:n}}}))},setChannelLastVisible:(a,n)=>{s(r=>({messagesByChannel:{...r.messagesByChannel,[a]:{...r.messagesByChannel[a],lastVisible:n}}}))},clearChannelMessages:a=>{s(n=>{const{[a]:r,...o}=n.messagesByChannel;return{messagesByChannel:o}})},removeChannelMessage:(a,n)=>{s(r=>{const o=r.messagesByChannel[a];if(!o)return r;const i=o.messages.filter(l=>l.id!==n);return console.log("🔔 [removeChannelMessage]",{channelId:a,messageId:n,beforeCount:o.messages.length,afterCount:i.length}),{messagesByChannel:{...r.messagesByChannel,[a]:{...o,messages:i}}}})},initFirebaseListeners:async a=>{t().cleanupListeners(),s({userId:a,channelsLoading:!0}),await t().fetchInitialData(a),await xe(async()=>{await Dl.runAllMigrations(a)},"runMigrations");const n=K.subscribeToChannels(a,r=>{const{isListenerEnabled:o}=t();o&&(s({channels:r,channelsLoading:!1}),t().validateAndCleanupCurrentChannel(r))});s({unsubscribeChannels:n})},cleanupListeners:()=>{const{unsubscribeChannels:a}=t();a&&a(),s({unsubscribeChannels:null,channels:[],channelsLoading:!0,userId:null,messagesByChannel:{}})},fetchInitialData:async a=>{s({channelsLoading:!0}),await xe(async()=>{const n=await K.fetchChannels(a);s({channels:n,channelsLoading:!1}),t().validateAndCleanupCurrentChannel(n)},"fetchChannels")},validateAndCleanupCurrentChannel:a=>{const n=O.getState().currentChannelId;if(!n)return;a.some(o=>o.id===n)||(O.getState().setCurrentChannel(null),_.getChannelStateControl(n).clearChannel(),t().clearChannelMessages(n))}}));var B=(s=>(s.IDLE="idle",s.AUTHENTICATING="authenticating",s.VERIFYING_EMAIL="verifying-email",s.INITIALIZING_DATA="initializing-data",s.COMPLETE="complete",s.ERROR="error",s))(B||{}),me=(s=>(s.CONNECTING_GOOGLE="Connecting to Google...",s.VERIFYING_CREDENTIALS="Verifying credentials...",s.CHECKING_EMAIL_VERIFICATION="Checking email verification...",s.SETTING_UP_WORKSPACE="Setting up your workspace...",s.WELCOME_BACK="Welcome back!",s.SIGN_IN_FAILED="Sign-in failed. Please try again.",s.CHECK_CREDENTIALS="Sign-in failed. Please check your credentials.",s.CREATING_ACCOUNT="Creating your account...",s.SENDING_VERIFICATION="Sending verification email...",s.ACCOUNT_CREATED="Account created successfully!",s))(me||{}),ge=(s=>(s[s.START=0]="START",s[s.AUTHENTICATING=25]="AUTHENTICATING",s[s.VERIFYING_EMAIL=50]="VERIFYING_EMAIL",s[s.INITIALIZING_DATA=75]="INITIALIZING_DATA",s[s.COMPLETE=100]="COMPLETE",s))(ge||{});let xt=!1,Ve=!1;const fe={signInWithGoogle:async()=>{if(console.log("[firebaseAuthService] signInWithGoogle"),!U.supportGoogleAuth())throw new Error("Google authentication is not supported in this region");const s=new ji;try{const t=await U.getAuth(),a=await Ni(t,s);return await T.getState().initFirebaseListeners(a.user.uid),a.user}catch(t){return console.error("Google Sign-In Error:",t),null}},sendSignUpLink:async(s,t,a)=>{try{xt=!0;try{const n=await U.getAuth(),r=await Ca(n,s,t);return a&&await Ls(r.user,{displayName:a}),await pt(r.user),await gt(n),{verificationSent:!0}}catch(n){if(n.code==="auth/email-already-in-use")try{const r=await U.getAuth(),o=await Na(r,s,t);if(o.user.emailVerified)throw new Error("EMAIL_ALREADY_VERIFIED");return a&&await Ls(o.user,{displayName:a}),await pt(o.user),await gt(r),{verificationSent:!0}}catch(r){throw r.code==="auth/wrong-password"||r.code==="auth/invalid-credential"?new Error("ACCOUNT_EXISTS_WRONG_PASSWORD"):r}throw n}}catch(n){throw xt=!1,console.error("Send Sign-Up Link Error:",n),n}finally{xt=!1}},signUpWithEmail:async(s,t,a)=>{try{const n=await U.getAuth(),r=await Ca(n,s,t);return a&&await Ls(r.user,{displayName:a}),await pt(r.user),await gt(n),{user:r.user,verificationSent:!0}}catch(n){throw console.error("Email Sign-Up Error:",n),n}},sendEmailVerification:async s=>{try{await pt(s)}catch(t){throw console.error("Email Verification Error:",t),t}},signInWithEmail:async(s,t)=>{try{console.log("🔐 Starting email sign-in process..."),Ve=!0,console.log("🔐 isSigningIn set to true"),Me.getState().setAuthStep(B.AUTHENTICATING,me.VERIFYING_CREDENTIALS,ge.AUTHENTICATING);const a=await U.getAuth(),n=await Na(a,s,t);if(console.log("✅ Firebase authentication successful"),console.log("📧 Email verified:",n.user.emailVerified),Me.getState().setAuthStep(B.VERIFYING_EMAIL,me.CHECKING_EMAIL_VERIFICATION,ge.VERIFYING_EMAIL),!n.user.emailVerified)throw console.log("📧 Email not verified, sending verification email..."),await pt(n.user),console.log("📧 Verification email sent"),await gt(a),console.log("🚪 User signed out due to unverified email"),Ve=!1,console.log("🔐 isSigningIn reset to false due to unverified email"),new Error("EMAIL_NOT_VERIFIED_RESENT");return console.log("✅ Email is verified, proceeding with login"),console.log("🔗 Initializing Firebase listeners..."),Me.getState().setAuthStep(B.INITIALIZING_DATA,me.SETTING_UP_WORKSPACE,ge.INITIALIZING_DATA),U.setUserIdForAnalytics(n.user.uid),await T.getState().initFirebaseListeners(n.user.uid),console.log("✅ Firebase listeners initialized"),Me.getState().setAuthStep(B.COMPLETE,me.WELCOME_BACK,ge.COMPLETE),Ve=!1,console.log("🔐 isSigningIn set to false after listeners initialized"),console.log("🎉 Login process completed successfully"),n.user}catch(a){throw console.error("❌ Email Sign-In Error:",a),Ve=!1,console.log("🔐 isSigningIn reset to false due to error"),Me.getState().setAuthStep(B.ERROR,me.SIGN_IN_FAILED,ge.START),a}},sendPasswordReset:async s=>{try{const t=await U.getAuth();await wi(t,s)}catch(t){throw console.error("Password Reset Error:",t),t}},signOut:async()=>{const s=await U.getAuth();await gt(s),T.getState().cleanupListeners()},onAuthStateChanged:async s=>{const t=await U.getAuth();return yi(t,async a=>{if(console.log("🔄 Auth state changed:",a?`User: ${a.email} (verified: ${a.emailVerified})`:"No user"),console.log("🔐 isRegistering:",xt,"isSigningIn:",Ve),xt){console.log("⏸️ Skipping auth state change due to ongoing registration");return}if(Ve&&a&&a.emailVerified)console.log("✅ Processing login state change - user is verified");else if(Ve){console.log("⏸️ Skipping auth state change due to ongoing sign-in (unverified user)");return}a?(U.setUserIdForAnalytics(a.uid),a.emailVerified?(console.log("✅ User email verified, initializing listeners"),await T.getState().initFirebaseListeners(a.uid)):(console.log("❌ User email not verified, cleaning up listeners"),T.getState().cleanupListeners())):(console.log("🚪 No user, cleaning up listeners"),T.getState().cleanupListeners()),console.log("📞 Calling auth state callback"),s(a)})},getCurrentUser:async()=>(await U.getAuth()).currentUser,checkEmailVerification:async()=>{const t=(await U.getAuth()).currentUser;return t?(await t.reload(),t.emailVerified):!1}},Me=de()(ct((s,t)=>({currentUser:null,authIsReady:!1,isInitializing:!1,isRefreshing:!1,isAuthenticating:!1,authStep:B.IDLE,authMessage:"",authProgress:0,signInWithGoogle:async()=>{if(!U.supportGoogleAuth())throw new Error("Google authentication is not supported in this region");s({isAuthenticating:!0,authStep:B.AUTHENTICATING,authMessage:me.CONNECTING_GOOGLE,authProgress:ge.AUTHENTICATING});try{await fe.signInWithGoogle(),s({authStep:B.INITIALIZING_DATA,authMessage:me.SETTING_UP_WORKSPACE,authProgress:ge.INITIALIZING_DATA})}catch(a){throw s({authStep:B.ERROR,authMessage:me.SIGN_IN_FAILED,authProgress:ge.START}),a}finally{s({isAuthenticating:!1})}},signInWithEmail:async(a,n)=>{s({isAuthenticating:!0,authStep:B.AUTHENTICATING,authMessage:me.VERIFYING_CREDENTIALS,authProgress:ge.AUTHENTICATING});try{await fe.signInWithEmail(a,n),s({authStep:B.VERIFYING_EMAIL,authMessage:me.CHECKING_EMAIL_VERIFICATION,authProgress:ge.VERIFYING_EMAIL})}catch(r){throw s({authStep:B.ERROR,authMessage:me.CHECK_CREDENTIALS,authProgress:ge.START}),r}finally{s({isAuthenticating:!1})}},signUpWithEmail:async(a,n,r)=>{s({isAuthenticating:!0});try{return await fe.signUpWithEmail(a,n,r)}finally{s({isAuthenticating:!1})}},sendSignUpLink:async(a,n,r)=>{s({isAuthenticating:!0});try{return await fe.sendSignUpLink(a,n,r)}finally{s({isAuthenticating:!1})}},sendPasswordReset:async a=>{s({isAuthenticating:!0});try{await fe.sendPasswordReset(a)}finally{s({isAuthenticating:!1})}},sendEmailVerification:async()=>{s({isAuthenticating:!0});try{const a=t().currentUser;if(!a)throw new Error("No user logged in");await fe.sendEmailVerification(a)}finally{s({isAuthenticating:!1})}},signOut:async()=>{s({isAuthenticating:!0});try{await fe.signOut()}finally{s({isAuthenticating:!1})}},setAuth:a=>{s({currentUser:a})},setAuthReady:a=>{s({authIsReady:a})},setInitializing:a=>{s({isInitializing:a})},setRefreshing:a=>{s({isRefreshing:a})},setAuthenticating:a=>{s({isAuthenticating:a})},setAuthStep:(a,n,r)=>{s({authStep:a,authMessage:n,authProgress:r})},initAuthListener:async()=>{const a=t().currentUser!==null;return s(a?{isRefreshing:!0,authIsReady:!1}:{isInitializing:!0,authIsReady:!1}),await fe.onAuthStateChanged(r=>{t().setAuth(r),s(a?{isRefreshing:!1,authIsReady:!0}:{isInitializing:!1,authIsReady:!0})})}}),{name:"echonote-auth-storage",partialize:s=>({currentUser:s.currentUser,authIsReady:s.authIsReady})})),zl=({error:s,isPasswordReset:t,isEmailVerificationSent:a,email:n,onResendVerification:r,onBackToSignIn:o,isAuthenticating:i})=>e.jsxs(e.Fragment,{children:[s&&e.jsx("div",{className:"text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/30 rounded-lg p-3",children:s}),t&&e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/30 rounded-lg p-3",children:"Password reset email sent! Check your inbox."}),a&&e.jsxs("div",{className:"text-sm text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/30 rounded-lg p-3",children:[e.jsx("div",{className:"font-medium mb-1",children:"Check your email"}),e.jsxs("div",{className:"text-xs",children:["We've sent a verification link to ",e.jsx("strong",{children:n}),". Click the link to complete registration."]}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("button",{onClick:r,disabled:i,className:"text-xs text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300 underline underline-offset-2 disabled:opacity-50",children:"Resend link"}),e.jsx("span",{className:"text-xs text-green-500 dark:text-green-400",children:"•"}),e.jsx("button",{onClick:o,className:"text-xs text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300 underline underline-offset-2",children:"Back to sign in"})]})]})]});function ye({className:s,type:t,...a}){return e.jsx("input",{type:t,"data-slot":"input",className:j("file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm","aria-invalid:border-destructive",s),...a})}const Bl=({email:s,password:t,confirmPassword:a,isSignUp:n,isAuthenticating:r,error:o,statusMessage:i,onEmailChange:l,onPasswordChange:c,onConfirmPasswordChange:d,onToggleSignUp:u,onPasswordReset:m,onSubmit:x})=>{const[p,g]=h.useState(!1),[f,b]=h.useState(!1);return e.jsxs("form",{onSubmit:v=>{v.preventDefault(),x()},className:"space-y-4",children:[e.jsx(ye,{type:"email",name:"email",placeholder:"Enter your email",value:s,onChange:v=>l(v.target.value),className:"w-full h-12 text-sm rounded-xl border-slate-200 dark:border-slate-600 focus:border-slate-400 dark:focus:border-slate-500 dark:bg-slate-700 dark:text-white dark:placeholder-slate-400",disabled:r,autoComplete:"email"}),e.jsxs("div",{className:"relative",children:[e.jsx(ye,{type:p?"text":"password",name:"password",placeholder:"Enter your password",value:t,onChange:v=>c(v.target.value),className:"w-full h-12 text-sm rounded-xl border-slate-200 dark:border-slate-600 focus:border-slate-400 dark:focus:border-slate-500  dark:bg-slate-700 dark:text-white dark:placeholder-slate-400 pr-10",disabled:r,autoComplete:n?"new-password":"current-password"}),e.jsx("button",{type:"button",onClick:()=>g(!p),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors",disabled:r,children:p?e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"})}):e.jsxs("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})})]}),n&&e.jsxs("div",{className:"relative",children:[e.jsx(ye,{type:f?"text":"password",name:"confirmPassword",placeholder:"Confirm your password",value:a,onChange:v=>d(v.target.value),className:"w-full h-12 text-sm rounded-xl border-slate-200 dark:border-slate-600 focus:border-slate-400 dark:focus:border-slate-500  dark:bg-slate-700 dark:text-white dark:placeholder-slate-400 pr-10",disabled:r,autoComplete:"new-password"}),e.jsx("button",{type:"button",onClick:()=>b(!f),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors",disabled:r,children:f?e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"})}):e.jsxs("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]})})]}),o&&e.jsx("div",{className:"text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/30 rounded-lg p-3",children:o}),i&&e.jsx("div",{className:"text-sm text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800/30 rounded-lg p-3",children:i}),e.jsx(N,{onClick:x,disabled:r||!s||!t||n&&(!a||t!==a||t.length<6),className:"w-full h-12 text-sm font-medium rounded-xl bg-slate-600 hover:bg-slate-700 dark:bg-slate-700 dark:hover:bg-slate-600 text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed",size:"lg",children:r?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:n?"Creating account...":"Signing in..."})]}):n?"Create Account":"Sign In"}),e.jsx("div",{className:"text-center",children:e.jsx("button",{onClick:u,className:"text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors underline underline-offset-2",disabled:r,children:n?"Already have an account? Sign in":"Don't have an account? Sign up"})}),!n&&e.jsx("div",{className:"text-center",children:e.jsx("button",{onClick:m,className:"text-sm text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300 transition-colors underline underline-offset-2",disabled:r||!s,children:"Forgot your password?"})})]})},Hl=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("p",{className:"text-xs text-slate-500 dark:text-slate-400 leading-relaxed",children:["By continuing, you agree to the"," ",e.jsx("button",{className:"underline underline-offset-2 hover:text-slate-700 dark:hover:text-slate-300 transition-colors font-medium",children:"Terms"}),","," ",e.jsx("button",{className:"underline underline-offset-2 hover:text-slate-700 dark:hover:text-slate-300 transition-colors font-medium",children:"Privacy"}),"."]})}),e.jsxs("div",{className:"flex justify-center gap-4 mt-6",children:[e.jsx("button",{className:"w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center transition-colors",children:e.jsx("svg",{className:"w-4 h-4 text-slate-600 dark:text-slate-400",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"})})}),e.jsx("button",{className:"w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 flex items-center justify-center transition-colors",children:e.jsx("svg",{className:"w-4 h-4 text-slate-600 dark:text-slate-400",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"})})})]})]}),Gl=()=>e.jsxs("div",{className:"hidden lg:flex flex-1 items-center justify-center p-8 relative overflow-hidden",children:[e.jsxs("div",{className:"relative z-10 max-w-lg",children:[e.jsxs("div",{className:"mb-12 text-center",children:[e.jsxs("h2",{className:"text-3xl md:text-4xl font-bold text-slate-800 dark:text-white mb-6 leading-tight",children:[e.jsx("span",{className:"italic text-slate-600 dark:text-slate-400",children:'"'}),e.jsx("span",{className:"bg-gradient-to-r from-emerald-700 via-slate-800 to-slate-700 dark:from-emerald-400 dark:via-slate-300 dark:to-slate-400 bg-clip-text text-transparent",children:"StillRoot: where thoughts take root"}),e.jsx("span",{className:"italic text-slate-600 dark:text-slate-400",children:'"'})]}),e.jsxs("div",{className:"space-y-3 text-slate-600 dark:text-slate-300",children:[e.jsxs("p",{className:"text-lg font-medium leading-relaxed opacity-90",children:["For your"," ",e.jsx("span",{className:"italic text-emerald-600 dark:text-emerald-400",children:"fleeting ideas"}),"."]}),e.jsxs("p",{className:"text-lg font-medium leading-relaxed opacity-90",children:["For your"," ",e.jsx("span",{className:"italic text-teal-600 dark:text-teal-400",children:"emerging insights"}),"."]}),e.jsxs("p",{className:"text-lg font-medium leading-relaxed opacity-90",children:["For your"," ",e.jsx("span",{className:"italic text-cyan-600 dark:text-cyan-400",children:"evolving self"}),"."]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center opacity-20",children:e.jsx("div",{className:"w-32 h-32 rounded-full bg-gradient-to-br from-emerald-200 to-cyan-200 dark:from-emerald-800 dark:to-cyan-800 animate-pulse"})}),e.jsxs("svg",{width:"400",height:"300",viewBox:"0 0 400 300",className:"mx-auto relative z-10",children:[e.jsxs("g",{transform:"translate(150, 80)",children:[e.jsx("ellipse",{cx:"0",cy:"40",rx:"25",ry:"35",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"text-slate-600 dark:text-slate-400"}),e.jsx("circle",{cx:"0",cy:"-10",r:"20",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"text-slate-600 dark:text-slate-400"}),e.jsx("path",{d:"M-15,-25 Q-20,-35 -10,-30 Q0,-40 10,-30 Q20,-35 15,-25",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"text-slate-600 dark:text-slate-400"}),e.jsx("path",{d:"M-25,20 Q-35,10 -30,0",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"text-slate-600 dark:text-slate-400"}),e.jsx("path",{d:"M25,20 Q35,10 30,0",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"text-slate-600 dark:text-slate-400"}),e.jsx("path",{d:"M-15,70 L-20,100",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"text-slate-600 dark:text-slate-400"}),e.jsx("path",{d:"M15,70 L20,100",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"text-slate-600 dark:text-slate-400"}),e.jsx("circle",{cx:"30",cy:"0",r:"3",fill:"#10b981"})]}),e.jsxs("g",{transform:"translate(120, 60)",children:[e.jsx("path",{d:"M0,100 Q-20,80 -15,60 Q-10,40 0,50 Q10,40 15,60 Q20,80 0,100",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"text-slate-600 dark:text-slate-400"}),e.jsx("path",{d:"M0,50 L0,100",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"text-slate-600 dark:text-slate-400"})]}),e.jsxs("g",{transform:"translate(180, 60)",children:[e.jsx("circle",{cx:"0",cy:"0",r:"8",fill:"#10b981"}),e.jsx("path",{d:"M-8,0 Q-12,-5 -8,-10 Q-4,-15 0,-10 Q4,-15 8,-10 Q12,-5 8,0",fill:"none",stroke:"#10b981",strokeWidth:"1"})]}),e.jsx("g",{transform:"translate(50, 40)",children:e.jsx("path",{d:"M0,0 Q10,-10 20,0 Q10,10 0,0",fill:"none",stroke:"currentColor",strokeWidth:"1",className:"text-slate-600 dark:text-slate-400"})}),e.jsx("g",{transform:"translate(320, 60)",children:e.jsx("path",{d:"M0,0 Q5,-8 10,0 Q5,8 0,0",fill:"none",stroke:"currentColor",strokeWidth:"1",className:"text-slate-600 dark:text-slate-400"})}),e.jsxs("g",{transform:"translate(80, 120)",children:[e.jsx("path",{d:"M0,20 Q-10,10 -5,0 Q0,-10 5,0 Q10,10 0,20",fill:"none",stroke:"currentColor",strokeWidth:"1",className:"text-slate-600 dark:text-slate-400"}),e.jsx("path",{d:"M0,0 L0,20",fill:"none",stroke:"currentColor",strokeWidth:"1",className:"text-slate-600 dark:text-slate-400"})]})]})]})]}),e.jsx("div",{className:"absolute top-10 right-10 w-8 h-8 border-2 border-slate-300 dark:border-slate-600 rounded-full"}),e.jsx("div",{className:"absolute top-20 right-20 w-4 h-4 bg-slate-300 dark:bg-slate-600 rounded-full"}),e.jsx("div",{className:"absolute bottom-20 left-10 w-6 h-6 border border-slate-300 dark:border-slate-600 rounded-full"}),e.jsx("div",{className:"absolute bottom-32 left-20 w-3 h-3 bg-slate-300 dark:bg-slate-600 rounded-full"})]}),Vl=({onGoogleLogin:s,isAuthenticating:t})=>{const{isGoogleAuthSupported:a}=ha();return a?e.jsx("div",{className:"mb-6",children:e.jsx(N,{onClick:s,disabled:t,className:"w-full h-12 text-sm font-medium rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 text-slate-900 dark:text-white transition-colors shadow-sm hover:shadow-md",size:"lg",children:t?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-slate-300 dark:border-slate-500 border-t-slate-600 dark:border-t-slate-300 rounded-full animate-spin"}),e.jsx("span",{children:"Signing in..."})]}):e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("svg",{className:"w-5 h-5",viewBox:"0 0 24 24",children:[e.jsx("path",{fill:"currentColor",d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),e.jsx("path",{fill:"currentColor",d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),e.jsx("path",{fill:"currentColor",d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),e.jsx("path",{fill:"currentColor",d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),e.jsx("span",{children:"Continue with Google"})]})})}):null},ql=({size:s="md",variant:t="default",text:a,className:n})=>{const r={sm:"w-4 h-4",md:"w-8 h-8",lg:"w-12 h-12",xl:"w-16 h-16"},o={sm:"text-xs",md:"text-sm",lg:"text-base",xl:"text-lg"},i=()=>e.jsx("div",{className:j("animate-spin rounded-full border-2 border-slate-200 dark:border-slate-700","border-t-blue-600 dark:border-t-blue-400",r[s])}),l=()=>e.jsx("div",{className:j("animate-pulse rounded-full bg-gradient-to-r from-blue-400 to-purple-500",r[s])}),c=()=>e.jsx("div",{className:"flex space-x-1",children:[0,1,2].map(x=>e.jsx("div",{className:j("animate-bounce rounded-full bg-blue-600 dark:bg-blue-400",s==="sm"?"w-1.5 h-1.5":s==="md"?"w-2 h-2":s==="lg"?"w-2.5 h-2.5":"w-3 h-3"),style:{animationDelay:`${x*.1}s`,animationDuration:"1s"}},x))}),d=()=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:j("absolute inset-0 rounded-full bg-blue-600 dark:bg-blue-400 opacity-75",r[s])}),e.jsx("div",{className:j("absolute inset-0 rounded-full bg-blue-600 dark:bg-blue-400 opacity-75",r[s],"animate-ping")}),e.jsx("div",{className:j("relative rounded-full bg-blue-600 dark:bg-blue-400",r[s])})]}),u=()=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:j("animate-spin rounded-full border-2 border-slate-200 dark:border-slate-700","border-t-blue-600 dark:border-t-blue-400",r[s])}),a&&e.jsx("span",{className:j("text-slate-600 dark:text-slate-400 font-medium",o[s]),children:a})]}),m=()=>{switch(t){case"spinner":return i();case"pulse":return l();case"dots":return c();case"ripple":return d();default:return u()}};return e.jsx("div",{className:j("flex items-center justify-center",n),children:m()})};function Wl({className:s,value:t,...a}){return e.jsx(Yr,{"data-slot":"progress",className:j("bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",s),...a,children:e.jsx(Xr,{"data-slot":"progress-indicator",className:"bg-primary h-full w-full flex-1 transition-all",style:{transform:`translateX(-${100-(t||0)}%)`}})})}const Kl=()=>{const{authStep:s,authMessage:t,authProgress:a,isAuthenticating:n}=Me();if(!n||s===B.IDLE)return null;const r=()=>{switch(s){case B.COMPLETE:return e.jsx(_t,{className:"w-6 h-6 text-green-500"});case B.ERROR:return e.jsx(fn,{className:"w-6 h-6 text-red-500"});default:return e.jsx(ql,{variant:"spinner",size:"lg"})}},o=()=>{switch(s){case B.COMPLETE:return"text-green-600 dark:text-green-400";case B.ERROR:return"text-red-600 dark:text-red-400";default:return"text-blue-600 dark:text-blue-400"}};return e.jsxs(Be,{open:!0,children:[e.jsx(Gn,{className:"bg-black/50 backdrop-blur-sm"}),e.jsx(He,{className:"max-w-md w-full mx-4 p-8",children:e.jsxs("div",{className:"text-center space-y-6",children:[e.jsx("div",{className:"flex justify-center",children:r()}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-slate-100",children:s===B.COMPLETE?"Welcome!":"Signing you in..."}),e.jsx("p",{className:`text-sm font-medium ${o()}`,children:t}),s!==B.COMPLETE&&s!==B.ERROR&&e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:"This may take a few moments"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(Wl,{value:a,className:`${s===B.ERROR?"bg-red-100 dark:bg-red-900/20":s===B.COMPLETE?"bg-green-100 dark:bg-green-900/20":"bg-blue-100 dark:bg-blue-900/20"}`}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500 dark:text-slate-400",children:[e.jsxs("div",{className:`flex items-center gap-2 ${s===B.AUTHENTICATING?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===B.AUTHENTICATING?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:"Authenticating"})]}),e.jsxs("div",{className:`flex items-center gap-2 ${s===B.VERIFYING_EMAIL?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===B.VERIFYING_EMAIL?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:"Verifying"})]}),e.jsxs("div",{className:`flex items-center gap-2 ${s===B.INITIALIZING_DATA?"text-blue-600 dark:text-blue-400":""}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s===B.INITIALIZING_DATA?"bg-blue-500":"bg-slate-300 dark:bg-slate-600"}`}),e.jsx("span",{children:"Setting up"})]})]})]})]})})]})},Yl=()=>{const{signInWithGoogle:s,signInWithEmail:t,sendSignUpLink:a,sendPasswordReset:n,sendEmailVerification:r,isAuthenticating:o}=Me(),[i,l]=h.useState(""),[c,d]=h.useState(""),[u,m]=h.useState(""),[x,p]=h.useState(!1),[g,f]=h.useState(""),[b,v]=h.useState(""),[y,I]=h.useState(!1),[C,w]=h.useState(!1),[k,R]=h.useState(null),E=async()=>{try{f(""),await s()}catch(V){switch(console.error("Google login failed:",V),V.code){case"auth/popup-closed-by-user":f("Sign-in was cancelled. Please try again.");break;case"auth/popup-blocked":f("Popup was blocked. Please allow popups and try again.");break;case"auth/network-request-failed":f("Network error. Please check your connection and try again.");break;case"auth/too-many-requests":f("Too many failed attempts. Please try again later.");break;default:f("Google sign-in failed. Please try again.")}}},S=async()=>{if(!i||!c){f("Please fill in all fields");return}if(x){if(!u){f("Please confirm your password");return}if(c!==u){f("Passwords do not match");return}if(c.length<6){f("Password must be at least 6 characters long");return}}try{f(""),v(""),x?(Ie.loading("Creating your account...",{id:"creating-account",duration:1e3}),(await a(i,c)).verificationSent&&(R({email:i}),w(!0),f(""),v(""),Ie.success("Account created! Please check your email to verify your account.",{id:"creating-account",duration:3e3}))):(Ie.loading("Signing you in...",{id:"signing-in",duration:1e3}),await t(i,c),Ie.success("Login successful! Welcome back!",{id:"signing-in",duration:1500}))}catch(V){console.error("Email auth failed:",V),v("");const ne=V;let J="";switch(ne.code){case"auth/user-not-found":J="No account found with this email address";break;case"auth/wrong-password":J="Incorrect password";break;case"auth/invalid-credential":J="Invalid email or password. Please check your credentials and try again.";break;case"auth/email-already-in-use":J="An account with this email already exists";break;case"auth/weak-password":J="Password should be at least 6 characters";break;case"auth/invalid-email":J="Invalid email address";break;case"auth/user-disabled":J="This account has been disabled. Please contact support.";break;case"auth/too-many-requests":J="Too many failed attempts. Please try again later.";break;case"auth/network-request-failed":J="Network error. Please check your connection and try again.";break;case"auth/operation-not-allowed":J="This sign-in method is not enabled. Please try a different method.";break;default:ne.message==="EMAIL_NOT_VERIFIED"?J="Please verify your email address before signing in. Check your inbox for a verification link.":ne.message==="EMAIL_NOT_VERIFIED_RESENT"?J="Please verify your email address before signing in. We've sent a new verification link to your inbox.":ne.message==="EMAIL_ALREADY_VERIFIED"?J="This email is already verified. Please sign in instead.":ne.message==="ACCOUNT_EXISTS_WRONG_PASSWORD"?J="An account with this email already exists, but the password is incorrect. Please check your password or try signing in.":J="Authentication failed. Please check your credentials and try again."}f(J),Ie.error(J,{id:x?"creating-account":"signing-in",duration:4e3})}},M=async()=>{if(!i){f("Please enter your email address first");return}try{f(""),await n(i),I(!0)}catch(V){switch(console.error("Password reset failed:",V),V.code){case"auth/user-not-found":f("No account found with this email address");break;case"auth/invalid-email":f("Invalid email address");break;case"auth/too-many-requests":f("Too many reset attempts. Please try again later.");break;case"auth/network-request-failed":f("Network error. Please check your connection and try again.");break;default:f("Failed to send password reset email. Please try again.")}}},A=async()=>{if(!k){f("No pending user found");return}try{f(""),await r(),w(!0)}catch(V){switch(console.error("Resend verification failed:",V),V.code){case"auth/too-many-requests":f("Too many verification attempts. Please try again later.");break;case"auth/network-request-failed":f("Network error. Please check your connection and try again.");break;default:f("Failed to resend verification email. Please try again.")}}},Y=()=>{p(!x),f(""),I(!1),w(!1),R(null),m("")},L=()=>{w(!1),R(null),p(!1),f(""),d(""),m("")},{isGoogleAuthSupported:Ae}=ha();return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-slate-900 dark:to-slate-800 flex",children:[e.jsxs("div",{className:"flex-1 flex items-center justify-center p-8 relative",children:[e.jsxs("div",{className:"absolute top-8 left-8 flex items-center gap-3 z-10",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-600 via-teal-600 to-cyan-600 flex items-center justify-center shadow-lg",children:e.jsx(it,{className:"w-5 h-5 text-white"})}),e.jsx("span",{className:"text-xl font-bold bg-gradient-to-r from-slate-900 via-slate-800 to-slate-700 dark:from-slate-100 dark:via-slate-200 dark:to-slate-300 bg-clip-text text-transparent",children:"StillRoot"})]}),e.jsxs("div",{className:"w-full max-w-md",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-96 h-96 rounded-full bg-gradient-to-br from-emerald-100/30 to-cyan-100/30 dark:from-emerald-900/20 dark:to-cyan-900/20 animate-pulse"})}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 p-8 relative backdrop-blur-sm",children:[Ae&&e.jsxs(e.Fragment,{children:[e.jsx(Vl,{onGoogleLogin:E,isAuthenticating:o}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("div",{className:"w-full border-t border-slate-200 dark:border-slate-600"})}),e.jsx("div",{className:"relative flex justify-center text-sm",children:e.jsx("span",{className:"px-2 bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400",children:"or"})})]})]}),e.jsx(Bl,{email:i,password:c,confirmPassword:u,isSignUp:x,isAuthenticating:o,error:g,statusMessage:b,onEmailChange:l,onPasswordChange:d,onConfirmPasswordChange:m,onToggleSignUp:Y,onPasswordReset:M,onSubmit:S}),e.jsx(Kl,{}),e.jsx(zl,{error:"",isPasswordReset:y,isEmailVerificationSent:C,email:i,onResendVerification:A,onBackToSignIn:L,isAuthenticating:o}),e.jsx(Hl,{})]})]})]}),e.jsx(Gl,{})]})},G=({className:s,children:t})=>t?e.jsx("div",{className:j("animate-pulse",s),children:t}):e.jsx("div",{className:j("animate-pulse rounded-md bg-slate-200 dark:bg-slate-700",s)}),Xl=()=>e.jsxs("div",{className:"h-screen bg-white dark:bg-slate-900",children:[e.jsx("div",{className:"h-16 bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700",children:e.jsxs("div",{className:"flex items-center h-full px-4",children:[e.jsx(G,{className:"w-8 h-8 rounded-lg"}),e.jsx(G,{className:"w-32 h-6 ml-4"}),e.jsxs("div",{className:"ml-auto flex items-center space-x-4",children:[e.jsx(G,{className:"w-8 h-8 rounded-full"}),e.jsx(G,{className:"w-20 h-8 rounded-md"})]})]})}),e.jsxs("div",{className:"flex h-[calc(100vh-4rem)]",children:[e.jsx("div",{className:"w-16 bg-slate-50 dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700",children:e.jsx("div",{className:"py-4 space-y-4",children:[1,2,3,4,5].map(s=>e.jsx("div",{className:"flex justify-center",children:e.jsx(G,{className:"w-10 h-10 rounded-lg"})},s))})}),e.jsx("div",{className:"flex-1 p-6",children:e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"w-48 h-8"}),e.jsx(G,{className:"w-96 h-4"})]}),[1,2,3].map(s=>e.jsx("div",{className:"p-6 border border-slate-200 dark:border-slate-700 rounded-lg",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(G,{className:"w-3/4 h-5"}),e.jsx(G,{className:"w-full h-4"}),e.jsx(G,{className:"w-2/3 h-4"}),e.jsxs("div",{className:"flex space-x-2 pt-2",children:[e.jsx(G,{className:"w-16 h-6 rounded-full"}),e.jsx(G,{className:"w-20 h-6 rounded-full"})]})]})},s))]})})]})]}),Ds=({...s})=>e.jsx($i,{position:"top-right",duration:1400,className:"toaster group",...s});function We({className:s,...t}){return e.jsx("div",{"data-slot":"card",className:j("bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",s),...t})}function jt({className:s,...t}){return e.jsx("div",{"data-slot":"card-header",className:j("@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",s),...t})}function Nt({className:s,...t}){return e.jsx("div",{"data-slot":"card-title",className:j("leading-none font-semibold",s),...t})}function Ct({className:s,...t}){return e.jsx("div",{"data-slot":"card-description",className:j("text-muted-foreground text-sm",s),...t})}function kt({className:s,...t}){return e.jsx("div",{"data-slot":"card-content",className:j("px-6",s),...t})}const Jl=()=>{const[s,t]=h.useState(null),[a,n]=h.useState(!1),[r,o]=h.useState(!1);h.useEffect(()=>{const c=m=>{m.preventDefault(),t(m),!r&&localStorage.getItem("pwa-install-dismissed")!=="true"&&n(!0)},d=()=>{o(!0),n(!1),t(null)};return(()=>{const m=window.matchMedia("(display-mode: standalone)").matches,x=window.navigator.standalone===!0,p=m||x;o(p),p&&n(!1)})(),window.addEventListener("beforeinstallprompt",c),window.addEventListener("appinstalled",d),()=>{window.removeEventListener("beforeinstallprompt",c),window.removeEventListener("appinstalled",d)}},[r]);const i=async()=>{if(!s)return;s.prompt();const{outcome:c}=await s.userChoice;console.log(c==="accepted"?"PWA installation accepted":"PWA installation dismissed"),t(null),n(!1)},l=()=>{n(!1),localStorage.setItem("pwa-install-dismissed","true")};return r||!a||localStorage.getItem("pwa-install-dismissed")==="true"?null:e.jsx("div",{className:"fixed bottom-4 left-4 right-4 z-50 md:left-auto md:right-4 md:max-w-sm",children:e.jsxs(We,{className:"border-2 border-blue-500 shadow-lg",children:[e.jsxs(jt,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Nt,{className:"text-lg",children:"Install StillRoot"}),e.jsx(N,{variant:"ghost",size:"sm",onClick:l,className:"h-6 w-6 p-0",children:e.jsx(Z,{className:"h-4 w-4"})})]}),e.jsx(Ct,{children:"Install StillRoot for a better experience with offline access and faster loading."})]}),e.jsx(kt,{className:"pt-0",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{onClick:i,className:"flex-1",children:"Install App"}),e.jsx(N,{variant:"outline",onClick:l,children:"Maybe Later"})]})})]})})},Ql=()=>{const[s,t]=h.useState(!1),[a,n]=h.useState(!1);h.useEffect(()=>{const i=()=>{t(!0)};return"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",l=>{l.data&&l.data.type==="SW_UPDATE_AVAILABLE"&&t(!0)}),()=>{"serviceWorker"in navigator&&navigator.serviceWorker.removeEventListener("message",i)}},[]);const r=async()=>{n(!0);try{if("serviceWorker"in navigator){const i=await navigator.serviceWorker.getRegistration();i&&i.waiting&&i.waiting.postMessage({type:"SKIP_WAITING"})}window.location.reload()}catch(i){console.error("Failed to update app:",i),n(!1)}},o=()=>{t(!1)};return s?e.jsx("div",{className:"fixed top-4 left-4 right-4 z-50 md:left-auto md:right-4 md:max-w-sm",children:e.jsxs(We,{className:"border-2 border-green-500 shadow-lg",children:[e.jsxs(jt,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Nt,{className:"text-lg flex items-center gap-2",children:[e.jsx(as,{className:"h-5 w-5"}),"Update Available"]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:o,className:"h-6 w-6 p-0",children:e.jsx(Z,{className:"h-4 w-4"})})]}),e.jsx(Ct,{children:"A new version of StillRoot is available. Update now for the latest features and improvements."})]}),e.jsx(kt,{className:"pt-0",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{onClick:r,disabled:a,className:"flex-1",children:a?e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"mr-2 h-4 w-4 animate-spin"}),"Updating..."]}):"Update Now"}),e.jsx(N,{variant:"outline",onClick:o,children:"Later"})]})})]})}):null},Zl=()=>{const[s,t]=h.useState({isInstalled:!1,isOnline:navigator.onLine,isUpdateAvailable:!1,installPrompt:null});return h.useEffect(()=>{const r=()=>{const u=window.matchMedia("(display-mode: standalone)").matches,m=window.navigator.standalone===!0;t(x=>({...x,isInstalled:u||m}))},o=()=>t(u=>({...u,isOnline:!0})),i=()=>t(u=>({...u,isOnline:!1})),l=u=>{u.preventDefault(),t(m=>({...m,installPrompt:u}))},c=()=>{t(u=>({...u,isInstalled:!0,installPrompt:null}))},d=()=>{t(u=>({...u,isUpdateAvailable:!0}))};return r(),window.addEventListener("online",o),window.addEventListener("offline",i),window.addEventListener("beforeinstallprompt",l),window.addEventListener("appinstalled",c),"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",u=>{u.data&&u.data.type==="SW_UPDATE_AVAILABLE"&&d()}),()=>{window.removeEventListener("online",o),window.removeEventListener("offline",i),window.removeEventListener("beforeinstallprompt",l),window.removeEventListener("appinstalled",c)}},[]),{...s,installApp:async()=>{if(!s.installPrompt)return!1;try{const r=s.installPrompt;r.prompt();const{outcome:o}=await r.userChoice;return o==="accepted"?(t(i=>({...i,installPrompt:null})),!0):!1}catch(r){return console.error("Failed to install app:",r),!1}},updateApp:async()=>{try{if("serviceWorker"in navigator){const r=await navigator.serviceWorker.getRegistration();r&&r.waiting&&r.waiting.postMessage({type:"SKIP_WAITING"})}window.location.reload()}catch(r){console.error("Failed to update app:",r)}}}},ec=aa("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 dark:bg-destructive/60",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function oe({className:s,variant:t,asChild:a=!1,...n}){const r=a?un:"span";return e.jsx(r,{"data-slot":"badge",className:j(ec({variant:t}),s),...n})}const tc=()=>{const{isInstalled:s,isOnline:t,isUpdateAvailable:a}=Zl();return s&&t&&!a?null:e.jsxs("div",{className:"fixed top-4 right-4 z-40 flex gap-2",children:[!t&&e.jsxs(oe,{variant:"destructive",className:"flex items-center gap-1",children:[e.jsx(ko,{className:"h-3 w-3"}),"Offline"]}),a&&e.jsxs(oe,{variant:"default",className:"flex items-center gap-1",children:[e.jsx(as,{className:"h-3 w-3"}),"Update Available"]})]})},Qn=()=>{const{currentUser:s,isInitializing:t,isRefreshing:a,initAuthListener:n}=Me();return h.useEffect(()=>{let r;return(async()=>{r=await n()})(),()=>{r&&r()}},[n]),{user:s,isInitializing:t,isRefreshing:a}},Oe=de(s=>({targetPath:null,currentPath:"/",navigate:t=>s({targetPath:t}),setCurrentPath:t=>s({currentPath:t})})),sc=()=>{const s=Ui(),t=Fi(),a=Oe(r=>r.targetPath),n=Oe(r=>r.currentPath);h.useEffect(()=>{a&&(s(a),Oe.getState().navigate(null))},[a,s]),h.useEffect(()=>{t.pathname!==n&&Oe.getState().setCurrentPath(t.pathname)},[t.pathname,n])},ft=new Bi,ac=s=>{const[t,a]=h.useState(!1),n=h.useRef(new Set);return h.useEffect(()=>{s.forEach(r=>{const o=r.manifest.id;ft.getExtension(o)||ft.registerExtension(r)})},[s]),h.useEffect(()=>{const r=new Set(s.map(l=>l.manifest.id)),o=n.current;s.forEach(l=>{const c=l.manifest.id;o.has(c)||(ft.activateExtension(c),o.add(c))}),Array.from(o).filter(l=>!r.has(l)).forEach(l=>{ft.deactivateExtension(l),o.delete(l)}),a(!0)},[s]),h.useEffect(()=>()=>{const r=n.current;Array.from(r).forEach(i=>{ft.deactivateExtension(i)}),r.clear()},[]),{initialized:t}},Zn=s=>{sc();const{initialized:t}=ac(s.extensions);return{initialized:t}};function er({className:s}){const{isDarkMode:t,toggleDarkMode:a}=jl();return e.jsx(N,{variant:"ghost",size:"icon",onClick:a,className:j("hover:bg-muted/80",s),title:t?"Switch to light mode":"Switch to dark mode",children:t?e.jsx(bn,{className:"h-[1.2rem] w-[1.2rem]"}):e.jsx(vn,{className:"h-[1.2rem] w-[1.2rem]"})})}const Da={message:it,users:ia,settings:oa,github:Uo,home:$o,search:Ce,file:Ee,folder:Oo,calendar:Po,star:_o,heart:Sn,bookmark:kn,bot:Fe,download:xs,upload:Do,share:Ro,edit:ra,trash:Lo,plus:ae,minus:Ao,check:Ue,x:Z,"chevron-left":To,"chevron-right":Cn,"chevron-up":Pt,"chevron-down":we,menu:Nn,"more-horizontal":ps,"more-vertical":na,sun:bn,moon:vn,monitor:Eo,bell:Mo,user:Os,"log-out":jn,cog:Io,"help-circle":So,info:wn,"alert-circle":fn,"alert-triangle":ns,"check-circle":_t,"x-circle":yn},ga=de()((s,t)=>({icons:Da,addIcon:(a,n)=>(s(r=>({icons:{...r.icons,[a]:n}})),()=>{t().removeIcon(a)}),addIcons:a=>(s(n=>({icons:{...n.icons,...a}})),()=>{Object.keys(a).forEach(n=>{t().removeIcon(n)})}),removeIcon:a=>{s(n=>{const r={...n.icons};return delete r[a],{icons:r}})},getIcon:a=>t().icons[a],reset:()=>{s({icons:Da})}})),nc=s=>ga(t=>t.icons[s]);function _a({id:s,className:t,fallbackIcon:a}){const n=nc(s||"");if(n){const r=n;return e.jsx(r,{className:j("w-4 h-4",t)})}if(a){const r=a;return e.jsx(r,{className:j("w-4 h-4",t)})}return null}const Pa="chat";var Mt=(s=>(s.MAIN="main",s.FOOTER="footer",s))(Mt||{});const nt=de()(ct(s=>({items:[],activeId:void 0,expanded:!1,addItem:t=>(s(a=>({items:[...a.items,t]})),()=>{s(a=>({items:a.items.filter(n=>n.id!==t.id)}))}),removeItem:t=>{s(a=>({items:a.items.filter(n=>n.id!==t),activeId:a.activeId===t?a.items.find(n=>n.id!==t)?.id||Pa:a.activeId}))},updateItem:(t,a)=>{s(n=>({items:n.items.map(r=>r.id===t?{...r,...a}:r)}))},setActiveId:t=>{s(a=>{const n=a.items.map(r=>({...r,isActive:r.id===t}));return{activeId:t,items:n}})},toggleExpanded:()=>{s(t=>({expanded:!t.expanded}))},setExpanded:t=>{s({expanded:t})},reset:()=>{s({items:[],activeId:Pa,expanded:!1})}}),{name:"activity-bar-store",partialize:s=>({expanded:s.expanded})})),tr=()=>{const{currentUser:s,signInWithGoogle:t,signOut:a}=Me(),{isGoogleAuthSupported:n}=ha(),r=async()=>{await t()},o=async()=>{await a()};return s?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm",children:["Hello, ",s.displayName]}),e.jsx(N,{onClick:o,variant:"outline",size:"sm",children:"Logout"})]}):n?e.jsx(N,{onClick:r,children:"Sign in with Google"}):e.jsx(N,{disabled:!0,children:"Sign in (Email only)"})};function Oa({className:s,...t}){return e.jsx(Jr,{"data-slot":"avatar",className:j("relative flex size-8 shrink-0 overflow-hidden rounded-full",s),...t})}function $a({className:s,...t}){return e.jsx(Qr,{"data-slot":"avatar-image",className:j("aspect-square size-full",s),...t})}function Ua({className:s,...t}){return e.jsx(Zr,{"data-slot":"avatar-fallback",className:j("bg-muted flex size-full items-center justify-center rounded-full",s),...t})}function Et({...s}){return e.jsx(to,{"data-slot":"popover",...s})}function Tt({...s}){return e.jsx(eo,{"data-slot":"popover-trigger",...s})}function At({className:s,align:t="center",sideOffset:a=4,...n}){return e.jsx(so,{children:e.jsx(ao,{"data-slot":"popover-content",align:t,sideOffset:a,className:j("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",s),...n})})}function Fa({...s}){return e.jsx(no,{"data-slot":"popover-close",...s})}function cs({delayDuration:s=0,...t}){return e.jsx(ro,{"data-slot":"tooltip-provider",delayDuration:s,...t})}function za({...s}){return e.jsx(cs,{children:e.jsx(oo,{"data-slot":"tooltip",...s})})}function Ba({...s}){return e.jsx(io,{"data-slot":"tooltip-trigger",...s})}function Ha({className:s,sideOffset:t=0,children:a,...n}){return e.jsx(lo,{children:e.jsxs(co,{"data-slot":"tooltip-content",sideOffset:t,className:j("bg-primary text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",s),...n,children:[a,e.jsx(uo,{className:"bg-primary fill-primary z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]"})]})})}const rc=({user:s})=>{const[t,a]=h.useState(!1);if(!s)return e.jsx(cs,{children:e.jsxs(za,{children:[e.jsx(Ba,{asChild:!0,children:e.jsx("div",{className:"px-2 py-1",children:e.jsx(tr,{})})}),e.jsx(Ha,{side:"right",children:e.jsx("p",{children:"Sign in to sync your data"})})]})});const n=async()=>{try{await fe.signOut(),a(!1)}catch(r){console.error("Logout failed:",r)}};return e.jsx(cs,{children:e.jsxs(za,{children:[e.jsx(Ba,{asChild:!0,children:e.jsxs(Et,{open:t,onOpenChange:a,children:[e.jsx(Tt,{asChild:!0,children:e.jsx(N,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800",children:e.jsxs(Oa,{className:"h-6 w-6",children:[e.jsx($a,{src:s.photoURL||void 0,alt:"User avatar"}),e.jsx(Ua,{className:"text-xs",children:s.displayName?.charAt(0)||s.email?.charAt(0)||"U"})]})})}),e.jsx(At,{side:"right",className:"w-64 p-3",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 pb-2 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs(Oa,{className:"h-10 w-10",children:[e.jsx($a,{src:s.photoURL||void 0,alt:"User avatar"}),e.jsx(Ua,{children:s.displayName?.charAt(0)||s.email?.charAt(0)||"U"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.displayName||"User"}),e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 truncate",children:s.email})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsxs(N,{variant:"outline",size:"sm",className:"w-full justify-start gap-2",onClick:n,children:[e.jsx(jn,{className:"h-4 w-4"}),"Sign Out"]})})]})})]})}),e.jsx(Ha,{side:"right",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-medium",children:s.displayName||"User"}),e.jsx("p",{className:"text-xs text-slate-400",children:s.email}),e.jsx("p",{className:"text-xs text-slate-500",children:"Click to manage account"})]})})]})})},sr=()=>{const{user:s}=Qn();return s?e.jsx(rc,{user:s}):e.jsx(tr,{})};function oc({className:s}){const{activeId:t,setActiveId:a,items:n}=nt(),r=n.filter(l=>l.group===Mt.MAIN),o=n.filter(l=>l.group===Mt.FOOTER),i=l=>{a(l)};return e.jsx("div",{className:j("relative flex-shrink-0 h-full","bg-sidebar border-none","shadow-md",s),children:e.jsxs(Ge.Root,{toggleable:!1,expanded:!1,activeId:t,expandedWidth:240,onExpandedChange:()=>{},onActiveChange:i,className:"relative z-10 h-full bg-transparent border-none",children:[e.jsx(Ge.Header,{icon:e.jsx("div",{className:"flex items-center justify-center w-6 h-6",children:e.jsx(Fo,{className:"w-5 h-5"})}),title:"StillRoot",showSearch:!1,showSeparator:!1,className:"bg-sidebar"}),e.jsx(Ge.GroupList,{showSeparator:!1,children:e.jsx(Ge.Group,{title:"main",children:r.map(l=>e.jsx(Ge.Item,{id:l.id,className:"activity-bar-item",activeClassName:"bg-sidebar-accent text-sidebar-accent-foreground shadow-sm",collapsedLabel:l.collapsedLabel,icon:e.jsx("div",{"data-testid":l.id,className:j("flex items-center justify-center"),children:e.jsx(_a,{id:l.icon})}),onClick:l.onClick,label:l.label,title:l.title},l.id))})}),e.jsxs(Ge.Footer,{className:"bg-sidebar",children:[e.jsx("div",{className:"px-2 py-2 flex justify-center",children:e.jsx(sr,{})}),e.jsx("div",{className:"px-2 py-2 flex justify-center",children:e.jsx(er,{})}),o.map(l=>e.jsx(Ge.Item,{id:l.id,className:"activity-bar-item",collapsedLabel:l.collapsedLabel,icon:e.jsx("div",{"data-testid":l.id,className:j("flex items-center justify-center",l.iconColor||"text-slate-600 dark:text-slate-400"),children:e.jsx(_a,{id:l.icon})}),onClick:l.onClick,label:l.label,title:l.title},l.id))]})]})})}function ar(s,t,a){return a?s.map(n=>n.id===a?{...n,children:n.children?[...n.children,t]:[t]}:n.children?{...n,children:ar(n.children,t,a)}:n):[...s,t]}function nr(s,t,a){return a?s.map(n=>n.id===a?{...n,children:n.children?[...n.children,...t]:t}:n.children?{...n,children:nr(n.children,t,a)}:n):[...s,...t]}function Xt(s,t){return s.filter(a=>a.id!==t).map(a=>a.children?{...a,children:Xt(a.children,t)}:a)}function rr(s,t,a){return s.map(n=>n.id===t?{...n,...a}:n.children?{...n,children:rr(n.children,t,a)}:n)}const js=de()((s,t)=>({routes:[],addRoute:(a,n)=>(s(r=>({routes:ar(r.routes,a,n)})),()=>{s(r=>({routes:Xt(r.routes,a.id)}))}),addRoutes:(a,n)=>(s(r=>({routes:nr(r.routes,a,n)})),()=>{s(r=>({routes:a.reduce((o,i)=>Xt(o,i.id),r.routes)}))}),removeRoute:a=>{s(n=>({routes:Xt(n.routes,a)}))},updateRoute:(a,n)=>{s(r=>({routes:rr(r.routes,a,n)}))},getRoutes:()=>t().routes,reset:()=>s({routes:[]})}));function or(s){return s.sort((t,a)=>(t.order??0)-(a.order??0)).map(t=>e.jsx(Pn,{path:t.path,element:t.element,children:t.children&&or(t.children)},t.id))}const ic=()=>{const s=js(t=>t.routes);return e.jsx(_n,{children:or(s)})},lc=s=>{const{extensions:t}=s,{initialized:a}=Zn({extensions:t});return a?e.jsx("div",{className:"fixed inset-0 flex flex-col",children:e.jsx("div",{className:j("flex flex-col h-full"),children:e.jsxs("div",{className:"flex-1 min-h-0 flex",children:[e.jsx(oc,{className:"flex"}),e.jsx(ic,{})]})})}):e.jsx("div",{children:"Loading..."})};function Ws(s,t={}){const{exact:a=!1,sensitive:n=!1}=t,r=s.replace(/:[^/]+/g,"([^/]+)").replace(/\*/g,".*"),o=n?"":"i";return new RegExp(`^${r}${a?"$":""}`,o)}function ir(s,t,a={}){const n=[...t].sort((r,o)=>{const i=(r.routerPath?.includes(":")||r.routerPaths?.some(u=>u.includes(":")))??!1,l=(o.routerPath?.includes(":")||o.routerPaths?.some(u=>u.includes(":")))??!1,c=(r.routerPath?.includes("*")||r.routerPaths?.some(u=>u.includes("*")))??!1,d=(o.routerPath?.includes("*")||o.routerPaths?.some(u=>u.includes("*")))??!1;return i&&!l?1:!i&&l?-1:c&&!d?1:!c&&d?-1:0});for(const r of n){if(r.routerPath&&Ws(r.routerPath,a).test(s))return r;if(r.routerPaths){for(const o of r.routerPaths)if(Ws(o,a).test(s))return r}if(r.children){const o=ir(s,r.children,a);if(o)return o}}}function Ga(s,t,a={}){const n=ir(s,t,a);n&&nt.getState().setActiveId(n.activityKey)}function Va(s,t,a={}){const n=t.find(c=>c.activityKey===s);if(!n)return;const r=Oe.getState().currentPath;if(!r)return;const o=[];n.routerPath&&o.push(n.routerPath),n.routerPaths&&o.push(...n.routerPaths),n.children&&n.children.forEach(c=>{c.routerPath&&o.push(c.routerPath),c.routerPaths&&o.push(...c.routerPaths)});for(const c of o)if(Ws(c,a).test(r))return;const l=o.sort((c,d)=>{const u=c.includes(":"),m=d.includes(":"),x=c.includes("*"),p=d.includes("*");return!u&&m?-1:u&&!m?1:!x&&p?-1:x&&!p?1:c.length-d.length})[0];l&&Oe.getState().navigate(l)}function cc(s,t={}){const a=Oe.getState().currentPath;return a&&Ga(a,s,t),Oe.subscribe((n,r)=>{if(n.currentPath===r.currentPath)return;const o=n.currentPath;o&&Ga(o,s,t)})}function dc(s){const t=nt.getState().activeId;return t&&Va(t,s),nt.subscribe((a,n)=>{if(a.activeId===n.activeId)return;const r=a.activeId;r&&Va(r,s)})}function lr(s,t={}){const a=cc(s,t),n=dc(s);return()=>{a(),n()}}var Ks=(s=>(s.DESKTOP="desktop",s.MOBILE="mobile",s))(Ks||{}),cr=(s=>(s.TEXT="text",s.IMAGE="image",s.FILE="file",s))(cr||{}),Jt=(s=>(s.NAME="name",s.DESCRIPTION="description",s.EMOJI="emoji",s))(Jt||{}),dr=(s=>(s.BUTTON="button",s.HOTKEY="hotkey",s.AUTO="auto",s))(dr||{}),ur=(s=>(s.LEFT="left",s.RIGHT="right",s))(ur||{}),Ys=(s=>(s.OPEN="open",s.CLOSE="close",s))(Ys||{}),Xs=(s=>(s.COLLAPSE="collapse",s.EXPAND="expand",s))(Xs||{});class uc{logEvent=(t,a)=>{const n=U.getAnalytics();if(n)try{gi(n,t,a)}catch(r){console.error("[Analytics] Failed to log event",r)}};setUserProperties=t=>{const a=U.getAnalytics();a&&pi(a,t)};logAppStart=(t,a)=>{this.logEvent("app_start",{platform:t,version:a})};logAppClose=t=>{this.logEvent("app_close",{session_duration:t})};logChannelCreate=(t,a,n)=>{this.logEvent("channel_create",{channel_id:t,channel_name:a,has_description:n})};logChannelSelect=(t,a,n)=>{this.logEvent("channel_select",{channel_id:t,channel_name:a,message_count:n})};logChannelEdit=(t,a)=>{this.logEvent("channel_edit",{channel_id:t,field:a})};logChannelDelete=(t,a,n)=>{this.logEvent("channel_delete",{channel_id:t,channel_name:a,message_count:n})};logMessageSend=(t,a,n,r)=>{this.logEvent("message_send",{channel_id:t,message_type:a,content_length:n,has_tags:r})};logMessageEdit=(t,a,n)=>{this.logEvent("message_edit",{message_id:t,channel_id:a,edit_count:n})};logMessageDelete=(t,a,n)=>{this.logEvent("message_delete",{message_id:t,channel_id:a,message_age:n})};logMessageReply=(t,a,n)=>{this.logEvent("message_reply",{message_id:t,channel_id:a,thread_id:n})};logAIAssistantOpen=(t,a)=>{this.logEvent("ai_assistant_open",{channel_id:t,trigger:a})};logAIAssistantClose=(t,a,n)=>{this.logEvent("ai_assistant_close",{channel_id:t,session_duration:a,message_count:n})};logAIMessageSend=(t,a,n)=>{this.logEvent("ai_message_send",{channel_id:t,message_length:a,context_mode:n})};logAIMessageReceive=(t,a,n,r)=>{this.logEvent("ai_message_receive",{channel_id:t,response_length:a,response_time:n,tool_used:r})};logAIToolUse=(t,a,n)=>{this.logEvent("ai_tool_use",{tool_name:t,channel_id:a,success:n})};logThreadOpen=(t,a,n)=>{this.logEvent("thread_open",{message_id:t,channel_id:a,thread_count:n})};logThreadClose=(t,a,n)=>{this.logEvent("thread_close",{message_id:t,channel_id:a,session_duration:n})};logThreadReply=(t,a,n)=>{this.logEvent("thread_reply",{message_id:t,channel_id:a,thread_id:n})};logSearchStart=(t,a)=>{this.logEvent("search_start",{query:t,channel_id:a,search_scope:a?"channel":"global"})};logSearchResult=(t,a,n)=>{this.logEvent("search_result",{query:t,result_count:a,channel_id:n,search_scope:n?"channel":"global"})};logSearchSelect=(t,a,n)=>{this.logEvent("search_select",{query:t,result_index:a,channel_id:n,search_scope:n?"channel":"global"})};logSidebarToggle=(t,a)=>{this.logEvent("sidebar_toggle",{sidebar:t,action:a})};logInputCollapse=t=>{this.logEvent("input_collapse",{action:t})};logScrollToBottom=(t,a)=>{this.logEvent("scroll_to_bottom",{channel_id:t,message_count:a})};logMessageExpand=(t,a,n)=>{this.logEvent("message_expand",{message_id:t,channel_id:a,content_length:n})};logSettingsOpen=t=>{this.logEvent("settings_open",{channel_id:t})};logThemeChange=t=>{this.logEvent("theme_change",{theme:t})};logContextModeChange=(t,a)=>{this.logEvent("context_mode_change",{mode:t,channel_id:a})};logPageLoad=(t,a,n)=>{this.logEvent("page_load",{page:t,load_time:a,platform:n})};logMessageLoad=(t,a,n)=>{this.logEvent("message_load",{channel_id:t,message_count:a,load_time:n})};logVirtualizationPerformance=(t,a,n,r)=>{this.logEvent("virtualization_performance",{channel_id:t,visible_count:a,total_count:n,render_time:r})};logError=(t,a,n,r)=>{this.logEvent("error_occurred",{error_type:t,error_message:a,component:n,channel_id:r})};logAIFailure=(t,a,n)=>{this.logEvent("ai_failure",{channel_id:t,error_type:a,retry_count:n})};logDailyActive=(t,a,n)=>{this.logEvent("daily_active",{message_count:t,channel_count:a,ai_usage_count:n})};logSessionMetrics=(t,a,n,r)=>{this.logEvent("session_metrics",{session_duration:t,message_count:a,ai_interaction_count:n,channel_count:r})};logFeatureUsage=(t,a,n)=>{this.logEvent("feature_usage",{feature:t,action:a,channel_id:n})};logExport=(t,a,n)=>{this.logEvent("export",{format:t,channel_id:a,message_count:n})};logTagUse=(t,a,n)=>{this.logEvent("tag_use",{tag:t,channel_id:a,action:n})};logHotkeyUse=(t,a)=>{this.logEvent("hotkey_use",{hotkey:t,context:a})};logMobileGesture=(t,a)=>{this.logEvent("mobile_gesture",{gesture:t,action:a})};logPWAInstall=t=>{this.logEvent("pwa_install",{platform:t})};logPWAUpdate=t=>{this.logEvent("pwa_update",{version:t})};logBatchOperation=(t,a,n)=>{this.logEvent("batch_operation",{operation:t,item_count:a,channel_id:n})};logFeedback=(t,a,n)=>{this.logEvent("feedback",{type:t,rating:a,channel_id:n})}}const ce=new uc,hr=h.createContext(null),hc=()=>{const s=h.useContext(hr);if(!s)throw new Error("useCollapsibleSidebar must be used within CollapsibleSidebar");return s},mc=({children:s,width:t="w-80",collapsedWidth:a="w-0",className:n="",collapsed:r,onCollapseChange:o})=>{const[i,l]=h.useState(!1),c=r!==void 0?r:i,d=()=>{const m=!c;ce.logSidebarToggle(ur.LEFT,m?Ys.CLOSE:Ys.OPEN),r===void 0&&l(m),o?.(m)};h.useEffect(()=>{r!==void 0&&l(r)},[r]);const u={isCollapsed:c,toggleCollapse:d,onCollapseChange:o};return e.jsx(hr.Provider,{value:u,children:e.jsx("div",{"data-component":"collapsible-sidebar",className:j("flex-shrink-0 transition-all duration-300 ease-in-out overflow-hidden",c?a:t,n),children:e.jsx("div",{className:j("h-full flex flex-col transition-opacity duration-300",c?"opacity-0":"opacity-100"),children:s})})})},gc=({children:s,className:t=""})=>e.jsx("div",{className:j("flex items-center justify-between p-3 border-b border-border",t),children:s}),pc=({className:s="",children:t})=>{const{isCollapsed:a,toggleCollapse:n}=hc();return e.jsx(N,{variant:"ghost",size:"sm",onClick:n,className:j("h-8 w-8 hover:bg-accent transition-all duration-300",a?"opacity-0 scale-95":"opacity-100 scale-100",s),title:a?"Expand sidebar":"Collapse sidebar",children:t||e.jsx(rs,{className:"h-4 w-4"})})},xc=({children:s,className:t=""})=>e.jsx("div",{"data-component":"collapsible-sidebar-content",className:j("flex-1 overflow-hidden",t),children:s}),ds=Object.assign(mc,{Header:gc,ToggleButton:pc,Content:xc}),mr=()=>{const s=T(o=>o.channels),t=La(s),a=O(o=>o.setCurrentChannel),n=O(o=>o.currentChannelId),r=La(n);h.useEffect(()=>{const o=t.pipe(bs(i=>i.length>0),Li(1),Ri(r)).subscribe(([i,l])=>{i.length>0&&!l&&a(i[0].id)});return()=>o.unsubscribe()},[t,r,a])},qa={general:et,work:Go,study:Ho,ideas:lt,personal:Sn,goals:Bo,team:ia,default:zo},gr=s=>{const t=qa[s]||qa.default;return e.jsx(t,{className:"w-4 h-4"})};function tt({className:s,...t}){return e.jsx(ho,{"data-slot":"label",className:j("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",s),...t})}const fc=h.createContext(null),bc=({children:s,open:t,onOpenChange:a,modal:n})=>{const[r,o]=h.useState(!1),i=t!==void 0?t:r,l=a||o,c={isOpen:i,onOpenChange:l};return e.jsx(fc.Provider,{value:c,children:e.jsx(Et,{open:i,onOpenChange:l,modal:n,children:s})})},vc=({children:s,className:t=""})=>e.jsx("div",{className:j("flex items-center gap-2.5 mb-5",t),children:s}),yc=({children:s,className:t=""})=>e.jsx("div",{className:j("space-y-4",t),children:s}),wc=({children:s,className:t=""})=>e.jsx("div",{className:j("flex justify-end gap-2.5 pt-3 mt-2",t),children:s}),jc=Tt,pr=h.forwardRef(({className:s,variant:t="default",size:a="md",...n},r)=>{const o="h-8 px-4 rounded-lg text-sm transition-all duration-200 font-medium flex items-center justify-center",i={default:"bg-primary text-primary-foreground hover:bg-primary/90",outline:"text-muted-foreground hover:text-foreground hover:bg-accent/30",ghost:"text-muted-foreground hover:text-foreground hover:bg-accent/30"},l={sm:"h-7 px-3 text-xs",md:"h-8 px-4 text-sm"};return e.jsx("button",{className:j(o,i[t],l[a],"disabled:opacity-50",s),ref:r,...n})});pr.displayName="RefinedPopoverButton";const Nc=({children:s,width:t="w-80",className:a="",align:n="center",side:r="bottom",sideOffset:o=6,onInteractOutside:i})=>e.jsx(At,{className:j(t,"p-4 border border-slate-200/60 dark:border-slate-700/60 shadow-lg bg-popover text-popover-foreground rounded-xl overflow-hidden max-w-[90vw] max-h-[70vh] mr-4 sm:mr-0",a),align:n,side:r,sideOffset:o,onInteractOutside:i,children:s}),P=Object.assign(bc,{Trigger:jc,Content:Nc,Header:vc,Body:yc,Actions:wc,Button:pr});function xr({onSelect:s,children:t}){const[a,n]=h.useState(!1),[r,o]=h.useState(!1);h.useEffect(()=>{const l=()=>{const u=document.documentElement.classList.contains("dark")||window.matchMedia("(prefers-color-scheme: dark)").matches;o(u)};l();const c=new MutationObserver(l);c.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]});const d=window.matchMedia("(prefers-color-scheme: dark)");return d.addEventListener("change",l),()=>{c.disconnect(),d.removeEventListener("change",l)}},[]);const i=l=>{s(l.emoji),n(!1)};return e.jsxs(P,{open:a,onOpenChange:n,children:[e.jsx(P.Trigger,{asChild:!0,children:t}),e.jsx(P.Content,{align:"start",sideOffset:8,className:"p-0",children:e.jsx("div",{className:"w-80",children:e.jsx(Hi,{onEmojiClick:i,autoFocusSearch:!1,searchDisabled:!1,skinTonesDisabled:!1,width:"100%",height:350,theme:r?Sa.DARK:Sa.LIGHT,previewConfig:{showPreview:!1},searchPlaceHolder:"Search emojis...",defaultSkinTone:Vi.NEUTRAL,emojiStyle:Gi.NATIVE,lazyLoadEmojis:!0})})})]})}const Wa=({channel:s,children:t})=>{const[a,n]=h.useState(!1),[r,o]=h.useState(s.name),[i,l]=h.useState(s.description),[c,d]=h.useState(s.emoji||""),[u,m]=h.useState(!1),{updateChannel:x}=T(),p=async()=>{if(r.trim()){m(!0);try{const b=r.trim()!==s.name,v=i.trim()!==(s.description||""),y=c.trim()!==(s.emoji||"");await x(s.id,{name:r.trim(),description:i.trim(),emoji:c.trim()||void 0}),b&&ce.logChannelEdit(s.id,Jt.NAME),v&&ce.logChannelEdit(s.id,Jt.DESCRIPTION),y&&ce.logChannelEdit(s.id,Jt.EMOJI),n(!1)}catch(b){console.error("Error updating channel:",b),o(s.name),l(s.description),d(s.emoji||"")}finally{m(!1)}}},g=()=>{o(s.name),l(s.description),d(s.emoji||""),n(!1)},f=b=>{b.key==="Enter"&&!u?p():b.key==="Escape"&&g()};return e.jsxs(P,{open:a,onOpenChange:n,children:[e.jsx(P.Trigger,{asChild:!0,children:t}),e.jsxs(P.Content,{align:"center",side:"bottom",children:[e.jsxs(P.Header,{children:[e.jsx(Vo,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:"Edit Thought Space"})]}),e.jsx(P.Body,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(tt,{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Emoji"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xr,{value:c,onSelect:d,children:e.jsx(N,{variant:"outline",size:"sm",className:"h-10 w-16 text-lg border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800",children:c||"😊"})}),c&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>d(""),className:"h-10 px-2 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200",children:"Clear"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(tt,{htmlFor:"channel-name",className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Channel Name"}),e.jsx(ye,{id:"channel-name",value:r,onChange:b=>o(b.target.value),onKeyDown:f,placeholder:"Enter channel name",disabled:u,className:"h-10 px-3 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg transition-colors duration-200 focus:border-slate-400 dark:focus:border-slate-500  hover:border-slate-300 dark:hover:border-slate-600"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(tt,{htmlFor:"channel-description",className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Description"}),e.jsx(ye,{id:"channel-description",value:i,onChange:b=>l(b.target.value),onKeyDown:f,placeholder:"Enter channel description",disabled:u,className:"h-10 px-3 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg transition-colors duration-200 focus:border-slate-400 dark:focus:border-slate-500  hover:border-slate-300 dark:hover:border-slate-600"})]})]})}),e.jsxs(P.Actions,{children:[e.jsx(P.Button,{type:"button",variant:"outline",onClick:g,disabled:u,children:"Cancel"}),e.jsx(P.Button,{type:"button",variant:"default",onClick:p,disabled:!r.trim()||u,children:u?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Saving..."]}):"Save"})]})]})]})};function dt({...s}){return e.jsx(mo,{"data-slot":"dropdown-menu",...s})}function ut({...s}){return e.jsx(go,{"data-slot":"dropdown-menu-trigger",...s})}function ht({className:s,sideOffset:t=4,...a}){return e.jsx(po,{children:e.jsx(xo,{"data-slot":"dropdown-menu-content",sideOffset:t,className:j("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",s),...a})})}function Cc({...s}){return e.jsx(yo,{"data-slot":"dropdown-menu-group",...s})}function Ns({className:s,inset:t,variant:a="default",...n}){return e.jsx(vo,{"data-slot":"dropdown-menu-item","data-inset":t,"data-variant":a,className:j("focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",s),...n})}function fr({className:s,inset:t,...a}){return e.jsx(fo,{"data-slot":"dropdown-menu-label","data-inset":t,className:j("px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",s),...a})}function br({className:s,...t}){return e.jsx(bo,{"data-slot":"dropdown-menu-separator",className:j("bg-border -mx-1 my-1 h-px",s),...t})}function kc({children:s,trigger:t,triggerClassName:a,contentClassName:n,align:r="end",sideOffset:o=4,width:i="md",alwaysVisible:l=!1}){const c={sm:"w-44",md:"w-52",lg:"w-60",xl:"w-72"},d=e.jsxs(N,{variant:"ghost",size:"sm",className:j("h-8 w-8 p-0 transition-all duration-200 rounded-md","text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200","hover:bg-slate-100 dark:hover:bg-slate-800","focus:outline-none",l?"opacity-100":"opacity-0 group-hover:opacity-100",a),children:[e.jsx(ps,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"More actions"})]});return e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:t||d}),e.jsx(ht,{align:r,className:j("p-1 rounded-lg border shadow-lg bg-white dark:bg-slate-900","min-w-[200px] max-w-[280px]",c[i],n),sideOffset:o,children:s})]})}function vr({icon:s,title:t,description:a,onClick:n,variant:r="default",disabled:o=!1,className:i}){const l={default:"text-slate-700 dark:text-slate-200 hover:text-slate-900 dark:hover:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-800",destructive:"text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/20",warning:"text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300 hover:bg-amber-50 dark:hover:bg-amber-900/20"},c={default:"text-slate-500 dark:text-slate-400",destructive:"text-red-500 dark:text-red-400",warning:"text-amber-500 dark:text-amber-400"};return e.jsxs(Ns,{onClick:o?void 0:n,disabled:o,className:j("flex items-center gap-3 px-3 py-2 cursor-pointer transition-colors duration-150 group","rounded-md text-sm font-medium",l[r],o&&"opacity-50 cursor-not-allowed",i),children:[e.jsx("div",{className:j("w-4 h-4 flex-shrink-0 transition-colors duration-150",c[r],"group-hover:scale-105"),children:s}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"truncate",children:t}),a&&e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400 truncate mt-0.5",children:a})]})]})}function yr({title:s,children:t,variant:a="default",showSeparator:n=!0,className:r}){const o={default:"text-slate-500 dark:text-slate-400",warning:"text-amber-500 dark:text-amber-400",danger:"text-red-500 dark:text-red-400"};return e.jsxs(e.Fragment,{children:[n&&e.jsx(br,{className:"my-1 bg-slate-200 dark:bg-slate-700"}),e.jsxs(Cc,{className:j("space-y-0.5",r),children:[s&&e.jsx(fr,{className:j("px-3 py-1.5 text-xs font-medium text-slate-500 dark:text-slate-400",o[a]),children:s}),t]})]})}function wr({groups:s,trigger:t,triggerClassName:a,contentClassName:n,align:r="end",sideOffset:o=4,width:i="md",alwaysVisible:l=!1}){const c=s.map(d=>({...d,items:d.items.filter(u=>!u.hidden)})).filter(d=>d.items.length>0);return e.jsx(kc,{trigger:t,triggerClassName:a,contentClassName:n,align:r,sideOffset:o,width:i,alwaysVisible:l,children:c.map((d,u)=>e.jsx(yr,{title:d.title,variant:d.variant,showSeparator:d.showSeparator!==!1&&u>0,children:d.items.map(m=>e.jsx(vr,{icon:m.icon,title:m.title,description:m.description,onClick:m.onClick,variant:m.variant,disabled:m.disabled},m.id))},d.id))})}function jr({groups:s}){const t=s.map(a=>({...a,items:a.items.filter(n=>!n.hidden)})).filter(a=>a.items.length>0);return e.jsx(e.Fragment,{children:t.map((a,n)=>e.jsx(yr,{title:a.title,variant:a.variant,showSeparator:n>0||a.showSeparator===!0,children:a.items.map(r=>e.jsx(vr,{icon:r.icon,title:r.title,description:r.description,onClick:r.onClick,variant:r.variant,className:r.disabled?"opacity-50 cursor-not-allowed":""},r.id))},a.id))})}function Sc({isOpen:s,onOpenChange:t,title:a,description:n,itemName:r,onConfirm:o}){const[i,l]=h.useState(!1),c=async()=>{l(!0);try{await o(),t(!1)}catch(u){console.error("Delete failed:",u)}finally{l(!1)}},d=()=>{t(!1)};return e.jsx(Be,{open:s,onOpenChange:t,children:e.jsxs(He,{className:"sm:max-w-md",children:[e.jsx(ys,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 rounded-full bg-destructive/10",children:e.jsx(ns,{className:"w-5 h-5 text-destructive"})}),e.jsxs("div",{children:[e.jsx(ws,{className:"text-lg font-semibold",children:a}),e.jsx(ua,{className:"text-sm text-muted-foreground mt-1",children:n})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-3 rounded-lg bg-muted/50 border border-muted",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Te,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:r})]})}),e.jsx("div",{className:"p-3 rounded-lg bg-destructive/5 border border-destructive/20",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ns,{className:"w-4 h-4 text-destructive mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-xs text-destructive",children:[e.jsx("p",{className:"font-medium",children:"This action cannot be undone."}),e.jsx("p",{className:"mt-1",children:"All data will be permanently deleted."})]})]})})]}),e.jsxs(da,{className:"gap-2",children:[e.jsx(N,{type:"button",variant:"outline",onClick:d,disabled:i,children:"Cancel"}),e.jsx(N,{type:"button",variant:"destructive",onClick:c,disabled:i,children:i?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Deleting..."]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Te,{className:"w-4 h-4"}),"Delete"]})})]})]})})}function Ka({channel:s,onDelete:t}){const[a,n]=h.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(N,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 hover:bg-slate-200 dark:hover:bg-slate-600",title:"More actions",onClick:r=>r.stopPropagation(),children:e.jsx(na,{className:"h-3 w-3"})})}),e.jsx(ht,{className:"w-56 p-2",align:"end",side:"bottom",onClick:r=>r.stopPropagation(),children:e.jsx(jr,{groups:[{id:"danger",items:[{id:"delete",icon:e.jsx(Te,{}),title:`Delete ${s.name}`,onClick:()=>n(!0),variant:"destructive"}]}]})})]}),e.jsx(Sc,{isOpen:a,onOpenChange:n,title:"Delete Channel",description:"This will permanently delete the channel and all its messages. This action cannot be undone.",itemName:s.name,onConfirm:t})]})}const Ic=({channel:s,isActive:t,onClick:a,onDelete:n})=>{const r=!!(s.description&&s.description.trim());return e.jsx("div",{className:`w-full group transition-all duration-200 cursor-pointer ${t?"transform scale-[1.01]":"hover:transform hover:scale-[1.005]"}`,onClick:a,children:e.jsx("div",{className:`relative p-3 rounded-lg transition-all duration-200 ${t?"bg-card-accent dark:bg-card-accent shadow-sm":"bg-transparent hover:bg-card-accent dark:hover:bg-card-accent"}`,children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0",children:s.emoji?e.jsx("span",{className:"text-lg",title:`Emoji: ${s.emoji}`,children:s.emoji}):gr(s.id)}),e.jsx("div",{className:`flex-1 min-w-0 ${r?"flex flex-col":"flex items-center justify-between"}`,children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:`font-medium truncate ${t?"text-slate-900 dark:text-slate-100":"text-slate-700 dark:text-slate-300"}`,children:s.name}),e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 flex-shrink-0",children:[e.jsx(Wa,{channel:s,children:e.jsx(N,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 hover:bg-slate-200 dark:hover:bg-slate-600",title:"Edit channel",onClick:o=>o.stopPropagation(),children:e.jsx(os,{className:"h-3 w-3"})})}),e.jsx(Ka,{channel:s,onDelete:n})]})]}),e.jsx("p",{className:`text-xs truncate mr-2 ${t?"text-slate-600 dark:text-slate-400":"text-slate-500 dark:text-slate-500"}`,children:s.description})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:`font-medium truncate ${t?"text-slate-900 dark:text-slate-100":"text-slate-700 dark:text-slate-300"}`,children:s.name}),e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 flex-shrink-0",children:[e.jsx(Wa,{channel:s,children:e.jsx(N,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 hover:bg-slate-200 dark:hover:bg-slate-600",title:"Edit channel",onClick:o=>o.stopPropagation(),children:e.jsx(os,{className:"h-3 w-3"})})}),e.jsx(Ka,{channel:s,onDelete:n})]})]})})]})})})},Mc=({onCreateChannel:s})=>e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4",children:e.jsx(ae,{className:"w-8 h-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No spaces yet"}),e.jsx("p",{className:"text-muted-foreground text-sm mb-4 max-w-xs",children:"Create your first thought space to start organizing your ideas and thoughts."}),e.jsx("button",{onClick:()=>s({name:"My First Space",emoji:"🚀",description:"Start your journey here"}),className:"text-sm text-primary hover:text-primary/80 font-medium",children:"Create your first space"})]});function Ec({count:s=12}){return e.jsxs("div",{"data-component":"channel-list",className:"w-full h-full overflow-hidden flex flex-col bg-card shadow-sm",children:[e.jsxs("div",{"data-component":"channel-list-header",className:"h-12 px-4 flex items-center justify-between",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("h3",{className:"text-base font-medium text-slate-900 dark:text-slate-100 truncate",children:"Spaces"})}),e.jsx(ds.ToggleButton,{})]}),e.jsx("div",{"data-component":"channel-list-content",className:"flex-1 overflow-y-auto p-3 space-y-1 min-h-0 channel-list-content",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:Array.from({length:s}).map((t,a)=>e.jsx("div",{className:"w-full group transition-all duration-200 cursor-pointer",children:e.jsx("div",{className:"relative p-3 rounded-lg transition-all duration-200 bg-transparent",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(G,{className:"w-8 h-8 rounded-lg flex-shrink-0"}),e.jsxs("div",{className:"flex-1 text-left min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx(G,{className:"w-20 h-4"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(G,{className:"w-24 h-3"}),e.jsx(G,{className:"w-16 h-3"})]})]}),e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1",children:[e.jsx(G,{className:"w-6 h-6 rounded"}),e.jsx(G,{className:"w-6 h-6 rounded"})]})]})})},a))}),e.jsx("div",{"data-component":"channel-list-footer",className:"p-3 border-t border-slate-200 dark:border-slate-700",children:e.jsx(G,{className:"w-full h-10 rounded-lg"})})]})}function Cs({className:s,...t}){return e.jsx("textarea",{"data-slot":"textarea",className:j("border-input placeholder:text-muted-foreground aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),...t})}function Lt({onAddChannel:s,trigger:t,variant:a="popover"}){const[n,r]=h.useState(!1),[o,i]=h.useState(""),[l,c]=h.useState(""),[d,u]=h.useState(Gs()),m=y=>{y&&y.preventDefault(),o.trim()&&(s({name:o.trim(),description:l.trim(),emoji:d?.trim()||void 0}),r(!1))},x=()=>{i(""),c(""),r(!1)},p=y=>{y.key==="Enter"&&o.trim()?(y.preventDefault(),m()):y.key==="Escape"&&(y.preventDefault(),x())},g=y=>{r(y),y&&(i(""),c(""),u(Gs()))},f=e.jsxs(N,{variant:"outline",className:"w-full h-10 text-muted-foreground hover:text-foreground border-dashed",children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"New Space"]}),b=e.jsxs("div",{className:"space-y-4 pb-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(tt,{htmlFor:"emoji",children:"Emoji"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xr,{onSelect:u,children:e.jsx(N,{type:"button",variant:"outline",size:"sm",className:"h-10 w-16 text-sm",children:d||"Select"})}),d&&e.jsx(N,{type:"button",variant:"ghost",size:"sm",onClick:()=>u(""),className:"h-10 px-2 text-muted-foreground",children:"Clear"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(tt,{htmlFor:"name",children:"Name"}),e.jsx(ye,{id:"name",value:o,onChange:y=>i(y.target.value),onKeyDown:p,placeholder:"Enter space name",required:!0,autoFocus:a==="popover"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(tt,{htmlFor:"description",children:"Description (Optional)"}),a==="dialog"?e.jsx(Cs,{id:"description",value:l,onChange:y=>c(y.target.value),placeholder:"Describe what this space is for",rows:3}):e.jsx(ye,{id:"description",value:l,onChange:y=>c(y.target.value),onKeyDown:p,placeholder:"Describe the theme of this space..."})]})]}),v=e.jsxs(e.Fragment,{children:[e.jsx(P.Button,{type:"button",variant:"outline",onClick:x,children:"Cancel"}),e.jsx(P.Button,{type:"submit",variant:"default",disabled:!o.trim(),onClick:m,children:"Create Space"})]});return a==="dialog"?e.jsxs(Be,{open:n,onOpenChange:g,children:[e.jsx(Hn,{asChild:!0,children:t??f}),e.jsxs(He,{className:"sm:max-w-md",children:[e.jsxs(ys,{children:[e.jsx(ws,{children:"Create New Thought Space"}),e.jsx(ua,{children:"Create a new space for organizing your thoughts and conversations."})]}),e.jsxs("form",{onSubmit:m,children:[b,e.jsx(da,{className:"gap-2 pt-4",children:v})]})]})]}):e.jsxs(P,{open:n,onOpenChange:g,children:[e.jsx(P.Trigger,{asChild:!0,children:t??f}),e.jsxs(P.Content,{align:"center",side:"bottom",children:[e.jsxs(P.Header,{children:[e.jsx(ae,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:"Create New Thought Space"})]}),e.jsx(P.Body,{children:b}),e.jsx(P.Actions,{children:v})]})]})}function Tc({showFadeEffect:s=!1}){const{channels:t,channelsLoading:a,addChannel:n,deleteChannel:r}=T(),{currentChannelId:o,setCurrentChannel:i}=O();mr();const l=h.useRef(null),[c,d]=h.useState(!1),u=async p=>{await n(p),ce.logChannelCreate(p.name,p.name,!!p.description)},m=async p=>{try{const g=t.find(f=>f.id===p);if(g&&ce.logChannelDelete(g.id,g.name,g.messageCount||0),await r(p),o===p&&t.length>1){const f=t.filter(b=>b.id!==p);f.length>0&&(console.log("🔔 [handleDeleteChannel] Switching to first available channel",f[0].id),i(f[0].id))}}catch(g){const f=g instanceof Error?g.message:"Unknown error";alert(`❌ Failed to delete the channel.

Error: ${f}

Please try again.`)}},x=h.useMemo(()=>{const p=g=>{const f=g.lastMessageTime?.getTime(),b=g.updatedAt?.getTime(),v=g.createdAt?.getTime?.()?g.createdAt.getTime():0;return f??b??v??0};return[...t].sort((g,f)=>p(f)-p(g))},[t]);return h.useEffect(()=>{if(l.current){const{scrollHeight:p,clientHeight:g}=l.current;d(p>g)}}),a?e.jsx(Ec,{}):e.jsxs("div",{"data-component":"channel-list",className:"flex flex-col h-full overflow-hidden bg-card shadow-sm",children:[e.jsxs("div",{"data-component":"channel-list-header",className:"h-12 px-4 flex items-center justify-between",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("h3",{className:"text-base font-medium text-slate-900 dark:text-slate-100 truncate",children:"Spaces"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Lt,{onAddChannel:u,trigger:e.jsx("button",{type:"button",className:"h-8 w-8 inline-flex items-center justify-center rounded-md hover:bg-accent","aria-label":"New space",title:"New space",children:e.jsx(ae,{className:"w-4 h-4"})})}),e.jsx(ds.ToggleButton,{})]})]}),e.jsx("div",{ref:l,"data-component":"channel-list-content",className:"flex-1 overflow-y-auto p-3 space-y-1 min-h-0 channel-list-content",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:x.length===0?e.jsx(Mc,{onCreateChannel:u}):x.map(p=>e.jsx(Ic,{channel:p,isActive:o===p.id,onClick:()=>{ce.logChannelSelect(p.id,p.name,p.messageCount||0),i(p.id)},onDelete:()=>m(p.id)},p.id))}),c&&s&&e.jsx("div",{className:"relative",children:e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-6 bg-gradient-to-t from-slate-100/90 dark:from-slate-800/90 to-transparent pointer-events-none"})})]})}const $e=de()(ct(s=>({isLeftSidebarCollapsed:!1,rightSidebarVisible:!1,rightSidebarSize:35,layoutMode:"default",showTimestamps:!0,showUserAvatars:!0,timelineCoverCollapsed:!1,timelineInputCollapsed:{},toggleLeftSidebar:()=>{s(t=>({isLeftSidebarCollapsed:!t.isLeftSidebarCollapsed}))},setLeftSidebarCollapsed:t=>{s({isLeftSidebarCollapsed:t})},setRightSidebarVisible:t=>{s({rightSidebarVisible:t})},setRightSidebarSize:t=>{s({rightSidebarSize:t})},setLayoutMode:t=>{s({layoutMode:t})},setShowTimestamps:t=>{s({showTimestamps:t})},setShowUserAvatars:t=>{s({showUserAvatars:t})},setTimelineCoverCollapsed:t=>{s({timelineCoverCollapsed:t})},setTimelineInputCollapsed:(t,a)=>{s(n=>({timelineInputCollapsed:{...n.timelineInputCollapsed,[t]:a}}))}}),{name:"echonote-ui-preferences-storage",partialize:s=>({isLeftSidebarCollapsed:s.isLeftSidebarCollapsed,rightSidebarVisible:s.rightSidebarVisible,rightSidebarSize:s.rightSidebarSize,layoutMode:s.layoutMode,showTimestamps:s.showTimestamps,showUserAvatars:s.showUserAvatars,timelineCoverCollapsed:s.timelineCoverCollapsed,timelineInputCollapsed:s.timelineInputCollapsed}),version:2,migrate:(s,t)=>{if(t<2&&s&&typeof s=="object"){const a=s,n=a.timelineCoverCollapsed;let r;return n&&typeof n=="object"&&!Array.isArray(n)?r=Object.values(n).some(Boolean):r=!!n,{...a,timelineCoverCollapsed:r}}return s}})),Ac=({children:s,width:t="w-70",collapsedWidth:a="w-0",className:n=""})=>{const{isLeftSidebarCollapsed:r,setLeftSidebarCollapsed:o}=$e(),i=l=>{o(l)};return e.jsx(ds,{width:t,collapsedWidth:a,className:n,collapsed:r,onCollapseChange:i,children:e.jsx(ds.Content,{children:s})})};function Lc({className:s,...t}){return e.jsx(qi,{"data-slot":"resizable-panel-group",className:j("flex h-full w-full data-[panel-group-direction=vertical]:flex-col",s),...t})}function Ya({...s}){return e.jsx(Wi,{"data-slot":"resizable-panel",...s})}function Rc({withHandle:s,className:t,...a}){return e.jsx(Ki,{"data-slot":"resizable-handle",className:j("bg-border/20 hover:bg-border/40 relative flex w-px items-center justify-center after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:translate-x-0 data-[panel-group-direction=vertical]:after:-translate-y-1/2 [&[data-panel-group-direction=vertical]>div]:rotate-90 transition-colors duration-200",t),...a,children:s&&e.jsx("div",{className:"bg-border/30 hover:bg-border/50 z-10 flex h-4 w-3 items-center justify-center rounded-xs border border-border/20 transition-colors duration-200",children:e.jsx(qo,{className:"size-2.5 text-muted-foreground/60"})})})}const Dc=({children:s,rightSidebar:t,className:a=""})=>{const{rightSidebarSize:n,setRightSidebarSize:r}=$e(),o=t?100-n:100;return e.jsxs(Lc,{direction:"horizontal",className:"flex-1 min-h-0",children:[e.jsx(Ya,{id:"content-panel",defaultSize:o,minSize:20,children:e.jsx("div",{className:`h-full flex flex-col bg-background overflow-hidden ${a}`,children:s})}),t&&e.jsxs(e.Fragment,{children:[e.jsx(Rc,{withHandle:!0}),e.jsx(Ya,{id:"right-sidebar-panel",defaultSize:n,minSize:20,onResize:i=>{r(i)},children:e.jsx("div",{className:"h-full border-l border-border/40 bg-muted overflow-hidden",children:t})})]})]})},_c=({sidebar:s,content:t,rightSidebar:a,className:n=""})=>e.jsx("div",{className:`flex-1 flex flex-col bg-background ${n} overflow-hidden`,children:e.jsxs("div",{className:"flex-1 flex min-h-0 relative",children:[e.jsx(Ac,{className:"bg-card dark:bg-sidebar",children:s}),e.jsx(Dc,{rightSidebar:a,children:t})]})});function Js(s,t=new WeakSet){if(s===null)return null;const a=typeof s;if(a==="string"||a==="number"||a==="boolean")return s;if(a==="bigint")return Number(s);if(!(a==="symbol"||a==="function"||a==="undefined")){if(Array.isArray(s))return s.map(r=>Js(r,t)).filter(r=>r!==void 0);if(a==="object"){const n=s;if(t.has(n))return;t.add(n);const r={};for(const[o,i]of Object.entries(n)){const l=Js(i,t);l!==void 0&&(r[o]=l)}return t.delete(n),r}}}function Bt(s){return{id:s.id,role:s.role,parts:Js(s.parts)}}class Pc{getDb(){return U.getDb()}async createConversation(t,a,n){const r=crypto.randomUUID(),o={id:r,title:a,userId:t,createdAt:new Date,updatedAt:new Date,lastMessageAt:new Date,messageCount:0,isArchived:!1,...n?{contexts:n}:{}};return await Yt(q(this.getDb(),`users/${t}/aiConversations/${r}`),{...o,createdAt:X(),updatedAt:X(),lastMessageAt:X()}),o}async getConversations(t){const a=this.buildConversationsQuery(t);return(await te(a)).docs.map(r=>this.docToAIConversation(r))}async listConversations(t,a={}){const n=a.limit??20;let r=Q(le(this.getDb(),`users/${t}/aiConversations`),ie("lastMessageAt","desc"),Qe(n));a.startAfterLastMessageAt&&(r=Q(r,Fs(a.startAfterLastMessageAt)));const o=await te(r),i=o.docs.map(c=>this.docToAIConversation(c));let l=null;return i.length===n&&(l=o.docs[o.docs.length-1].data()?.lastMessageAt?.toDate?.()??i[i.length-1]?.lastMessageAt??null),{items:i,nextCursor:l}}async getConversation(t,a){const n=q(this.getDb(),`users/${t}/aiConversations/${a}`),r=await Je(n);return r.exists()?this.docToAIConversation(r):null}async deleteConversation(t,a){const n=le(this.getDb(),`users/${t}/aiConversations/${a}/uiMessages`),o=(await te(n)).docs.map(i=>Kt(i.ref));await Promise.all(o),await Kt(q(this.getDb(),`users/${t}/aiConversations/${a}`))}async updateConversation(t,a,n){await ee(q(this.getDb(),`users/${t}/aiConversations/${a}`),{...n,updatedAt:X()})}async addMessage(t,a,n){const r=q(this.getDb(),`users/${t}/aiConversations/${a}/uiMessages/${n.id}`),i=!(await Je(r)).exists();if(i){console.log("[FirebaseAIConversationService] addMessage new message",n);const c=Bt(n);await Yt(r,{...c,conversationId:a,timestamp:X()})}else{console.log("[FirebaseAIConversationService] addMessage existing message",n);const c=Bt(n);await ee(r,{...c,conversationId:a,timestamp:X()})}const l={lastMessageAt:X(),updatedAt:X()};i&&(l.messageCount=Wt(1)),await ee(q(this.getDb(),`users/${t}/aiConversations/${a}`),l)}async createMessage(t,a,n){const r=q(this.getDb(),`users/${t}/aiConversations/${a}/uiMessages/${n.id}`);if((await Je(r)).exists())return;const i=Bt(n);await Yt(r,{...i,conversationId:a,timestamp:X()}),await ee(q(this.getDb(),`users/${t}/aiConversations/${a}`),{lastMessageAt:X(),updatedAt:X(),messageCount:Wt(1)})}async getMessages(t,a){const n=Q(le(this.getDb(),`users/${t}/aiConversations/${a}/uiMessages`),ie("timestamp","asc"));return(await te(n)).docs.map(o=>this.docToUIMessage(o))}async listMessages(t,a,n={}){const{limit:r=50,orderBy:o="asc",startAfter:i,endBefore:l}=n;let c=Q(le(this.getDb(),`users/${t}/aiConversations/${a}/uiMessages`),ie("timestamp",o));if(r&&(c=Q(c,Mi(r))),i){const u=await Je(q(this.getDb(),`users/${t}/aiConversations/${a}/uiMessages/${i}`));c=Q(c,Fs(u))}if(l){const u=await Je(q(this.getDb(),`users/${t}/aiConversations/${a}/uiMessages/${l}`));c=Q(c,Ei(u))}return(await te(c)).docs.map(u=>this.docToUIMessage(u))}async updateMessage(t,a,n,r){const o={updatedAt:X()},i=r;if(Object.prototype.hasOwnProperty.call(i,"role")&&(o.role=i.role),Object.prototype.hasOwnProperty.call(i,"parts")){const l=Bt({id:n,role:i.role??"assistant",parts:i.parts});o.parts=l.parts}await ee(q(this.getDb(),`users/${t}/aiConversations/${a}/uiMessages/${n}`),o)}async deleteMessage(t,a,n){await Kt(q(this.getDb(),`users/${t}/aiConversations/${a}/uiMessages/${n}`)),await ee(q(this.getDb(),`users/${t}/aiConversations/${a}`),{messageCount:Wt(-1),updatedAt:X()})}subscribeToMessages(t,a,n){const r=Q(le(this.getDb(),`users/${t}/aiConversations/${a}/uiMessages`),ie("timestamp","asc"));return yt(r,o=>{const i=o.docs.map(l=>this.docToUIMessage(l));n(i)})}subscribeToConversations(t,a){const n=this.buildConversationsQuery(t);return yt(n,r=>{const o=r.docs.map(i=>this.docToAIConversation(i));a(o)})}buildConversationsQuery(t){return Q(le(this.getDb(),`users/${t}/aiConversations`),ie("lastMessageAt","desc"))}docToAIConversation(t){const a=t.data(),n={id:t.id,title:a.title,userId:a.userId,createdAt:a.createdAt?.toDate()||new Date,updatedAt:a.updatedAt?.toDate()||new Date,lastMessageAt:a.lastMessageAt?.toDate()||new Date,messageCount:a.messageCount||0,isArchived:a.isArchived||!1};let r;return a.contexts?r=a.contexts:a.channelId&&(r={mode:"channels",channelIds:[a.channelId]}),r?{...n,contexts:r}:n}docToUIMessage(t){const a=t.data();return{id:t.id,role:a.role,parts:a.parts}}}const he=new Pc,Oc="sk-06c61fc3bb2543069ed235e2df877f8a",$c="https://dashscope.aliyuncs.com/compatible-mode/v1",Qt="qwen-plus-latest",Zt=new Un({apiKey:Oc,baseURL:$c,dangerouslyAllowBrowser:!0});async function Uc({prompt:s,system:t,temperature:a}){const r=(await Zt.chat.completions.create({model:Qt,messages:[{role:"system",content:t},{role:"user",content:s}],temperature:a})).choices?.[0]?.message?.content;return typeof r=="string"?r:""}class Fc{inFlight=new Map;queue=[];running=!1;enabled=!0;minIntervalMs=1500;results=new Map;setEnabled(t){this.enabled=t}request(t,a,n){if(!this.enabled)return Promise.resolve("");const r=this.inFlight.get(t);if(r)return r.promise;const o=new Promise((i,l)=>{const c=n?.mode||"deterministic";this.queue.push(JSON.stringify({id:t,text:a,mode:c})),this.runLoop().catch(()=>{});const d=setInterval(()=>{const u=this.results.get(t);u!==void 0&&(clearInterval(d),this.results.delete(t),u.error?l(u.error):i(u.title||""))},50)});return this.inFlight.set(t,{promise:o,ts:Date.now()}),o.finally(()=>this.inFlight.delete(t)),o}async runLoop(){if(this.running)return;this.running=!0;let t=0;for(;this.queue.length;){const a=this.queue.shift();if(!a)break;const{id:n,text:r,mode:o}=JSON.parse(a),i=Date.now()-t;i<this.minIntervalMs&&await new Promise(l=>setTimeout(l,this.minIntervalMs-i));try{const l=await this.generateTitle(r,o);this.results.set(n,{title:l}),t=Date.now()}catch(l){this.results.set(n,{error:l}),t=Date.now()}}this.running=!1}async generateTitle(t,a){return a==="deterministic"?this.generateDeterministicTitle(t):a==="auto"&&!this.enabled?this.generateDeterministicTitle(t):a==="ai"||a==="auto"&&this.enabled?this.generateAITitle(t):this.generateDeterministicTitle(t)}generateDeterministicTitle(t){return t.trim().replace(/\s+/g," ").slice(0,200)}async generateAITitle(t){try{const a=this.buildTitlePrompt(t),n=await this.callAIService(a),r=this.validateAndTrimTitle(n);return r||this.generateDeterministicTitle(t)}catch(a){return console.warn("AI title generation failed, falling back to deterministic:",a),this.generateDeterministicTitle(t)}}buildTitlePrompt(t){return`Generate a concise, descriptive title for this conversation content. The title should be:
- Maximum 36 characters
- Capture the main topic or theme
- Be clear and informative
- Avoid generic phrases like "New Conversation"

Content: ${t}`}async callAIService(t){return await Uc({prompt:t,system:"You are a helpful assistant that generates concise, descriptive titles for conversations.",temperature:.3})}validateAndTrimTitle(t){const a=t.trim();return a&&a.length<=36?a:null}}const zc=new Fc;async function Bc(s){if(!Hc(s))return;const t=Gc(s.messages);if(t){s.setTitleGenerating(s.conversationId);try{const a=await Vc(s,t);if(!a){s.completeTitleGenerating(s.conversationId);return}await qc(s,a),s.completeTitleGenerating(s.conversationId)}catch(a){throw s.completeTitleGenerating(s.conversationId),a}}}function Hc(s){const{conversationId:t,conversation:a,autoTitleDone:n}=s;return n[t]?!1:!a.title||/^New Conversation/i.test(a.title)||a.title.startsWith("temp-")}function Gc(s){const t=s.find(n=>n.role==="user");return t&&t.parts.find(n=>n.type==="text")?.text?.trim()||""}async function Vc(s,t){const{conversationId:a,autoTitleEnabled:n,autoTitleMode:r}=s,o=n?r:"deterministic";try{const i=await zc.request(a,t,{mode:o});if(i)return i}catch{return t.replace(/\s+/g," ").slice(0,36)}return t.replace(/\s+/g," ").slice(0,36)}async function qc(s,t){const{conversationId:a,getUserId:n,update:r,applyLocal:o,markDone:i}=s,l=n();l&&(await r(l,a,t),o(a,t),i(a))}function Wc(s,t,a){return s.id.startsWith("temp-")||t.autoTitleDone[s.id]||t.titleGeneratingMap[s.id]||!a.some(o=>o.role==="user")?!1:!s.title||/^New Conversation/i.test(s.title)||s.title.startsWith("temp-")||s.title==="Generating title..."}const Kc=s=>s.startsWith("temp-"),$=de((s,t)=>({conversations:[],currentConversationId:null,loading:!0,loadingMore:!1,error:null,selectionTick:0,uiView:"chat",deletingIds:[],showArchived:!1,query:"",titleGeneratingMap:{},autoTitleEnabled:!0,autoTitleDone:{},autoTitleMode:"ai",nextCursor:null,hasMore:!1,async createConversation(a,n,r){s({error:null});const o=`temp-${crypto.randomUUID()}`,i={id:o,title:n,userId:a,createdAt:new Date,updatedAt:new Date,lastMessageAt:new Date,messageCount:0,isArchived:!1,...r?{contexts:r}:{}};s(l=>({conversations:[i,...l.conversations],currentConversationId:o,uiView:"chat"}));try{const l=await he.createConversation(a,n,r);return s(c=>({conversations:c.conversations.map(d=>d.id===o?l:d),currentConversationId:l.id,uiView:"chat"})),l}catch(l){throw s(c=>({conversations:c.conversations.filter(d=>d.id!==o),currentConversationId:c.currentConversationId===o?null:c.currentConversationId,error:l instanceof Error?l.message:"Failed to create conversation"})),l}},async loadConversations(a){s({loading:!0,error:null,nextCursor:null,hasMore:!1});try{const{items:n,nextCursor:r}=await he.listConversations(a,{limit:20}),o=t().currentConversationId;s({conversations:n,loading:!1,nextCursor:r,hasMore:!!r}),n.length>0&&!o&&s({currentConversationId:n[0].id})}catch(n){s({loading:!1,error:n instanceof Error?n.message:"Failed to load conversations"})}},async loadMoreConversations(a){const{nextCursor:n,loadingMore:r,hasMore:o}=t();if(!(!o||r)){s({loadingMore:!0});try{const{items:i,nextCursor:l}=await he.listConversations(a,{limit:20,startAfterLastMessageAt:n}),d=[...t().conversations];for(const u of i)d.some(m=>m.id===u.id)||d.push(u);s({conversations:d,nextCursor:l,hasMore:!!l})}catch(i){s({error:i instanceof Error?i.message:"Failed to load more conversations"})}finally{s({loadingMore:!1})}}},selectConversation(a){s(n=>({currentConversationId:a,selectionTick:n.selectionTick+1,uiView:"chat"}))},async deleteConversation(a,n){s(i=>({error:null,deletingIds:[...i.deletingIds,n]}));const r=t().conversations,o=t().currentConversationId===n;s(i=>({conversations:i.conversations.filter(l=>l.id!==n),currentConversationId:o?null:i.currentConversationId}));try{await he.deleteConversation(a,n)}catch(i){throw s({conversations:r,currentConversationId:o?n:t().currentConversationId,error:i instanceof Error?i.message:"Failed to delete conversation"}),i}finally{s(i=>({deletingIds:i.deletingIds.filter(l=>l!==n)}))}},async updateConversation(a,n,r){const o=t().conversations;s(i=>({conversations:i.conversations.map(l=>l.id===n?{...l,...r}:l)}));try{await he.updateConversation(a,n,r)}catch(i){throw s({conversations:o,error:i instanceof Error?i.message:"Failed to update conversation"}),i}},clearError(){s({error:null})},showList(){s({uiView:"list"})},showChat(){s({uiView:"chat"})},setView(a){s({uiView:a})},setShowArchived(a){s({showArchived:a})},setQuery(a){s({query:a})},async archiveConversation(a,n){await he.updateConversation(a,n,{isArchived:!0,updatedAt:new Date}),s(r=>({conversations:r.conversations.map(o=>o.id===n?{...o,isArchived:!0}:o)}))},async unarchiveConversation(a,n){await he.updateConversation(a,n,{isArchived:!1,updatedAt:new Date}),s(r=>({conversations:r.conversations.map(o=>o.id===n?{...o,isArchived:!1}:o)}))},setTitleGenerating(a){s(n=>({titleGeneratingMap:{...n.titleGeneratingMap,[a]:!0}}))},completeTitleGenerating(a){s(n=>{const r={...n.titleGeneratingMap};return delete r[a],{titleGeneratingMap:r}})},clearTitleGenerating(a){s(n=>{const r={...n.titleGeneratingMap};return delete r[a],{titleGeneratingMap:r}})},setAutoTitleDone(a){s(n=>({autoTitleDone:{...n.autoTitleDone,[a]:!0}}))},setAutoTitleMode(a){s({autoTitleMode:a})},onMessagesSnapshot(a,n){const r=t(),o=r.conversations.find(i=>i.id===a);o&&Wc(o,r,n)&&Bc({conversationId:a,conversation:o,messages:n,autoTitleEnabled:r.autoTitleEnabled,autoTitleMode:r.autoTitleMode,autoTitleDone:r.autoTitleDone,getUserId:()=>T.getState().userId,update:async(i,l,c)=>{await he.updateConversation(i,l,{title:c})},applyLocal:(i,l)=>s(c=>({conversations:c.conversations.map(d=>d.id===i?{...d,title:l}:d)})),markDone:i=>s(l=>({autoTitleDone:{...l.autoTitleDone,[i]:!0}})),setTitleGenerating:i=>t().setTitleGenerating(i),completeTitleGenerating:i=>t().completeTitleGenerating(i)})}}));function Ut(){const s=$(g=>g.conversations),t=$(g=>g.currentConversationId),a=$(g=>g.loading),n=$(g=>g.loadingMore),r=$(g=>g.error),o=$(g=>g.hasMore),i=$(g=>g.createConversation),l=$(g=>g.loadConversations),c=$(g=>g.loadMoreConversations),d=$(g=>g.selectConversation),u=$(g=>g.deleteConversation),m=$(g=>g.updateConversation),x=$(g=>g.clearError),p=h.useMemo(()=>s.find(g=>g.id===t)||null,[s,t]);return{conversations:s,currentConversationId:t,currentConversation:p,loading:a,loadingMore:n,error:r,hasMore:o,createConversation:i,loadConversations:l,loadMoreConversations:c,selectConversation:d,deleteConversation:u,updateConversation:m,clearError:x}}function Yc(s,t){const{sidebar:a=320,chatMin:n=520,gutter:r=0,hysteresis:o=24,debounceMs:i=100}=t||{},[l,c]=h.useState("two-pane"),[d,u]=h.useState(!1),m=h.useRef(l);return m.current=l,h.useLayoutEffect(()=>{const x=s.current;if(!x)return;const p=a+n+r;let g=null;const f=()=>{const y=x.clientWidth||x.getBoundingClientRect().width,I=m.current;let C;I==="two-pane"?C=y>=p-o?"two-pane":"single-pane":C=y>=p+o?"two-pane":"single-pane",C!==I&&(m.current=C,c(C)),u(!0)},b=()=>{g&&clearTimeout(g),g=setTimeout(f,i)};f();const v=new ResizeObserver(()=>b());return v.observe(x),()=>{g&&clearTimeout(g),v.disconnect()}},[s,a,n,r,o,i]),{mode:l,ready:d}}const rt=s=>{const t=typeof s=="string"?new Date(s):s;if(isNaN(t.getTime()))return"Unknown time";const a=new Date,n=Math.floor((a.getTime()-t.getTime())/(1e3*60)),r=Math.floor(n/60),o=Yi(a,t);return n<1?"Just now":n<60?`${n}m`:r<24?`${r}h`:Xi(t)?"Yesterday":o<3?`${o}d ago`:Ji(t)?Hs(t,"MMM d"):Hs(t,"MMM d, yyyy")};function pa({conversations:s,currentConversationId:t,loading:a}){const{selectConversation:n,deleteConversation:r,updateConversation:o,loadMoreConversations:i,hasMore:l,loadingMore:c}=Ut(),{userId:d}=T(),u=$(w=>w.deletingIds),m=$(w=>w.showArchived),x=$(w=>w.setShowArchived),p=$(w=>w.query),g=$(w=>w.setQuery),f=$(w=>w.titleGeneratingMap),[b,v]=h.useState(null),[y,I]=h.useState(""),C=s.filter(w=>{if(!m&&w.isArchived)return!1;if(!p)return!0;const k=p.toLowerCase();return(w.title||"").toLowerCase().includes(k)});return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-3 sticky top-0 bg-background/95 backdrop-blur-sm z-10 border-b flex items-center gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{value:p,onChange:w=>g(w.target.value),placeholder:"Search conversations",className:"w-full h-9 px-3 rounded-lg border bg-muted/50 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-colors"})}),e.jsxs(Et,{children:[e.jsx(Tt,{asChild:!0,children:e.jsx("button",{type:"button",className:"h-9 w-9 inline-flex items-center justify-center rounded-lg border bg-background hover:bg-accent transition-colors","aria-label":"Filter",children:e.jsx(Wo,{className:"w-4 h-4"})})}),e.jsx(At,{align:"end",sideOffset:6,className:"p-2 w-56",onClick:w=>w.stopPropagation(),onMouseDown:w=>w.stopPropagation(),children:e.jsxs("button",{type:"button",onClick:()=>x(!m),className:"w-full h-8 px-3 rounded-md border bg-background text-sm flex items-center justify-between hover:bg-accent transition-colors",children:[e.jsx("span",{children:"Show archived"}),e.jsx("span",{className:"inline-block w-4 h-4 rounded-sm border "+(m?"bg-primary border-primary":"bg-background")})]})})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:a?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"Loading..."}):C.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"No conversations yet"}):e.jsxs(e.Fragment,{children:[C.map(w=>e.jsx("div",{className:`group px-4 py-3 cursor-pointer hover:bg-accent/50 transition-colors ${t===w.id?"bg-accent":""} ${u.includes(w.id)?"opacity-50 pointer-events-none":""}`,onClick:()=>n(w.id),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"text-sm font-medium text-foreground truncate mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"truncate",children:b===w.id?e.jsx("input",{value:y,onChange:k=>I(k.target.value),onKeyDown:k=>{if(k.key==="Enter"){const R=y.trim();R&&d&&o(d,w.id,{title:R}),v(null)}k.key==="Escape"&&v(null)},onBlur:()=>{const k=y.trim();k&&d&&o(d,w.id,{title:k}),v(null)},className:"h-7 px-2 rounded-sm border bg-background text-sm w-full",autoFocus:!0,onClick:k=>k.stopPropagation()}):e.jsx("span",{onDoubleClick:k=>{k.stopPropagation(),v(w.id),I(w.title||"")},children:f[w.id]?"Generating title...":w.title||"New Conversation"})}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsx(it,{className:"w-3 h-3 text-muted-foreground/60"}),e.jsx("span",{className:"text-xs text-muted-foreground/70",children:w.messageCount})]})]}),w.isArchived&&e.jsx("span",{className:"ml-2 text-[10px] uppercase tracking-wide text-muted-foreground bg-muted px-1.5 py-0.5 rounded",children:"Archived"})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:rt(w.lastMessageAt)})]}),d&&e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{type:"button",className:"text-muted-foreground hover:text-foreground p-1.5 rounded-md hover:bg-accent/50 transition-colors",onClick:k=>{k.stopPropagation(),w.isArchived?(o(d,w.id,{isArchived:!1}),Ie.success("Conversation restored")):(o(d,w.id,{isArchived:!0}),Ie.success("Conversation archived"))},"aria-label":w.isArchived?"Restore conversation":"Archive conversation",children:e.jsx(Ko,{className:"w-4 h-4"})}),e.jsxs(Et,{children:[e.jsx(Tt,{asChild:!0,children:e.jsx("button",{type:"button",className:"text-muted-foreground hover:text-foreground p-1.5 rounded-md hover:bg-accent/50 transition-colors",onClick:k=>{k.stopPropagation()},onMouseDown:k=>{k.stopPropagation()},onKeyDown:k=>{k.stopPropagation()},"aria-label":"Delete conversation",children:e.jsx(Te,{className:"w-4 h-4"})})}),e.jsxs(At,{align:"end",sideOffset:6,className:"p-2 w-56",onClick:k=>k.stopPropagation(),onMouseDown:k=>k.stopPropagation(),children:[e.jsx("div",{className:"text-sm mb-2",children:"Delete this conversation?"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(Fa,{asChild:!0,children:e.jsx("button",{type:"button",className:"h-8 px-3 rounded-md text-sm border hover:bg-accent",onClick:k=>{k.stopPropagation()},children:"Cancel"})}),e.jsx(Fa,{asChild:!0,children:e.jsx("button",{type:"button",className:"h-8 px-3 rounded-md text-sm bg-destructive text-destructive-foreground hover:bg-destructive/90",onClick:k=>{k.stopPropagation(),r(d,w.id).then(()=>Ie.success("Conversation deleted")).catch(()=>Ie.error("Delete failed"))},children:"Delete"})})]})]})]})]})]})},w.id)),l&&d&&e.jsx("div",{className:"p-4 border-t",children:e.jsx("button",{type:"button",className:"w-full h-9 px-4 rounded-lg text-sm border bg-background hover:bg-accent disabled:opacity-60 transition-colors",disabled:c,onClick:()=>{i(d)},children:c?"Loading…":"Load more"})})]})})]})}function Xc(s){const t=new Map;for(const a of s)a?.id&&t.set(a.id,a);return Array.from(t.values())}class Jc{dataContainer=Xn({messageByConversation:{}});requestLoadInitialMessages$=new Tn(1);handleRequestWorkflow$=this.requestLoadInitialMessages$.pipe(fs(),Di(t=>console.log("[ConversationMessageService] handleRequestWorkflow$",t)),bs(t=>!this.dataContainer.get().messageByConversation[t]),An(t=>_i(this.loadInitialMessages({conversationId:t}))));connectToRequestWorkflow=()=>{const t=this.handleRequestWorkflow$.subscribe();return()=>t.unsubscribe()};getConversationStateControl(t){const a=at(this.dataContainer,`messageByConversation.${t}`),{get:n,namespaces:{messages:{set:r},loading:{set:o},loadingMore:{set:i},hasMore:{set:l},subscription:{set:c}}}=a,d=()=>{n()||a.set({messages:[],loading:!1,loadingMore:!1,hasMore:!0})},u=p=>r(Xc(p));return{getState:n,ensureInit:d,setMessages:u,setLoading:o,setLoadingMore:i,setHasMore:l,setSubscription:c,mergeAndSet:p=>{const g=n()?.messages||[];u([...g,...p])},upsert:p=>{const g=n()?.messages||[],f=g.findIndex(b=>b.id===p.id);u(f===-1?[...g,p]:[...g.slice(0,f),p,...g.slice(f+1)])}}}loadInitialMessages=async({conversationId:t})=>{const{userId:a}=T.getState();if(!a||!t)return;const{ensureInit:n,setLoading:r,setMessages:o,setSubscription:i}=this.getConversationStateControl(t);n(),r(!0);try{const l=await he.getMessages(a,t);o(l);const c=this.subscribeToMessages({userId:a,conversationId:t});i({unsubscribe:c})}finally{r(!1)}};subscribeToMessages=({userId:t,conversationId:a})=>{const{setMessages:n}=this.getConversationStateControl(a);return he.subscribeToMessages(t,a,r=>n(r||[]))};async createMessage(t,a,n){await he.createMessage(t,a,n)}async updateMessage(t,a,n){await he.updateMessage(t,a,n.id,n)}}const bt=new Jc;function Qc(s){const{userId:t}=T(),a=h.useMemo(()=>at(bt.dataContainer,`messageByConversation.${s}`),[s]),{value:n}=Jn(a);h.useEffect(()=>bt.connectToRequestWorkflow(),[]),h.useEffect(()=>{!t||!s||bt.requestLoadInitialMessages$.next(s)},[t,s]);const r=async i=>{t&&await bt.createMessage(t,s,i)},o=async i=>{t&&await bt.updateMessage(t,s,i)};return{messages:n?.messages||[],loading:n?.loading||!1,createMessage:r,updateMessage:o}}const Re="https://stillroot-ai-proxy.agentverse.cc",Ye=[{id:"qwen-plus",name:"Qwen Plus",description:"Alibaba Cloud Qwen model via DashScope",apiKey:"sk-06c61fc3bb2543069ed235e2df877f8a",model:"qwen-plus-latest",apiUrl:"https://dashscope.aliyuncs.com/compatible-mode/v1",temperature:.7,maxTokens:4e3},{id:"qwen3-max",name:"Qwen3 Max",description:"Alibaba Cloud Qwen3 Max model via DashScope",apiKey:"sk-06c61fc3bb2543069ed235e2df877f8a",model:"qwen3-max",apiUrl:"https://dashscope.aliyuncs.com/compatible-mode/v1",temperature:.7,maxTokens:4e3,isDefault:!0},{id:"cloudflare-worker-openrouter-google-gemini-2.5-pro",name:"Gemini 2.5 Pro",description:"Google Gemini 2.5 Pro via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/google/gemini-2.5-pro",apiUrl:Re,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-gemini-2.5-flash",name:"Gemini 2.5 Flash",description:"Google Gemini 2.5 Flash via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/google/gemini-2.5-flash",apiUrl:Re,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-grok-4-fast",name:"Grok 4 Fast",description:"Grok 4 Fast via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/x-ai/grok-4-fast:free",apiUrl:Re,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-grok-code-fast-1",name:"Grok Code Fast 1",description:"Grok Code Fast 1 via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/x-ai/grok-code-fast-1",apiUrl:Re,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-openai-gpt-5-codex",name:"GPT 5 Codex",description:"GPT 5 Codex via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/openai/gpt-5-codex",apiUrl:Re,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-openai-gpt-5-chat",name:"GPT 5 Chat",description:"GPT 5 Chat via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/openai/gpt-5-chat",apiUrl:Re,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-claude-sonnet-4.5",name:"Claude Sonnet 4.5",description:"Claude Sonnet 4.5 via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/anthropic/claude-sonnet-4.5",apiUrl:Re,temperature:.7,maxTokens:4e3,isDefault:!1},{id:"cloudflare-worker-openrouter-glm-4.6",name:"GLM 4.6",description:"GLM 4.5 via Cloudflare Worker OpenRouter",apiKey:"not-needed",model:"openrouter/z-ai/glm-4.6",apiUrl:Re,temperature:.7,maxTokens:4e3,isDefault:!1}],Qs=()=>Ye.find(s=>s.isDefault)||Ye[0],xa=s=>Ye.find(t=>t.id===s),Zc=s=>s.includes("qwen")?"default":s.includes("gemini")?"secondary":s.includes("grok")?"outline":s.includes("claude")?"secondary":s.includes("glm")?"outline":"default";function ed({selectedModelId:s,onModelChange:t,className:a=""}){const[n,r]=h.useState(!1),o=s?xa(s):Ye[0],i=l=>{t?.(l.id),r(!1)};return e.jsx("div",{className:`flex items-center ${a}`,children:e.jsxs(dt,{open:n,onOpenChange:r,children:[e.jsx(ut,{asChild:!0,children:e.jsxs(N,{variant:"ghost",size:"sm",className:"h-8 px-3 gap-2 bg-transparent hover:bg-accent/50 text-muted-foreground hover:text-foreground",children:[e.jsx("span",{className:"text-sm font-medium",children:o?.name||"Select Model"}),e.jsx(we,{className:"w-3 h-3 opacity-50"})]})}),e.jsxs(ht,{align:"start",className:"w-64 p-1",side:"top",children:[e.jsx(fr,{className:"text-xs text-muted-foreground px-2 py-1.5",children:"Choose AI Model"}),e.jsx(br,{}),Ye.map(l=>e.jsxs(Ns,{onClick:()=>i(l),className:"flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-accent/50 rounded-md",children:[e.jsx("span",{className:"text-sm font-medium text-foreground",children:l.name}),e.jsxs("div",{className:"flex items-center gap-1",children:[l.isDefault&&e.jsx(oe,{variant:"secondary",className:"text-xs px-1.5 py-0.5",children:"Default"}),s===l.id&&e.jsx(oe,{variant:Zc(l.id),className:"text-xs px-1.5 py-0.5",children:"Selected"})]})]},l.id))]})]})})}const td=s=>{const{messages:t,assistantMessageId:a}=s,n=t.filter(i=>i.role==="assistant"&&!!i.toolCalls).map(i=>i.toolCalls).flat(),r=t.filter(i=>i.role==="assistant").map(i=>i.content).join(`
`),o=t.filter(i=>i.role==="tool");return[{id:a,role:"assistant",content:r,toolCalls:n.length>0?n:void 0},...o]},sd=(s,t,a)=>{const{id:n,role:r}=s,o=[],i=`${n}-${a}`;if(t.type==="text")o.push({id:i,role:r,content:t.text});else if(t.type==="tool-invocation"){const l={id:`${i}-tool-call`,role:"assistant",content:"",toolCalls:[{id:t.toolInvocation.toolCallId,type:"function",function:{name:t.toolInvocation.toolName,arguments:t.toolInvocation.args}}]};if([ue.CALL,ue.PARTIAL_CALL].includes(t.toolInvocation.status))o.push(l);else{const c={id:`${i}-tool-result`,role:"tool",toolCallId:t.toolInvocation.toolCallId,content:JSON.stringify({result:t.toolInvocation.result,error:t.toolInvocation.error,cancelled:t.toolInvocation.status===ue.CANCELLED})};o.push(l,c)}}return r==="assistant"?td({messages:o,assistantMessageId:n}):o},ad=s=>s.filter(t=>t.role!=="data").map(t=>t.parts.map((a,n)=>sd(t,a,n)).flat()).flat();class nd{constructor(){}encode(t){return this.encodeSSE(t)}encodeSSE(t){return`data: ${JSON.stringify(t)}

`}}class Nr{constructor(t){this.encoder=t}async*handle(t,a){if(!a.isMessageStarted){const r={type:pe.TEXT_START,messageId:a.messageId};yield this.encoder.encode(r),a.isMessageStarted=!0}const n=t.choices[0].delta.content;if(n){a.fullResponse+=n;const r={type:pe.TEXT_DELTA,messageId:a.messageId,delta:n};yield this.encoder.encode(r)}}async*finalize(t){if(t.isMessageStarted){const a={type:pe.TEXT_END,messageId:t.messageId};yield this.encoder.encode(a)}}}class rd{constructor(t){this.encoder=t}async*handle(t,a){const n=t.choices[0].delta.tool_calls?.[0];if(n){if(!a.isToolCallStarted){a.toolCallId=n.id??"",a.toolCallName=n.function?.name??"",a.isToolCallStarted=!0;const r={type:pe.TOOL_CALL_START,toolCallId:a.toolCallId,toolName:a.toolCallName};yield this.encoder.encode(r)}if(n.function?.arguments){a.toolCallArgs+=n.function.arguments;const r={type:pe.TOOL_CALL_ARGS_DELTA,toolCallId:a.toolCallId,argsDelta:n.function.arguments};yield this.encoder.encode(r)}}}async*finalize(t){if(t.isToolCallStarted){const a={type:pe.TOOL_CALL_END,toolCallId:t.toolCallId};yield this.encoder.encode(a)}}}class od{constructor(t){this.encoder=t,this.context={messageId:Dn(),toolCallId:"",isMessageStarted:!1,isToolCallStarted:!1,fullResponse:"",toolCallArgs:"",toolCallName:"",getSnapshot:()=>({last_response:this.context.fullResponse,last_tool_call:this.context.isToolCallStarted?{name:this.context.toolCallName,arguments:this.context.toolCallArgs}:null,usage:{prompt_tokens:0,completion_tokens:0,total_tokens:0}})}}handlers=new Map;context;addHandler(t,a){this.handlers.set(t,a)}async*process(t){try{for await(const a of t){const n=this.getChunkType(a),r=this.handlers.get(n);r&&(yield*r.handle(a,this.context))}for(const a of this.handlers.values())yield*a.finalize(this.context)}catch(a){yield*this.handleError(a)}}getChunkType(t){return t.choices[0].delta.tool_calls?"tool":t.choices[0].delta.content?"text":"unknown"}async*handleError(t){const a=new Nr(this.encoder);yield*a.handle({id:"",created:0,model:"",object:"chat.completion.chunk",choices:[{delta:{content:`Error: ${t.message}`},finish_reason:"stop",index:0}],usage:{prompt_tokens:0,completion_tokens:0,total_tokens:0}},this.context),yield*a.finalize(this.context);const n={type:pe.RUN_ERROR,error:t.message};yield this.encoder.encode(n)}}class Xa{constructor(t){this.config=t,this.client=new Un({apiKey:t.apiKey,baseURL:t.baseURL,dangerouslyAllowBrowser:!0})}client;currentStream=null;convertToolsToOpenAIFormat(t){return t.map(a=>({type:"function",function:{name:a.name,description:a.description,parameters:a.parameters}}))}convertMessagesToOpenAIFormat(t){return ad(t).map(n=>n.role==="tool"&&"toolCallId"in n?{role:n.role,content:n.content,tool_call_id:n.toolCallId}:n.role==="developer"||n.role==="system"||n.role==="user"?{role:n.role,content:n.content,id:n.id}:{role:n.role,content:n.content,id:n.id,tool_calls:"toolCalls"in n?n.toolCalls?.map(r=>({id:r.id,type:"function",function:{name:r.function.name,arguments:r.function.arguments}})):void 0})}addContextToMessages(t,a){return[{role:"system",content:a.map(r=>`${r.description}: ${r.value}`).join(`
`)},...t]}async*run(t,a){console.log("🔔 [OpenAIAgent][run] inputData:",t);const n=new nd,r={type:pe.RUN_STARTED,threadId:t.threadId};yield n.encode(r);try{let i=t.messages?this.convertMessagesToOpenAIFormat(t.messages):[];t.context&&(i=this.addContextToMessages(i,t.context)),console.log("🔔 [OpenAIAgent][run] messages:",i,"inputData.messages:",t.messages);const l=t.tools?this.convertToolsToOpenAIFormat(t.tools):[],c=await this.client.chat.completions.create({model:this.config.model,messages:i,stream:!0,tools:l.length>0?l:void 0});this.currentStream=c;const d=new od(n);d.addHandler("text",new Nr(n)),d.addHandler("tool",new rd(n)),yield*d.process(c)}catch(i){yield*this.handleError(i,n)}const o={type:pe.RUN_FINISHED,threadId:t.threadId};yield n.encode(o)}abort(){this.currentStream&&this.currentStream.controller.abort()}async*handleError(t,a){const n={type:pe.RUN_ERROR,error:t.message};console.error("[OpenAIAgent][handleError]:",t),yield a.encode(n)}}function id(){return s=>s.pipe(Rn(t=>new zs(a=>{const n=t.split(/\r?\n/);for(const r of n){if(!r.startsWith("data:"))continue;const o=r.slice(5).trim();if(!(!o||o==="[DONE]"))try{const i=JSON.parse(o);a.next(i)}catch{}}a.complete()})))}const Ja=5e4;class Ht{openaiAgent;currentConfig;contextCharLimit;constructor(t){this.currentConfig={apiKey:t?.apiKey||"sk-06c61fc3bb2543069ed235e2df877f8a",model:t?.model||"qwen3-max-preview",temperature:t?.temperature||.7,maxTokens:t?.maxTokens||1e3,baseURL:t?.baseURL||"https://dashscope.aliyuncs.com/compatible-mode/v1"};const a=Ja;if(this.contextCharLimit=Number.isFinite(a)&&a>0?a:Ja,!this.currentConfig.apiKey)throw new Error("API key is required. Please set the appropriate API key environment variable.");this.openaiAgent=new Xa(this.currentConfig)}abortRun(){this.openaiAgent.abort()}run(t){const a=this.trimInputByCharLimit(t,this.contextCharLimit);console.log("🔔 [ExperimentalInBrowserAgent][run] trimmedInput:",{input:t,trimmedInput:a,contextCharLimit:this.contextCharLimit});const n=r=>new zs(o=>{(async()=>{try{for await(const i of r)o.next(i);o.complete()}catch(i){o.error(i)}})()});return new zs(r=>((async()=>{try{const l=this.openaiAgent.run(a,"application/json");n(l).pipe(id(),bs(c=>!!c&&!!c.type),Pi(c=>(console.error("🔔 [ExperimentalInBrowserAgent][run] error:",c),r.next({type:pe.RUN_ERROR}),r.error(c),[]))).subscribe({next:c=>{console.log("event",c),r.next(c)},error:c=>r.error(c),complete:()=>{r.complete()}})}catch(i){console.error("🔔 [ExperimentalInBrowserAgent][run] error:",i),r.next({type:pe.RUN_ERROR}),r.error(i)}})(),()=>{}))}setConfig(t){this.currentConfig={...this.currentConfig,...t};const a=t?.contextCharLimit;if(typeof a=="number"&&Number.isFinite(a)&&a>0&&(this.contextCharLimit=a),!this.currentConfig.apiKey)throw new Error("API key is required. Please set the appropriate API key environment variable.");this.openaiAgent=new Xa(this.currentConfig)}getConfig(){return{...this.currentConfig,hasApiKey:!!this.currentConfig.apiKey,contextCharLimit:this.contextCharLimit}}trimInputByCharLimit(t,a){try{const n=t.messages||[],r=g=>g.type==="text"&&typeof g.text=="string",o=g=>g.type==="tool-invocation"&&!!g.toolInvocation,i=g=>{if(r(g))return g.text.length;if(o(g)){const f=g.toolInvocation;let b=0;return b+=f.toolName?f.toolName.length:0,typeof f.args=="string"&&(b+=f.args.length),f.toolCallId&&(b+=f.toolCallId.length),f.result!==void 0&&(b+=typeof f.result=="string"?f.result.length:JSON.stringify(f.result).length),f.error!==void 0&&(b+=typeof f.error=="string"?f.error.length:JSON.stringify(f.error).length),b}try{return JSON.stringify(g).length}catch{return 0}},l=g=>(g.parts||[]).reduce((f,b)=>f+i(b),0),c=n.filter(g=>g.role==="user"||g.role==="assistant"),d=c.reduce((g,f)=>g+l(f),0);if(d<=a)return t;const u=[...c],m=new Set;let x=d;for(;x>a&&u.length>0;){const g=u.shift();m.add(g.id),x-=l(g)}const p=n.filter(g=>!m.has(g.id));return{...t,messages:p}}catch(n){return console.warn("trimInputByCharLimit failed, fallback to original input:",n),t}}}function ks(s){try{if(s.parsedArgs)return s.parsedArgs;const t=s.args;return typeof t=="string"?JSON.parse(t):t&&typeof t=="object"?t:null}catch{return null}}const ld={default:"bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800",success:"bg-green-50 dark:bg-green-950 border-green-200 dark:border-green-900",warning:"bg-yellow-50 dark:bg-yellow-950 border-yellow-200 dark:border-yellow-900",error:"bg-red-50 dark:bg-red-950 border-red-200 dark:border-red-900"},cd={default:"text-gray-700 dark:text-gray-300",success:"text-gray-700 dark:text-gray-200",warning:"text-gray-700 dark:text-gray-200",error:"text-gray-600 dark:text-gray-300"};function Zs({content:s,variant:t="default",maxHeight:a,showScrollbar:n=!0,className:r,placeholder:o="Loading content..."}){const i=s||o;return e.jsx("div",{className:j("rounded-md border p-3",ld[t],n&&"overflow-y-auto",r),style:a?{maxHeight:a}:void 0,children:e.jsx("p",{className:j("text-sm whitespace-pre-wrap",cd[t]),children:i})})}const dd=aa("relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",{variants:{variant:{default:"bg-card text-card-foreground",destructive:"text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90"}},defaultVariants:{variant:"default"}});function us({className:s,variant:t,...a}){return e.jsx("div",{"data-slot":"alert",role:"alert",className:j(dd({variant:t}),s),...a})}function hs({className:s,...t}){return e.jsx("div",{"data-slot":"alert-description",className:j("text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",s),...t})}function ms({error:s,fallbackMessage:t="An error occurred",variant:a="text",className:n}){const r=typeof s=="string"?s:s instanceof Error?s.message:t;return a==="alert"?e.jsx(us,{variant:"destructive",className:n,children:e.jsx(hs,{children:r})}):e.jsx("div",{className:j("text-red-700 dark:text-red-300 text-sm",n),children:r})}function Cr({icon:s,message:t,className:a}){return e.jsxs("div",{className:j("flex items-center gap-2 text-gray-500 dark:text-gray-400",a),children:[e.jsx(s,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:t})]})}const ud={sm:"gap-2",md:"gap-4",lg:"gap-6"},hd={default:"text-gray-500 dark:text-gray-400",mono:"font-mono text-gray-500 dark:text-gray-400",highlight:"text-gray-700 dark:text-gray-300 font-medium"};function md({items:s,className:t,gap:a="md"}){return s.length===0?null:e.jsx("div",{className:j("flex items-center",ud[a],t),children:s.map((n,r)=>e.jsx("div",{className:"flex items-center gap-1",children:n.variant==="mono"?e.jsx(oe,{variant:"outline",className:"text-xs font-mono",children:n.value}):e.jsx("span",{className:j("text-xs",hd[n.variant||"default"]),children:n.value})},r))})}function Qa({original:s,updated:t,showLabels:a=!0,className:n}){return e.jsxs("div",{className:j("space-y-3",n),children:[a&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:s.label||"Original"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"→"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:t.label||"Updated"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(Zs,{content:s.content,variant:"default",maxHeight:"max-h-48",showScrollbar:!0,placeholder:s.placeholder||"Loading original content..."}),e.jsx(Zs,{content:t.content,variant:"success",maxHeight:"max-h-48",showScrollbar:!0,placeholder:t.placeholder||"Loading updated content..."})]})]})}function gd({icon:s,title:t,status:a,statusText:n,hasDetails:r=!1,isExpanded:o=!1,onToggleExpanded:i}){const c={loading:{icon:e.jsx(ze,{className:"h-4 w-4 animate-spin text-blue-600"}),color:"text-blue-600"},success:{icon:e.jsx(_t,{className:"h-4 w-4 text-green-600"}),color:"text-green-600"},error:{icon:e.jsx(yn,{className:"h-4 w-4 text-red-600"}),color:"text-red-600"},ready:{icon:e.jsx(la,{className:"h-4 w-4 text-gray-500"}),color:"text-gray-500"}}[a];return e.jsxs("div",{className:"px-2 flex gap-2 items-center overflow-hidden",children:[e.jsx("div",{className:"flex items-center gap-2 flex-shrink-0",children:s}),e.jsx("div",{className:"overflow-y-auto flex-shrink-0",children:t}),e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx("div",{className:"flex-shrink-0",children:c.icon}),e.jsx("span",{className:`text-sm font-medium truncate overflow-hidden ${c.color}`,children:n})]}),e.jsx("div",{className:"flex-1 w-[9999px]"}),r&&e.jsx(N,{variant:"ghost",size:"sm",onClick:i,className:"h-8 w-8 p-0 hover:bg-gray-100 flex-shrink-0","aria-label":o?"Collapse details":"Expand details",children:o?e.jsx(we,{className:"h-4 w-4"}):e.jsx(Cn,{className:"h-4 w-4"})})]})}function pd({children:s,maxHeight:t="400px",isExpanded:a=!1,scrollable:n=!0}){return a?e.jsx("div",{className:"p-4 w-full",children:e.jsx("div",{className:n?"overflow-y-auto w-full":"w-full",style:n?{maxHeight:t}:void 0,children:s})}):null}function xd({children:s,header:t,content:a,headerCardClassName:n="border-gray-200 dark:border-gray-800",contentCardClassName:r="border-gray-200 dark:border-gray-800 mt-2"}){return e.jsxs("div",{className:"w-full flex flex-col","data-echo-tool":!0,children:[e.jsx("div",{className:"flex w-full overflow-hidden",children:e.jsx(We,{className:j(n,"overflow-hidden py-2 px-2"),children:e.jsx(gd,{...t})})}),a&&a.isExpanded&&e.jsx("div",{className:"w-full",children:e.jsx(We,{className:r,children:e.jsx(pd,{...a})})}),s&&e.jsx("div",{className:"w-full mt-2",children:s})]})}function Ne({icon:s,title:t,status:a,statusText:n,children:r,maxHeight:o="400px",defaultExpanded:i,expandable:l,forceExpanded:c,contentScrollable:d,headerCardClassName:u,contentCardClassName:m}){const x=!!r,p=l!==!1&&x&&!c,[g,f]=h.useState(i??!1),b=c?!0:g,v=h.useMemo(()=>({icon:s,title:t,status:a,statusText:n,hasDetails:p,isExpanded:b,onToggleExpanded:p?()=>f(I=>!I):void 0}),[s,t,a,n,p,b]),y=x?{children:r,maxHeight:o,isExpanded:b,scrollable:d!==!1}:void 0;return e.jsx("div",{className:"w-full","data-echo-tool":!0,children:e.jsx(xd,{header:v,content:y,headerCardClassName:u,contentCardClassName:m})})}function kr(s){try{if(s.parsedArgs)return s.parsedArgs;const t=s.args;return typeof t=="string"?JSON.parse(t):t&&typeof t=="object"?t:null}catch{return null}}function fa({invocation:s,icon:t,title:a,loadingText:n="Loading...",loadingIcon:r,successIcon:o,errorIcon:i,readyIcon:l,successStatusText:c,errorStatusText:d,readyStatusText:u="Ready",contentScrollable:m=!0,headerCardClassName:x,contentCardClassName:p,children:g}){const f=kr(s)||{};if(s.status===ue.PARTIAL_CALL)return e.jsx(Ne,{icon:r||t,title:a,status:"loading",statusText:n,contentScrollable:m,headerCardClassName:x||"border-blue-200 dark:border-blue-800",contentCardClassName:p||"border-gray-200 dark:border-gray-800 mt-2",children:g(f)});if(s.status===ue.CALL)return e.jsx(Ne,{icon:r||t,title:a,status:"loading",statusText:n,contentScrollable:m,headerCardClassName:x||"border-blue-200 dark:border-blue-800",contentCardClassName:p||"border-gray-200 dark:border-gray-800 mt-2",children:g(f)});if(s.status===ue.RESULT){const b=s.result;return e.jsx(Ne,{icon:o||t,title:a,status:"success",statusText:c?c(b):"Success",contentScrollable:m,headerCardClassName:x||"border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950",contentCardClassName:p||"border-gray-200 dark:border-gray-800 mt-2",children:g(f,b)})}if(s.status===ue.ERROR){const b=s.error;return e.jsx(Ne,{icon:i||t,title:a,status:"error",statusText:d?d(b):"Error occurred",contentScrollable:m,headerCardClassName:x||"border-red-200 dark:border-red-800",contentCardClassName:p||"border-red-200 dark:border-red-800 mt-2",children:g(f,void 0,b)})}return e.jsx(Ne,{icon:l||t,title:a,status:"ready",statusText:u,contentScrollable:m,headerCardClassName:x||"border-gray-200 dark:border-gray-800",contentCardClassName:p||"border-gray-200 dark:border-gray-800 mt-2",children:g(f)})}function Za({confirmLabel:s,cancelLabel:t="Cancel",onConfirm:a,onCancel:n,isLoading:r,confirmIcon:o,loadingLabel:i,variant:l="default"}){return e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(N,{onClick:a,disabled:r,className:"flex-1",variant:l,children:r?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-4 w-4 mr-2 animate-spin"}),i||`${s}...`]}):e.jsxs(e.Fragment,{children:[o,o?e.jsx("span",{className:"ml-2",children:s}):s]})}),e.jsx(N,{variant:"outline",onClick:n,disabled:r,children:t})]})}function fd({invocation:s,onResult:t,confirm:a}){const[n,r]=h.useState(!1),[o,i]=h.useState(null);return{isLoading:n,error:o,handleConfirm:async()=>{r(!0),i(null);try{const d=await a();t({toolCallId:s.toolCallId,result:d,status:ue.RESULT})}catch(d){const u=d instanceof Error?d.message:"Operation failed";i(u),r(!1)}},handleCancel:()=>{t({toolCallId:s.toolCallId,status:ue.CANCELLED,cancelled:!0})}}}function ba(s){const{invocation:t,onResult:a,icon:n,title:r,loadingText:o="Loading...",callStatusText:i,preview:l,confirm:c,confirmLabel:d,confirmIcon:u,confirmVariant:m,resultStatusText:x,resultContent:p,cancelStatusText:g,contentScrollable:f,stickyFooter:b=!0}=s,v=kr(t)||{},{isLoading:y,error:I,handleConfirm:C,handleCancel:w}=fd({invocation:t,onResult:a,confirm:c});if(t.status===ue.PARTIAL_CALL)return e.jsx(Ne,{icon:n,title:r,status:"loading",statusText:o,contentScrollable:f,headerCardClassName:"border-blue-200 dark:border-blue-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:l(v)});if(t.status===ue.CALL)return e.jsx(Ne,{icon:n,title:r,status:"ready",statusText:i,forceExpanded:!0,contentScrollable:f,headerCardClassName:"border-amber-200 dark:border-amber-800",children:b?e.jsxs("div",{className:"relative w-full",children:[e.jsxs("div",{className:"space-y-4 w-full pb-16",children:[l(v),I&&e.jsx(us,{variant:"destructive",children:e.jsx(hs,{children:I})})]}),e.jsx("div",{className:"sticky bottom-0 w-full bg-background border-t dark:border-gray-800 pt-3 pb-3",children:e.jsx(Za,{confirmLabel:d,loadingLabel:`${d}...`,onConfirm:C,onCancel:w,isLoading:y,confirmIcon:u,variant:m})})]}):e.jsxs("div",{className:"space-y-4 w-full",children:[l(v),I&&e.jsx(us,{variant:"destructive",children:e.jsx(hs,{children:I})}),e.jsx(Za,{confirmLabel:d,loadingLabel:`${d}...`,onConfirm:C,onCancel:w,isLoading:y,confirmIcon:u,variant:m})]})});if(t.status===ue.RESULT){const k=t.result;return e.jsx(Ne,{icon:n,title:r,status:"success",statusText:x(k),contentScrollable:f,headerCardClassName:"border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:p(v,k)})}return t.status===ue.CANCELLED?e.jsx(Ne,{icon:n,title:r,status:"ready",statusText:g||"Cancelled",contentScrollable:f,headerCardClassName:"border-gray-200 dark:border-gray-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:l(v)}):e.jsx(Ne,{icon:n,title:r,status:"ready",statusText:"",headerCardClassName:"border-gray-200 dark:border-gray-800"})}function Rt({content:s,showMetadata:t=!1,metadata:a,variant:n="preview",maxHeight:r,className:o,placeholder:i}){const l=[];t&&a&&(a.noteId&&l.push({label:"ID",value:a.noteId,variant:"mono"}),a.timestamp&&l.push({label:"Time",value:a.timestamp,variant:"default"}),a.contentLength&&l.push({label:"Length",value:`${a.contentLength} chars`,variant:"default"}));const c=n==="detail"?"success":n==="error"?"error":"default",d=n==="comparison"?"max-h-48":r;return e.jsxs("div",{className:o,children:[t&&l.length>0&&e.jsx(md,{items:l,className:"mb-3"}),e.jsx(Zs,{content:s,variant:c,maxHeight:d,showScrollbar:n==="comparison",placeholder:i})]})}function bd({noteId:s,content:t,contentLength:a,timestampReadable:n,showIdPrefix:r=!0,idPrefixLength:o=8,showCharCount:i=!0,charCountThreshold:l=60,className:c}){return e.jsxs("div",{className:j("p-3 bg-gray-50 dark:bg-gray-900 rounded-md border dark:border-gray-800",c),children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ot,{className:"w-3 h-3 text-gray-400 dark:text-gray-500"}),r&&e.jsxs(oe,{variant:"outline",className:"text-xs font-mono",children:[s.substring(0,o),"..."]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx(la,{className:"w-3 h-3"}),e.jsx("span",{children:n})]})]}),e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap",children:t}),i&&a>l&&e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:["(",a," characters total)"]})]})}function vd(s,t){const[a,n]=st.useState("");return st.useEffect(()=>{if(!(!s||!t))try{const o=_.dataContainer.get().messageByChannel[t]?.messages.find(i=>i.id===s);o&&n(o.content)}catch(r){console.error("Failed to fetch note content:",r)}},[s,t]),a}function yd({invocation:s,onResult:t}){const a=ks(s),n=a?.noteId||"",r=a?.content||"",o=a?.channelId||"",i=vd(n,o);return e.jsx(ba,{invocation:s,onResult:t,icon:e.jsx(ra,{className:"h-5 w-5 text-amber-600 dark:text-amber-400"}),title:"Update Note",loadingText:"Preparing parameters...",callStatusText:"Ready to update",contentScrollable:!1,stickyFooter:!1,preview:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(oe,{variant:"outline",className:"font-mono text-xs",children:n||"Loading..."})}),e.jsx(Qa,{original:{content:i||"",label:"Original",placeholder:"Loading original content..."},updated:{content:r,label:"Updated",placeholder:"Loading updated content..."},showLabels:!0})]}),confirm:async()=>(await _.updateMessage({messageId:n,channelId:o,updates:{content:r},userId:T.getState().userId}),{status:"updated",message:"Note updated successfully"}),confirmLabel:"Update Note",confirmIcon:e.jsx(_t,{className:"h-4 w-4"}),resultStatusText:()=>"Note Updated Successfully!",resultContent:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(oe,{variant:"outline",className:"font-mono text-xs",children:n})}),e.jsx(Qa,{original:{content:i||"",label:"Original",placeholder:"Original content"},updated:{content:r,label:"Updated",placeholder:"Updated content"},showLabels:!0})]}),cancelStatusText:"Update Cancelled"})}function wd({invocation:s,onResult:t}){const[a,n]=h.useState(""),r=ks(s),o=r?.noteId||"",i=r?.channelId||"";return st.useEffect(()=>{try{const c=_.dataContainer.get().messageByChannel[i]?.messages.find(d=>d.id===o);c&&n(c.content)}catch(l){console.error("Failed to fetch note content:",l)}},[o,i]),e.jsx(ba,{invocation:s,onResult:t,icon:e.jsx(Te,{className:"h-5 w-5 text-amber-600 dark:text-amber-400"}),title:"Delete Note",loadingText:"Preparing parameters...",callStatusText:"Ready to delete",preview:()=>e.jsxs("div",{className:"space-y-4 w-full",children:[e.jsx(us,{variant:"destructive",children:e.jsxs(hs,{children:[e.jsx("strong",{children:"Warning:"})," This action will permanently delete the note. This cannot be undone."]})}),e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(oe,{variant:"outline",className:"font-mono text-xs",children:o||"Loading..."})}),e.jsx(Rt,{content:a,variant:"preview",showMetadata:!1,maxHeight:"max-h-32",placeholder:"Loading note content..."})]}),confirm:async()=>(await _.deleteMessage({messageId:o,channelId:O.getState().currentChannelId}),{status:"deleted",message:"Note deleted successfully"}),confirmLabel:"Delete Note",confirmIcon:e.jsx(Te,{className:"h-4 w-4"}),confirmVariant:"destructive",resultStatusText:()=>"Note Deleted Successfully!",resultContent:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx(oe,{variant:"outline",className:"font-mono text-xs",children:o})}),e.jsx(Rt,{content:a,variant:"error",showMetadata:!1,placeholder:"Deleted note content"})]})})}function jd({invocation:s}){console.log("🔔 [ReadNoteToolRenderer] invocation:",s);const a=ks(s)?.noteId;return e.jsx(fa,{invocation:s,icon:e.jsx(Ee,{className:"h-5 w-5 text-blue-600"}),title:"Read Note",loadingText:`Reading note ${a?.substring(0,8)||"unknown"}...`,successIcon:e.jsx(Ee,{className:"h-5 w-5 text-green-600"}),errorIcon:e.jsx(ns,{className:"w-5 h-5 text-red-600"}),successStatusText:()=>"Note loaded successfully",errorStatusText:n=>n&&typeof n=="object"&&"found"in n&&!n.found?"Note not found":"Failed to load note",readyStatusText:"Preparing to read note...",contentScrollable:!0,headerCardClassName:"border-blue-200 dark:border-blue-900",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:(n,r,o)=>o?e.jsx(ms,{error:o,fallbackMessage:"An error occurred while loading the note"}):r?.found?e.jsx(Rt,{content:r.content,variant:"detail",showMetadata:!0,metadata:{noteId:r.noteId,timestamp:r.timestampReadable,contentLength:r.contentLength}}):e.jsx(ms,{error:"Note not found",fallbackMessage:"Note not found"})})}function Nd({invocation:s}){const a=(s.parsedArgs||{}).limit||10;return e.jsx(fa,{invocation:s,icon:e.jsx(Yo,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),title:"List Notes",loadingText:"Loading notes from channel...",successStatusText:n=>`Found ${n?.notes?.length||0} note${(n?.notes?.length||0)!==1?"s":""}`,errorStatusText:n=>"Failed to load notes",readyStatusText:"Preparing to list notes...",contentScrollable:!0,headerCardClassName:"border-blue-200 dark:border-blue-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:(n,r,o)=>o?e.jsx(ms,{error:o,fallbackMessage:"An error occurred while loading notes",variant:"alert"}):!r?.notes||!Array.isArray(r.notes)||r.notes.length===0?e.jsx(Cr,{icon:Ee,message:"No notes found in this channel"}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3",children:["Showing up to ",a," notes from the channel"]}),r.notes.map((i,l)=>e.jsx(bd,{noteId:i.noteId,content:i.content,contentLength:i.contentLength,timestampReadable:i.timestampReadable},i.noteId||l))]})})}function Cd({invocation:s}){const t=n=>{const r=n||{},o=["grep"];r.ignoreCase&&o.push("-i"),r.word&&o.push("-w"),r.fixedStrings&&o.push("-F"),r.onlyMatching&&o.push("-o"),r.countOnly&&o.push("-c"),r.listOnly&&o.push("-l"),r.context!==void 0&&o.push("-C",String(r.context)),r.before!==void 0&&o.push("-B",String(r.before)),r.after!==void 0&&o.push("-A",String(r.after)),r.maxMatches!==void 0&&o.push("--max-count",String(r.maxMatches));const i=r.pattern??"",l=`'${String(i).replace(/'/g,"'\\''")}'`;return r.isRegex,o.push("--",l),o.join(" ")},a=({args:n,scope:r,effectiveIncludeCount:o})=>{const i=t(n);return e.jsxs("div",{className:"rounded-md border p-3 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800 space-y-2",children:[e.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Command"}),e.jsx("pre",{className:"text-xs bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-2 py-1 rounded overflow-x-auto",children:i}),e.jsxs("div",{className:"text-xs text-gray-700 dark:text-gray-300",children:[e.jsxs("span",{className:"inline-block mr-2",children:["scope: ",e.jsx("code",{children:r||"global"})]}),typeof o=="number"&&e.jsxs("span",{className:"inline-block",children:["channels: ",e.jsx("code",{children:o})]})]}),e.jsx("div",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:"Scope is enforced by conversation/UI context and is not part of the grep command."})]})};return e.jsx(fa,{invocation:s,icon:e.jsx(Ce,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),title:"Grep Notes",loadingText:"Searching notes...",successStatusText:n=>{const r=n?.summary;if(!r)return"Search finished";const o=r.timedOut?" (timed out)":"";return`Matches ${r.totalMatches} in ${r.matchedNotes}/${r.scannedNotes} notes • ${r.tookMs}ms${o}`},errorStatusText:()=>"Search failed",readyStatusText:"Ready to search",contentScrollable:!0,headerCardClassName:"border-blue-200 dark:border-blue-800",contentCardClassName:"border-gray-200 dark:border-gray-800 mt-2",children:(n,r,o)=>{const i=e.jsx(a,{args:n,effectiveIncludeCount:r?.effectiveIncludeCount});return o?e.jsxs("div",{className:"space-y-3",children:[i,e.jsx(ms,{error:o,fallbackMessage:"An error occurred while searching",variant:"alert"})]}):r?r.noteIds&&r.noteIds.length>0&&(!r.matches||r.matches.length===0)?e.jsxs("div",{className:"space-y-3",children:[i,e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Matched notes:"}),e.jsx("div",{className:"rounded-md border p-3 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800",children:e.jsx("ul",{className:"list-disc pl-6 text-sm",children:r.noteIds.map(l=>e.jsx("li",{children:e.jsx("code",{children:l})},l))})})]}):!r.matches||r.matches.length===0?e.jsxs("div",{className:"space-y-3",children:[i,e.jsx(Cr,{icon:Ce,message:"No matches found"})]}):e.jsxs("div",{className:"space-y-4",children:[i,r.matches.map(l=>e.jsxs("div",{className:"rounded-md border p-3 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-800 space-y-2",children:[e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:["note: ",e.jsx("code",{children:l.noteId})," • channel: ",e.jsx("code",{children:l.channelId})," •"," ",l.timestamp]}),e.jsx("div",{className:"font-mono text-sm",children:l.contexts.map((c,d)=>e.jsxs("div",{className:"mb-3",children:[c.before?.map((u,m)=>e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:u},`b-${m}`)),e.jsx("div",{className:"bg-yellow-100 dark:bg-yellow-900/40 px-1 rounded",children:c.match}),c.after?.map((u,m)=>e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:u},`a-${m}`))]},d))})]},l.noteId))]}):i}})}function kd({invocation:s,onResult:t}){const a=ks(s),n=a?.content||"",r=a?.channelId||"";return e.jsx(ba,{invocation:s,onResult:t,icon:e.jsx(Ee,{className:"h-5 w-5 text-amber-600 dark:text-amber-400"}),title:"Create Note",loadingText:"Preparing parameters...",callStatusText:"Ready to create",preview:()=>e.jsx(Rt,{content:n,variant:"preview",showMetadata:!1}),confirm:async()=>(await _.sendMessage({channelId:r,content:n,sender:"user"}),{status:"created",message:"Note created successfully"}),confirmLabel:"Create Note",confirmIcon:e.jsx(_t,{className:"h-4 w-4"}),resultStatusText:()=>"Note Created Successfully!",resultContent:()=>e.jsxs("div",{className:"space-y-3",children:[e.jsx(Rt,{content:n,variant:"detail",showMetadata:!1}),e.jsx("p",{className:"text-sm text-green-600 dark:text-green-400",children:"Your note has been saved to the channel."})]}),cancelStatusText:"Creation Cancelled"})}function Sd(){return{name:"listNotes",description:"List notes/thoughts in the specified channel, optionally sorted by time",parameters:{type:"object",properties:{limit:{type:"number",description:"Maximum number of notes/thoughts to return (default: 10)"},order:{type:"string",enum:["asc","desc"],description:"Sort order by timestamp (default: desc)"},channelId:{type:"string",description:"ID of the channel to list notes from"}},required:["channelId"]},execute:async s=>{try{console.log("🔔 [listNotesTool][execute][toolCallArgs]:",s);const{limit:t=10,order:a="desc",channelId:n}=s,{userId:r}=T.getState();if(!r)throw new Error("User not signed in");const{messages:o}=await K.fetchInitialMessagesAllSenders(r,n,t);return console.log("🔔 [listNotesTool][execute][messages]:",o),{notes:(a==="asc"?[...o].sort((c,d)=>c.timestamp.getTime()-d.timestamp.getTime()):[...o].sort((c,d)=>d.timestamp.getTime()-c.timestamp.getTime())).map(c=>({content:c.content.substring(0,200)+(c.content.length>200?"...":""),contentLength:c.content.length,timestamp:c.timestamp,timestampReadable:rt(c.timestamp),noteId:c.id}))}}catch(t){throw console.error("🔔 [listNotesTool][execute][error]:",t),new Error(`Failed to list notes: ${t instanceof Error?t.message:"Unknown error"}`)}},render:s=>e.jsx(Nd,{invocation:s})}}class St{notes$=new _e([]);channels$=new _e([]);updateStatus$=new _e({isUpdating:!1,lastUpdateTime:0});channelUpdateStatus$=new _e({});static STALE_MS=3600*1e3;constructor(){this.loadFromCache()}getNotes(t){return this.notes$.pipe(qe(a=>this.filterNotes(a,t)))}getChannels(t){return this.channels$.pipe(qe(a=>this.filterChannels(a,t)))}getNoteById(t){return this.notes$.pipe(qe(a=>a.find(n=>n.id===t)||null))}getUpdateStatus(){return this.updateStatus$}getChannelUpdateStatus(t){return this.channelUpdateStatus$.pipe(qe(a=>a[t]||null))}async updateAll(){this.setUpdateStatus({isUpdating:!0,lastUpdateTime:0});try{const a=(await fe.getCurrentUser())?.uid;if(!a)return;const n=this.getLastFullUpdateTime();if(n&&Date.now()-n<St.STALE_MS){(this.notes$.value.length===0||this.channels$.value.length===0)&&await this.loadFromCache(),this.setUpdateStatus({isUpdating:!1,lastUpdateTime:n});return}const o=await K.fetchChannels(a);let i=[];this.notes$.value.length>0?i=[...this.notes$.value]:i=[...(await this.loadFromIndexedDB()).notes],console.debug("[NoteSearch][updateAll] start",{channels:o.length});for(const l of o){const c=this.getChannelLastUpdateTime(l.id),d=c&&Date.now()-c<St.STALE_MS,u=i.some(p=>p.channelId===l.id);if(d&&u)continue;let m=[];try{const p=await K.fetchInitialMessagesAllSenders(a,l.id,1e3);console.debug("[NoteSearch][updateAll] channel fetched (all senders)",{channelId:l.id,count:p.messages.length}),m=p.messages}catch(p){console.warn("[NoteSearch][updateAll] all-senders fetch failed, fallback to user-only",{channelId:l.id,err:p}),m=(await K.fetchInitialMessages(a,l.id,1e3)).messages}const x=m.map(p=>{const g=p;return{id:g.id,channelId:g.channelId,content:g.content,tags:g.tags||[],aiAnalysis:g.aiAnalysis,timestamp:g.timestamp,sender:g.sender,isDeleted:g.isDeleted||!1}});i=i.filter(p=>p.channelId!==l.id).concat(x),this.notes$.next([...i]),this.setChannelLastUpdateTime(l.id,Date.now())}this.notes$.next(i),this.channels$.next(o),await this.saveToCache(i,o),this.setLastFullUpdateTime(Date.now()),this.setUpdateStatus({isUpdating:!1,lastUpdateTime:Date.now()})}catch(t){console.warn("[NoteSearch][updateAll] failed",t),this.setUpdateStatus({isUpdating:!1,lastUpdateTime:Date.now(),error:t instanceof Error?t.message:"Unknown error"})}}async updateChannel(t){this.setChannelUpdateStatus(t,{isUpdating:!0,lastUpdateTime:0});try{const n=(await fe.getCurrentUser())?.uid;if(!n)return;const r=this.getChannelLastUpdateTime(t);if(r&&Date.now()-r<St.STALE_MS&&(this.notes$.value.length===0&&await this.loadFromCache(),this.notes$.value.some(m=>m.channelId===t))){this.setChannelUpdateStatus(t,{isUpdating:!1,lastUpdateTime:r});return}console.debug("[NoteSearch][updateChannel] start",{channelId:t});let i=[];try{const u=await K.fetchInitialMessagesAllSenders(n,t,1e3);console.debug("[NoteSearch][updateChannel] fetched (all senders)",{channelId:t,count:u.messages.length}),i=u.messages}catch(u){console.warn("[NoteSearch][updateChannel] all-senders fetch failed, fallback to user-only",{channelId:t,err:u}),i=(await K.fetchInitialMessages(n,t,1e3)).messages}const l=i.map(u=>{const m=u;return{id:m.id,channelId:m.channelId,content:m.content,tags:m.tags||[],aiAnalysis:m.aiAnalysis,timestamp:m.timestamp,sender:m.sender,isDeleted:m.isDeleted||!1}}),d=this.notes$.value.filter(u=>u.channelId!==t).concat(l);this.notes$.next(d),await this.saveNotesToCache(d),this.setChannelLastUpdateTime(t,Date.now()),this.setChannelUpdateStatus(t,{isUpdating:!1,lastUpdateTime:Date.now()})}catch(a){console.warn("[NoteSearch][updateChannel] failed",a),this.setChannelUpdateStatus(t,{isUpdating:!1,lastUpdateTime:0})}}async forceUpdate(){await this.updateAll()}filterNotes(t,a){return a?t.filter(n=>{if(a.channelIds&&!a.channelIds.includes(n.channelId)||a.tags&&!a.tags.some(r=>n.tags.includes(r))||a.sender&&n.sender!==a.sender)return!1;if(a.dateRange){const r=new Date(n.timestamp).getTime();if(a.dateRange.start&&r<a.dateRange.start||a.dateRange.end&&r>a.dateRange.end)return!1}return!0}):t}filterChannels(t,a){return a?t.filter(n=>!(a.ids&&!a.ids.includes(n.id)||a.name&&!n.name.toLowerCase().includes(a.name.toLowerCase()))):t}setUpdateStatus(t){this.updateStatus$.next(t)}setChannelUpdateStatus(t,a){const n=this.channelUpdateStatus$.value;this.channelUpdateStatus$.next({...n,[t]:a})}async loadFromCache(){try{const t=await this.loadFromIndexedDB();t.notes.length>0&&this.notes$.next(t.notes),t.channels.length>0&&this.channels$.next(t.channels)}catch(t){console.warn("Failed to load from cache:",t)}}async saveToCache(t,a){try{await this.saveToIndexedDB({notes:t,channels:a})}catch(n){console.warn("Failed to save to cache:",n)}}async saveNotesToCache(t){try{const a=await this.loadFromIndexedDB();await this.saveToIndexedDB({...a,notes:t})}catch(a){console.warn("Failed to save notes to cache:",a)}}async loadFromIndexedDB(){return new Promise((t,a)=>{const n=indexedDB.open("echonote_data",1);n.onupgradeneeded=()=>{const r=n.result;r.objectStoreNames.contains("notes")||r.createObjectStore("notes",{keyPath:"id"}),r.objectStoreNames.contains("channels")||r.createObjectStore("channels",{keyPath:"id"})},n.onsuccess=()=>{const r=n.result,o=r.transaction(["notes","channels"],"readonly"),i=o.objectStore("notes"),l=o.objectStore("channels"),c=i.getAll(),d=l.getAll();Promise.all([new Promise((u,m)=>{c.onsuccess=()=>u(c.result),c.onerror=()=>m(c.error)}),new Promise((u,m)=>{d.onsuccess=()=>u(d.result),d.onerror=()=>m(d.error)})]).then(([u,m])=>{r.close(),t({notes:u,channels:m})}).catch(a)},n.onerror=()=>a(n.error)})}async saveToIndexedDB(t){return new Promise((a,n)=>{const r=indexedDB.open("echonote_data",1);r.onupgradeneeded=()=>{const o=r.result;o.objectStoreNames.contains("notes")||o.createObjectStore("notes",{keyPath:"id"}),o.objectStoreNames.contains("channels")||o.createObjectStore("channels",{keyPath:"id"})},r.onsuccess=()=>{const o=r.result,i=o.transaction(["notes","channels"],"readwrite"),l=i.objectStore("notes"),c=i.objectStore("channels");l.clear(),c.clear(),t.notes.forEach(d=>l.add(d)),t.channels.forEach(d=>c.add(d)),i.oncomplete=()=>{o.close(),a()},i.onerror=()=>n(i.error)},r.onerror=()=>n(r.error)})}getLastFullUpdateTime(){if(typeof window>"u")return null;const t=window.localStorage.getItem("echonote_search_last_full_update");return t?Number(t):null}setLastFullUpdateTime(t){typeof window>"u"||window.localStorage.setItem("echonote_search_last_full_update",String(t))}getChannelLastUpdateTime(t){if(typeof window>"u")return null;const a=window.localStorage.getItem(`echonote_search_channel_update_${t}`);return a?Number(a):null}setChannelLastUpdateTime(t,a){typeof window>"u"||window.localStorage.setItem(`echonote_search_channel_update_${t}`,String(a))}}const be=new St;function Id(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Md(s){const t=s.pattern??"",a=s.ignoreCase?"i":"";if(!t)return{test:()=>({matched:!1})};if(s.fixedStrings){const i=s.ignoreCase?t.toLowerCase():t;return{test:l=>{const d=(s.ignoreCase?l.toLowerCase():l).indexOf(i);return{matched:d>=0,matchText:t,index:d>=0?d:void 0}}}}const n=s.isRegex?t:Id(t),r=s.word?`\\b${n}\\b`:n;let o;try{o=new RegExp(r,a)}catch{const i=s.ignoreCase?t.toLowerCase():t;return{test:l=>{const d=(s.ignoreCase?l.toLowerCase():l).indexOf(i);return{matched:d>=0,matchText:t,index:d>=0?d:void 0}}}}return{test:i=>{const l=o.exec(i);return{matched:!!l,matchText:l?.[0],index:l?.index}}}}async function Ed(s){const t=Date.now(),a=Math.max(500,Math.min(s.timeoutMs??3e3,15e3)),n=Math.max(1,Math.min(s.maxMatches??200,5e3)),r=Math.max(1,Math.min(s.maxNotes??500,5e3)),o=s.context!==void 0?s.context:s.before??0,i=s.context!==void 0?s.context:s.after??0,l={};let c="global",d=null;if(s.includeChannels&&s.includeChannels.length>0)d=s.includeChannels,c="args";else{const v=$.getState(),y=v.currentConversationId,I=v.conversations.find(w=>w.id===y),C=I?.contexts?.mode;if(C==="channels"&&I?.contexts?.channelIds&&I.contexts.channelIds.length>0)d=I.contexts.channelIds,c="contexts:channels";else if(C==="all")d=null,c="contexts:all";else{const{currentChannelId:w}=O.getState();w?(d=[w],c="currentChannel"):(d=null,c="global")}}if(d&&d.length>0&&(l.channelIds=d),s.tags&&s.tags.length>0&&(l.tags=s.tags),s.sender&&(l.sender=s.sender),s.dateRange){const v=s.dateRange.start??0,y=s.dateRange.end??Number.MAX_SAFE_INTEGER;l.dateRange={start:v,end:y}}let u=await wt(be.getNotes(l));if(u.length===0||s.includeChannels&&s.includeChannels.every(v=>!u.some(y=>y.channelId===v)))try{if(s.includeChannels&&s.includeChannels.length>0)for(const v of s.includeChannels)await be.updateChannel(v);else await be.updateAll();u=await wt(be.getNotes(l))}catch{}if(s.excludeChannels&&s.excludeChannels.length>0){const v=new Set(s.excludeChannels);u=u.filter(y=>!v.has(y.channelId))}let m=0,x=0,p=0;const g=[],f=Md(s);for(const v of u){if(Date.now()-t>a||m>=r)break;m++;const y=v.content||"";if(!y)continue;const I=y.split(/\r?\n/),C=[];let w=!1;for(let k=0;k<I.length;k++){const R=I[k],E=f.test(R);if(E.matched){w=!0,p++;const S=[],M=[];for(let Y=Math.max(0,k-o);Y<k;Y++)S.push(I[Y]);for(let Y=k+1;Y<=Math.min(I.length-1,k+i);Y++)M.push(I[Y]);const A=s.onlyMatching&&E.matchText?E.matchText:R;if(C.push({before:S,match:A,after:M,line:k+1,offset:E.index}),p>=n)break}if(Date.now()-t>a)break}if(w&&(x++,s.countOnly||g.push({noteId:v.id,channelId:v.channelId,timestamp:v.timestamp?.toLocaleString?.()||"",contexts:C})),p>=n)break}const b={summary:{scannedNotes:m,matchedNotes:x,totalMatches:p,tookMs:Date.now()-t,timedOut:Date.now()-t>a},scope:c,effectiveIncludeCount:d?d.length:void 0};return s.countOnly||(s.listOnly?b.noteIds=g.map(v=>v.noteId):b.matches=g),b}function Td(){return{name:"grepNotes",description:"Search notes with grep-like semantics. Supports regex, case-insensitive, word boundary, context lines, and filtering by channel/tags/date.",parameters:{type:"object",properties:{pattern:{type:"string",description:"Search pattern (string or regex source when isRegex=true)"},isRegex:{type:"boolean"},ignoreCase:{type:"boolean"},word:{type:"boolean"},fixedStrings:{type:"boolean"},before:{type:"number"},after:{type:"number"},context:{type:"number"},countOnly:{type:"boolean"},listOnly:{type:"boolean"},onlyMatching:{type:"boolean"},includeChannels:{type:"array",items:{type:"string"}},excludeChannels:{type:"array",items:{type:"string"}},tags:{type:"array",items:{type:"string"}},sender:{type:"string",enum:["user","ai"]},dateRange:{type:"object",properties:{start:{type:"number"},end:{type:"number"}}},maxMatches:{type:"number"},maxNotes:{type:"number"},snippetSize:{type:"number"},timeoutMs:{type:"number"}},required:["pattern"]},execute:async s=>await Ed(s),render:s=>st.createElement(Cd,{invocation:s})}}async function Ad(s,t){const r=_.dataContainer.get().messageByChannel[s];if(r&&!r.loading)return;r||_.requestLoadInitialMessages$.next({channelId:s});const o=Date.now();await new Promise((i,l)=>{const c=()=>{const d=_.dataContainer.get().messageByChannel[s];if(d&&!d.loading)return i();if(Date.now()-o>1e4)return l(new Error(`Timeout waiting channel ${s} messages to load`));setTimeout(c,100)};c()})}class Ld{getChannelTools(){console.log("🔔 [ChannelToolsManager][getChannelTools] creating tools");const t=[this.createNoteTool(),this.readNoteTool(),this.updateNoteTool(),this.deleteNoteTool(),this.listNotesTool(),this.grepNotesTool()];return console.log("🔔 [ChannelToolsManager][getChannelTools] created tools:",t.map(a=>({name:a.name,description:a.description}))),t}createNoteTool(){return{name:"createNote",description:"Create a new note/thought in the specified channel (requires user confirmation).",parameters:{type:"object",properties:{content:{type:"string",description:"Content of the note/thought"},channelId:{type:"string",description:"ID of the channel to create the note in"}},required:["content","channelId"]},render:(t,a)=>h.createElement(kd,{invocation:t,onResult:a})}}readNoteTool(){return{name:"readNote",description:"Read a specific note/thought by its ID from the specified channel",parameters:{type:"object",properties:{noteId:{type:"string",description:"ID of the note/thought to read"},channelId:{type:"string",description:"ID of the channel to read the note from"}},required:["noteId","channelId"]},execute:async t=>{const{noteId:a,channelId:n}=t;try{await Ad(n);const r=_.dataContainer.get().messageByChannel[n],o=r?.messages.find(i=>i.id===a);if(console.log("🔔 [readNoteTool][result]:",{noteId:a,note:o?{id:o.id,content:o.content.substring(0,50)+"..."}:null,channelState:r?{messagesCount:r.messages?.length||0}:null}),!o)throw new Error(`Note with ID ${a} not found`);return{found:!0,noteId:o.id,content:o.content,timestamp:o.timestamp,timestampReadable:o.timestamp.toLocaleString(),contentLength:o.content.length}}catch(r){throw console.error("🔔 [readNoteTool][error]:",r),new Error(`Failed to read note: ${r instanceof Error?r.message:"Unknown error"}`)}},render:t=>h.createElement(jd,{invocation:t})}}updateNoteTool(){return{name:"updateNote",description:"Update an existing note/thought by its ID in the specified channel (requires user confirmation).",parameters:{type:"object",properties:{noteId:{type:"string",description:"ID of the note/thought to update"},content:{type:"string",description:"New content for the note/thought"},channelId:{type:"string",description:"ID of the channel containing the note"}},required:["noteId","content","channelId"]},render:(t,a)=>h.createElement(yd,{invocation:t,onResult:a})}}deleteNoteTool(){return{name:"deleteNote",description:"Delete a note/thought by its ID from the specified channel (requires user confirmation).",parameters:{type:"object",properties:{noteId:{type:"string",description:"ID of the note/thought to delete"},channelId:{type:"string",description:"ID of the channel containing the note"}},required:["noteId","channelId"]},render:(t,a)=>h.createElement(wd,{invocation:t,onResult:a})}}listNotesTool(){return Sd()}grepNotesTool(){return Td()}}const Rd=new Ld;class Dd{summarizeMessages(t,a){const n=t.filter(i=>i.sender==="user");if(n.length===0)return[{description:"No user content available",value:JSON.stringify({message:"No user thoughts or notes found in this context."})}];const r=n.reduce((i,l)=>{const c=l.channelId;return i[c]||(i[c]=[]),i[c].push(l),i},{}),o=[];return Object.entries(r).forEach(([i,l])=>{const c=T.getState().channels.find(u=>u.id===i),d=l.sort((u,m)=>m.timestamp.getTime()-u.timestamp.getTime());o.push({description:`Channel ${i} - All messages (${d.length} messages)`,value:JSON.stringify({channelId:i,messageCount:c?.messageCount,channelName:c?.name,messages:d.map(u=>({id:u.id,content:u.content,timestamp:u.timestamp.toISOString(),sender:u.sender,channelId:u.channelId,tags:u.tags}))})})}),o}}class _d{TIER_LIMITS={latest:1e4,recent:2e3,historical:300,archive:30};MAX_LENGTH=35e3;summarizeMessages(t,a){const n=a||this.MAX_LENGTH,r=t.filter(l=>l.sender==="user");if(r.length===0)return[{description:"User Notes Context",value:JSON.stringify({empty:!0,message:"No user notes available"})}];const o=this.groupMessagesByTier(r),i=this.buildContextJSON(o,n);return[{description:"User Notes Context (Structured)",value:JSON.stringify(i)}]}groupMessagesByTier(t){const a=[{name:"1",description:"Most recent note (full content)",items:[],charLimit:this.TIER_LIMITS.latest},{name:"2-5",description:"Recent notes (detailed)",items:[],charLimit:this.TIER_LIMITS.recent},{name:"6-30",description:"Historical notes (summarized)",items:[],charLimit:this.TIER_LIMITS.historical},{name:"31+",description:"Archive notes (brief)",items:[],charLimit:this.TIER_LIMITS.archive}];return t.forEach((n,r)=>{const o=this.getMessageGroupIndex(r);o>=0&&o<a.length&&a[o].items.push(n)}),a}getMessageGroupIndex(t){return t===0?0:t>=1&&t<=4?1:t>=5&&t<=29?2:3}buildContextJSON(t,a){const n=t.flatMap(c=>c.items);if(n.length===0)return{empty:!0,message:"No user notes available",sampling_rules:this.getSamplingRulesDescription()};const r={sampling_rules:this.getSamplingRulesDescription(),groups:[]};let o=0,i=0;for(const c of t){if(c.items.length===0)continue;const d=this.buildGroupJSON(c),u=this.getTextLength(JSON.stringify(d));if(o+u<=a)r.groups.push(d),o+=u,i+=c.items.length;else break}const l=n.length-i;return l>0&&(r.additional_notes={count:l,message:"Use search tools to access more content"}),r}buildGroupJSON(t){const a={name:t.name,description:t.description,items:[]};return t.items.forEach(n=>{const r=this.processMessageContent(n,t.charLimit),o={id:n.id,timestamp:n.timestamp.toISOString(),channel_id:n.channelId,content:r.content};r.truncated&&(o.truncated=!0,o.original_length=r.originalLength,o.truncated_length=r.truncatedLength),a.items.push(o)}),a}processMessageContent(t,a){if(t.content.length<=a)return{content:t.content};const n=this.truncateContent(t.content,a);return{content:n,truncated:!0,originalLength:t.content.length,truncatedLength:n.length}}truncateContent(t,a){if(t.length<=a)return t;const n=.7,r=.3,o="...",i=Math.floor(a*n),l=Math.floor(a*r),c=Math.max(0,i-o.length),d=Math.max(0,l-o.length),u=t.substring(0,c),m=t.substring(t.length-d);return`${u}${o}${m}`}getTextLength(t){return t?.length||0}getSamplingRulesDescription(){return`USER NOTES CONTEXT ORGANIZATION:

Notes are sorted by timestamp (newest first) and organized into groups by position with different detail levels:

1. POSITION 1 (Most Recent):
   - Contains: The single most recent user note
   - Detail level: FULL CONTENT (up to ${this.TIER_LIMITS.latest} characters)
   - Purpose: Provides complete context of user's latest thoughts
   - Usage: Reference for immediate context and current user state

2. POSITIONS 2-5 (Recent Notes):
   - Contains: Notes from positions 2, 3, 4, and 5 (if they exist)
   - Detail level: DETAILED (up to ${this.TIER_LIMITS.recent} characters each)
   - Purpose: Recent context and immediate history
   - Usage: Understanding recent user patterns and immediate background

3. POSITIONS 6-30 (Historical Notes):
   - Contains: Notes from positions 6 through 30 (if they exist)
   - Detail level: SUMMARIZED (up to ${this.TIER_LIMITS.historical} characters each)
   - Purpose: Historical context and patterns
   - Usage: Understanding user's longer-term thinking patterns and themes

4. POSITIONS 31+ (Archive Notes):
   - Contains: All notes from position 31 onwards (if they exist)
   - Detail level: BRIEF (up to ${this.TIER_LIMITS.archive} characters each)
   - Purpose: Distant historical context
   - Usage: Identifying long-term themes and patterns

CONTENT PROCESSING:
- Long content is intelligently truncated preserving 70% from start + 30% from end
- Truncated items include metadata: truncated=true, original_length, truncated_length
- Each note includes: id, timestamp, channel_id, content
- Use search tools to access full content of truncated or additional notes

GROUP STRUCTURE:
Each group contains: name (position range), description (purpose), and items array (actual notes)
Groups are processed in priority order (1 → 2-5 → 6-30 → 31+) until token limit is reached`}debugSummarizeMessages(t){const a=t||this.generateSampleMessages();console.group("🔍 Message Summarizer Debug"),console.log("📝 Input Messages:",a);const n=this.summarizeMessages(a);if(console.log("📊 Summary Result:",n),n[0]?.value)try{const r=JSON.parse(n[0].value);console.log("📋 Parsed JSON:",r),console.log("📏 Length:",this.getTextLength(n[0].value)),console.log("📐 Character Count:",n[0].value.length)}catch(r){console.error("❌ Failed to parse JSON:",r)}console.groupEnd()}generateSampleMessages(){const t=new Date;return[{id:"1",content:"This is the latest note with full content that should be preserved completely. It contains important information about the current project status and next steps.",timestamp:new Date(t.getTime()-1e3*60*5),sender:"user",channelId:"channel1"},{id:"2",content:"This is a recent note that should be included with good detail. It discusses the implementation approach and technical considerations.",timestamp:new Date(t.getTime()-1e3*60*30),sender:"user",channelId:"channel1"},{id:"3",content:"This is a historical note that should be summarized. It contains older information that is less critical but still relevant for context.",timestamp:new Date(t.getTime()-1e3*60*60*2),sender:"user",channelId:"channel2"},{id:"4",content:"This is an archive note that should be brief. Very old information that provides minimal context.",timestamp:new Date(t.getTime()-1e3*60*60*24),sender:"user",channelId:"channel1"}]}}class Sr{rawSummarizer=new Dd;tieredSummarizer=new _d;LENGTH_LIMIT=3e4;summarizeMessages(t){if(t.length===0)return[];const a=this.rawSummarizer.summarizeMessages(t),n=this.calculateTotalLength(a);if(n<=this.LENGTH_LIMIT)return console.log(`[HybridMessageSummarizer] Using raw strategy (${n} chars)`),a;console.log(`[HybridMessageSummarizer] Raw strategy exceeds limit (${n} chars), switching to tiered strategy`);const r=this.tieredSummarizer.summarizeMessages(t),o=this.calculateTotalLength(r);return console.log(`[HybridMessageSummarizer] Tiered strategy result: ${o} chars`),r}calculateTotalLength(t){return t.reduce((a,n)=>a+(n.value?.length||0),0)}getStrategyInfo(t){const a=this.rawSummarizer.summarizeMessages(t),n=this.tieredSummarizer.summarizeMessages(t),r=this.calculateTotalLength(a),o=this.calculateTotalLength(n),i=r<=this.LENGTH_LIMIT,l=i?"raw":"tiered";return{messageCount:t.length,rawLength:r,tieredLength:o,strategyUsed:l,withinLimit:i}}}function Pd(s,t,a){return`You are StillRoot AI, a specialized assistant focused on personal growth and cognitive enhancement. Your mission is to help users become who they want to be.

You are currently assisting in the channel: ${s}
This channel contains ${t} thought records that represent the collective knowledge and ideas of the team.

## Your Three Core Objectives (in priority order):

### Objective 1: Personal Growth Supervision & Guidance (Highest Priority)
- Actively monitor users' growth progress and regularly review their status
- Provide objective and comprehensive analysis, pointing out problems in users' thinking and behavior
- Offer specific improvement suggestions and action plans
- Act like a responsible mentor who supervises and encourages user growth

### Objective 2: Uncovering Problem Essence & Achieving High Cognition (Medium Priority)
- Help users dig deeper from surface phenomena to underlying essence and patterns
- Guide users to achieve higher levels of cognition and understanding
- Encourage users to question assumptions and break through cognitive boundaries
- Provide multi-dimensional thinking frameworks

### Objective 3: Knowledge Insight Discovery (Basic Priority)
- Analyze hidden connections between notes and identify recurring themes
- Discover users' knowledge blind spots and cognitive gaps
- Provide new insights and connections
- Help users build comprehensive knowledge systems

## Your Working Approach:
In every conversation, you should:
1. First focus on the user's growth status, actively analyze and point out problems
2. Then help users uncover the essence of problems and enhance cognitive levels
3. Finally provide insights and discoveries from a knowledge perspective

## Terminology clarification:
- 'Thoughts' and 'Notes' are interchangeable terms in this platform
- A thought record is the same as a note - both represent user-created content
- When users refer to notes, thoughts, or thought records, they mean the same thing

## Important Rules:
- DO NOT create thoughts/notes unless explicitly requested by the user
- Focus on analyzing, organizing, and providing insights about existing content
- Suggest improvements and connections, but don't generate new content without permission
- Maintain an objective but warm attitude
- Actively identify problems without avoiding pointing out shortcomings
- Provide specific and actionable suggestions
- Always prioritize user growth and happiness as the ultimate goal

## Tool Usage Guidelines:
- When using any tool (createNote, readNote, updateNote, deleteNote, listNotes), you MUST provide the channelId parameter
- The channelId should be the ID of the channel you want to operate on
- For operations in the current channel, use the channelId: "${a}"
- For operations in other channels, use the specific channel ID provided by the user
- Always specify the channelId explicitly - it is a required parameter for all tools
- AVOID calling readNote if you already have the complete note content from conversation context

Always be concise, actionable, and focused on helping users maximize their potential in this collaborative knowledge space.`}class Od{summarizer=new Sr;getChannelContext(t){const a=_.dataContainer.get().messageByChannel[t],{channels:n}=T.getState(),r=n.find(c=>c.id===t),o=a?.messages||[];if(!r)return[{description:"Channel Context",value:JSON.stringify({info:"Channel meta loading...",channelId:t,timestamp:new Date().toISOString()})}];const i=o.filter(c=>c.sender==="user").sort((c,d)=>d.timestamp.getTime()-c.timestamp.getTime()),l=this.summarizer.summarizeMessages(i);return[{description:"System Instructions",value:JSON.stringify({instructions:Pd(r.name,i.length,t)})},...l]}}const $d=new Od;var D=(s=>(s.NONE="none",s.CHANNELS="channels",s.ALL="all",s.AUTO="auto",s))(D||{});const Gt=1e3;class Ud{summarizer=new Sr;generateSystemInstructions(t,a,n,r){const o=t>1;return`You are StillRoot AI, a specialized assistant focused on personal growth and cognitive enhancement. Your mission is to help users become who they want to be.

You are currently assisting in ${o?`a multi-channel context spanning ${t} channels: ${n.join(", ")}`:`the channel: ${n[0]}`}
This context contains ${a} thought records, representing the collective knowledge and ideas.

## Your Three Core Objectives (in priority order):

### Objective 1: Personal Growth Supervision & Guidance (Highest Priority)
- Actively monitor users' growth progress and regularly review their status
- Provide objective and comprehensive analysis, pointing out problems in users' thinking and behavior
- Offer specific improvement suggestions and action plans
- Act like a responsible mentor who supervises and encourages user growth

### Objective 2: Uncovering Problem Essence & Achieving High Cognition (Medium Priority)
- Help users dig deeper from surface phenomena to underlying essence and patterns
- Guide users to achieve higher levels of cognition and understanding
- Encourage users to question assumptions and break through cognitive boundaries
- Provide multi-dimensional thinking frameworks

### Objective 3: Knowledge Insight Discovery (Basic Priority)
- Analyze hidden connections between notes${o?" across different channels":""}
- Discover users' knowledge blind spots and cognitive gaps
- Provide new insights and connections${o?" across channel boundaries":""}
- Help users build comprehensive knowledge systems

## Your Working Approach:
In every conversation, you should:
1. First focus on the user's growth status, actively analyze and point out problems
2. Then help users uncover the essence of problems and enhance cognitive levels
3. Finally provide insights and discoveries from a knowledge perspective

## Context Understanding:
${o?`- You have access to notes from multiple channels, each representing different topics or contexts
- Notes are organized by recency with different detail levels across all channels
- Use channel information to understand the source and context of each note
- Look for patterns and connections that span across different channels`:`- You have access to notes from this channel, representing the user's thoughts and ideas
- Notes are organized by recency with different detail levels
- Use this context to understand the user's thinking patterns and provide relevant insights`}

## Terminology clarification:
- 'Thoughts' and 'Notes' are interchangeable terms in this platform
- A thought record is the same as a note - both represent user-created content
- When users refer to notes, thoughts, or thought records, they mean the same thing

## Important Rules:
- DO NOT create thoughts/notes unless explicitly requested by the user
- Focus on analyzing, organizing, and providing insights about existing content
- Suggest improvements and connections, but don't generate new content without permission
- Maintain an objective but warm attitude
- Actively identify problems without avoiding pointing out shortcomings
- Provide specific and actionable suggestions
- Always prioritize user growth and happiness as the ultimate goal

## Tool Usage Guidelines:
- When using any tool (createNote, readNote, updateNote, deleteNote, listNotes), you MUST provide the channelId parameter
- The channelId should be the ID of the channel you want to operate on
- For operations in the current context, use the channelId: "${r}"
- For operations in other channels, use the specific channel ID provided by the user
- Always specify the channelId explicitly - it is a required parameter for all tools
- AVOID calling readNote if you already have the complete note content from conversation context

Always be concise, actionable, and focused on helping users maximize their potential in this collaborative knowledge space.`}ensureContextsLoaded(t,a){if(!t){const o=_.dataContainer.get().messageByChannel[a];(!o||o.hasMore)&&_.requestLoadInitialMessages$.next({channelId:a,messageLimit:Gt});return}const{mode:n,channelIds:r}=t;if(n===D.AUTO){const o=O.getState().currentChannelId,i=_.dataContainer.get().messageByChannel[o];(!i||i.hasMore)&&_.requestLoadInitialMessages$.next({channelId:o,messageLimit:Gt});return}if(n===D.CHANNELS&&r)r.forEach(o=>{const i=_.dataContainer.get().messageByChannel[o];(!i||i.hasMore)&&_.requestLoadInitialMessages$.next({channelId:o,messageLimit:Gt})});else if(n===D.ALL){const{channels:o}=T.getState();o.forEach(i=>{const l=_.dataContainer.get().messageByChannel[i.id];(!l||l.hasMore)&&_.requestLoadInitialMessages$.next({channelId:i.id,messageLimit:Gt})})}}getSessionContexts(t,a){const n=$.getState().conversations.find(d=>d.id===t);if(!n||!n.contexts)return this.getUnifiedContext([a]);const{mode:r,channelIds:o}=n.contexts;if(r===D.NONE)return[{description:"System Instructions",value:JSON.stringify({instructions:"No external context is attached to this conversation. Respond based on user input only unless the user explicitly asks to reference notes."})}];if(r===D.CHANNELS){const d=o||[];return d.length===0?[]:this.getUnifiedContext(d)}const{channels:i}=T.getState(),l=_.dataContainer.get().messageByChannel,c=i.map(d=>d.id).filter(d=>{const u=l[d];return u&&!u.loading});return c.length===0?this.getUnifiedContext([a]):this.getUnifiedContext(c)}getUnifiedContext(t){const{channels:a}=T.getState(),n=_.dataContainer.get().messageByChannel,r=[];t.forEach(u=>{const m=a.find(p=>p.id===u),x=n[u];if(m&&x?.messages){const p=x.messages.filter(g=>g.sender==="user").map(g=>({...g,channelId:u,channelName:m.name}));r.push(...p)}}),r.sort((u,m)=>m.timestamp.getTime()-u.timestamp.getTime());const o=this.summarizer.summarizeMessages(r),i=t.map(u=>{const m=a.find(x=>x.id===u);return{id:u,name:m?.name||"Unknown",note_count:m?.messageCount||0}}),l=i.map(u=>u.name),c=r.length;return[{description:"System Instructions",value:this.generateSystemInstructions(t.length,c,l,t[0])},{description:"Channel Information",value:JSON.stringify({channels:i,total_channels:t.length,total_notes:c})},...o]}}const va=new Ud;function Fd({conversationId:s,fallbackChannelId:t,onActiveToolChannelChange:a,activeToolChannelId:n}){const r=$(p=>p.conversations.find(g=>g.id===s)),o=$(p=>p.updateConversation),{userId:i}=T(),[l,c]=h.useState(r?.contexts?r.contexts.mode:D.AUTO),[d,u]=h.useState(r?.contexts?.mode===D.CHANNELS?r?.contexts?.channelIds||[t]:[t]);h.useEffect(()=>{c(r?.contexts?r.contexts.mode:D.AUTO),u(r?.contexts?.mode===D.CHANNELS?r?.contexts?.channelIds||[t]:[t])},[s,r?.contexts,t]);const m=h.useCallback(p=>{u(g=>g.includes(p)?g.filter(f=>f!==p):[...g,p])},[]),x=h.useCallback(async()=>{if(!i||!r)return;if(l===D.AUTO){await o(i,r.id,{contexts:{mode:D.AUTO}});return}let p;if(l===D.NONE)p={mode:D.NONE};else if(l===D.ALL)p={mode:D.ALL};else{const g=d.length?d:[t];if(p={mode:D.CHANNELS,channelIds:g},a){const f=n&&g.includes(n)?n:g[0];a(f)}}await o(i,r.id,{contexts:p}),va.ensureContextsLoaded(p,t)},[i,r,l,d,t,a,n,o]);return{draftMode:l,setDraftMode:c,draftChannelIds:d,toggleChannel:m,apply:x,isSelectedMode:l===D.CHANNELS}}function zd(s,t,a,n){if(s===D.AUTO)return[a];if(s===D.NONE)return[];if(s===D.CHANNELS){const r=t?.channelIds||[];return r.length>0?r:[a]}else return n.map(r=>r.id)}function Bd(s,t,a){return s.length===0?"":s.map(r=>{const o=t[r],i=a(r),l=o?.loading?"loading":"ready";return`${i}(${l})`}).join(", ")}function Hd({conversationId:s,fallbackChannelId:t,contexts:a,getChannelName:n}){const r=_.dataContainer.use(),{channels:o}=T();h.useEffect(()=>{va.ensureContextsLoaded(a||null,t)},[s,t,a]);const{anyLoading:i,tooltip:l}=h.useMemo(()=>{const c=a?a.mode:D.AUTO,d=zd(c,a,t,o),m=d.map(p=>r.messageByChannel[p]?.loading||!1).some(p=>p),x=Bd(d,r.messageByChannel,n);return{anyLoading:m,tooltip:x}},[a,t,o,r,n]);return{anyLoading:i,tooltip:l}}function Gd(s){const[t,a]=h.useState(""),n=O(o=>o.currentChannelId),r=h.useMemo(()=>{let o=s;if(t.trim()){const i=t.toLowerCase();o=s.filter(l=>l.name.toLowerCase().includes(i)||l.description?.toLowerCase().includes(i))}return o.sort((i,l)=>{if(n){if(i.id===n&&l.id!==n)return-1;if(l.id===n&&i.id!==n)return 1}return i.messageCount!==l.messageCount?l.messageCount-i.messageCount:i.name.localeCompare(l.name)})},[s,t,n]);return{searchQuery:t,setSearchQuery:a,filteredChannels:r}}function Vd({contexts:s,fallbackChannelId:t,getChannelName:a,channelsLength:n}){const r=h.useMemo(()=>{const l=s;if(!l)return`Auto (${a(t)})`;if(l.mode===D.NONE)return"No Context";if(l.mode===D.ALL)return"All Spaces";const c=l.channelIds||[];return c.length===0?"No Context":(c.length===1,a(c[0]))},[s,t,a]),o=h.useMemo(()=>{const l=s;if(!l||l.mode!==D.CHANNELS)return 0;const c=l.channelIds||[];return Math.max(0,c.length-1)},[s]),i=h.useMemo(()=>{const l=s;return l?l.mode===D.NONE?0:l.mode===D.ALL?n:(l.channelIds||[]).length:1},[s,n]);return{label:r,otherCount:o,totalCount:i}}function Vt({mode:s,currentMode:t,icon:a,title:n,description:r,onClick:o,showChevron:i=!1,isExpanded:l=!1}){const c=t===s;return e.jsxs("div",{className:j("flex items-center gap-2.5 px-2.5 py-2 rounded-lg cursor-pointer transition-all duration-200",c?"bg-primary/8 text-primary":"hover:bg-accent/30 text-foreground"),onClick:o,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("div",{className:j("transition-colors",c?"text-primary":"text-muted-foreground"),children:a}),e.jsx("span",{className:"text-sm font-medium",children:n})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground/70",children:r}),i&&e.jsx(we,{className:j("w-3.5 h-3.5 text-muted-foreground/60 transition-all duration-200",l?"rotate-180":"")})]})]})}function qd({searchQuery:s,setSearchQuery:t,filteredChannels:a,draftChannelIds:n,toggleChannel:r,fallbackChannelId:o}){return e.jsxs("div",{className:"bg-muted/35 border border-muted/50 rounded-lg shadow-sm transition-all",children:[e.jsx("div",{className:"p-2.5 border-b border-muted/45 bg-muted/15",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ce,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground/60"}),e.jsx(ye,{placeholder:"Search spaces...",value:s,onChange:i=>t(i.target.value),className:"pl-9 h-7 text-sm border-0 bg-background/95 focus:bg-background focus:ring-1 focus:ring-primary/20"})]})}),e.jsx("div",{className:"max-h-32 overflow-y-auto",children:a.length===0?e.jsxs("div",{className:"text-center py-6",children:[e.jsx("div",{className:"text-muted-foreground/50 mb-1.5 text-lg",children:s?"🔍":"📁"}),e.jsx("div",{className:"text-xs text-muted-foreground/70",children:s?"No spaces found":"No spaces available"})]}):e.jsx("div",{className:"p-1.5 space-y-0.5",children:a.map(i=>{const l=n.includes(i.id),c=i.id===o;return e.jsxs("div",{className:j("flex items-center gap-2.5 px-2.5 py-1.5 rounded-lg text-sm transition-all duration-200 cursor-pointer",l?"bg-primary/6 text-primary":"hover:bg-accent/25 text-foreground"),onClick:()=>r(i.id),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("span",{className:"text-sm",children:i.emoji||"📝"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:i.name}),c&&e.jsx("div",{className:"text-xs text-primary/80",children:"Current space"})]})]}),l&&e.jsx(Ue,{className:"w-4 h-4 text-primary"})]},i.id)})})})]})}function Wd({activeToolChannelId:s,draftChannelIds:t,onActiveToolChannelChange:a,getChannelName:n}){return e.jsxs("div",{className:"p-2.5 rounded-lg bg-muted/35 border border-muted/50 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(qt,{className:"w-4 h-4 text-muted-foreground/70"}),e.jsx("span",{className:"text-sm font-medium text-foreground/90",children:"Active Tool Space"})]}),e.jsxs("select",{value:s&&t.includes(s)?s:t[0]||"",onChange:r=>a(r.target.value||null),className:"w-full h-7 px-2.5 rounded-lg border-0 bg-background/95 text-sm focus:bg-background focus:ring-1 focus:ring-primary/20 transition-all duration-200",children:[t.length===0&&e.jsx("option",{value:"",children:"(none)"}),t.map(r=>e.jsx("option",{value:r,children:n(r)},r))]})]})}function Ir({conversationId:s,fallbackChannelId:t,onActiveToolChannelChange:a,activeToolChannelId:n,variant:r="inline"}){const[o,i]=h.useState(!1),l=$(M=>M.conversations.find(A=>A.id===s)),{channels:c}=T(),d=h.useCallback(M=>c.find(A=>A.id===M)?.name||M,[c]),{draftMode:u,setDraftMode:m,draftChannelIds:x,toggleChannel:p,apply:g}=Fd({conversationId:s,fallbackChannelId:t,onActiveToolChannelChange:a,activeToolChannelId:n}),{searchQuery:f,setSearchQuery:b,filteredChannels:v}=Gd(c),{anyLoading:y,tooltip:I}=Hd({conversationId:s,fallbackChannelId:t,contexts:l?.contexts,getChannelName:d}),{label:C,otherCount:w,totalCount:k}=Vd({contexts:l?.contexts,fallbackChannelId:t,getChannelName:d,channelsLength:c.length}),[R,E]=h.useState(u===D.CHANNELS),S=r==="banner"?"flex items-center gap-2 px-3 py-2 border-b bg-background/60":r==="compact"?"inline-flex items-center":"inline-flex items-center gap-1";return e.jsx("div",{className:S,children:e.jsxs(P,{open:o,onOpenChange:i,modal:!0,children:[e.jsx(P.Trigger,{asChild:!0,children:r==="compact"?e.jsxs("button",{type:"button","aria-label":`Context: ${C}`,title:I||C,className:"relative h-8 w-8 inline-flex items-center justify-center rounded-md hover:bg-accent",children:[(()=>{const M=l?.contexts;return M?M.mode===D.NONE?e.jsx(Ms,{className:"w-4 h-4"}):M.mode===D.ALL?e.jsx(Es,{className:"w-4 h-4"}):M.mode===D.CHANNELS?e.jsx(Ts,{className:"w-4 h-4"}):e.jsx(qt,{className:"w-4 h-4"}):e.jsx(et,{className:"w-4 h-4"})})(),k>0&&e.jsx("span",{className:"absolute top-0 right-0.5 min-w-[14px] h-3 px-1 rounded-full bg-muted text-foreground/80 text-[10px] leading-3 flex items-center justify-center",children:k}),e.jsx("span",{className:"absolute bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full "+(y?"bg-primary animate-pulse":"bg-emerald-500")})]}):e.jsxs("button",{type:"button",title:I||C,className:"relative inline-flex items-center gap-1.5 text-sm px-2.5 py-1.5 rounded-md bg-background/50 backdrop-blur-sm border border-border/30 shadow-xs hover:shadow-sm hover:border-border/50 hover:bg-accent/30 text-muted-foreground hover:text-foreground transition-all duration-200 ease-out",children:[(()=>{const M=l?.contexts;return!M||M.mode===D.AUTO?e.jsx(et,{className:"w-4 h-4 text-muted-foreground/70"}):M.mode===D.NONE?e.jsx(Ms,{className:"w-4 h-4 text-muted-foreground/70"}):M.mode===D.ALL?e.jsx(Es,{className:"w-4 h-4 text-muted-foreground/70"}):M.mode===D.CHANNELS?e.jsx(Ts,{className:"w-4 h-4 text-muted-foreground/70"}):e.jsx(qt,{className:"w-4 h-4 text-muted-foreground/70"})})(),e.jsx("span",{className:"font-medium text-foreground/90 truncate max-w-[10rem]",children:C}),w>0&&e.jsxs("span",{className:"ml-0.5 inline-flex items-center justify-center px-1 rounded-sm border bg-muted text-foreground/80 whitespace-nowrap",children:["+",w]}),e.jsx("span",{className:"w-1.5 h-1.5 rounded-full "+(y?"bg-primary animate-pulse":"bg-emerald-500")}),e.jsx(we,{className:"w-4 h-4 text-muted-foreground/60"})]})}),e.jsxs(P.Content,{width:"w-80",align:"center",side:"bottom",children:[e.jsxs(P.Header,{children:[e.jsx(qt,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:"Context Settings"}),e.jsx(P.Button,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:()=>i(!1),title:"Close",children:e.jsx(Z,{className:"h-3 w-3"})})]}),e.jsxs(P.Body,{children:[y&&e.jsx("div",{className:"mb-3 p-2.5 rounded-lg bg-primary/6",children:e.jsxs("div",{className:"flex items-center gap-2 text-xs text-primary/90",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-primary animate-pulse"}),e.jsx("span",{children:"Loading context data..."})]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Vt,{mode:D.AUTO,currentMode:u,icon:e.jsx(et,{className:"w-4 h-4 text-muted-foreground"}),title:"Auto",description:"Current space",onClick:()=>{m(D.AUTO),E(!1)}}),e.jsx(Vt,{mode:D.NONE,currentMode:u,icon:e.jsx(Ms,{className:"w-4 h-4 text-muted-foreground"}),title:"No Context",description:"Clean chat",onClick:()=>{m(D.NONE),E(!1)}}),e.jsx(Vt,{mode:D.ALL,currentMode:u,icon:e.jsx(Es,{className:"w-4 h-4 text-muted-foreground"}),title:"All Spaces",description:"Full access",onClick:()=>{m(D.ALL),E(!1)}}),e.jsx(Vt,{mode:D.CHANNELS,currentMode:u,icon:e.jsx(Ts,{className:"w-4 h-4 text-muted-foreground"}),title:"Custom",description:"Select specific",showChevron:!0,isExpanded:R,onClick:()=>{u===D.CHANNELS?E(!R):(m(D.CHANNELS),E(!0))}}),R&&e.jsx(qd,{searchQuery:f,setSearchQuery:b,filteredChannels:v,draftChannelIds:x,toggleChannel:p,fallbackChannelId:t}),u===D.CHANNELS&&a&&e.jsx(Wd,{activeToolChannelId:n||null,draftChannelIds:x,onActiveToolChannelChange:a,getChannelName:d})]})]}),e.jsxs(P.Actions,{children:[e.jsx(P.Button,{type:"button",variant:"outline",onClick:()=>i(!1),children:"Cancel"}),e.jsx(P.Button,{type:"button",variant:"default",onClick:()=>{g(),i(!1)},children:"Apply Changes"})]})]})]})})}const Mr=de()(ct((s,t)=>{const a=Qs();return{selectedModelId:a.id,selectedModel:a,setSelectedModel:n=>{const r=Ye.find(o=>o.id===n);r&&s({selectedModelId:n,selectedModel:r})},getSelectedModel:()=>t().selectedModel}},{name:"model-selection-storage",partialize:s=>({selectedModelId:s.selectedModelId}),onRehydrateStorage:()=>s=>{if(s){const t=Ye.find(a=>a.id===s.selectedModelId);if(t)s.selectedModel=t;else{const a=Qs();s.selectedModelId=a.id,s.selectedModel=a}}}}));class Kd{agent=null;getAgent(){if(!this.agent){const{getSelectedModel:t}=Mr.getState(),a=t();this.agent=new Ht({apiKey:a.apiKey,model:a.model,temperature:a.temperature,maxTokens:a.maxTokens,baseURL:a.apiUrl})}return this.agent}updateAgentConfig(t){this.agent||(this.agent=new Ht),this.agent.setConfig({apiKey:t.apiKey,model:t.model,temperature:t.temperature,maxTokens:t.maxTokens,baseURL:t.apiUrl})}createAgentWithModel(t){return new Ht({apiKey:t.apiKey,model:t.model,temperature:t.temperature,maxTokens:t.maxTokens,baseURL:t.apiUrl})}createAgentWithConfig(t){const a=Qs();return new Ht({apiKey:t.apiKey||a.apiKey,model:t.model||a.model,temperature:t.temperature??a.temperature,maxTokens:t.maxTokens??a.maxTokens,baseURL:t.baseURL||a.apiUrl})}getChannelTools(){console.log("🔔 [AIAgentFactory][getChannelTools] requesting tools");const t=Rd.getChannelTools();return console.log("🔔 [AIAgentFactory][getChannelTools] returning tools:",t.map(a=>({name:a.name,description:a.description}))),t}getChannelContext(t){return $d.getChannelContext(t)}getSessionContexts(t,a){return va.getSessionContexts(t,a)}}const es=new Kd,Yd=({draft:s,setDraft:t,props:a})=>{const{selectedModelId:n,setSelectedModel:r}=Mr(),o=s.meta?.modelId,i=l=>{const c=xa(l);c&&(r(l),es.updateAgentConfig(c),t({...s,meta:{...s.meta,modelId:l,modelConfig:{apiKey:c.apiKey,model:c.model,apiUrl:c.apiUrl,temperature:c.temperature,maxTokens:c.maxTokens}}}),a.onModelChange?.(l))};return e.jsx(ed,{selectedModelId:o||n||a.selectedModelId,onModelChange:i,className:a.className})},Xd=s=>({id:"model-selector",placement:"bottom-left",render:({draft:t,setDraft:a})=>e.jsx(Yd,{draft:t,setDraft:a,props:s}),beforeSend:async t=>{const a=t.meta?.modelId;if(a){const n=xa(a);if(n)return{...t,meta:{...t.meta,modelConfig:{apiKey:n.apiKey,model:n.model,apiUrl:n.apiUrl,temperature:n.temperature,maxTokens:n.maxTokens}}}}return t}});function Er({conversationId:s,channelId:t}){const{userId:a}=T(),{messages:n,createMessage:r,updateMessage:o,loading:i}=Qc(s),l=$(x=>x.conversations.find(p=>p.id===s)),c=!!l&&l.messageCount===0,d=i&&!c,u=h.useRef(s),m=h.useMemo(()=>{const x=u.current;if(x!==s)return u.current=s,Kc(x)?x:s},[s]);return e.jsx("div",{className:"h-full flex flex-col bg-background",children:e.jsx("div",{className:"flex-1 overflow-hidden",children:d?e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(ze,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Loading conversation..."})]})}):e.jsx(Jd,{conversationId:s,channelId:t,messages:n,createMessage:r,updateMessage:o},m)})})}function Jd({conversationId:s,channelId:t,messages:a,createMessage:n,updateMessage:r}){const o=h.useMemo(()=>es.getAgent(),[]),i=h.useMemo(()=>es.getChannelTools(),[]),{toolDefs:l,toolExecutors:c,toolRenderers:d}=Qi(i),u=Zi({agent:o,getToolDefs:()=>l,getContexts:()=>es.getSessionContexts(s,t),initialMessages:a,getToolExecutor:g=>c[g]}),m=ls(n),x=ls(r);h.useEffect(()=>{const g=u.addMessagesEvent$.subscribe(({messages:f})=>{f.forEach(async b=>{m(b)})});return()=>g.unsubscribe()},[u.addMessagesEvent$,m]),h.useEffect(()=>{const g=u.updateMessageEvent$.pipe(qe(({message:f})=>f),Oi(f=>f.id),Rn(f=>f.pipe(Bs(300),fs((b,v)=>ol(b,v))))).subscribe(f=>{x(f)});return()=>g.unsubscribe()},[u.updateMessageEvent$,x]),h.useEffect(()=>{const g=u.messages$.pipe(Bs(100)).subscribe(f=>{$.getState().onMessagesSnapshot(s,f)});return()=>g.unsubscribe()},[u,s]);const p=h.useMemo(()=>[Xd({onModelChange:g=>{console.log("Model changed to:",g)}})],[]);return el(u),e.jsx("div",{className:"h-full flex flex-col agent-chat-fullwidth",children:e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(tl,{agentSessionManager:u,toolRenderers:d,className:"h-full w-full",messageItemProps:{showAvatar:!1},promptsProps:{items:Qd(),onItemClick:({prompt:g})=>{u.handleAddMessages([{id:crypto.randomUUID(),role:"user",parts:[{type:"text",text:g}]}])}},inputExtensions:p})})})}function Qd(s){return[{id:"prompt-1",prompt:"Let's chat"},{id:"prompt-2",prompt:"Summarize this"},{id:"prompt-3",prompt:"Any suggestions?"},{id:"prompt-4",prompt:"What should I do next?"},{id:"prompt-5",prompt:"What important thing am I missing?"},{id:"prompt-6",prompt:"Suggestions for next week"}]}function Tr({onCreate:s}){return e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No conversation selected"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Create a new conversation to start chatting"}),e.jsx("button",{onClick:s,className:"inline-flex h-9 items-center justify-center whitespace-nowrap rounded-md px-3 text-sm font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90",children:"Create Conversation"})]})})}function Ar({currentConversationId:s,channelId:t,hasConversations:a,onClose:n}){const{createConversation:r}=Ut(),{userId:o}=T();return s?e.jsx(Er,{conversationId:s,channelId:t,onClose:n}):a?e.jsx("div",{className:"flex-1"}):e.jsx(Tr,{onCreate:()=>{o&&r(o,"New Conversation")}})}function Zd({conversations:s,currentConversationId:t,loading:a,channelId:n,onClose:r}){const o=s.length>0;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-80 flex flex-col border-r border-border",children:e.jsx(pa,{conversations:s,currentConversationId:t,loading:a,withHeader:!1})}),e.jsx("div",{className:"flex-1 flex flex-col",children:e.jsx(Ar,{currentConversationId:t,channelId:n,hasConversations:o,onClose:r})})]})}const eu=h.forwardRef(function({conversations:t,currentConversationId:a,loading:n,channelId:r,onClose:o},i){const l=$(m=>m.uiView),c=$(m=>m.showList),d=$(m=>m.showChat),u=t.length>0;return h.useImperativeHandle(i,()=>({showList:()=>c(),showChat:()=>d()}),[c,d]),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"absolute inset-0 flex flex-col "+(l==="list"?"":"hidden"),children:e.jsx(pa,{conversations:t,currentConversationId:a,loading:n,withHeader:!1})}),e.jsx("div",{className:"absolute inset-0 flex flex-col "+(l==="chat"?"":"hidden"),children:e.jsx(Ar,{currentConversationId:a,channelId:r,hasConversations:u,onClose:o})})]})}),tu=h.forwardRef(function({channelId:t,onClose:a},n){const{userId:r}=T(),{conversations:o,currentConversationId:i,loading:l,createConversation:c,loadConversations:d}=Ut(),u=h.useRef(null),{mode:m,ready:x}=Yc(u,{sidebar:320,chatMin:520,hysteresis:12,debounceMs:80}),p=m==="single-pane",g=h.useRef(null),f=h.useCallback(()=>{r&&c(r,"New Conversation")},[r,c]);return h.useImperativeHandle(n,()=>({showList:()=>g.current?.showList(),showChat:()=>g.current?.showChat(),createNew:()=>f(),isSinglePane:()=>p}),[p,f]),h.useEffect(()=>{r&&d(r)},[r,d]),l||!x?e.jsx("div",{ref:u,className:"h-full flex "+(x?"":"invisible"),children:e.jsx(su,{})}):e.jsx("div",{ref:u,className:"h-full flex "+(x?"":"invisible"),children:m==="two-pane"?e.jsx(Zd,{conversations:o,currentConversationId:i,loading:l,channelId:t,onClose:a}):e.jsx(eu,{ref:g,conversations:o,currentConversationId:i,loading:l,channelId:t,onClose:a})})});function su(){return e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(ze,{className:"w-4 h-4 animate-spin text-muted-foreground"})})}function au({isOpen:s,onClose:t,channelId:a}){const{userId:n}=T(),r=h.useRef(null),{currentConversation:o,createConversation:i}=Ut(),l=$(u=>u.uiView),c=$(u=>u.titleGeneratingMap);if(!s)return null;const d=()=>l==="list"?"Conversations":o?c[o.id]?"Generating Title...":o.title||"AI Conversations":"AI Conversations";return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"px-3 py-2 border-b border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("h3",{className:"font-semibold text-foreground truncate",children:d()}),o&&e.jsx(Ir,{conversationId:o.id,fallbackChannelId:a,variant:"inline"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>{const u=r.current;u&&u.isSinglePane()&&u.showList()},"aria-label":"Conversations",children:e.jsx(In,{className:"w-5 h-5"})}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>{n&&i(n,"New Conversation")},"aria-label":"New conversation",children:e.jsx(ae,{className:"w-5 h-5"})}),e.jsx(N,{variant:"ghost",size:"icon",onClick:t,"aria-label":"Close",children:e.jsx(Z,{className:"w-5 h-5"})})]})]})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(tu,{ref:r,channelId:a,onClose:t})})]})}const mt=({onHistoryMessagesChange:s})=>{const{currentChannelId:t}=O(),a=h.useMemo(()=>at(_.dataContainer,`messageByChannel.${t}`),[t]),{value:{messages:n=[],loading:r,hasMore:o,loadingMore:i}={},get:l}=Jn(a);return h.useEffect(()=>_.moreMessageLoadedEvent$.listen(({messages:c})=>s?.(c)),[]),h.useEffect(()=>_.connectToRequestWorkflow(),[]),h.useEffect(()=>{t&&_.requestLoadInitialMessages$.next({channelId:t})},[t]),{messages:n,loading:r,hasMore:o,loadMore:_.loadMoreHistory,loadingMore:i,getChannelState:l}},Ft=s=>s.metaKey||s.ctrlKey,en=s=>`⌘+${s} / Ctrl+${s}`,ot={SEND:en("Enter"),SAVE:en("Enter"),CANCEL:"Esc"},nu=({isOpen:s,onClose:t,onSendMessage:a,currentThreadId:n})=>{const{messages:r}=mt({}),o=n&&r?.find(g=>g.id===n)||null,i=n?r?.filter(g=>g.threadId===n)||[]:[],[l,c]=h.useState(""),[d,u]=h.useState(!1),m=()=>{l.trim()&&(a(l.trim()),c(""))},x=g=>{g.key==="Enter"&&Ft(g)&&(g.preventDefault(),m())},p=(g,f=200)=>g.length<=f?g:g.substring(0,f)+"...";return s?e.jsxs("div",{className:"h-full flex flex-col bg-white dark:bg-slate-900",children:[e.jsxs("div",{className:"flex-shrink-0 flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($s,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),e.jsx("h3",{className:"font-semibold text-slate-800 dark:text-slate-200",children:"Discussion"}),i.length>0&&e.jsx("span",{className:"px-2 py-1 text-xs bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-full",children:i.length})]}),e.jsx("button",{onClick:t,className:"p-2 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors duration-200 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800",children:e.jsx(Z,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto timeline-scroll",children:[o&&e.jsx("div",{className:"p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/30",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0",children:e.jsx(Os,{className:"w-4 h-4 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-slate-800 dark:text-slate-200 mb-1",children:"Original Thought"}),e.jsx("div",{className:"text-sm text-slate-600 dark:text-slate-400 leading-relaxed",children:d?o.content:p(o.content)}),o.content.length>200&&e.jsx("button",{onClick:()=>u(!d),className:"mt-2 flex items-center gap-1 text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors duration-200",children:d?e.jsxs(e.Fragment,{children:[e.jsx(Pt,{className:"w-3 h-3"}),"Show less"]}):e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"w-3 h-3"}),"Show more"]})})]})]})}),e.jsx("div",{className:"p-4 space-y-4",children:i.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx($s,{className:"w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-4"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-sm",children:"No replies yet. Start the discussion!"})]}):i.map(g=>e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${g.sender==="user"?"bg-blue-500":"bg-slate-500"}`,children:g.sender==="user"?e.jsx(Os,{className:"w-4 h-4 text-white"}):e.jsx(Fe,{className:"w-4 h-4 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-slate-800 dark:text-slate-200 mb-1",children:g.sender==="user"?"You":"AI Assistant"}),e.jsx("div",{className:"text-sm text-slate-600 dark:text-slate-400 leading-relaxed",children:g.content})]})]},g.id))})]}),e.jsx("div",{className:"flex-shrink-0 p-4 border-t border-slate-200 dark:border-slate-700",children:e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx("textarea",{value:l,onChange:g=>c(g.target.value),onKeyDown:x,placeholder:"Add to discussion...",className:"w-full px-3 py-2 text-sm border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder:text-slate-500 resize-none focus:outline-none  focus:border-transparent",rows:2})}),e.jsx("button",{onClick:m,disabled:!l.trim(),className:"p-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:text-blue-600 text-white rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx($t,{className:"w-4 h-4"})})]})})]}):null};function ru({isOpen:s,onClose:t,content:a,title:n,onDownload:r,showDownload:o=!0}){const[i,l]=h.useState(!1),[c,d]=h.useState(!1);return h.useEffect(()=>{if(s){l(!1),d(!0);const u=setTimeout(()=>l(!0),100);return()=>clearTimeout(u)}},[s]),h.useEffect(()=>{if(s&&c){const u=setTimeout(()=>d(!1),3e3);return()=>clearTimeout(u)}},[s,c]),h.useEffect(()=>(s?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[s]),h.useEffect(()=>{const u=m=>{m.key==="Escape"&&s&&t()};return s&&document.addEventListener("keydown",u),()=>{document.removeEventListener("keydown",u)}},[s,t]),s?e.jsxs("div",{className:"fixed inset-0 z-[9999] bg-black/95 backdrop-blur-sm",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx("div",{className:`relative w-full h-full flex items-center justify-center transition-all duration-300 ${i?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"relative w-full h-full flex items-center justify-center overflow-hidden bg-white dark:bg-gray-900 rounded-lg p-4",children:e.jsx("div",{className:"w-full h-full flex items-center justify-center [&_svg]:max-w-full [&_svg]:max-h-full [&_svg]:w-auto [&_svg]:h-auto",dangerouslySetInnerHTML:{__html:a}})})})}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-4",children:[n&&e.jsx("div",{className:"text-white/90 text-sm font-medium truncate max-w-[60%] bg-black/50 backdrop-blur-sm rounded-full px-3 py-1",children:n}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[o&&r&&e.jsx(N,{variant:"ghost",size:"sm",onClick:r,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(xs,{className:"w-4 h-4"})}),e.jsx(N,{variant:"ghost",size:"sm",onClick:t,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(Z,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"absolute inset-0 -z-10",onClick:t,"aria-label":"Close viewer"}),e.jsxs("div",{className:`absolute top-16 left-1/2 transform -translate-x-1/2 bg-black/50 backdrop-blur-sm rounded-full px-4 py-2 text-white/60 text-xs transition-all duration-500 ${c?"opacity-100 translate-y-0":"opacity-0 -translate-y-2 pointer-events-none"}`,children:["Press ",e.jsx("kbd",{className:"px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono",children:"ESC"})," to close"]})]}):null}function ou({code:s}){const[t,a]=h.useState(null),[n,r]=h.useState(null),[o,i]=h.useState(!1),l=h.useRef(null),c=h.useMemo(()=>`mermaid-${Math.random().toString(36).slice(2)}`,[]),[d,u]=h.useState(!1),[m,x]=h.useState(!1);h.useEffect(()=>{let f=!1;async function b(){try{const v=await F(()=>import("./pkg-mermaid-2J7i20Jj.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48])),y=document.documentElement.classList.contains("dark");v.default.initialize({startOnLoad:!1,securityLevel:"loose",theme:y?"dark":"default"});const{svg:I,bindFunctions:C}=await v.default.render(c,s);if(f)return;a(I),C&&l.current&&C(l.current)}catch(v){if(f)return;const y=typeof v=="object"&&v&&"message"in v?String(v.message):"Failed to render mermaid diagram";r(y)}}return b(),()=>{f=!0}},[s,c]);const p=async()=>{try{await navigator.clipboard.writeText(s),i(!0),setTimeout(()=>i(!1),1500)}catch(f){console.warn("Copy mermaid source failed:",f)}},g=()=>{if(t)try{const f=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),b=URL.createObjectURL(f),v=document.createElement("a");v.href=b,v.download="diagram.svg",document.body.appendChild(v),v.click(),v.remove(),URL.revokeObjectURL(b)}catch(f){console.warn("Download SVG failed:",f)}};return n?e.jsxs("div",{className:"group/code relative my-4",children:[e.jsxs("div",{className:"flex items-center justify-between bg-slate-100 dark:bg-gray-900 border border-slate-200 dark:border-gray-700 rounded-t px-2 py-1",children:[e.jsx("span",{className:"text-[11px] font-medium uppercase tracking-wide text-slate-600 dark:text-gray-300",children:"MERMAID"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>x(f=>!f),className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:m?"View diagram":"View source",children:m?e.jsx(is,{className:"w-3 h-3"}):e.jsx(ja,{className:"w-3 h-3"})}),e.jsx("button",{onClick:p,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:o?"Copied!":"Copy source",children:o?e.jsx(Ue,{className:"w-3 h-3"}):e.jsx(It,{className:"w-3 h-3"})})]})]}),m?e.jsx("pre",{className:"bg-slate-50 dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700 border-t-0",children:e.jsx("code",{className:"text-sm leading-relaxed font-mono text-slate-800 dark:text-gray-200 whitespace-pre",children:s})}):e.jsx("div",{className:"bg-white dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700",children:e.jsx("code",{className:"text-sm text-red-400",children:"Failed to render mermaid diagram"})})]}):e.jsxs("div",{className:"group/code relative my-4",ref:l,children:[e.jsxs("div",{className:"flex items-center justify-between bg-slate-100 dark:bg-gray-900 border border-slate-200 dark:border-gray-700 rounded-t px-2 py-1",children:[e.jsx("span",{className:"text-[11px] font-medium uppercase tracking-wide text-slate-600 dark:text-gray-300",children:"MERMAID"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>x(f=>!f),className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:m?"View diagram":"View source",children:m?e.jsx(is,{className:"w-3 h-3"}):e.jsx(ja,{className:"w-3 h-3"})}),!m&&e.jsx("button",{onClick:()=>u(!0),className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:"View larger",children:e.jsx(ca,{className:"w-3 h-3"})}),e.jsx("button",{onClick:m?()=>{try{const f=new Blob([s],{type:"text/plain;charset=utf-8"}),b=URL.createObjectURL(f),v=document.createElement("a");v.href=b,v.download="diagram.mmd",document.body.appendChild(v),v.click(),v.remove(),URL.revokeObjectURL(b)}catch(f){console.warn("Download mmd failed:",f)}}:g,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:m?"Download .mmd":"Download SVG",children:e.jsx(xs,{className:"w-3 h-3"})}),e.jsx("button",{onClick:p,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:o?"Copied!":"Copy source",children:o?e.jsx(Ue,{className:"w-3 h-3"}):e.jsx(It,{className:"w-3 h-3"})})]})]}),m?e.jsx("pre",{className:"bg-slate-50 dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700",children:e.jsx("code",{className:"text-sm leading-relaxed font-mono text-slate-800 dark:text-gray-200 whitespace-pre",children:s})}):e.jsx("div",{className:"bg-white dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700 border-t-0 cursor-zoom-in",onDoubleClick:()=>u(!0),dangerouslySetInnerHTML:{__html:t||""}}),e.jsx(ru,{isOpen:d,onClose:()=>u(!1),content:t||"",title:"Diagram Preview",onDownload:g,showDownload:!!t})]})}const iu={javascript:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.j),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),jsx:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.a),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),typescript:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.t),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),tsx:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.b),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),json:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.c),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),bash:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.d),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),shell:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.d),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),sh:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.d),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),yaml:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.y),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),yml:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.y),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),markdown:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.m),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),md:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.m),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),css:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.e),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),scss:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.s),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),html:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.f),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),xml:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.f),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),graphql:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.g),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),go:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.i),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),java:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.k),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),python:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.p),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),ruby:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.r),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),rust:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.l),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),php:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.n),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),c:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.q),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),cpp:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.u),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),docker:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.w),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),nginx:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.x),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),sql:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.z),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67])),diff:()=>F(()=>import("./pkg-react-syntax-highlighter-D_Ci07Lc.js").then(s=>s.A),__vite__mapDeps([49,50,27,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67]))},ea=new Set,_s={};async function lu(s){if(!s)return;const t=s.toLowerCase();if(t==="mermaid"||ea.has(t))return;const a=iu[t];a&&(_s[t]||(_s[t]=a().then(n=>{const o=n.default??n;Fn.registerLanguage(t,o),ea.add(t)}).catch(n=>{console.warn("Failed to load prism language:",t,n)})),await _s[t])}function cu({className:s,children:t}){const[a,n]=h.useState(!1),r=/language-(\w+)/.exec(s||""),o=r?r[1]:"",i=!s||!r,[l,c]=h.useState(0),[d,u]=h.useState(()=>typeof document<"u"?document.documentElement.classList.contains("dark"):!1),m=h.useMemo(()=>h.Children.toArray(t).map(p=>typeof p=="string"?p:"").join("").replace(/\n$/,""),[t]);h.useMemo(()=>{(async()=>(await lu(o),c(p=>p+1)))()},[o]),h.useEffect(()=>{if(typeof document>"u")return;const p=document.documentElement,g=()=>u(p.classList.contains("dark"));g();const f=new MutationObserver(g);return f.observe(p,{attributes:!0,attributeFilter:["class"]}),()=>f.disconnect()},[]);const x=async()=>{try{await navigator.clipboard.writeText(m),n(!0),setTimeout(()=>n(!1),2e3)}catch(p){console.error("Failed to copy code:",p)}};return i?e.jsx("code",{className:"inline-block bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-1.5 py-0.5 rounded text-sm font-mono border border-gray-300 dark:border-gray-600",children:t}):o==="mermaid"?e.jsx(ou,{code:m}):e.jsxs("div",{className:"group/code relative my-4",children:[e.jsxs("div",{className:"flex items-center justify-between bg-slate-100 dark:bg-gray-900 border border-slate-200 dark:border-gray-700 rounded-t px-2 py-1",children:[e.jsx("div",{className:"flex items-center space-x-2",children:o&&e.jsx("span",{className:"text-[11px] font-medium uppercase tracking-wide text-slate-600 dark:text-gray-300",children:o})}),e.jsx("button",{onClick:x,className:"flex items-center justify-center w-6 h-6 text-xs text-slate-500 hover:text-slate-700 dark:text-gray-400 dark:hover:text-gray-200 bg-transparent hover:bg-black/10 dark:hover:bg-gray-700/70 rounded transition-all duration-150 opacity-0 group-hover/code:opacity-100",title:a?"Copied!":"Copy code",children:a?e.jsx(Ue,{className:"w-3 h-3"}):e.jsx(It,{className:"w-3 h-3"})})]}),o&&ea.has(o.toLowerCase())?e.jsx(Fn,{style:d?il:ll,language:o,PreTag:"div",className:"rounded-b overflow-auto w-full max-w-full min-w-0 border border-slate-200 dark:border-gray-700 border-t-0",wrapLongLines:!0,customStyle:{whiteSpace:"pre",overflowX:"auto",overflowY:"auto",background:d?"#0b0b0b":"#f8fafc",margin:0,padding:"0.75rem"},children:m},l):e.jsx("pre",{className:"bg-slate-50 dark:bg-gray-950 rounded-b p-3 overflow-x-auto border border-slate-200 dark:border-gray-700 border-t-0",children:e.jsx("code",{className:"text-sm leading-relaxed font-mono text-slate-800 dark:text-gray-200",children:m})})]})}function du({className:s,...t}){return e.jsx(wo,{"data-slot":"checkbox",className:j("peer border-slate-300 dark:border-slate-600 dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",s),...t,children:e.jsx(jo,{"data-slot":"checkbox-indicator",className:"flex items-center justify-center text-current transition-none",children:e.jsx(Ue,{className:"size-3.5"})})})}function uu({minScale:s=.1,maxScale:t=5,initialScale:a=1}={}){const[n,r]=h.useState(a),[o,i]=h.useState({x:0,y:0}),[l,c]=h.useState(!1),[d,u]=h.useState({x:0,y:0}),[m,x]=h.useState(0),p=h.useCallback(w=>{n>1&&(c(!0),u({x:w.clientX-o.x,y:w.clientY-o.y}))},[n,o]),g=h.useCallback(w=>{l&&n>1&&i({x:w.clientX-d.x,y:w.clientY-d.y})},[l,n,d]),f=h.useCallback(()=>{c(!1)},[]),b=h.useCallback(w=>{w.preventDefault();const k=Date.now();if(k-m<16)return;x(k);const R=Math.abs(w.deltaY);let E;R<50?E=w.deltaY>0?.98:1.02:R<100?E=w.deltaY>0?.96:1.04:E=w.deltaY>0?.94:1.06;const S=Math.max(s,Math.min(t,n*E));r(S),S<=1&&i({x:0,y:0})},[m,n,s,t]),v=h.useCallback(()=>{r(w=>Math.min(t,w*1.1))},[t]),y=h.useCallback(()=>{r(w=>{const k=Math.max(s,w*.9);return k<=1&&i({x:0,y:0}),k})},[s]),I=h.useCallback(()=>{r(a),i({x:0,y:0})},[a]),C=h.useCallback(()=>{r(a),i({x:0,y:0}),c(!1)},[a]);return{scale:n,position:o,isDragging:l,handleMouseDown:p,handleMouseMove:g,handleMouseUp:f,handleWheel:b,zoomIn:v,zoomOut:y,resetView:I,reset:C}}function hu({isOpen:s,onClose:t,src:a,alt:n,title:r,onDownload:o,showDownload:i=!0}){const[l,c]=h.useState(!1),[d,u]=h.useState(!1),[m,x]=h.useState(!1),{scale:p,position:g,isDragging:f,handleMouseDown:b,handleMouseMove:v,handleMouseUp:y,handleWheel:I,zoomIn:C,zoomOut:w,resetView:k,reset:R}=uu();return h.useEffect(()=>{if(s){c(!1),u(!0);const E=setTimeout(()=>c(!0),100);return()=>clearTimeout(E)}},[s]),h.useEffect(()=>{if(s&&d){const E=setTimeout(()=>u(!1),3e3);return()=>clearTimeout(E)}},[s,d]),h.useEffect(()=>(s?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[s]),h.useEffect(()=>{const E=S=>{S.key==="Escape"&&s&&t()};return s&&document.addEventListener("keydown",E),()=>{document.removeEventListener("keydown",E)}},[s,t]),h.useEffect(()=>{s&&(R(),x(!1))},[s,R]),s?e.jsxs("div",{className:"fixed inset-0 z-[9999] bg-black/95 backdrop-blur-sm",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center p-4",children:e.jsx("div",{className:`relative w-full h-full flex items-center justify-center transition-all duration-300 ${l?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"relative w-full h-full flex items-center justify-center overflow-hidden",onWheel:I,children:e.jsx("img",{src:a,alt:n,className:`max-w-full max-h-full object-contain transition-all duration-200 ${m?"opacity-100":"opacity-0"} ${f?"cursor-grabbing":p>1?"cursor-grab":"cursor-zoom-in"}`,style:{transform:`scale(${p}) translate(${g.x/p}px, ${g.y/p}px)`,transformOrigin:"center center"},onLoad:()=>x(!0),onMouseDown:b,onMouseMove:v,onMouseUp:y,onMouseLeave:y,draggable:!1})})})}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-4",children:[r&&e.jsx("div",{className:"text-white/90 text-sm font-medium truncate max-w-[60%] bg-black/50 backdrop-blur-sm rounded-full px-3 py-1",children:r}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[i&&o&&e.jsx(N,{variant:"ghost",size:"sm",onClick:o,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(xs,{className:"w-4 h-4"})}),e.jsx(N,{variant:"ghost",size:"sm",onClick:t,className:"text-white/80 hover:text-white hover:bg-black/70 border-0 h-8 w-8 p-0 bg-black/50 backdrop-blur-sm",children:e.jsx(Z,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"absolute inset-0 -z-10",onClick:t,"aria-label":"Close viewer"}),e.jsxs("div",{className:`absolute top-16 left-1/2 transform -translate-x-1/2 bg-black/50 backdrop-blur-sm rounded-full px-4 py-2 text-white/60 text-xs transition-all duration-500 ${d?"opacity-100 translate-y-0":"opacity-0 -translate-y-2 pointer-events-none"}`,children:["Press ",e.jsx("kbd",{className:"px-1.5 py-0.5 bg-white/20 rounded text-xs font-mono",children:"ESC"})," to close"]}),e.jsxs("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 flex items-center gap-2 bg-black/50 backdrop-blur-sm rounded-full px-4 py-2",children:[e.jsx(N,{variant:"ghost",size:"sm",onClick:w,className:"text-white/80 hover:text-white hover:bg-white/10 border-0 h-8 w-8 p-0",children:e.jsx(Xo,{className:"w-4 h-4"})}),e.jsxs("span",{className:"text-white/80 text-xs font-medium min-w-[3rem] text-center",children:[Math.round(p*100),"%"]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:C,className:"text-white/80 hover:text-white hover:bg-white/10 border-0 h-8 w-8 p-0",children:e.jsx(Jo,{className:"w-4 h-4"})}),e.jsx("div",{className:"w-px h-4 bg-white/20"}),e.jsx(N,{variant:"ghost",size:"sm",onClick:k,className:"text-white/80 hover:text-white hover:bg-white/10 border-0 h-8 w-8 p-0",children:e.jsx(Qo,{className:"w-4 h-4"})})]})]}):null}function mu({src:s,alt:t,className:a}){const[n,r]=h.useState(!1),[o,i]=h.useState(!1),l=(()=>{if(!s)return"image";try{return new URL(s,window.location.href).pathname.split("/").pop()||"image"||"image"}catch{return"image"}})(),c=async()=>{if(s)try{const u=await(await fetch(s)).blob(),m=URL.createObjectURL(u),x=document.createElement("a");x.href=m,x.download=l,document.body.appendChild(x),x.click(),x.remove(),URL.revokeObjectURL(m)}catch{const d=document.createElement("a");d.href=s,d.download=l,document.body.appendChild(d),d.click(),d.remove()}};return e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"group inline-block relative",children:[e.jsx("img",{src:s,alt:t,className:`${o?"cursor-default":"cursor-zoom-in"} ${a??""}`,loading:"lazy",onLoad:()=>i(!1),onError:()=>i(!0),onClick:()=>!o&&r(!0)}),!o&&e.jsx("button",{type:"button",className:"absolute top-1 right-1 hidden group-hover:flex items-center justify-center w-6 h-6 rounded bg-black/50 text-white",title:"View larger",onClick:()=>r(!0),children:e.jsx(ca,{className:"w-3 h-3"})})]}),e.jsx(hu,{isOpen:n,onClose:()=>r(!1),src:s||"",alt:t,title:t||l,onDownload:o?void 0:c,showDownload:!o})]})}function ya({content:s,className:t=""}){return e.jsx("div",{className:`prose prose-slate dark:prose-invert max-w-none [&_ul_ul]:ml-6 [&_ul_ul_ul]:ml-6 [&_ul_ul_ul_ul]:ml-6 [&_ul_ul_ul_ul_ul]:ml-6 [&_ol_ol]:ml-6 [&_ol_ol_ol]:ml-6 [&_ol_ol_ol_ol]:ml-6 [&_ol_ol_ol_ol_ol]:ml-6 [&_ul_ol]:ml-6 [&_ol_ul]:ml-6 ${t}`,children:e.jsx(sl,{remarkPlugins:[nl,rl],rehypePlugins:[al],components:{code:cu,a({children:a,href:n,...r}){return e.jsx("a",{href:n,className:"text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline transition-colors duration-150",target:"_blank",rel:"noopener noreferrer",...r,children:a})},table({children:a,...n}){return e.jsx("div",{className:"my-4 overflow-x-auto",children:e.jsx("table",{className:"min-w-full border-collapse border border-gray-300 dark:border-gray-600",...n,children:a})})},th({children:a,...n}){return e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-900 dark:text-gray-100 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600",...n,children:a})},td({children:a,...n}){return e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600",...n,children:a})},blockquote({children:a,...n}){return e.jsx("blockquote",{className:"my-4 pl-4 py-2 italic text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-800/30 border-l-4 border-gray-300 dark:border-gray-600 [&>p:last-child]:mb-0",...n,children:a})},ul({children:a,...n}){return e.jsx("ul",{className:"my-2 space-y-2 list-disc pl-6",...n,children:a})},li({children:a,...n}){return e.jsx("li",{className:"text-gray-800 dark:text-gray-200 leading-relaxed",...n,children:a})},input({type:a,checked:n,...r}){return a==="checkbox"?e.jsx(du,{checked:n,className:"mr-2 mt-0.5 inline-block align-top",disabled:!0}):e.jsx("input",{type:a,checked:n,...r})},ol({children:a,...n}){return e.jsx("ol",{className:"my-2 space-y-2 list-decimal pl-6 text-gray-800 dark:text-gray-200",...n,children:a})},h1({children:a,...n}){return e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-3 mt-5 leading-7",...n,children:a})},h2({children:a,...n}){return e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3 mt-4 leading-6",...n,children:a})},h3({children:a,...n}){return e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2 mt-3 leading-5",...n,children:a})},h4({children:a,...n}){return e.jsx("h4",{className:"text-base font-medium text-gray-900 dark:text-gray-100 mb-2 mt-3 leading-5",...n,children:a})},h5({children:a,...n}){return e.jsx("h5",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 mb-2 mt-3 leading-5",...n,children:a})},h6({children:a,...n}){return e.jsx("h6",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 mt-3 leading-5",...n,children:a})},p({children:a,...n}){return e.jsx("p",{className:"text-base leading-6 text-gray-800 dark:text-gray-200 whitespace-pre-wrap break-words font-normal mb-2",...n,children:a})},hr({...a}){return e.jsx("hr",{className:"my-6 border-0 h-px bg-gray-300 dark:bg-gray-600",...a})},strong({children:a,...n}){return e.jsx("strong",{className:"font-semibold text-gray-900 dark:text-gray-100",...n,children:a})},em({children:a,...n}){return e.jsx("em",{className:"italic text-gray-700 dark:text-gray-300",...n,children:a})},img({src:a,alt:n}){return e.jsx(mu,{src:a,alt:n?.toString(),className:"my-2"})}},children:s})})}const H=de()((s,t)=>({editingMessageId:null,editContent:"",originalContent:"",isDirty:!1,isSaving:!1,editMode:"inline",startEditing:(a,n)=>{s({editingMessageId:a,editContent:n,originalContent:n,isDirty:!1,isSaving:!1,editMode:"inline"})},updateContent:a=>{const{originalContent:n}=t();s({editContent:a,isDirty:a!==n})},switchToExpandedMode:()=>{s({editMode:"expanded"})},switchToInlineMode:()=>{s({editMode:"inline"})},save:async()=>{const{editingMessageId:a,editContent:n}=t();if(!(!a||!n.trim())){s({isSaving:!0});try{const{userId:r}=T.getState();if(!r)throw new Error("User not authenticated");const{currentChannelId:o}=O.getState();if(!o)throw new Error("No current channel selected");await _.updateMessage({messageId:a,channelId:o,updates:{content:n.trim()},userId:r}),t().reset()}catch(r){console.error("Failed to save message:",r)}finally{s({isSaving:!1})}}},cancel:()=>{t().reset()},reset:()=>{s({editingMessageId:null,editContent:"",originalContent:"",isDirty:!1,isSaving:!1,editMode:"inline"})}}));class gu{textarea;updateContent;pendingOperations=[];constructor(t,a){this.textarea=t,this.updateContent=a,this.setupEventListeners()}setupEventListeners=()=>{this.textarea.addEventListener("keydown",this.handleKeyDown)};handleKeyDown=t=>{t.key==="Tab"&&(t.preventDefault(),this.handleTabIndentation(t.shiftKey))};handleTabIndentation=t=>{const a=this.textarea.selectionStart,n=this.textarea.selectionEnd,r=this.textarea.value;if(console.log("handleTabIndentation",a,n,r),a===n)if(t){const o=r.substring(0,a),i=r.substring(n),l=Math.min(2,o.length-o.trimEnd().length),c=o.slice(0,-l)+i,d=a-l;this.setContentAndFocus(c,d,d)}else{const o=r.slice(0,a)+"  "+r.slice(n),i=a+2;this.setContentAndFocus(o,i,i)}else{const o=r.split(`
`),i=r.substring(0,a).split(`
`).length-1,l=r.substring(0,n).split(`
`).length-1;let c=a,d=n;const m=o.map((x,p)=>{if(p>=i&&p<=l)if(t){const g=x.replace(/^ {2}/,""),f=x.length-g.length;return p===i&&(c=Math.max(0,c-f)),p===l&&(d=Math.max(0,d-f)),g}else{const g="  "+x;return p===i&&(c+=2),p===l&&(d+=2),g}return x}).join(`
`);this.setContentAndFocus(m,c,d)}};setContentAndFocus=(t,a,n)=>{console.log("setContentAndFocus",t,a,n),this.addPendingOperation(()=>{this.textarea&&document.contains(this.textarea)&&(this.textarea.focus(),this.textarea.setSelectionRange(a,n))}),this.updateContent(t)};addPendingOperation=t=>{this.pendingOperations.push(t)};consumePendingOperations=()=>{for(;this.pendingOperations.length>0;){const t=this.pendingOperations.shift();t&&t()}};hasPendingOperations=()=>this.pendingOperations.length>0;destroy=()=>{this.textarea.removeEventListener("keydown",this.handleKeyDown)}}const Ss=s=>{const{textareaRef:t,updateContent:a,content:n}=s,r=h.useRef(null),o=h.useRef(a);return h.useEffect(()=>{o.current=a},[a]),h.useEffect(()=>(t.current&&(r.current&&r.current.destroy(),r.current=new gu(t.current,i=>{o.current(i)})),()=>{r.current&&(r.current.destroy(),r.current=null)}),[]),h.useEffect(()=>{r.current&&setTimeout(()=>{r.current?.consumePendingOperations()},0)},[n]),{editor:r.current}};function pu({content:s,onSave:t,onCancel:a,onCollapse:n,isSaving:r}){const[o,i]=h.useState(s),l=h.useRef(null),c=H(p=>p.updateContent);Ss({textareaRef:l,updateContent:c,content:s}),h.useEffect(()=>{l.current&&l.current.focus()},[]),h.useEffect(()=>{i(s)},[s]),h.useEffect(()=>{l.current&&(l.current.style.height="auto",l.current.style.height=`${l.current.scrollHeight}px`)},[o]);const d=p=>{i(p),c(p)},u=()=>{o.trim()&&t()},m=()=>{a()},x=p=>{p.key==="Escape"?m():p.key==="Enter"&&Ft(p)&&u()};return e.jsxs("div",{className:"w-full h-full min-h-0 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-8 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/30",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500 animate-pulse"}),e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Editing Thought"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(N,{variant:"ghost",size:"sm",onClick:n,className:"h-8 px-3 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200",children:[e.jsx(Zo,{className:"w-3.5 h-3.5 mr-1.5"}),"Collapse"]})})]}),e.jsxs("div",{className:"flex-1 min-h-0 flex overflow-hidden",children:[e.jsxs("div",{className:"w-1/2 min-h-0 border-r border-slate-200 dark:border-slate-700 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 border-b border-slate-200 dark:border-slate-700 bg-slate-50/30 dark:bg-slate-800/20",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-600 dark:text-slate-400",children:"Editor"}),e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-500",children:[o.length," characters"]})]})}),e.jsx("div",{className:"flex-1 min-h-0 p-6 overflow-y-auto",children:e.jsx("textarea",{ref:l,value:o,onChange:p=>d(p.target.value),onKeyDown:x,placeholder:"Write your thought in Markdown...",className:"w-full h-full resize-none bg-transparent border-0 rounded-none text-base leading-relaxed placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:ring-0 focus:outline-none focus:border-0 shadow-none text-slate-800 dark:text-slate-200 font-mono",disabled:r,style:{caretColor:"#3b82f6"}})})]}),e.jsxs("div",{className:"w-1/2 min-h-0 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 border-b border-slate-200 dark:border-slate-700 bg-slate-50/30 dark:bg-slate-800/20",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-medium text-slate-600 dark:text-slate-400",children:"Preview"}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-500",children:"Live Preview"})]})}),e.jsx("div",{className:"flex-1 min-h-0 p-6 overflow-y-auto",children:e.jsx("div",{className:"prose prose-slate dark:prose-invert max-w-none",children:o.trim()?e.jsx(ya,{content:o}):e.jsx("div",{className:"text-slate-400 dark:text-slate-500 italic text-center py-8",children:"Start typing to see preview..."})})})]})]}),e.jsx("div",{className:"px-8 py-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/30",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:[e.jsx("kbd",{className:"px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs border border-slate-200 dark:border-slate-700",children:ot.SAVE}),e.jsx("span",{className:"ml-2",children:"to save,"}),e.jsx("kbd",{className:"px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs border border-slate-200 dark:border-slate-700 ml-2",children:ot.CANCEL}),e.jsx("span",{className:"ml-2",children:"to cancel"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(N,{variant:"ghost",size:"sm",onClick:m,disabled:r,className:"h-8 px-3 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800",children:[e.jsx(Z,{className:"w-3.5 h-3.5 mr-1.5"}),"Cancel"]}),e.jsx(N,{size:"sm",onClick:u,disabled:r||!o.trim(),className:"h-8 px-3 bg-blue-600 hover:bg-blue-700 text-white shadow-sm",children:r?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"w-3.5 h-3.5 mr-1.5 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ue,{className:"w-3.5 h-3.5 mr-1.5"}),"Save Changes"]})})]})]})})]})}const xu=({isVisible:s,editContent:t,isSaving:a,onSave:n,onCancel:r,onCollapse:o,className:i=""})=>e.jsx(Be,{open:s,onOpenChange:l=>{l||r()},children:e.jsx(He,{showCloseButton:!1,className:`p-0 gap-0 overflow-hidden sm:max-w-[95vw] md:max-w-5xl w-[95vw] h-[85vh] ${i}`,children:e.jsx(pu,{content:t,onSave:n,onCancel:r,onCollapse:o,isSaving:a})})}),fu=()=>{const s=H(d=>!!(d.editingMessageId&&d.editMode==="expanded")),t=H(d=>d.editContent),a=H(d=>d.isSaving),n=H(d=>d.save),r=H(d=>d.cancel),o=H(d=>d.switchToInlineMode),i=h.useCallback(()=>n(),[n]),l=h.useCallback(()=>r(),[r]),c=h.useCallback(()=>o(),[o]);return e.jsx(xu,{isVisible:s,editContent:t,isSaving:a,onSave:i,onCancel:l,onCollapse:c})},Lr=({actions:s,className:t,leftActions:a,rightActions:n})=>{const r=(o,i)=>e.jsxs(N,{variant:o.variant||"ghost",size:o.size||"sm",onClick:o.onClick,disabled:o.disabled,className:j("h-8 px-3 text-xs",o.className),children:[o.icon,o.label]},i);return e.jsxs("div",{className:j("flex items-center justify-between",t),children:[e.jsx("div",{className:"flex items-center gap-2",children:a?.map(r)}),s&&s.length>0&&e.jsx("div",{className:"flex items-center gap-2",children:s.map(r)}),e.jsx("div",{className:"flex items-center gap-2",children:n?.map(r)})]})};function bu({content:s,onSave:t,onCancel:a,onExpand:n,isSaving:r,className:o}){const[i,l]=h.useState(s),c=h.useRef(null),d=H(g=>g.updateContent);Ss({textareaRef:c,updateContent:d,content:s}),h.useEffect(()=>{c.current&&c.current.focus()},[]),h.useEffect(()=>{l(s)},[s]),h.useEffect(()=>{if(c.current){c.current.style.height="auto";const g=300;c.current.style.height=`${Math.min(c.current.scrollHeight,g)}px`}},[i]);const u=g=>{l(g),d(g)},m=()=>{i.trim()&&t()},x=()=>{a()},p=g=>{g.key==="Escape"?x():g.key==="Enter"&&Ft(g)&&m()};return e.jsxs("div",{className:j("space-y-4",o),children:[e.jsx("div",{className:"relative rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 p-2 shadow-sm",children:e.jsx("textarea",{ref:c,value:i,onChange:g=>u(g.target.value),onKeyDown:p,placeholder:"Edit your thought...",className:"w-full min-h-[120px] max-h-[300px] resize-none bg-transparent border-0 rounded-none text-base leading-relaxed placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:ring-0 focus:outline-none focus:border-0 shadow-none text-slate-800 dark:text-slate-200 font-normal",disabled:r,style:{caretColor:"#3b82f6"}})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400",children:[e.jsx("kbd",{className:"px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs border border-slate-200 dark:border-slate-700",children:ot.SAVE}),e.jsx("span",{className:"ml-2",children:"to save,"}),e.jsx("kbd",{className:"px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs border border-slate-200 dark:border-slate-700 ml-2",children:ot.CANCEL}),e.jsx("span",{className:"ml-2",children:"to cancel"})]}),e.jsx(Lr,{rightActions:[{label:"Expand",onClick:n,disabled:r,icon:e.jsx(ca,{className:"w-3.5 h-3.5 mr-1.5"}),className:"text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800"},{label:"Cancel",onClick:x,disabled:r,icon:e.jsx(Z,{className:"w-3.5 h-3.5 mr-1.5"}),className:"text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800"},{label:r?"Saving...":"Save",onClick:m,disabled:r||!i.trim(),icon:r?e.jsx(ze,{className:"w-3.5 h-3.5 mr-1.5 animate-spin"}):e.jsx(Ue,{className:"w-3.5 h-3.5 mr-1.5"}),className:"bg-blue-600 hover:bg-blue-700 text-white shadow-sm"}]})]})]})}const vu=600,re=de((s,t)=>({statusMap:{},activeMessageId:null,inlineOverlap:!1,activeVisibleHeight:null,pendingCollapseId:null,layoutSync:null,shouldSuppressAutoScroll:!1,suppressionTimestamp:null,setStatus:(a,n)=>s(r=>({statusMap:{...r.statusMap,[a]:n}})),setActiveInfo:(a,n,r)=>s({activeMessageId:a,inlineOverlap:n,activeVisibleHeight:r}),requestCollapse:a=>s({pendingCollapseId:a}),acknowledgeCollapse:()=>s({pendingCollapseId:null}),registerLayoutSync:a=>s({layoutSync:a}),notifyLayoutChange:()=>{const a=t().layoutSync;a?.()},activateAutoScrollSuppression:()=>s({shouldSuppressAutoScroll:!0,suppressionTimestamp:Date.now()}),shouldSuppressAutoScrollNow:()=>{const a=t();return a.shouldSuppressAutoScroll?a.suppressionTimestamp&&Date.now()-a.suppressionTimestamp>vu?(s({shouldSuppressAutoScroll:!1,suppressionTimestamp:null}),!1):!0:!1}})),Rr=s=>{const t=s.activeMessageId;if(!t)return!1;const a=s.statusMap[t];return!a||!a.long||!a.expanded||!s.inlineOverlap?!1:a.collapseThreshold<=0||s.activeVisibleHeight==null?!0:s.activeVisibleHeight>a.collapseThreshold+1},tn=s=>typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(s):s.replace(/["\\]/g,"\\$&"),Ke={messageId:"data-message-id",collapseInlineFor:"data-collapse-inline-for"},Dt={message:`[${Ke.messageId}]`,messageById:s=>`[${Ke.messageId}="${tn(s)}"]`,collapseInlineFor:s=>`[${Ke.collapseInlineFor}="${tn(s)}"]`},yu=s=>s.getAttribute(Ke.messageId);function Dr({children:s,messageId:t,maxHeight:a,clampMargin:n=0,className:r,gradientClassName:o,readMoreLabel:i="Read more",collapseLabel:l="Collapse"}){const c=re(h.useCallback(E=>E.setStatus,[])),d=re(E=>E.pendingCollapseId),u=re(h.useCallback(E=>E.acknowledgeCollapse,[])),[m,x]=h.useState(!1),[p,g]=h.useState(!1),f=h.useRef(null),b=re(Rr),v=re(h.useCallback(E=>E.activeMessageId,[])),y=re(h.useCallback(E=>E.notifyLayoutChange,[])),I=re(h.useCallback(E=>E.activateAutoScrollSuppression,[])),C=h.useRef(!1);h.useEffect(()=>{if(!f.current)return;const E=f.current.scrollHeight;g(E>a+n)},[s,a,n,m]),h.useEffect(()=>{c(t,{long:p,expanded:m,collapseThreshold:a+n})},[t,p,m,a,n,c]),h.useEffect(()=>{d===t&&m&&(x(!1),u())},[d,t,m,u]),h.useEffect(()=>{y()},[y,m,p]),h.useEffect(()=>{m&&!C.current&&I(),C.current=m},[m,I]);const w=()=>x(E=>!E),k=b&&v===t&&m,R={[Ke.collapseInlineFor]:t};return e.jsxs("div",{className:j("relative group overflow-hidden",r),children:[e.jsx("div",{ref:f,className:j("transition-all duration-100 ease-in-out",!m&&p?"overflow-hidden":"",m&&p?"pb-12":""),style:{maxHeight:!m&&p?`${a}px`:"none"},children:s}),!m&&p&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:j("pointer-events-none absolute inset-x-0 bottom-0 h-16 bg-gradient-to-t from-background via-background/60 to-transparent transition-colors duration-200 group-hover:from-muted group-hover:via-muted/50 group-hover:to-transparent z-0",o)}),e.jsxs("button",{type:"button",onClick:w,className:"absolute bottom-2 left-1/2 -translate-x-1/2 z-10 text-xs px-2 py-1.5 rounded-full bg-white/80 dark:bg-slate-900/60 backdrop-blur-sm text-muted-foreground shadow-sm border border-slate-200/30 dark:border-slate-700/30 flex items-center gap-1 active:scale-[0.98] transition-all duration-150 hover:bg-white/90 dark:hover:bg-slate-900/70 hover:shadow-md",children:[e.jsx("span",{children:i}),e.jsx(we,{className:"w-3 h-3"})]})]}),m&&p&&e.jsxs("button",{type:"button",...R,onClick:w,className:j("absolute bottom-4 left-1/2 -translate-x-1/2 z-10 text-xs px-2 py-1.5 rounded-full bg-white/80 dark:bg-slate-900/60 backdrop-blur-sm text-muted-foreground shadow-sm border border-slate-200/30 dark:border-slate-700/30 flex items-center gap-1 active:scale-[0.98] transition-all duration-150 hover:bg-white/90 dark:hover:bg-slate-900/70 hover:shadow-md",k&&"opacity-0 pointer-events-none"),children:[e.jsx(Pt,{className:"w-3 h-3"}),e.jsx("span",{children:l})]})]})}function wu({children:s,maxHeight:t=300,className:a="",messageId:n}){return e.jsx(Dr,{messageId:n,maxHeight:t,className:j("relative overflow-hidden pb-3",a),children:s})}async function ju({schema:s,prompt:t,system:a,temperature:n,jsonOnly:r=!0}){if(!r){const c=(await Zt.chat.completions.create({model:Qt,messages:[{role:"system",content:a||"You are a helpful assistant."},{role:"user",content:t}],temperature:n})).choices?.[0]?.message?.content;if(!c)throw new Error("No content generated");return c}const o={type:"function",function:{name:"generate_structured_data",description:"Generate structured data according to the specified schema",parameters:s}},i=a||"You are a helpful assistant that generates structured data according to specifications.";try{const c=(await Zt.chat.completions.create({model:Qt,messages:[{role:"system",content:i},{role:"user",content:t}],tools:[o],tool_choice:{type:"function",function:{name:"generate_structured_data"}},temperature:typeof n=="number"?n:.3})).choices?.[0]?.message?.tool_calls?.[0];if(!c||c.type!=="function")throw new Error("No tool call generated");if(c.function.name!=="generate_structured_data")throw new Error("Unexpected tool call function name");const d=c.function.arguments;if(!d)throw new Error("No arguments in tool call");return JSON.parse(d)}catch(l){console.error("Failed to generate structured data using tools:",l),console.warn("Falling back to manual JSON generation...");const c=JSON.stringify(s,null,2),d=`You are a strict JSON generator. Return ONLY valid JSON that conforms to the following JSON schema:

${c}

IMPORTANT: Your response must be a valid JSON object that matches this schema exactly.`,u=`

Required output format: A single JSON object that matches the schema above. No markdown, no comments, no additional text.`,m=async(g,f=1)=>{const b=f>1?`

This is attempt ${f}. Please ensure the output strictly follows the schema.`:"",y=(await Zt.chat.completions.create({model:Qt,messages:[{role:"system",content:`${d}${g?`
${g}`:""}${b}`},{role:"user",content:`${t}${u}`}],temperature:n})).choices?.[0]?.message?.content;return typeof y=="string"?y:""};let x=await m(),p;try{return p=JSON.parse(x),p}catch(g){console.warn("First fallback attempt failed, retrying...",g);const f=`The previous output did not match the expected JSON schema. 
Please fix the output to strictly conform to this schema:

${c}

Common issues to avoid:
- Extra text before or after JSON
- Missing required fields
- Wrong data types
- Extra commas or syntax errors

Output ONLY the valid JSON object.`;x=await m(f,2);try{return p=JSON.parse(x),p}catch(b){throw console.error("All attempts failed:",b),console.error("Generated text:",x),new Error(`Failed to generate valid JSON. Tool-based generation failed and fallback also failed. Last error: ${b}`)}}}}class sn{static DEFAULT_OPTIONS={maxMessages:20,maxContentLength:2e3,excludeCurrentMessage:!0};static getChannelContext(t,a,n={}){const r={...this.DEFAULT_OPTIONS,...n},o=at(_.dataContainer,`messageByChannel.${t}`).get();if(!o?.messages)return console.warn(`[ChannelContextService] No messages found for channel: ${t}`),null;let i=o.messages;return r.excludeCurrentMessage&&a&&(i=i.filter(d=>d.id!==a)),{recentMessages:i.sort((d,u)=>u.timestamp.getTime()-d.timestamp.getTime()).slice(0,r.maxMessages).map(d=>({...d,content:this.truncateContent(d.content,r.maxContentLength)})),totalMessageCount:o.messages.length,channelId:t}}static formatContextForPrompt(t){return t.recentMessages.length===0?"":[`
<channel_context>`,"  <metadata>",`    <recent_messages_count>${t.recentMessages.length}</recent_messages_count>`,`    <total_messages_count>${t.totalMessageCount}</total_messages_count>`,`    <channel_id>${t.channelId}</channel_id>`,"  </metadata>","  <recent_thoughts>",...t.recentMessages.map((n,r)=>{const o=this.formatReadableTime(n.timestamp);return`    <thought index="${r+1}" timestamp="${o}">${n.content}</thought>`}),"  </recent_thoughts>",`</channel_context>
`].join(`
`)}static formatReadableTime(t){return t.toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}static truncateContent(t,a){if(t.length<=a)return t;const n=t.substring(0,a),r=Math.max(n.lastIndexOf("."),n.lastIndexOf("!"),n.lastIndexOf("?"));if(r>a*.7)return n.substring(0,r+1)+"...";const o=n.lastIndexOf(" ");return o>a*.8?n.substring(0,o)+"...":n+"..."}}const an={type:"object",properties:{sparks:{type:"array",items:{type:"string"},minItems:3,maxItems:5}},required:["sparks"]};async function _r(s){const{content:t,channelId:a,messageId:n,options:r={}}=s;let o="";if(r.includeChannelContext&&a){const l=sn.getChannelContext(a,n,r.contextOptions);l&&(o=sn.formatContextForPrompt(l))}const i=`<role>
You are StillRoot's intelligent thinking expansion assistant, designed to help users deepen their thoughts and promote cognitive growth.
</role>

<task>
Generate 3-5 thoughtful sparks based on the user's recorded thought below.

<strategy>
Since you can generate multiple sparks (3-5), strategically utilize this space to fully address different objectives and requirements. Each spark can focus on a different aspect, approach, or perspective to provide comprehensive coverage of the user's needs.

<spark_distribution_guide>
- Use 3 sparks minimum, 5 sparks maximum
- Distribute sparks across different objectives to maximize value
- Each spark should have a distinct focus and approach
- Vary the tone and style across sparks (analytical, creative, supportive, etc.)
- Ensure each spark provides unique value rather than repeating similar points
- Pay special attention to additional instructions - they may contain specific generation requirements or preferences that should be prioritized
- If additional instructions specify particular needs, adjust spark allocation and focus accordingly
</spark_distribution_guide>
</strategy>
</task>

<objectives>
<objective priority="high" spark_allocation="1-2">Expand thinking - Provide knowledge, insights, or perspectives that deepen understanding. Use 1-2 sparks to offer different angles of analysis or expertise.</objective>
<objective priority="high" spark_allocation="1">Show care - Express warmth, understanding, and support like a thoughtful friend. Use 1 spark to provide emotional support and encouragement.</objective>
<objective priority="high" spark_allocation="1-2">Adapt intelligently - Match the content type (analytical, emotional, creative, philosophical, etc.). Use 1-2 sparks to demonstrate different thinking styles or approaches.</objective>
<objective priority="high" spark_allocation="1">Promote growth - Help users learn, reflect, and develop their thinking. Use 1 spark to suggest actionable next steps or reflection questions.</objective>
${o?'<objective priority="medium" spark_allocation="1">Connect contextually - Consider related thoughts from the same channel to provide more relevant and connected insights. Use 1 spark to draw connections with previous thoughts.</objective>':""}
<objective priority="highest" spark_allocation="flexible">Additional Instructions - If additional instructions are provided, prioritize and incorporate them into spark generation. Adjust spark allocation and focus to meet specific user requirements mentioned in additional instructions.</objective>
</objectives>

<quality_requirements>
<requirement>Highly relevant to the user's thought</requirement>
<requirement>Educational and thought-provoking</requirement>
<requirement>Warm and supportive in tone</requirement>
<requirement>Varied in approach and perspective</requirement>
${o?"<requirement>Connected to the broader context of their thinking journey</requirement>":""}
</quality_requirements>

<user_content>
${t}
</user_content>
${o?`<context>${o}</context>`:""}${r.additionalInstructions?`

<additional_instructions>${r.additionalInstructions}</additional_instructions>`:""}`;console.log("Generating creative sparks with schema:",an);try{const l=await ju({schema:an,prompt:i,temperature:.9,jsonOnly:!0});return console.log("Successfully generated creative sparks:",l.sparks),l.sparks}catch(l){throw console.error("Failed to generate creative sparks:",l),l}}async function Nu(s){return _r({content:s})}class Cu{rules=[];constructor(){this.initializeDefaultRules()}addRule(t){this.rules.push(t),this.rules.sort((a,n)=>(n.priority||0)-(a.priority||0))}removeRule(t){this.rules=this.rules.filter(a=>a.pattern.toString()!==t.toString())}processTags(t,a){const n=[];for(const o of a){const i=this.findMatchingRule(o);if(i){const l=i.handler(o,t);l&&n.push(l)}}return n.length===0?{enhancedPrompt:t,hasTagContext:!1}:{enhancedPrompt:`Special instructions:
${n.join(`
`)}`,hasTagContext:!0}}hasTagContext(t){return this.findMatchingRule(t)!==null}getSupportedPatterns(){return this.rules.map(t=>({pattern:t.pattern.toString(),description:t.description||"No description",priority:t.priority||0}))}findMatchingRule(t){for(const a of this.rules)if(typeof a.pattern=="string"){if(t.toLowerCase()===a.pattern.toLowerCase())return a}else if(a.pattern.test(t))return a;return null}initializeDefaultRules(){this.addRule({pattern:"prompt",handler:(t,a)=>`<instruction>${a}</instruction>`,priority:10,description:"Convert content to instruction"}),this.addRule({pattern:"translate",handler:(t,a)=>`<translate>${a}</translate>`,priority:10,description:"Translate content"}),this.addRule({pattern:"to-english",handler:(t,a)=>`<translate-to-english>${a}</translate-to-english>`,priority:10,description:"Translate content to English"}),this.addRule({pattern:/^prompt:/i,handler:t=>{const a=t.substring(7).trim();return a?`<instruction>${a}</instruction>`:""},priority:20,description:"Any tag starting with prompt: becomes an instruction"})}}const ku=new Cu;function nn(s,t){return ku.processTags(s,t)}function Su({message:s,showAnalysis:t,className:a,onClose:n,enableContextEnhancement:r=!0}){const[o,i]=h.useState(!1),l=s.aiAnalysis,c=!!(l&&l.insights&&l.insights.length>0),{hasTagContext:d}=nn(s.content,s.tags||[]);async function u(){try{i(!0);const{enhancedPrompt:m,hasTagContext:x}=nn(s.content,s.tags||[]),p=await _r({content:s.content,channelId:s.channelId,messageId:s.id,options:{includeChannelContext:r,additionalInstructions:x?m:void 0}}),{userId:g}=T.getState();if(!g)throw new Error("User not authenticated");await _.updateMessage({messageId:s.id,channelId:s.channelId,updates:{aiAnalysis:{...l,insights:p,keywords:l?.keywords??[],topics:l?.topics??[],sentiment:l?.sentiment??"neutral",summary:l?.summary??"",tags:l?.tags??[],relatedTopics:l?.relatedTopics??[]}},userId:g})}finally{i(!1)}}return t?e.jsx("div",{className:j("mb-4 p-4 bg-slate-50/60 dark:bg-slate-800/30 rounded-lg border border-slate-200/50 dark:border-slate-700/50",a),children:e.jsx("div",{className:"space-y-4",children:c?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Creative Sparks"}),d&&e.jsx("span",{className:"text-xs px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-full",children:"Tag-enhanced"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{onClick:u,variant:"outline",disabled:o,children:o?"Generating...":"Regenerate"}),n&&e.jsx("button",{onClick:n,className:"p-1 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-all duration-200 rounded hover:bg-slate-200/60 dark:hover:bg-slate-700/60",title:"Close analysis",children:e.jsx(Z,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"space-y-3",children:l?.insights?.map((m,x)=>e.jsx("div",{className:"p-3 bg-white/60 dark:bg-slate-700/40 rounded-lg border border-slate-200/40 dark:border-slate-600/40",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-yellow-500/80 mt-2 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-slate-700 dark:text-slate-200 leading-relaxed",children:m})]})},x))})]}):e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Creative Sparks"}),d&&e.jsx("span",{className:"text-xs px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-full",children:"Tag-enhanced"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",onClick:u,disabled:o,children:o?"Generating...":"Generate Sparks"}),n&&e.jsx("button",{onClick:n,className:"p-1 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-all duration-200 rounded hover:bg-slate-200/60 dark:hover:bg-slate-700/60",title:"Close analysis",children:e.jsx(Z,{className:"w-4 h-4"})})]})]})})}):null}function Iu({icon:s,onClick:t,title:a,disabled:n,active:r}){return e.jsx("button",{onClick:()=>t?.(),disabled:n,className:`p-2 transition-all duration-200 rounded-lg hover:scale-105 ${r?"bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-400":"text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 hover:bg-slate-200/60 dark:hover:bg-slate-700/60"} ${n?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,title:a,children:e.jsx(s,{className:"w-4 h-4"})})}function Mu({message:s,onDelete:t,onEdit:a,onCopy:n,onShare:r,onReport:o}){const i=()=>{n?n():navigator.clipboard.writeText(s.content)},l=[{id:"primary",showSeparator:!1,items:[...a?[{id:"edit",icon:e.jsx(ra,{}),title:"Edit thought",description:"Modify this thought",onClick:a,variant:"default"}]:[],{id:"copy",icon:e.jsx(It,{}),title:"Copy content",onClick:i,variant:"default"},...r?[{id:"share",icon:e.jsx(ei,{}),title:"Share thought",description:"Share with others",onClick:r,variant:"default"}]:[]]},{id:"advanced",title:"Advanced",variant:"default",items:[...o?[{id:"report",icon:e.jsx(ti,{}),title:"Report",description:"Report inappropriate content",onClick:o,variant:"warning"}]:[]]},{id:"danger",title:"Danger Zone",variant:"danger",items:[{id:"delete",icon:e.jsx(Te,{}),title:"Delete thought",onClick:t}]}];return e.jsx(wr,{groups:l})}function Eu({onToggleAnalysis:s,onReply:t,onEdit:a,message:n,onDelete:r,isEditing:o}){const i=[{icon:os,onClick:a,title:"Edit thought",disabled:o,enabled:se().channel.thoughtRecord.edit.enabled},{icon:lt,onClick:s,title:"Toggle sparks",disabled:o,enabled:se().channel.thoughtRecord.sparks.enabled},{icon:si,onClick:void 0,title:"View details",disabled:o,enabled:se().channel.thoughtRecord.viewDetails.enabled},{icon:kn,onClick:void 0,title:"Bookmark",disabled:o,enabled:se().channel.thoughtRecord.bookmark.enabled},{icon:$s,onClick:t,title:"Reply to thought",disabled:o,enabled:se().channel.thoughtRecord.reply.enabled}].filter(l=>l.enabled);return e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out",children:[i.map(({icon:l,onClick:c,title:d,disabled:u})=>e.jsx(Iu,{icon:l,onClick:c,title:d,disabled:u},d)),e.jsx(Mu,{message:n,onDelete:r,onCopy:()=>navigator.clipboard.writeText(n.content)})]})}function rn({children:s,onClick:t,className:a=""}){const n="hover:text-slate-600 dark:hover:text-slate-300 transition-colors duration-200",r=t?"cursor-pointer":"";return t?e.jsx("button",{onClick:t,className:`${n} ${r} ${a}`,children:s}):e.jsx("span",{className:`${n} ${a}`,children:s})}class Tu{requestOpenAIAssistant$=new De;requestOpenAIConversation$=new De;requestOpenThread$=new De;requestCloseThread$=new De;requestOpenSettings$=new De;requestJumpToMessage$=new De}const ve=new Tu;function Au({tags:s,onTagsChange:t,trigger:a,maxTags:n=10,placeholder:r="Add a tag..."}){const[o,i]=h.useState(!1),[l,c]=h.useState(""),[d,u]=h.useState(null),m=h.useRef(null);h.useEffect(()=>{o&&m.current&&m.current.focus()},[o]);const x=C=>{const w=C.trim().toLowerCase();if(w){if(s.includes(w)){c("");return}s.length>=n||(t([...s,w]),c(""))}},p=C=>{t(s.filter(w=>w!==C))},g=C=>{C.key==="Enter"?(C.preventDefault(),x(l)):C.key==="Escape"&&i(!1)},f=()=>{x(l)},b=C=>{u(C),c(C),m.current&&m.current.focus()},v=()=>{if(d&&l.trim()){const C=l.trim().toLowerCase();C!==d&&!s.includes(C)&&t(s.map(w=>w===d?C:w)),u(null),c("")}},y=()=>{u(null),c("")},I=C=>{C.key==="Enter"?(C.preventDefault(),v()):C.key==="Escape"&&y()};return e.jsxs(Et,{open:o,onOpenChange:i,children:[e.jsx(Tt,{asChild:!0,children:a||e.jsxs(N,{variant:"ghost",size:"sm",className:"h-8 px-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 dark:text-slate-400 dark:hover:text-slate-100 dark:hover:bg-slate-800",children:[e.jsx(Us,{className:"h-4 w-4 mr-1"}),"Tags",s.length>0&&e.jsx("span",{className:"ml-1 px-1.5 py-0.5 text-xs bg-slate-200 dark:bg-slate-700 rounded-full",children:s.length})]})}),e.jsxs(At,{className:"w-80 p-0",align:"start",side:"bottom",children:[e.jsxs("div",{className:"p-3 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Us,{className:"h-4 w-4 text-slate-600 dark:text-slate-400"}),e.jsx("h3",{className:"text-sm font-medium text-slate-900 dark:text-slate-100",children:"Edit Tags"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ye,{ref:m,value:l,onChange:C=>c(C.target.value),onKeyPress:d?I:g,placeholder:d?`Edit "${d}"`:r,className:"flex-1"}),d?e.jsxs("div",{className:"flex gap-1",children:[e.jsx(N,{size:"sm",variant:"outline",onClick:y,className:"px-2",children:e.jsx(Z,{className:"h-3 w-3"})}),e.jsx(N,{size:"sm",onClick:v,disabled:!l.trim(),className:"px-2",children:"✓"})]}):e.jsx(N,{size:"sm",onClick:f,disabled:!l.trim()||s.length>=n,className:"px-2",children:e.jsx(ae,{className:"h-3 w-3"})})]})]}),e.jsx("div",{className:"p-3",children:s.length===0?e.jsx("div",{className:"text-center py-4 text-slate-500 dark:text-slate-400 text-sm",children:"No tags yet. Add some above."}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-xs text-slate-500 dark:text-slate-400 mb-2",children:[s.length," of ",n," tags"]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:s.map(C=>e.jsxs("div",{className:"group flex items-center gap-1 bg-slate-100 dark:bg-slate-800 rounded-md px-2 py-1 text-sm",children:[e.jsx("span",{className:"cursor-pointer hover:text-blue-600 dark:hover:text-blue-400",onClick:()=>b(C),children:C}),e.jsx("button",{onClick:()=>p(C),className:"opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-slate-600 dark:hover:text-slate-300",children:e.jsx(Z,{className:"h-3 w-3"})})]},C))})]})})]})]})}const Lu={default:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",secondary:"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200",outline:"border border-gray-300 text-gray-700 dark:border-gray-600 dark:text-gray-300",destructive:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200",footer:"bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300"},Ru={sm:"px-2 py-1 text-xs",md:"px-2.5 py-1.5 text-sm",lg:"px-3 py-2 text-base"};function Du({name:s,variant:t="default",size:a="sm",removable:n=!1,onClick:r,onRemove:o,className:i,truncate:l=!1,maxWidth:c="80px"}){const d=u=>{u.stopPropagation(),o?.()};return e.jsxs("span",{className:j("inline-flex items-center gap-1 rounded-full font-medium transition-colors",Lu[t],Ru[a],r&&"cursor-pointer hover:opacity-80",l&&"max-w-[80px]",i),style:l?{maxWidth:c}:void 0,onClick:r,title:l?s:void 0,children:[e.jsxs("span",{className:j(l&&"truncate"),children:["#",s]}),n&&e.jsx(N,{variant:"ghost",size:"sm",className:"h-4 w-4 p-0 hover:bg-transparent",onClick:d,children:e.jsx(Z,{className:"h-3 w-3"})})]})}function _u({tags:s,variant:t="default",size:a="sm",removable:n=!1,onTagClick:r,onTagRemove:o,className:i,maxTags:l,truncate:c=!1,maxWidth:d="80px"}){const u=l?s.slice(0,l):s,m=l&&s.length>l?s.length-l:0;return s.length===0?null:e.jsxs("div",{className:j("flex flex-wrap gap-1",i),children:[u.map(x=>e.jsx(Du,{name:x,variant:t,size:a,removable:n,onClick:()=>r?.(x),onRemove:()=>o?.(x),truncate:c,maxWidth:d},x)),m>0&&e.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:["+",m," more"]})]})}function Pu({tags:s,onTagsChange:t,maxTags:a=10}){return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Au,{tags:s,onTagsChange:t,maxTags:a,trigger:e.jsxs("button",{className:"flex items-center gap-1 px-2 py-1 rounded transition-all duration-200 text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:text-slate-400 dark:hover:text-slate-200 dark:hover:bg-slate-800",children:[e.jsx(Us,{className:"h-3 w-3"}),s.length>0?`${s.length} tags`:"Add tags"]})}),s.length>0&&e.jsx(_u,{tags:s,variant:"footer",size:"sm",maxTags:2,truncate:!0,maxWidth:"80px"})]})}function Ou({message:s,editingTags:t,onTagsChange:a,hasSparks:n,aiAnalysis:r,onToggleAnalysis:o,threadCount:i}){return e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-400 dark:text-slate-500 px-6",children:[e.jsxs("div",{className:"flex items-center gap-4 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out",children:[e.jsxs(rn,{children:[s.content.length," characters"]}),n&&se().channel.thoughtRecord.sparks.enabled&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-slate-300 dark:text-slate-600",children:"•"}),e.jsxs(rn,{onClick:o,children:[r.insights.length," sparks"]})]}),e.jsx(Pu,{tags:t,onTagsChange:a,maxTags:10})]}),e.jsx("div",{className:"flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-out",children:se().channel.thoughtRecord.thread.enabled})]})}function $u(s){const{currentChannelId:t}=O(),{userId:a}=T(),[n,r]=h.useState(!1),[o,i]=h.useState(s.tags||[]),l=_.deleteMessage,c=H(L=>L.editingMessageId),d=H(L=>L.editContent),u=H(L=>L.editMode),m=H(L=>L.isSaving),x=H(L=>L.startEditing),p=H(L=>L.save),g=H(L=>L.cancel),f=H(L=>L.switchToExpandedMode),b=c===s.id,v=b?d:s.content,y=b?u:"inline",I=b?m:!1,C=s.aiAnalysis,w=!!C?.insights?.length;return h.useEffect(()=>{i(s.tags||[])},[s.tags]),{showAnalysis:n,editingTags:o,isEditing:b,aiAnalysis:C,hasSparks:w,editContent:v,editMode:y,isSaving:I,handleDelete:async()=>{setTimeout(async()=>{const L=s.content.length>100?`${s.content.substring(0,100)}...`:s.content;if(window.confirm(`🗑️ Delete Thought

"${L}"

⚠️ This action cannot be undone.
The thought will be moved to trash.

Are you sure you want to continue?`))try{await l({messageId:s.id,hardDelete:!1,channelId:t})}catch(V){const ne=V instanceof Error?V.message:"Unknown error";alert(`❌ Failed to delete the message.

Error: ${ne}

Please try again.`)}},0)},handleToggleAnalysis:()=>{r(!n)},handleEdit:()=>{x(s.id,s.content)},handleSave:async()=>{await p()},handleCancel:()=>{g()},handleExpand:()=>{f()},handleTagsChange:async L=>{if(i(L),!(!a||!t))try{await _.updateMessage({messageId:s.id,channelId:t,updates:{tags:L},userId:a})}catch(Ae){console.error("Failed to update tags:",Ae),i(s.tags||[])}}}}function Uu({message:s,onReply:t,threadCount:a=0}){const{showAnalysis:n,editingTags:r,isEditing:o,aiAnalysis:i,hasSparks:l,editContent:c,editMode:d,isSaving:u,handleDelete:m,handleToggleAnalysis:x,handleEdit:p,handleSave:g,handleCancel:f,handleExpand:b,handleTagsChange:v}=$u(s);return s.isDeleted?null:e.jsx("div",{className:"w-full","data-component":"thought-record",children:e.jsxs("div",{className:`group relative w-full py-4 transition-all duration-300 ease-out ${o?"bg-gray-100/60 dark:bg-gray-800/30":"hover:bg-gray-100/80 dark:hover:bg-gray-800/20"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 px-6",children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 font-medium",children:[e.jsx(la,{className:"w-3 h-3"}),e.jsx("span",{children:rt(s.timestamp)})]})}),e.jsx(Eu,{onToggleAnalysis:x,onReply:t,onEdit:p,message:s,onDelete:m,isEditing:o})]}),o&&d==="inline"?e.jsx(bu,{content:c,onSave:g,onCancel:f,onExpand:b,isSaving:u,className:"px-6"}):e.jsx("div",{className:"px-6",children:e.jsx(wu,{maxHeight:300,messageId:s.id,children:e.jsx(ya,{content:s.content})})}),!o&&e.jsx(Su,{message:s,showAnalysis:n,className:"px-6 mx-6",onClose:x}),!o&&e.jsx(Ou,{message:s,editingTags:r,onTagsChange:v,hasSparks:l,aiAnalysis:i||null,onToggleAnalysis:x,threadCount:a})]})})}function Fu({message:s,onMessageChange:t,onKeyDown:a,placeholder:n,disabled:r,textareaRef:o}){return e.jsx("div",{className:"px-3 pb-2",children:e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"relative min-h-[70px] bg-transparent",children:e.jsx("textarea",{ref:o,value:s,onChange:i=>t(i.target.value),onKeyDown:a,placeholder:n,className:"w-full min-h-[70px] max-h-[200px] resize-none pr-12 pl-4 py-2 pt-0 bg-transparent border-0 rounded-none text-sm leading-relaxed placeholder:text-slate-400 dark:placeholder:text-slate-500 placeholder:text-sm focus:ring-0 focus:outline-none focus:border-0 shadow-none",disabled:r,style:{caretColor:"#3b82f6"}})})})})}function zu({replyToMessage:s,onCancelReply:t}){return e.jsx("div",{className:"px-4 py-2 bg-blue-50 dark:bg-blue-900/20 border-b border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ai,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm text-blue-700 dark:text-blue-300",children:"Reply:"}),e.jsxs("span",{className:"text-sm text-slate-600 dark:text-slate-400 truncate",children:[s.content.substring(0,50),"..."]})]}),e.jsx("button",{onClick:t,className:"text-slate-400 hover:text-slate-600 dark:hover:text-slate-300",children:e.jsx(ps,{className:"w-4 h-4"})})]})})}function Bu({onSend:s,disabled:t,message:a}){return e.jsx("div",{className:"absolute bottom-2 right-3",children:e.jsx("button",{onClick:s,disabled:t,className:`w-8 h-8 rounded-full flex items-center justify-center transition-all duration-200 ${a.trim()&&!t?"bg-blue-500 text-white hover:bg-blue-600 shadow-sm":"bg-slate-100 dark:bg-slate-700 text-slate-400"}`,children:e.jsx($t,{className:"w-4 h-4"})})})}function on({icon:s,onClick:t,title:a,disabled:n=!1,className:r=""}){const o="w-8 h-8 rounded-lg flex items-center justify-center text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-slate-300 transition-all duration-200",i=n?"opacity-50 cursor-not-allowed":"cursor-pointer";return e.jsx("button",{onClick:()=>t?.(),disabled:n,className:`${o} ${i} ${r}`,title:a,children:e.jsx(s,{className:"w-4 h-4"})})}function wa(){const{currentChannelId:s}=O(),t=$e(h.useCallback(i=>s?i.timelineInputCollapsed[s]??!1:!1,[s])),a=$e(h.useCallback(i=>i.setTimelineInputCollapsed,[])),n=re(h.useCallback(i=>i.notifyLayoutChange,[])),r=h.useCallback(()=>{s&&(ce.logInputCollapse(Xs.COLLAPSE),a(s,!0),n())},[s,a,n]),o=h.useCallback(()=>{s&&(ce.logInputCollapse(Xs.EXPAND),a(s,!1),n())},[s,a,n]);return{inputCollapsed:t,handleCollapseInput:r,handleExpandInput:o,currentChannelId:s}}function Hu(){const{inputCollapsed:s,handleCollapseInput:t,handleExpandInput:a}=wa(),n=[{icon:ni,title:"Emoji",onClick:void 0,enabled:se().channel.input.emoji.enabled},{icon:is,title:"Image",onClick:void 0,enabled:se().channel.input.image.enabled},{icon:Ee,title:"File",onClick:void 0,enabled:se().channel.input.file.enabled},{icon:ri,title:"Voice",onClick:void 0,enabled:se().channel.input.voice.enabled},{icon:ps,title:"More",onClick:void 0,enabled:se().channel.input.more.enabled}].filter(o=>o.enabled),r=[{icon:oi,title:"Call",onClick:void 0,enabled:se().channel.input.call.enabled},{icon:ii,title:"Video",onClick:void 0,enabled:se().channel.input.video.enabled}].filter(o=>o.enabled);return s?r.push({icon:$t,title:"Show composer",onClick:a,enabled:!0}):r.push({icon:li,title:"Hide composer",onClick:t,enabled:!0}),e.jsxs("div",{className:"px-3 py-1 flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-1",children:n.map((o,i)=>e.jsx(on,{icon:o.icon,onClick:o.onClick,title:o.title},i))}),e.jsx("div",{className:"flex items-center gap-1",children:r.map((o,i)=>e.jsx(on,{icon:o.icon,onClick:o.onClick,title:o.title},i))})]})}function Gu({onSend:s,replyToMessageId:t}){const[a,n]=h.useState(""),r=h.useRef(null),{sendMessage:o}=_,i=T(f=>f.addThreadMessage),{currentChannelId:l,isAddingMessage:c}=O(),{messages:d=[]}=mt({}),u=h.useMemo(()=>t&&d.length>0?d.find(f=>f.id===t):null,[t,d]),m=async()=>{if(!a.trim()||!l)return;const f=a.trim(),b=f.includes("#"),v=cr.TEXT;ce.logMessageSend(l,v,f.length,b),t?(ce.logMessageReply(t,l,t),i(t,{content:f,sender:"user",channelId:l})):o({content:f,sender:"user",channelId:l}),s(),n("")},x=f=>{f.key==="Enter"&&Ft(f)&&(f.preventDefault(),m())},p=f=>{n(f)};h.useEffect(()=>{r.current&&(r.current.style.height="auto",r.current.style.height=`${Math.min(r.current.scrollHeight,200)}px`)},[a]);const g=u?`Reply to this message... (${ot.SEND} to send, Enter for new line)`:`Record your thoughts... (${ot.SEND} to send, Enter for new line)`;return{message:a,textareaRef:r,replyToMessage:u,isAddingMessage:c,handleSend:m,handleKeyDown:x,handleMessageChange:p,placeholder:g,currentChannelId:l}}function Vu({onSend:s,replyToMessageId:t,onCancelReply:a}){const{message:n,textareaRef:r,replyToMessage:o,isAddingMessage:i,handleSend:l,handleKeyDown:c,handleMessageChange:d,placeholder:u}=Gu({onSend:s,replyToMessageId:t});return e.jsxs("div",{className:"bg-white dark:bg-background border-t border-slate-200/50 dark:border-slate-700/50",children:[o&&e.jsx(zu,{replyToMessage:o,onCancelReply:a}),e.jsx(Hu,{}),e.jsxs("div",{className:"relative",children:[e.jsx(Fu,{message:n,onMessageChange:d,onKeyDown:c,placeholder:u,disabled:i,textareaRef:r}),e.jsx(Bu,{onSend:l,disabled:!n.trim()||i,message:n})]})]})}const qu=()=>e.jsx("div",{className:"w-full p-4 space-y-3 border-b border-border/50",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(G,{className:"w-8 h-8 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(G,{className:"h-4 w-24"}),e.jsx(G,{className:"h-3 w-16"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"h-4 w-full"}),e.jsx(G,{className:"h-4 w-3/4"}),e.jsx(G,{className:"h-4 w-1/2"})]}),e.jsxs("div",{className:"flex items-center space-x-2 pt-2",children:[e.jsx(G,{className:"h-6 w-16"}),e.jsx(G,{className:"h-6 w-16"}),e.jsx(G,{className:"h-6 w-16"})]})]})]})}),Pr=({count:s=3})=>e.jsx("div",{className:"w-full h-full overflow-hidden",children:Array.from({length:s}).map((t,a)=>e.jsx(qu,{},a))}),ta=({onClick:s,children:t,ariaLabel:a,isVisible:n=!0,className:r})=>n?e.jsx(N,{size:"sm",variant:"secondary",className:j("h-8 w-8 rounded-full p-0 shadow-lg",r),onClick:s,"aria-label":a,children:t}):null,Wu=({onClick:s,isVisible:t})=>e.jsx(ta,{onClick:s,isVisible:t,ariaLabel:"Scroll to bottom",children:e.jsx(we,{className:"h-4 w-4"})}),Ku=({scrollContainerRef:s})=>{const t=h.useRef(0);return h.useEffect(()=>{s.current&&(t.current=s.current.scrollHeight)},[s]),h.useEffect(()=>{const a=s.current;if(!a)return;t.current=a.scrollHeight;const n=()=>{t.current=a.scrollHeight};return a.addEventListener("scroll",n),()=>{a.removeEventListener("scroll",n)}},[t,s]),{lastScrollHeightRef:t}},Yu=({enableDetect:s,scrollContainerRef:t,handleScrollHeightChange:a})=>{const{lastScrollHeightRef:n}=Ku({scrollContainerRef:t}),r=ls(a);h.useEffect(()=>{if(!s)return;const o=t.current;if(!o)return;let i=null;const l=()=>{o&&(o.scrollHeight!==n.current&&r(),i=requestAnimationFrame(l))};return i=requestAnimationFrame(l),()=>{i&&cancelAnimationFrame(i)}},[s,t,n,r])};function Xu({scrollContainerRef:s,threshold:t=30,deps:a=[]}){const[n,r]=h.useState(!1),o=h.useCallback((l={})=>{const c=s.current;c&&(l.smooth?c.scrollTo({top:c.scrollHeight,behavior:"smooth"}):c.scrollTop=c.scrollHeight)},[s]),i=h.useCallback(()=>{const l=s.current;if(!l)return;const c=l.scrollHeight-l.scrollTop-l.clientHeight;r(c<=t)},[t,s]);return h.useEffect(()=>{n&&o()},a),h.useEffect(()=>{const l=s.current;if(l)return l.addEventListener("scroll",i),()=>{l.removeEventListener("scroll",i)}},[i,s]),Yu({enableDetect:n,scrollContainerRef:s,handleScrollHeightChange:()=>{re.getState().shouldSuppressAutoScrollNow()?re.getState().activateAutoScrollSuppression():o()}}),{isSticky:n,scrollToBottom:o,setSticky:r}}const ln=(s,t=5)=>{if(!s)return!1;const{scrollTop:a,clientHeight:n,scrollHeight:r}=s;return r-a-n>t},Or=(s,t=[],a={})=>{const{scrollToBottom:n,isSticky:r,setSticky:o}=Xu({scrollContainerRef:s,threshold:a.threshold??30,deps:t}),[i,l]=h.useState(!1);h.useEffect(()=>{const d=s.current;if(d){l(ln(d,a.threshold??30));const u=()=>{l(ln(d,a.threshold??30))};return d.addEventListener("scroll",u),()=>{d?.removeEventListener("scroll",u)}}},[s,a.threshold]);const c=ls(d=>{o(!0),n({smooth:d?.behavior==="smooth"})});return{containerRef:s,isSticky:r,scrollToBottom:c,showScrollToBottomButton:i}},Ju=({containerRef:s})=>{const t=h.useRef(null),a=h.useCallback(()=>{if(!s.current)return;const r=s.current;t.current={scrollTop:r.scrollTop,scrollHeight:r.scrollHeight,clientHeight:r.clientHeight}},[s]),n=h.useCallback(()=>{if(!t.current||!s.current)return;const{scrollTop:r,scrollHeight:o}=t.current,i=s.current;requestAnimationFrame(()=>{if(!i)return;const d=i.scrollHeight-o;d>0&&i.scrollTo({top:r+d,behavior:"instant"}),t.current=null})},[s]);return{recordScrollPosition:a,restoreScrollPosition:n}},Is=de()(ct(s=>({isAIAssistantOpen:!zn(),isThreadOpen:!1,currentThreadId:null,isSettingsOpen:!1,isChannelListOpen:!1,openAIAssistant:()=>{s({isAIAssistantOpen:!0,isThreadOpen:!1,currentThreadId:null})},closeAIAssistant:()=>{s({isAIAssistantOpen:!1})},openThread:t=>{s({isThreadOpen:!0,currentThreadId:t,isAIAssistantOpen:!1})},closeThread:()=>{s({isThreadOpen:!1,currentThreadId:null})},openSettings:()=>{s({isSettingsOpen:!0})},closeSettings:()=>{s({isSettingsOpen:!1})},openChannelList:()=>{s({isChannelListOpen:!0})},closeChannelList:()=>{s({isChannelListOpen:!1})}}),{name:"echonote-ui-state",partialize:s=>({isAIAssistantOpen:s.isAIAssistantOpen})}));function Qu(s){const{container:t,element:a,topVisibleBefore:n,onCollapse:r}=s,o=t.getBoundingClientRect();r(),requestAnimationFrame(()=>{if(!n){const l=a.getBoundingClientRect().top-o.top;t.scrollTop+=l}})}function Zu(s){if(!s)return 8;const a=getComputedStyle(s).getPropertyValue("--collapse-float-offset"),n=parseFloat(a);return Number.isFinite(n)?n:8}function eh(s){const t=Array.from(s.querySelectorAll(Dt.message));if(!t.length)return{id:null,inlineOverlap:!1,visibleHeight:null};const a=s.getBoundingClientRect();let n=null;for(const d of t){const u=d.getBoundingClientRect();if(u.bottom<a.top||u.top>a.bottom)continue;const m=yu(d);if(!m)continue;const x=Math.max(0,a.bottom-u.bottom);(!n||x<n.distance)&&(n={id:m,distance:x,rect:u})}if(!n)return{id:null,inlineOverlap:!1,visibleHeight:null};const o=s.querySelector(Dt.collapseInlineFor(n.id))?.getBoundingClientRect(),i=Zu(s),l=o?a.bottom-o.bottom<=i+.5:!1,c=Math.max(0,Math.min(a.bottom,n.rect.bottom)-Math.max(a.top,n.rect.top));return{id:n.id,inlineOverlap:l,visibleHeight:c}}function th(s){const t=re(Rr),a=re(h.useCallback(u=>u.requestCollapse,[])),n=re(h.useCallback(u=>u.setActiveInfo,[])),r=re(h.useCallback(u=>u.registerLayoutSync,[])),o=h.useRef(null),i=h.useRef(null),l=h.useCallback(()=>{const u=s.current;u&&(o.current&&cancelAnimationFrame(o.current),o.current=requestAnimationFrame(()=>{const{id:m,inlineOverlap:x,visibleHeight:p}=eh(u);n(m,x,p)}))},[s,n]);h.useEffect(()=>()=>{o.current&&cancelAnimationFrame(o.current),i.current?.disconnect()},[]),h.useEffect(()=>{const u=s.current;if(!u)return;const m=new MutationObserver(x=>{x.some(g=>g.type!=="childList"?!1:[...Array.from(g.addedNodes),...Array.from(g.removedNodes)].some(b=>b instanceof HTMLElement&&b.hasAttribute(Ke.messageId)))&&l()});return m.observe(u,{childList:!0,subtree:!0}),i.current=m,l(),()=>{m.disconnect()}},[s,l]),h.useEffect(()=>(r(l),()=>r(null)),[r,l]),h.useEffect(()=>(window.addEventListener("resize",l),()=>window.removeEventListener("resize",l)),[l]);const c=h.useCallback(()=>{l()},[l]),d=h.useCallback(()=>{const m=re.getState().activeMessageId,x=s.current;if(!m||!x)return;const p=x.querySelector(Dt.messageById(m));if(!p)return;const g=x.getBoundingClientRect(),f=p.getBoundingClientRect().top>=g.top;Qu({container:x,element:p,topVisibleBefore:f,onCollapse:()=>a(m)})},[s,a]);return{showFloatingCollapse:t,handleScroll:c,collapseCurrent:d}}const sh=({date:s})=>{const t=Hs(new Date(s),"MMM dd, yyyy");return e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"px-4 py-1.5 bg-slate-50/60 dark:bg-slate-900/40 rounded-lg",children:e.jsx("span",{className:"text-xs font-normal text-slate-500 dark:text-slate-400 tracking-wide",children:t})}),e.jsx("div",{className:"absolute -left-12 top-1/2 transform -translate-y-1/2 w-8 h-px bg-slate-200/40 dark:bg-slate-700/40"}),e.jsx("div",{className:"absolute -right-12 top-1/2 transform -translate-y-1/2 w-8 h-px bg-slate-200/40 dark:bg-slate-700/40"})]})})},$r=h.forwardRef(({renderThoughtRecord:s,className:t="",groupedMessages:a,messages:n,onScroll:r,onHistoryMessagesLoadedEvent$:o},i)=>{const{isAIAssistantOpen:l,openAIAssistant:c}=Is(),{inputCollapsed:d,handleExpandInput:u}=wa(),m=h.useRef(null),{scrollToBottom:x,showScrollToBottomButton:p}=Or(m,[],{}),{recordScrollPosition:g,restoreScrollPosition:f}=Ju({containerRef:m}),{showFloatingCollapse:b,handleScroll:v,collapseCurrent:y}=th(m),I=Ke.messageId,C=h.useCallback(k=>{r?.(k),g(),v()},[r,g,v]);h.useEffect(()=>o?.listen(()=>{f()}),[o,f]),h.useImperativeHandle(i,()=>({scrollToBottom:x}),[x]),h.useEffect(()=>{x({behavior:"instant"})},[x]);const w=h.useMemo(()=>{const k=new Map;for(const R of n??[]){const E=R.threadId||R.id;k.set(E,(k.get(E)??0)+1)}return k},[n]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{"data-component":"message-timeline",ref:m,className:`w-full bg-background flex-1 overflow-y-auto min-h-0 timeline-scroll ${t}`,style:{height:"100%",minHeight:"100%",maxHeight:"100%",scrollbarWidth:"thin",scrollbarColor:"rgba(148, 163, 184, 0.4) transparent"},onScroll:C,children:Object.entries(a).map(([k,R])=>{const E=R.filter(S=>S.sender==="user"&&!S.parentId);return e.jsxs("div",{className:"w-full",style:{height:"auto",minHeight:"auto"},children:[e.jsx(sh,{date:k}),e.jsx("div",{className:"px-0 divide-y divide-slate-200/80 dark:divide-slate-800/80",children:E.map(S=>{const M=S.threadId||S.id,A=w.get(M)??0,Y=A>1?A-1:0;return e.jsx("div",{[I]:S.id,className:"w-full",style:{height:"auto",minHeight:"auto"},children:s?s(S,Y):e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Message: ",S.content]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Thread count: ",Y]})]})},S.id)})})]},k)})}),e.jsx("div",{className:"absolute bottom-4 right-4 z-20 pointer-events-none",children:e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[d&&e.jsx("div",{className:"pointer-events-auto",children:e.jsx(ta,{onClick:u,ariaLabel:"Show composer",children:e.jsx($t,{className:"h-4 w-4"})})}),e.jsx("div",{className:"pointer-events-auto",children:e.jsx(ta,{onClick:()=>{ce.logAIAssistantOpen("",dr.BUTTON),c()},isVisible:!l,ariaLabel:"Open AI Assistant",children:e.jsx(Fe,{className:"h-4 w-4"})})}),e.jsx("div",{className:"pointer-events-auto",children:e.jsx(Wu,{onClick:()=>{ce.logScrollToBottom("",n.length),x({behavior:"smooth"})},isVisible:p})})]})}),e.jsx("div",{className:`pointer-events-none absolute left-1/2 -translate-x-1/2 z-20 transition-all duration-150 ${b?"opacity-100 translate-y-0":"opacity-0 translate-y-1"}`,style:{bottom:"calc(env(safe-area-inset-bottom, 0px) + var(--collapse-float-offset, 8px))"},children:b&&e.jsx("div",{className:"pointer-events-auto",children:e.jsxs(N,{size:"sm",variant:"secondary",className:"h-8 rounded-full px-2.5 shadow-lg flex items-center gap-1 hover:bg-secondary",onClick:y,"aria-label":"Collapse current",children:[e.jsx(Pt,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs leading-none",children:"Collapse"})]})})})]})}),ah=()=>{const{addChannel:s}=T(),t=async()=>{try{await s({name:"My First Space",emoji:"🚀",description:"Start your journey here"})}catch(a){console.error("Failed to create first channel:",a)}};return e.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:e.jsxs("div",{className:"max-w-2xl w-full space-y-8",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto shadow-lg",children:e.jsx(et,{className:"w-10 h-10 text-white"})}),e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Welcome to StillRoot"}),e.jsx("p",{className:"text-lg text-muted-foreground max-w-lg mx-auto",children:"Your personal space for thoughts, ideas, and AI-powered conversations. Let's create your first thought space to get started."})]}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-6",children:[e.jsxs(We,{className:"text-center",children:[e.jsxs(jt,{className:"pb-3",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center mx-auto mb-2",children:e.jsx(Ee,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"})}),e.jsx(Nt,{className:"text-base",children:"Organize Thoughts"})]}),e.jsx(kt,{children:e.jsx(Ct,{className:"text-sm",children:"Create dedicated spaces for different topics and organize your thoughts systematically."})})]}),e.jsxs(We,{className:"text-center",children:[e.jsxs(jt,{className:"pb-3",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center mx-auto mb-2",children:e.jsx(Fe,{className:"w-6 h-6 text-green-600 dark:text-green-400"})}),e.jsx(Nt,{className:"text-base",children:"AI Assistant"})]}),e.jsx(kt,{children:e.jsx(Ct,{className:"text-sm",children:"Get help from AI to explore ideas, answer questions, and enhance your thinking process."})})]}),e.jsxs(We,{className:"text-center",children:[e.jsxs(jt,{className:"pb-3",children:[e.jsx("div",{className:"w-12 h-12 bg-purple-100 dark:bg-purple-900/20 rounded-lg flex items-center justify-center mx-auto mb-2",children:e.jsx(lt,{className:"w-6 h-6 text-purple-600 dark:text-purple-400"})}),e.jsx(Nt,{className:"text-base",children:"Spark Ideas"})]}),e.jsx(kt,{children:e.jsx(Ct,{className:"text-sm",children:"Capture inspiration, brainstorm solutions, and develop your creative potential."})})]})]}),e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs(N,{onClick:t,size:"lg",className:"bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white shadow-lg",children:[e.jsx(ae,{className:"w-5 h-5 mr-2"}),"Create Your First Space"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"You can always create more spaces later from the sidebar"})]})]})})},Ur=s=>h.useMemo(()=>{if(!s||s.length===0)return{};const t={};s.forEach(r=>{const o=new Date(r.timestamp).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"});t[o]||(t[o]=[]),t[o].push(r)}),Object.keys(t).forEach(r=>{t[r].sort((o,i)=>new Date(o.timestamp).getTime()-new Date(i.timestamp).getTime())});const a=Object.keys(t).sort((r,o)=>{const i=new Date(t[r][0]?.timestamp||0),l=new Date(t[o][0]?.timestamp||0);return i.getTime()-l.getTime()}),n={};return a.forEach(r=>{n[r]=t[r]}),n},[s]),Fr=({onTrigger:s,canTrigger:t,threshold:a=.2,getState:n})=>({handleScroll:h.useCallback(o=>{if(!t||!n().hasMore||n().loading||n().loadingMore)return;const{scrollTop:i,scrollHeight:l,clientHeight:c}=o.currentTarget;i/(l-c)<a&&s()},[t,n,a,s])}),zr=()=>h.useMemo(()=>new De,[]),nh=h.forwardRef(({renderThoughtRecord:s,className:t=""},a)=>{const{currentChannelId:n}=O();console.log("🔔 [TimelineContent] currentChannelId",n);const r=zr(),{messages:o,loading:i,hasMore:l,loadMore:c,getChannelState:d}=mt({onHistoryMessagesChange:x=>{r.emit(x)}});console.log("🔔 [TimelineContent] messages",o);const{handleScroll:u}=Fr({onTrigger:()=>n&&c({channelId:n,messagesLimit:20}),canTrigger:!!l&&!i,getState:d}),m=Ur(o);return n?i?e.jsx(Pr,{count:5}):e.jsx("div",{className:`flex-1 flex flex-col min-h-0 relative ${t}`,children:o&&e.jsx($r,{ref:a,renderThoughtRecord:s,groupedMessages:m,messages:o,onScroll:u,onHistoryMessagesLoadedEvent$:r})}):e.jsx(ah,{})}),sa=de(s=>({open:!1,setOpen:t=>s({open:t})})),gs=()=>sa.getState().setOpen(!0),rh=[{id:"gradient-1",name:"Ocean Breeze",type:"gradient",value:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",preview:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"},{id:"gradient-2",name:"Sunset Glow",type:"gradient",value:"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",preview:"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"},{id:"gradient-3",name:"Forest Mist",type:"gradient",value:"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",preview:"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"},{id:"gradient-4",name:"Warm Sand",type:"gradient",value:"linear-gradient(135deg, #fa709a 0%, #fee140 100%)",preview:"linear-gradient(135deg, #fa709a 0%, #fee140 100%)"},{id:"gradient-5",name:"Purple Haze",type:"gradient",value:"linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",preview:"linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)"},{id:"gradient-6",name:"Midnight Sky",type:"gradient",value:"linear-gradient(135deg, #2c3e50 0%, #3498db 100%)",preview:"linear-gradient(135deg, #2c3e50 0%, #3498db 100%)"}],oh=[{id:"color-1",name:"Soft Blue",type:"color",value:"#e3f2fd",preview:"#e3f2fd"},{id:"color-2",name:"Warm Gray",type:"color",value:"#f5f5f5",preview:"#f5f5f5"},{id:"color-3",name:"Mint Green",type:"color",value:"#e8f5e8",preview:"#e8f5e8"},{id:"color-4",name:"Lavender",type:"color",value:"#f3e5f5",preview:"#f3e5f5"},{id:"color-5",name:"Peach",type:"color",value:"#fff3e0",preview:"#fff3e0"},{id:"color-6",name:"Rose",type:"color",value:"#fce4ec",preview:"#fce4ec"}],ih=(s=6)=>{const t=[],a=new Set;for(;t.length<s;){const n=Math.floor(Math.random()*1e3)+1;a.has(n)||(a.add(n),t.push({id:`random-${n}`,name:`Image ${t.length+1}`,type:"image",value:`https://picsum.photos/id/${n}/800/400`,preview:`https://picsum.photos/id/${n}/100/100`}))}return t},lh=({currentBackground:s,onBackgroundSelect:t})=>{const a=n=>s===n.value;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Gradients"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:rh.map(n=>e.jsx("button",{onClick:r=>{r.preventDefault(),r.stopPropagation(),t(n)},className:`relative aspect-square rounded-lg border-2 transition-all duration-200 hover:scale-105 cursor-pointer ${a(n)?"border-primary":"border-border hover:border-primary/50"}`,style:{background:n.preview},title:n.name,children:a(n)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 rounded-lg",children:e.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})},n.id))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Solid Colors"}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:oh.map(n=>e.jsx("button",{onClick:r=>{r.preventDefault(),r.stopPropagation(),t(n)},className:`relative aspect-square rounded-lg border-2 transition-all duration-200 hover:scale-105 cursor-pointer ${a(n)?"border-primary":"border-border hover:border-primary/50"}`,style:{background:n.preview},title:n.name,children:a(n)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 rounded-lg",children:e.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})},n.id))})]})]})},ch=({currentBackground:s,onBackgroundSelect:t})=>{const[a,n]=h.useState(""),[r,o]=h.useState([]),[i,l]=h.useState(!1),c=p=>s===p.value,d=async()=>{l(!0);try{const p=ih(6);o(p)}finally{l(!1)}},u=()=>{d()},m=()=>{if(!a.trim())return;const p={id:`custom-${Date.now()}`,name:"Custom Image",type:"image",value:a.trim(),preview:a.trim()};t(p),n("")},x=p=>{try{return new URL(p),p.match(/\.(jpg|jpeg|png|gif|webp|svg)(\?.*)?$/i)}catch{return!1}};return h.useEffect(()=>{d()},[]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground",children:"Random Images"}),e.jsx(N,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:u,disabled:i,children:i?e.jsx(ze,{className:"h-3 w-3 animate-spin"}):e.jsx(as,{className:"h-3 w-3"})})]}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:i?Array.from({length:6}).map((p,g)=>e.jsx("div",{className:"aspect-square rounded-lg border-2 border-border bg-muted animate-pulse"},g)):r.map(p=>e.jsxs("button",{onClick:g=>{g.preventDefault(),g.stopPropagation(),t(p)},className:`relative aspect-square rounded-lg border-2 transition-all duration-200 hover:scale-105 cursor-pointer overflow-hidden ${c(p)?"border-primary":"border-border hover:border-primary/50"}`,title:p.name,children:[e.jsx("img",{src:p.preview,alt:p.name,className:"w-full h-full object-cover",onError:g=>{const f=g.target;f.style.display="none"}}),c(p)&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20 rounded-lg",children:e.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})})]},p.id))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Custom Image URL"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ye,{type:"url",placeholder:"Enter image URL (jpg, png, gif, webp, svg)",value:a,onChange:p=>n(p.target.value),className:"text-xs"}),e.jsxs(N,{variant:"outline",size:"sm",className:"w-full",onClick:m,disabled:!a.trim()||!x(a),children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"Add Image"]}),a&&!x(a)&&e.jsx("p",{className:"text-xs text-destructive",children:"Please enter a valid image URL"})]})]})]})};function cn({currentBackground:s,onBackgroundChange:t,onRemoveBackground:a,buttonClassName:n="h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105"}){const[r,o]=h.useState(!1),[i,l]=h.useState("colors"),[c,d]=h.useState(s),u=h.useRef(!1);h.useEffect(()=>{u.current=r},[r]);const m=g=>{g&&d(s),o(g)},x=g=>{g.type==="gradient"||g.type==="color"?t({type:"color",value:g.value}):g.type==="image"&&t({type:"image",value:g.value})},p=()=>{c?(console.log("🎨 [BackgroundSwitcher] Resetting background to:",{originalBackground:c}),t({type:c.type,value:c.value||""})):a()};return e.jsxs(P,{open:r,onOpenChange:m,children:[e.jsx(P.Trigger,{asChild:!0,children:e.jsx(N,{variant:"ghost",size:"sm",className:n,title:"Change background",children:e.jsx(As,{className:"h-4 w-4"})})}),e.jsxs(P.Content,{width:"w-80",align:"center",side:"bottom",onInteractOutside:g=>{g.preventDefault()},children:[e.jsxs(P.Header,{children:[e.jsx(As,{className:"w-4 h-4 text-primary/80"}),e.jsx("div",{className:"text-sm font-semibold text-foreground/90",children:"Background"}),e.jsx(P.Button,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:()=>o(!1),title:"Close",children:e.jsx(Z,{className:"h-3 w-3"})})]}),e.jsxs(P.Body,{children:[e.jsxs("div",{className:"flex space-x-1 mb-4",children:[e.jsxs(P.Button,{variant:i==="colors"?"default":"outline",size:"sm",className:"flex-1",onClick:()=>l("colors"),children:[e.jsx(As,{className:"h-4 w-4 mr-2"}),"Colors"]}),e.jsxs(P.Button,{variant:i==="images"?"default":"outline",size:"sm",className:"flex-1",onClick:()=>l("images"),children:[e.jsx(is,{className:"h-4 w-4 mr-2"}),"Images"]})]}),e.jsx("div",{className:"max-h-64 overflow-y-auto",children:i==="colors"?e.jsx(lh,{currentBackground:s?.value,onBackgroundSelect:x}):e.jsx(ch,{currentBackground:s?.value,onBackgroundSelect:x})}),e.jsx("div",{className:"mt-4 pt-3 border-t border-border",children:e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Choose a background to personalize your channel"}),e.jsx("div",{className:"flex justify-center",children:e.jsx(P.Button,{variant:"outline",size:"sm",className:"h-6 px-3 text-xs",onClick:p,title:"Reset to original background",children:"Reset"})})]})})]})]})]})}const dh=({currentChannel:s,channels:t,onChannelSelect:a,className:n=""})=>e.jsx("div",{className:n,children:e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsxs("div",{className:"flex items-center space-x-1.5 min-w-0",children:[s.emoji&&e.jsx("div",{className:"text-lg flex-shrink-0",children:s.emoji}),e.jsxs("div",{className:"flex items-center space-x-1.5 min-w-0",children:[e.jsx("h1",{className:"text-lg font-semibold text-muted-foreground truncate",children:s.name}),e.jsx(oe,{variant:"secondary",className:"text-xs flex-shrink-0 text-muted-foreground",children:s.messageCount})]}),e.jsx(we,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]})}),e.jsx(ht,{className:"w-72 max-h-80 overflow-y-auto",align:"start",sideOffset:8,children:t.map(r=>e.jsxs(Ns,{onClick:()=>a(r.id),className:`flex items-center space-x-3 p-3 cursor-pointer transition-all duration-200 ${r.id===s.id?"bg-accent text-accent-foreground":"hover:bg-accent/50"}`,children:[e.jsx("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0",children:r.emoji?e.jsx("span",{className:"text-lg",children:r.emoji}):gr(r.id)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"font-medium truncate",children:r.name}),e.jsx(oe,{variant:"secondary",className:"text-xs flex-shrink-0",children:r.messageCount})]}),r.description&&e.jsx("div",{className:"text-xs text-muted-foreground line-clamp-1 mt-1",children:r.description})]}),r.id===s.id&&e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary flex-shrink-0"})]},r.id))})]})}),uh=s=>{let t=0;for(let a=0;a<s.length;a++)t=t*31+s.charCodeAt(a);return Math.abs(t)},hh=s=>({background:`url(https://picsum.photos/800/400?random=${s%100+1})`,isImage:!0}),mh=s=>{if(s.backgroundImage)return{background:`url(${s.backgroundImage})`,isImage:!0};if(s.backgroundColor)return{background:s.backgroundColor,isImage:!1};const t=uh(s.id);return hh(t)},gh=({channel:s,onOpenSettings:t,className:a="",defaultCollapsed:n=!1})=>{const[r,o]=h.useState(!1),i=h.useRef(null),l=re(h.useCallback(A=>A.notifyLayoutChange,[])),c=$e(h.useCallback(A=>A.setTimelineCoverCollapsed,[])),d=$e(h.useCallback(A=>A.timelineCoverCollapsed??n,[n])),u=$e(h.useCallback(A=>A.isLeftSidebarCollapsed,[])),m=$e(h.useCallback(A=>A.setLeftSidebarCollapsed,[])),{updateChannel:x,channels:p,addChannel:g}=T(),{setCurrentChannel:f}=O(),{background:b,isImage:v}=mh(s),y=b.includes("gradient"),I=()=>v?{backgroundImage:b,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"}:y?{background:b}:{backgroundColor:b},C=()=>{if(r)return;o(!0),c(!d),l(),setTimeout(()=>{o(!1),l()},300)},w=()=>{m(!1)},k=async({type:A,value:Y})=>{try{A==="color"?await x(s.id,{backgroundColor:Y,backgroundImage:void 0}):A==="image"&&await x(s.id,{backgroundImage:Y,backgroundColor:void 0})}catch(L){console.error("Failed to update channel background:",L)}},R=A=>{g(A)},E=async()=>{try{await x(s.id,{backgroundColor:void 0,backgroundImage:void 0})}catch(A){console.error("Failed to remove channel background:",A)}},S=e.jsxs("div",{className:"flex items-center space-x-2 min-w-0 w-full max-w-full overflow-hidden",children:[u&&e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"ghost",size:"sm",onClick:w,className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105 flex-shrink-0 animate-in fade-in slide-in-from-left-2 duration-300",title:"Expand sidebar",children:e.jsx(rs,{className:"h-4 w-4"})}),e.jsx(Lt,{onAddChannel:R,trigger:e.jsx(N,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105 flex-shrink-0",title:"New space","aria-label":"New space",children:e.jsx(ae,{className:"h-4 w-4"})})})]}),u?e.jsx(dh,{currentChannel:s,channels:p,onChannelSelect:f,className:"flex-1 min-w-0 max-w-full"}):e.jsxs(e.Fragment,{children:[s.emoji&&e.jsx("div",{className:"text-lg flex-shrink-0 transition-all duration-300 ease-out",children:s.emoji}),e.jsxs("div",{className:"flex items-center space-x-1.5 min-w-0 flex-1 max-w-full overflow-hidden",children:[e.jsx("h1",{className:"text-lg font-semibold text-muted-foreground truncate transition-all duration-300 ease-out min-w-0",children:s.name}),e.jsx(oe,{variant:"secondary",className:"text-xs flex-shrink-0 transition-all duration-300 ease-out text-muted-foreground",children:s.messageCount})]})]})]}),M=e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative z-10 flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2 min-w-0 flex-1",children:[u&&e.jsxs(e.Fragment,{children:[e.jsx(N,{variant:"ghost",size:"sm",onClick:w,className:"h-8 w-8 p-0 text-white/80 hover:text-white hover:bg-white/20 transition-all duration-200 hover:scale-105 flex-shrink-0 animate-in fade-in slide-in-from-left-2 duration-300",title:"Expand sidebar",children:e.jsx(rs,{className:"h-4 w-4"})}),e.jsx(Lt,{onAddChannel:R,trigger:e.jsx(N,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-white hover:bg-white/20 transition-all duration-200 hover:scale-105 flex-shrink-0",title:"New space","aria-label":"New space",children:e.jsx(ae,{className:"h-4 w-4"})})})]}),s.emoji&&e.jsx("div",{className:"text-4xl drop-shadow-lg flex-shrink-0 transition-all duration-300 ease-out",children:s.emoji}),e.jsxs("div",{className:"flex-1 min-w-0 ml-3",children:[e.jsx("h1",{className:"text-3xl font-bold text-white drop-shadow-lg truncate transition-all duration-300 ease-out min-w-0",children:s.name}),s.description&&e.jsx("p",{className:"text-white/90 text-sm mt-1.5 drop-shadow-md line-clamp-2 transition-all duration-300 ease-out",children:s.description})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-4 flex-shrink-0",children:[e.jsx(N,{variant:"ghost",size:"sm",className:"text-white hover:bg-white/20 transition-all duration-200 hover:scale-105",onClick:()=>gs(),title:"Search",children:e.jsx(Ce,{className:"h-4 w-4"})}),se().channel.settings.enabled,e.jsx(cn,{currentBackground:{type:s.backgroundColor?"color":"image",value:s.backgroundColor||s.backgroundImage},onBackgroundChange:k,onRemoveBackground:E,buttonClassName:"h-8 w-8 p-0 text-white hover:text-white hover:bg-white/20 transition-all duration-200 hover:scale-105"}),e.jsx(N,{variant:"ghost",size:"sm",className:"text-white hover:bg-white/20 transition-all duration-200 hover:scale-105",onClick:C,children:e.jsx(Pt,{className:"h-4 w-4 transition-transform duration-200"})})]})]}),e.jsxs("div",{className:"relative z-10 flex items-center justify-between mt-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(oe,{variant:"secondary",className:"bg-white/25 text-white border-white/40 backdrop-blur-sm transition-all duration-300 ease-out",children:[e.jsx(it,{className:"h-3 w-3 mr-1.5"}),e.jsx("span",{className:"font-medium",children:s.messageCount}),e.jsx("span",{className:"ml-1 text-xs opacity-90",children:"messages"})]}),s.lastMessageTime&&e.jsxs(oe,{variant:"secondary",className:"bg-white/25 text-white border-white/40 backdrop-blur-sm transition-all duration-300 ease-out",children:[e.jsx(ia,{className:"h-3 w-3 mr-1.5"}),e.jsx("span",{className:"text-xs",children:new Date(s.lastMessageTime).toLocaleDateString()})]})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs(N,{variant:"secondary",size:"sm",className:"bg-white/25 text-white border-white/40 hover:bg-white/35 backdrop-blur-sm transition-all duration-200 hover:scale-105",onClick:()=>ve.requestOpenAIAssistant$.emit({channelId:s.id}),children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"font-medium",children:"AI Assistant"})]})})]})]});return e.jsx("div",{ref:i,className:j("relative w-full overflow-hidden transition-all duration-300 ease-out",d?"h-12":"h-52",d?"flex items-center justify-between px-4":"",a),style:d?{}:I(),children:d?e.jsxs(e.Fragment,{children:[S,e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(N,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105",onClick:()=>gs(),title:"Search",children:e.jsx(Ce,{className:"h-4 w-4"})}),e.jsx(N,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105",onClick:()=>ve.requestOpenAIAssistant$.emit({channelId:s.id}),children:e.jsx(Fe,{className:"h-4 w-4"})}),e.jsx(cn,{currentBackground:{type:s.backgroundColor?"color":"image",value:s.backgroundColor||s.backgroundImage},onBackgroundChange:k,onRemoveBackground:E}),se().channel.settings.enabled,e.jsx(N,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-muted-foreground hover:text-foreground hover:bg-accent transition-all duration-200 hover:scale-105",onClick:C,children:e.jsx(we,{className:"h-4 w-4 transition-transform duration-200"})})]})]}):e.jsxs("div",{className:"relative w-full h-full flex flex-col justify-between p-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-black/10 via-black/20 to-black/30 z-0"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-transparent to-black/10 z-0"}),M]})})},ph=({content:s,actions:t,channel:a,onOpenSettings:n,className:r=""})=>e.jsxs("div",{"data-component":"timeline-container",className:`relative flex-1 flex flex-col h-full ${r}`,children:[a&&e.jsx(gh,{channel:a,onOpenSettings:n}),e.jsx("div",{className:"flex-1 flex flex-col min-h-0",children:s}),t]}),Br=()=>{const[s,t]=h.useState(null);return{replyToMessageId:s,handleSend:()=>{t(null)},handleCancelReply:()=>{t(null)},setReplyToMessageId:t}},xh=()=>{const s=Br();return{chatActions:h.useMemo(()=>({replyToMessageId:s.replyToMessageId,handleSend:s.handleSend,handleCancelReply:s.handleCancelReply}),[s.replyToMessageId,s.handleSend,s.handleCancelReply])}};function fh(){const{channels:s}=T(),{currentChannelId:t}=O();return s.find(a=>a.id===t)||null}class bh{docs=new Map;byChannelCount=new Map;indexNotes(t){this.docs.clear(),this.byChannelCount.clear();for(const a of t)a.isDeleted||(this.docs.set(a.id,a),this.byChannelCount.set(a.channelId,(this.byChannelCount.get(a.channelId)||0)+1))}upsertNote(t){const a=this.docs.get(t.id);if(!t.isDeleted)this.docs.set(t.id,t),a||this.byChannelCount.set(t.channelId,(this.byChannelCount.get(t.channelId)||0)+1);else if(this.docs.delete(t.id),a){const n=(this.byChannelCount.get(a.channelId)||1)-1;n>0?this.byChannelCount.set(a.channelId,n):this.byChannelCount.delete(a.channelId)}}upsertNotes(t){for(const a of t)this.upsertNote(a)}search(t,a){const n=(t||"").trim().toLowerCase();if(!n)return[];const r=a?.channelIds?new Set(a.channelIds):null,o=[];for(const i of this.docs.values()){if(r&&!r.has(i.channelId))continue;const l=this.scoreNote(i,n);l.score>0&&o.push(l)}return o.sort((i,l)=>l.score-i.score||l.timestamp.getTime()-i.timestamp.getTime()),a?.limit?o.slice(0,a.limit):o}getChannelDocCount(t){return this.byChannelCount.get(t)||0}getIndexedChannelIds(){return Array.from(this.byChannelCount.keys())}getTotalDocs(){return this.docs.size}scoreNote(t,a){const n=[];let r=0;const o=(t.content||"").toLowerCase(),i=this.countOccurrences(o,a);i>0&&(n.push("content"),r+=i*10);const c=(t.tags||[]).map(p=>p.toLowerCase()).filter(p=>p.includes(a)).length;c>0&&(n.push("tags"),r+=c*6);const u=(t.aiAnalysis?.keywords||[]).map(p=>p.toLowerCase()).filter(p=>p.includes(a)).length;u>0&&(n.push("keywords"),r+=u*5);const m=(t.aiAnalysis?.summary||"").toLowerCase(),x=this.countOccurrences(m,a);return x>0&&(n.push("summary"),r+=x*3),{id:t.id,channelId:t.channelId,score:r,snippet:this.buildSnippet(t.content,a),matchedFields:n,timestamp:t.timestamp}}countOccurrences(t,a){if(!t||!a)return 0;let n=0,r=0;for(;(r=t.indexOf(a,r))!==-1;)n++,r+=a.length;return n}buildSnippet(t,a){const n=t||"",o=n.toLowerCase().indexOf(a);if(o===-1)return;const i=Math.max(0,o-30),l=Math.min(n.length,o+a.length+30),c=n.slice(i,l),d=i>0?"…":"",u=l<n.length?"…":"";return d+c+u}}const Ps={limits:{maxResults:50},ui:{debounceMs:150,minQueryLength:1}};class vh{searchIndex;searchQuery$=new _e("");searchFilters$=new _e({});indexStats$=new _e({totalDocs:0,indexedChannelIds:[]});indexedDataHash="";isIndexing=!1;constructor(){this.searchIndex=new bh,this.initializeIndex()}search(t,a){return this.searchQuery$.next(t),a&&this.searchFilters$.next(a),Ln([be.getNotes(this.searchFilters$.value),this.searchQuery$.pipe(Bs(Ps.ui.debounceMs),fs())]).pipe(qe(([n,r])=>!r||r.trim().length<Ps.ui.minQueryLength?[]:(this.updateIndexIfNeeded(n),this.searchIndex.search(r,{channelIds:this.searchFilters$.value.channelIds,limit:Ps.limits.maxResults}))))}async updateAllData(){await be.updateAll()}async updateChannelData(t){await be.updateChannel(t)}async preIndexData(){if(!this.isIndexing){this.isIndexing=!0;try{const t=await wt(be.getNotes());t&&(this.searchIndex.indexNotes(t),this.indexedDataHash=this.calculateDataHash(t),this.updateIndexStats())}finally{this.isIndexing=!1}}}async preIndexChannel(t){if(!this.isIndexing){this.isIndexing=!0;try{const a=await wt(be.getNotes({channelIds:[t]}));if(a){this.searchIndex.upsertNotes(a);const n=await wt(be.getNotes());this.indexedDataHash=this.calculateDataHash(n),this.updateIndexStats()}}finally{this.isIndexing=!1}}}getIndexStats(){return{totalDocs:this.searchIndex.getTotalDocs(),indexedChannelIds:this.searchIndex.getIndexedChannelIds()}}getIndexStats$(){return this.indexStats$.asObservable()}initializeIndex(){be.getNotes().subscribe(t=>{this.updateIndexIfNeeded(t);const a=this.getIndexStats();typeof window<"u"&&console.debug("[NoteSearchService] notes updated, index stats",a)})}updateIndexIfNeeded(t){const a=this.calculateDataHash(t);a!==this.indexedDataHash&&(this.searchIndex.indexNotes(t),this.indexedDataHash=a,this.updateIndexStats())}updateIndexStats(){this.indexStats$.next({totalDocs:this.searchIndex.getTotalDocs(),indexedChannelIds:this.searchIndex.getIndexedChannelIds()})}calculateDataHash(t){const a=JSON.stringify(t.map(r=>{const o=r;return{id:o.id,content:o.content,tags:o.tags,aiAnalysis:o.aiAnalysis,timestamp:o.timestamp}}));let n=0;for(let r=0;r<a.length;r++){const o=a.charCodeAt(r);n=(n<<5)-n+o,n=n&n}return n.toString()}}const Se=new vh;function dn(s,t){const[a,n]=h.useState(t),r=h.useMemo(()=>typeof s=="function"?s():s,[s]);return h.useEffect(()=>{const o=r.subscribe(n);return()=>o.unsubscribe()},[r]),a}function Hr(){const s=sa(S=>S.open),t=sa(S=>S.setOpen),{currentChannelId:a}=O(),n=T(S=>S.channels),[r,o]=h.useState(""),[i,l]=h.useState("current"),[c,d]=h.useState([]),[u,m]=h.useState(!1),[x,p]=h.useState(0),[g,f]=h.useState(!1),b=h.useRef(null),v=h.useRef(null),y=h.useMemo(()=>i==="current"&&a?[a]:void 0,[i,a]);h.useEffect(()=>{s&&setTimeout(()=>b.current?.focus(),0),s||(o(""),d([]),m(!1),p(0))},[s]),h.useEffect(()=>{let S=!1;return(async()=>s&&i==="all"&&(m(!0),await Se.updateAllData(),await Se.preIndexData(),S||m(!1)))(),()=>{S=!0}},[s,i]),h.useEffect(()=>{let S=!1;return(async()=>{if(!s||i!=="current"||!a)return;console.debug("[QuickSearch] current scope pre-index start",{currentChannelId:a}),m(!0),await Se.updateChannelData(a),await Se.preIndexChannel(a);const M=Se.getIndexStats();console.debug("[QuickSearch] current scope pre-index done",{stats:M}),S||m(!1)})(),()=>{S=!0}},[s,i,a]),h.useEffect(()=>{if(!s)return;const S=M=>{if(M.key==="Escape"){M.preventDefault(),t(!1);return}if(M.key==="ArrowDown"){M.preventDefault(),p(A=>Math.min(A+1,Math.max(0,c.length-1)));return}if(M.key==="ArrowUp"){M.preventDefault(),p(A=>Math.max(0,A-1));return}if(M.key==="Tab"){M.preventDefault(),l(A=>A==="current"?"all":"current");return}if(M.key==="Enter"&&c[x]){M.preventDefault();const A=c[x];R(A.id,A.channelId)}};return window.addEventListener("keydown",S),()=>window.removeEventListener("keydown",S)},[s,c,x]),h.useEffect(()=>{if(!s)return;let S=0,M=0,A=!1;const Y=V=>{S=V.touches[0].clientY,M=V.touches[0].clientX,A=!1},L=V=>{if(!A){const ne=Math.abs(V.touches[0].clientY-S),J=Math.abs(V.touches[0].clientX-M);A=J>ne&&J>10}},Ae=V=>{if(A){const ne=V.changedTouches[0].clientX-M;Math.abs(ne)>50&&(V.preventDefault(),l(J=>J==="current"?"all":"current"))}};return document.addEventListener("touchstart",Y,{passive:!0}),document.addEventListener("touchmove",L,{passive:!0}),document.addEventListener("touchend",Ae,{passive:!1}),()=>{document.removeEventListener("touchstart",Y),document.removeEventListener("touchmove",L),document.removeEventListener("touchend",Ae)}},[s]);const I=dn(Se.getIndexStats$(),{totalDocs:0,indexedChannelIds:[]}),C=h.useMemo(()=>Se.search(r,{channelIds:y}),[r,y]),w=dn(C,[]);h.useEffect(()=>{d(w),p(0),r&&console.debug("[QuickSearch] search results",{q:r,scope:i,channelIds:y,count:w.length})},[w,r,i,y]),h.useEffect(()=>{const S=c[x]?.id;if(!S)return;document.getElementById(S)?.scrollIntoView({block:"nearest"})},[x,c]);const k=S=>n.find(M=>M.id===S)?.name||S,R=(S,M)=>{t(!1),ve.requestJumpToMessage$.emit({channelId:M,messageId:S})},E=async()=>{if(!g){f(!0);try{await Se.updateAllData(),await Se.preIndexData()}finally{f(!1)}}};return e.jsx(Be,{open:s,onOpenChange:S=>{S||t(!1)},children:e.jsxs(He,{showCloseButton:!1,className:"flex flex-col p-0 w-screen max-w-none h-svh top-0 left-0 translate-y-0 translate-x-0 rounded-none border-0 sm:rounded-lg sm:h-auto sm:w-[96vw] sm:max-w-2xl sm:top-[8vh] sm:left-1/2 sm:translate-y-0 sm:translate-x-[-50%] sm:max-h-[80vh]",children:[e.jsxs("div",{className:"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b",children:[e.jsx("div",{className:"h-[env(safe-area-inset-top)] sm:hidden"}),e.jsxs("div",{className:"px-4 py-3 sm:px-6 sm:py-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ce,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ye,{ref:b,placeholder:i==="current"?"Search current space…":"Search all spaces…",value:r,onChange:S=>o(S.target.value),className:"pl-10 pr-10 h-10 text-sm sm:h-9 sm:text-sm w-full"}),r&&e.jsx("button",{className:"absolute right-3 top-1/2 -translate-y-1/2 h-6 w-6 inline-flex items-center justify-center rounded-md hover:bg-accent text-muted-foreground transition-colors",onClick:()=>o(""),children:e.jsx(Z,{className:"h-4 w-4"})})]}),e.jsx("button",{className:"text-sm font-medium text-muted-foreground hover:text-foreground transition-colors",onClick:()=>t(!1),children:"Exit"})]}),e.jsxs("div",{className:"mt-2 flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:i==="all"?e.jsxs("span",{children:[e.jsx("span",{className:"inline-block w-2 h-2 mr-2 align-middle rounded-full bg-primary animate-pulse"}),u?"Indexing all spaces… ":"Indexed: ",I.totalDocs," docs in ",I.indexedChannelIds.length," spaces"]}):e.jsxs("span",{className:"text-muted-foreground/90",children:["Searching in"," ",e.jsx("span",{className:"font-medium text-foreground",children:k(a||"")||"current space"})]})}),e.jsx("div",{className:"shrink-0",children:e.jsxs("div",{role:"radiogroup","aria-label":"Search scope",className:"inline-flex items-center rounded-md border bg-muted p-0.5",children:[e.jsx("button",{role:"radio","aria-checked":i==="current",className:`px-3 py-1.5 text-xs rounded-sm transition-all duration-200 ${i==="current"?"bg-background shadow-sm text-foreground font-medium":"text-muted-foreground hover:text-foreground"}`,onClick:()=>l("current"),children:"Current"}),e.jsx("button",{role:"radio","aria-checked":i==="all",className:`px-3 py-1.5 text-xs rounded-sm transition-all duration-200 ${i==="all"?"bg-background shadow-sm text-foreground font-medium":"text-muted-foreground hover:text-foreground"}`,onClick:()=>l("all"),children:"All"})]})})]})]})]}),e.jsx("div",{ref:v,className:"flex-1 overflow-y-auto overscroll-contain flex flex-col",role:"listbox","aria-activedescendant":c[x]?.id,children:r?c.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center py-16 px-4 text-center",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-muted/50 flex items-center justify-center mb-4",children:e.jsx(Ce,{className:"h-8 w-8 text-muted-foreground/60"})}),e.jsx("p",{className:"text-base font-medium text-foreground mb-2",children:"No matches found"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Try different keywords or search in all spaces"}),e.jsx("button",{onClick:E,disabled:g,className:"text-xs px-3 py-1.5 rounded-md bg-muted hover:bg-muted/80 text-muted-foreground hover:text-foreground transition-colors disabled:opacity-50",children:g?"Refreshing...":"Refresh Search"})]}):e.jsx("div",{className:"flex-1 py-1",children:c.map((S,M)=>e.jsxs("button",{id:S.id,type:"button",role:"option","aria-selected":M===x,className:`w-full text-left px-4 py-4 hover:bg-accent/50 focus:outline-none transition-all duration-200 border-b border-border/30 last:border-b-0 active:scale-[0.98] ${M===x?"bg-accent/60 shadow-sm":""}`,onMouseEnter:()=>p(M),onClick:()=>R(S.id,S.channelId),children:[e.jsxs("div",{className:"flex items-center justify-between gap-3 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx(oe,{variant:"secondary",className:`shrink-0 text-xs transition-colors ${M===x?"bg-primary/10 text-primary border-primary/20":""}`,children:k(S.channelId)}),S.matchedFields.length>0&&e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:S.matchedFields.join(", ")})]}),e.jsx("span",{className:"text-xs text-muted-foreground whitespace-nowrap",children:new Date(S.timestamp).toLocaleDateString()})]}),e.jsx("div",{className:"text-sm text-foreground/90 line-clamp-2 leading-relaxed",children:S.snippet?e.jsx(yh,{text:S.snippet,query:r}):"(no preview)"}),M===x&&e.jsx("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 w-1 h-6 bg-primary rounded-full opacity-60"})]},S.id))}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center py-16 px-4 text-center",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-muted/50 flex items-center justify-center mb-4",children:e.jsx(Ce,{className:"h-8 w-8 text-muted-foreground/60"})}),e.jsx("p",{className:"text-base font-medium text-foreground mb-2",children:"Search your notes"}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:["Type to search across ",i==="current"?"current space":"all spaces"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground/70",children:[e.jsx("span",{className:"w-1 h-1 rounded-full bg-muted-foreground/50"}),e.jsx("span",{children:"Swipe left/right to switch scope"}),e.jsx("span",{className:"w-1 h-1 rounded-full bg-muted-foreground/50"})]})]})}),e.jsx("div",{className:"border-t bg-muted/30 px-4 py-2 sm:px-6",children:e.jsxs("div",{className:"text-xs text-muted-foreground text-center sm:text-left",children:[e.jsx("span",{className:"hidden sm:inline",children:"↑/↓ Select • Enter Open • Esc Close"}),e.jsx("span",{className:"sm:hidden",children:"↑/↓ Select • Enter Open"})]})})]})})}function yh({text:s,query:t}){if(!s||!t)return e.jsx(e.Fragment,{children:s});const a=wh(t);try{const n=new RegExp(`(${a})`,"ig"),r=s.split(n);return e.jsx(e.Fragment,{children:r.map((o,i)=>o.toLowerCase()===t.toLowerCase()?e.jsx("mark",{className:"bg-yellow-200/80 dark:bg-yellow-600/50 text-foreground rounded px-0.5",children:o},i):e.jsx("span",{children:o},i))})}catch{return e.jsx(e.Fragment,{children:s})}}function wh(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function jh(){return h.useEffect(()=>{const s=t=>{(navigator.platform.toUpperCase().includes("MAC")?t.metaKey:t.ctrlKey)&&(t.key==="k"||t.key==="K")&&(t.preventDefault(),gs())};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[]),null}const Nh=({className:s=""})=>{const{chatActions:t}=xh(),a=fh(),n=h.useRef(null),{inputCollapsed:r}=wa(),o=h.useCallback((l,c)=>e.jsx(Uu,{message:l,threadCount:c}),[]),i=()=>{n.current?.scrollToBottom({behavior:"instant"}),t.handleSend()};return e.jsxs("div",{className:`relative w-full h-full ${s}`,children:[e.jsx(ph,{channel:a||void 0,onOpenSettings:()=>ve.requestOpenSettings$.emit({}),content:e.jsxs("div",{className:"flex flex-1 flex-col min-h-0 relative",children:[e.jsx(nh,{ref:n,renderThoughtRecord:o}),e.jsx(Hr,{}),e.jsx(jh,{})]}),actions:a&&!r?e.jsx(Vu,{onSend:i,replyToMessageId:t.replyToMessageId??void 0,onCancelReply:t.handleCancelReply}):null}),e.jsx(fu,{})]})};function Ch(){const{isAIAssistantOpen:s,isThreadOpen:t,currentThreadId:a,openAIAssistant:n,closeAIAssistant:r,openThread:o,closeThread:i,openSettings:l}=Is(),{currentChannelId:c}=O(),d=h.useRef(!1),u=()=>{console.log("Open channel settings"),l()},m=x=>{console.log("Send thread message:",x)};return h.useEffect(()=>ve.requestOpenAIAssistant$.listen(()=>{n()}),[n]),h.useEffect(()=>ve.requestOpenAIConversation$.listen(()=>{n()}),[n]),h.useEffect(()=>ve.requestOpenThread$.listen(({messageId:x})=>{o(x)}),[o]),h.useEffect(()=>ve.requestCloseThread$.listen(()=>{i()}),[i]),h.useEffect(()=>ve.requestOpenSettings$.listen(()=>{u()}),[]),h.useEffect(()=>ve.requestJumpToMessage$.listen(({channelId:x,messageId:p})=>{if(d.current)return;d.current=!0;const g=()=>{const v="search-target-highlight-style";if(document.getElementById(v))return;const y=document.createElement("style");y.id=v,y.textContent=`
                  @keyframes search-target-pulse {
                    0% { background-color: rgba(250, 204, 21, 0.00); outline-color: rgba(245, 158, 11, 0.00); }
                    20% { background-color: rgba(250, 204, 21, 0.32); outline-color: rgba(245, 158, 11, 0.95); }
                    55% { background-color: rgba(250, 204, 21, 0.20); outline-color: rgba(245, 158, 11, 0.50); }
                    100% { background-color: rgba(250, 204, 21, 0.08); outline-color: rgba(245, 158, 11, 0.00); }
                  }
                  .search-target-highlight {
                    outline: 2px solid rgba(245, 158, 11, 0.9); /* amber-500 */
                    background-color: rgba(250, 204, 21, 0.18); /* amber-300 @ ~18% */
                    animation: search-target-pulse 1.5s ease-in-out 2;
                  }
                `,document.head.appendChild(y)},f=v=>{const y=v.getBoundingClientRect(),I=window.innerHeight||document.documentElement.clientHeight,C=window.innerWidth||document.documentElement.clientWidth;return y.top>=0&&y.left>=0&&y.bottom<=I&&y.right<=C},b=(v,y=1200)=>{g();let I=!1;const C=()=>{I||(I=!0,v.classList.add("search-target-highlight"),setTimeout(()=>v.classList.remove("search-target-highlight"),y))};if(f(v)){C();return}if("IntersectionObserver"in window){const w=new IntersectionObserver(k=>{k.find(E=>E.isIntersecting)&&(C(),w.disconnect())},{threshold:.1});w.observe(v),setTimeout(()=>{I||(w.disconnect(),C())},2e3)}else setTimeout(C,300)};(async()=>{try{const{currentChannelId:v}=O.getState();v!==x&&(O.getState().setCurrentChannel(x),await new Promise(R=>setTimeout(R,140)));const y=Dt.messageById(p),I=()=>{const R=document.querySelector(y);return R?(R.scrollIntoView({behavior:"smooth",block:"start"}),b(R,3e3),!0):!1},C=8e3,w=Date.now();let k=0;for(_.requestLoadInitialMessages$.next({channelId:x});Date.now()-w<C;){if(I())return;const R=_.dataContainer.get().messageByChannel[x];if(R?.hasMore&&!R.loadingMore&&k<25){k+=1,await _.loadMoreHistory({channelId:x,messagesLimit:30}),await new Promise(S=>{let M=!1;const A=_.moreMessageLoadedEvent$.listen(Y=>{Y.channelId===x&&!M&&(M=!0,A(),S())});setTimeout(()=>{if(!M){M=!0;try{A()}catch{}S()}},1600)}),await new Promise(S=>setTimeout(S,70));continue}await new Promise(S=>setTimeout(S,160))}console.warn("[JumpToMessage] not found within time budget",{channelId:x,messageId:p})}finally{setTimeout(()=>{d.current=!1},200)}})()}),[]),e.jsx(_c,{sidebar:e.jsx(Tc,{}),content:e.jsx(Nh,{}),rightSidebar:(t||s)&&(t?e.jsx(nu,{isOpen:t,onClose:i,onSendMessage:m,currentThreadId:a||void 0}):e.jsx(au,{isOpen:s,onClose:r,channelId:c||""}))})}const kh=$n({manifest:{id:"notes",name:"Notes Extension",description:"Conversational AI note-taking feature",version:"1.0.0",author:"StillRoot Team",icon:"notebook"},activate:({subscriptions:s})=>{s.push(Pe.from(ga.getState().addIcons({"message-square":it,hash:Ot,plus:ae,notebook:Mn}))),s.push(Pe.from(nt.getState().addItem({id:"notes",label:"Notes",title:"Conversational Notes",group:Mt.MAIN,collapsedLabel:"Notes",icon:"notebook",order:1}))),s.push(Pe.from(js.getState().addRoutes([{id:"notes-main",path:"/notes",element:e.jsx(Ch,{}),order:1},{id:"notes-default",path:"*",element:e.jsx(On,{to:"/notes"}),order:9999}]))),s.push(Pe.from(lr([{activityKey:"notes",routerPath:"/notes"}])))}}),Sh=()=>e.jsx("div",{className:"h-screen flex flex-col",children:e.jsx(lc,{extensions:[kh]})});function Gr(s){return s.sort((t,a)=>(t.order??0)-(a.order??0)).map(t=>e.jsx(Pn,{path:t.path,element:t.element,children:t.children&&Gr(t.children)},t.id))}const Ih=()=>{const s=js(t=>t.routes);return e.jsx(_n,{children:Gr(s)})},Mh=s=>{const{extensions:t}=s,{initialized:a}=Zn({extensions:t});return a?e.jsx("div",{className:"flex flex-col bg-background overflow-hidden",style:{height:"100%"},children:e.jsx("div",{className:"flex-1 min-h-0 overflow-hidden h-full",children:e.jsx(Ih,{})})}):e.jsx("div",{className:"flex items-center justify-center h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("div",{className:"text-muted-foreground",children:"Loading..."})]})})};function Eh(){const{currentChannelId:s}=O(),t=T(d=>d.addThreadMessage),[a,n]=h.useState(!1),[r,o]=h.useState(void 0);return{isThreadOpen:a,currentThreadId:r,handleOpenThread:d=>{o(d),n(!0)},handleCloseThread:()=>{n(!1),o(void 0)},handleSendThreadMessage:d=>{r&&t(r,{content:d,sender:"user",channelId:s||""})}}}const Th=()=>{const{addMessage:s,addThreadMessage:t}=T(),{currentChannelId:a,isAddingMessage:n,setIsAddingMessage:r}=O();return{sendMessage:async(i,l)=>{if(!(!i.trim()||!a))try{return l?await t(l,{content:i.trim(),sender:"user",channelId:a}):await s({content:i.trim(),sender:"user",channelId:a}),r(!0),setTimeout(async()=>{try{l?await t(l,{content:"This is an AI response as an annotation to your message.",sender:"ai",channelId:a}):await s({content:"This is an AI response as an annotation to your content.",sender:"ai",channelId:a})}catch(c){console.error("Failed to add AI response:",c)}finally{r(!1)}},1e3),!0}catch(c){return console.error("Failed to send message:",c),!1}},isAddingMessage:n}},Ah=()=>{const{currentChannelId:s}=O(),{channels:t}=T(),{messages:a,hasMore:n,loadMore:r}=mt({}),o=h.useRef(null),{isSticky:i,scrollToBottom:l}=Or(o,[s,a.length]),{replyToMessageId:c,handleCancelReply:d,setReplyToMessageId:u}=Br(),{isThreadOpen:m,handleOpenThread:x,handleCloseThread:p,handleSendThreadMessage:g}=Eh(),{sendMessage:f,isAddingMessage:b}=Th();return h.useEffect(()=>{const y=()=>{if(!o.current)return;const{scrollTop:C}=o.current;C===0&&n&&s&&r({channelId:s,messagesLimit:20})},I=o.current;if(I)return I.addEventListener("scroll",y),()=>I.removeEventListener("scroll",y)},[n,r,o,s]),{currentChannelId:s,channels:t,messages:a,hasMore:n,isSticky:i,replyToMessageId:c,isThreadOpen:m,isAddingMessage:b,containerRef:o,handleSendMessage:async y=>{requestAnimationFrame(()=>{l({behavior:"instant"})}),f(y,c||void 0),c&&d()},handleCancelReply:d,handleOpenThread:x,handleCloseThread:p,handleSendThreadMessage:g,scrollToBottom:l,setReplyToMessageId:u}},Lh=({currentChannel:s,channels:t,onChannelSelect:a,className:n=""})=>e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(N,{variant:"ghost",className:`h-auto px-2 py-1.5 hover:bg-muted/50 active:bg-muted/70 transition-all duration-200 touch-manipulation min-h-[36px] ${n}`,children:e.jsxs("div",{className:"flex items-center space-x-1.5 min-w-0 max-w-full",children:[s.emoji&&e.jsx("div",{className:"text-base flex-shrink-0",children:s.emoji}),e.jsx("div",{className:"flex items-center min-w-0 flex-1",children:e.jsx("h1",{className:"text-base font-medium text-foreground/90 truncate",children:s.name})}),e.jsx(we,{className:"h-3.5 w-3.5 text-muted-foreground flex-shrink-0"})]})})}),e.jsx(ht,{className:"w-64 max-h-72 overflow-y-auto",align:"center",sideOffset:6,children:t.map(r=>e.jsxs(Ns,{onClick:()=>a(r.id),className:`flex items-center space-x-2 px-3 py-2 cursor-pointer transition-all duration-200 touch-manipulation min-h-[40px] ${r.id===s.id?"bg-accent text-accent-foreground":"hover:bg-accent/50 active:bg-accent/70"}`,children:[e.jsx("div",{className:"w-6 h-6 rounded flex items-center justify-center flex-shrink-0",children:r.emoji?e.jsx("span",{className:"text-sm",children:r.emoji}):e.jsx(Ot,{className:"w-3.5 h-3.5 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate text-sm",children:r.name}),r.description&&e.jsx("div",{className:"text-xs text-muted-foreground line-clamp-1 mt-0.5",children:r.description})]}),r.id===s.id&&e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-primary flex-shrink-0"})]},r.id))})]}),Rh=({currentChannelName:s,currentChannel:t,channels:a})=>{const{openChannelList:n,openAIAssistant:r,openSettings:o}=Is(),{setCurrentChannel:i}=O(),{channels:l}=T(),c=()=>{r()};return e.jsx("div",{className:"flex-shrink-0 px-4 py-2 bg-background",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:n,className:"h-9 w-9 dark:text-primary",title:"Channels","aria-label":"Channels",children:e.jsx(rs,{className:"size-5"})}),e.jsx(Lt,{variant:"dialog",onAddChannel:d=>{T.getState().addChannel(d)},trigger:e.jsx(N,{variant:"ghost",size:"icon",className:"h-9 w-9 dark:text-primary",title:"New space","aria-label":"New space",children:e.jsx(ae,{className:"size-5"})})})]}),e.jsx("div",{className:"flex-1 text-center min-w-0",children:t&&l.length>1?e.jsx(Lh,{currentChannel:t,channels:l,onChannelSelect:i,className:"w-full"}):e.jsx("h1",{className:"text-lg font-semibold text-foreground/90 truncate px-2 max-w-full",children:s||"Chat"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:gs,className:"h-9 w-9 dark:text-primary",title:"Search",children:e.jsx(Ce,{className:"size-5"})}),e.jsx(N,{variant:"ghost",size:"icon",onClick:c,className:"h-9 w-9 dark:text-primary",children:e.jsx(Fe,{className:"size-5"})}),e.jsx(N,{variant:"ghost",size:"lg",onClick:o,className:"h-9 w-9 dark:text-primary",children:e.jsx(oa,{className:"size-5"})})]})]})})},Dh=()=>e.jsxs("div",{className:"flex flex-1 flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4",children:e.jsx(Ee,{className:"w-8 h-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:"No thoughts yet"}),e.jsx("p",{className:"text-muted-foreground max-w-sm",children:"Start your first thought by typing a message below. Your AI assistant will help you explore ideas and insights."})]}),_h=()=>{const{addChannel:s}=T(),t=async()=>{try{await s({name:"My First Space",emoji:"🚀",description:"Start your journey here"})}catch(a){console.error("Failed to create first channel:",a)}};return e.jsx("div",{className:"flex-1 flex items-center justify-center p-6",children:e.jsxs("div",{className:"max-w-sm w-full space-y-6 text-center",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto shadow-lg",children:e.jsx(et,{className:"w-8 h-8 text-white"})}),e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Welcome to StillRoot"}),e.jsx("p",{className:"text-muted-foreground text-sm leading-relaxed",children:"Your personal space for thoughts, ideas, and AI-powered conversations. Create your first thought space to get started."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 text-left",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(Ee,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-foreground",children:"Organize Thoughts"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Create dedicated spaces for different topics"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 text-left",children:[e.jsx("div",{className:"w-8 h-8 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(Fe,{className:"w-4 h-4 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-foreground",children:"AI Assistant"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Get help from AI to explore ideas"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 text-left",children:[e.jsx("div",{className:"w-8 h-8 bg-purple-100 dark:bg-purple-900/20 rounded-lg flex items-center justify-center flex-shrink-0",children:e.jsx(lt,{className:"w-4 h-4 text-purple-600 dark:text-purple-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-foreground",children:"Spark Ideas"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Capture inspiration and brainstorm solutions"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(N,{onClick:t,size:"lg",className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white shadow-lg",children:[e.jsx(ae,{className:"w-5 h-5 mr-2"}),"Create Your First Space"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"You can create more spaces later from the menu"})]})]})})},Ph=h.forwardRef(({onReply:s,className:t=""},a)=>{const{currentChannelId:n}=O(),r=h.useRef(null),o=zr(),{messages:i=[],loading:l,hasMore:c,loadMore:d,getChannelState:u}=mt({onHistoryMessagesChange:f=>{o.emit(f)}}),{handleScroll:m}=Fr({onTrigger:()=>{n&&d({channelId:n,messagesLimit:20})},canTrigger:!!c&&!l,getState:u}),x=Ur(i);h.useImperativeHandle(a,()=>({scrollToBottom:f=>{r.current?.scrollToBottom(f)}}),[r]);const p=(f,b)=>e.jsx(Hh,{message:f,onReply:()=>s(f.id),threadCount:b}),g=Object.values(x).some(f=>f.some(b=>b.sender==="user"&&!b.parentId));return n?l?e.jsx(Pr,{count:5}):g?e.jsx("div",{className:`flex-1 min-h-0 relative overflow-hidden bg-white dark:bg-slate-950 ${t}`,children:e.jsx($r,{ref:r,className:"h-full",renderThoughtRecord:p,groupedMessages:x,messages:i,onScroll:m,onHistoryMessagesLoadedEvent$:o})}):e.jsx(Dh,{}):e.jsx(_h,{})}),Oh=({originalContent:s,onSave:t,onCancel:a,onCollapse:n,isSaving:r})=>{const o=H(x=>x.editContent),i=H(x=>x.updateContent),l=o!==s,c=h.useRef(null);Ss({textareaRef:c,updateContent:i,content:o});const d=x=>{const p=x.target.value;i(p)},u=()=>{l&&t()},m=()=>{l?confirm("You have unsaved changes. Are you sure you want to cancel?")&&a():a()};return e.jsxs("div",{className:"w-full h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border bg-muted/30",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:n,className:"h-8 w-8",children:e.jsx(En,{className:"h-4 w-4"})}),e.jsx("h3",{className:"font-semibold text-foreground",children:"Edit Message"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"ghost",size:"sm",onClick:m,disabled:r,className:"px-3 py-1.5 text-sm text-muted-foreground hover:text-foreground transition-colors",children:"Cancel"}),e.jsx(N,{onClick:u,disabled:!l||r,size:"sm",className:`px-3 py-1.5 text-sm rounded-md transition-colors ${l?"bg-slate-600 hover:bg-slate-700 text-white shadow-sm border border-slate-500":"bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed"}`,children:r?"Saving...":"Save"})]})]}),e.jsx("div",{className:"flex-1 p-4 min-h-0",children:e.jsx(Cs,{ref:c,value:o,onChange:d,placeholder:"Edit your message...",className:"w-full h-full resize-none text-sm leading-relaxed border border-input rounded-lg p-3 bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent",autoFocus:!0})}),e.jsx("div",{className:"p-4 border-t border-border bg-muted/30",children:e.jsx("div",{className:"text-xs text-muted-foreground text-center",children:l?"Unsaved changes":"All changes saved"})})]})};function $h({onSave:s,onCancel:t,onExpand:a,isSaving:n}){const r=H(x=>x.editContent),o=H(x=>x.originalContent),i=H(x=>x.updateContent),l=r!==o,c=h.useRef(null);Ss({textareaRef:c,updateContent:i,content:r});const d=x=>{const p=x.target.value;i(p)},u=()=>{l&&s()},m=()=>{l?confirm("You have unsaved changes. Are you sure you want to cancel?")&&t():t()};return e.jsxs("div",{className:"space-y-3",children:[e.jsx(Cs,{ref:c,value:r,onChange:d,placeholder:"Edit your thought...",className:"min-h-[120px] resize-none text-sm leading-relaxed border-2 border-blue-200 dark:border-blue-700 focus:border-blue-400 dark:focus:border-blue-500",autoFocus:!0,style:{caretColor:"#3b82f6"}}),e.jsx(Lr,{leftActions:[{label:"Cancel",onClick:m,disabled:n,icon:e.jsx(Z,{className:"w-3 h-3 mr-1"})},{label:n?"Saving...":"Save",onClick:u,disabled:!l||n,icon:e.jsx(di,{className:"w-3 h-3 mr-1"}),className:l?"bg-slate-600 hover:bg-slate-700 text-white shadow-sm border border-slate-500 transition-colors duration-200":"bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed"}],rightActions:[{label:"Expand",onClick:a,disabled:n,icon:e.jsx(ci,{className:"w-3 h-3 mr-1"}),variant:"outline"}]})]})}function Uh({message:s,isEditing:t,onDelete:a,onEdit:n,onCopy:r,onReply:o,onGenerateSparks:i,onViewDetails:l,onBookmark:c}){const d=()=>{r?r():navigator.clipboard.writeText(s.content)},u=[{id:"primary",showSeparator:!1,items:[...n&&se().channel.thoughtRecord.edit.enabled?[{id:"edit",icon:e.jsx(os,{className:"w-4 h-4"}),title:"Edit",onClick:n,variant:"default",disabled:t}]:[],{id:"copy",icon:e.jsx(It,{className:"w-4 h-4"}),title:"Copy",onClick:d,variant:"default",disabled:t}]},{id:"ai",showSeparator:!0,items:[...i&&se().channel.thoughtRecord.sparks.enabled?[{id:"generate-sparks",icon:e.jsx(lt,{className:"w-4 h-4"}),title:"Generate Sparks",onClick:i,variant:"default",disabled:t}]:[]]},{id:"secondary",showSeparator:!0,items:[]},{id:"danger",showSeparator:!0,items:[{id:"delete",icon:e.jsx(Te,{className:"w-4 h-4"}),title:"Delete",onClick:a,variant:"destructive",disabled:t}]}];return e.jsx(wr,{groups:u,width:"md",alwaysVisible:!0,triggerClassName:"h-8 w-8 p-0 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all duration-200 rounded-md"})}function Fh({children:s,messageId:t,maxHeight:a=600,className:n}){return e.jsx(Dr,{messageId:t,maxHeight:a,clampMargin:24,className:j("relative group",n),children:s})}function zh({message:s,showAnalysis:t,onToggleAnalysis:a,className:n,autoGenerate:r=!1}){const[o,i]=h.useState(!1),l=s.aiAnalysis,c=!!l?.insights?.length,d=h.useCallback(async()=>{try{i(!0);const u=await Nu(s.content),{userId:m}=T.getState();if(!m)throw new Error("User not authenticated");await _.updateMessage({messageId:s.id,channelId:s.channelId,updates:{aiAnalysis:{...l,insights:u,keywords:l?.keywords??[],topics:l?.topics??[],sentiment:l?.sentiment??"neutral",summary:l?.summary??"",tags:l?.tags??[],relatedTopics:l?.relatedTopics??[]}},userId:m})}catch(u){console.error("Failed to generate sparks:",u)}finally{i(!1)}},[s.content,s.id,s.channelId,l]);return h.useEffect(()=>{r&&t&&!c&&!o&&d()},[r,t,c,o,d]),!c&&!t?null:e.jsx("div",{className:n,children:c?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:a,className:"flex items-center gap-1.5 px-2.5 py-1.5 bg-blue-50 dark:bg-blue-900/20 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-all duration-200 group",title:t?"Hide sparks":"Show sparks",children:[e.jsx(lt,{className:"w-3.5 h-3.5 text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"text-xs font-medium text-blue-700 dark:text-blue-300",children:l.insights.length})]}),t&&e.jsx("div",{className:"space-y-2",children:l.insights.map((u,m)=>e.jsx("div",{className:"text-xs text-slate-600 dark:text-slate-300 leading-relaxed p-2 bg-slate-50 dark:bg-slate-800/50 rounded-lg",children:u},m))})]}):e.jsx("div",{className:"flex items-center justify-center py-4",children:o?e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400",children:[e.jsx("div",{className:"w-3 h-3 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}),"Generating sparks..."]}):e.jsx("div",{className:"text-xs text-slate-400 dark:text-slate-500",children:"No sparks available"})})})}function Bh({threadCount:s,messageId:t}){return null}const Hh=({message:s,onReply:t,threadCount:a=0})=>{const{deleteMessage:n}=_,[r,o]=h.useState(!1),[i,l]=h.useState(!1),c=H(L=>L.editingMessageId),d=H(L=>L.editMode),u=H(L=>L.isSaving),m=H(L=>L.startEditing),x=H(L=>L.save),p=H(L=>L.cancel),g=H(L=>L.switchToExpandedMode),f=H(L=>L.switchToInlineMode),b=c===s.id,v=b&&d==="expanded",y=b?u:!1,I=b?d:"inline";if(h.useEffect(()=>{i&&l(!1)},[i]),s.isDeleted)return null;const C=()=>{m(s.id,s.content)},w=async()=>{const L=s.content.length>100?`${s.content.substring(0,100)}...`:s.content;if(window.confirm(`🗑️ Delete Thought

"${L}"

⚠️ This action cannot be undone.
The thought will be moved to trash.

Are you sure you want to continue?`))try{await n({messageId:s.id,channelId:s.channelId})}catch(V){const ne=V instanceof Error?V.message:"Unknown error";alert(`❌ Failed to delete the message.

Error: ${ne}

Please try again.`)}},k=()=>{o(!r)},R=()=>{l(!0),o(!0)},E=()=>{navigator.clipboard.writeText(s.content)},S=()=>{t?.()},M=async()=>{await x()},A=()=>{p()},Y=()=>{g()};return e.jsx("div",{className:"w-full flex flex-col overflow-hidden group",children:e.jsxs("div",{className:"relative w-full px-4 py-4 bg-muted/20 hover:bg-muted/40 transition-all duration-200 ease-out",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center gap-2 text-xs text-muted-foreground font-medium",children:e.jsx("span",{children:rt(s.timestamp)})}),e.jsx("div",{className:"w-1 h-1 bg-muted-foreground/60 rounded-full"})]}),e.jsx(Uh,{message:s,isEditing:b,onDelete:w,onEdit:C,onCopy:E,onReply:t?S:void 0,onGenerateSparks:R,onViewDetails:()=>{},onBookmark:()=>{}})]}),e.jsx("div",{className:"",children:b&&I==="inline"?e.jsx($h,{onSave:M,onCancel:A,onExpand:Y,isSaving:y}):e.jsx(Fh,{maxHeight:400,messageId:s.id,children:e.jsx(ya,{content:s.content})})}),!b&&e.jsx(zh,{message:s,showAnalysis:r,onToggleAnalysis:k,autoGenerate:i}),!b&&a>0&&e.jsx("div",{className:"flex justify-end mt-4 pt-2",children:e.jsx(Bh,{threadCount:a,messageId:s.id})}),e.jsx(Be,{open:v,onOpenChange:L=>{L||f()},children:e.jsx(He,{showCloseButton:!1,className:"h-[90vh] w-[95vw] max-w-none p-0 border-0 bg-background",onInteractOutside:L=>{L.preventDefault()},children:e.jsx(Oh,{originalContent:s.content,onSave:M,onCancel:A,onCollapse:f,isSaving:y})})})]})})},Gh=({onSend:s,replyToMessageId:t,onCancelReply:a,isSending:n=!1,className:r=""})=>{const[o,i]=h.useState(""),l=h.useRef(null);h.useEffect(()=>{l.current&&(l.current.style.height="auto",l.current.style.height=`${Math.min(l.current.scrollHeight,120)}px`)},[o]);const c=()=>{o.trim()&&(s(o.trim()),i(""),l.current&&(l.current.style.height="auto"))},d=m=>{m.key==="Enter"&&Ft(m)&&(m.preventDefault(),c())},u=!!t;return e.jsxs("div",{className:j("bg-background p-4 space-y-3",r),children:[u&&e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 rounded-xl px-4 py-3 border border-border/50",children:[e.jsx("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:e.jsx("span",{children:"Replying to message"})}),e.jsx(N,{variant:"ghost",size:"sm",onClick:a,className:"h-7 px-3 text-xs rounded-lg",children:"Cancel"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Cs,{ref:l,value:o,onChange:m=>i(m.target.value),onKeyDown:d,placeholder:"Message...",className:"min-h-[52px] max-h-[120px] resize-none rounded-2xl border border-border/50 dark:border-border/50 bg-background/90 backdrop-blur-sm shadow-none focus:shadow-none focus:outline-none transition-all duration-200 pl-4 pr-12 py-3 text-base",rows:1}),e.jsx(N,{type:"button",variant:"ghost",onClick:c,disabled:!o.trim()||n,size:"icon",className:`absolute right-2 bottom-2 h-9 w-9 rounded-full transition-colors duration-150 ${o.trim()&&!n?"bg-slate-900 text-white hover:bg-slate-800 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600 shadow-sm":"text-muted-foreground hover:text-foreground hover:bg-muted/60"}`,"aria-label":"Send",children:n?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current"}):e.jsx($t,{className:"h-5 w-5"})})]})})]})},Vh=h.forwardRef(function({conversations:t,currentConversationId:a,loading:n,onCreate:r,channelId:o,onClose:i},l){const c=$(v=>v.uiView),d=$(v=>v.showList),u=$(v=>v.showChat),m=t.length>0;h.useImperativeHandle(l,()=>({showList:()=>d(),showChat:()=>u(),createNew:()=>{r(),u()},isListView:()=>c==="list"}),[r,d,u,c]);const x=()=>e.jsx(pa,{conversations:t,currentConversationId:a,loading:n,withHeader:!1}),p=()=>a?e.jsx(Er,{conversationId:a,channelId:o,onClose:i}):n?e.jsx("div",{className:"relative flex-1 flex flex-col",children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(ze,{className:"w-4 h-4 animate-spin"})})}):m?e.jsx("div",{className:"flex-1"}):e.jsx(Tr,{onCreate:r}),g=a?t.find(v=>v.id===a):void 0,f=$(v=>v.titleGeneratingMap),b=c==="list"?"Conversations":g?f[g.id]?"Generating title...":g.title||"AI Chat":"AI Chat";return e.jsxs("div",{className:"relative flex-1 flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 pt-2 pb-2 bg-background",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[c==="chat"&&e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>d(),"aria-label":"Show conversations",className:"h-8 w-8 flex-shrink-0",children:e.jsx(In,{className:"w-4 h-4"})}),c==="list"&&e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>u(),"aria-label":"Back to chat",className:"h-8 w-8 flex-shrink-0",children:e.jsx(En,{className:"w-4 h-4"})}),e.jsx("h3",{className:"font-semibold text-foreground truncate text-sm leading-6",children:b})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[c==="chat"&&a&&e.jsx(Ir,{conversationId:a,fallbackChannelId:o,variant:"compact"}),e.jsx(N,{variant:"ghost",size:"icon","aria-label":"New conversation",className:"h-8 w-8",onClick:()=>{r(),u()},children:e.jsx(ae,{className:"w-4 h-4"})}),i&&e.jsxs(N,{variant:"ghost",size:"icon","aria-label":"Close",className:"h-8 w-8",onClick:i,children:[e.jsx("span",{className:"sr-only",children:"Close"}),e.jsx("svg",{viewBox:"0 0 24 24",className:"w-4 h-4","aria-hidden":!0,children:e.jsx("path",{stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",d:"M6 6l12 12M18 6L6 18"})})]})]})]}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"absolute inset-0 flex flex-col "+(c==="list"?"":"hidden"),children:x()}),e.jsx("div",{className:"absolute inset-0 flex flex-col "+(c==="chat"?"":"hidden"),children:p()})]})]})}),qh=({channelId:s,isOpen:t,onClose:a})=>{const{userId:n}=T(),{conversations:r,currentConversationId:o,loading:i,createConversation:l,loadConversations:c}=Ut(),d=h.useRef(null);h.useEffect(()=>{n&&t&&c(n)},[n,t,c]);const u=()=>{n&&l(n,"New Conversation")};return t?e.jsx(Vh,{ref:d,conversations:r,currentConversationId:o,loading:i,onCreate:u,channelId:s,onClose:a}):null};function Wh({channel:s,onDelete:t}){return e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(N,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-muted-foreground hover:text-foreground hover:bg-muted",title:"More actions",onClick:a=>a.stopPropagation(),children:e.jsx(na,{className:"h-3.5 w-3.5"})})}),e.jsx(ht,{className:"w-56 p-2",align:"end",side:"bottom",onClick:a=>a.stopPropagation(),children:e.jsx(jr,{groups:[{id:"danger",items:[{id:"delete",icon:e.jsx(Te,{}),title:`Delete ${s.name}`,onClick:t}]}]})})]})}function Kh({channel:s,isActive:t,onClick:a,onDelete:n}){return e.jsxs("button",{onClick:a,className:j("w-full flex items-center gap-3 px-3 py-3 text-left transition-all duration-200 group rounded-lg","hover:bg-muted/50",t&&"bg-muted/50"),children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 flex items-center justify-center",children:s.emoji?e.jsx("span",{className:"text-lg leading-none",title:`Emoji: ${s.emoji}`,children:s.emoji}):e.jsx(Ot,{className:"w-4 h-4 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:j("font-medium truncate text-sm",t?"text-foreground":"text-foreground/80"),children:s.name}),s.description&&e.jsx("div",{className:"text-xs text-muted-foreground truncate mt-0.5",children:s.description})]}),n&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx(Wh,{channel:s,onDelete:n})})]})}function ts({...s}){return e.jsx(hn,{"data-slot":"sheet",...s})}function Yh({...s}){return e.jsx(pn,{"data-slot":"sheet-portal",...s})}function Xh({className:s,...t}){return e.jsx(xn,{"data-slot":"sheet-overlay",className:j("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",s),...t})}function ss({className:s,children:t,side:a="right",hideClose:n,...r}){return e.jsxs(Yh,{children:[e.jsx(Xh,{}),e.jsxs(mn,{"data-slot":"sheet-content",className:j("bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-200 data-[state=open]:duration-250",a==="right"&&"data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm",a==="left"&&"data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm",a==="top"&&"data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b",a==="bottom"&&"data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",s),...r,children:[t,!n&&e.jsxs(gn,{className:"data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:outline-hidden disabled:pointer-events-none",children:[e.jsx(Z,{className:"size-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]})}function Jh({isOpen:s,onClose:t,onChannelSelect:a}){const{channels:n,addChannel:r,deleteChannel:o}=T(),{currentChannelId:i,setCurrentChannel:l}=O(),c=x=>{r(x)},d=x=>{a(x)},u=async x=>{const p=n.find(f=>f.id===x);if(!p)return;if(window.confirm(`🗑️ Delete Channel

"${p.name}"

⚠️ This action cannot be undone.
The channel and all its messages will be moved to trash.

Are you sure you want to continue?`))try{if(await o(x),i===x&&n.length>1){const f=n.filter(b=>b.id!==x);f.length>0&&(l(f[0].id),a(f[0].id))}}catch(f){const b=f instanceof Error?f.message:"Unknown error";alert(`❌ Failed to delete the channel.

Error: ${b}

Please try again.`)}},m=h.useMemo(()=>{const x=p=>{const g=p.lastMessageTime?.getTime(),f=p.updatedAt?.getTime(),b=p.createdAt?.getTime?.()?p.createdAt.getTime():0;return g??f??b??0};return[...n].sort((p,g)=>x(g)-x(p))},[n]);return e.jsx(ts,{open:s,onOpenChange:t,children:e.jsx(ss,{side:"left",className:"w-80 p-0 border-r border-border",hideClose:!0,children:e.jsxs("div",{className:"flex flex-col h-full bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h3",{className:"font-semibold text-foreground",children:"Spaces"})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(Lt,{variant:"dialog",onAddChannel:c,trigger:e.jsx(N,{variant:"ghost",size:"icon",className:"h-8 w-8",title:"New space","aria-label":"New space",children:e.jsx(ae,{className:"w-4 h-4"})})})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-2",children:m.map(x=>e.jsx(Kh,{channel:x,isActive:i===x.id,onClick:()=>d(x.id),onDelete:()=>u(x.id)},x.id))})]})})})}const Qh=({onClose:s})=>e.jsxs("div",{className:"h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oa,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-semibold text-foreground",children:"Settings"})]}),s&&e.jsx(N,{variant:"ghost",size:"icon","aria-label":"Close",className:"h-8 w-8",onClick:s,children:e.jsx(Z,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex-1 p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:"Account"}),e.jsx("div",{className:"bg-muted/50 rounded-lg p-3",children:e.jsx(sr,{})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:"Appearance"}),e.jsx("div",{className:"bg-muted/50 rounded-lg p-3",children:e.jsx(er,{})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:"Data"}),e.jsx(N,{variant:"outline",className:"w-full justify-start",children:"Export Data"}),e.jsx(N,{variant:"outline",className:"w-full justify-start",children:"Import Data"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[e.jsx(ui,{className:"w-4 h-4"}),"Developer"]}),e.jsxs(Be,{children:[e.jsx(Hn,{asChild:!0,children:e.jsxs(N,{variant:"outline",className:"w-full justify-start",children:[e.jsx(wn,{className:"w-4 h-4 mr-2"}),"Debug Information"]})}),e.jsxs(He,{className:"sm:max-w-md",children:[e.jsx(ys,{children:e.jsx(ws,{children:"Debug Information"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Version:"}),e.jsx("div",{className:"text-muted-foreground",children:"v1.0.5"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Build Time:"}),e.jsx("div",{className:"text-muted-foreground",children:new Date().toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Environment:"}),e.jsx("div",{className:"text-muted-foreground",children:"Production"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Platform:"}),e.jsx("div",{className:"text-muted-foreground",children:"Mobile"})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground border-t pt-3",children:"This debug information is only visible to developers and support staff."})]})]})]})]})]})]}),Zh=({onSendMessage:s,onClose:t})=>{const{currentChannelId:a}=O(),{messages:n}=mt({}),r=a?n.find(i=>i.id===a):null,o=a?n.filter(i=>i.threadId===a)||[]:[];return e.jsxs("div",{className:"h-full flex flex-col bg-background",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(it,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-semibold text-foreground",children:"Thread"})]}),t&&e.jsx(N,{variant:"ghost",size:"icon","aria-label":"Close",className:"h-8 w-8",onClick:t,children:e.jsx(Z,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"p-4 bg-muted/50",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-2",children:"Parent Message"}),e.jsx("div",{className:"text-sm text-foreground leading-relaxed",children:r?.content}),e.jsx("div",{className:"text-xs text-muted-foreground mt-2",children:rt(r?.timestamp||new Date)})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground mb-3",children:"Replies"}),o.length===0?e.jsx("div",{className:"text-sm text-muted-foreground text-center py-8",children:"No replies yet. Start the conversation!"}):o.map(i=>e.jsxs("div",{className:"bg-card border border-border rounded-lg p-3",children:[e.jsx("div",{className:"text-sm text-foreground leading-relaxed whitespace-pre-wrap",children:i.content}),e.jsx("div",{className:"text-xs text-muted-foreground mt-2",children:rt(i.timestamp)})]},i.id))]}),e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"Reply to thread...",className:"flex-1 px-3 py-2 border border-border rounded-md text-sm bg-background text-foreground placeholder:text-muted-foreground",onKeyDown:i=>{i.key==="Enter"&&i.currentTarget.value.trim()&&(s(i.currentTarget.value.trim()),i.currentTarget.value="")}}),e.jsx(N,{size:"sm",onClick:i=>{const l=i.currentTarget.previousElementSibling;l&&l.value.trim()&&(s(l.value.trim()),l.value="")},children:"Reply"})]})})]})},em=()=>{const{setCurrentChannel:s,currentChannelId:t}=O(),{isChannelListOpen:a,isAIAssistantOpen:n,isSettingsOpen:r,isThreadOpen:o,closeChannelList:i,closeAIAssistant:l,closeSettings:c,closeThread:d}=Is(),u=T(p=>p.addThreadMessage),m=p=>{s(p),i()},x=p=>{t&&u(t,{content:p,sender:"user",channelId:t})};return e.jsxs(e.Fragment,{children:[e.jsx(Jh,{isOpen:a,onClose:i,onChannelSelect:m}),t&&e.jsx(ts,{open:n,onOpenChange:l,children:e.jsx(ss,{side:"bottom",className:"h-[80vh] p-0 border-t border-border/60",hideClose:!0,onOpenAutoFocus:p=>p.preventDefault(),children:e.jsx(qh,{channelId:t,isOpen:n,onClose:l})})}),o&&e.jsx(ts,{open:o,onOpenChange:d,children:e.jsx(ss,{side:"right",className:"w-full max-w-md p-0 border-l border-border/60",hideClose:!0,children:e.jsx(Zh,{onSendMessage:x,onClose:d})})}),e.jsx(ts,{open:r,onOpenChange:c,children:e.jsx(ss,{side:"right",className:"w-full max-w-md p-0 border-l border-border/60",hideClose:!0,children:e.jsx(Qh,{onClose:c})})})]})},tm=({onSendMessage:s,setReplyToMessageId:t})=>{const a=h.useCallback(r=>{t(r)},[t]),n=h.useCallback(r=>{s(r)},[s]);return{handleReply:a,handleSendMessage:n}},sm=()=>{const[s,t]=h.useState("100vh");return h.useEffect(()=>{const a=()=>{const r=`${window.innerHeight}px`;t(r),document.documentElement.style.setProperty("--mobile-vh",r)};a();const n=["resize","orientationchange"];return n.forEach(r=>{window.addEventListener(r,a)}),"visualViewport"in window&&window.visualViewport&&window.visualViewport.addEventListener("resize",a),()=>{n.forEach(r=>{window.removeEventListener(r,a)}),"visualViewport"in window&&window.visualViewport&&window.visualViewport.removeEventListener("resize",a)}},[]),s},am=({currentChannelName:s,replyToMessageId:t,isAddingMessage:a,onSendMessage:n,onCancelReply:r,setReplyToMessageId:o})=>{const i=tm({onSendMessage:n,setReplyToMessageId:o}),l=sm(),{currentChannelId:c}=O(),{channels:d}=T(),u=d.find(p=>p.id===c),m=h.useRef(null),x=p=>{_.sendMessage({channelId:O.getState().currentChannelId,content:p,sender:"user"}),setTimeout(()=>{m.current?.scrollToBottom({behavior:"instant"})},100)};return e.jsxs("div",{className:"flex flex-col overflow-hidden",style:{height:l,minHeight:l,maxHeight:l},children:[e.jsx(Rh,{currentChannelName:s,currentChannel:u,channels:d}),e.jsxs("div",{className:"flex-1 flex flex-col min-h-0 overflow-hidden",children:[e.jsx(Ph,{ref:m,onReply:i.handleReply}),e.jsx(Hr,{}),u&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx(Gh,{onSend:x,replyToMessageId:t||void 0,onCancelReply:r,isSending:a})})]})]})};function nm(){mr();const s=Ah();rm();const t=s.channels.find(a=>a.id===s.currentChannelId);return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx(am,{currentChannelName:t?.name,replyToMessageId:s.replyToMessageId,isAddingMessage:s.isAddingMessage,onSendMessage:s.handleSendMessage,onCancelReply:s.handleCancelReply,setReplyToMessageId:s.setReplyToMessageId}),e.jsx(em,{})]})}function rm(){h.useEffect(()=>ve.requestJumpToMessage$.listen(({channelId:s,messageId:t})=>{const a=()=>{const o="search-target-highlight-style";if(document.getElementById(o))return;const i=document.createElement("style");i.id=o,i.textContent=`
          @keyframes search-target-pulse { 
            0% { background-color: rgba(250, 204, 21, 0.00); outline-color: rgba(245, 158, 11, 0.00); }
            20% { background-color: rgba(250, 204, 21, 0.32); outline-color: rgba(245, 158, 11, 0.95); }
            55% { background-color: rgba(250, 204, 21, 0.20); outline-color: rgba(245, 158, 11, 0.50); }
            100% { background-color: rgba(250, 204, 21, 0.08); outline-color: rgba(245, 158, 11, 0.00); }
          }
          .search-target-highlight { outline: 2px solid rgba(245, 158, 11, 0.9); background-color: rgba(250, 204, 21, 0.18); animation: search-target-pulse 1.5s ease-in-out 2; }
        `,document.head.appendChild(i)},n=o=>{const i=o.getBoundingClientRect(),l=window.innerHeight||document.documentElement.clientHeight,c=window.innerWidth||document.documentElement.clientWidth;return i.top>=0&&i.left>=0&&i.bottom<=l&&i.right<=c},r=(o,i=3e3)=>{a();let l=!1;const c=()=>{l||(l=!0,o.classList.add("search-target-highlight"),setTimeout(()=>o.classList.remove("search-target-highlight"),i))};if(n(o)){c();return}if("IntersectionObserver"in window){const d=new IntersectionObserver(u=>{u.find(x=>x.isIntersecting)&&(c(),d.disconnect())},{threshold:.1});d.observe(o),setTimeout(()=>{l||(d.disconnect(),c())},2e3)}else setTimeout(c,300)};(async()=>{try{const{currentChannelId:o}=O.getState();o!==s&&(O.getState().setCurrentChannel(s),await new Promise(m=>setTimeout(m,160)));const i=Dt.messageById(t),l=()=>{const m=document.querySelector(i);return m?(m.scrollIntoView({behavior:"smooth",block:"start"}),r(m,3e3),!0):!1},c=8e3,d=Date.now();let u=0;for(_.requestLoadInitialMessages$.next({channelId:s});Date.now()-d<c;){if(l())return;const m=_.dataContainer.get().messageByChannel[s];if(m?.hasMore&&!m.loadingMore&&u<20){u+=1,await _.loadMoreHistory({channelId:s,messagesLimit:20}),await new Promise(p=>{let g=!1;const f=_.moreMessageLoadedEvent$.listen(b=>{b.channelId===s&&!g&&(g=!0,f(),p())});setTimeout(()=>{if(!g){g=!0;try{f()}catch{}p()}},1600)}),await new Promise(p=>setTimeout(p,60));continue}await new Promise(p=>setTimeout(p,150))}console.warn("[Mobile JumpToMessage] not found within time budget",{channelId:s,messageId:t})}finally{}})()}),[])}const om=$n({manifest:{id:"mobile-notes",name:"Mobile Notes Extension",description:"Mobile-optimized conversational AI note-taking feature",version:"1.0.0",author:"StillRoot Team",icon:"notebook"},activate:({subscriptions:s})=>{s.push(Pe.from(ga.getState().addIcons({notebook:Mn,hash:Ot,plus:ae,menu:Nn}))),s.push(Pe.from(nt.getState().addItem({id:"mobile-notes",label:"Notes",title:"Mobile Notes",group:Mt.MAIN,icon:"notebook",order:1,iconColor:"text-blue-600 dark:text-blue-400"}))),s.push(Pe.from(js.getState().addRoutes([{id:"mobile-notes-main",path:"/notes",element:e.jsx(nm,{}),order:1},{id:"mobile-notes-default",path:"*",element:e.jsx(On,{to:"/notes"}),order:9999}]))),s.push(Pe.from(lr([{activityKey:"mobile-notes",routerPath:"/notes"}])))}}),im=()=>e.jsx("div",{className:"flex flex-col bg-background overflow-hidden",style:{height:"100%"},children:e.jsx(Mh,{extensions:[om]})}),lm=()=>{const{currentBreakpoint:s}=xl(),{user:t,isInitializing:a}=Qn(),n=h.useRef(Date.now());console.log("[App] ",{user:t,isInitializing:a});const r=O(o=>o.setAuth);return h.useEffect(()=>{r(t)},[t,r]),h.useEffect(()=>{const o=s==="sm"?Ks.MOBILE:Ks.DESKTOP;return ce.logAppStart(o,"1.0.0"),()=>{const i=Date.now()-n.current;ce.logAppClose(i)}},[s]),a?e.jsxs(e.Fragment,{children:[e.jsx(Xl,{}),e.jsx(Ds,{})]}):t?e.jsxs(e.Fragment,{children:[s==="sm"?e.jsx(im,{}):e.jsx(Sh,{}),e.jsx(Ds,{}),e.jsx(tc,{}),e.jsx(Jl,{}),e.jsx(Ql,{})]}):e.jsxs(e.Fragment,{children:[e.jsx(Yl,{}),e.jsx(Ds,{})]})};class cm{auth;constructor(t){const a=new cl({tokenRequestMethod:"url",httpClient:{fetch:async(n,r)=>{if(n.includes("github.com/login/oauth/access_token")){const o=`https://proxy.agentverse.cc/?${n}`;return fetch(o,r)}return fetch(n,r)}}});this.auth=new dl(a,{clientId:t.clientId,clientSecret:t.clientSecret,redirectUri:t.redirectUri,scopes:t.scopes||["repo","user"]})}async startAuth(){const t=ul(32);return sessionStorage.setItem("github_auth_state",t),await this.auth.startAuth({state:t})}async handleCallback(t){const{code:a,state:n,error:r}=hl(t);if(console.log("[GitHubAuthService][handleCallback] code",{code:a,url:t}),r)throw new Error(`GitHub authentication failed: ${r}`);if(!a)throw new Error("Authorization code not received");const o=sessionStorage.getItem("github_auth_state");if(!o||n!==o)throw new Error("State parameter validation failed, possible CSRF attack");try{const i=await this.auth.handleCallback(a,n);return console.log("[GitHubAuthService][handleCallback] result",i),sessionStorage.removeItem("github_auth_state"),this.saveAuthResult(i),i}catch(i){throw new Error(`Failed to handle authentication callback: ${i instanceof Error?i.message:"Unknown error"}`)}}getAuthStatus(){const t=localStorage.getItem("github_auth");if(!t)return null;try{const a=JSON.parse(t),n=Date.now(),r=a.createdAt+a.expiresIn*1e3;return n>=r?(this.clearAuth(),null):a}catch{return this.clearAuth(),null}}isAuthenticated(){return this.getAuthStatus()!==null}getAccessToken(){return this.getAuthStatus()?.accessToken||null}getUserInfo(){return this.getAuthStatus()?.user||null}logout(){this.clearAuth()}saveAuthResult(t){localStorage.setItem("github_auth",JSON.stringify(t))}clearAuth(){localStorage.removeItem("github_auth"),sessionStorage.removeItem("github_auth_state")}}function dm(s){new cm({...s})}const vt={oauth:{clientId:"Ov23liDcQnnEXXktUGbS",clientSecret:"3be855bdce90d8a13dbf18d1e808d55d36b7bc8a",redirectUri:"https://memol.dimstack.com/",scopes:["repo","user","workflow"]},storage:{defaultBranch:"main",basePath:"data"},api:{baseUrl:"https://api.github.com",timeout:3e4},features:{autoSync:!0,conflictResolution:!0,backupEnabled:!0}};try{vt.oauth.clientId&&(dm({clientId:vt.oauth.clientId,clientSecret:vt.oauth.clientSecret,redirectUri:vt.oauth.redirectUri,scopes:vt.oauth.scopes}),console.log("✅ GitHub认证服务初始化成功"))}catch(s){console.warn("⚠️ GitHub认证服务初始化失败:",s)}Vr.createRoot(document.getElementById("root")).render(e.jsx(h.StrictMode,{children:e.jsx(cs,{children:e.jsx(pl,{children:e.jsx(wl,{children:e.jsx(yl,{children:e.jsx(zi,{children:e.jsx(lm,{})})})})})})}));
