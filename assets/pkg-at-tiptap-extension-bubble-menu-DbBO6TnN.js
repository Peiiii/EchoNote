import{E as b,i as y,p as O}from"./pkg-at-tiptap-core-BEPluX3I.js";import{f as U,s as I,o as H,b as T,a as D,d as E,h as M,i as C,c as R}from"./pkg-at-floating-ui-dom-H_s0ufE4.js";import{P,d as z,N as S,U as V}from"./editor-C-B7di21.js";function x(t,e){const n=Math.min(t.top,e.top),a=Math.max(t.bottom,e.bottom),l=Math.min(t.left,e.left),h=Math.max(t.right,e.right)-l,u=a-n,r=l,d=n;return new DOMRect(r,d,h,u)}var B=class{constructor({editor:t,element:e,view:n,updateDelay:a=250,resizeDelay:l=60,shouldShow:i,appendTo:h,getReferencedVirtualElement:u,options:r}){this.preventHide=!1,this.isVisible=!1,this.scrollTarget=window,this.floatingUIOptions={strategy:"absolute",placement:"top",offset:8,flip:{},shift:{},arrow:!1,size:!1,autoPlacement:!1,hide:!1,inline:!1,onShow:void 0,onHide:void 0,onUpdate:void 0,onDestroy:void 0},this.shouldShow=({view:s,state:o,from:p,to:f})=>{const{doc:c,selection:m}=o,{empty:g}=m,v=!c.textBetween(p,f).length&&y(o.selection),w=this.element.contains(document.activeElement);return!(!(s.hasFocus()||w)||g||v||!this.editor.isEditable)},this.mousedownHandler=()=>{this.preventHide=!0},this.dragstartHandler=()=>{this.hide()},this.resizeHandler=()=>{this.resizeDebounceTimer&&clearTimeout(this.resizeDebounceTimer),this.resizeDebounceTimer=window.setTimeout(()=>{this.updatePosition()},this.resizeDelay)},this.focusHandler=()=>{setTimeout(()=>this.update(this.editor.view))},this.blurHandler=({event:s})=>{var o;if(this.editor.isDestroyed){this.destroy();return}if(this.preventHide){this.preventHide=!1;return}s?.relatedTarget&&((o=this.element.parentNode)!=null&&o.contains(s.relatedTarget))||s?.relatedTarget!==this.editor.view.dom&&this.hide()},this.handleDebouncedUpdate=(s,o)=>{const p=!o?.selection.eq(s.state.selection),f=!o?.doc.eq(s.state.doc);!p&&!f||(this.updateDebounceTimer&&clearTimeout(this.updateDebounceTimer),this.updateDebounceTimer=window.setTimeout(()=>{this.updateHandler(s,p,f,o)},this.updateDelay))},this.updateHandler=(s,o,p,f)=>{const{composing:c}=s;if(c||!o&&!p)return;if(!this.getShouldShow(f)){this.hide();return}this.updatePosition(),this.show()},this.transactionHandler=({transaction:s})=>{s.getMeta("bubbleMenu")==="updatePosition"&&this.updatePosition()};var d;this.editor=t,this.element=e,this.view=n,this.updateDelay=a,this.resizeDelay=l,this.appendTo=h,this.scrollTarget=(d=r?.scrollTarget)!=null?d:window,this.getReferencedVirtualElement=u,this.floatingUIOptions={...this.floatingUIOptions,...r},this.element.tabIndex=0,i&&(this.shouldShow=i),this.element.addEventListener("mousedown",this.mousedownHandler,{capture:!0}),this.view.dom.addEventListener("dragstart",this.dragstartHandler),this.editor.on("focus",this.focusHandler),this.editor.on("blur",this.blurHandler),this.editor.on("transaction",this.transactionHandler),window.addEventListener("resize",this.resizeHandler),this.scrollTarget.addEventListener("scroll",this.resizeHandler),this.update(n,n.state),this.getShouldShow()&&(this.show(),this.updatePosition())}get middlewares(){const t=[];return this.floatingUIOptions.flip&&t.push(U(typeof this.floatingUIOptions.flip!="boolean"?this.floatingUIOptions.flip:void 0)),this.floatingUIOptions.shift&&t.push(I(typeof this.floatingUIOptions.shift!="boolean"?this.floatingUIOptions.shift:void 0)),this.floatingUIOptions.offset&&t.push(H(typeof this.floatingUIOptions.offset!="boolean"?this.floatingUIOptions.offset:void 0)),this.floatingUIOptions.arrow&&t.push(T(this.floatingUIOptions.arrow)),this.floatingUIOptions.size&&t.push(D(typeof this.floatingUIOptions.size!="boolean"?this.floatingUIOptions.size:void 0)),this.floatingUIOptions.autoPlacement&&t.push(E(typeof this.floatingUIOptions.autoPlacement!="boolean"?this.floatingUIOptions.autoPlacement:void 0)),this.floatingUIOptions.hide&&t.push(M(typeof this.floatingUIOptions.hide!="boolean"?this.floatingUIOptions.hide:void 0)),this.floatingUIOptions.inline&&t.push(C(typeof this.floatingUIOptions.inline!="boolean"?this.floatingUIOptions.inline:void 0)),t}get virtualElement(){var t;const{selection:e}=this.editor.state,n=(t=this.getReferencedVirtualElement)==null?void 0:t.call(this);if(n)return n;const a=O(this.view,e.from,e.to);let l={getBoundingClientRect:()=>a,getClientRects:()=>[a]};if(e instanceof S){let i=this.view.nodeDOM(e.from);const h=i.dataset.nodeViewWrapper?i:i.querySelector("[data-node-view-wrapper]");h&&(i=h),i&&(l={getBoundingClientRect:()=>i.getBoundingClientRect(),getClientRects:()=>[i.getBoundingClientRect()]})}if(e instanceof V){const{$anchorCell:i,$headCell:h}=e,u=i?i.pos:h.pos,r=h?h.pos:i.pos,d=this.view.nodeDOM(u),s=this.view.nodeDOM(r);if(!d||!s)return;const o=d===s?d.getBoundingClientRect():x(d.getBoundingClientRect(),s.getBoundingClientRect());l={getBoundingClientRect:()=>o,getClientRects:()=>[o]}}return l}updatePosition(){const t=this.virtualElement;t&&R(t,this.element,{placement:this.floatingUIOptions.placement,strategy:this.floatingUIOptions.strategy,middleware:this.middlewares}).then(({x:e,y:n,strategy:a})=>{this.element.style.width="max-content",this.element.style.position=a,this.element.style.left=`${e}px`,this.element.style.top=`${n}px`,this.isVisible&&this.floatingUIOptions.onUpdate&&this.floatingUIOptions.onUpdate()})}update(t,e){const{state:n}=t,a=n.selection.from!==n.selection.to;if(this.updateDelay>0&&a){this.handleDebouncedUpdate(t,e);return}const l=!e?.selection.eq(t.state.selection),i=!e?.doc.eq(t.state.doc);this.updateHandler(t,l,i,e)}getShouldShow(t){var e;const{state:n}=this.view,{selection:a}=n,{ranges:l}=a,i=Math.min(...l.map(r=>r.$from.pos)),h=Math.max(...l.map(r=>r.$to.pos));return((e=this.shouldShow)==null?void 0:e.call(this,{editor:this.editor,element:this.element,view:this.view,state:n,oldState:t,from:i,to:h}))||!1}show(){var t;if(this.isVisible)return;this.element.style.visibility="visible",this.element.style.opacity="1";const e=typeof this.appendTo=="function"?this.appendTo():this.appendTo;(t=e??this.view.dom.parentElement)==null||t.appendChild(this.element),this.floatingUIOptions.onShow&&this.floatingUIOptions.onShow(),this.isVisible=!0}hide(){this.isVisible&&(this.element.style.visibility="hidden",this.element.style.opacity="0",this.element.remove(),this.floatingUIOptions.onHide&&this.floatingUIOptions.onHide(),this.isVisible=!1)}destroy(){this.hide(),this.element.removeEventListener("mousedown",this.mousedownHandler,{capture:!0}),this.view.dom.removeEventListener("dragstart",this.dragstartHandler),window.removeEventListener("resize",this.resizeHandler),this.scrollTarget.removeEventListener("scroll",this.resizeHandler),this.editor.off("focus",this.focusHandler),this.editor.off("blur",this.blurHandler),this.editor.off("transaction",this.transactionHandler),this.floatingUIOptions.onDestroy&&this.floatingUIOptions.onDestroy()}},L=t=>new P({key:typeof t.pluginKey=="string"?new z(t.pluginKey):t.pluginKey,view:e=>new B({view:e,...t})}),K=b.create({name:"bubbleMenu",addOptions(){return{element:null,pluginKey:"bubbleMenu",updateDelay:void 0,appendTo:void 0,shouldShow:null}},addProseMirrorPlugins(){return this.options.element?[L({pluginKey:this.options.pluginKey,editor:this.editor,element:this.options.element,updateDelay:this.options.updateDelay,options:this.options.options,appendTo:this.options.appendTo,getReferencedVirtualElement:this.options.getReferencedVirtualElement,shouldShow:this.options.shouldShow})]:[]}}),N=K;export{N as i};
