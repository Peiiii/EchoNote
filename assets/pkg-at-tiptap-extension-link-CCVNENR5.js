import{M as y,a as b,m as v,e as T,g as w,j as _,k as H,l as O}from"./pkg-at-tiptap-core-DNbHC1Gn.js";import{f as C,r as M,t as R,a as I}from"./pkg-linkifyjs-DVrXeg1a.js";import{P as m,d as A}from"./editor-C-B7di21.js";var P="[\0-   ᠎ -\u2029 　]",B=new RegExp(P),U=new RegExp(`${P}$`),N=new RegExp(P,"g");function V(t){return t.length===1?t[0].isLink:t.length===3&&t[1].isLink?["()","[]"].includes(t[0].value+t[2].value):!1}function W(t){return new m({key:new A("autolink"),appendTransaction:(e,r,o)=>{const s=e.some(a=>a.docChanged)&&!r.doc.eq(o.doc),l=e.some(a=>a.getMeta("preventAutolink"));if(!s||l)return;const{tr:i}=o,k=T(r.doc,[...e]);if(w(k).forEach(({newRange:a})=>{const u=_(o.doc,a,h=>h.isTextblock);let d,c;if(u.length>1)d=u[0],c=o.doc.textBetween(d.pos,d.pos+d.node.nodeSize,void 0," ");else if(u.length){const h=o.doc.textBetween(a.from,a.to," "," ");if(!U.test(h))return;d=u[0],c=o.doc.textBetween(d.pos,a.to,void 0," ")}if(d&&c){const h=c.split(B).filter(Boolean);if(h.length<=0)return!1;const g=h[h.length-1],L=d.pos+c.lastIndexOf(g);if(!g)return!1;const E=R(g).map(n=>n.toObject(t.defaultProtocol));if(!V(E))return!1;E.filter(n=>n.isLink).map(n=>({...n,from:L+n.start+1,to:L+n.end+1})).filter(n=>o.schema.marks.code?!o.doc.rangeHasMark(n.from,n.to,o.schema.marks.code):!0).filter(n=>t.validate(n.value)).filter(n=>t.shouldAutoLink(n.value)).forEach(n=>{H(n.from,n.to,o.doc).some(x=>x.mark.type===t.type)||i.addMark(n.from,n.to,t.type.create({href:n.href}))})}}),!!i.steps.length)return i}})}function D(t){return new m({key:new A("handleClickLink"),props:{handleClick:(e,r,o)=>{var s,l;if(o.button!==0||!e.editable)return!1;let i=null;if(o.target instanceof HTMLAnchorElement)i=o.target;else{let u=o.target;const d=[];for(;u.nodeName!=="DIV";)d.push(u),u=u.parentNode;i=d.find(c=>c.nodeName==="A")}if(!i)return!1;const k=O(e.state,t.type.name),f=(s=i?.href)!=null?s:k.href,a=(l=i?.target)!=null?l:k.target;return t.enableClickSelection&&t.editor.commands.extendMarkRange(t.type.name),i&&f?(window.open(f,a),!0):!1}}})}function $(t){return new m({key:new A("handlePasteLink"),props:{handlePaste:(e,r,o)=>{const{shouldAutoLink:s}=t,{state:l}=e,{selection:i}=l,{empty:k}=i;if(k)return!1;let f="";o.content.forEach(u=>{f+=u.textContent});const a=C(f,{defaultProtocol:t.defaultProtocol}).find(u=>u.isLink&&u.value===f);return!f||!a||s!==void 0&&!s(a.href)?!1:t.editor.commands.setMark(t.type,{href:a.href})}}})}function p(t,e){const r=["http","https","ftp","ftps","mailto","tel","callto","sms","cid","xmpp"];return e&&e.forEach(o=>{const s=typeof o=="string"?o:o.scheme;s&&r.push(s)}),!t||t.replace(N,"").match(new RegExp(`^(?:(?:${r.join("|")}):|[^a-z]|[a-z0-9+.-]+(?:[^a-z+.-:]|$))`,"i"))}var z=y.create({name:"link",priority:1e3,keepOnSplit:!1,exitable:!0,onCreate(){this.options.validate&&!this.options.shouldAutoLink&&(this.options.shouldAutoLink=this.options.validate,console.warn("The `validate` option is deprecated. Rename to the `shouldAutoLink` option instead.")),this.options.protocols.forEach(t=>{if(typeof t=="string"){M(t);return}M(t.scheme,t.optionalSlashes)})},onDestroy(){I()},inclusive(){return this.options.autolink},addOptions(){return{openOnClick:!0,enableClickSelection:!1,linkOnPaste:!0,autolink:!0,protocols:[],defaultProtocol:"http",HTMLAttributes:{target:"_blank",rel:"noopener noreferrer nofollow",class:null},isAllowedUri:(t,e)=>!!p(t,e.protocols),validate:t=>!!t,shouldAutoLink:t=>!!t}},addAttributes(){return{href:{default:null,parseHTML(t){return t.getAttribute("href")}},target:{default:this.options.HTMLAttributes.target},rel:{default:this.options.HTMLAttributes.rel},class:{default:this.options.HTMLAttributes.class}}},parseHTML(){return[{tag:"a[href]",getAttrs:t=>{const e=t.getAttribute("href");return!e||!this.options.isAllowedUri(e,{defaultValidate:r=>!!p(r,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:null}}]},renderHTML({HTMLAttributes:t}){return this.options.isAllowedUri(t.href,{defaultValidate:e=>!!p(e,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?["a",v(this.options.HTMLAttributes,t),0]:["a",v(this.options.HTMLAttributes,{...t,href:""}),0]},markdownTokenName:"link",parseMarkdown:(t,e)=>e.applyMark("link",e.parseInline(t.tokens||[]),{href:t.href,title:t.title||null}),renderMarkdown:(t,e)=>{var r;const o=((r=t.attrs)==null?void 0:r.href)||"";return`[${e.renderChildren(t)}](${o})`},addCommands(){return{setLink:t=>({chain:e})=>{const{href:r}=t;return this.options.isAllowedUri(r,{defaultValidate:o=>!!p(o,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?e().setMark(this.name,t).setMeta("preventAutolink",!0).run():!1},toggleLink:t=>({chain:e})=>{const{href:r}=t||{};return r&&!this.options.isAllowedUri(r,{defaultValidate:o=>!!p(o,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:e().toggleMark(this.name,t,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()},unsetLink:()=>({chain:t})=>t().unsetMark(this.name,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()}},addPasteRules(){return[b({find:t=>{const e=[];if(t){const{protocols:r,defaultProtocol:o}=this.options,s=C(t).filter(l=>l.isLink&&this.options.isAllowedUri(l.value,{defaultValidate:i=>!!p(i,r),protocols:r,defaultProtocol:o}));s.length&&s.forEach(l=>{this.options.shouldAutoLink(l.value)&&e.push({text:l.value,data:{href:l.href},index:l.start})})}return e},type:this.type,getAttributes:t=>{var e;return{href:(e=t.data)==null?void 0:e.href}}})]},addProseMirrorPlugins(){const t=[],{protocols:e,defaultProtocol:r}=this.options;return this.options.autolink&&t.push(W({type:this.type,defaultProtocol:this.options.defaultProtocol,validate:o=>this.options.isAllowedUri(o,{defaultValidate:s=>!!p(s,e),protocols:e,defaultProtocol:r}),shouldAutoLink:this.options.shouldAutoLink})),this.options.openOnClick===!0&&t.push(D({type:this.type,editor:this.editor,enableClickSelection:this.options.enableClickSelection})),this.options.linkOnPaste&&t.push($({editor:this.editor,defaultProtocol:this.options.defaultProtocol,type:this.type,shouldAutoLink:this.options.shouldAutoLink})),t}}),X=z;export{z as L,X as i};
